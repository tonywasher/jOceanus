<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThemisDSMPackage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Themis Core Project Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.themis.lethe.dsm</a> &gt; <span class="el_source">ThemisDSMPackage.java</span></div><h1>ThemisDSMPackage.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Themis: Java Project Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/
package net.sourceforge.joceanus.themis.lethe.dsm;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Objects;

import net.sourceforge.joceanus.themis.lethe.analysis.ThemisAnalysisPackage;

/**
 * DSM Package.
 */
public class ThemisDSMPackage {
    /**
     * The package separator.
     */
    static final String SEP_PACKAGE = &quot;.&quot;;

    /**
     * The import prefix.
     */
    private static final String PFX_IMPORT = &quot;import &quot;;

    /**
     * The package-info file.
     */
    private static final String PACKAGE_INFO = &quot;package-info.java&quot;;

    /**
     * The location of the package.
     */
    private final File theLocation;

    /**
     * The name of the package.
     */
    private final String thePackage;

    /**
     * The module that contains the package.
     */
    private final ThemisDSMModule theModule;

    /**
     * The list of direct references to other packages.
     */
    private final List&lt;ThemisDSMPackage&gt; theDirectReferences;

    /**
     * The list of implied  references to other packages.
     */
    private final List&lt;ThemisDSMPackage&gt; theImpliedReferences;

    /**
     * The list of classes in this package.
     */
    private final List&lt;ThemisDSMClass&gt; theClasses;

    /**
     * Constructor.
     * @param pModule the owning module
     * @param pLocation the location of the package
     */
    ThemisDSMPackage(final ThemisDSMModule pModule,
                     final File pLocation) {
<span class="nc" id="L87">        this(pModule, pLocation, pLocation.getName().replace(File.separatorChar, '.'));</span>
<span class="nc" id="L88">    }</span>

    /**
     * Constructor.
     * @param pPackage the parent package
     * @param pLocation the location of the package
     */
    ThemisDSMPackage(final ThemisDSMPackage pPackage,
                     final File pLocation) {
<span class="nc" id="L97">        this(pPackage.getModule(), pLocation,  pPackage.getPackageName() + SEP_PACKAGE + pLocation.getName());</span>
<span class="nc" id="L98">    }</span>

    /**
     * Constructor.
     * @param pModule the owning module
     * @param pLocation the location of the package
     * @param pName the name of the package
     */
    private ThemisDSMPackage(final ThemisDSMModule pModule,
                             final File pLocation,
<span class="nc" id="L108">                             final String pName) {</span>
<span class="nc" id="L109">        theModule = pModule;</span>
<span class="nc" id="L110">        theLocation = pLocation;</span>
<span class="nc" id="L111">        thePackage = pName;</span>
<span class="nc" id="L112">        theDirectReferences = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L113">        theImpliedReferences = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L114">        theClasses = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L115">    }</span>

    /**
     * Return the owning module.
     * @return the module
     */
    ThemisDSMModule getModule() {
<span class="nc" id="L122">        return theModule;</span>
    }

    /**
     * Return the location of the module.
     * @return the location
     */
    File getLocation() {
<span class="nc" id="L130">        return theLocation;</span>
    }

    /**
     * Return the package name.
     * @return the name
     */
    String getPackageName() {
<span class="nc" id="L138">        return thePackage;</span>
    }

    /**
     * Does the package have references?
     * @return true/false
     */
    public boolean hasReferences() {
<span class="nc bnc" id="L146" title="All 2 branches missed.">        return !theDirectReferences.isEmpty();</span>
    }

    /**
     * Add a reference to the list.
     * @param pReference the reference
     */
    void registerReference(final ThemisDSMPackage pReference) {
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (!theDirectReferences.contains(pReference)) {</span>
<span class="nc" id="L155">            theDirectReferences.add(pReference);</span>
        }
<span class="nc" id="L157">    }</span>

    /**
     * Obtain a list of all direct references.
     * @return the list
     */
    public List&lt;ThemisDSMPackage&gt; listReferences() {
<span class="nc" id="L164">        return new ArrayList&lt;&gt;(theDirectReferences);</span>
    }

    /**
     * Obtain the default reference.
     * @return the default
     */
    public ThemisDSMPackage getDefaultReference() {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        return theDirectReferences.isEmpty() ? null : theDirectReferences.get(0);</span>
    }

    @Override
    public boolean equals(final Object pThat) {
        /* Handle the trivial cases */
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (this == pThat) {</span>
<span class="nc" id="L179">            return true;</span>
        }
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (pThat == null) {</span>
<span class="nc" id="L182">            return false;</span>
        }

        /* Make sure that the object is a package */
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (pThat.getClass() != this.getClass()) {</span>
<span class="nc" id="L187">            return false;</span>
        }

        /* Access the target Class */
<span class="nc" id="L191">        final ThemisDSMPackage myThat = (ThemisDSMPackage) pThat;</span>

        /* Check name */
<span class="nc" id="L194">        return thePackage.equals(myThat.getPackageName());</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L199">        return thePackage.hashCode();</span>
    }

    /**
     * process packages.
     */
    void processPackages() {
        /* Loop through the entries in the directory */
<span class="nc bnc" id="L207" title="All 2 branches missed.">        for (File myFile: Objects.requireNonNull(theLocation.listFiles())) {</span>
            /* Handle files */
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (!myFile.isDirectory()) {</span>
                /* Access the name of the file */
<span class="nc" id="L211">                final String myName = myFile.getName();</span>

                /* If this is a .java that is not package-info */
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (myName.endsWith(ThemisAnalysisPackage.SFX_JAVA)</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                    &amp;&amp; !PACKAGE_INFO.equals(myName)) {</span>
                    /* Add the class */
<span class="nc" id="L217">                    final ThemisDSMClass myClass = new ThemisDSMClass(this, myFile);</span>
<span class="nc" id="L218">                    theClasses.add(myClass);</span>
<span class="nc" id="L219">                }</span>
                continue;
            }

            /* Process the subpackage */
<span class="nc" id="L224">            final ThemisDSMPackage myPackage = new ThemisDSMPackage(this, myFile);</span>
<span class="nc" id="L225">            myPackage.processPackages();</span>
        }

        /* Register the package if we have any classes */
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (!theClasses.isEmpty()) {</span>
<span class="nc" id="L230">            theModule.registerPackage(this);</span>
<span class="nc" id="L231">            theClasses.sort(Comparator.comparing(ThemisDSMClass::getClassName));</span>
        }
<span class="nc" id="L233">    }</span>

    /**
     * process classes.
     */
    void processClasses() {
        /* Loop through the classes */
<span class="nc bnc" id="L240" title="All 2 branches missed.">        for (ThemisDSMClass myClass : theClasses) {</span>
            /* Process the class */
<span class="nc" id="L242">            processClass(myClass);</span>

            /* Sort the imports */
<span class="nc" id="L245">            myClass.sortImports();</span>
<span class="nc" id="L246">        }</span>

        /* Sort the references */
<span class="nc" id="L249">        theDirectReferences.sort(Comparator.comparing(ThemisDSMPackage::getPackageName));</span>
<span class="nc" id="L250">    }</span>

    /**
     * process class.
     * @param pClass the class
     */
    private void processClass(final ThemisDSMClass pClass) {
        /* Process the file */
<span class="nc" id="L258">        try (FileReader myInStream = new FileReader(pClass.getLocation());</span>
<span class="nc" id="L259">             BufferedReader myReader = new BufferedReader(myInStream)) {</span>
            /* Read line by line */
            String myLine;
<span class="nc bnc" id="L262" title="All 2 branches missed.">            while ((myLine = myReader.readLine()) != null) {</span>
                /* If the line starts with import */
<span class="nc bnc" id="L264" title="All 2 branches missed.">                if (myLine.startsWith(PFX_IMPORT)) {</span>
                    /* Process the reference to the class */
<span class="nc" id="L266">                    myLine = myLine.substring(PFX_IMPORT.length()).trim();</span>
<span class="nc" id="L267">                    myLine = myLine.substring(0, myLine.length() - 1);</span>
<span class="nc" id="L268">                    processReference(pClass, myLine);</span>
                }
            }

            /* Handle exceptions */
<span class="nc" id="L273">        } catch (IOException e) {</span>
<span class="nc" id="L274">            throw new IllegalStateException(&quot;Help&quot;, e);</span>
<span class="nc" id="L275">        }</span>
<span class="nc" id="L276">    }</span>

    /**
     * process reference.
     * @param pClass the class
     * @param pReference the referenced class
     */
    private void processReference(final ThemisDSMClass pClass,
                                  final String pReference) {
        /* If the referenced class is one of ours and not in the same package  */
<span class="nc" id="L286">        final ThemisDSMClass myReferenced = theModule.findClass(pReference);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (myReferenced != null</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">            &amp;&amp; !thePackage.equals(myReferenced.getPackage().getPackageName())) {</span>
            /* register the import */
<span class="nc" id="L290">            pClass.registerImport(myReferenced);</span>
<span class="nc" id="L291">            registerReference(myReferenced.getPackage());</span>
        }
<span class="nc" id="L293">    }</span>

    /**
     * Find a class reference.
     * @param pReference the class name
     * @return the found class or null
     */
    ThemisDSMClass findClass(final String pReference) {
        /* Loop through the classes */
<span class="nc bnc" id="L302" title="All 2 branches missed.">        for (ThemisDSMClass myClass : theClasses) {</span>
            /* Look for match or prefix */
<span class="nc" id="L304">            final String myName = myClass.getFullClassName();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (pReference.equals(myName)</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                || pReference.startsWith(myName + SEP_PACKAGE)) {</span>
<span class="nc" id="L307">                return myClass;</span>
            }
<span class="nc" id="L309">        }</span>

        /* No match */
<span class="nc" id="L312">        return null;</span>
    }

    /**
     * process dependencies.
     */
    void processDependencies() {
        /* Loop through the dependencies */
<span class="nc bnc" id="L320" title="All 2 branches missed.">        for (ThemisDSMPackage myPackage : theDirectReferences) {</span>
            /* Process the class */
<span class="nc" id="L322">            processDependencies(myPackage);</span>
<span class="nc" id="L323">        }</span>

        /* Sort the full references */
<span class="nc" id="L326">        theImpliedReferences.sort(Comparator.comparing(ThemisDSMPackage::getPackageName));</span>
<span class="nc" id="L327">    }</span>

    /**
     * process dependencies.
     * @param pPackage the package to process dependencies for
     */
    void processDependencies(final ThemisDSMPackage pPackage) {
        /* If this is not already in the fullReference list */
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (!theImpliedReferences.contains(pPackage)) {</span>
            /* Add the package */
<span class="nc" id="L337">            theImpliedReferences.add(pPackage);</span>

           /* Loop through the dependencies */
<span class="nc bnc" id="L340" title="All 2 branches missed.">            for (ThemisDSMPackage myPackage : pPackage.theDirectReferences) {</span>
                /* If this is not already in the full references
                /* Process the class */
<span class="nc" id="L343">                processDependencies(myPackage);</span>
<span class="nc" id="L344">            }</span>
        }
<span class="nc" id="L346">    }</span>

    /**
     * is this package circularly dependent?
     * @return true/false
     */
    public boolean isCircular() {
        /* Loop through the dependencies */
<span class="nc" id="L354">        return theImpliedReferences.contains(this);</span>
    }

    /**
     * Obtain the list of direct references to the other package.
     * @param pPackage the other package
     * @return the list of direct references
     */
    public List&lt;ThemisDSMClass&gt; getReferencesTo(final ThemisDSMPackage pPackage) {
        /* If there are references */
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (theDirectReferences.contains(pPackage)) {</span>
            /* Loop through the classes */
<span class="nc" id="L366">            final List&lt;ThemisDSMClass&gt; myReferences = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">            for (ThemisDSMClass myClass : theClasses) {</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">                if (myClass.references(pPackage)) {</span>
<span class="nc" id="L369">                    myReferences.add(myClass);</span>
                }
<span class="nc" id="L371">            }</span>
<span class="nc" id="L372">            return myReferences;</span>
        }

        /* No references */
<span class="nc" id="L376">        return Collections.emptyList();</span>
    }

    /**
     * Compare this package to another package for sort order.
     * @param pThat the other package to compare to
     * @return true/false
     */
    public int compareTo(final ThemisDSMPackage pThat) {
        /* Handle simple dependency */
<span class="nc bnc" id="L386" title="All 2 branches missed.">        if (theImpliedReferences.contains(pThat)</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                &amp;&amp; !pThat.theImpliedReferences.contains(this)) {</span>
<span class="nc" id="L388">            return -1;</span>
        }
<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (pThat.theImpliedReferences.contains(this)</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">                &amp;&amp; !theImpliedReferences.contains(pThat)) {</span>
<span class="nc" id="L392">            return 1;</span>
        }

        /* Sort on number of dependencies */
<span class="nc" id="L396">        final int iDiff = pThat.theImpliedReferences.size()</span>
<span class="nc" id="L397">                - theImpliedReferences.size();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (iDiff != 0) {</span>
<span class="nc" id="L399">            return iDiff;</span>
        }

        /* If all else fails rely on alphabetical */
<span class="nc" id="L403">        return thePackage.compareTo(pThat.getPackageName());</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L408">        return getPackageName();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>