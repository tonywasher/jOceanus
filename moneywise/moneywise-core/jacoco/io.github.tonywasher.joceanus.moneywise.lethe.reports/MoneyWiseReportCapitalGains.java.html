<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseReportCapitalGains.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.moneywise.lethe.reports</a> &gt; <span class="el_source">MoneyWiseReportCapitalGains.java</span></div><h1>MoneyWiseReportCapitalGains.java</h1><pre class="source lang-java linenums">/*
 * MoneyWise: Finance Application
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.moneywise.lethe.reports;

import io.github.tonywasher.joceanus.oceanus.date.OceanusDate;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusDecimal;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusMoney;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusPrice;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusRatio;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusUnits;
import io.github.tonywasher.joceanus.oceanus.format.OceanusDataFormatter;
import io.github.tonywasher.joceanus.metis.report.MetisReportBase;
import io.github.tonywasher.joceanus.metis.report.MetisReportHTMLBuilder;
import io.github.tonywasher.joceanus.metis.report.MetisReportHTMLBuilder.MetisHTMLTable;
import io.github.tonywasher.joceanus.metis.report.MetisReportManager;
import io.github.tonywasher.joceanus.metis.report.MetisReportReferenceManager.DelayedTable;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseBasicDataType;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseBasicResource;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransaction.MoneyWiseTransactionList;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysis;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisSecurityBucket;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisSecurityAttr;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisSecurityValues;
import io.github.tonywasher.joceanus.moneywise.lethe.views.MoneyWiseAnalysisFilter;
import io.github.tonywasher.joceanus.moneywise.tax.MoneyWiseCashType;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

import java.util.Iterator;

/**
 * CapitalGains report builder.
 */
public class MoneyWiseReportCapitalGains
        extends MetisReportBase&lt;MoneyWiseAnalysis, MoneyWiseAnalysisFilter&lt;?, ?&gt;&gt; {
    /**
     * The Title text.
     */
<span class="nc" id="L56">    private static final String TEXT_TITLE = MoneyWiseReportResource.CAPITALGAINS_TITLE.getValue();</span>

    /**
     * HTML builder.
     */
    private final MetisReportHTMLBuilder theBuilder;

    /**
     * The Formatter.
     */
    private final OceanusDataFormatter theFormatter;

    /**
     * The string builder.
     */
    private final StringBuilder theStringBuilder;

    /**
     * The source SecurityBucket.
     */
    private MoneyWiseAnalysisSecurityBucket theSecurity;

    /**
     * The transactions.
     */
    private MoneyWiseTransactionList theTransactions;

    /**
     * The EndDate.
     */
    private OceanusDate theEndDate;

    /**
     * The table.
     */
    private MetisHTMLTable theTable;

    /**
     * The attribute table.
     */
    private MetisHTMLTable theAttrTable;

    /**
     * Constructor.
     *
     * @param pManager the Report Manager
     */
<span class="nc" id="L103">    protected MoneyWiseReportCapitalGains(final MetisReportManager&lt;MoneyWiseAnalysisFilter&lt;?, ?&gt;&gt; pManager) {</span>
        /* Access underlying utilities */
<span class="nc" id="L105">        theBuilder = pManager.getBuilder();</span>
<span class="nc" id="L106">        theFormatter = theBuilder.getDataFormatter();</span>
<span class="nc" id="L107">        theStringBuilder = new StringBuilder();</span>
<span class="nc" id="L108">    }</span>

    /**
     * Set the security bucket.
     *
     * @param pSecurity the security bucket
     */
    protected void setSecurity(final MoneyWiseAnalysisSecurityBucket pSecurity) {
<span class="nc" id="L116">        theSecurity = pSecurity;</span>
<span class="nc" id="L117">    }</span>

    @Override
    public Document createReport(final MoneyWiseAnalysis pAnalysis) {
        /* Access the securities and the date */
<span class="nc" id="L122">        theTransactions = pAnalysis.getEditSet().getDataList(MoneyWiseBasicDataType.TRANSACTION, MoneyWiseTransactionList.class);</span>
<span class="nc" id="L123">        theEndDate = pAnalysis.getDateRange().getEnd();</span>

        /* Start the report */
<span class="nc" id="L126">        final Element myBody = theBuilder.startReport();</span>
<span class="nc" id="L127">        theBuilder.makeTitle(myBody, TEXT_TITLE, theFormatter.formatObject(theEndDate));</span>
<span class="nc" id="L128">        theBuilder.makeSubTitle(myBody, theSecurity.getDecoratedName());</span>

        /* Initialise the table */
<span class="nc" id="L131">        theTable = theBuilder.startTable(myBody);</span>
<span class="nc" id="L132">        theBuilder.startHdrRow(theTable);</span>
<span class="nc" id="L133">        theBuilder.makeTitleCell(theTable, MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE.getValue());</span>
<span class="nc" id="L134">        theBuilder.makeTitleCell(theTable, MoneyWiseBasicDataType.TRANSACTION.getItemName());</span>

        /* Format the history */
<span class="nc" id="L137">        formatHistory();</span>

        /* Return the document */
<span class="nc" id="L140">        return theBuilder.getDocument();</span>
    }

    /**
     * format the cost history.
     */
    private void formatHistory() {
        /* Loop through the transactions */
<span class="nc" id="L148">        final Iterator&lt;MoneyWiseTransaction&gt; myIterator = theTransactions.iterator();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L150">            final MoneyWiseTransaction myTrans = myIterator.next();</span>

            /* Check for End of report */
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (theEndDate != null</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                    &amp;&amp; theEndDate.compareTo(myTrans.getDate()) &lt; 0) {</span>
<span class="nc" id="L155">                break;</span>
            }

            /* If the transaction relates to the security */
<span class="nc" id="L159">            final MoneyWiseAnalysisSecurityValues myValues = theSecurity.getValuesForTransaction(myTrans);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (myValues != null) {</span>
                /* Format the transaction */
<span class="nc" id="L162">                formatTransaction(myTrans, myValues);</span>

                /* If we have an attribute table */
<span class="nc bnc" id="L165" title="All 2 branches missed.">                if (theAttrTable != null) {</span>
                    /* Embed the table correctly and reset the indicator */
<span class="nc" id="L167">                    theBuilder.embedTable(theAttrTable);</span>
<span class="nc" id="L168">                    theAttrTable = null;</span>
                }
            }
<span class="nc" id="L171">        }</span>
<span class="nc" id="L172">    }</span>

    /**
     * Format the details.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatTransaction(final MoneyWiseTransaction pTrans,
                                   final MoneyWiseAnalysisSecurityValues pValues) {
        /* Switch on the class */
<span class="nc bnc" id="L183" title="All 7 branches missed.">        switch (pTrans.getCategoryClass()) {</span>
            case TRANSFER:
            case STOCKRIGHTSISSUE:
            case INHERITED:
<span class="nc" id="L187">                formatTransfer(pTrans, pValues);</span>
<span class="nc" id="L188">                break;</span>
            case SECURITYREPLACE:
            case STOCKTAKEOVER:
<span class="nc" id="L191">                formatStockTakeOver(pTrans, pValues);</span>
<span class="nc" id="L192">                break;</span>
            case STOCKDEMERGER:
<span class="nc" id="L194">                formatStockDeMerger(pTrans, pValues);</span>
<span class="nc" id="L195">                break;</span>
            case STOCKSPLIT:
            case UNITSADJUST:
<span class="nc" id="L198">                formatUnitsAdjust(pTrans, pValues);</span>
<span class="nc" id="L199">                break;</span>
            case DIVIDEND:
<span class="nc" id="L201">                formatDividend(pTrans, pValues);</span>
<span class="nc" id="L202">                break;</span>
            case PORTFOLIOXFER:
<span class="nc" id="L204">                formatPortfolioXfer(pTrans, pValues);</span>
<span class="nc" id="L205">                break;</span>
            default:
                break;
        }
<span class="nc" id="L209">    }</span>

    /**
     * Format basic details of a transaction.
     *
     * @param pTrans the transaction
     */
    private void formatBasicTransaction(final MoneyWiseTransaction pTrans) {
        /* Create the transaction row */
<span class="nc" id="L218">        theBuilder.startRow(theTable);</span>
<span class="nc" id="L219">        theBuilder.makeValueCell(theTable, pTrans.getDate());</span>
<span class="nc" id="L220">        theBuilder.makeValueCell(theTable, pTrans);</span>
<span class="nc" id="L221">    }</span>

    /**
     * Check whether this is a debit transaction for the security.
     *
     * @param pTrans the transaction
     * @return true/false
     */
    private boolean isDebit(final MoneyWiseTransaction pTrans) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        final MoneyWiseTransAsset myDebit = pTrans.getDirection().isTo()</span>
<span class="nc" id="L231">                ? pTrans.getAccount()</span>
<span class="nc" id="L232">                : pTrans.getPartner();</span>
<span class="nc" id="L233">        return myDebit.equals(theSecurity.getSecurityHolding());</span>
    }

    /**
     * Check whether this is a credit transaction for the security.
     *
     * @param pTrans the transaction
     * @return true/false
     */
    private boolean isCredit(final MoneyWiseTransaction pTrans) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">        final MoneyWiseTransAsset myCredit = pTrans.getDirection().isFrom()</span>
<span class="nc" id="L244">                ? pTrans.getAccount()</span>
<span class="nc" id="L245">                : pTrans.getPartner();</span>
<span class="nc" id="L246">        return myCredit.equals(theSecurity.getSecurityHolding());</span>
    }

    /**
     * Ensure the attribute table.
     */
    private void ensureAttrTable() {
        /* If we do not have a current attribute table */
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (theAttrTable == null) {</span>
            /* Create a new table */
<span class="nc" id="L256">            theAttrTable = theBuilder.createEmbeddedTable(theTable);</span>
        }
<span class="nc" id="L258">    }</span>

    /**
     * Format a value.
     *
     * @param pAttr  the attribute
     * @param pValue the value
     */
    private void formatValue(final MoneyWiseAnalysisSecurityAttr pAttr,
                             final Object pValue) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L269">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L272">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L273">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L274">        theBuilder.makeStretchedValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L275">    }</span>

    /**
     * Format a division.
     *
     * @param pAttr      the attribute
     * @param pValue     the value
     * @param pNumerator the numerator
     * @param pDivisor   the divisor
     */
    private void formatDivision(final MoneyWiseAnalysisSecurityAttr pAttr,
                                final Object pValue,
                                final OceanusDecimal pNumerator,
                                final OceanusDecimal pDivisor) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L290">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L293">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L294">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L295">        theBuilder.makeValueCell(theAttrTable, formatDivision(pNumerator, pDivisor));</span>
<span class="nc" id="L296">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L297">    }</span>

    /**
     * Format a division.
     *
     * @param pNumerator the numerator
     * @param pDivisor   the divisor
     * @return the formatted division
     */
    private String formatDivision(final OceanusDecimal pNumerator,
                                  final OceanusDecimal pDivisor) {
<span class="nc" id="L308">        return formatCombination(pNumerator, pDivisor, '/');</span>
    }

    /**
     * Format a valuation.
     *
     * @param pAttr        the attribute
     * @param pValue       the value
     * @param pUnits       the units
     * @param pPrice       the price
     * @param pXchangeRate the exchange rate
     */
    private void formatValuation(final MoneyWiseAnalysisSecurityAttr pAttr,
                                 final Object pValue,
                                 final OceanusUnits pUnits,
                                 final OceanusPrice pPrice,
                                 final OceanusRatio pXchangeRate) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L326">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L329">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L330">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L331">        theBuilder.makeValueCell(theAttrTable, formatValuation(pUnits, pPrice, pXchangeRate));</span>
<span class="nc" id="L332">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L333">    }</span>

    /**
     * Format a valuation.
     *
     * @param pUnits       the units
     * @param pPrice       the price
     * @param pXchangeRate the exchange rate
     * @return the formatted valuation
     */
    private String formatValuation(final OceanusUnits pUnits,
                                   final OceanusPrice pPrice,
                                   final OceanusRatio pXchangeRate) {
<span class="nc" id="L346">        theStringBuilder.setLength(0);</span>
<span class="nc" id="L347">        theStringBuilder.append(theFormatter.formatObject(pUnits));</span>
<span class="nc" id="L348">        theStringBuilder.append('@');</span>
<span class="nc" id="L349">        theStringBuilder.append(theFormatter.formatObject(pPrice));</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (pXchangeRate != null) {</span>
<span class="nc" id="L351">            theStringBuilder.append('/');</span>
<span class="nc" id="L352">            theStringBuilder.append(theFormatter.formatObject(pXchangeRate));</span>
        }
<span class="nc" id="L354">        return theStringBuilder.toString();</span>
    }

    /**
     * Format a multiplication.
     *
     * @param pAttr   the attribute
     * @param pValue  the value
     * @param pFirst  the first item
     * @param pSecond the second item
     */
    private void formatMultiplication(final MoneyWiseAnalysisSecurityAttr pAttr,
                                      final Object pValue,
                                      final OceanusDecimal pFirst,
                                      final OceanusDecimal pSecond) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L370">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L373">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L374">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L375">        theBuilder.makeValueCell(theAttrTable, formatMultiplication(pFirst, pSecond));</span>
<span class="nc" id="L376">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L377">    }</span>

    /**
     * Format a multiplication.
     *
     * @param pFirst  the first item
     * @param pSecond the second item
     * @return the formatted multiplication
     */
    private String formatMultiplication(final OceanusDecimal pFirst,
                                        final OceanusDecimal pSecond) {
<span class="nc" id="L388">        return formatCombination(pFirst, pSecond, '*');</span>
    }

    /**
     * Format an addition.
     *
     * @param pAttr   the attribute
     * @param pValue  the value
     * @param pFirst  the first item
     * @param pSecond the second item
     */
    private void formatAddition(final MoneyWiseAnalysisSecurityAttr pAttr,
                                final Object pValue,
                                final OceanusDecimal pFirst,
                                final OceanusDecimal pSecond) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L404">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L407">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L408">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L409">        theBuilder.makeValueCell(theAttrTable, formatAddition(pFirst, pSecond));</span>
<span class="nc" id="L410">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L411">    }</span>

    /**
     * Format an addition.
     *
     * @param pFirst  the first item
     * @param pSecond the second item
     * @return the formatted addition
     */
    private String formatAddition(final OceanusDecimal pFirst,
                                  final OceanusDecimal pSecond) {
<span class="nc" id="L422">        return formatCombination(pFirst, pSecond, '+');</span>
    }

    /**
     * Format a subtraction.
     *
     * @param pAttr   the attribute
     * @param pValue  the value
     * @param pFirst  the first item
     * @param pSecond the second item
     */
    private void formatSubtraction(final MoneyWiseAnalysisSecurityAttr pAttr,
                                   final Object pValue,
                                   final OceanusDecimal pFirst,
                                   final OceanusDecimal pSecond) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L438">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L441">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L442">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L443">        theBuilder.makeValueCell(theAttrTable, formatSubtraction(pFirst, pSecond));</span>
<span class="nc" id="L444">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L445">    }</span>

    /**
     * Format a subtraction.
     *
     * @param pFirst  the first item
     * @param pSecond the second item
     * @return the formatted subtraction
     */
    private String formatSubtraction(final OceanusDecimal pFirst,
                                     final OceanusDecimal pSecond) {
<span class="nc" id="L456">        return formatCombination(pFirst, pSecond, '-');</span>
    }

    /**
     * Format a combination.
     *
     * @param pFirst  the first item
     * @param pSecond the second item
     * @param pSymbol the symbol
     * @return the formatted combination
     */
    private String formatCombination(final OceanusDecimal pFirst,
                                     final OceanusDecimal pSecond,
                                     final char pSymbol) {
<span class="nc" id="L470">        theStringBuilder.setLength(0);</span>
<span class="nc" id="L471">        theStringBuilder.append(theFormatter.formatObject(pFirst));</span>
<span class="nc" id="L472">        theStringBuilder.append(pSymbol);</span>
<span class="nc" id="L473">        theStringBuilder.append(theFormatter.formatObject(pSecond));</span>
<span class="nc" id="L474">        return theStringBuilder.toString();</span>
    }

    /**
     * Format a Transfer.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatTransfer(final MoneyWiseTransaction pTrans,
                                final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L486">        formatBasicTransaction(pTrans);</span>

        /* Split workings for transfer in/out */
<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (isDebit(pTrans)) {</span>
<span class="nc" id="L490">            formatTransferOut(pTrans, pValues);</span>
        } else {
<span class="nc" id="L492">            formatTransferIn(pTrans, pValues);</span>
        }
<span class="nc" id="L494">    }</span>

    /**
     * Format a Dividend.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatDividend(final MoneyWiseTransaction pTrans,
                                final MoneyWiseAnalysisSecurityValues pValues) {
        /* If this is a dividend re-investment */
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (isCredit(pTrans)) {</span>
            /* Format the basic transaction */
<span class="nc" id="L507">            formatBasicTransaction(pTrans);</span>

            /* Deal as investment */
<span class="nc" id="L510">            formatTransferIn(pTrans, pValues);</span>
        }
<span class="nc" id="L512">    }</span>

    /**
     * Format transfer money in.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatTransferIn(final MoneyWiseTransaction pTrans,
                                  final MoneyWiseAnalysisSecurityValues pValues) {

        /* Access interesting values */
<span class="nc" id="L524">        final OceanusUnits myUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L525">        OceanusUnits myDeltaUnits = pTrans.getAccountDeltaUnits();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (myDeltaUnits == null) {</span>
<span class="nc" id="L527">            myDeltaUnits = pTrans.getPartnerDeltaUnits();</span>
        }
<span class="nc" id="L529">        final OceanusMoney myCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L530">        final OceanusMoney myAmount = theSecurity.getMoneyDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L531">        final OceanusPrice myPrice = pValues.getPriceValue(MoneyWiseAnalysisSecurityAttr.PRICE);</span>
<span class="nc" id="L532">        final OceanusRatio myXchangeRate = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE);</span>

        /* Obtain the original units/cost */
<span class="nc" id="L535">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L536">        final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L537">        final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>

        /* If this is an inheritance */
<span class="nc bnc" id="L540" title="All 2 branches missed.">        if (pTrans.isCategoryClass(MoneyWiseTransCategoryClass.INHERITED)) {</span>
<span class="nc" id="L541">            formatValuation(MoneyWiseAnalysisSecurityAttr.INVESTED, myAmount, myDeltaUnits, myPrice, myXchangeRate);</span>
        } else {
<span class="nc" id="L543">            formatValue(MoneyWiseAnalysisSecurityAttr.INVESTED, myAmount);</span>
        }

        /* Record the details */
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (myDeltaUnits != null) {</span>
<span class="nc" id="L548">            formatAddition(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>
        }
<span class="nc" id="L550">        formatAddition(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost, myOriginalCost, myAmount);</span>
<span class="nc" id="L551">    }</span>

    /**
     * Format transfer money out.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatTransferOut(final MoneyWiseTransaction pTrans,
                                   final MoneyWiseAnalysisSecurityValues pValues) {
        /* Access interesting values */
<span class="nc" id="L562">        final OceanusMoney myGain = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN);</span>
<span class="nc" id="L563">        final OceanusMoney myAllowedCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST);</span>
<span class="nc" id="L564">        final OceanusRatio myCostDilution = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION);</span>
<span class="nc" id="L565">        final OceanusMoney myTotalGains = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS);</span>
<span class="nc" id="L566">        final OceanusMoney myCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L567">        final OceanusUnits myUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L568">        final OceanusMoney myCash = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH);</span>
<span class="nc" id="L569">        final OceanusMoney myConsideration = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.CONSIDERATION);</span>
<span class="nc" id="L570">        final MoneyWiseCashType myCashType = pValues.getEnumValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, MoneyWiseCashType.class);</span>

        /* Obtain the original values */
<span class="nc" id="L573">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L574">        final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L575">        final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>

        /* Obtain the delta in units/money */
<span class="nc" id="L578">        OceanusUnits myDeltaUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L579">        final OceanusMoney myAmount = new OceanusMoney(myCash);</span>
<span class="nc" id="L580">        myAmount.negate();</span>

        /* Report the returned cash */
<span class="nc" id="L583">        formatValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH, myCash);</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">        if (myCashType != null) {</span>
<span class="nc" id="L585">            formatValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, myCashType);</span>
        }

        /* If we have changed the number of units */
<span class="nc bnc" id="L589" title="All 2 branches missed.">        if (myDeltaUnits.isNonZero()) {</span>
            /* Obtain the various values */
<span class="nc" id="L591">            myDeltaUnits = new OceanusUnits(myDeltaUnits);</span>
<span class="nc" id="L592">            myDeltaUnits.negate();</span>

            /* Format the units */
<span class="nc" id="L595">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>

            /* Format the dilution */
<span class="nc" id="L598">            formatDivision(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution, myUnits, myOriginalUnits);</span>

            /* Else we need to format the cost dilution */
<span class="nc bnc" id="L601" title="All 2 branches missed.">        } else if (myConsideration != null) {</span>
            /* Format the valuation */
<span class="nc" id="L603">            final OceanusMoney myValuation = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.VALUATION);</span>
<span class="nc" id="L604">            final OceanusPrice myPrice = pValues.getPriceValue(MoneyWiseAnalysisSecurityAttr.PRICE);</span>
<span class="nc" id="L605">            final OceanusRatio myXchangeRate = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE);</span>
<span class="nc" id="L606">            formatValuation(MoneyWiseAnalysisSecurityAttr.VALUATION, myValuation, myUnits, myPrice, myXchangeRate);</span>
<span class="nc" id="L607">            formatAddition(MoneyWiseAnalysisSecurityAttr.CONSIDERATION, myConsideration, myCash, myValuation);</span>

            /* Format the dilution */
<span class="nc" id="L610">            formatDivision(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution, myValuation, myConsideration);</span>
        }

        /* Record the details */
<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (myCostDilution != null) {</span>
<span class="nc" id="L615">            formatMultiplication(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost, myOriginalCost, myCostDilution);</span>
<span class="nc" id="L616">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost, myOriginalCost, myCost);</span>
        } else {
<span class="nc" id="L618">            formatValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost);</span>
<span class="nc" id="L619">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost, myOriginalCost, myAllowedCost);</span>
        }

        /* Record the gains allocation */
<span class="nc bnc" id="L623" title="All 2 branches missed.">        if (myGain != null) {</span>
<span class="nc" id="L624">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN, myGain, myCash, myAllowedCost);</span>
<span class="nc" id="L625">            formatValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myTotalGains);</span>
        }
<span class="nc" id="L627">    }</span>

    /**
     * Format a Units Adjustment.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatUnitsAdjust(final MoneyWiseTransaction pTrans,
                                   final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L638">        formatBasicTransaction(pTrans);</span>

        /* Access interesting values */
<span class="nc" id="L641">        final OceanusUnits myUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L642">        OceanusUnits myDeltaUnits = pTrans.getAccountDeltaUnits();</span>

        /* Obtain the original units */
<span class="nc" id="L645">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L646">        final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>

        /* Record the details */
<span class="nc bnc" id="L649" title="All 2 branches missed.">        if (myDeltaUnits.isPositive()) {</span>
<span class="nc" id="L650">            formatAddition(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>
        } else {
<span class="nc" id="L652">            myDeltaUnits = new OceanusUnits(myDeltaUnits);</span>
<span class="nc" id="L653">            myDeltaUnits.negate();</span>
<span class="nc" id="L654">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>
        }
<span class="nc" id="L656">    }</span>

    /**
     * Format a Stock DeMerger.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatStockDeMerger(final MoneyWiseTransaction pTrans,
                                     final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L667">        formatBasicTransaction(pTrans);</span>

        /* Split workings for credit and debit */
<span class="nc bnc" id="L670" title="All 2 branches missed.">        if (isDebit(pTrans)) {</span>
<span class="nc" id="L671">            formatDebitStockDeMerger(pTrans, pValues);</span>
        } else {
<span class="nc" id="L673">            formatCreditStockDeMerger(pTrans, pValues);</span>
        }
<span class="nc" id="L675">    }</span>

    /**
     * Format debit side of a Stock DeMerger.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatDebitStockDeMerger(final MoneyWiseTransaction pTrans,
                                          final MoneyWiseAnalysisSecurityValues pValues) {
        /* Access interesting values */
<span class="nc" id="L686">        final OceanusRatio myCostDilution = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION);</span>
<span class="nc" id="L687">        final OceanusMoney myResidualCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L688">        final OceanusMoney myXferredCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L689">        OceanusUnits myDeltaUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>

        /* Check whether the units have changed */
<span class="nc" id="L692">        final boolean isDeltaUnits = myDeltaUnits.isNonZero();</span>

        /* Obtain the original cost */
<span class="nc" id="L695">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L696">        final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>

        /* If we have changed the number of units */
<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (isDeltaUnits) {</span>
            /* Obtain the various values */
<span class="nc" id="L701">            final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L702">            final OceanusUnits myUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L703">            myDeltaUnits = new OceanusUnits(myDeltaUnits);</span>
<span class="nc" id="L704">            myDeltaUnits.negate();</span>

            /* Format the units/dilution */
<span class="nc" id="L707">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>
<span class="nc" id="L708">            formatDivision(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution, myUnits, myOriginalUnits);</span>

            /* else just report the dilution */
<span class="nc" id="L711">        } else {</span>
<span class="nc" id="L712">            formatValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution);</span>
        }

        /* Record the details */
<span class="nc" id="L716">        formatMultiplication(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myResidualCost, myOriginalCost, myCostDilution);</span>
<span class="nc" id="L717">        formatSubtraction(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myXferredCost, myOriginalCost, myResidualCost);</span>
<span class="nc" id="L718">    }</span>

    /**
     * Format credit side of a Stock DeMerger.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatCreditStockDeMerger(final MoneyWiseTransaction pTrans,
                                           final MoneyWiseAnalysisSecurityValues pValues) {
        /* Access interesting values */
<span class="nc" id="L729">        final OceanusMoney myResidualCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L730">        final OceanusMoney myXferredCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L731">        final OceanusMoney myValueXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE);</span>
<span class="nc" id="L732">        final OceanusUnits myUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L733">        final OceanusPrice myPrice = pValues.getPriceValue(MoneyWiseAnalysisSecurityAttr.PRICE);</span>
<span class="nc" id="L734">        final OceanusRatio myXchangeRate = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE);</span>

        /* Record the details */
<span class="nc" id="L737">        formatValuation(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myValueXfer, myUnits, myPrice, myXchangeRate);</span>
<span class="nc" id="L738">        formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myXferredCost);</span>
<span class="nc" id="L739">        formatValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myResidualCost);</span>
<span class="nc" id="L740">    }</span>

    /**
     * Format a Stock TakeOver.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatStockTakeOver(final MoneyWiseTransaction pTrans,
                                     final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L751">        formatBasicTransaction(pTrans);</span>

        /* Split out Stock and Cash TakeOver */
<span class="nc" id="L754">        final OceanusMoney myCash = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH);</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">        if (myCash != null) {</span>
<span class="nc" id="L756">            formatStockAndCashTakeOver(pTrans, pValues, myCash);</span>

            /* Split workings for credit and debit */
<span class="nc bnc" id="L759" title="All 2 branches missed.">        } else if (isDebit(pTrans)) {</span>
            /* Record the transfer of cost for simple replacement takeOver */
<span class="nc" id="L761">            final OceanusMoney myCostXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L762">            formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer);</span>
<span class="nc" id="L763">        } else {</span>
<span class="nc" id="L764">            formatCreditStockTakeOver(pTrans, pValues);</span>
        }
<span class="nc" id="L766">    }</span>

    /**
     * Format a StockAndCash TakeOver.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     * @param pCash   the cash consideration
     */
    private void formatStockAndCashTakeOver(final MoneyWiseTransaction pTrans,
                                            final MoneyWiseAnalysisSecurityValues pValues,
                                            final OceanusMoney pCash) {
        /* Split workings for credit and debit */
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (isDebit(pTrans)) {</span>
<span class="nc" id="L780">            formatDebitStockAndCashTakeOver(pTrans, pValues, pCash);</span>
        } else {
<span class="nc" id="L782">            formatCreditStockTakeOver(pTrans, pValues);</span>
        }
<span class="nc" id="L784">    }</span>

    /**
     * Format debit side of a StockAndCash TakeOver.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     * @param pCash   the cash consideration
     */
    private void formatDebitStockAndCashTakeOver(final MoneyWiseTransaction pTrans,
                                                 final MoneyWiseAnalysisSecurityValues pValues,
                                                 final OceanusMoney pCash) {
        /* Access interesting values */
<span class="nc" id="L797">        final OceanusMoney myStock = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE);</span>
<span class="nc" id="L798">        final OceanusMoney myConsideration = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.CONSIDERATION);</span>
<span class="nc" id="L799">        final OceanusMoney myCostXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L800">        final OceanusRatio myCostDilution = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION);</span>
<span class="nc" id="L801">        final OceanusMoney myAllowedCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST);</span>
<span class="nc" id="L802">        final OceanusMoney myGain = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN);</span>
<span class="nc" id="L803">        final OceanusMoney myTotalGains = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS);</span>
<span class="nc" id="L804">        final MoneyWiseCashType myCashType = pValues.getEnumValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, MoneyWiseCashType.class);</span>

        /* Record the calculation of total consideration */
<span class="nc" id="L807">        formatValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH, pCash);</span>
<span class="nc" id="L808">        formatValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, myCashType);</span>
<span class="nc" id="L809">        formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myStock);</span>
<span class="nc" id="L810">        formatAddition(MoneyWiseAnalysisSecurityAttr.CONSIDERATION, myConsideration, pCash, myStock);</span>

        /* Obtain the original cost */
<span class="nc" id="L813">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L814">        final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>

        /* Format the cost dilution */
<span class="nc bnc" id="L817" title="All 2 branches missed.">        if (myCostDilution != null) {</span>
<span class="nc" id="L818">            formatDivision(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution, pCash, myConsideration);</span>
<span class="nc" id="L819">            formatMultiplication(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost, myOriginalCost, myCostDilution);</span>
        } else {
<span class="nc" id="L821">            formatValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost);</span>
        }
<span class="nc" id="L823">        formatSubtraction(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer, myOriginalCost, myAllowedCost);</span>

        /* Record the gains allocation */
<span class="nc bnc" id="L826" title="All 2 branches missed.">        if (myGain != null) {</span>
<span class="nc" id="L827">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN, myGain, pCash, myAllowedCost);</span>
<span class="nc" id="L828">            formatValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myTotalGains);</span>
        }
<span class="nc" id="L830">    }</span>

    /**
     * Format credit side of a StockAndCash TakeOver.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatCreditStockTakeOver(final MoneyWiseTransaction pTrans,
                                           final MoneyWiseAnalysisSecurityValues pValues) {
        /* Access interesting values */
<span class="nc" id="L841">        final OceanusPrice myPrice = pValues.getPriceValue(MoneyWiseAnalysisSecurityAttr.PRICE);</span>
<span class="nc" id="L842">        final OceanusUnits myUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L843">        final OceanusMoney myValueXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE);</span>
<span class="nc" id="L844">        final OceanusMoney myCostXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L845">        final OceanusMoney myResidualCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L846">        final OceanusRatio myXchangeRate = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE);</span>

        /* Detail the new units and cost */
<span class="nc" id="L849">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L850">        final OceanusUnits myNewUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L851">        final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L852">        formatAddition(MoneyWiseAnalysisSecurityAttr.UNITS, myNewUnits, myOriginalUnits, myUnits);</span>

        /* Record the transfer of value and cost */
<span class="nc" id="L855">        formatValuation(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myValueXfer, myUnits, myPrice, myXchangeRate);</span>
<span class="nc" id="L856">        formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer);</span>
<span class="nc" id="L857">        formatValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myResidualCost);</span>
<span class="nc" id="L858">    }</span>

    /**
     * Format a Stock DeMerger.
     *
     * @param pTrans  the transaction
     * @param pValues the values for the transaction
     */
    private void formatPortfolioXfer(final MoneyWiseTransaction pTrans,
                                     final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L869">        formatBasicTransaction(pTrans);</span>

        /* Determine the direction of transfer */
<span class="nc" id="L872">        final OceanusMoney myCostXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L873">        formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer);</span>

<span class="nc" id="L875">        final OceanusUnits myUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">        if (myUnits.isPositive()) {</span>
            /* Detail the new units and cost */
<span class="nc" id="L878">            final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L879">            final OceanusUnits myNewUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L880">            final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L881">            formatAddition(MoneyWiseAnalysisSecurityAttr.UNITS, myNewUnits, myOriginalUnits, myUnits);</span>
<span class="nc" id="L882">            final OceanusMoney myCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L883">            final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L884">            formatAddition(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost, myOriginalCost, myCostXfer);</span>
        }
<span class="nc" id="L886">    }</span>

    @Override
    public MoneyWiseAnalysisFilter&lt;?, ?&gt; processFilter(final Object pSource) {
<span class="nc" id="L890">        return null;</span>
    }

    @Override
    public MetisHTMLTable createDelayedTable(final DelayedTable pTable) {
<span class="nc" id="L895">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>