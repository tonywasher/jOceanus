<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseAnalysisView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.lethe.views</a> &gt; <span class="el_source">MoneyWiseAnalysisView.java</span></div><h1>MoneyWiseAnalysisView.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.lethe.views;

import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.metis.field.MetisFieldItem;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseBasicDataType;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransInfo;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransInfo.MoneyWiseTransInfoList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction.MoneyWiseTransactionList;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseStaticDataType;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransInfoType.MoneyWiseTransInfoTypeList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.analyse.MoneyWiseAnalysisTransAnalyser;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysis;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisDataResource;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisManager;
import net.sourceforge.joceanus.moneywise.views.MoneyWiseView;
import net.sourceforge.joceanus.moneywise.views.MoneyWiseViewResource;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.date.OceanusDateRange;
import net.sourceforge.joceanus.oceanus.event.OceanusEventManager;
import net.sourceforge.joceanus.oceanus.event.OceanusEventRegistrar;
import net.sourceforge.joceanus.oceanus.event.OceanusEventRegistrar.OceanusEventProvider;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.oceanus.logger.OceanusLogManager;
import net.sourceforge.joceanus.oceanus.logger.OceanusLogger;
import net.sourceforge.joceanus.oceanus.profile.OceanusProfile;
import net.sourceforge.joceanus.prometheus.views.PrometheusDataEvent;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditEntry;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditSet;

import java.util.Iterator;

/**
 * Analysis Edit View.
 */
public class MoneyWiseAnalysisView
        implements MetisFieldItem, OceanusEventProvider&lt;PrometheusDataEvent&gt; {
    /**
     * Report fields.
     */
<span class="nc" id="L59">    private static final MetisFieldSet&lt;MoneyWiseAnalysisView&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseAnalysisView.class);</span>

    /*
     * Declare Fields.
     */
    static {
<span class="nc" id="L65">        FIELD_DEFS.declareLocalField(MoneyWiseViewResource.ANALYSISVIEW_UPDATESET, MoneyWiseAnalysisView::getEditSet);</span>
<span class="nc" id="L66">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_NAME, MoneyWiseAnalysisView::getAnalysis);</span>
    }

    /**
     * Logger.
     */
<span class="nc" id="L72">    private static final OceanusLogger LOGGER = OceanusLogManager.getLogger(MoneyWiseAnalysisView.class);</span>

    /**
     * The Event Manager.
     */
    private final OceanusEventManager&lt;PrometheusDataEvent&gt; theEventManager;

    /**
     * The View.
     */
    private final MoneyWiseView theView;

    /**
     * The UpdateSet.
     */
    private final PrometheusEditSet theEditSet;

    /**
     * The event entry.
     */
    private final PrometheusEditEntry&lt;MoneyWiseTransaction&gt; theTransEntry;

    /**
     * The info entry.
     */
    private final PrometheusEditEntry&lt;MoneyWiseTransInfo&gt; theInfoEntry;

    /**
     * The transactions.
     */
    private MoneyWiseTransactionView theTransactions;

    /**
     * Analysis Manager.
     */
    private MoneyWiseAnalysisManager theManager;

    /**
     * The active analysis.
     */
    private MoneyWiseAnalysis theAnalysis;

    /**
     * The current range.
     */
    private OceanusDateRange theRange;

    /**
     * Constructor.
     * @param pView the view
     * @param pEditSet the edit set
     */
    public MoneyWiseAnalysisView(final MoneyWiseView pView,
<span class="nc" id="L125">                                 final PrometheusEditSet pEditSet) {</span>
        /* Store update set */
<span class="nc" id="L127">        theView = pView;</span>
<span class="nc" id="L128">        theEditSet = pEditSet;</span>

        /* Register data entries */
<span class="nc" id="L131">        theTransEntry = theEditSet.registerType(MoneyWiseBasicDataType.TRANSACTION);</span>
<span class="nc" id="L132">        theInfoEntry = theEditSet.registerType(MoneyWiseBasicDataType.TRANSACTIONINFO);</span>

        /* Create event manager */
<span class="nc" id="L135">        theEventManager = new OceanusEventManager&lt;&gt;();</span>
<span class="nc" id="L136">    }</span>

    @Override
    public MetisFieldSet&lt;MoneyWiseAnalysisView&gt; getDataFieldSet() {
<span class="nc" id="L140">        return FIELD_DEFS;</span>
    }

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L145">        return FIELD_DEFS.getName();</span>
    }

    @Override
    public OceanusEventRegistrar&lt;PrometheusDataEvent&gt; getEventRegistrar() {
<span class="nc" id="L150">        return theEventManager.getEventRegistrar();</span>
    }

    /**
     * Obtain the active analysis.
     * @return the active analysis
     */
    public MoneyWiseAnalysis getAnalysis() {
<span class="nc" id="L158">        return theAnalysis;</span>
    }

    /**
     * Obtain the editSet.
     * @return the editSet
     */
    private PrometheusEditSet getEditSet() {
<span class="nc" id="L166">        return theEditSet;</span>
    }

    /**
     * Obtain the transaction list.
     * @return the transaction list
     */
    public MoneyWiseTransactionList getTransactions() {
<span class="nc" id="L174">        return theTransactions;</span>
    }

    /**
     * Obtain the range.
     * @return the range
     */
    public OceanusDateRange getRange() {
<span class="nc" id="L182">        return theRange;</span>
    }

    /**
     * Refresh data.
     */
    public void refreshData() {
        /* Protect against exceptions */
        try {
            /* Access the new analysis manager */
<span class="nc" id="L192">            theManager = theView.getAnalysisManager();</span>
<span class="nc" id="L193">            theEditSet.setDataSet(theView.getData());</span>

            /* If we have a range */
<span class="nc bnc" id="L196" title="All 2 branches missed.">            if (theRange != null) {</span>
                /* Obtain the required analysis and reset to it */
<span class="nc" id="L198">                theAnalysis = theManager.getRangedAnalysis(theRange);</span>

                /* Create the new transaction list */
<span class="nc" id="L201">                final MoneyWiseDataSet myData = theView.getData();</span>
<span class="nc" id="L202">                theTransactions = new MoneyWiseTransactionView(myData.getTransactions());</span>

                /* else no range */
<span class="nc" id="L205">            } else {</span>
                /* Set nulls */
<span class="nc" id="L207">                theAnalysis = null;</span>
<span class="nc" id="L208">                theTransactions = null;</span>
            }

            /* register the lists */
<span class="nc" id="L212">            registerLists();</span>

            /* Notify listeners */
<span class="nc" id="L215">            theEventManager.fireEvent(PrometheusDataEvent.ADJUSTVISIBILITY);</span>

<span class="nc" id="L217">        } catch (OceanusException e) {</span>
<span class="nc" id="L218">            LOGGER.error(&quot;Failed to refreshData&quot;, e);</span>
<span class="nc" id="L219">        }</span>
<span class="nc" id="L220">    }</span>

    /**
     * Set the selected date range.
     * @param pRange the date range
     */
    public void setRange(final OceanusDateRange pRange) {
        /* If we have changed the range */
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(theRange, pRange)) {</span>
            /* Obtain the required analysis and reset to it */
<span class="nc" id="L230">            theRange = pRange;</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">            theAnalysis = theManager == null ? null : theManager.getRangedAnalysis(theRange);</span>

            /* Notify listeners */
<span class="nc" id="L234">            theEventManager.fireEvent(PrometheusDataEvent.ADJUSTVISIBILITY);</span>
        }
<span class="nc" id="L236">    }</span>

    /**
     * /** Register lists.
     */
    private void registerLists() {
        /* If we have transactions */
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (theTransactions != null) {</span>
<span class="nc" id="L244">            final MoneyWiseTransInfoList myInfo = theTransactions.getTransactionInfo();</span>
<span class="nc" id="L245">            theTransEntry.setDataList(theTransactions);</span>
<span class="nc" id="L246">            theInfoEntry.setDataList(myInfo);</span>
<span class="nc" id="L247">        } else {</span>
<span class="nc" id="L248">            theTransEntry.setDataList(null);</span>
<span class="nc" id="L249">            theInfoEntry.setDataList(null);</span>
        }
<span class="nc" id="L251">    }</span>

    /**
     * TransactionView class.
     */
    private final class MoneyWiseTransactionView
            extends MoneyWiseTransactionList {
        /**
         * Constructor.
         * @param pSource the source transaction list
         * @throws OceanusException on error
         */
<span class="nc" id="L263">        private MoneyWiseTransactionView(final MoneyWiseTransactionList pSource) throws OceanusException {</span>
            /* Initialise as edit list */
<span class="nc" id="L265">            super(pSource);</span>
<span class="nc" id="L266">            setStyle(PrometheusListStyle.EDIT);</span>
<span class="nc" id="L267">            setEditSet(theEditSet);</span>
<span class="nc" id="L268">            theEditSet.setEditEntryList(MoneyWiseBasicDataType.TRANSACTION, this);</span>

            /* Store InfoType list */
<span class="nc" id="L271">            setTransInfoTypes(theEditSet.getDataList(MoneyWiseStaticDataType.TRANSINFOTYPE, MoneyWiseTransInfoTypeList.class));</span>

            /* Create and store info List */
<span class="nc" id="L274">            final MoneyWiseTransInfoList myTransInfo = pSource.getTransactionInfo().getEmptyList(PrometheusListStyle.EDIT);</span>
<span class="nc" id="L275">            theEditSet.setEditEntryList(MoneyWiseBasicDataType.TRANSACTIONINFO, myTransInfo);</span>
<span class="nc" id="L276">            setTransactionInfo(myTransInfo);</span>

            /* Loop through the Transactions extracting relevant elements */
<span class="nc" id="L279">            final Iterator&lt;MoneyWiseTransaction&gt; myIterator = pSource.iterator();</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L281">                final MoneyWiseTransaction myCurr = myIterator.next();</span>

                /* Ignore deleted events */
<span class="nc bnc" id="L284" title="All 2 branches missed.">                if (myCurr.isDeleted()) {</span>
<span class="nc" id="L285">                    continue;</span>
                }

                /* Build the new linked transaction and add it to the list */
<span class="nc" id="L289">                final MoneyWiseTransaction myTrans = new MoneyWiseTransaction(this, myCurr);</span>
<span class="nc" id="L290">                add(myTrans);</span>
<span class="nc" id="L291">                myTrans.resolveEditSetLinks();</span>

                /* Adjust the map */
<span class="nc" id="L294">                myTrans.adjustMapForItem();</span>
<span class="nc" id="L295">            }</span>
<span class="nc" id="L296">        }</span>

        @Override
        public void postProcessOnUpdate() {
            /* Pass call on */
<span class="nc" id="L301">            super.postProcessOnUpdate();</span>

            /* Obtain the active profile */
<span class="nc" id="L304">            OceanusProfile myTask = theView.getActiveTask();</span>
<span class="nc" id="L305">            myTask = myTask.startTask(&quot;updateAnalysis&quot;);</span>

            /* Protect against exceptions */
            try {
                /* Sort the transaction list */
<span class="nc" id="L310">                myTask.startTask(&quot;sortTransactions&quot;);</span>
<span class="nc" id="L311">                reSort();</span>

                /* Initialise the analysis */
<span class="nc" id="L314">                myTask.startTask(&quot;UpdateMaps&quot;);</span>
<span class="nc" id="L315">                theView.getData().updateMaps();</span>

                /* Analyse the data */
<span class="nc" id="L318">                myTask.startTask(&quot;analyseData&quot;);</span>
<span class="nc" id="L319">                final MoneyWiseAnalysisTransAnalyser myAnalyser = new MoneyWiseAnalysisTransAnalyser(myTask, theEditSet, theView.getPreferenceManager());</span>
<span class="nc" id="L320">                final MoneyWiseAnalysis myAnalysis = myAnalyser.getAnalysis();</span>
<span class="nc" id="L321">                theManager = new MoneyWiseAnalysisManager(myAnalysis);</span>
<span class="nc" id="L322">                theAnalysis = theManager.getRangedAnalysis(theRange);</span>

                /* Notify listeners */
<span class="nc" id="L325">                myTask.startTask(&quot;Notify&quot;);</span>
<span class="nc" id="L326">                theEventManager.fireEvent(PrometheusDataEvent.ADJUSTVISIBILITY);</span>

                /* Catch exceptions */
<span class="nc" id="L329">            } catch (OceanusException e) {</span>
<span class="nc" id="L330">                LOGGER.error(&quot;Failed to analyse changes&quot;, e);</span>
<span class="nc" id="L331">            }</span>
<span class="nc" id="L332">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>