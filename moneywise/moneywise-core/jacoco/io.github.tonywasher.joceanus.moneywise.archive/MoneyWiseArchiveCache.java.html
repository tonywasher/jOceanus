<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseArchiveCache.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.moneywise.archive</a> &gt; <span class="el_source">MoneyWiseArchiveCache.java</span></div><h1>MoneyWiseArchiveCache.java</h1><pre class="source lang-java linenums">/*
 * MoneyWise: Finance Application
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.moneywise.archive;

import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDate;
import io.github.tonywasher.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetBase;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetDirection;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetType;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseBasicDataType;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseBasicResource;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseDataSet;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWisePortfolio;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWisePortfolio.MoneyWisePortfolioList;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurity;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding.MoneyWiseSecurityHoldingMap;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransaction.MoneyWiseTransactionList;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import io.github.tonywasher.joceanus.moneywise.exc.MoneyWiseDataException;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataItem;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataValues;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Objects;

/**
 * Parent Cache details.
 */
public final class MoneyWiseArchiveCache {
    /**
     * DataSet.
     */
    private final MoneyWiseDataSet theData;

    /**
     * TransactionList.
     */
    private final MoneyWiseTransactionList theList;

    /**
     * The map of names to assets.
     */
    private final Map&lt;String, Object&gt; theNameMap;

    /**
     * The map of names-&gt;categories.
     */
    private final Map&lt;String, MoneyWiseTransCategory&gt; theCategoryMap;

    /**
     * The list of years.
     */
    private final List&lt;MoneyWiseArchiveYear&gt; theYears;

    /**
     * Are we filtering?.
     */
    private boolean enableFiltering;

    /**
     * Last Parent.
     */
    private MoneyWiseTransaction theLastParent;

    /**
     * Last Debit.
     */
    private Object theLastDebit;

    /**
     * Last Credit.
     */
    private Object theLastCredit;

    /**
     * The parent.
     */
    private MoneyWiseTransaction theParent;

    /**
     * Split Status.
     */
    private boolean isSplit;

    /**
     * Resolved Date.
     */
    private OceanusDate theDate;

    /**
     * AssetPair Id.
     */
    private MoneyWiseAssetDirection theDirection;

    /**
     * Resolved Account.
     */
    private MoneyWiseTransAsset theAccount;

    /**
     * Resolved Partner.
     */
    private MoneyWiseTransAsset thePartner;

    /**
     * Resolved Transaction Category.
     */
    private MoneyWiseTransCategory theCategory;

    /**
     * Resolved Portfolio.
     */
    private MoneyWisePortfolio thePortfolio;

    /**
     * Is the Debit reversed?
     */
    private boolean isDebitReversed;

    /**
     * The last event.
     */
    private OceanusDate theLastEvent;

    /**
     * Have we hit the lastEvent limit.
     */
    private boolean hitEventLimit;

    /**
     * Constructor.
     *
     * @param pData the dataSet
     */
<span class="nc" id="L159">    MoneyWiseArchiveCache(final MoneyWiseDataSet pData) {</span>
        /* Store lists */
<span class="nc" id="L161">        theData = pData;</span>
<span class="nc" id="L162">        theList = theData.getTransactions();</span>

        /* Create the maps */
<span class="nc" id="L165">        theNameMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L166">        theCategoryMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L167">        theYears = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L168">    }</span>

    /**
     * Enable filtering.
     */
    void enableFiltering() {
<span class="nc" id="L174">        enableFiltering = true;</span>
<span class="nc" id="L175">    }</span>

    /**
     * Set lastEvent.
     *
     * @param pLastEvent the last event date
     */
    void setLastEvent(final OceanusDate pLastEvent) {
<span class="nc" id="L183">        theLastEvent = pLastEvent;</span>
<span class="nc" id="L184">    }</span>

    /**
     * Check valid date.
     *
     * @param pDate the date
     * @return true/false
     */
    boolean checkDate(final OceanusDate pDate) {
<span class="nc bnc" id="L193" title="All 4 branches missed.">        return theLastEvent == null || theLastEvent.compareTo(pDate) &gt;= 0;</span>
    }

    /**
     * Did we hit the event limit?
     *
     * @return true/false
     */
    boolean hitEventLimit() {
<span class="nc" id="L202">        return hitEventLimit;</span>
    }

    /**
     * Add a year to the front of the list.
     *
     * @param pName the range name
     */
    void addYear(final String pName) {
<span class="nc" id="L211">        final MoneyWiseArchiveYear myYear = new MoneyWiseArchiveYear(pName);</span>
<span class="nc" id="L212">        theYears.add(myYear);</span>
<span class="nc" id="L213">    }</span>

    /**
     * Get the iterator.
     *
     * @return the iterator
     */
    ListIterator&lt;MoneyWiseArchiveYear&gt; getIterator() {
<span class="nc" id="L221">        return theYears.listIterator();</span>
    }

    /**
     * Obtain the reverse iterator of the years.
     *
     * @return the iterator.
     */
    ListIterator&lt;MoneyWiseArchiveYear&gt; reverseIterator() {
<span class="nc" id="L230">        return theYears.listIterator(getNumYears());</span>
    }

    /**
     * Get the number of years.
     *
     * @return the number of years
     */
    int getNumYears() {
<span class="nc" id="L239">        return theYears.size();</span>
    }

    /**
     * Build transaction.
     *
     * @param pAmount     the amount
     * @param pReconciled is the transaction reconciled?
     * @return the new transaction
     * @throws OceanusException on error
     */
    MoneyWiseTransaction buildTransaction(final String pAmount,
                                          final boolean pReconciled) throws OceanusException {
        /* Build data values */
<span class="nc" id="L253">        final PrometheusDataValues myValues = new PrometheusDataValues(MoneyWiseTransaction.OBJECT_NAME);</span>
<span class="nc" id="L254">        myValues.addValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE, theDate);</span>
<span class="nc" id="L255">        myValues.addValue(MoneyWiseBasicDataType.TRANSCATEGORY, theCategory);</span>
<span class="nc" id="L256">        myValues.addValue(MoneyWiseBasicResource.TRANSACTION_DIRECTION, theDirection);</span>
<span class="nc" id="L257">        myValues.addValue(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, theAccount);</span>
<span class="nc" id="L258">        myValues.addValue(MoneyWiseBasicResource.TRANSACTION_PARTNER, thePartner);</span>
<span class="nc" id="L259">        myValues.addValue(MoneyWiseBasicResource.TRANSACTION_RECONCILED, pReconciled);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (pAmount != null) {</span>
<span class="nc" id="L261">            myValues.addValue(MoneyWiseBasicResource.TRANSACTION_AMOUNT, pAmount);</span>
        }

<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (filterTransaction(myValues)) {</span>
<span class="nc" id="L265">            return null;</span>
        }

        /* Add the value into the list */
<span class="nc" id="L269">        final MoneyWiseTransaction myTrans = theList.addValuesItem(myValues);</span>

        /* If we were not a child */
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!isSplit) {</span>
            /* Note the last parent */
<span class="nc" id="L274">            theLastParent = myTrans;</span>
        }

        /* return the new transaction */
<span class="nc" id="L278">        return myTrans;</span>
    }

    /**
     * Is the debit reversed?
     *
     * @return true/false
     */
    boolean isDebitReversed() {
<span class="nc" id="L287">        return isDebitReversed;</span>
    }

    /**
     * Is the transaction recursive?
     *
     * @return true/false
     */
    boolean isRecursive() {
<span class="nc" id="L296">        return theLastDebit.equals(theLastCredit);</span>
    }

    /**
     * should we filter this transaction?
     *
     * @param pTrans the transaction
     * @return true/false
     */
    boolean filterTransaction(final PrometheusDataValues pTrans) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">        return enableFiltering</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                &amp;&amp; (filterAsset(pTrans, MoneyWiseBasicResource.TRANSACTION_ACCOUNT)</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                || filterAsset(pTrans, MoneyWiseBasicResource.TRANSACTION_PARTNER));</span>
    }

    /**
     * Should we filter this asset?
     *
     * @param pTrans the transaction values
     * @param pAsset the asset
     * @return true/false
     */
    private boolean filterAsset(final PrometheusDataValues pTrans,
                                final MetisDataFieldId pAsset) {
<span class="nc" id="L320">        final MoneyWiseTransAsset myAsset = pTrans.getValue(pAsset, MoneyWiseTransAsset.class);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">        switch (myAsset.getAssetType()) {</span>
            case DEPOSIT:
            case CASH:
            case PAYEE:
            case LOAN:
<span class="nc" id="L326">                return false;</span>
            default:
<span class="nc" id="L328">                return true;</span>
        }
    }

    /**
     * Resolve Values.
     *
     * @param pDate     the date of the transaction
     * @param pDebit    the name of the debit object
     * @param pCredit   the name of the credit object
     * @param pCategory the name of the category object
     * @return continue true/false
     * @throws OceanusException on error
     */
    boolean resolveValues(final OceanusDate pDate,
                          final String pDebit,
                          final String pCredit,
                          final String pCategory) throws OceanusException {
        /* If the Date is null */
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (pDate == null) {</span>
            /* Resolve child values */
<span class="nc" id="L349">            resolveChildValues(pDebit, pCredit, pCategory);</span>
<span class="nc" id="L350">            return true;</span>
        }

        /* If the date is too late */
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (!checkDate(pDate)) {</span>
            /* reject the transaction */
<span class="nc" id="L356">            hitEventLimit = true;</span>
<span class="nc" id="L357">            return false;</span>
        }

        /* Note that there is no split */
<span class="nc" id="L361">        isSplit = Boolean.FALSE;</span>
<span class="nc" id="L362">        theParent = null;</span>

        /* Store the Date */
<span class="nc" id="L365">        theDate = pDate;</span>

        /* Resolve the names */
<span class="nc" id="L368">        theLastDebit = theNameMap.get(pDebit);</span>
<span class="nc" id="L369">        theLastCredit = theNameMap.get(pCredit);</span>
<span class="nc" id="L370">        theCategory = theCategoryMap.get(pCategory);</span>

        /* Check resolution */
<span class="nc" id="L373">        checkResolution(pDebit, pCredit, pCategory);</span>

        /* If the category is portfolio transfer */
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (theCategory.isCategoryClass(MoneyWiseTransCategoryClass.PORTFOLIOXFER)) {</span>
            /* Adjust maps to reflect the transfer */
<span class="nc" id="L378">            resolvePortfolioXfer(theData, theLastDebit, theLastCredit);</span>
        }

        /* Resolve assets */
<span class="nc" id="L382">        resolveAssets();</span>
<span class="nc" id="L383">        return true;</span>
    }

    /**
     * Resolve Child Values.
     *
     * @param pDebit    the name of the debit object
     * @param pCredit   the name of the credit object
     * @param pCategory the name of the category object
     * @throws OceanusException on error
     */
    private void resolveChildValues(final String pDebit,
                                    final String pCredit,
                                    final String pCategory) throws OceanusException {
        /* Handle no LastParent */
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (theLastParent == null) {</span>
<span class="nc" id="L399">            throw new MoneyWiseDataException(theDate, &quot;Missing parent transaction&quot;);</span>
        }

        /* Note that there is a split */
<span class="nc" id="L403">        isSplit = Boolean.TRUE;</span>
<span class="nc" id="L404">        theParent = theLastParent;</span>

        /* Resolve the debit and credit */
<span class="nc bnc" id="L407" title="All 2 branches missed.">        final Object myDebit = pDebit == null</span>
<span class="nc" id="L408">                ? theLastDebit</span>
<span class="nc" id="L409">                : theNameMap.get(pDebit);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">        final Object myCredit = pCredit == null</span>
<span class="nc" id="L411">                ? theLastCredit</span>
<span class="nc" id="L412">                : theNameMap.get(pCredit);</span>

        /* Store last credit and debit */
<span class="nc" id="L415">        theLastDebit = myDebit;</span>
<span class="nc" id="L416">        theLastCredit = myCredit;</span>

        /* Resolve the category */
<span class="nc" id="L419">        theCategory = theCategoryMap.get(pCategory);</span>

        /* Check resolution */
<span class="nc" id="L422">        checkResolution(pDebit, pCredit, pCategory);</span>

        /* Resolve assets */
<span class="nc" id="L425">        resolveAssets();</span>
<span class="nc" id="L426">    }</span>

    /**
     * Resolve assets.
     *
     * @throws OceanusException on error
     */
    private void resolveAssets() throws OceanusException {
<span class="nc" id="L434">        final boolean isDebitHolding = theLastDebit instanceof MoneyWiseSecurityHolding;</span>
<span class="nc" id="L435">        final boolean isCreditHolding = theLastCredit instanceof MoneyWiseSecurityHolding;</span>

        /* Resolve debit and credit */
<span class="nc" id="L438">        final MoneyWiseTransAsset myDebit = (MoneyWiseTransAsset) theLastDebit;</span>
<span class="nc" id="L439">        final MoneyWiseTransAsset myCredit = (MoneyWiseTransAsset) theLastCredit;</span>

        /* Access asset types */
<span class="nc" id="L442">        final MoneyWiseAssetType myDebitType = myDebit.getAssetType();</span>
<span class="nc" id="L443">        final MoneyWiseAssetType myCreditType = myCredit.getAssetType();</span>

        /* Handle non-Asset debit */
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (!myDebitType.isBaseAccount()) {</span>
            /* Use credit as account */
<span class="nc" id="L448">            isDebitReversed = true;</span>

            /* Handle non-Asset credit */
<span class="nc bnc" id="L451" title="All 2 branches missed.">        } else if (!myCreditType.isBaseAccount()) {</span>
            /* Use debit as account */
<span class="nc" id="L453">            isDebitReversed = false;</span>

            /* Handle non-child transfer */
<span class="nc bnc" id="L456" title="All 2 branches missed.">        } else if (!isSplit) {</span>
            /* Flip values for StockRightsTaken and LoanInterest */
<span class="nc bnc" id="L458" title="All 4 branches missed.">            switch (Objects.requireNonNull(theCategory.getCategoryTypeClass())) {</span>
                case STOCKRIGHTSISSUE:
                    /* Use securityHolding as account */
<span class="nc bnc" id="L461" title="All 2 branches missed.">                    isDebitReversed = !myDebitType.isSecurityHolding();</span>
<span class="nc" id="L462">                    break;</span>
                case LOANINTERESTEARNED:
                    /* Use credit as account */
<span class="nc bnc" id="L465" title="All 2 branches missed.">                    isDebitReversed = !theData.newValidityChecks();</span>
<span class="nc" id="L466">                    break;</span>
                case LOANINTERESTCHARGED:
                case WRITEOFF:
                    /* Use credit as account */
<span class="nc" id="L470">                    isDebitReversed = theData.newValidityChecks();</span>
<span class="nc" id="L471">                    break;</span>
                default:
                    /* Use debit as account */
<span class="nc" id="L474">                    isDebitReversed = false;</span>
<span class="nc" id="L475">                    break;</span>
            }
        } else {
            /* Access parent assets */
<span class="nc" id="L479">            final MoneyWiseTransAsset myParAccount = theParent.getAccount();</span>
<span class="nc" id="L480">            final MoneyWiseTransAsset myParPartner = theParent.getPartner();</span>

            /* If we match the parent on debit */
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (myDebit.equals(myParAccount)) {</span>
                /* Use debit as account */
<span class="nc" id="L485">                isDebitReversed = false;</span>

                /* else if we match credit account */
<span class="nc bnc" id="L488" title="All 2 branches missed.">            } else if (myCredit.equals(myParAccount)) {</span>
                /* Use credit as account */
<span class="nc" id="L490">                isDebitReversed = true;</span>

                /* else don't match the parent account, so parent must be wrong */
            } else {
                /* Flip parent assets */
<span class="nc" id="L495">                theParent.flipAssets();</span>

                /* Determine if debit is reversed */
<span class="nc bnc" id="L498" title="All 2 branches missed.">                isDebitReversed = !myDebit.equals(myParPartner);</span>
            }
        }

        /* Set up values */
<span class="nc bnc" id="L503" title="All 2 branches missed.">        if (!isDebitReversed) {</span>
            /* Use debit as account */
<span class="nc" id="L505">            theAccount = myDebit;</span>
<span class="nc" id="L506">            thePartner = myCredit;</span>
<span class="nc" id="L507">            theDirection = MoneyWiseAssetDirection.TO;</span>
        } else {
            /* Use credit as account */
<span class="nc" id="L510">            theAccount = myCredit;</span>
<span class="nc" id="L511">            thePartner = myDebit;</span>
<span class="nc" id="L512">            theDirection = MoneyWiseAssetDirection.FROM;</span>
        }

        /* Resolve portfolio */
<span class="nc" id="L516">        thePortfolio = null;</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">        if (isDebitHolding) {</span>
<span class="nc" id="L518">            thePortfolio = ((MoneyWiseSecurityHolding) theLastDebit).getPortfolio();</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">            if (isCreditHolding) {</span>
<span class="nc" id="L520">                final MoneyWisePortfolio myPortfolio = ((MoneyWiseSecurityHolding) theLastCredit).getPortfolio();</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">                if (!thePortfolio.equals(myPortfolio)) {</span>
<span class="nc" id="L522">                    throw new MoneyWiseDataException(theDate, &quot;Inconsistent portfolios&quot;);</span>
                }
<span class="nc" id="L524">            }</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">        } else if (isCreditHolding) {</span>
<span class="nc" id="L526">            thePortfolio = ((MoneyWiseSecurityHolding) theLastCredit).getPortfolio();</span>
        }
<span class="nc" id="L528">    }</span>

    /**
     * Check resolution.
     *
     * @param pDebit    the name of the debit object
     * @param pCredit   the name of the credit object
     * @param pCategory the name of the category object
     * @throws OceanusException on error
     */
    private void checkResolution(final String pDebit,
                                 final String pCredit,
                                 final String pCategory) throws OceanusException {
        /* Check debit resolution */
<span class="nc bnc" id="L542" title="All 2 branches missed.">        if (theLastDebit == null) {</span>
<span class="nc" id="L543">            throw new MoneyWiseDataException(pDebit, &quot;Failed to resolve debit account on &quot; + theDate);</span>
        }

        /* Check credit resolution */
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (theLastCredit == null) {</span>
<span class="nc" id="L548">            throw new MoneyWiseDataException(pCredit, &quot;Failed to resolve credit account on &quot; + theDate);</span>
        }

        /* Check category resolution */
<span class="nc bnc" id="L552" title="All 2 branches missed.">        if (theCategory == null) {</span>
<span class="nc" id="L553">            throw new MoneyWiseDataException(pCategory, &quot;Failed to resolve category on &quot; + theDate);</span>
        }
<span class="nc" id="L555">    }</span>

    /**
     * Declare asset.
     *
     * @param pAsset the asset to declare.
     * @throws OceanusException on error
     */
    void declareAsset(final MoneyWiseAssetBase pAsset) throws OceanusException {
        /* Access the asset name */
<span class="nc" id="L565">        final String myName = pAsset.getName();</span>

        /* Check for name already exists */
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (theNameMap.get(myName) != null) {</span>
<span class="nc" id="L569">            throw new MoneyWiseDataException(pAsset, PrometheusDataItem.ERROR_DUPLICATE);</span>
        }

        /* Store the asset */
<span class="nc" id="L573">        theNameMap.put(myName, pAsset);</span>
<span class="nc" id="L574">    }</span>

    /**
     * Declare category.
     *
     * @param pCategory the category to declare.
     * @throws OceanusException on error
     */
    void declareCategory(final MoneyWiseTransCategory pCategory) throws OceanusException {
        /* Access the asset name */
<span class="nc" id="L584">        final String myName = pCategory.getName();</span>

        /* Check for name already exists */
<span class="nc bnc" id="L587" title="All 2 branches missed.">        if (theCategoryMap.get(myName) != null) {</span>
<span class="nc" id="L588">            throw new MoneyWiseDataException(pCategory, PrometheusDataItem.ERROR_DUPLICATE);</span>
        }

        /* Store the category */
<span class="nc" id="L592">        theCategoryMap.put(myName, pCategory);</span>
<span class="nc" id="L593">    }</span>

    /**
     * Declare security holding.
     *
     * @param pSecurity  the security.
     * @param pPortfolio the portfolio
     * @throws OceanusException on error
     */
    void declareSecurityHolding(final MoneyWiseSecurity pSecurity,
                                final String pPortfolio) throws OceanusException {
        /* Access the name */
<span class="nc" id="L605">        final String myName = pSecurity.getName();</span>

        /* Check for name already exists */
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (theNameMap.get(myName) != null) {</span>
<span class="nc" id="L609">            throw new MoneyWiseDataException(pSecurity, PrometheusDataItem.ERROR_DUPLICATE);</span>
        }

        /* Store the asset */
<span class="nc" id="L613">        theNameMap.put(myName, new MoneyWiseSecurityHoldingDef(pSecurity, pPortfolio));</span>
<span class="nc" id="L614">    }</span>

    /**
     * Declare alias holding.
     *
     * @param pName      the security holding name
     * @param pAlias     the alias name.
     * @param pPortfolio the portfolio
     * @throws OceanusException on error
     */
    void declareAliasHolding(final String pName,
                             final String pAlias,
                             final String pPortfolio) throws OceanusException {
        /* Check for name already exists */
<span class="nc" id="L628">        final Object myHolding = theNameMap.get(pAlias);</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">        if (!(myHolding instanceof MoneyWiseSecurityHoldingDef myAliased)) {</span>
<span class="nc" id="L630">            throw new MoneyWiseDataException(pAlias, &quot;Aliased security not found&quot;);</span>
        }

        /* Store the asset */
<span class="nc" id="L634">        theNameMap.put(pName, new MoneyWiseSecurityHoldingDef(myAliased.getSecurity(), pPortfolio));</span>
<span class="nc" id="L635">    }</span>

    /**
     * Resolve security holdings.
     *
     * @param pData the dataSet
     */
    void resolveSecurityHoldings(final MoneyWiseDataSet pData) {
        /* Access securityHoldingsMap and Portfolio list */
<span class="nc" id="L644">        final MoneyWiseSecurityHoldingMap myMap = pData.getPortfolios().getSecurityHoldingsMap();</span>
<span class="nc" id="L645">        final MoneyWisePortfolioList myPortfolios = pData.getPortfolios();</span>

        /* Loop through the name map */
<span class="nc bnc" id="L648" title="All 2 branches missed.">        for (Entry&lt;String, Object&gt; myEntry : theNameMap.entrySet()) {</span>
            /* If this is a security holding definition */
<span class="nc" id="L650">            final Object myValue = myEntry.getValue();</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            if (myValue instanceof MoneyWiseSecurityHoldingDef myDef) {</span>
                /* Access security holding */
<span class="nc" id="L653">                final MoneyWisePortfolio myPortfolio = myPortfolios.findItemByName(myDef.getPortfolio());</span>
<span class="nc" id="L654">                final MoneyWiseSecurityHolding myHolding = myMap.declareHolding(myPortfolio, myDef.getSecurity());</span>

                /* Replace definition in map */
<span class="nc" id="L657">                myEntry.setValue(myHolding);</span>
            }
<span class="nc" id="L659">        }</span>
<span class="nc" id="L660">    }</span>


    /**
     * Process portfolio transfer.
     *
     * @param pData   the dataSet
     * @param pSource the source asset
     * @param pTarget the target asset
     * @throws OceanusException on error
     */
    private void resolvePortfolioXfer(final MoneyWiseDataSet pData,
                                      final Object pSource,
                                      final Object pTarget) throws OceanusException {
        /* Target must be portfolio */
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (!(pTarget instanceof MoneyWisePortfolio myPortfolio)) {</span>
<span class="nc" id="L676">            throw new MoneyWiseDataException(pTarget, &quot;Inconsistent portfolios&quot;);</span>
        }

<span class="nc" id="L679">        final MoneyWiseSecurityHoldingMap myMap = pData.getPortfolios().getSecurityHoldingsMap();</span>

        /* Loop through the name map */
<span class="nc bnc" id="L682" title="All 2 branches missed.">        for (Entry&lt;String, Object&gt; myEntry : theNameMap.entrySet()) {</span>
            /* If this is a security holding definition */
<span class="nc" id="L684">            final Object myValue = myEntry.getValue();</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">            if (myValue instanceof MoneyWiseSecurityHolding myHolding) {</span>
                /* If this holding needs updating */
<span class="nc bnc" id="L687" title="All 4 branches missed.">                if (pSource.equals(myHolding) || pSource.equals(myHolding.getPortfolio())) {</span>
                    /* Change the holding */
<span class="nc" id="L689">                    myHolding = myMap.declareHolding(myPortfolio, myHolding.getSecurity());</span>

                    /* Replace definition in map */
<span class="nc" id="L692">                    myEntry.setValue(myHolding);</span>
                }
            }
<span class="nc" id="L695">        }</span>
<span class="nc" id="L696">    }</span>

    /**
     * Security Holding Definition.
     */
    private static final class MoneyWiseSecurityHoldingDef {
        /**
         * Security.
         */
        private final MoneyWiseSecurity theSecurity;

        /**
         * Portfolio.
         */
        private final String thePortfolio;

        /**
         * Constructor.
         *
         * @param pSecurity  the security
         * @param pPortfolio the portfolio
         */
        private MoneyWiseSecurityHoldingDef(final MoneyWiseSecurity pSecurity,
<span class="nc" id="L719">                                            final String pPortfolio) {</span>
            /* Store parameters */
<span class="nc" id="L721">            theSecurity = pSecurity;</span>
<span class="nc" id="L722">            thePortfolio = pPortfolio;</span>
<span class="nc" id="L723">        }</span>

        /**
         * Obtain security.
         *
         * @return the security
         */
        public MoneyWiseSecurity getSecurity() {
<span class="nc" id="L731">            return theSecurity;</span>
        }

        /**
         * Obtain portfolio.
         *
         * @return the portfolio
         */
        public String getPortfolio() {
<span class="nc" id="L740">            return thePortfolio;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>