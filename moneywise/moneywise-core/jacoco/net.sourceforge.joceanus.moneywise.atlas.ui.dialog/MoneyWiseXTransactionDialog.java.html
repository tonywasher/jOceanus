<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseXTransactionDialog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.atlas.ui.dialog</a> &gt; <span class="el_source">MoneyWiseXTransactionDialog.java</span></div><h1>MoneyWiseXTransactionDialog.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.atlas.ui.dialog;

import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.metis.field.MetisFieldRequired;
import net.sourceforge.joceanus.moneywise.atlas.data.analysis.base.MoneyWiseXAnalysisEvent;
import net.sourceforge.joceanus.moneywise.atlas.data.analysis.buckets.MoneyWiseXAnalysis;
import net.sourceforge.joceanus.moneywise.atlas.ui.controls.MoneyWiseXAnalysisSelect;
import net.sourceforge.joceanus.moneywise.atlas.views.MoneyWiseXAnalysisFilter;
import net.sourceforge.joceanus.moneywise.atlas.views.MoneyWiseXTransactionFilters;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetBase;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetBase.MoneyWiseAssetBaseList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetDirection;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetType;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseBasicDataType;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseBasicResource;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseCash.MoneyWiseCashList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataValidator.MoneyWiseDataValidatorTrans;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDeposit.MoneyWiseDepositList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseLoan.MoneyWiseLoanList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePayee.MoneyWisePayeeList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePortfolio;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePortfolio.MoneyWisePortfolioList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurity;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding.MoneyWiseSecurityHoldingMap;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransCategory.MoneyWiseTransCategoryList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransInfoSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransTag;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransTag.MoneyWiseTransTagList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransInfoClass;
import net.sourceforge.joceanus.moneywise.data.validate.MoneyWiseValidateTransaction;
import net.sourceforge.joceanus.moneywise.ui.MoneyWiseIcon;
import net.sourceforge.joceanus.moneywise.ui.MoneyWiseUIResource;
import net.sourceforge.joceanus.moneywise.ui.base.MoneyWiseBaseTable;
import net.sourceforge.joceanus.moneywise.ui.base.MoneyWiseItemPanel;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.date.OceanusDateConfig;
import net.sourceforge.joceanus.oceanus.date.OceanusDateRange;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.decimal.OceanusPrice;
import net.sourceforge.joceanus.oceanus.decimal.OceanusRatio;
import net.sourceforge.joceanus.oceanus.decimal.OceanusUnits;
import net.sourceforge.joceanus.prometheus.ui.fieldset.PrometheusFieldSet;
import net.sourceforge.joceanus.prometheus.ui.fieldset.PrometheusFieldSetEvent;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditSet;
import net.sourceforge.joceanus.tethys.api.control.TethysUIControl.TethysUIIconMapSet;
import net.sourceforge.joceanus.tethys.api.factory.TethysUIFactory;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIDateButtonField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIIconButtonField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIIntegerEditField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIListButtonField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIMoneyEditField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIRatioEditField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIScrollButtonField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIStringEditField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIUnitsEditField;
import net.sourceforge.joceanus.tethys.api.field.TethysUIFieldFactory;
import net.sourceforge.joceanus.tethys.api.menu.TethysUIScrollItem;
import net.sourceforge.joceanus.tethys.api.menu.TethysUIScrollMenu;
import net.sourceforge.joceanus.tethys.api.menu.TethysUIScrollSubMenu;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * Panel to display/edit/create a Transaction.
 */
public class MoneyWiseXTransactionDialog
        extends MoneyWiseItemPanel&lt;MoneyWiseXAnalysisEvent&gt; {
    /**
     * Info Tab Title.
     */
<span class="nc" id="L98">    private static final String TAB_INFO = MoneyWiseUIResource.TRANSPANEL_TAB_INFO.getValue();</span>

    /**
     * Tax Tab Title.
     */
<span class="nc" id="L103">    private static final String TAB_TAXES = MoneyWiseUIResource.TRANSPANEL_TAB_TAXES.getValue();</span>

    /**
     * Securities Tab Title.
     */
<span class="nc" id="L108">    private static final String TAB_SECURITIES = MoneyWiseUIResource.TRANSPANEL_TAB_SECURITIES.getValue();</span>

    /**
     * Returned Tab Title.
     */
<span class="nc" id="L113">    private static final String TAB_RETURNED = MoneyWiseUIResource.TRANSPANEL_TAB_RETURNED.getValue();</span>

    /**
     * The fieldSet.
     */
    private final PrometheusFieldSet&lt;MoneyWiseXAnalysisEvent&gt; theFieldSet;

    /**
     * Analysis selection panel.
     */
    private final MoneyWiseXAnalysisSelect theAnalysisSelect;

    /**
     * dateRange.
     */
    private OceanusDateRange theRange;

    /**
     * transaction.
     */
    private MoneyWiseTransaction theTransaction;

    /**
     * reconciledState.
     */
<span class="nc" id="L138">    private Boolean theReconciledState = Boolean.FALSE;</span>

    /**
     * directionState.
     */
<span class="nc" id="L143">    private Boolean theDirectionState = Boolean.FALSE;</span>

    /**
     * Constructor.
     * @param pFactory the GUI factory
     * @param pEditSet the edit set
     * @param pAnalysisSelect the analysis selection panel
     * @param pOwner the owning table
     */
    public MoneyWiseXTransactionDialog(final TethysUIFactory&lt;?&gt; pFactory,
                                       final PrometheusEditSet pEditSet,
                                       final MoneyWiseXAnalysisSelect pAnalysisSelect,
                                       final MoneyWiseBaseTable&lt;MoneyWiseXAnalysisEvent&gt; pOwner) {
        /* Initialise the panel */
<span class="nc" id="L157">        super(pFactory, pEditSet, pOwner);</span>
<span class="nc" id="L158">        theAnalysisSelect = pAnalysisSelect;</span>

        /* Access the fieldSet */
<span class="nc" id="L161">        theFieldSet = getFieldSet();</span>

        /* Build the main panel */
<span class="nc" id="L164">        buildMainPanel(pFactory);</span>

        /* Build the info panel */
<span class="nc" id="L167">        buildInfoPanel(pFactory);</span>

        /* Build the tax panel */
<span class="nc" id="L170">        buildTaxPanel(pFactory);</span>

        /* Build the securities panel */
<span class="nc" id="L173">        buildSecuritiesPanel(pFactory);</span>

        /* Build the returned panel */
<span class="nc" id="L176">        buildReturnedPanel(pFactory);</span>
<span class="nc" id="L177">    }</span>

    /**
     * Build Main subPanel.
     * @param pFactory the GUI factory
     */
    private void buildMainPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Allocate fields */
<span class="nc" id="L185">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L186">        final TethysUIMoneyEditField myAmount = myFields.newMoneyField();</span>

        /* Create the buttons */
<span class="nc" id="L189">        final TethysUIDateButtonField myDateButton = myFields.newDateField();</span>
<span class="nc" id="L190">        final TethysUIScrollButtonField&lt;MoneyWiseTransAsset&gt; myAccountButton = myFields.newScrollField(MoneyWiseTransAsset.class);</span>
<span class="nc" id="L191">        final TethysUIScrollButtonField&lt;MoneyWiseTransAsset&gt; myPartnerButton = myFields.newScrollField(MoneyWiseTransAsset.class);</span>
<span class="nc" id="L192">        final TethysUIScrollButtonField&lt;MoneyWiseTransCategory&gt; myCategoryButton = myFields.newScrollField(MoneyWiseTransCategory.class);</span>
<span class="nc" id="L193">        final TethysUIIconButtonField&lt;Boolean&gt; myReconciledButton = myFields.newIconField(Boolean.class);</span>
<span class="nc" id="L194">        final TethysUIIconButtonField&lt;MoneyWiseAssetDirection&gt; myDirectionButton = myFields.newIconField(MoneyWiseAssetDirection.class);</span>

        /* Assign the fields to the panel */
<span class="nc" id="L197">        theFieldSet.addField(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE, myDateButton, MoneyWiseXAnalysisEvent::getDate);</span>
<span class="nc" id="L198">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, myAccountButton, MoneyWiseXAnalysisEvent::getAccount);</span>
<span class="nc" id="L199">        theFieldSet.addField(MoneyWiseBasicDataType.TRANSCATEGORY, myCategoryButton, MoneyWiseXAnalysisEvent::getCategory);</span>
<span class="nc" id="L200">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_DIRECTION, myDirectionButton, MoneyWiseXAnalysisEvent::getDirection);</span>
<span class="nc" id="L201">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_PARTNER, myPartnerButton, MoneyWiseXAnalysisEvent::getPartner);</span>
<span class="nc" id="L202">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_AMOUNT, myAmount, MoneyWiseXAnalysisEvent::getAmount);</span>
<span class="nc" id="L203">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_RECONCILED, myReconciledButton, MoneyWiseXAnalysisEvent::isReconciled);</span>

        /* Configure the menuBuilders */
<span class="nc" id="L206">        myDateButton.setDateConfigurator(this::handleDateConfig);</span>
<span class="nc" id="L207">        myAccountButton.setMenuConfigurator(c -&gt; buildAccountMenu(c, getItem()));</span>
<span class="nc" id="L208">        myCategoryButton.setMenuConfigurator(c -&gt; buildCategoryMenu(c, getItem()));</span>
<span class="nc" id="L209">        myPartnerButton.setMenuConfigurator(c -&gt; buildPartnerMenu(c, getItem()));</span>
<span class="nc" id="L210">        final Map&lt;Boolean, TethysUIIconMapSet&lt;Boolean&gt;&gt; myRecMapSets = MoneyWiseIcon.configureReconciledIconButton(pFactory);</span>
<span class="nc" id="L211">        myReconciledButton.setIconMapSet(() -&gt; myRecMapSets.get(theReconciledState));</span>
<span class="nc" id="L212">        final Map&lt;Boolean, TethysUIIconMapSet&lt;MoneyWiseAssetDirection&gt;&gt; myDirMapSets = MoneyWiseIcon.configureDirectionIconButton(pFactory);</span>
<span class="nc" id="L213">        myDirectionButton.setIconMapSet(() -&gt; myDirMapSets.get(theDirectionState));</span>
<span class="nc" id="L214">        myAmount.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L215">    }</span>

    /**
     * Build info subPanel.
     * @param pFactory the GUI factory
     */
    private void buildInfoPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create a new panel */
<span class="nc" id="L223">        theFieldSet.newPanel(TAB_INFO);</span>

        /* Allocate fields */
<span class="nc" id="L226">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L227">        final TethysUIMoneyEditField myAmount = myFields.newMoneyField();</span>
<span class="nc" id="L228">        final TethysUIStringEditField myComments = myFields.newStringField();</span>
<span class="nc" id="L229">        final TethysUIStringEditField myReference = myFields.newStringField();</span>

        /* Create the buttons */
<span class="nc" id="L232">        final TethysUIListButtonField&lt;MoneyWiseTransTag&gt; myTagButton = myFields.newListField();</span>

        /* Assign the fields to the panel */
<span class="nc" id="L235">        theFieldSet.addField(MoneyWiseTransInfoClass.PARTNERAMOUNT, myAmount, MoneyWiseXAnalysisEvent::getPartnerAmount);</span>
<span class="nc" id="L236">        theFieldSet.addField(MoneyWiseTransInfoClass.COMMENTS, myComments, MoneyWiseXAnalysisEvent::getComments);</span>
<span class="nc" id="L237">        theFieldSet.addField(MoneyWiseTransInfoClass.REFERENCE, myReference, MoneyWiseXAnalysisEvent::getReference);</span>
<span class="nc" id="L238">        theFieldSet.addField(MoneyWiseTransInfoClass.TRANSTAG, myTagButton, MoneyWiseXAnalysisEvent::getTransactionTags);</span>

        /* Configure the tag button */
<span class="nc" id="L241">        myTagButton.setSelectables(this::buildTransactionTags);</span>

        /* Set currency */
<span class="nc" id="L244">        myAmount.setDeemedCurrency(() -&gt; getItem().getPartner().getCurrency());</span>
<span class="nc" id="L245">    }</span>

    /**
     * Build tax subPanel.
     * @param pFactory the GUI factory
     */
    private void buildTaxPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create a new panel */
<span class="nc" id="L253">        theFieldSet.newPanel(TAB_TAXES);</span>

        /* Allocate fields */
<span class="nc" id="L256">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L257">        final TethysUIMoneyEditField myTaxCredit = myFields.newMoneyField();</span>
<span class="nc" id="L258">        final TethysUIMoneyEditField myEeNatIns = myFields.newMoneyField();</span>
<span class="nc" id="L259">        final TethysUIMoneyEditField myErNatIns = myFields.newMoneyField();</span>
<span class="nc" id="L260">        final TethysUIMoneyEditField myBenefit = myFields.newMoneyField();</span>
<span class="nc" id="L261">        final TethysUIMoneyEditField myWithheld = myFields.newMoneyField();</span>
<span class="nc" id="L262">        final TethysUIIntegerEditField myYears = myFields.newIntegerField();</span>

        /* Assign the fields to the panel */
<span class="nc" id="L265">        theFieldSet.addField(MoneyWiseTransInfoClass.TAXCREDIT, myTaxCredit, MoneyWiseXAnalysisEvent::getTaxCredit);</span>
<span class="nc" id="L266">        theFieldSet.addField(MoneyWiseTransInfoClass.EMPLOYEENATINS, myEeNatIns, MoneyWiseXAnalysisEvent::getEmployeeNatIns);</span>
<span class="nc" id="L267">        theFieldSet.addField(MoneyWiseTransInfoClass.EMPLOYERNATINS, myErNatIns, MoneyWiseXAnalysisEvent::getEmployerNatIns);</span>
<span class="nc" id="L268">        theFieldSet.addField(MoneyWiseTransInfoClass.DEEMEDBENEFIT, myBenefit, MoneyWiseXAnalysisEvent::getDeemedBenefit);</span>
<span class="nc" id="L269">        theFieldSet.addField(MoneyWiseTransInfoClass.WITHHELD, myWithheld, MoneyWiseXAnalysisEvent::getWithheld);</span>

        /* Set currency */
<span class="nc" id="L272">        myTaxCredit.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L273">        myEeNatIns.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L274">        myErNatIns.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L275">        myBenefit.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L276">        myWithheld.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L277">    }</span>

    /**
     * Build securities subPanel.
     * @param pFactory the GUI factory
     */
    private void buildSecuritiesPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create a new panel */
<span class="nc" id="L285">        theFieldSet.newPanel(TAB_SECURITIES);</span>

        /* Allocate fields */
<span class="nc" id="L288">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L289">        final TethysUIUnitsEditField myAccountUnits = myFields.newUnitsField();</span>
<span class="nc" id="L290">        final TethysUIUnitsEditField myPartnerUnits = myFields.newUnitsField();</span>
<span class="nc" id="L291">        final TethysUIRatioEditField myDilution = myFields.newRatioField();</span>

        /* Assign the fields to the panel */
<span class="nc" id="L294">        theFieldSet.addField(MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS, myAccountUnits, MoneyWiseXAnalysisEvent::getAccountDeltaUnits);</span>
<span class="nc" id="L295">        theFieldSet.addField(MoneyWiseTransInfoClass.PARTNERDELTAUNITS, myPartnerUnits, MoneyWiseXAnalysisEvent::getPartnerDeltaUnits);</span>
<span class="nc" id="L296">        theFieldSet.addField(MoneyWiseTransInfoClass.DILUTION, myDilution, MoneyWiseXAnalysisEvent::getDilution);</span>
<span class="nc" id="L297">    }</span>

    /**
     * Build returned subPanel.
     * @param pFactory the GUI factory
     */
    private void buildReturnedPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create a new panel */
<span class="nc" id="L305">        theFieldSet.newPanel(TAB_RETURNED);</span>

        /* Allocate fields */
<span class="nc" id="L308">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L309">        final TethysUIMoneyEditField myReturnedCash = myFields.newMoneyField();</span>

        /* Create the buttons */
<span class="nc" id="L312">        final TethysUIScrollButtonField&lt;MoneyWiseTransAsset&gt; myReturnedAccountButton = myFields.newScrollField(MoneyWiseTransAsset.class);</span>

        /* Assign the fields to the panel */
<span class="nc" id="L315">        theFieldSet.addField(MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT, myReturnedAccountButton, MoneyWiseXAnalysisEvent::getReturnedCashAccount);</span>
<span class="nc" id="L316">        theFieldSet.addField(MoneyWiseTransInfoClass.RETURNEDCASH, myReturnedCash, MoneyWiseXAnalysisEvent::getReturnedCash);</span>

        /* Configure the menuBuilders */
<span class="nc" id="L319">        myReturnedAccountButton.setMenuConfigurator(c -&gt; buildReturnedAccountMenu(c, getItem()));</span>

        /* Set currency */
<span class="nc" id="L322">        myReturnedCash.setDeemedCurrency(() -&gt; getItem().getReturnedCashAccount().getCurrency());</span>
<span class="nc" id="L323">    }</span>

    @Override
    public void refreshData() {
        /* If we have an item */
<span class="nc" id="L328">        final MoneyWiseXAnalysisEvent myItem = getItem();</span>
        //if (myItem != null) {
            /* TODO Reselect from list of Events - Where is this list? */
            //setItem(myTrans.findItemById(myItem.getIndexedId()));
        //}

        /* Make sure that the item is not editable */
<span class="nc" id="L335">        setEditable(false);</span>
<span class="nc" id="L336">    }</span>

    /**
     * Update editors.
     * @param pRange the date range.
     */
    public void updateEditors(final OceanusDateRange pRange) {
        /* Update the range */
<span class="nc" id="L344">        theRange = pRange;</span>
<span class="nc" id="L345">    }</span>

    /**
     * Handle dateConfig.
     * @param pConfig the dateConfig
     */
    private void handleDateConfig(final OceanusDateConfig pConfig) {
        /* Update Date button */
<span class="nc bnc" id="L353" title="All 2 branches missed.">        pConfig.setEarliestDate(theRange != null</span>
<span class="nc" id="L354">                ? theRange.getStart()</span>
<span class="nc" id="L355">                : null);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">        pConfig.setLatestDate(theRange != null</span>
<span class="nc" id="L357">                ? theRange.getEnd()</span>
<span class="nc" id="L358">                : null);</span>
<span class="nc" id="L359">    }</span>

    @Override
    public boolean isDeletable() {
<span class="nc bnc" id="L363" title="All 4 branches missed.">        return getItem() != null &amp;&amp; !getItem().isReconciled();</span>
    }

    @Override
    protected void adjustFields(final boolean isEditable) {
        /* Access the item */
<span class="nc" id="L369">        final MoneyWiseTransaction myTrans = getItem().getTransaction();</span>
<span class="nc" id="L370">        final boolean bIsReconciled = myTrans.isReconciled();</span>
<span class="nc" id="L371">        final boolean bIsLocked = myTrans.isLocked();</span>

        /* Determine whether the comments field should be visible */
<span class="nc bnc" id="L374" title="All 4 branches missed.">        boolean bShowField = isEditable || myTrans.getComments() != null;</span>
<span class="nc" id="L375">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.COMMENTS, bShowField);</span>

        /* Determine whether the reference field should be visible */
<span class="nc bnc" id="L378" title="All 4 branches missed.">        bShowField = isEditable || myTrans.getReference() != null;</span>
<span class="nc" id="L379">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.REFERENCE, bShowField);</span>

        /* Determine whether the tags field should be visible */
<span class="nc bnc" id="L382" title="All 4 branches missed.">        bShowField = isEditable || myTrans.getTransactionTags() != null;</span>
<span class="nc" id="L383">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.TRANSTAG, bShowField);</span>

        /* Determine whether the partnerAmount field should be visible */
<span class="nc bnc" id="L386" title="All 4 branches missed.">        boolean bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.PARTNERAMOUNT);</span>
<span class="nc bnc" id="L387" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getPartnerAmount() != null;</span>
<span class="nc" id="L388">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.PARTNERAMOUNT, bShowField);</span>
<span class="nc" id="L389">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.PARTNERAMOUNT, bEditField);</span>

        /* Determine whether the taxCredit field should be visible */
<span class="nc bnc" id="L392" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.TAXCREDIT);</span>
<span class="nc bnc" id="L393" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getTaxCredit() != null;</span>
<span class="nc" id="L394">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.TAXCREDIT, bShowField);</span>
<span class="nc" id="L395">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.TAXCREDIT, bEditField);</span>

        /* Determine whether the EeNatIns field should be visible */
<span class="nc bnc" id="L398" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.EMPLOYEENATINS);</span>
<span class="nc bnc" id="L399" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getEmployeeNatIns() != null;</span>
<span class="nc" id="L400">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.EMPLOYEENATINS, bShowField);</span>
<span class="nc" id="L401">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.EMPLOYEENATINS, bEditField);</span>

        /* Determine whether the ErnatIns field should be visible */
<span class="nc bnc" id="L404" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.EMPLOYERNATINS);</span>
<span class="nc bnc" id="L405" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getEmployerNatIns() != null;</span>
<span class="nc" id="L406">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.EMPLOYERNATINS, bShowField);</span>
<span class="nc" id="L407">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.EMPLOYERNATINS, bEditField);</span>

        /* Determine whether the benefit field should be visible */
<span class="nc bnc" id="L410" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.DEEMEDBENEFIT);</span>
<span class="nc bnc" id="L411" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getDeemedBenefit() != null;</span>
<span class="nc" id="L412">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.DEEMEDBENEFIT, bShowField);</span>
<span class="nc" id="L413">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.DEEMEDBENEFIT, bEditField);</span>

        /* Determine whether the donation field should be visible */
<span class="nc bnc" id="L416" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.WITHHELD);</span>
<span class="nc bnc" id="L417" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getWithheld() != null;</span>
<span class="nc" id="L418">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.WITHHELD, bShowField);</span>
<span class="nc" id="L419">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.WITHHELD, bEditField);</span>

        /* Determine whether the account units field should be visible */
<span class="nc bnc" id="L422" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS);</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getAccountDeltaUnits() != null;</span>
<span class="nc" id="L424">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS, bShowField);</span>
<span class="nc" id="L425">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS, bEditField);</span>

        /* Determine whether the partnerDeltaUnits field should be visible */
<span class="nc bnc" id="L428" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.PARTNERDELTAUNITS);</span>
<span class="nc bnc" id="L429" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getPartnerDeltaUnits() != null;</span>
<span class="nc" id="L430">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.PARTNERDELTAUNITS, bShowField);</span>
<span class="nc" id="L431">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.PARTNERDELTAUNITS, bEditField);</span>

        /* Determine whether the dilution field should be visible */
<span class="nc bnc" id="L434" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.DILUTION);</span>
<span class="nc bnc" id="L435" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getDilution() != null;</span>
<span class="nc" id="L436">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.DILUTION, bShowField);</span>
<span class="nc" id="L437">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.DILUTION, bEditField);</span>

        /* Determine whether the returnedAccount field should be visible */
<span class="nc bnc" id="L440" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT);</span>
<span class="nc bnc" id="L441" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getReturnedCashAccount() != null;</span>
<span class="nc" id="L442">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT, bShowField);</span>
<span class="nc" id="L443">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT, bEditField);</span>

        /* Determine whether the returnedCash field should be visible */
<span class="nc bnc" id="L446" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.RETURNEDCASH);</span>
<span class="nc bnc" id="L447" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getReturnedCash() != null;</span>
<span class="nc" id="L448">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.RETURNEDCASH, bShowField);</span>
<span class="nc" id="L449">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.RETURNEDCASH, bEditField);</span>

        /* Determine whether the reconciled field should be visible */
<span class="nc bnc" id="L452" title="All 4 branches missed.">        final boolean bShowReconciled = isEditable || bIsReconciled;</span>
<span class="nc" id="L453">        theReconciledState = bIsLocked;</span>
<span class="nc" id="L454">        theDirectionState = bIsReconciled;</span>
<span class="nc" id="L455">        theFieldSet.setFieldVisible(MoneyWiseBasicResource.TRANSACTION_RECONCILED, bShowReconciled);</span>
<span class="nc bnc" id="L456" title="All 4 branches missed.">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_RECONCILED, isEditable &amp;&amp; !bIsLocked);</span>

        /* Determine basic editing */
<span class="nc bnc" id="L459" title="All 4 branches missed.">        final boolean canEdit = isEditable &amp;&amp; !bIsReconciled;</span>
<span class="nc" id="L460">        final boolean needsNullAmount = myTrans.needsNullAmount();</span>
<span class="nc bnc" id="L461" title="All 4 branches missed.">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_DIRECTION, canEdit &amp;&amp; myTrans.canSwitchDirection());</span>
<span class="nc" id="L462">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, canEdit);</span>
<span class="nc" id="L463">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_PARTNER, canEdit);</span>
<span class="nc" id="L464">        theFieldSet.setFieldEditable(MoneyWiseBasicDataType.TRANSCATEGORY, canEdit);</span>
<span class="nc" id="L465">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE, canEdit);</span>
<span class="nc bnc" id="L466" title="All 4 branches missed.">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_AMOUNT, canEdit &amp;&amp; !needsNullAmount);</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">        theFieldSet.setFieldVisible(MoneyWiseBasicResource.TRANSACTION_AMOUNT, !needsNullAmount);</span>

        /* Set the range for the dateButton */
<span class="nc" id="L470">        final MoneyWiseValidateTransaction myBuilder = (MoneyWiseValidateTransaction) myTrans.getList().getValidator();</span>
<span class="nc" id="L471">        theRange = myBuilder.getRange();</span>
<span class="nc" id="L472">    }</span>

    /**
     * Is the field editable?
     * @param pTrans the transaction
     * @param pField the field class
     * @return true/false
     */
    public static boolean isEditableField(final MoneyWiseTransaction pTrans,
                                          final MoneyWiseTransInfoClass pField) {
        /* Access the infoSet */
<span class="nc" id="L483">        final MoneyWiseTransInfoSet myInfoSet = pTrans.getInfoSet();</span>

        /* If the transaction is reconciled */
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (Boolean.TRUE.equals(pTrans.isReconciled())) {</span>
            /* Only allow editing of metaData */
<span class="nc" id="L488">            return myInfoSet.isMetaData(pField);</span>
        }

        /* Check whether the field is available */
<span class="nc" id="L492">        final MoneyWiseValidateTransaction myValidator = (MoneyWiseValidateTransaction) pTrans.getList().getValidator();</span>
<span class="nc" id="L493">        final MetisFieldRequired isRequired = myValidator.isClassRequired(pTrans, pField);</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">        return !isRequired.equals(MetisFieldRequired.NOTALLOWED);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    protected void updateField(final PrometheusFieldSetEvent pUpdate) throws OceanusException {
        /* Access the field */
<span class="nc" id="L501">        final MetisDataFieldId myField = pUpdate.getFieldId();</span>
<span class="nc" id="L502">        final MoneyWiseTransaction myTrans = getItem().getTransaction();</span>
<span class="nc" id="L503">        final MoneyWiseValidateTransaction myBuilder = (MoneyWiseValidateTransaction) myTrans.getList().getValidator();</span>

        /* Process updates */
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE.equals(myField)) {</span>
            /* Update the Date */
<span class="nc" id="L508">            myTrans.setDate(pUpdate.getValue(OceanusDate.class));</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_AMOUNT.equals(myField)) {</span>
            /* Update the Amount */
<span class="nc" id="L511">            myTrans.setAmount(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc" id="L512">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_ACCOUNT.equals(myField)) {</span>
            /* Update the Account */
<span class="nc" id="L515">            myTrans.setAccount(resolveAsset(pUpdate.getValue(MoneyWiseTransAsset.class)));</span>
<span class="nc" id="L516">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_DIRECTION.equals(myField)) {</span>
            /* Update the Direction */
<span class="nc" id="L519">            myTrans.switchDirection();</span>
<span class="nc" id="L520">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_PARTNER.equals(myField)) {</span>
            /* Update the Partner */
<span class="nc" id="L523">            myTrans.setPartner(resolveAsset(pUpdate.getValue(MoneyWiseTransAsset.class)));</span>
<span class="nc" id="L524">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">        } else if (MoneyWiseBasicDataType.TRANSCATEGORY.equals(myField)) {</span>
            /* Update the Category */
<span class="nc" id="L527">            myTrans.setCategory(pUpdate.getValue(MoneyWiseTransCategory.class));</span>
<span class="nc" id="L528">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_RECONCILED.equals(myField)) {</span>
            /* Update the Reconciled indication */
<span class="nc" id="L531">            myTrans.setReconciled(pUpdate.getValue(Boolean.class));</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.COMMENTS.equals(myField)) {</span>
            /* Update the Comments */
<span class="nc" id="L534">            myTrans.setComments(pUpdate.getValue(String.class));</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.REFERENCE.equals(myField)) {</span>
            /* Update the Reference */
<span class="nc" id="L537">            myTrans.setReference(pUpdate.getValue(String.class));</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.TRANSTAG.equals(myField)) {</span>
            /* Update the Tag indication */
<span class="nc" id="L540">            myTrans.setTransactionTags(pUpdate.getValue(List.class));</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.PARTNERAMOUNT.equals(myField)) {</span>
            /* Update the PartnerAmount */
<span class="nc" id="L543">            myTrans.setPartnerAmount(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.XCHANGERATE.equals(myField)) {</span>
            /* Update the ExchangeRate */
<span class="nc" id="L546">            myTrans.setExchangeRate(pUpdate.getValue(OceanusRatio.class));</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS.equals(myField)) {</span>
            /* Update the AccountDeltaUnits */
<span class="nc" id="L549">            myTrans.setAccountDeltaUnits(pUpdate.getValue(OceanusUnits.class));</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.PARTNERDELTAUNITS.equals(myField)) {</span>
            /* Update the PartnerDeltaUnits */
<span class="nc" id="L552">            myTrans.setPartnerDeltaUnits(pUpdate.getValue(OceanusUnits.class));</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.PRICE.equals(myField)) {</span>
            /* Update the Price */
<span class="nc" id="L555">            myTrans.setPrice(pUpdate.getValue(OceanusPrice.class));</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.COMMISSION.equals(myField)) {</span>
            /* Update the Commission */
<span class="nc" id="L558">            myTrans.setCommission(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.DILUTION.equals(myField)) {</span>
            /* Update the Dilution */
<span class="nc" id="L561">            myTrans.setDilution(pUpdate.getValue(OceanusRatio.class));</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.QUALIFYYEARS.equals(myField)) {</span>
            /* Update the QualifyYears */
<span class="nc" id="L564">            myTrans.setYears(pUpdate.getValue(Integer.class));</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT.equals(myField)) {</span>
            /* Update the ReturnedCashAccount */
<span class="nc" id="L567">            myTrans.setReturnedCashAccount(pUpdate.getValue(MoneyWiseTransAsset.class));</span>
<span class="nc" id="L568">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.RETURNEDCASH.equals(myField)) {</span>
            /* Update the ReturnedCash */
<span class="nc" id="L571">            myTrans.setReturnedCash(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.TAXCREDIT.equals(myField)) {</span>
            /* Update the TaxCredit */
<span class="nc" id="L574">            myTrans.setTaxCredit(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.EMPLOYEENATINS.equals(myField)) {</span>
            /* Update the EmployeeNatIns */
<span class="nc" id="L577">            myTrans.setEmployeeNatIns(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.EMPLOYERNATINS.equals(myField)) {</span>
            /* Update the EmployerNayIns */
<span class="nc" id="L580">            myTrans.setEmployerNatIns(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.DEEMEDBENEFIT.equals(myField)) {</span>
            /* Update the Benefit */
<span class="nc" id="L583">            myTrans.setDeemedBenefit(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.WITHHELD.equals(myField)) {</span>
            /* Update the Withheld */
<span class="nc" id="L586">            myTrans.setWithheld(pUpdate.getValue(OceanusMoney.class));</span>
        }
<span class="nc" id="L588">    }</span>

    @Override
    protected void declareGoToItems(final boolean pUpdates) {
        /* Access the item */
<span class="nc" id="L593">        final MoneyWiseXAnalysisEvent myItem = getItem();</span>

        /* Access the analysis and the relevant filters */
<span class="nc" id="L596">        final MoneyWiseXAnalysis myAnalysis = theAnalysisSelect.getAnalysis();</span>
<span class="nc" id="L597">        final OceanusDateRange myDateRange = theAnalysisSelect.getRange();</span>
<span class="nc" id="L598">        final MoneyWiseXTransactionFilters myFilters = new MoneyWiseXTransactionFilters(myAnalysis, myDateRange, myItem);</span>

        /* Remove the current filter */
<span class="nc" id="L601">        final MoneyWiseXAnalysisFilter&lt;?, ?&gt; myCurrent = theAnalysisSelect.getFilter();</span>
<span class="nc" id="L602">        myFilters.remove(myCurrent);</span>

        /* Loop through the filters */
<span class="nc" id="L605">        final Iterator&lt;MoneyWiseXAnalysisFilter&lt;?, ?&gt;&gt; myIterator = myFilters.iterator();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L607">            final MoneyWiseXAnalysisFilter&lt;?, ?&gt; myFilter = myIterator.next();</span>

            /* declare it */
<span class="nc" id="L610">            declareGoToFilter(myFilter);</span>
<span class="nc" id="L611">        }</span>

        /* If we have not had updates */
<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (!pUpdates) {</span>
            /* Allow GoTo different panels */
<span class="nc" id="L616">            buildAssetGoTo(myItem.getAccount());</span>
<span class="nc" id="L617">            buildAssetGoTo(myItem.getPartner());</span>
<span class="nc" id="L618">            declareGoToItem(myItem.getCategory());</span>
<span class="nc" id="L619">            buildAssetGoTo(myItem.getReturnedCashAccount());</span>
        }
<span class="nc" id="L621">    }</span>

    /**
     * Handle goto declarations for TransactionAssets.
     * @param pAsset the asset
     */
    private void buildAssetGoTo(final MoneyWiseTransAsset pAsset) {
<span class="nc bnc" id="L628" title="All 2 branches missed.">        if (pAsset instanceof MoneyWiseSecurityHolding myHolding) {</span>
            /* Build menu Items for Portfolio and Security */
<span class="nc" id="L630">            declareGoToItem(myHolding.getPortfolio());</span>
<span class="nc" id="L631">            declareGoToItem(myHolding.getSecurity());</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">        } else if (pAsset instanceof MoneyWiseAssetBase myAsset) {</span>
<span class="nc" id="L633">            declareGoToItem(myAsset);</span>
        }
<span class="nc" id="L635">    }</span>

    /**
     * Resolve Asset.
     * @param pAsset the asset to resolve
     * @return the resolved asset
     */
    public static MoneyWiseTransAsset resolveAsset(final MoneyWiseTransAsset pAsset) {
        /* If this is a security holding */
<span class="nc bnc" id="L644" title="All 2 branches missed.">        if (pAsset instanceof MoneyWiseSecurityHolding myHolding) {</span>
            /* declare holding via map */
<span class="nc" id="L646">            final MoneyWisePortfolio myPortfolio = myHolding.getPortfolio();</span>
<span class="nc" id="L647">            final MoneyWiseSecurity mySecurity = myHolding.getSecurity();</span>
<span class="nc" id="L648">            final MoneyWiseDataSet myData = myPortfolio.getDataSet();</span>
<span class="nc" id="L649">            final MoneyWiseSecurityHoldingMap myMap = myData.getPortfolios().getSecurityHoldingsMap();</span>
<span class="nc" id="L650">            return myMap.declareHolding(myPortfolio, mySecurity);</span>
        }

        /* Just return the asset */
<span class="nc" id="L654">        return pAsset;</span>
    }

    /**
     * Build the account menu for an item.
     * @param pMenu the menu
     * @param pEvent the event to build for
     */
    public void buildAccountMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                 final MoneyWiseXAnalysisEvent pEvent) {
        /* Clear the menu */
<span class="nc" id="L665">        pMenu.removeAllItems();</span>

        /* Add possible items */
<span class="nc" id="L668">        final MoneyWiseTransaction myTrans = pEvent.getTransaction();</span>
<span class="nc" id="L669">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class), true, myTrans);</span>
<span class="nc" id="L670">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.CASH, MoneyWiseCashList.class), true, myTrans);</span>
<span class="nc" id="L671">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.LOAN, MoneyWiseLoanList.class), true, myTrans);</span>
<span class="nc" id="L672">        buildHoldingMenu(pMenu, true, myTrans);</span>
<span class="nc" id="L673">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class), true, myTrans);</span>
<span class="nc" id="L674">    }</span>

    /**
     * Build the partner menu for an item.
     * @param pMenu the menu
     * @param pEvent the event to build for
     */
    public void buildPartnerMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                 final MoneyWiseXAnalysisEvent pEvent) {
        /* Clear the menu */
<span class="nc" id="L684">        pMenu.removeAllItems();</span>

        /* Add possible items */
<span class="nc" id="L687">        final MoneyWiseTransaction myTrans = pEvent.getTransaction();</span>
<span class="nc" id="L688">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class), false, myTrans);</span>
<span class="nc" id="L689">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.CASH, MoneyWiseCashList.class), false, myTrans);</span>
<span class="nc" id="L690">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.LOAN, MoneyWiseLoanList.class), false, myTrans);</span>
<span class="nc" id="L691">        buildHoldingMenu(pMenu, false, myTrans);</span>
<span class="nc" id="L692">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class), false, myTrans);</span>
<span class="nc" id="L693">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.PAYEE, MoneyWisePayeeList.class), false, myTrans);</span>
<span class="nc" id="L694">    }</span>

    /**
     * Build the asset menu for an item.
     * @param &lt;T&gt; the Asset type
     * @param pMenu the menu
     * @param pIsAccount is this item the account rather than partner
     * @param pList the asset list
     * @param pTrans the transaction to build for
     */
    private static &lt;T extends MoneyWiseAssetBase&gt; void buildAssetMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                                                      final MoneyWiseAssetBaseList&lt;T&gt; pList,
                                                                      final boolean pIsAccount,
                                                                      final MoneyWiseTransaction pTrans) {
        /* Record active item */
<span class="nc" id="L709">        final MoneyWiseTransAsset myAccount = pTrans.getAccount();</span>
<span class="nc" id="L710">        final MoneyWiseTransCategory myCategory = pTrans.getCategory();</span>
<span class="nc" id="L711">        final MoneyWiseDataValidatorTrans&lt;?&gt; myValidator = pTrans.getList().getValidator();</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">        final MoneyWiseTransAsset myCurr = pIsAccount</span>
<span class="nc" id="L713">                ? myAccount</span>
<span class="nc" id="L714">                : pTrans.getPartner();</span>
<span class="nc" id="L715">        TethysUIScrollItem&lt;MoneyWiseTransAsset&gt; myActive = null;</span>
<span class="nc" id="L716">        TethysUIScrollSubMenu&lt;MoneyWiseTransAsset&gt; myMenu = null;</span>

        /* Loop through the available values */
<span class="nc" id="L719">        final Iterator&lt;T&gt; myIterator = pList.iterator();</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L721">            final T myAsset = myIterator.next();</span>

            /* Only process non-deleted/non-closed items */
<span class="nc bnc" id="L724" title="All 4 branches missed.">            boolean bIgnore = myAsset.isDeleted() || myAsset.isClosed();</span>

            /* Check whether the asset is allowable for the owner */
<span class="nc bnc" id="L727" title="All 2 branches missed.">            bIgnore |= !(pIsAccount</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">                    ? myValidator.isValidAccount(myAsset)</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                    : myValidator.isValidPartner(myAccount, myCategory, myAsset));</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">            if (bIgnore) {</span>
<span class="nc" id="L731">                continue;</span>
            }

            /* If this the first item */
<span class="nc bnc" id="L735" title="All 2 branches missed.">            if (myMenu == null) {</span>
                /* Create a new subMenu and add it to the popUp */
<span class="nc" id="L737">                myMenu = pMenu.addSubMenu(pList.getItemType().getItemName());</span>
            }

            /* Create a new MenuItem and add it to the popUp */
<span class="nc" id="L741">            final TethysUIScrollItem&lt;MoneyWiseTransAsset&gt; myItem = myMenu.getSubMenu().addItem(myAsset);</span>

            /* If this is the active category */
<span class="nc bnc" id="L744" title="All 2 branches missed.">            if (myAsset.equals(myCurr)) {</span>
                /* Record it */
<span class="nc" id="L746">                myActive = myItem;</span>
            }
<span class="nc" id="L748">        }</span>

        /* Ensure active item is visible */
<span class="nc bnc" id="L751" title="All 2 branches missed.">        if (myActive != null) {</span>
<span class="nc" id="L752">            myActive.scrollToItem();</span>
        }
<span class="nc" id="L754">    }</span>

    /**
     * Build the holding asset menu for an item.
     * @param pMenu the menu
     * @param pIsAccount is this item the account rather than partner
     * @param pTrans the transaction to build for
     */
    private static void buildHoldingMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                         final boolean pIsAccount,
                                         final MoneyWiseTransaction pTrans) {
        /* Record active item */
<span class="nc" id="L766">        final MoneyWiseTransAsset myAccount = pTrans.getAccount();</span>
<span class="nc" id="L767">        final MoneyWiseTransCategory myCategory = pTrans.getCategory();</span>
<span class="nc" id="L768">        final MoneyWiseDataValidatorTrans&lt;?&gt; myValidator = pTrans.getList().getValidator();</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">        final MoneyWiseTransAsset myCurr = pIsAccount</span>
<span class="nc" id="L770">                ? myAccount</span>
<span class="nc" id="L771">                : pTrans.getPartner();</span>
<span class="nc" id="L772">        TethysUIScrollItem&lt;MoneyWiseTransAsset&gt; myActive = null;</span>
<span class="nc" id="L773">        TethysUIScrollSubMenu&lt;MoneyWiseTransAsset&gt; myMenu = null;</span>

        /* Access Portfolios and Holdings Map */
<span class="nc" id="L776">        final MoneyWiseDataSet myData = pTrans.getDataSet();</span>
<span class="nc" id="L777">        final MoneyWisePortfolioList myPortfolios = myData.getPortfolios();</span>
<span class="nc" id="L778">        final MoneyWiseSecurityHoldingMap myMap = myPortfolios.getSecurityHoldingsMap();</span>

        /* Loop through the Portfolios */
<span class="nc" id="L781">        final Iterator&lt;MoneyWisePortfolio&gt; myPortIterator = myPortfolios.iterator();</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">        while (myPortIterator.hasNext()) {</span>
<span class="nc" id="L783">            final MoneyWisePortfolio myPortfolio = myPortIterator.next();</span>
<span class="nc" id="L784">            TethysUIScrollSubMenu&lt;MoneyWiseTransAsset&gt; myCoreMenu = null;</span>

            /* Ignore deleted or closed */
<span class="nc bnc" id="L787" title="All 2 branches missed.">            if (myPortfolio.isDeleted()</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">                    || Boolean.TRUE.equals(myPortfolio.isClosed())) {</span>
<span class="nc" id="L789">                continue;</span>
            }

            /* Look for existing and new holdings */
<span class="nc" id="L793">            final Iterator&lt;MoneyWiseSecurityHolding&gt; myExistIterator = myMap.existingIterator(myPortfolio);</span>
<span class="nc" id="L794">            final Iterator&lt;MoneyWiseSecurityHolding&gt; myNewIterator = myMap.newIterator(myPortfolio);</span>
<span class="nc bnc" id="L795" title="All 4 branches missed.">            if ((myExistIterator != null) || (myNewIterator != null)) {</span>
                /* If there are existing elements */
<span class="nc bnc" id="L797" title="All 2 branches missed.">                if (myExistIterator != null) {</span>
                    /* Loop through them */
<span class="nc bnc" id="L799" title="All 2 branches missed.">                    while (myExistIterator.hasNext()) {</span>
<span class="nc" id="L800">                        final MoneyWiseSecurityHolding myHolding = myExistIterator.next();</span>
<span class="nc" id="L801">                        final MoneyWiseSecurity mySecurity = myHolding.getSecurity();</span>

                        /* Check whether the asset is allowable for the owner */
<span class="nc bnc" id="L804" title="All 2 branches missed.">                        final boolean bIgnore = !(pIsAccount</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">                                ? myValidator.isValidAccount(myHolding)</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">                                : myValidator.isValidPartner(myAccount, myCategory, myHolding));</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">                        if (bIgnore) {</span>
<span class="nc" id="L808">                            continue;</span>
                        }

                        /* Ensure that hierarchy is created */
<span class="nc bnc" id="L812" title="All 2 branches missed.">                        if (myMenu == null) {</span>
                            /* Create a new JMenu and add it to the popUp */
<span class="nc" id="L814">                            myMenu = pMenu.addSubMenu(MoneyWiseAssetType.SECURITYHOLDING.toString());</span>
                        }
<span class="nc bnc" id="L816" title="All 2 branches missed.">                        if (myCoreMenu == null) {</span>
                            /* Create a new Menu and add it to the popUp */
<span class="nc" id="L818">                            myCoreMenu = myMenu.getSubMenu().addSubMenu(myPortfolio.getName());</span>
                        }

                        /* Add the item to the menu */
<span class="nc" id="L822">                        final TethysUIScrollItem&lt;MoneyWiseTransAsset&gt; myItem = myCoreMenu.getSubMenu().addItem(myHolding, mySecurity.getName());</span>

                        /* If this is the active holding */
<span class="nc bnc" id="L825" title="All 2 branches missed.">                        if (mySecurity.equals(myCurr)) {</span>
                            /* Record it */
<span class="nc" id="L827">                            myActive = myItem;</span>
                        }
<span class="nc" id="L829">                    }</span>
                }

                /* If there are new elements */
<span class="nc bnc" id="L833" title="All 2 branches missed.">                if (myNewIterator != null) {</span>
                    /* Loop through them */
<span class="nc" id="L835">                    TethysUIScrollSubMenu&lt;MoneyWiseTransAsset&gt; mySubMenu = null;</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">                    while (myNewIterator.hasNext()) {</span>
<span class="nc" id="L837">                        final MoneyWiseSecurityHolding myHolding = myNewIterator.next();</span>
<span class="nc" id="L838">                        final MoneyWiseSecurity mySecurity = myHolding.getSecurity();</span>

                        /* Check whether the asset is allowable for the owner */
<span class="nc bnc" id="L841" title="All 2 branches missed.">                        final boolean bIgnore = !(pIsAccount</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">                                ? myValidator.isValidAccount(myHolding)</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">                                : myValidator.isValidPartner(myAccount, myCategory, myHolding));</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">                        if (bIgnore) {</span>
<span class="nc" id="L845">                            continue;</span>
                        }

                        /* Ensure that hierarchy is created */
<span class="nc bnc" id="L849" title="All 2 branches missed.">                        if (myMenu == null) {</span>
                            /* Create a new subMenu and add it to the popUp */
<span class="nc" id="L851">                            myMenu = pMenu.addSubMenu(MoneyWiseAssetType.SECURITYHOLDING.toString());</span>
                        }
<span class="nc bnc" id="L853" title="All 2 branches missed.">                        if (myCoreMenu == null) {</span>
                            /* Create a new subMenu and add it to the popUp */
<span class="nc" id="L855">                            myCoreMenu = myMenu.getSubMenu().addSubMenu(myPortfolio.getName());</span>
                        }
<span class="nc bnc" id="L857" title="All 2 branches missed.">                        if (mySubMenu == null) {</span>
                            /* Create a new subMenu */
<span class="nc" id="L859">                            mySubMenu = myCoreMenu.getSubMenu().addSubMenu(MoneyWiseSecurityHolding.SECURITYHOLDING_NEW);</span>
                        }

                        /* Add the item to the menu */
<span class="nc" id="L863">                        mySubMenu.getSubMenu().addItem(myHolding, mySecurity.getName());</span>
<span class="nc" id="L864">                    }</span>
                }
            }
<span class="nc" id="L867">        }</span>

        /* Ensure active item is visible */
<span class="nc bnc" id="L870" title="All 2 branches missed.">        if (myActive != null) {</span>
<span class="nc" id="L871">            myActive.scrollToItem();</span>
        }
<span class="nc" id="L873">    }</span>

    /**
     * Build the category menu for an item.
     * @param pMenu the menu
     * @param pEvent the event to build for
     */
    public void buildCategoryMenu(final TethysUIScrollMenu&lt;MoneyWiseTransCategory&gt; pMenu,
                                  final MoneyWiseXAnalysisEvent pEvent) {
        /* Clear the menu */
<span class="nc" id="L883">        pMenu.removeAllItems();</span>

        /* Record active item */
<span class="nc" id="L886">        final MoneyWiseTransAsset myAccount = pEvent.getAccount();</span>
<span class="nc" id="L887">        final MoneyWiseTransCategory myCurr = pEvent.getCategory();</span>
<span class="nc" id="L888">        TethysUIScrollItem&lt;MoneyWiseTransCategory&gt; myActive = null;</span>
        TethysUIScrollItem&lt;MoneyWiseTransCategory&gt; myItem;

        /* Create a simple map for top-level categories */
<span class="nc" id="L892">        final Map&lt;String, TethysUIScrollSubMenu&lt;MoneyWiseTransCategory&gt;&gt; myMap = new HashMap&lt;&gt;();</span>

        /* Access Categories */
<span class="nc" id="L895">        final MoneyWiseTransCategoryList myCategories = getDataList(MoneyWiseBasicDataType.TRANSCATEGORY, MoneyWiseTransCategoryList.class);</span>
<span class="nc" id="L896">        final MoneyWiseDataValidatorTrans&lt;?&gt; myValidator = pEvent.getTransaction().getList().getValidator();</span>

        /* Loop through the available category values */
<span class="nc" id="L899">        final Iterator&lt;MoneyWiseTransCategory&gt; myIterator = myCategories.iterator();</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L901">            final MoneyWiseTransCategory myCategory = myIterator.next();</span>

            /* Only process non-deleted low-level items */
<span class="nc" id="L904">            final MoneyWiseTransCategoryClass myClass = myCategory.getCategoryTypeClass();</span>
<span class="nc bnc" id="L905" title="All 4 branches missed.">            boolean bIgnore = myCategory.isDeleted() || myClass.canParentCategory();</span>

            /* Check whether the category is allowable for the owner */
<span class="nc bnc" id="L908" title="All 2 branches missed.">            bIgnore |= !myValidator.isValidCategory(myAccount, myCategory);</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">            if (bIgnore) {</span>
<span class="nc" id="L910">                continue;</span>
            }

            /* Determine parent */
<span class="nc" id="L914">            final MoneyWiseTransCategory myParent = myCategory.getParentCategory();</span>

            /* If we have a parent */
<span class="nc bnc" id="L917" title="All 2 branches missed.">            if (myParent != null) {</span>
<span class="nc" id="L918">                final String myParentName = myParent.getName();</span>
<span class="nc" id="L919">                final TethysUIScrollSubMenu&lt;MoneyWiseTransCategory&gt; myMenu = myMap.computeIfAbsent(myParentName, pMenu::addSubMenu);</span>

                /* Create a new MenuItem and add it to the subMenu */
<span class="nc" id="L922">                myItem = myMenu.getSubMenu().addItem(myCategory, myCategory.getSubCategory());</span>

<span class="nc" id="L924">            } else {</span>
                /* Create a new MenuItem and add it to the popUp */
<span class="nc" id="L926">                myItem = pMenu.addItem(myCategory);</span>
            }

            /* If this is the active category */
<span class="nc bnc" id="L930" title="All 2 branches missed.">            if (myCategory.equals(myCurr)) {</span>
                /* Record it */
<span class="nc" id="L932">                myActive = myItem;</span>
            }
<span class="nc" id="L934">        }</span>

        /* Ensure active item is visible */
<span class="nc bnc" id="L937" title="All 2 branches missed.">        if (myActive != null) {</span>
<span class="nc" id="L938">            myActive.scrollToItem();</span>
        }
<span class="nc" id="L940">    }</span>

    /**
     * Build the ReturnedAccount menu for an item.
     * @param pMenu the menu
     * @param pEvent the event to build for
     */
    public void buildReturnedAccountMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                         final MoneyWiseXAnalysisEvent pEvent) {
        /* Clear the menu */
<span class="nc" id="L950">        pMenu.removeAllItems();</span>

        /* Add possible items */
<span class="nc" id="L953">        final MoneyWiseTransaction myTrans = pEvent.getTransaction();</span>
<span class="nc" id="L954">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class), false, myTrans);</span>
<span class="nc" id="L955">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class), false, myTrans);</span>
<span class="nc" id="L956">    }</span>

    /**
     * Build the possible TransactionTag list.
     * @return the transaction tag iterator
     */
    public Iterator&lt;MoneyWiseTransTag&gt; buildTransactionTags() {
        /* Create a list */
<span class="nc" id="L964">        final List&lt;MoneyWiseTransTag&gt; myList = new ArrayList&lt;&gt;();</span>

        /* Loop through the TransactionTags */
<span class="nc" id="L967">        final Iterator&lt;MoneyWiseTransTag&gt; myIterator = getEditSet()</span>
<span class="nc" id="L968">                .getDataList(MoneyWiseBasicDataType.TRANSTAG, MoneyWiseTransTagList.class).iterator();</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L970">            final MoneyWiseTransTag myTag = myIterator.next();</span>

            /* Add to list if available */
<span class="nc bnc" id="L973" title="All 2 branches missed.">            if (!myTag.isDeleted()) {</span>
<span class="nc" id="L974">                myList.add(myTag);</span>
            }
<span class="nc" id="L976">        }</span>

        /* Return the iterator */
<span class="nc" id="L979">        return myList.iterator();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>