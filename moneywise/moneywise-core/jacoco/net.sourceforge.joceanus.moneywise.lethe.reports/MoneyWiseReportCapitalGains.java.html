<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseReportCapitalGains.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.lethe.reports</a> &gt; <span class="el_source">MoneyWiseReportCapitalGains.java</span></div><h1>MoneyWiseReportCapitalGains.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.lethe.reports;

import net.sourceforge.joceanus.metis.report.MetisReportBase;
import net.sourceforge.joceanus.metis.report.MetisReportHTMLBuilder;
import net.sourceforge.joceanus.metis.report.MetisReportHTMLBuilder.MetisHTMLTable;
import net.sourceforge.joceanus.metis.report.MetisReportManager;
import net.sourceforge.joceanus.metis.report.MetisReportReferenceManager.DelayedTable;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseBasicDataType;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseBasicResource;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction.MoneyWiseTransactionList;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysis;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisSecurityBucket;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisSecurityAttr;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisSecurityValues;
import net.sourceforge.joceanus.moneywise.lethe.views.MoneyWiseAnalysisFilter;
import net.sourceforge.joceanus.moneywise.tax.MoneyWiseCashType;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.decimal.OceanusDecimal;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.decimal.OceanusPrice;
import net.sourceforge.joceanus.oceanus.decimal.OceanusRatio;
import net.sourceforge.joceanus.oceanus.decimal.OceanusUnits;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

import java.util.Iterator;

/**
 * CapitalGains report builder.
 */
public class MoneyWiseReportCapitalGains
        extends MetisReportBase&lt;MoneyWiseAnalysis, MoneyWiseAnalysisFilter&lt;?, ?&gt;&gt; {
    /**
     * The Title text.
     */
<span class="nc" id="L56">    private static final String TEXT_TITLE = MoneyWiseReportResource.CAPITALGAINS_TITLE.getValue();</span>

    /**
     * HTML builder.
     */
    private final MetisReportHTMLBuilder theBuilder;

    /**
     * The Formatter.
     */
    private final OceanusDataFormatter theFormatter;

    /**
     * The string builder.
     */
    private final StringBuilder theStringBuilder;

    /**
     * The source SecurityBucket.
     */
    private MoneyWiseAnalysisSecurityBucket theSecurity;

    /**
     * The transactions.
     */
    private MoneyWiseTransactionList theTransactions;

    /**
     * The EndDate.
     */
    private OceanusDate theEndDate;

    /**
     * The table.
     */
    private MetisHTMLTable theTable;

    /**
     * The attribute table.
     */
    private MetisHTMLTable theAttrTable;

    /**
     * Constructor.
     * @param pManager the Report Manager
     */
<span class="nc" id="L102">    protected MoneyWiseReportCapitalGains(final MetisReportManager&lt;MoneyWiseAnalysisFilter&lt;?, ?&gt;&gt; pManager) {</span>
        /* Access underlying utilities */
<span class="nc" id="L104">        theBuilder = pManager.getBuilder();</span>
<span class="nc" id="L105">        theFormatter = theBuilder.getDataFormatter();</span>
<span class="nc" id="L106">        theStringBuilder = new StringBuilder();</span>
<span class="nc" id="L107">    }</span>

    /**
     * Set the security bucket.
     * @param pSecurity the security bucket
     */
    protected void setSecurity(final MoneyWiseAnalysisSecurityBucket pSecurity) {
<span class="nc" id="L114">        theSecurity = pSecurity;</span>
<span class="nc" id="L115">    }</span>

    @Override
    public Document createReport(final MoneyWiseAnalysis pAnalysis) {
        /* Access the securities and the date */
<span class="nc" id="L120">        theTransactions = pAnalysis.getEditSet().getDataList(MoneyWiseBasicDataType.TRANSACTION, MoneyWiseTransactionList.class);</span>
<span class="nc" id="L121">        theEndDate = pAnalysis.getDateRange().getEnd();</span>

        /* Start the report */
<span class="nc" id="L124">        final Element myBody = theBuilder.startReport();</span>
<span class="nc" id="L125">        theBuilder.makeTitle(myBody, TEXT_TITLE, theFormatter.formatObject(theEndDate));</span>
<span class="nc" id="L126">        theBuilder.makeSubTitle(myBody, theSecurity.getDecoratedName());</span>

        /* Initialise the table */
<span class="nc" id="L129">        theTable = theBuilder.startTable(myBody);</span>
<span class="nc" id="L130">        theBuilder.startHdrRow(theTable);</span>
<span class="nc" id="L131">        theBuilder.makeTitleCell(theTable, MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE.getValue());</span>
<span class="nc" id="L132">        theBuilder.makeTitleCell(theTable, MoneyWiseBasicDataType.TRANSACTION.getItemName());</span>

        /* Format the history */
<span class="nc" id="L135">        formatHistory();</span>

        /* Return the document */
<span class="nc" id="L138">        return theBuilder.getDocument();</span>
    }

    /**
     * format the cost history.
     */
    private void formatHistory() {
        /* Loop through the transactions */
<span class="nc" id="L146">        final Iterator&lt;MoneyWiseTransaction&gt; myIterator = theTransactions.iterator();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L148">            final MoneyWiseTransaction myTrans = myIterator.next();</span>

            /* Check for End of report */
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (theEndDate != null</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                    &amp;&amp; theEndDate.compareTo(myTrans.getDate()) &lt; 0) {</span>
<span class="nc" id="L153">                break;</span>
            }

            /* If the transaction relates to the security */
<span class="nc" id="L157">            final MoneyWiseAnalysisSecurityValues myValues = theSecurity.getValuesForTransaction(myTrans);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (myValues != null) {</span>
                /* Format the transaction */
<span class="nc" id="L160">                formatTransaction(myTrans, myValues);</span>

                /* If we have an attribute table */
<span class="nc bnc" id="L163" title="All 2 branches missed.">                if (theAttrTable != null) {</span>
                    /* Embed the table correctly and reset the indicator */
<span class="nc" id="L165">                    theBuilder.embedTable(theAttrTable);</span>
<span class="nc" id="L166">                    theAttrTable = null;</span>
                }
            }
<span class="nc" id="L169">        }</span>
<span class="nc" id="L170">    }</span>

    /**
     * Format the details.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatTransaction(final MoneyWiseTransaction pTrans,
                                   final MoneyWiseAnalysisSecurityValues pValues) {
        /* Switch on the class */
<span class="nc bnc" id="L180" title="All 7 branches missed.">        switch (pTrans.getCategoryClass()) {</span>
            case TRANSFER:
            case STOCKRIGHTSISSUE:
            case INHERITED:
<span class="nc" id="L184">                formatTransfer(pTrans, pValues);</span>
<span class="nc" id="L185">                break;</span>
            case SECURITYREPLACE:
            case STOCKTAKEOVER:
<span class="nc" id="L188">                formatStockTakeOver(pTrans, pValues);</span>
<span class="nc" id="L189">                break;</span>
            case STOCKDEMERGER:
<span class="nc" id="L191">                formatStockDeMerger(pTrans, pValues);</span>
<span class="nc" id="L192">                break;</span>
            case STOCKSPLIT:
            case UNITSADJUST:
<span class="nc" id="L195">                formatUnitsAdjust(pTrans, pValues);</span>
<span class="nc" id="L196">                break;</span>
            case DIVIDEND:
<span class="nc" id="L198">                formatDividend(pTrans, pValues);</span>
<span class="nc" id="L199">                break;</span>
            case PORTFOLIOXFER:
<span class="nc" id="L201">                formatPortfolioXfer(pTrans, pValues);</span>
<span class="nc" id="L202">                break;</span>
            default:
                break;
        }
<span class="nc" id="L206">    }</span>

    /**
     * Format basic details of a transaction.
     * @param pTrans the transaction
     */
    private void formatBasicTransaction(final MoneyWiseTransaction pTrans) {
        /* Create the transaction row */
<span class="nc" id="L214">        theBuilder.startRow(theTable);</span>
<span class="nc" id="L215">        theBuilder.makeValueCell(theTable, pTrans.getDate());</span>
<span class="nc" id="L216">        theBuilder.makeValueCell(theTable, pTrans);</span>
<span class="nc" id="L217">    }</span>

    /**
     * Check whether this is a debit transaction for the security.
     * @param pTrans the transaction
     * @return true/false
     */
    private boolean isDebit(final MoneyWiseTransaction pTrans) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">        final MoneyWiseTransAsset myDebit = pTrans.getDirection().isTo()</span>
<span class="nc" id="L226">                ? pTrans.getAccount()</span>
<span class="nc" id="L227">                : pTrans.getPartner();</span>
<span class="nc" id="L228">        return myDebit.equals(theSecurity.getSecurityHolding());</span>
    }

    /**
     * Check whether this is a credit transaction for the security.
     * @param pTrans the transaction
     * @return true/false
     */
    private boolean isCredit(final MoneyWiseTransaction pTrans) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        final MoneyWiseTransAsset myCredit = pTrans.getDirection().isFrom()</span>
<span class="nc" id="L238">                ? pTrans.getAccount()</span>
<span class="nc" id="L239">                : pTrans.getPartner();</span>
<span class="nc" id="L240">        return myCredit.equals(theSecurity.getSecurityHolding());</span>
    }

    /**
     * Ensure the attribute table.
     */
    private void ensureAttrTable() {
        /* If we do not have a current attribute table */
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (theAttrTable == null) {</span>
            /* Create a new table */
<span class="nc" id="L250">            theAttrTable = theBuilder.createEmbeddedTable(theTable);</span>
        }
<span class="nc" id="L252">    }</span>

    /**
     * Format a value.
     * @param pAttr the attribute
     * @param pValue the value
     */
    private void formatValue(final MoneyWiseAnalysisSecurityAttr pAttr,
                             final Object pValue) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L262">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L265">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L266">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L267">        theBuilder.makeStretchedValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L268">    }</span>

    /**
     * Format a division.
     * @param pAttr the attribute
     * @param pValue the value
     * @param pNumerator the numerator
     * @param pDivisor the divisor
     */
    private void formatDivision(final MoneyWiseAnalysisSecurityAttr pAttr,
                                final Object pValue,
                                final OceanusDecimal pNumerator,
                                final OceanusDecimal pDivisor) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L282">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L285">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L286">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L287">        theBuilder.makeValueCell(theAttrTable, formatDivision(pNumerator, pDivisor));</span>
<span class="nc" id="L288">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L289">    }</span>

    /**
     * Format a division.
     * @param pNumerator the numerator
     * @param pDivisor the divisor
     * @return the formatted division
     */
    private String formatDivision(final OceanusDecimal pNumerator,
                                  final OceanusDecimal pDivisor) {
<span class="nc" id="L299">        return formatCombination(pNumerator, pDivisor, '/');</span>
    }

    /**
     * Format a valuation.
     * @param pAttr the attribute
     * @param pValue the value
     * @param pUnits the units
     * @param pPrice the price
     * @param pXchangeRate the exchange rate
     */
    private void formatValuation(final MoneyWiseAnalysisSecurityAttr pAttr,
                                 final Object pValue,
                                 final OceanusUnits pUnits,
                                 final OceanusPrice pPrice,
                                 final OceanusRatio pXchangeRate) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L316">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L319">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L320">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L321">        theBuilder.makeValueCell(theAttrTable, formatValuation(pUnits, pPrice, pXchangeRate));</span>
<span class="nc" id="L322">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L323">    }</span>

    /**
     * Format a valuation.
     * @param pUnits the units
     * @param pPrice the price
     * @param pXchangeRate the exchange rate
     * @return the formatted valuation
     */
    private String formatValuation(final OceanusUnits pUnits,
                                   final OceanusPrice pPrice,
                                   final OceanusRatio pXchangeRate) {
<span class="nc" id="L335">        theStringBuilder.setLength(0);</span>
<span class="nc" id="L336">        theStringBuilder.append(theFormatter.formatObject(pUnits));</span>
<span class="nc" id="L337">        theStringBuilder.append('@');</span>
<span class="nc" id="L338">        theStringBuilder.append(theFormatter.formatObject(pPrice));</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (pXchangeRate != null) {</span>
<span class="nc" id="L340">            theStringBuilder.append('/');</span>
<span class="nc" id="L341">            theStringBuilder.append(theFormatter.formatObject(pXchangeRate));</span>
        }
<span class="nc" id="L343">        return theStringBuilder.toString();</span>
    }

    /**
     * Format a multiplication.
     * @param pAttr the attribute
     * @param pValue the value
     * @param pFirst the first item
     * @param pSecond the second item
     */
    private void formatMultiplication(final MoneyWiseAnalysisSecurityAttr pAttr,
                                      final Object pValue,
                                      final OceanusDecimal pFirst,
                                      final OceanusDecimal pSecond) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L358">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L361">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L362">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L363">        theBuilder.makeValueCell(theAttrTable, formatMultiplication(pFirst, pSecond));</span>
<span class="nc" id="L364">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L365">    }</span>

    /**
     * Format a multiplication.
     * @param pFirst the first item
     * @param pSecond the second item
     * @return the formatted multiplication
     */
    private String formatMultiplication(final OceanusDecimal pFirst,
                                        final OceanusDecimal pSecond) {
<span class="nc" id="L375">        return formatCombination(pFirst, pSecond, '*');</span>
    }

    /**
     * Format an addition.
     * @param pAttr the attribute
     * @param pValue the value
     * @param pFirst the first item
     * @param pSecond the second item
     */
    private void formatAddition(final MoneyWiseAnalysisSecurityAttr pAttr,
                                final Object pValue,
                                final OceanusDecimal pFirst,
                                final OceanusDecimal pSecond) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L390">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L393">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L394">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L395">        theBuilder.makeValueCell(theAttrTable, formatAddition(pFirst, pSecond));</span>
<span class="nc" id="L396">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L397">    }</span>

    /**
     * Format an addition.
     * @param pFirst the first item
     * @param pSecond the second item
     * @return the formatted addition
     */
    private String formatAddition(final OceanusDecimal pFirst,
                                  final OceanusDecimal pSecond) {
<span class="nc" id="L407">        return formatCombination(pFirst, pSecond, '+');</span>
    }

    /**
     * Format a subtraction.
     * @param pAttr the attribute
     * @param pValue the value
     * @param pFirst the first item
     * @param pSecond the second item
     */
    private void formatSubtraction(final MoneyWiseAnalysisSecurityAttr pAttr,
                                   final Object pValue,
                                   final OceanusDecimal pFirst,
                                   final OceanusDecimal pSecond) {
        /* Ensure that we have an attribute table */
<span class="nc" id="L422">        ensureAttrTable();</span>

        /* Format the attribute */
<span class="nc" id="L425">        theBuilder.startRow(theAttrTable);</span>
<span class="nc" id="L426">        theBuilder.makeValueCell(theAttrTable, pAttr);</span>
<span class="nc" id="L427">        theBuilder.makeValueCell(theAttrTable, formatSubtraction(pFirst, pSecond));</span>
<span class="nc" id="L428">        theBuilder.makeValueCell(theAttrTable, pValue);</span>
<span class="nc" id="L429">    }</span>

    /**
     * Format a subtraction.
     * @param pFirst the first item
     * @param pSecond the second item
     * @return the formatted subtraction
     */
    private String formatSubtraction(final OceanusDecimal pFirst,
                                     final OceanusDecimal pSecond) {
<span class="nc" id="L439">        return formatCombination(pFirst, pSecond, '-');</span>
    }

    /**
     * Format a combination.
     * @param pFirst the first item
     * @param pSecond the second item
     * @param pSymbol the symbol
     * @return the formatted combination
     */
    private String formatCombination(final OceanusDecimal pFirst,
                                     final OceanusDecimal pSecond,
                                     final char pSymbol) {
<span class="nc" id="L452">        theStringBuilder.setLength(0);</span>
<span class="nc" id="L453">        theStringBuilder.append(theFormatter.formatObject(pFirst));</span>
<span class="nc" id="L454">        theStringBuilder.append(pSymbol);</span>
<span class="nc" id="L455">        theStringBuilder.append(theFormatter.formatObject(pSecond));</span>
<span class="nc" id="L456">        return theStringBuilder.toString();</span>
    }

    /**
     * Format a Transfer.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatTransfer(final MoneyWiseTransaction pTrans,
                                final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L467">        formatBasicTransaction(pTrans);</span>

        /* Split workings for transfer in/out */
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (isDebit(pTrans)) {</span>
<span class="nc" id="L471">            formatTransferOut(pTrans, pValues);</span>
        } else {
<span class="nc" id="L473">            formatTransferIn(pTrans, pValues);</span>
        }
<span class="nc" id="L475">    }</span>

    /**
     * Format a Dividend.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatDividend(final MoneyWiseTransaction pTrans,
                                final MoneyWiseAnalysisSecurityValues pValues) {
        /* If this is a dividend re-investment */
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (isCredit(pTrans)) {</span>
            /* Format the basic transaction */
<span class="nc" id="L487">            formatBasicTransaction(pTrans);</span>

            /* Deal as investment */
<span class="nc" id="L490">            formatTransferIn(pTrans, pValues);</span>
        }
<span class="nc" id="L492">    }</span>

    /**
     * Format transfer money in.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatTransferIn(final MoneyWiseTransaction pTrans,
                                  final MoneyWiseAnalysisSecurityValues pValues) {

        /* Access interesting values */
<span class="nc" id="L503">        final OceanusUnits myUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L504">        OceanusUnits myDeltaUnits = pTrans.getAccountDeltaUnits();</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (myDeltaUnits == null) {</span>
<span class="nc" id="L506">            myDeltaUnits = pTrans.getPartnerDeltaUnits();</span>
        }
<span class="nc" id="L508">        final OceanusMoney myCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L509">        final OceanusMoney myAmount = theSecurity.getMoneyDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L510">        final OceanusPrice myPrice = pValues.getPriceValue(MoneyWiseAnalysisSecurityAttr.PRICE);</span>
<span class="nc" id="L511">        final OceanusRatio myXchangeRate = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE);</span>

        /* Obtain the original units/cost */
<span class="nc" id="L514">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L515">        final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L516">        final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>

        /* If this is an inheritance */
<span class="nc bnc" id="L519" title="All 2 branches missed.">        if (pTrans.isCategoryClass(MoneyWiseTransCategoryClass.INHERITED)) {</span>
<span class="nc" id="L520">            formatValuation(MoneyWiseAnalysisSecurityAttr.INVESTED, myAmount, myDeltaUnits, myPrice, myXchangeRate);</span>
        } else {
<span class="nc" id="L522">            formatValue(MoneyWiseAnalysisSecurityAttr.INVESTED, myAmount);</span>
        }

        /* Record the details */
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (myDeltaUnits != null) {</span>
<span class="nc" id="L527">            formatAddition(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>
        }
<span class="nc" id="L529">        formatAddition(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost, myOriginalCost, myAmount);</span>
<span class="nc" id="L530">    }</span>

    /**
     * Format transfer money out.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatTransferOut(final MoneyWiseTransaction pTrans,
                                   final MoneyWiseAnalysisSecurityValues pValues) {
        /* Access interesting values */
<span class="nc" id="L540">        final OceanusMoney myGain = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN);</span>
<span class="nc" id="L541">        final OceanusMoney myAllowedCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST);</span>
<span class="nc" id="L542">        final OceanusRatio myCostDilution = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION);</span>
<span class="nc" id="L543">        final OceanusMoney myTotalGains = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS);</span>
<span class="nc" id="L544">        final OceanusMoney myCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L545">        final OceanusUnits myUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L546">        final OceanusMoney myCash = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH);</span>
<span class="nc" id="L547">        final OceanusMoney myConsideration = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.CONSIDERATION);</span>
<span class="nc" id="L548">        final MoneyWiseCashType myCashType = pValues.getEnumValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, MoneyWiseCashType.class);</span>

        /* Obtain the original values */
<span class="nc" id="L551">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L552">        final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L553">        final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>

        /* Obtain the delta in units/money */
<span class="nc" id="L556">        OceanusUnits myDeltaUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L557">        final OceanusMoney myAmount = new OceanusMoney(myCash);</span>
<span class="nc" id="L558">        myAmount.negate();</span>

        /* Report the returned cash */
<span class="nc" id="L561">        formatValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH, myCash);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">        if (myCashType != null) {</span>
<span class="nc" id="L563">            formatValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, myCashType);</span>
        }

        /* If we have changed the number of units */
<span class="nc bnc" id="L567" title="All 2 branches missed.">        if (myDeltaUnits.isNonZero()) {</span>
            /* Obtain the various values */
<span class="nc" id="L569">            myDeltaUnits = new OceanusUnits(myDeltaUnits);</span>
<span class="nc" id="L570">            myDeltaUnits.negate();</span>

            /* Format the units */
<span class="nc" id="L573">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>

            /* Format the dilution */
<span class="nc" id="L576">            formatDivision(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution, myUnits, myOriginalUnits);</span>

            /* Else we need to format the cost dilution */
<span class="nc bnc" id="L579" title="All 2 branches missed.">        } else if (myConsideration != null) {</span>
            /* Format the valuation */
<span class="nc" id="L581">            final OceanusMoney myValuation = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.VALUATION);</span>
<span class="nc" id="L582">            final OceanusPrice myPrice = pValues.getPriceValue(MoneyWiseAnalysisSecurityAttr.PRICE);</span>
<span class="nc" id="L583">            final OceanusRatio myXchangeRate = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE);</span>
<span class="nc" id="L584">            formatValuation(MoneyWiseAnalysisSecurityAttr.VALUATION, myValuation, myUnits, myPrice, myXchangeRate);</span>
<span class="nc" id="L585">            formatAddition(MoneyWiseAnalysisSecurityAttr.CONSIDERATION, myConsideration, myCash, myValuation);</span>

            /* Format the dilution */
<span class="nc" id="L588">            formatDivision(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution, myValuation, myConsideration);</span>
        }

        /* Record the details */
<span class="nc bnc" id="L592" title="All 2 branches missed.">        if (myCostDilution != null) {</span>
<span class="nc" id="L593">            formatMultiplication(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost, myOriginalCost, myCostDilution);</span>
<span class="nc" id="L594">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost, myOriginalCost, myCost);</span>
        } else {
<span class="nc" id="L596">            formatValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost);</span>
<span class="nc" id="L597">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost, myOriginalCost, myAllowedCost);</span>
        }

        /* Record the gains allocation */
<span class="nc bnc" id="L601" title="All 2 branches missed.">        if (myGain != null) {</span>
<span class="nc" id="L602">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN, myGain, myCash, myAllowedCost);</span>
<span class="nc" id="L603">            formatValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myTotalGains);</span>
        }
<span class="nc" id="L605">    }</span>

    /**
     * Format a Units Adjustment.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatUnitsAdjust(final MoneyWiseTransaction pTrans,
                                   final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L615">        formatBasicTransaction(pTrans);</span>

        /* Access interesting values */
<span class="nc" id="L618">        final OceanusUnits myUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L619">        OceanusUnits myDeltaUnits = pTrans.getAccountDeltaUnits();</span>

        /* Obtain the original units */
<span class="nc" id="L622">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L623">        final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>

        /* Record the details */
<span class="nc bnc" id="L626" title="All 2 branches missed.">        if (myDeltaUnits.isPositive()) {</span>
<span class="nc" id="L627">            formatAddition(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>
        } else {
<span class="nc" id="L629">            myDeltaUnits = new OceanusUnits(myDeltaUnits);</span>
<span class="nc" id="L630">            myDeltaUnits.negate();</span>
<span class="nc" id="L631">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>
        }
<span class="nc" id="L633">    }</span>

    /**
     * Format a Stock DeMerger.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatStockDeMerger(final MoneyWiseTransaction pTrans,
                                     final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L643">        formatBasicTransaction(pTrans);</span>

        /* Split workings for credit and debit */
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (isDebit(pTrans)) {</span>
<span class="nc" id="L647">            formatDebitStockDeMerger(pTrans, pValues);</span>
        } else {
<span class="nc" id="L649">            formatCreditStockDeMerger(pTrans, pValues);</span>
        }
<span class="nc" id="L651">    }</span>

    /**
     * Format debit side of a Stock DeMerger.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatDebitStockDeMerger(final MoneyWiseTransaction pTrans,
                                          final MoneyWiseAnalysisSecurityValues pValues) {
        /* Access interesting values */
<span class="nc" id="L661">        final OceanusRatio myCostDilution = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION);</span>
<span class="nc" id="L662">        final OceanusMoney myResidualCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L663">        final OceanusMoney myXferredCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L664">        OceanusUnits myDeltaUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>

        /* Check whether the units have changed */
<span class="nc" id="L667">        final boolean isDeltaUnits = myDeltaUnits.isNonZero();</span>

        /* Obtain the original cost */
<span class="nc" id="L670">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L671">        final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>

        /* If we have changed the number of units */
<span class="nc bnc" id="L674" title="All 2 branches missed.">        if (isDeltaUnits) {</span>
            /* Obtain the various values */
<span class="nc" id="L676">            final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L677">            final OceanusUnits myUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L678">            myDeltaUnits = new OceanusUnits(myDeltaUnits);</span>
<span class="nc" id="L679">            myDeltaUnits.negate();</span>

            /* Format the units/dilution */
<span class="nc" id="L682">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits, myOriginalUnits, myDeltaUnits);</span>
<span class="nc" id="L683">            formatDivision(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution, myUnits, myOriginalUnits);</span>

            /* else just report the dilution */
<span class="nc" id="L686">        } else {</span>
<span class="nc" id="L687">            formatValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution);</span>
        }

        /* Record the details */
<span class="nc" id="L691">        formatMultiplication(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myResidualCost, myOriginalCost, myCostDilution);</span>
<span class="nc" id="L692">        formatSubtraction(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myXferredCost, myOriginalCost, myResidualCost);</span>
<span class="nc" id="L693">    }</span>

    /**
     * Format credit side of a Stock DeMerger.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatCreditStockDeMerger(final MoneyWiseTransaction pTrans,
                                           final MoneyWiseAnalysisSecurityValues pValues) {
        /* Access interesting values */
<span class="nc" id="L703">        final OceanusMoney myResidualCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L704">        final OceanusMoney myXferredCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L705">        final OceanusMoney myValueXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE);</span>
<span class="nc" id="L706">        final OceanusUnits myUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L707">        final OceanusPrice myPrice = pValues.getPriceValue(MoneyWiseAnalysisSecurityAttr.PRICE);</span>
<span class="nc" id="L708">        final OceanusRatio myXchangeRate = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE);</span>

        /* Record the details */
<span class="nc" id="L711">        formatValuation(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myValueXfer, myUnits, myPrice, myXchangeRate);</span>
<span class="nc" id="L712">        formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myXferredCost);</span>
<span class="nc" id="L713">        formatValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myResidualCost);</span>
<span class="nc" id="L714">    }</span>

    /**
     * Format a Stock TakeOver.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatStockTakeOver(final MoneyWiseTransaction pTrans,
                                     final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L724">        formatBasicTransaction(pTrans);</span>

        /* Split out Stock and Cash TakeOver */
<span class="nc" id="L727">        final OceanusMoney myCash = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH);</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">        if (myCash != null) {</span>
<span class="nc" id="L729">            formatStockAndCashTakeOver(pTrans, pValues, myCash);</span>

            /* Split workings for credit and debit */
<span class="nc bnc" id="L732" title="All 2 branches missed.">        } else if (isDebit(pTrans)) {</span>
            /* Record the transfer of cost for simple replacement takeOver */
<span class="nc" id="L734">            final OceanusMoney myCostXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L735">            formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer);</span>
<span class="nc" id="L736">        } else {</span>
<span class="nc" id="L737">            formatCreditStockTakeOver(pTrans, pValues);</span>
        }
<span class="nc" id="L739">    }</span>

    /**
     * Format a StockAndCash TakeOver.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     * @param pCash the cash consideration
     */
    private void formatStockAndCashTakeOver(final MoneyWiseTransaction pTrans,
                                            final MoneyWiseAnalysisSecurityValues pValues,
                                            final OceanusMoney pCash) {
        /* Split workings for credit and debit */
<span class="nc bnc" id="L751" title="All 2 branches missed.">        if (isDebit(pTrans)) {</span>
<span class="nc" id="L752">            formatDebitStockAndCashTakeOver(pTrans, pValues, pCash);</span>
        } else {
<span class="nc" id="L754">            formatCreditStockTakeOver(pTrans, pValues);</span>
        }
<span class="nc" id="L756">    }</span>

    /**
     * Format debit side of a StockAndCash TakeOver.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     * @param pCash the cash consideration
     */
    private void formatDebitStockAndCashTakeOver(final MoneyWiseTransaction pTrans,
                                                 final MoneyWiseAnalysisSecurityValues pValues,
                                                 final OceanusMoney pCash) {
        /* Access interesting values */
<span class="nc" id="L768">        final OceanusMoney myStock = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE);</span>
<span class="nc" id="L769">        final OceanusMoney myConsideration = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.CONSIDERATION);</span>
<span class="nc" id="L770">        final OceanusMoney myCostXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L771">        final OceanusRatio myCostDilution = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION);</span>
<span class="nc" id="L772">        final OceanusMoney myAllowedCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST);</span>
<span class="nc" id="L773">        final OceanusMoney myGain = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN);</span>
<span class="nc" id="L774">        final OceanusMoney myTotalGains = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS);</span>
<span class="nc" id="L775">        final MoneyWiseCashType myCashType = pValues.getEnumValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, MoneyWiseCashType.class);</span>

        /* Record the calculation of total consideration */
<span class="nc" id="L778">        formatValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH, pCash);</span>
<span class="nc" id="L779">        formatValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, myCashType);</span>
<span class="nc" id="L780">        formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myStock);</span>
<span class="nc" id="L781">        formatAddition(MoneyWiseAnalysisSecurityAttr.CONSIDERATION, myConsideration, pCash, myStock);</span>

        /* Obtain the original cost */
<span class="nc" id="L784">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L785">        final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>

        /* Format the cost dilution */
<span class="nc bnc" id="L788" title="All 2 branches missed.">        if (myCostDilution != null) {</span>
<span class="nc" id="L789">            formatDivision(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution, pCash, myConsideration);</span>
<span class="nc" id="L790">            formatMultiplication(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost, myOriginalCost, myCostDilution);</span>
        } else {
<span class="nc" id="L792">            formatValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost);</span>
        }
<span class="nc" id="L794">        formatSubtraction(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer, myOriginalCost, myAllowedCost);</span>

        /* Record the gains allocation */
<span class="nc bnc" id="L797" title="All 2 branches missed.">        if (myGain != null) {</span>
<span class="nc" id="L798">            formatSubtraction(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN, myGain, pCash, myAllowedCost);</span>
<span class="nc" id="L799">            formatValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myTotalGains);</span>
        }
<span class="nc" id="L801">    }</span>

    /**
     * Format credit side of a StockAndCash TakeOver.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatCreditStockTakeOver(final MoneyWiseTransaction pTrans,
                                           final MoneyWiseAnalysisSecurityValues pValues) {
        /* Access interesting values */
<span class="nc" id="L811">        final OceanusPrice myPrice = pValues.getPriceValue(MoneyWiseAnalysisSecurityAttr.PRICE);</span>
<span class="nc" id="L812">        final OceanusUnits myUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L813">        final OceanusMoney myValueXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE);</span>
<span class="nc" id="L814">        final OceanusMoney myCostXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L815">        final OceanusMoney myResidualCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L816">        final OceanusRatio myXchangeRate = pValues.getRatioValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE);</span>

        /* Detail the new units and cost */
<span class="nc" id="L819">        final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L820">        final OceanusUnits myNewUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L821">        final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L822">        formatAddition(MoneyWiseAnalysisSecurityAttr.UNITS, myNewUnits, myOriginalUnits, myUnits);</span>

        /* Record the transfer of value and cost */
<span class="nc" id="L825">        formatValuation(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myValueXfer, myUnits, myPrice, myXchangeRate);</span>
<span class="nc" id="L826">        formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer);</span>
<span class="nc" id="L827">        formatValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myResidualCost);</span>
<span class="nc" id="L828">    }</span>

    /**
     * Format a Stock DeMerger.
     * @param pTrans the transaction
     * @param pValues the values for the transaction
     */
    private void formatPortfolioXfer(final MoneyWiseTransaction pTrans,
                                     final MoneyWiseAnalysisSecurityValues pValues) {
        /* Format the basic transaction */
<span class="nc" id="L838">        formatBasicTransaction(pTrans);</span>

        /* Determine the direction of transfer */
<span class="nc" id="L841">        final OceanusMoney myCostXfer = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST);</span>
<span class="nc" id="L842">        formatValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer);</span>

<span class="nc" id="L844">        final OceanusUnits myUnits = theSecurity.getUnitsDeltaForTransaction(pTrans, MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">        if (myUnits.isPositive()) {</span>
            /* Detail the new units and cost */
<span class="nc" id="L847">            final MoneyWiseAnalysisSecurityValues myPreviousValues = theSecurity.getPreviousValuesForTransaction(pTrans);</span>
<span class="nc" id="L848">            final OceanusUnits myNewUnits = pValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L849">            final OceanusUnits myOriginalUnits = myPreviousValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L850">            formatAddition(MoneyWiseAnalysisSecurityAttr.UNITS, myNewUnits, myOriginalUnits, myUnits);</span>
<span class="nc" id="L851">            final OceanusMoney myCost = pValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L852">            final OceanusMoney myOriginalCost = myPreviousValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L853">            formatAddition(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost, myOriginalCost, myCostXfer);</span>
        }
<span class="nc" id="L855">    }</span>

    @Override
    public MoneyWiseAnalysisFilter&lt;?, ?&gt; processFilter(final Object pSource) {
<span class="nc" id="L859">        return null;</span>
    }

    @Override
    public MetisHTMLTable createDelayedTable(final DelayedTable pTable) {
<span class="nc" id="L864">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>