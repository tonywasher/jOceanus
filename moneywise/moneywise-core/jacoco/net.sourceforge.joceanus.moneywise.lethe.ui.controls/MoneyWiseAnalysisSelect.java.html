<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseAnalysisSelect.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.lethe.ui.controls</a> &gt; <span class="el_source">MoneyWiseAnalysisSelect.java</span></div><h1>MoneyWiseAnalysisSelect.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.lethe.ui.controls;

import java.util.EnumMap;
import java.util.Map;
import java.util.Map.Entry;

import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.metis.ui.MetisIcon;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.base.MoneyWiseAnalysisAttribute;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysis;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisType;
import net.sourceforge.joceanus.moneywise.ui.MoneyWiseAnalysisColumnSet;
import net.sourceforge.joceanus.moneywise.ui.MoneyWiseUIResource;
import net.sourceforge.joceanus.moneywise.lethe.views.MoneyWiseAnalysisFilter;
import net.sourceforge.joceanus.moneywise.lethe.views.MoneyWiseAnalysisFilter.MoneyWiseAnalysisAllFilter;
import net.sourceforge.joceanus.moneywise.lethe.views.MoneyWiseAnalysisView;
import net.sourceforge.joceanus.moneywise.views.MoneyWiseView;
import net.sourceforge.joceanus.prometheus.views.PrometheusDataEvent;
import net.sourceforge.joceanus.oceanus.date.OceanusDateRange;
import net.sourceforge.joceanus.oceanus.date.OceanusDateResource;
import net.sourceforge.joceanus.oceanus.event.OceanusEventManager;
import net.sourceforge.joceanus.oceanus.event.OceanusEventRegistrar;
import net.sourceforge.joceanus.oceanus.event.OceanusEventRegistrar.OceanusEventProvider;
import net.sourceforge.joceanus.tethys.api.base.TethysUIArrowIconId;
import net.sourceforge.joceanus.tethys.api.base.TethysUIComponent;
import net.sourceforge.joceanus.tethys.api.base.TethysUIEvent;
import net.sourceforge.joceanus.tethys.api.button.TethysUIButton;
import net.sourceforge.joceanus.tethys.api.button.TethysUIButtonFactory;
import net.sourceforge.joceanus.tethys.api.button.TethysUIDateRangeSelector;
import net.sourceforge.joceanus.tethys.api.button.TethysUIScrollButtonManager;
import net.sourceforge.joceanus.tethys.api.control.TethysUIControlFactory;
import net.sourceforge.joceanus.tethys.api.control.TethysUILabel;
import net.sourceforge.joceanus.tethys.api.factory.TethysUIFactory;
import net.sourceforge.joceanus.tethys.api.menu.TethysUIScrollMenu;
import net.sourceforge.joceanus.tethys.api.pane.TethysUIBoxPaneManager;
import net.sourceforge.joceanus.tethys.api.pane.TethysUICardPaneManager;
import net.sourceforge.joceanus.tethys.api.pane.TethysUIPaneFactory;

/**
 * Selection panel for Analysis Statement.
 */
public class MoneyWiseAnalysisSelect
        implements OceanusEventProvider&lt;PrometheusDataEvent&gt;, TethysUIComponent {
    /**
     * Text for DateRange Label.
     */
<span class="nc" id="L63">    private static final String NLS_RANGE = MoneyWiseUIResource.ANALYSIS_PROMPT_RANGE.getValue();</span>

    /**
     * Text for Filter Label.
     */
<span class="nc" id="L68">    private static final String NLS_FILTER = MoneyWiseUIResource.ANALYSIS_PROMPT_FILTER.getValue();</span>

    /**
     * Text for FilterType Label.
     */
<span class="nc" id="L73">    private static final String NLS_FILTERTYPE = MoneyWiseUIResource.ANALYSIS_PROMPT_FILTERTYPE.getValue();</span>

    /**
     * Text for ColumnSet Label.
     */
<span class="nc" id="L78">    private static final String NLS_COLUMNS = MoneyWiseUIResource.ANALYSIS_PROMPT_COLUMNSET.getValue();</span>

    /**
     * Text for BucketType Label.
     */
<span class="nc" id="L83">    private static final String NLS_BUCKET = MoneyWiseUIResource.ANALYSIS_PROMPT_BUCKET.getValue();</span>

    /**
     * Text for Title.
     */
<span class="nc" id="L88">    private static final String NLS_TITLE = MoneyWiseUIResource.ANALYSIS_TITLE.getValue();</span>

    /**
     * Text for NoBucket.
     */
<span class="nc" id="L93">    private static final String NLS_NONE = MoneyWiseUIResource.ANALYSIS_BUCKET_NONE.getValue();</span>

    /**
     * Text for Title.
     */
<span class="nc" id="L98">    private static final String NLS_FILTERTITLE = MoneyWiseUIResource.ANALYSIS_FILTER_TITLE.getValue();</span>

    /**
     * Text for Box Title.
     */
<span class="nc" id="L103">    private static final String NLS_RANGETITLE = OceanusDateResource.TITLE_BOX.getValue();</span>

    /**
     * The Event Manager.
     */
    private final OceanusEventManager&lt;PrometheusDataEvent&gt; theEventManager;

    /**
     * View.
     */
    private final MoneyWiseView theView;

    /**
     * Panel.
     */
    private final TethysUIBoxPaneManager thePanel;

    /**
     * Range Button.
     */
    private final TethysUIButton theRangeButton;

    /**
     * Filter Button.
     */
    private final TethysUIButton theFilterButton;

    /**
     * Filter Type Button.
     */
    private final TethysUIScrollButtonManager&lt;MoneyWiseAnalysisType&gt; theFilterTypeButton;

    /**
     * Bucket Type Button.
     */
    private final TethysUIScrollButtonManager&lt;MoneyWiseAnalysisAttribute&gt; theBucketButton;

    /**
     * ColumnSet Button.
     */
    private final TethysUIScrollButtonManager&lt;MoneyWiseAnalysisColumnSet&gt; theColumnButton;

    /**
     * The bucket label.
     */
    private final TethysUILabel theBucketLabel;

    /**
     * The column label.
     */
    private final TethysUILabel theColumnLabel;

    /**
     * The filter detail panel.
     */
    private final TethysUIBoxPaneManager theFilterDetail;

    /**
     * DateRange Select Panel.
     */
    private final TethysUIDateRangeSelector theRangeSelect;

    /**
     * Filter Select Panel.
     */
    private final TethysUIBoxPaneManager theFilterSelect;

    /**
     * Deposit Select Panel.
     */
    private final MoneyWiseDepositAnalysisSelect theDepositSelect;

    /**
     * Cash Select Panel.
     */
    private final MoneyWiseCashAnalysisSelect theCashSelect;

    /**
     * Loan Select Panel.
     */
    private final MoneyWiseLoanAnalysisSelect theLoanSelect;

    /**
     * Security Select Panel.
     */
    private final MoneyWiseSecurityAnalysisSelect theSecuritySelect;

    /**
     * Portfolio Select Panel.
     */
    private final MoneyWisePortfolioAnalysisSelect thePortfolioSelect;

    /**
     * Payee Select Panel.
     */
    private final MoneyWisePayeeAnalysisSelect thePayeeSelect;

    /**
     * TransCategory Select Panel.
     */
    private final MoneyWiseTransCategoryAnalysisSelect theCategorySelect;

    /**
     * TaxBasis Select Panel.
     */
    private final MoneyWiseTaxBasisAnalysisSelect theTaxBasisSelect;

    /**
     * TransactionTag Select Panel.
     */
    private final MoneyWiseTransTagSelect theTagSelect;

    /**
     * All Select Panel.
     */
    private final MoneyWiseAllSelect theAllSelect;

    /**
     * The card panel.
     */
    private final TethysUICardPaneManager&lt;MoneyWiseAnalysisFilterSelection&gt; theCardPanel;

    /**
     * The analysis view.
     */
    private final MoneyWiseAnalysisView theAnalysisView;

    /**
     * Select panel map.
     */
    private final Map&lt;MoneyWiseAnalysisType, MoneyWiseAnalysisFilterSelection&gt; theMap;

    /**
     * AnalysisType menu.
     */
    private final TethysUIScrollMenu&lt;MoneyWiseAnalysisType&gt; theTypeMenu;

    /**
     * Bucket menu.
     */
    private final TethysUIScrollMenu&lt;MoneyWiseAnalysisAttribute&gt; theBucketMenu;

    /**
     * Column menu.
     */
    private final TethysUIScrollMenu&lt;MoneyWiseAnalysisColumnSet&gt; theColumnMenu;

    /**
     * Analysis.
     */
    private MoneyWiseAnalysis theAnalysis;

    /**
     * Analysis State.
     */
    private MoneyWiseAnalysisState theState;

    /**
     * The savePoint.
     */
    private MoneyWiseAnalysisState theSavePoint;

    /**
     * Is the control refreshing?
     */
    private boolean isRefreshing;

    /**
     * Is the range visible?
     */
    private boolean isRangeVisible;

    /**
     * Is the filter visible?
     */
    private boolean isFilterVisible;

    /**
     * Constructor.
     * @param pFactory the GUI factory
     * @param pView the view
     * @param pAnalysisView the analysis view
     * @param pNewButton the new button
     */
    public MoneyWiseAnalysisSelect(final TethysUIFactory&lt;?&gt; pFactory,
                                   final MoneyWiseView pView,
                                   final MoneyWiseAnalysisView pAnalysisView,
<span class="nc" id="L290">                                   final TethysUIButton pNewButton) {</span>
        /* Access the analysis manager */
<span class="nc" id="L292">        theView = pView;</span>
<span class="nc" id="L293">        theAnalysisView = pAnalysisView;</span>

        /* Create Event Manager */
<span class="nc" id="L296">        theEventManager = new OceanusEventManager&lt;&gt;();</span>

        /* Create the range button */
<span class="nc" id="L299">        final TethysUIButtonFactory&lt;?&gt; myButtons = pFactory.buttonFactory();</span>
<span class="nc" id="L300">        theRangeButton = myButtons.newButton();</span>
<span class="nc" id="L301">        theRangeButton.setIcon(TethysUIArrowIconId.DOWN);</span>
<span class="nc" id="L302">        theRangeButton.setTextAndIcon();</span>

        /* Create the filter button */
<span class="nc" id="L305">        theFilterButton = myButtons.newButton();</span>
<span class="nc" id="L306">        theFilterButton.setIcon(TethysUIArrowIconId.DOWN);</span>
<span class="nc" id="L307">        theFilterButton.setTextAndIcon();</span>

        /* Create the filter type button */
<span class="nc" id="L310">        theFilterTypeButton = myButtons.newScrollButton(MoneyWiseAnalysisType.class);</span>

        /* Create the columnSet button */
<span class="nc" id="L313">        final TethysUIControlFactory myControls = pFactory.controlFactory();</span>
<span class="nc" id="L314">        theColumnLabel = myControls.newLabel(NLS_COLUMNS);</span>
<span class="nc" id="L315">        theColumnButton = myButtons.newScrollButton(MoneyWiseAnalysisColumnSet.class);</span>

        /* Create the bucket button */
<span class="nc" id="L318">        theBucketLabel = myControls.newLabel(NLS_BUCKET);</span>
<span class="nc" id="L319">        theBucketButton = myButtons.newScrollButton(MoneyWiseAnalysisAttribute.class);</span>

        /* Create the Range Select panel */
<span class="nc" id="L322">        theRangeSelect = myButtons.newDateRangeSelector();</span>
<span class="nc" id="L323">        theRangeSelect.setBorderTitle(NLS_RANGETITLE);</span>

        /* Create the panel map */
<span class="nc" id="L326">        theMap = new EnumMap&lt;&gt;(MoneyWiseAnalysisType.class);</span>

        /* Create the filter selection panels */
<span class="nc" id="L329">        theDepositSelect = new MoneyWiseDepositAnalysisSelect(pFactory);</span>
<span class="nc" id="L330">        theCashSelect = new MoneyWiseCashAnalysisSelect(pFactory);</span>
<span class="nc" id="L331">        theLoanSelect = new MoneyWiseLoanAnalysisSelect(pFactory);</span>
<span class="nc" id="L332">        theSecuritySelect = new MoneyWiseSecurityAnalysisSelect(pFactory);</span>
<span class="nc" id="L333">        thePortfolioSelect = new MoneyWisePortfolioAnalysisSelect(pFactory);</span>
<span class="nc" id="L334">        thePayeeSelect = new MoneyWisePayeeAnalysisSelect(pFactory);</span>
<span class="nc" id="L335">        theCategorySelect = new MoneyWiseTransCategoryAnalysisSelect(pFactory);</span>
<span class="nc" id="L336">        theTaxBasisSelect = new MoneyWiseTaxBasisAnalysisSelect(pFactory);</span>
<span class="nc" id="L337">        theTagSelect = new MoneyWiseTransTagSelect(pFactory);</span>
<span class="nc" id="L338">        theAllSelect = new MoneyWiseAllSelect(pFactory);</span>

        /* Create the card panel */
<span class="nc" id="L341">        final TethysUIPaneFactory myPanes = pFactory.paneFactory();</span>
<span class="nc" id="L342">        theCardPanel = myPanes.newCardPane();</span>

        /* Create the filter detail panel */
<span class="nc" id="L345">        theFilterDetail = buildFilterDetail(pFactory);</span>

        /* Create the filter selection panel */
<span class="nc" id="L348">        theFilterSelect = buildFilterSelect(pFactory);</span>

        /* Create the control panel */
<span class="nc" id="L351">        final TethysUIBoxPaneManager myPanel = buildControlPanel(pFactory, pNewButton);</span>

        /* Create the panel */
<span class="nc" id="L354">        thePanel = myPanes.newVBoxPane();</span>
<span class="nc" id="L355">        thePanel.addNode(myPanel);</span>
<span class="nc" id="L356">        thePanel.addNode(theRangeSelect);</span>
<span class="nc" id="L357">        thePanel.addNode(theFilterSelect);</span>

        /* Initially hide the select boxes */
<span class="nc" id="L360">        theRangeSelect.setVisible(false);</span>
<span class="nc" id="L361">        theFilterSelect.setVisible(false);</span>

        /* Create initial state */
<span class="nc" id="L364">        theState = new MoneyWiseAnalysisState();</span>
<span class="nc" id="L365">        theState.showColumns(true);</span>
<span class="nc" id="L366">        final MoneyWiseStatementSelect mySelect = new MoneyWiseStatementSelect(theRangeSelect, new MoneyWiseAnalysisAllFilter());</span>
<span class="nc" id="L367">        selectStatement(mySelect);</span>

        /* Access the menus */
<span class="nc" id="L370">        theTypeMenu = theFilterTypeButton.getMenu();</span>
<span class="nc" id="L371">        theBucketMenu = theBucketButton.getMenu();</span>
<span class="nc" id="L372">        theColumnMenu = theColumnButton.getMenu();</span>

        /* Create the listeners */
<span class="nc" id="L375">        OceanusEventRegistrar&lt;TethysUIEvent&gt; myRegistrar = theFilterTypeButton.getEventRegistrar();</span>
<span class="nc" id="L376">        myRegistrar.addEventListener(TethysUIEvent.NEWVALUE, e -&gt; handleFilterType());</span>
<span class="nc" id="L377">        theFilterTypeButton.setMenuConfigurator(e -&gt; buildAnalysisTypeMenu());</span>
<span class="nc" id="L378">        myRegistrar = theBucketButton.getEventRegistrar();</span>
<span class="nc" id="L379">        myRegistrar.addEventListener(TethysUIEvent.NEWVALUE, e -&gt; handleNewBucket());</span>
<span class="nc" id="L380">        theBucketButton.setMenuConfigurator(e -&gt; buildBucketMenu());</span>
<span class="nc" id="L381">        myRegistrar = theColumnButton.getEventRegistrar();</span>
<span class="nc" id="L382">        myRegistrar.addEventListener(TethysUIEvent.NEWVALUE, e -&gt; handleNewColumns());</span>
<span class="nc" id="L383">        theColumnButton.setMenuConfigurator(e -&gt; buildColumnsMenu());</span>
<span class="nc" id="L384">        theAnalysisView.getEventRegistrar().addEventListener(e -&gt; setAnalysisView());</span>

        /* Handle buttons */
<span class="nc bnc" id="L387" title="All 2 branches missed.">        theRangeButton.getEventRegistrar().addEventListener(e -&gt; setRangeVisibility(!isRangeVisible));</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">        theFilterButton.getEventRegistrar().addEventListener(e -&gt; setFilterVisibility(!isFilterVisible));</span>
<span class="nc" id="L389">        theRangeSelect.getEventRegistrar().addEventListener(TethysUIEvent.NEWVALUE, e -&gt; handleNewRange());</span>

        /* handle sub-selections */
<span class="nc" id="L392">        theDepositSelect.getEventRegistrar().addEventListener(e -&gt; buildDepositFilter());</span>
<span class="nc" id="L393">        theCashSelect.getEventRegistrar().addEventListener(e -&gt; buildCashFilter());</span>
<span class="nc" id="L394">        theLoanSelect.getEventRegistrar().addEventListener(e -&gt; buildLoanFilter());</span>
<span class="nc" id="L395">        theSecuritySelect.getEventRegistrar().addEventListener(e -&gt; buildSecurityFilter());</span>
<span class="nc" id="L396">        thePortfolioSelect.getEventRegistrar().addEventListener(e -&gt; buildPortfolioFilter());</span>
<span class="nc" id="L397">        thePayeeSelect.getEventRegistrar().addEventListener(e -&gt; buildPayeeFilter());</span>
<span class="nc" id="L398">        theCategorySelect.getEventRegistrar().addEventListener(e -&gt; buildCategoryFilter());</span>
<span class="nc" id="L399">        theTaxBasisSelect.getEventRegistrar().addEventListener(e -&gt; buildTaxBasisFilter());</span>
<span class="nc" id="L400">        theTagSelect.getEventRegistrar().addEventListener(e -&gt; buildTagFilter());</span>
<span class="nc" id="L401">    }</span>

    @Override
    public TethysUIComponent getUnderlying() {
<span class="nc" id="L405">        return thePanel;</span>
    }

    @Override
    public OceanusEventRegistrar&lt;PrometheusDataEvent&gt; getEventRegistrar() {
<span class="nc" id="L410">        return theEventManager.getEventRegistrar();</span>
    }

    /**
     * Obtain the DateDayRange.
     * @return the range.
     */
    public OceanusDateRange getRange() {
<span class="nc" id="L418">        return theState.getRange();</span>
    }

    /**
     * Obtain the analysis.
     * @return the range.
     */
    public MoneyWiseAnalysis getAnalysis() {
<span class="nc" id="L426">        return theAnalysis;</span>
    }

    /**
     * Obtain the Filter.
     * @return the filter.
     */
    public MoneyWiseAnalysisFilter&lt;?, ?&gt; getFilter() {
<span class="nc" id="L434">        return theState.getFilter();</span>
    }

    /**
     * Obtain the ColumnSet.
     * @return the columnSet.
     */
    public MoneyWiseAnalysisColumnSet getColumns() {
<span class="nc" id="L442">        return theState.getColumns();</span>
    }

    /**
     * Are we showing columns?
     * @return true/false.
     */
    public boolean showColumns() {
<span class="nc" id="L450">        return theState.showColumns();</span>
    }

    /**
     * Create control panel.
     * @param pFactory the GUI factory
     * @param pNewButton the new button
     * @return the panel
     */
    private TethysUIBoxPaneManager buildControlPanel(final TethysUIFactory&lt;?&gt; pFactory,
                                                     final TethysUIButton pNewButton) {
        /* Create the control panel */
<span class="nc" id="L462">        final TethysUIBoxPaneManager myPanel = pFactory.paneFactory().newHBoxPane();</span>

        /* Create the labels */
<span class="nc" id="L465">        final TethysUILabel myRangeLabel = pFactory.controlFactory().newLabel(NLS_RANGE);</span>

        /* Create save button */
<span class="nc" id="L468">        final TethysUIButton mySave = pFactory.buttonFactory().newButton();</span>
<span class="nc" id="L469">        MetisIcon.configureSaveIconButton(mySave);</span>

        /* Create the panel */
<span class="nc" id="L472">        myPanel.setBorderTitle(NLS_TITLE);</span>
<span class="nc" id="L473">        myPanel.addNode(myRangeLabel);</span>
<span class="nc" id="L474">        myPanel.addNode(theRangeButton);</span>
<span class="nc" id="L475">        myPanel.addSpacer();</span>
<span class="nc" id="L476">        myPanel.addNode(theFilterDetail);</span>
<span class="nc" id="L477">        myPanel.addSpacer();</span>
<span class="nc" id="L478">        myPanel.addNode(mySave);</span>
<span class="nc" id="L479">        myPanel.addNode(pNewButton);</span>

        /* Pass through the save event */
<span class="nc" id="L482">        final OceanusEventRegistrar&lt;TethysUIEvent&gt; myRegistrar = mySave.getEventRegistrar();</span>
<span class="nc" id="L483">        myRegistrar.addEventListener(e -&gt; theEventManager.fireEvent(PrometheusDataEvent.SAVETOFILE));</span>

        /* Return the panel */
<span class="nc" id="L486">        return myPanel;</span>
    }

    /**
     * Create filter detail panel.
     * @param pFactory the GUI factory
     * @return the panel
     */
    private TethysUIBoxPaneManager buildFilterDetail(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create the control panel */
<span class="nc" id="L496">        final TethysUIBoxPaneManager myPanel = pFactory.paneFactory().newHBoxPane();</span>

        /* Create the labels */
<span class="nc" id="L499">        final TethysUILabel myFilterLabel = pFactory.controlFactory().newLabel(NLS_FILTER);</span>

        /* Create the panel */
<span class="nc" id="L502">        myPanel.addNode(myFilterLabel);</span>
<span class="nc" id="L503">        myPanel.addNode(theFilterButton);</span>
<span class="nc" id="L504">        myPanel.addSpacer();</span>
<span class="nc" id="L505">        myPanel.addNode(theBucketLabel);</span>
<span class="nc" id="L506">        myPanel.addNode(theColumnLabel);</span>
<span class="nc" id="L507">        myPanel.addNode(theBucketButton);</span>
<span class="nc" id="L508">        myPanel.addNode(theColumnButton);</span>

        /* Return the panel */
<span class="nc" id="L511">        return myPanel;</span>
    }

    /**
     * Create filter select panel.
     * @param pFactory the GUI factory
     * @return the panel
     */
    private TethysUIBoxPaneManager buildFilterSelect(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create the filter panel */
<span class="nc" id="L521">        final TethysUIBoxPaneManager myPanel = pFactory.paneFactory().newHBoxPane();</span>

        /* Create the labels */
<span class="nc" id="L524">        final TethysUILabel myTypeLabel = pFactory.controlFactory().newLabel(NLS_FILTERTYPE);</span>

        /* Add to the card panels */
<span class="nc" id="L527">        theCardPanel.addCard(MoneyWiseAnalysisType.DEPOSIT.name(), theDepositSelect);</span>
<span class="nc" id="L528">        theCardPanel.addCard(MoneyWiseAnalysisType.CASH.name(), theCashSelect);</span>
<span class="nc" id="L529">        theCardPanel.addCard(MoneyWiseAnalysisType.LOAN.name(), theLoanSelect);</span>
<span class="nc" id="L530">        theCardPanel.addCard(MoneyWiseAnalysisType.SECURITY.name(), theSecuritySelect);</span>
<span class="nc" id="L531">        theCardPanel.addCard(MoneyWiseAnalysisType.PORTFOLIO.name(), thePortfolioSelect);</span>
<span class="nc" id="L532">        theCardPanel.addCard(MoneyWiseAnalysisType.PAYEE.name(), thePayeeSelect);</span>
<span class="nc" id="L533">        theCardPanel.addCard(MoneyWiseAnalysisType.CATEGORY.name(), theCategorySelect);</span>
<span class="nc" id="L534">        theCardPanel.addCard(MoneyWiseAnalysisType.TAXBASIS.name(), theTaxBasisSelect);</span>
<span class="nc" id="L535">        theCardPanel.addCard(MoneyWiseAnalysisType.TRANSTAG.name(), theTagSelect);</span>
<span class="nc" id="L536">        theCardPanel.addCard(MoneyWiseAnalysisType.ALL.name(), theAllSelect);</span>

        /* Build the map */
<span class="nc" id="L539">        theMap.put(MoneyWiseAnalysisType.DEPOSIT, theDepositSelect);</span>
<span class="nc" id="L540">        theMap.put(MoneyWiseAnalysisType.CASH, theCashSelect);</span>
<span class="nc" id="L541">        theMap.put(MoneyWiseAnalysisType.LOAN, theLoanSelect);</span>
<span class="nc" id="L542">        theMap.put(MoneyWiseAnalysisType.SECURITY, theSecuritySelect);</span>
<span class="nc" id="L543">        theMap.put(MoneyWiseAnalysisType.PORTFOLIO, thePortfolioSelect);</span>
<span class="nc" id="L544">        theMap.put(MoneyWiseAnalysisType.PAYEE, thePayeeSelect);</span>
<span class="nc" id="L545">        theMap.put(MoneyWiseAnalysisType.CATEGORY, theCategorySelect);</span>
<span class="nc" id="L546">        theMap.put(MoneyWiseAnalysisType.TAXBASIS, theTaxBasisSelect);</span>
<span class="nc" id="L547">        theMap.put(MoneyWiseAnalysisType.TRANSTAG, theTagSelect);</span>
<span class="nc" id="L548">        theMap.put(MoneyWiseAnalysisType.ALL, theAllSelect);</span>

        /* Create the panel */
<span class="nc" id="L551">        myPanel.setBorderTitle(NLS_FILTERTITLE);</span>
<span class="nc" id="L552">        myPanel.addNode(myTypeLabel);</span>
<span class="nc" id="L553">        myPanel.addNode(theFilterTypeButton);</span>
<span class="nc" id="L554">        myPanel.addSpacer();</span>
<span class="nc" id="L555">        myPanel.addNode(theCardPanel);</span>

        /* Return the panel */
<span class="nc" id="L558">        return myPanel;</span>
    }

    /**
     * Select Statement.
     * @param pSelect the selection
     */
    public void selectStatement(final MoneyWiseStatementSelect pSelect) {
        /* Set refreshing flag */
<span class="nc" id="L567">        isRefreshing = true;</span>

        /* Update the range */
<span class="nc" id="L570">        final TethysUIDateRangeSelector mySelect = pSelect.getRangeSelect();</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">        if (mySelect != null) {</span>
<span class="nc" id="L572">            theRangeSelect.setSelection(mySelect);</span>
<span class="nc" id="L573">            theRangeSelect.lockPeriod(false);</span>
<span class="nc" id="L574">            theState.setRange(mySelect);</span>

            /* Update the analysis */
<span class="nc" id="L577">            theAnalysisView.setRange(mySelect.getRange());</span>
<span class="nc" id="L578">            theAnalysis = theAnalysisView.getAnalysis();</span>
<span class="nc" id="L579">            setAnalysis();</span>
        }

        /* Access the filter and the selection panel */
<span class="nc" id="L583">        final MoneyWiseAnalysisFilter&lt;?, ?&gt; myFilter = pSelect.getFilter();</span>
<span class="nc" id="L584">        final MoneyWiseAnalysisType myType = myFilter.getAnalysisType();</span>
<span class="nc" id="L585">        final MoneyWiseAnalysisFilterSelection myPanel = theMap.get(myType);</span>

        /* Move correct card to front and update it */
<span class="nc" id="L588">        theCardPanel.selectCard(myType.name());</span>
<span class="nc" id="L589">        myPanel.setFilter(myFilter);</span>

        /* Determine the state */
<span class="nc" id="L592">        theState.determineState(myPanel);</span>

        /* Clear refreshing flag */
<span class="nc" id="L595">        isRefreshing = false;</span>
<span class="nc" id="L596">    }</span>

    /**
     * Refresh data.
     */
    public void refreshData() {
        /* Update the range selection */
<span class="nc" id="L603">        final OceanusDateRange myRange = theView.getRange();</span>
<span class="nc" id="L604">        theRangeSelect.setOverallRange(myRange);</span>

        /* Refresh the analysisView */
<span class="nc" id="L607">        theAnalysisView.refreshData();</span>

        /* Update the filter selection */
<span class="nc" id="L610">        checkType();</span>
<span class="nc" id="L611">    }</span>

    /**
     * Declare analysis.
     */
    private void setAnalysis() {
        /* Only update if we have an analysis */
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (theAnalysis != null) {</span>
            /* Update filters */
<span class="nc" id="L620">            theDepositSelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L621">            theCashSelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L622">            theLoanSelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L623">            theSecuritySelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L624">            thePortfolioSelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L625">            theCategorySelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L626">            thePayeeSelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L627">            theTaxBasisSelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L628">            theTagSelect.setAnalysis(theAnalysis);</span>
<span class="nc" id="L629">            theAllSelect.setAnalysis(theAnalysis);</span>

            /* Update the filter */
<span class="nc" id="L632">            updateFilter();</span>
        }
<span class="nc" id="L634">    }</span>

    /**
     * Update the filter.
     */
    private void updateFilter() {
        /* Access the active panel */
<span class="nc" id="L641">        final MoneyWiseAnalysisType myType = theState.getType();</span>
<span class="nc" id="L642">        final MoneyWiseAnalysisFilterSelection myPanel = theMap.get(myType);</span>

        /* Update filters */
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (myPanel != null) {</span>
<span class="nc" id="L646">            final MoneyWiseAnalysisFilter&lt;?, ?&gt; myFilter = myPanel.getFilter();</span>
<span class="nc" id="L647">            myFilter.setCurrentAttribute(theState.getBucket());</span>
<span class="nc" id="L648">            theState.setFilter(myFilter);</span>
        }

        /* Notify updated filter */
<span class="nc" id="L652">        theEventManager.fireEvent(PrometheusDataEvent.SELECTIONCHANGED);</span>
<span class="nc" id="L653">    }</span>

    /**
     * Create SavePoint.
     */
    protected void createSavePoint() {
        /* Create the savePoint */
<span class="nc" id="L660">        theSavePoint = new MoneyWiseAnalysisState(theState);</span>
<span class="nc" id="L661">    }</span>

    /**
     * Restore SavePoint.
     */
    protected void restoreSavePoint() {
        /* Restore the savePoint */
<span class="nc" id="L668">        theState = new MoneyWiseAnalysisState(theSavePoint);</span>

        /* Apply the state */
<span class="nc" id="L671">        theState.applyState();</span>
<span class="nc" id="L672">    }</span>

    @Override
    public void setEnabled(final boolean bEnabled) {
        /* If there are filters available */
<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (isAvailable()) {</span>
            /* Enabled disable range selection */
<span class="nc" id="L679">            theRangeButton.setEnabled(bEnabled);</span>

            /* Enable filter detail */
<span class="nc" id="L682">            theFilterDetail.setVisible(true);</span>
<span class="nc" id="L683">            theFilterButton.setEnabled(bEnabled);</span>
<span class="nc" id="L684">            theColumnButton.setEnabled(bEnabled);</span>
<span class="nc" id="L685">            theBucketButton.setEnabled(bEnabled);</span>

            /* If we are disabling */
<span class="nc bnc" id="L688" title="All 2 branches missed.">            if (!bEnabled) {</span>
                /* Hide panels */
<span class="nc" id="L690">                setRangeVisibility(false);</span>
<span class="nc" id="L691">                setFilterVisibility(false);</span>
            }

            /* else no filters available */
        } else {
            /* Enabled disable range selection */
<span class="nc" id="L697">            theRangeButton.setEnabled(false);</span>

            /* Hide panels */
<span class="nc" id="L700">            setRangeVisibility(false);</span>
<span class="nc" id="L701">            setFilterVisibility(false);</span>
<span class="nc" id="L702">            theFilterDetail.setVisible(false);</span>
<span class="nc" id="L703">            theRangeSelect.setEnabled(bEnabled);</span>
        }
<span class="nc" id="L705">    }</span>

    @Override
    public void setVisible(final boolean pVisible) {
<span class="nc" id="L709">        thePanel.setVisible(pVisible);</span>
<span class="nc" id="L710">    }</span>

    /**
     * Is there any filter available?
     * @return true/false
     */
    private boolean isAvailable() {
        /* Loop through the panels */
<span class="nc bnc" id="L718" title="All 2 branches missed.">        for (MoneyWiseAnalysisFilterSelection myEntry : theMap.values()) {</span>
            /* If the filter is possible */
<span class="nc bnc" id="L720" title="All 2 branches missed.">            if (myEntry.isAvailable()) {</span>
                /* Filter available */
<span class="nc" id="L722">                return true;</span>
            }
<span class="nc" id="L724">        }</span>

        /* No available filters */
<span class="nc" id="L727">        return false;</span>
    }

    /**
     * Check analysis type.
     */
    private void checkType() {
        /* If the type is not appropriate */
<span class="nc" id="L735">        MoneyWiseAnalysisType myType = theState.getType();</span>

        /* If the type is selected */
<span class="nc bnc" id="L738" title="All 2 branches missed.">        if (myType != null) {</span>
            /* Check that the filter is appropriate */
<span class="nc" id="L740">            final MoneyWiseAnalysisFilterSelection myPanel = theMap.get(myType);</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">            if (myPanel.isAvailable()) {</span>
                /* We are OK */
<span class="nc" id="L743">                final MoneyWiseAnalysisFilter&lt;?, ?&gt; myFilter = myPanel.getFilter();</span>
<span class="nc" id="L744">                theState.setFilter(myFilter);</span>
<span class="nc" id="L745">                return;</span>
            }
        }

        /* Loop through the panels */
<span class="nc bnc" id="L750" title="All 2 branches missed.">        for (Entry&lt;MoneyWiseAnalysisType, MoneyWiseAnalysisFilterSelection&gt; myEntry : theMap.entrySet()) {</span>
            /* If the filter is possible */
<span class="nc" id="L752">            final MoneyWiseAnalysisFilterSelection myPanel = myEntry.getValue();</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">            if (myPanel.isAvailable()) {</span>
                /* Access Analysis type */
<span class="nc" id="L755">                myType = myEntry.getKey();</span>

                /* Move correct card to front */
<span class="nc" id="L758">                theCardPanel.selectCard(myType.name());</span>

                /* Obtain the relevant filter */
<span class="nc" id="L761">                final MoneyWiseAnalysisFilter&lt;?, ?&gt; myFilter = myPanel.getFilter();</span>
<span class="nc" id="L762">                final MoneyWiseAnalysisAttribute myDefault = myType.getDefaultValue();</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">                if (myFilter != null) {</span>
<span class="nc" id="L764">                    myFilter.setCurrentAttribute(myDefault);</span>
                }

                /* Set new bucket type and apply state */
<span class="nc" id="L768">                theState.setAnalysisType(myType);</span>
<span class="nc" id="L769">                theState.setFilter(myFilter);</span>
<span class="nc" id="L770">                theState.setBucket(myDefault);</span>
<span class="nc" id="L771">                theState.applyState();</span>

                /* Filter available */
<span class="nc" id="L774">                return;</span>
            }
<span class="nc" id="L776">        }</span>

        /* No available filters */
<span class="nc" id="L779">        theState.setFilter(null);</span>
<span class="nc" id="L780">        theState.setAnalysisType(null);</span>
<span class="nc" id="L781">        theState.setBucket(null);</span>
<span class="nc" id="L782">    }</span>

    /**
     * Build AnalysisType menu.
     */
    private void buildAnalysisTypeMenu() {
        /* Reset the popUp menu */
<span class="nc" id="L789">        theTypeMenu.removeAllItems();</span>

        /* Loop through the panels */
<span class="nc bnc" id="L792" title="All 2 branches missed.">        for (Entry&lt;MoneyWiseAnalysisType, MoneyWiseAnalysisFilterSelection&gt; myEntry : theMap.entrySet()) {</span>
            /* If the filter is possible */
<span class="nc bnc" id="L794" title="All 2 branches missed.">            if (myEntry.getValue().isAvailable()) {</span>
                /* Create a new MenuItem and add it to the popUp */
<span class="nc" id="L796">                theTypeMenu.addItem(myEntry.getKey());</span>
            }
<span class="nc" id="L798">        }</span>
<span class="nc" id="L799">    }</span>

    /**
     * Build Bucket menu.
     */
    private void buildBucketMenu() {
        /* Reset the popUp menu */
<span class="nc" id="L806">        theBucketMenu.removeAllItems();</span>

        /* Loop through the buckets */
<span class="nc" id="L809">        final MoneyWiseAnalysisFilter&lt;?, ?&gt; myFilter = theState.getFilter();</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">        for (MoneyWiseAnalysisAttribute myAttr : theState.getType().getValues()) {</span>
            /* If the value is a counter */
<span class="nc bnc" id="L812" title="All 2 branches missed.">            if (myAttr.isCounter()</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">                    &amp;&amp; myFilter.isRelevantCounter(myAttr)) {</span>
                /* Create a new MenuItem and add it to the popUp */
<span class="nc" id="L815">                theBucketMenu.addItem(myAttr);</span>
            }
        }

        /* Add the entry for null bucket */
<span class="nc" id="L820">        theBucketMenu.addNullItem(NLS_NONE);</span>
<span class="nc" id="L821">    }</span>

    /**
     * Build Columns menu.
     */
    private void buildColumnsMenu() {
        /* Reset the popUp menu */
<span class="nc" id="L828">        theColumnMenu.removeAllItems();</span>

        /* Determine whether we have balances */
<span class="nc" id="L831">        final boolean hasBalances = theState.getType().hasBalances();</span>

        /* Loop through the sets */
<span class="nc bnc" id="L834" title="All 2 branches missed.">        for (MoneyWiseAnalysisColumnSet mySet : MoneyWiseAnalysisColumnSet.values()) {</span>
            /* if we have balances or this is not the balance set */
<span class="nc bnc" id="L836" title="All 2 branches missed.">            if (hasBalances</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">                    || !mySet.isBalance()) {</span>
                /* Add the item */
<span class="nc" id="L839">                theColumnMenu.addItem(mySet);</span>
            }
        }
<span class="nc" id="L842">    }</span>

    /**
     * Build Deposit Filter.
     */
    private void buildDepositFilter() {
<span class="nc" id="L848">        applyFilter(theDepositSelect.getFilter());</span>
<span class="nc" id="L849">    }</span>

    /**
     * Build Cash Filter.
     */
    private void buildCashFilter() {
<span class="nc" id="L855">        applyFilter(theCashSelect.getFilter());</span>
<span class="nc" id="L856">    }</span>

    /**
     * Build Loan Filter.
     */
    private void buildLoanFilter() {
<span class="nc" id="L862">        applyFilter(theLoanSelect.getFilter());</span>
<span class="nc" id="L863">    }</span>

    /**
     * Build Security Filter.
     */
    private void buildSecurityFilter() {
<span class="nc" id="L869">        applyFilter(theSecuritySelect.getFilter());</span>
<span class="nc" id="L870">    }</span>

    /**
     * Build Portfolio Filter.
     */
    private void buildPortfolioFilter() {
<span class="nc" id="L876">        applyFilter(thePortfolioSelect.getFilter());</span>
<span class="nc" id="L877">    }</span>

    /**
     * Build Payee Filter.
     */
    private void buildPayeeFilter() {
<span class="nc" id="L883">        applyFilter(thePayeeSelect.getFilter());</span>
<span class="nc" id="L884">    }</span>

    /**
     * Build Category Filter.
     */
    private void buildCategoryFilter() {
<span class="nc" id="L890">        applyFilter(theCategorySelect.getFilter());</span>
<span class="nc" id="L891">    }</span>

    /**
     * Build TaxBasis Filter.
     */
    private void buildTaxBasisFilter() {
<span class="nc" id="L897">        applyFilter(theTaxBasisSelect.getFilter());</span>
<span class="nc" id="L898">    }</span>

    /**
     * Build Tag Filter.
     */
    private void buildTagFilter() {
<span class="nc" id="L904">        applyFilter(theTagSelect.getFilter());</span>
<span class="nc" id="L905">    }</span>

    /**
     * Apply Filter.
     * @param pFilter the filter
     */
    private void applyFilter(final MoneyWiseAnalysisFilter&lt;?, ?&gt; pFilter) {
        /* Ignore if we are refreshing */
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (!isRefreshing) {</span>
<span class="nc" id="L914">            final MoneyWiseAnalysisAttribute myBucket = theState.getBucket();</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">            if (pFilter.isRelevantCounter(myBucket)) {</span>
<span class="nc" id="L916">                pFilter.setCurrentAttribute(theState.getBucket());</span>
            } else {
<span class="nc" id="L918">                theState.setBucket(pFilter.getCurrentAttribute());</span>
            }
<span class="nc" id="L920">            theState.setFilter(pFilter);</span>
<span class="nc" id="L921">            theState.applyState();</span>
<span class="nc" id="L922">            theEventManager.fireEvent(PrometheusDataEvent.SELECTIONCHANGED);</span>
        }
<span class="nc" id="L924">    }</span>

    /**
     * Set AnalysisView.
     */
    private void setAnalysisView() {
        /* Ignore if we are refreshing */
<span class="nc bnc" id="L931" title="All 2 branches missed.">        if (!isRefreshing) {</span>
            /* Declare the analysis */
<span class="nc" id="L933">            theAnalysis = theAnalysisView.getAnalysis();</span>
<span class="nc" id="L934">            setAnalysis();</span>

            /* Validate state and apply */
<span class="nc" id="L937">            checkType();</span>
<span class="nc" id="L938">            theState.applyState();</span>

            /* Notify listeners */
<span class="nc" id="L941">            theEventManager.fireEvent(PrometheusDataEvent.SELECTIONCHANGED);</span>
        }
<span class="nc" id="L943">    }</span>

    /**
     * Handle New Range.
     */
    private void handleNewRange() {
        /* Ignore if we are refreshing */
<span class="nc bnc" id="L950" title="All 2 branches missed.">        if (isRefreshing) {</span>
<span class="nc" id="L951">            return;</span>
        }

        /* If we have a change to the range */
<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (theState.setRange(theRangeSelect)) {</span>
            /* Note that we are refreshing */
<span class="nc" id="L957">            isRefreshing = true;</span>

            /* Obtain new analysis */
<span class="nc" id="L960">            theAnalysisView.setRange(getRange());</span>
<span class="nc" id="L961">            theAnalysis = theAnalysisView.getAnalysis();</span>
<span class="nc" id="L962">            setAnalysis();</span>

            /* Validate state and apply */
<span class="nc" id="L965">            checkType();</span>
<span class="nc" id="L966">            theState.applyState();</span>

            /* Remove refreshing flag and notify listeners */
<span class="nc" id="L969">            isRefreshing = false;</span>
<span class="nc" id="L970">            theEventManager.fireEvent(PrometheusDataEvent.SELECTIONCHANGED);</span>
        }
<span class="nc" id="L972">    }</span>

    /**
     * Set RangeSelect visibility.
     * @param pVisible the visibility setting
     */
    private void setRangeVisibility(final boolean pVisible) {
<span class="nc bnc" id="L979" title="All 2 branches missed.">        theRangeButton.setIcon(pVisible</span>
<span class="nc" id="L980">                ? TethysUIArrowIconId.UP</span>
<span class="nc" id="L981">                : TethysUIArrowIconId.DOWN);</span>
<span class="nc" id="L982">        theRangeSelect.setVisible(pVisible);</span>
<span class="nc" id="L983">        isRangeVisible = pVisible;</span>
<span class="nc" id="L984">    }</span>

    /**
     * Set FilterSelect visibility.
     * @param pVisible the visibility setting
     */
    private void setFilterVisibility(final boolean pVisible) {
<span class="nc bnc" id="L991" title="All 2 branches missed.">        theFilterButton.setIcon(pVisible</span>
<span class="nc" id="L992">                ? TethysUIArrowIconId.UP</span>
<span class="nc" id="L993">                : TethysUIArrowIconId.DOWN);</span>
<span class="nc" id="L994">        theFilterSelect.setVisible(pVisible);</span>
<span class="nc" id="L995">        isFilterVisible = pVisible;</span>
<span class="nc" id="L996">    }</span>

    /**
     * Handle New Bucket.
     */
    private void handleNewBucket() {
        /* Ignore if we are refreshing */
<span class="nc bnc" id="L1003" title="All 2 branches missed.">        if (isRefreshing) {</span>
<span class="nc" id="L1004">            return;</span>
        }

<span class="nc" id="L1007">        final MoneyWiseAnalysisAttribute myBucket = theBucketButton.getValue();</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">        if (theState.setBucket(myBucket)) {</span>
<span class="nc" id="L1009">            final MoneyWiseAnalysisFilter&lt;?, ?&gt; myFilter = theState.getFilter();</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">            if (myBucket != null) {</span>
<span class="nc" id="L1011">                myFilter.setCurrentAttribute(myBucket);</span>
            }
<span class="nc" id="L1013">            theState.applyState();</span>
<span class="nc" id="L1014">            theEventManager.fireEvent(PrometheusDataEvent.SELECTIONCHANGED);</span>
        }
<span class="nc" id="L1016">    }</span>

    /**
     * Handle New Columns.
     */
    private void handleNewColumns() {
        /* Ignore if we are refreshing */
<span class="nc bnc" id="L1023" title="All 2 branches missed.">        if (isRefreshing) {</span>
<span class="nc" id="L1024">            return;</span>
        }

        /* Record the columns */
<span class="nc" id="L1028">        final MoneyWiseAnalysisColumnSet mySet = theColumnButton.getValue();</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        if (theState.setColumns(mySet)) {</span>
<span class="nc" id="L1030">            theState.applyState();</span>
<span class="nc" id="L1031">            theEventManager.fireEvent(PrometheusDataEvent.SELECTIONCHANGED);</span>
        }
<span class="nc" id="L1033">    }</span>

    /**
     * Handle FilterType.
     */
    private void handleFilterType() {
        /* Ignore if we are refreshing */
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        if (isRefreshing) {</span>
<span class="nc" id="L1041">            return;</span>
        }

        /* If the type has changed */
<span class="nc" id="L1045">        final MoneyWiseAnalysisType myType = theFilterTypeButton.getValue();</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">        if (theState.setAnalysisType(myType)) {</span>
            /* Determine whether we are showing balances */
<span class="nc bnc" id="L1048" title="All 2 branches missed.">            final boolean showingBalances = !theState.showColumns();</span>
<span class="nc bnc" id="L1049" title="All 4 branches missed.">            if (showingBalances &amp;&amp; !myType.hasBalances()) {</span>
                /* Move to columns if we have no balances */
<span class="nc" id="L1051">                theState.showColumns(true);</span>
            }

            /* Move correct card to front */
<span class="nc" id="L1055">            theCardPanel.selectCard(myType.name());</span>

            /* Obtain the relevant filter */
<span class="nc" id="L1058">            final MoneyWiseAnalysisFilterSelection myPanel = theMap.get(myType);</span>
<span class="nc" id="L1059">            final MoneyWiseAnalysisFilter&lt;?, ?&gt; myFilter = myPanel.getFilter();</span>
<span class="nc" id="L1060">            myFilter.setCurrentAttribute(myType.getDefaultValue());</span>

            /* Set new bucket type and apply state */
<span class="nc" id="L1063">            theState.setFilter(myFilter);</span>
<span class="nc" id="L1064">            theState.setBucket(myFilter.getCurrentAttribute());</span>
<span class="nc" id="L1065">            theState.applyState();</span>
<span class="nc" id="L1066">            theEventManager.fireEvent(PrometheusDataEvent.SELECTIONCHANGED);</span>
        }
<span class="nc" id="L1068">    }</span>

    /**
     * SavePoint values.
     */
    private final class MoneyWiseAnalysisState {
        /**
         * The Range.
         */
        private OceanusDateRange theRange;

        /**
         * The AnalysisType.
         */
        private MoneyWiseAnalysisType theType;

        /**
         * The BucketAttribute.
         */
        private MoneyWiseAnalysisAttribute theBucket;

        /**
         * The ColumnSet.
         */
        private MoneyWiseAnalysisColumnSet theColumns;

        /**
         * The filter.
         */
        private MoneyWiseAnalysisFilter&lt;?, ?&gt; theFilter;

        /**
         * Are we showing Columns?
         */
        private boolean showColumns;

        /**
         * Constructor.
         */
<span class="nc" id="L1107">        private MoneyWiseAnalysisState() {</span>
<span class="nc" id="L1108">            theRange = null;</span>
<span class="nc" id="L1109">            theFilter = null;</span>
<span class="nc" id="L1110">            theType = null;</span>
<span class="nc" id="L1111">            theBucket = null;</span>
<span class="nc" id="L1112">            theColumns = MoneyWiseAnalysisColumnSet.STANDARD;</span>
<span class="nc" id="L1113">            showColumns = true;</span>
<span class="nc" id="L1114">        }</span>

        /**
         * Constructor.
         * @param pState state to copy from
         */
<span class="nc" id="L1120">        private MoneyWiseAnalysisState(final MoneyWiseAnalysisState pState) {</span>
<span class="nc" id="L1121">            theRange = pState.getRange();</span>
<span class="nc" id="L1122">            theFilter = pState.getFilter();</span>
<span class="nc" id="L1123">            theType = pState.getType();</span>
<span class="nc" id="L1124">            theBucket = pState.getBucket();</span>
<span class="nc" id="L1125">            theColumns = pState.getColumns();</span>
<span class="nc" id="L1126">            showColumns = pState.showColumns();</span>
<span class="nc" id="L1127">        }</span>

        /**
         * Obtain the DateDayRange.
         * @return the range.
         */
        private OceanusDateRange getRange() {
<span class="nc" id="L1134">            return theRange;</span>
        }

        /**
         * Obtain the AnalysisType.
         * @return the analysis type.
         */
        private MoneyWiseAnalysisType getType() {
<span class="nc" id="L1142">            return theType;</span>
        }

        /**
         * Obtain the BucketType.
         * @return the bucket type.
         */
        private MoneyWiseAnalysisAttribute getBucket() {
<span class="nc" id="L1150">            return theBucket;</span>
        }

        /**
         * Obtain the Columns.
         * @return the columns.
         */
        private MoneyWiseAnalysisColumnSet getColumns() {
<span class="nc" id="L1158">            return theColumns;</span>
        }

        /**
         * Obtain the Filter.
         * @return the filter.
         */
        private MoneyWiseAnalysisFilter&lt;?, ?&gt; getFilter() {
<span class="nc" id="L1166">            return theFilter;</span>
        }

        /**
         * Are we showing columns?
         * @return true/false.
         */
        private boolean showColumns() {
<span class="nc" id="L1174">            return showColumns;</span>
        }

        /**
         * Determine selection from panels.
         * @param pFilter selection panel
         */
        private void determineState(final MoneyWiseAnalysisFilterSelection pFilter) {
            /* Update the selection panels */
<span class="nc" id="L1183">            theRange = theRangeSelect.getRange();</span>
<span class="nc" id="L1184">            theFilter = pFilter.getFilter();</span>
<span class="nc" id="L1185">            theType = theFilter.getAnalysisType();</span>
<span class="nc" id="L1186">            theBucket = theFilter.getCurrentAttribute();</span>
<span class="nc bnc" id="L1187" title="All 2 branches missed.">            showColumns = theBucket == null;</span>
<span class="nc" id="L1188">            applyState();</span>
<span class="nc" id="L1189">        }</span>

        /**
         * Set new Range from select panel.
         * @param pSelect the selection panel
         * @return true/false did a change occur
         */
        private boolean setRange(final TethysUIDateRangeSelector pSelect) {
            /* Adjust the selected account */
<span class="nc" id="L1198">            final OceanusDateRange myRange = pSelect.getRange();</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">            if (!MetisDataDifference.isEqual(myRange, theRange)) {</span>
<span class="nc" id="L1200">                theRange = myRange;</span>
<span class="nc" id="L1201">                return true;</span>
            }
<span class="nc" id="L1203">            return false;</span>
        }

        /**
         * Set new analysis type.
         * @param pType the analysis type
         * @return true/false did a change occur
         */
        private boolean setAnalysisType(final MoneyWiseAnalysisType pType) {
<span class="nc bnc" id="L1212" title="All 2 branches missed.">            if (!MetisDataDifference.isEqual(pType, theType)) {</span>
<span class="nc" id="L1213">                theType = pType;</span>
<span class="nc" id="L1214">                return true;</span>
            }
<span class="nc" id="L1216">            return false;</span>
        }

        /**
         * Set new bucket type.
         * @param pBucket the bucket type
         * @return true/false did a change occur
         */
        private boolean setBucket(final MoneyWiseAnalysisAttribute pBucket) {
<span class="nc bnc" id="L1225" title="All 2 branches missed.">            if (!MetisDataDifference.isEqual(pBucket, theBucket)) {</span>
                /* If this is the null bucket */
<span class="nc bnc" id="L1227" title="All 2 branches missed.">                if (pBucket == null) {</span>
<span class="nc" id="L1228">                    showColumns = true;</span>
                } else {
<span class="nc" id="L1230">                    theBucket = pBucket;</span>
                }
<span class="nc" id="L1232">                return true;</span>
            }
<span class="nc" id="L1234">            return false;</span>
        }

        /**
         * Set new column set.
         * @param pColumnSet the column set
         * @return true/false did a change occur
         */
        private boolean setColumns(final MoneyWiseAnalysisColumnSet pColumnSet) {
<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (!MetisDataDifference.isEqual(pColumnSet, theColumns)) {</span>
                /* If this is the balance bucket */
<span class="nc bnc" id="L1245" title="All 2 branches missed.">                if (pColumnSet.equals(MoneyWiseAnalysisColumnSet.BALANCE)) {</span>
<span class="nc" id="L1246">                    showColumns = false;</span>
                } else {
<span class="nc" id="L1248">                    theColumns = pColumnSet;</span>
                }
<span class="nc" id="L1250">                return true;</span>
            }
<span class="nc" id="L1252">            return false;</span>
        }

        /**
         * Set filter.
         * @param pFilter the filter
         */
        private void setFilter(final MoneyWiseAnalysisFilter&lt;?, ?&gt; pFilter) {
<span class="nc" id="L1260">            theFilter = pFilter;</span>
<span class="nc" id="L1261">        }</span>

        /**
         * Apply the State.
         */
        private void applyState() {
            /* Adjust the lock-down */
<span class="nc" id="L1268">            setEnabled(true);</span>
<span class="nc" id="L1269">            theRangeButton.setText(theRange.toString());</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">            theFilterButton.setText((theFilter == null)</span>
<span class="nc" id="L1271">                    ? null</span>
<span class="nc" id="L1272">                    : theFilter.getName());</span>
<span class="nc" id="L1273">            theFilterTypeButton.setValue(theType);</span>
<span class="nc" id="L1274">            theBucketButton.setValue(theBucket);</span>
<span class="nc" id="L1275">            theColumnButton.setValue(theColumns);</span>
<span class="nc" id="L1276">            showColumns(showColumns);</span>
<span class="nc" id="L1277">        }</span>

        /**
         * Show Columns.
         * @param pShow true/false
         */
        private void showColumns(final boolean pShow) {
            /* Show columns */
<span class="nc" id="L1285">            theColumnLabel.setVisible(pShow);</span>
<span class="nc" id="L1286">            theColumnButton.setVisible(pShow);</span>

            /* Hide buckets */
<span class="nc bnc" id="L1289" title="All 2 branches missed.">            theBucketLabel.setVisible(!pShow);</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">            theBucketButton.setVisible(!pShow);</span>

            /* Record details */
<span class="nc" id="L1293">            showColumns = pShow;</span>
<span class="nc" id="L1294">        }</span>
    }

    /**
     * The Statement Select class.
     */
    public static final class MoneyWiseStatementSelect {
        /**
         * The Range Selection.
         */
        private final TethysUIDateRangeSelector theRangeSelect;

        /**
         * The AnalysisFilter.
         */
        private final MoneyWiseAnalysisFilter&lt;?, ?&gt; theFilter;

        /**
         * Constructor.
         * @param pRangeSelect the range selection
         * @param pFilter the analysis filter
         */
        public MoneyWiseStatementSelect(final TethysUIDateRangeSelector pRangeSelect,
<span class="nc" id="L1317">                                        final MoneyWiseAnalysisFilter&lt;?, ?&gt; pFilter) {</span>
            /* Store parameters */
<span class="nc" id="L1319">            theRangeSelect = pRangeSelect;</span>
<span class="nc" id="L1320">            theFilter = pFilter;</span>
<span class="nc" id="L1321">        }</span>

        /**
         * Obtain the RangeSelection.
         * @return the filter
         */
        public TethysUIDateRangeSelector getRangeSelect() {
<span class="nc" id="L1328">            return theRangeSelect;</span>
        }

        /**
         * Obtain the Filter.
         * @return the filter
         */
        public MoneyWiseAnalysisFilter&lt;?, ?&gt; getFilter() {
<span class="nc" id="L1336">            return theFilter;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>