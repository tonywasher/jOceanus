<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseQIFParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.quicken.file</a> &gt; <span class="el_source">MoneyWiseQIFParser.java</span></div><h1>MoneyWiseQIFParser.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.quicken.file;

import net.sourceforge.joceanus.moneywise.quicken.definitions.MoneyWiseQIFType;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.tethys.api.factory.TethysUIFactory;

import java.io.BufferedReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

/**
 * Class to parse a QIFFile.
 */
public class MoneyWiseQIFParser {
    /**
     * The QIFFile being built.
     */
    private final MoneyWiseQIFFile theFile;

    /**
     * Data formatter.
     */
    private final OceanusDataFormatter theFormatter;

    /**
     * Record mode.
     */
    private MoneyWiseQIFSection theSection;

    /**
     * Active account.
     */
    private MoneyWiseQIFAccountEvents theActive;

    /**
     * is active account portfolio?
     */
    private boolean isPortfolio;

    /**
     * Constructor.
     * @param pFactory the gui factory
     * @param pFileType the QIF file type.
     */
    public MoneyWiseQIFParser(final TethysUIFactory&lt;?&gt; pFactory,
<span class="nc" id="L63">                              final MoneyWiseQIFType pFileType) {</span>
        /* Create new file */
<span class="nc" id="L65">        theFile = new MoneyWiseQIFFile(pFileType);</span>

        /* Allocate the formatter and set date format */
<span class="nc" id="L68">        theFormatter = pFactory.newDataFormatter();</span>
<span class="nc" id="L69">        theFormatter.setFormat(MoneyWiseQIFWriter.QIF_DATEFORMAT);</span>
<span class="nc" id="L70">    }</span>

    /**
     * Obtain file.
     * @return the QIF file.
     */
    public MoneyWiseQIFFile getFile() {
<span class="nc" id="L77">        return theFile;</span>
    }

    /**
     * Load from Stream.
     * @param pStream the input stream
     * @return continue true/false
     * @throws IOException on error
     */
    public boolean loadFile(final BufferedReader pStream) throws IOException {
        /* List of lines */
<span class="nc" id="L88">        final List&lt;String&gt; myLines = new ArrayList&lt;&gt;();</span>

        /* Loop through the file */
        for (;;) {
            /* Read the next line and break on EOF */
<span class="nc" id="L93">            final String myLine = pStream.readLine();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            if (myLine == null) {</span>
<span class="nc" id="L95">                break;</span>
            }

            /* If this is a command */
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (myLine.startsWith(MoneyWiseQIFRecord.QIF_CMD)) {</span>
                /* Process the mode */
<span class="nc" id="L101">                processMode(myLine);</span>
                /* If this is an EOI */
<span class="nc bnc" id="L103" title="All 2 branches missed.">            } else if (myLine.equals(MoneyWiseQIFRecord.QIF_EOI)) {</span>
                /* Process the records */
<span class="nc" id="L105">                processRecord(myLines);</span>

                /* else normal line */
            } else {
                /* Ignore blank lines */
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (myLine.length() &gt; 0) {</span>
<span class="nc" id="L111">                    myLines.add(myLine);</span>
                }
            }
<span class="nc" id="L114">        }</span>

        /* Sort the file lists */
<span class="nc" id="L117">        theFile.sortLists();</span>

        /* Return to the caller */
<span class="nc" id="L120">        return true;</span>
    }

    /**
     * Process the mode.
     * @param pLine the line to process
     */
    private void processMode(final String pLine) {
        /* If the line is a type record */
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (pLine.startsWith(MoneyWiseQIFRecord.QIF_ITEMTYPE)) {</span>
            /* Access the type */
<span class="nc" id="L131">            final String myType = pLine.substring(MoneyWiseQIFRecord.QIF_ITEMTYPE.length());</span>

            /* Determine which section this describes */
<span class="nc" id="L134">            final MoneyWiseQIFSection mySection = MoneyWiseQIFSection.determineType(myType);</span>

            /* If we found a section */
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (mySection != null) {</span>
                /* Switch on the section */
<span class="nc bnc" id="L139" title="All 2 branches missed.">                switch (mySection) {</span>
                    case CLASS:
                    case CATEGORY:
                    case SECURITY:
                    case PRICE:
<span class="nc" id="L144">                        theSection = mySection;</span>
<span class="nc" id="L145">                        theActive = null;</span>
<span class="nc" id="L146">                        break;</span>
                    default:
<span class="nc" id="L148">                        theSection = null;</span>
<span class="nc" id="L149">                        break;</span>
                }

                /* else if we have an active account */
<span class="nc bnc" id="L153" title="All 2 branches missed.">            } else if (theActive != null) {</span>
                /* Make sure that the type matches */
<span class="nc" id="L155">                final String myActiveType = theActive.getAccount().getType();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (myActiveType.equals(myType)) {</span>
                    /* Set events */
<span class="nc" id="L158">                    theSection = MoneyWiseQIFSection.EVENT;</span>

                    /* Note portfolio */
<span class="nc" id="L161">                    isPortfolio = myType.equals(MoneyWiseQIFAccount.QIFACT_INVST);</span>

                    /* Not recognised */
                } else {
<span class="nc" id="L165">                    theSection = null;</span>
                }

                /* Not recognised */
<span class="nc" id="L169">            } else {</span>
<span class="nc" id="L170">                theSection = null;</span>
            }

            /* Handle Account call */
<span class="nc bnc" id="L174" title="All 2 branches missed.">        } else if (pLine.startsWith(MoneyWiseQIFAccount.QIF_HDR)) {</span>
            /* Look for account record */
<span class="nc" id="L176">            theSection = MoneyWiseQIFSection.ACCOUNT;</span>
        }
<span class="nc" id="L178">    }</span>

    /**
     * Process the record.
     * @param pLines the lines to process
     */
    private void processRecord(final List&lt;String&gt; pLines) {
        /* Switch on the section */
<span class="nc bnc" id="L186" title="All 7 branches missed.">        switch (theSection) {</span>
            case CLASS:
<span class="nc" id="L188">                processClassRecord(pLines);</span>
<span class="nc" id="L189">                break;</span>
            case CATEGORY:
<span class="nc" id="L191">                processCategoryRecord(pLines);</span>
<span class="nc" id="L192">                break;</span>
            case ACCOUNT:
<span class="nc" id="L194">                processAccountRecord(pLines);</span>
<span class="nc" id="L195">                break;</span>
            case SECURITY:
<span class="nc" id="L197">                processSecurityRecord(pLines);</span>
<span class="nc" id="L198">                break;</span>
            case EVENT:
<span class="nc" id="L200">                processEventRecord(pLines);</span>
<span class="nc" id="L201">                break;</span>
            case PRICE:
<span class="nc" id="L203">                processPriceRecord(pLines);</span>
<span class="nc" id="L204">                break;</span>
            default:
                break;
        }

        /* Clear line list */
<span class="nc" id="L210">        pLines.clear();</span>
<span class="nc" id="L211">    }</span>

    /**
     * Process the class record.
     * @param pLines the lines to process
     */
    private void processClassRecord(final List&lt;String&gt; pLines) {
        /* register the class */
<span class="nc" id="L219">        final MoneyWiseQIFClass myClass = new MoneyWiseQIFClass(theFile, pLines);</span>
<span class="nc" id="L220">        theFile.registerClass(myClass);</span>
<span class="nc" id="L221">    }</span>

    /**
     * Process the category record.
     * @param pLines the lines to process
     */
    private void processCategoryRecord(final List&lt;String&gt; pLines) {
        /* Register the category */
<span class="nc" id="L229">        final MoneyWiseQIFEventCategory myCategory = new MoneyWiseQIFEventCategory(theFile, pLines);</span>
<span class="nc" id="L230">        theFile.registerCategory(myCategory);</span>
<span class="nc" id="L231">    }</span>

    /**
     * Process the account record.
     * @param pLines the lines to process
     */
    private void processAccountRecord(final List&lt;String&gt; pLines) {
        /* Register the account */
<span class="nc" id="L239">        final MoneyWiseQIFAccount myAccount = new MoneyWiseQIFAccount(theFile, theFormatter, pLines);</span>
<span class="nc" id="L240">        theActive = theFile.registerAccount(myAccount);</span>
<span class="nc" id="L241">    }</span>

    /**
     * Process the security record.
     * @param pLines the lines to process
     */
    private void processSecurityRecord(final List&lt;String&gt; pLines) {
        /* Register the security */
<span class="nc" id="L249">        final MoneyWiseQIFSecurity mySecurity = new MoneyWiseQIFSecurity(theFile, pLines);</span>
<span class="nc" id="L250">        theFile.registerSecurity(mySecurity);</span>
<span class="nc" id="L251">    }</span>

    /**
     * Process the event record.
     * @param pLines the lines to process
     */
    private void processEventRecord(final List&lt;String&gt; pLines) {
        /* Switch on portfolio */
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (isPortfolio) {</span>
            /* Register the event */
<span class="nc" id="L261">            final MoneyWiseQIFPortfolioEvent myEvent = new MoneyWiseQIFPortfolioEvent(theFile, theFormatter, pLines);</span>
<span class="nc" id="L262">            theActive.addEvent(myEvent);</span>
<span class="nc" id="L263">        } else {</span>
            /* Register the event */
<span class="nc" id="L265">            final MoneyWiseQIFEvent myEvent = new MoneyWiseQIFEvent(theFile, theFormatter, pLines);</span>
<span class="nc" id="L266">            theActive.addEvent(myEvent);</span>
        }
<span class="nc" id="L268">    }</span>

    /**
     * Process the price record.
     * @param pLines the lines to process
     */
    private void processPriceRecord(final List&lt;String&gt; pLines) {
        /* Register the price */
<span class="nc" id="L276">        final MoneyWiseQIFPrice myPrice = new MoneyWiseQIFPrice(theFile, theFormatter, pLines);</span>
<span class="nc" id="L277">        theFile.registerPrice(myPrice);</span>
<span class="nc" id="L278">    }</span>

    /**
     * QIF File section.
     */
<span class="nc" id="L283">    private enum MoneyWiseQIFSection {</span>
        /**
         * Classes.
         */
<span class="nc" id="L287">        CLASS(&quot;Class&quot;),</span>

        /**
         * Category.
         */
<span class="nc" id="L292">        CATEGORY(&quot;Cat&quot;),</span>

        /**
         * Account.
         */
<span class="nc" id="L297">        ACCOUNT(&quot;Account&quot;),</span>

        /**
         * Security.
         */
<span class="nc" id="L302">        SECURITY(&quot;Security&quot;),</span>

        /**
         * EVENT.
         */
<span class="nc" id="L307">        EVENT(null),</span>

        /**
         * Price.
         */
<span class="nc" id="L312">        PRICE(&quot;Prices&quot;);</span>

        /**
         * Type.
         */
        private final String theType;

        /**
         * Constructor.
         * @param pType the type
         */
<span class="nc" id="L323">        MoneyWiseQIFSection(final String pType) {</span>
<span class="nc" id="L324">            theType = pType;</span>
<span class="nc" id="L325">        }</span>

        /**
         * Determine section.
         * @param pLine the line to check
         * @return the section
         */
        private static MoneyWiseQIFSection determineType(final String pLine) {
            /* Loop through the values */
<span class="nc bnc" id="L334" title="All 2 branches missed.">            for (MoneyWiseQIFSection mySection : MoneyWiseQIFSection.values()) {</span>
                /* If we have a match */
<span class="nc bnc" id="L336" title="All 2 branches missed.">                if (pLine.equals(mySection.theType)) {</span>
<span class="nc" id="L337">                    return mySection;</span>
                }
            }

            /* Not found */
<span class="nc" id="L342">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>