<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseXReportTab.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.moneywise.atlas.ui.panel</a> &gt; <span class="el_source">MoneyWiseXReportTab.java</span></div><h1>MoneyWiseXReportTab.java</h1><pre class="source lang-java linenums">/*
 * MoneyWise: Finance Application
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.moneywise.atlas.ui.panel;

import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDateRange;
import io.github.tonywasher.joceanus.oceanus.event.OceanusEvent;
import io.github.tonywasher.joceanus.oceanus.event.OceanusEventManager;
import io.github.tonywasher.joceanus.oceanus.event.OceanusEventRegistrar;
import io.github.tonywasher.joceanus.oceanus.event.OceanusEventRegistrar.OceanusEventProvider;
import io.github.tonywasher.joceanus.oceanus.profile.OceanusProfile;
import io.github.tonywasher.joceanus.metis.report.MetisReportEvent;
import io.github.tonywasher.joceanus.metis.report.MetisReportHTMLBuilder;
import io.github.tonywasher.joceanus.metis.report.MetisReportManager;
import io.github.tonywasher.joceanus.metis.ui.MetisErrorPanel;
import io.github.tonywasher.joceanus.metis.viewer.MetisViewerEntry;
import io.github.tonywasher.joceanus.metis.viewer.MetisViewerManager;
import io.github.tonywasher.joceanus.moneywise.atlas.data.analysis.analyse.MoneyWiseXAnalysisManager;
import io.github.tonywasher.joceanus.moneywise.atlas.data.analysis.buckets.MoneyWiseXAnalysis;
import io.github.tonywasher.joceanus.moneywise.atlas.data.analysis.buckets.MoneyWiseXAnalysisSecurityBucket;
import io.github.tonywasher.joceanus.moneywise.atlas.reports.MoneyWiseXReportBuilder;
import io.github.tonywasher.joceanus.moneywise.atlas.reports.MoneyWiseXReportStyleSheet;
import io.github.tonywasher.joceanus.moneywise.atlas.reports.MoneyWiseXReportType;
import io.github.tonywasher.joceanus.moneywise.atlas.ui.controls.MoneyWiseXAnalysisSelect.MoneyWiseXStatementSelect;
import io.github.tonywasher.joceanus.moneywise.atlas.ui.controls.MoneyWiseXReportSelect;
import io.github.tonywasher.joceanus.moneywise.atlas.views.MoneyWiseXAnalysisFilter;
import io.github.tonywasher.joceanus.moneywise.atlas.views.MoneyWiseXAnalysisFilter.MoneyWiseXAnalysisSecurityFilter;
import io.github.tonywasher.joceanus.moneywise.exc.MoneyWiseDataException;
import io.github.tonywasher.joceanus.moneywise.ui.MoneyWiseGoToId;
import io.github.tonywasher.joceanus.moneywise.ui.MoneyWiseUIResource;
import io.github.tonywasher.joceanus.moneywise.views.MoneyWiseView;
import io.github.tonywasher.joceanus.prometheus.ui.PrometheusGoToEvent;
import io.github.tonywasher.joceanus.prometheus.views.PrometheusDataEvent;
import io.github.tonywasher.joceanus.prometheus.views.PrometheusViewerEntryId;
import io.github.tonywasher.joceanus.tethys.api.base.TethysUIComponent;
import io.github.tonywasher.joceanus.tethys.api.base.TethysUIEvent;
import io.github.tonywasher.joceanus.tethys.api.button.TethysUIDateRangeSelector;
import io.github.tonywasher.joceanus.tethys.api.control.TethysUIHTMLManager;
import io.github.tonywasher.joceanus.tethys.api.factory.TethysUIFactory;
import io.github.tonywasher.joceanus.tethys.api.pane.TethysUIBorderPaneManager;
import io.github.tonywasher.joceanus.tethys.api.pane.TethysUIPaneFactory;
import io.github.tonywasher.joceanus.tethys.api.pane.TethysUIScrollPaneManager;
import org.w3c.dom.Document;

/**
 * Report panel.
 */
public class MoneyWiseXReportTab
        implements OceanusEventProvider&lt;PrometheusDataEvent&gt;, TethysUIComponent {
    /**
     * Text for DataEntry Title.
     */
<span class="nc" id="L67">    private static final String NLS_DATAENTRY = MoneyWiseUIResource.REPORT_DATAENTRY.getValue();</span>

    /**
     * The Event Manager.
     */
    private final OceanusEventManager&lt;PrometheusDataEvent&gt; theEventManager;

    /**
     * The Data View.
     */
    private final MoneyWiseView theView;

    /**
     * The AnalysisManager.
     */
    private final MoneyWiseXAnalysisManager theAnalysisMgr;

    /**
     * The Panel.
     */
    private final TethysUIBorderPaneManager thePanel;

    /**
     * The HTML pane.
     */
    private final TethysUIHTMLManager theHTMLPane;

    /**
     * The Report selection Panel.
     */
    private final MoneyWiseXReportSelect theSelect;

    /**
     * The Spot Analysis Entry.
     */
    private final MetisViewerEntry theSpotEntry;

    /**
     * The Error Panel.
     */
    private final MetisErrorPanel theError;

    /**
     * The Report Manager.
     */
    private final MetisReportManager&lt;MoneyWiseXAnalysisFilter&lt;?, ?&gt;&gt; theManager;

    /**
     * The ReportBuilder.
     */
    private final MoneyWiseXReportBuilder theBuilder;

    /**
     * Constructor for Report Window.
     *
     * @param pView        the data view
     * @param pAnalysisMgr the analysisManager
     * @throws OceanusException on error
     */
    public MoneyWiseXReportTab(final MoneyWiseView pView,
<span class="nc" id="L127">                               final MoneyWiseXAnalysisManager pAnalysisMgr) throws OceanusException {</span>
        /* Store the view */
<span class="nc" id="L129">        theView = pView;</span>
<span class="nc" id="L130">        theAnalysisMgr = pAnalysisMgr;</span>

        /* Access GUI Factory */
<span class="nc" id="L133">        final TethysUIFactory&lt;?&gt; myFactory = pView.getGuiFactory();</span>

        /* Create the event manager */
<span class="nc" id="L136">        theEventManager = new OceanusEventManager&lt;&gt;();</span>

        /* Create the Panel */
<span class="nc" id="L139">        final TethysUIPaneFactory myPanes = myFactory.paneFactory();</span>
<span class="nc" id="L140">        thePanel = myPanes.newBorderPane();</span>

        /* Create the top level debug entry for this view */
<span class="nc" id="L143">        final MetisViewerManager myDataMgr = theView.getViewerManager();</span>
<span class="nc" id="L144">        final MetisViewerEntry mySection = theView.getViewerEntry(PrometheusViewerEntryId.VIEW);</span>
<span class="nc" id="L145">        final MetisViewerEntry myReport = myDataMgr.newEntry(mySection, NLS_DATAENTRY);</span>
<span class="nc" id="L146">        theSpotEntry = myDataMgr.newEntry(myReport, PrometheusViewerEntryId.ANALYSIS.toString());</span>
<span class="nc" id="L147">        theSpotEntry.setVisible(false);</span>

        /* Create the HTML Pane */
<span class="nc" id="L150">        theHTMLPane = myFactory.controlFactory().newHTMLManager();</span>

        /* Create Report Manager */
<span class="nc" id="L153">        theManager = new MetisReportManager&lt;&gt;(new MetisReportHTMLBuilder(pView.getDataFormatter()));</span>

        /* Create the report builder */
<span class="nc" id="L156">        theBuilder = new MoneyWiseXReportBuilder(theManager);</span>

        /* Create the Report Selection panel */
<span class="nc" id="L159">        theSelect = new MoneyWiseXReportSelect(myFactory);</span>

        /* Create the error panel for this view */
<span class="nc" id="L162">        theError = theView.getToolkit().getToolkit().newErrorPanel(myReport);</span>

        /* Create a scroll pane */
<span class="nc" id="L165">        final TethysUIScrollPaneManager myHTMLScroll = myPanes.newScrollPane();</span>
<span class="nc" id="L166">        myHTMLScroll.setContent(theHTMLPane);</span>

        /* Create the header panel */
<span class="nc" id="L169">        final TethysUIBorderPaneManager myHeader = myPanes.newBorderPane();</span>
<span class="nc" id="L170">        myHeader.setCentre(theSelect);</span>
<span class="nc" id="L171">        myHeader.setNorth(theError);</span>

        /* Now define the panel */
<span class="nc" id="L174">        thePanel.setNorth(myHeader);</span>
<span class="nc" id="L175">        thePanel.setCentre(myHTMLScroll);</span>

        /* Load the CSS */
<span class="nc" id="L178">        theHTMLPane.setCSSContent(MoneyWiseXReportStyleSheet.CSS_REPORT);</span>

        /* Create listeners */
<span class="nc" id="L181">        theView.getEventRegistrar().addEventListener(e -&gt; refreshData());</span>
<span class="nc" id="L182">        theManager.getEventRegistrar().addEventListener(this::handleGoToRequest);</span>
<span class="nc" id="L183">        theError.getEventRegistrar().addEventListener(e -&gt; handleErrorPane());</span>
<span class="nc" id="L184">        final OceanusEventRegistrar&lt;PrometheusDataEvent&gt; myRegistrar = theSelect.getEventRegistrar();</span>
<span class="nc" id="L185">        myRegistrar.addEventListener(PrometheusDataEvent.SELECTIONCHANGED, e -&gt; handleReportRequest());</span>
<span class="nc" id="L186">        myRegistrar.addEventListener(PrometheusDataEvent.PRINT, e -&gt; theHTMLPane.printIt());</span>
<span class="nc" id="L187">        myRegistrar.addEventListener(PrometheusDataEvent.SAVETOFILE, e -&gt; theHTMLPane.saveToFile());</span>
<span class="nc" id="L188">        theHTMLPane.getEventRegistrar().addEventListener(TethysUIEvent.BUILDPAGE, e -&gt; {</span>
<span class="nc" id="L189">            theManager.processReference(e.getDetails(String.class), theHTMLPane);</span>
<span class="nc" id="L190">            e.consume();</span>
<span class="nc" id="L191">        });</span>
<span class="nc" id="L192">    }</span>

    @Override
    public TethysUIComponent getUnderlying() {
<span class="nc" id="L196">        return thePanel;</span>
    }

    @Override
    public OceanusEventRegistrar&lt;PrometheusDataEvent&gt; getEventRegistrar() {
<span class="nc" id="L201">        return theEventManager.getEventRegistrar();</span>
    }

    @Override
    public void setEnabled(final boolean pEnabled) {
        /* Pass on to important elements */
<span class="nc" id="L207">        theSelect.setEnabled(pEnabled);</span>
<span class="nc" id="L208">        theError.setEnabled(pEnabled);</span>
<span class="nc" id="L209">        theHTMLPane.setEnabled(pEnabled);</span>
<span class="nc" id="L210">    }</span>

    @Override
    public void setVisible(final boolean pVisible) {
<span class="nc" id="L214">        thePanel.setVisible(pVisible);</span>
<span class="nc" id="L215">    }</span>

    /**
     * Refresh views/controls after a load/update of underlying data.
     */
    private void refreshData() {
        /* Obtain the active profile */
<span class="nc" id="L222">        OceanusProfile myTask = theView.getActiveTask();</span>
<span class="nc" id="L223">        myTask = myTask.startTask(&quot;Reports&quot;);</span>

        /* Protect against exceptions */
        try {
            /* Hide the instant debug since it is now invalid */
<span class="nc" id="L228">            theSpotEntry.setVisible(false);</span>

            /* Refresh the data */
<span class="nc" id="L231">            theSelect.setRange(theView.getRange());</span>
<span class="nc" id="L232">            theSelect.setSecurities(theView.hasActiveSecurities());</span>
<span class="nc" id="L233">            buildReport();</span>

            /* Create SavePoint */
<span class="nc" id="L236">            theSelect.createSavePoint();</span>
<span class="nc" id="L237">        } catch (OceanusException e) {</span>
            /* Show the error */
<span class="nc" id="L239">            theView.addError(e);</span>

            /* Restore SavePoint */
<span class="nc" id="L242">            theSelect.restoreSavePoint();</span>
<span class="nc" id="L243">        }</span>

        /* Complete the task */
<span class="nc" id="L246">        myTask.end();</span>
<span class="nc" id="L247">    }</span>

    /**
     * Build the report.
     *
     * @throws OceanusException on error
     */
    private void buildReport() throws OceanusException {
        /* Access the values from the selection */
<span class="nc" id="L256">        final MoneyWiseXReportType myReportType = theSelect.getReportType();</span>
<span class="nc" id="L257">        final OceanusDateRange myRange = theSelect.getDateRange();</span>
<span class="nc" id="L258">        final MoneyWiseXAnalysisSecurityBucket mySecurity = theSelect.getSecurity();</span>

        /* set lockDown of selection */
<span class="nc" id="L261">        theSelect.setEnabled(true);</span>

        /* Skip if we have no analysis */
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (theAnalysisMgr.isIdle()) {</span>
<span class="nc" id="L265">            theHTMLPane.setHTMLContent(&quot;&quot;, &quot;&quot;);</span>
<span class="nc" id="L266">            return;</span>
        }

        /* Access the appropriate analysis */
<span class="nc bnc" id="L270" title="All 2 branches missed.">        final MoneyWiseXAnalysis myAnalysis = myReportType.isPointInTime()</span>
<span class="nc" id="L271">                ? theAnalysisMgr.getDatedAnalysis(myRange.getEnd())</span>
<span class="nc" id="L272">                : theAnalysisMgr.getRangedAnalysis(myRange);</span>

        /* Record analysis and build report */
<span class="nc" id="L275">        theSelect.setAnalysis(myAnalysis);</span>
<span class="nc" id="L276">        final Document myDoc = theBuilder.createReport(myAnalysis, myReportType, mySecurity);</span>

        /* Declare to debugger */
<span class="nc" id="L279">        theSpotEntry.setObject(myAnalysis);</span>
<span class="nc" id="L280">        theSpotEntry.setVisible(true);</span>

        /* Declare the document */
<span class="nc" id="L283">        theManager.setDocument(myDoc);</span>

        /* Create initial display version */
<span class="nc" id="L286">        final String myText = theManager.formatXML();</span>
<span class="nc" id="L287">        theHTMLPane.setHTMLContent(myText, &quot;&quot;);</span>
<span class="nc" id="L288">    }</span>

    /**
     * handleErrorPane.
     */
    private void handleErrorPane() {
        /* Determine whether we have an error */
<span class="nc" id="L295">        final boolean isError = theError.hasError();</span>

        /* Hide selection panel on error */
<span class="nc bnc" id="L298" title="All 2 branches missed.">        theSelect.setVisible(!isError);</span>

        /* Lock HTML area */
<span class="nc bnc" id="L301" title="All 2 branches missed.">        theHTMLPane.setEnabled(!isError);</span>
<span class="nc" id="L302">    }</span>

    /**
     * handleGoToRequest.
     *
     * @param pEvent the event
     */
    private void handleGoToRequest(final OceanusEvent&lt;MetisReportEvent&gt; pEvent) {
        /* Access the filter */
<span class="nc" id="L311">        final MoneyWiseXAnalysisFilter&lt;?, ?&gt; myFilter = pEvent.getDetails(MoneyWiseXAnalysisFilter.class);</span>

        /* If we are currently showing Asset Gains */
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (MoneyWiseXReportType.ASSETGAINS.equals(theSelect.getReportType())) {</span>
            /* Select the capital gains report */
<span class="nc" id="L316">            final MoneyWiseXAnalysisSecurityBucket myBucket = ((MoneyWiseXAnalysisSecurityFilter) myFilter).getBucket();</span>
<span class="nc" id="L317">            theSelect.setSecurity(myBucket);</span>

            /* else we are selecting a statement */
<span class="nc" id="L320">        } else {</span>
            /* Create the details of the report */
<span class="nc" id="L322">            final TethysUIDateRangeSelector mySelect = theSelect.getDateRangeSelector();</span>
<span class="nc" id="L323">            final MoneyWiseXStatementSelect myStatement = new MoneyWiseXStatementSelect(mySelect, myFilter);</span>

            /* Request the action */
<span class="nc" id="L326">            theEventManager.fireEvent(PrometheusDataEvent.GOTOWINDOW, new PrometheusGoToEvent&lt;&gt;(MoneyWiseGoToId.STATEMENT, myStatement));</span>
        }
<span class="nc" id="L328">    }</span>

    /**
     * handleReportRequest.
     */
    private void handleReportRequest() {
        /* Protect against exceptions */
        try {
            /* build the report */
<span class="nc" id="L337">            buildReport();</span>

            /* Create SavePoint */
<span class="nc" id="L340">            theSelect.createSavePoint();</span>

            /* Catch Exceptions */
<span class="nc" id="L343">        } catch (OceanusException e) {</span>
            /* Build the error */
<span class="nc" id="L345">            final OceanusException myError = new MoneyWiseDataException(&quot;Failed to change selection&quot;, e);</span>

            /* Show the error */
<span class="nc" id="L348">            theError.addError(myError);</span>
<span class="nc" id="L349">            handleErrorPane();</span>

            /* Restore SavePoint */
<span class="nc" id="L352">            theSelect.restoreSavePoint();</span>
<span class="nc" id="L353">        }</span>
<span class="nc" id="L354">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>