<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseSecurityPrice.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.moneywise.data.basic</a> &gt; <span class="el_source">MoneyWiseSecurityPrice.java</span></div><h1>MoneyWiseSecurityPrice.java</h1><pre class="source lang-java linenums">/*
 * MoneyWise: Finance Application
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.moneywise.data.basic;

import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDate;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDateFormatter;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDateRange;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusPrice;
import io.github.tonywasher.joceanus.oceanus.format.OceanusDataFormatter;
import io.github.tonywasher.joceanus.metis.data.MetisDataDifference;
import io.github.tonywasher.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import io.github.tonywasher.joceanus.metis.data.MetisDataItem.MetisDataList;
import io.github.tonywasher.joceanus.metis.data.MetisDataResource;
import io.github.tonywasher.joceanus.metis.field.MetisFieldItem;
import io.github.tonywasher.joceanus.metis.field.MetisFieldSet;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurity.MoneyWiseSecurityList;
import io.github.tonywasher.joceanus.moneywise.exc.MoneyWiseDataException;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataInstanceMap;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataItem;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataMapItem;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataValues;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusEncryptedDataItem;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusEncryptedFieldSet;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusEncryptedPair;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusEncryptedValues;
import io.github.tonywasher.joceanus.prometheus.views.PrometheusEditSet;

import java.util.ArrayList;
import java.util.Currency;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;

/**
 * SecurityPrice data type.
 *
 * @author Tony Washer
 */
public class MoneyWiseSecurityPrice
        extends PrometheusEncryptedDataItem {
    /**
     * Object name.
     */
<span class="fc" id="L61">    public static final String OBJECT_NAME = MoneyWiseBasicDataType.SECURITYPRICE.getItemName();</span>

    /**
     * List name.
     */
<span class="fc" id="L66">    public static final String LIST_NAME = MoneyWiseBasicDataType.SECURITYPRICE.getListName();</span>

    /**
     * Report fields.
     */
<span class="fc" id="L71">    private static final PrometheusEncryptedFieldSet&lt;MoneyWiseSecurityPrice&gt; FIELD_DEFS = PrometheusEncryptedFieldSet.newEncryptedFieldSet(MoneyWiseSecurityPrice.class);</span>

    /*
     * FieldIds.
     */
    static {
<span class="fc" id="L77">        FIELD_DEFS.declareLinkField(MoneyWiseBasicDataType.SECURITY);</span>
<span class="fc" id="L78">        FIELD_DEFS.declareDateField(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE);</span>
<span class="fc" id="L79">        FIELD_DEFS.declareEncryptedPriceField(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE);</span>
    }

    /**
     * Invalid currency error.
     */
<span class="fc" id="L85">    public static final String ERROR_CURRENCY = MoneyWiseBasicResource.MONEYWISEDATA_ERROR_CURRENCY.getValue();</span>

    /**
     * Copy Constructor.
     *
     * @param pList  the list
     * @param pPrice The Price
     */
    protected MoneyWiseSecurityPrice(final MoneyWiseSecurityPriceBaseList&lt;? extends MoneyWiseSecurityPrice&gt; pList,
                                     final MoneyWiseSecurityPrice pPrice) {
        /* Set standard values */
<span class="fc" id="L96">        super(pList, pPrice);</span>
<span class="fc" id="L97">    }</span>

    /**
     * Edit Constructor.
     *
     * @param pList the list
     */
    public MoneyWiseSecurityPrice(final MoneyWiseSecurityPriceBaseList&lt;? extends MoneyWiseSecurityPrice&gt; pList) {
<span class="fc" id="L105">        super(pList, 0);</span>
<span class="fc" id="L106">        setNextDataKeySet();</span>
<span class="fc" id="L107">    }</span>

    /**
     * Values constructor.
     *
     * @param pList   the List to add to
     * @param pValues the values constructor
     * @throws OceanusException on error
     */
    private MoneyWiseSecurityPrice(final MoneyWiseSecurityPriceList pList,
                                   final PrometheusDataValues pValues) throws OceanusException {
        /* Initialise the item */
<span class="fc" id="L119">        super(pList, pValues);</span>

        /* Access formatter */
<span class="fc" id="L122">        final OceanusDataFormatter myFormatter = getDataSet().getDataFormatter();</span>

        /* Protect against exceptions */
        try {
            /* Store the Date */
<span class="fc" id="L127">            Object myValue = pValues.getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE);</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">            if (myValue instanceof OceanusDate d) {</span>
<span class="fc" id="L129">                setValueDate(d);</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L131">                final OceanusDateFormatter myParser = myFormatter.getDateFormatter();</span>
<span class="fc" id="L132">                setValueDate(myParser.parseDate(s));</span>
            }

            /* Store the Security */
<span class="fc" id="L136">            myValue = pValues.getValue(MoneyWiseBasicDataType.SECURITY);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            if (myValue instanceof Integer i) {</span>
<span class="fc" id="L138">                setValueSecurity(i);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L140">                setValueSecurity(s);</span>
            }

            /* Store the Price */
<span class="fc" id="L144">            myValue = pValues.getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">            if (myValue instanceof OceanusPrice p) {</span>
<span class="nc" id="L146">                setValuePrice(p);</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">            } else if (myValue instanceof byte[] ba) {</span>
<span class="fc" id="L148">                setValuePrice(ba);</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            } else if (myValue instanceof String myString) {</span>
<span class="fc" id="L150">                setValuePrice(myString);</span>
<span class="fc" id="L151">                setValuePrice(myFormatter.parseValue(myString, OceanusPrice.class));</span>
            }

            /* Catch Exceptions */
<span class="nc" id="L155">        } catch (IllegalArgumentException</span>
                 | OceanusException e) {
            /* Pass on exception */
<span class="nc" id="L158">            throw new MoneyWiseDataException(this, ERROR_CREATEITEM, e);</span>
<span class="fc" id="L159">        }</span>
<span class="fc" id="L160">    }</span>

    @Override
    public MetisFieldSetDef getDataFieldSet() {
<span class="fc" id="L164">        return FIELD_DEFS;</span>
    }

    @Override
    public boolean includeXmlField(final MetisDataFieldId pField) {
        /* Determine whether fields should be included */
<span class="fc bfc" id="L170" title="All 2 branches covered.">        if (MoneyWiseBasicDataType.SECURITY.equals(pField)) {</span>
<span class="fc" id="L171">            return true;</span>
        }
<span class="fc bfc" id="L173" title="All 2 branches covered.">        if (MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE.equals(pField)) {</span>
<span class="fc" id="L174">            return true;</span>
        }
<span class="fc bfc" id="L176" title="All 2 branches covered.">        if (MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE.equals(pField)) {</span>
<span class="fc" id="L177">            return true;</span>
        }

        /* Pass call on */
<span class="fc" id="L181">        return super.includeXmlField(pField);</span>
    }

    @Override
    public String toString() {
        /* Access Key Values */
<span class="nc" id="L187">        final PrometheusEncryptedValues myValues = getValues();</span>
<span class="nc" id="L188">        final Object mySecurity = myValues.getValue(MoneyWiseBasicDataType.SECURITY);</span>
<span class="nc" id="L189">        final Object myDate = myValues.getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE);</span>
<span class="nc" id="L190">        final Object myPrice = myValues.getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE, OceanusPrice.class);</span>

        /* Access formatter */
<span class="nc" id="L193">        final OceanusDataFormatter myFormatter = getDataSet().getDataFormatter();</span>

        /* Create string builder */
<span class="nc" id="L196">        final StringBuilder myBuilder = new StringBuilder();</span>
<span class="nc" id="L197">        myBuilder.append(myFormatter.formatObject(mySecurity));</span>
<span class="nc" id="L198">        myBuilder.append(&quot;: &quot;);</span>
<span class="nc" id="L199">        myBuilder.append(myFormatter.formatObject(myPrice));</span>
<span class="nc" id="L200">        myBuilder.append('@');</span>
<span class="nc" id="L201">        myBuilder.append(myFormatter.formatObject(myDate));</span>

        /* return it */
<span class="nc" id="L204">        return myBuilder.toString();</span>
    }

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L209">        return toString();</span>
    }

    /**
     * Obtain Price.
     *
     * @return the price
     */
    public OceanusPrice getPrice() {
<span class="fc" id="L218">        return getValues().getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE, OceanusPrice.class);</span>
    }

    /**
     * Obtain Encrypted Price.
     *
     * @return the Bytes
     */
    public byte[] getPriceBytes() {
<span class="fc" id="L227">        return getValues().getEncryptedBytes(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE);</span>
    }

    /**
     * Obtain Encrypted Price Field.
     *
     * @return the field
     */
    public PrometheusEncryptedPair getPriceField() {
<span class="nc" id="L236">        return getValues().getEncryptedPair(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE);</span>
    }

    /**
     * Obtain Date.
     *
     * @return the date
     */
    public OceanusDate getDate() {
<span class="fc" id="L245">        return getValues().getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE, OceanusDate.class);</span>
    }

    /**
     * Obtain Security.
     *
     * @return the security
     */
    public MoneyWiseSecurity getSecurity() {
<span class="fc" id="L254">        return getValues().getValue(MoneyWiseBasicDataType.SECURITY, MoneyWiseSecurity.class);</span>
    }

    /**
     * Obtain SecurityId.
     *
     * @return the securityId
     */
    public Integer getSecurityId() {
<span class="fc" id="L263">        final MoneyWiseSecurity mySecurity = getSecurity();</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">        return mySecurity == null</span>
<span class="nc" id="L265">                ? null</span>
<span class="fc" id="L266">                : mySecurity.getIndexedId();</span>
    }

    /**
     * Obtain SecurityName.
     *
     * @return the securityName
     */
    public String getSecurityName() {
<span class="nc" id="L275">        final MoneyWiseSecurity mySecurity = getSecurity();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        return mySecurity == null</span>
<span class="nc" id="L277">                ? null</span>
<span class="nc" id="L278">                : mySecurity.getName();</span>
    }

    /**
     * Set the security.
     *
     * @param pValue the security
     */
    private void setValueSecurity(final MoneyWiseSecurity pValue) {
<span class="fc" id="L287">        getValues().setUncheckedValue(MoneyWiseBasicDataType.SECURITY, pValue);</span>
<span class="fc" id="L288">    }</span>

    /**
     * Set the security id.
     *
     * @param pId the security id
     */
    private void setValueSecurity(final Integer pId) {
<span class="fc" id="L296">        getValues().setUncheckedValue(MoneyWiseBasicDataType.SECURITY, pId);</span>
<span class="fc" id="L297">    }</span>

    /**
     * Set the security name.
     *
     * @param pName the security name
     */
    private void setValueSecurity(final String pName) {
<span class="fc" id="L305">        getValues().setUncheckedValue(MoneyWiseBasicDataType.SECURITY, pName);</span>
<span class="fc" id="L306">    }</span>

    /**
     * Set the price.
     *
     * @param pValue the price
     * @throws OceanusException on error
     */
    private void setValuePrice(final OceanusPrice pValue) throws OceanusException {
<span class="fc" id="L315">        setEncryptedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE, pValue);</span>
<span class="fc" id="L316">    }</span>

    /**
     * Set the encrypted price.
     *
     * @param pBytes the encrypted price
     * @throws OceanusException on error
     */
    private void setValuePrice(final byte[] pBytes) throws OceanusException {
<span class="fc" id="L325">        setEncryptedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE, pBytes, OceanusPrice.class);</span>
<span class="fc" id="L326">    }</span>

    /**
     * Set the price.
     *
     * @param pValue the price
     */
    private void setValuePrice(final String pValue) {
<span class="fc" id="L334">        getValues().setUncheckedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE, pValue);</span>
<span class="fc" id="L335">    }</span>

    /**
     * Set the price.
     *
     * @param pValue the price
     */
    public void setValuePrice(final PrometheusEncryptedPair pValue) {
<span class="nc" id="L343">        getValues().setUncheckedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_PRICE, pValue);</span>
<span class="nc" id="L344">    }</span>

    /**
     * Set the date.
     *
     * @param pValue the date
     */
    private void setValueDate(final OceanusDate pValue) {
<span class="fc" id="L352">        getValues().setUncheckedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE, pValue);</span>
<span class="fc" id="L353">    }</span>

    @Override
    public MoneyWiseDataSet getDataSet() {
<span class="fc" id="L357">        return (MoneyWiseDataSet) super.getDataSet();</span>
    }

    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    public MoneyWiseSecurityPriceBaseList&lt;? extends MoneyWiseSecurityPrice&gt; getList() {
<span class="fc" id="L363">        return (MoneyWiseSecurityPriceBaseList&lt;? extends MoneyWiseSecurityPrice&gt;) super.getList();</span>
    }

    @Override
    public MoneyWiseSecurityPrice getBase() {
<span class="fc" id="L368">        return (MoneyWiseSecurityPrice) super.getBase();</span>
    }

    @Override
    public int compareValues(final PrometheusDataItem pThat) {
        /* Access as SecurityPrice */
<span class="fc" id="L374">        final MoneyWiseSecurityPrice myThat = (MoneyWiseSecurityPrice) pThat;</span>

        /* If header settings differ */
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">        if (isHeader() != pThat.isHeader()) {</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            return isHeader()</span>
<span class="nc" id="L379">                    ? -1</span>
<span class="nc" id="L380">                    : 1;</span>
        }

        /* If the date differs */
<span class="fc" id="L384">        final int iDiff = MetisDataDifference.compareObject(getDate(), myThat.getDate());</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">        if (iDiff != 0) {</span>
            /* Sort in reverse date order !! */
<span class="fc" id="L387">            return -iDiff;</span>
        }

        /* Compare the securities */
<span class="fc" id="L391">        return getSecurity().compareTo(myThat.getSecurity());</span>
    }

    @Override
    public void resolveDataSetLinks() throws OceanusException {
        /* Update the Encryption details */
<span class="fc" id="L397">        super.resolveDataSetLinks();</span>

        /* Resolve data links */
<span class="fc" id="L400">        final MoneyWiseDataSet myData = getDataSet();</span>
<span class="fc" id="L401">        resolveDataLink(MoneyWiseBasicDataType.SECURITY, myData.getSecurities());</span>
<span class="fc" id="L402">    }</span>

    /**
     * Resolve links in an editSet.
     *
     * @param pEditSet the edit Set
     * @throws OceanusException on error
     */
    protected void resolveEditSetLinks(final PrometheusEditSet pEditSet) throws OceanusException {
        /* Resolve parent within list */
<span class="fc" id="L412">        final MoneyWiseSecurityList mySecurities = pEditSet.getDataList(MoneyWiseBasicDataType.SECURITY, MoneyWiseSecurityList.class);</span>
<span class="fc" id="L413">        resolveDataLink(MoneyWiseBasicDataType.SECURITY, mySecurities);</span>
<span class="fc" id="L414">    }</span>

    /**
     * Set the security.
     *
     * @param pValue the security
     */
    public void setSecurity(final MoneyWiseSecurity pValue) {
<span class="fc" id="L422">        setValueSecurity(pValue);</span>
<span class="fc" id="L423">    }</span>

    /**
     * Set a new price.
     *
     * @param pPrice the price
     * @throws OceanusException on error
     */
    public void setPrice(final OceanusPrice pPrice) throws OceanusException {
<span class="fc" id="L432">        setValuePrice(pPrice);</span>
<span class="fc" id="L433">    }</span>

    /**
     * Set a new date.
     *
     * @param pDate the new date
     */
    public void setDate(final OceanusDate pDate) {
<span class="fc" id="L441">        setValueDate(pDate);</span>
<span class="fc" id="L442">    }</span>

    @Override
    public void touchUnderlyingItems() {
        /* touch the underlying security */
<span class="fc" id="L447">        getSecurity().touchItem(this);</span>
<span class="fc" id="L448">    }</span>

    @Override
    public void touchOnUpdate() {
        /* Touch security */
<span class="nc" id="L453">        getSecurity().touchItem(this);</span>
<span class="nc" id="L454">    }</span>

    @Override
    public boolean applyChanges(final PrometheusDataItem pPrice) {
        /* Can only update from a SecurityPrice */
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (!(pPrice instanceof MoneyWiseSecurityPrice)) {</span>
<span class="nc" id="L460">            return false;</span>
        }
<span class="nc" id="L462">        final MoneyWiseSecurityPrice myPrice = (MoneyWiseSecurityPrice) pPrice;</span>

        /* Store the current detail into history */
<span class="nc" id="L465">        pushHistory();</span>

        /* Update the price if required */
<span class="nc bnc" id="L468" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getPrice(), myPrice.getPrice())) {</span>
<span class="nc" id="L469">            setValuePrice(myPrice.getPriceField());</span>
        }

        /* Update the date if required */
<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getDate(), myPrice.getDate())) {</span>
<span class="nc" id="L474">            setValueDate(myPrice.getDate());</span>
        }

        /* Check for changes */
<span class="nc" id="L478">        return checkForHistory();</span>
    }

    @Override
    public void adjustMapForItem() {
<span class="fc" id="L483">        final MoneyWiseSecurityPriceBaseList&lt;? extends MoneyWiseSecurityPrice&gt; myList = getList();</span>
<span class="fc" id="L484">        final MoneyWiseSecurityPriceDataMap myMap = myList.getDataMap();</span>
<span class="fc" id="L485">        myMap.adjustForItem(this);</span>
<span class="fc" id="L486">    }</span>

    /**
     * Price List.
     *
     * @param &lt;T&gt; the data type
     */
    public abstract static class MoneyWiseSecurityPriceBaseList&lt;T extends MoneyWiseSecurityPrice&gt;
            extends PrometheusEncryptedList&lt;T&gt; {
        /*
         * Report fields.
         */
        static {
<span class="fc" id="L499">            MetisFieldSet.newFieldSet(MoneyWiseSecurityPriceBaseList.class);</span>
<span class="fc" id="L500">        }</span>

        /**
         * Construct an empty CORE Price list.
         *
         * @param pData     the DataSet for the list
         * @param pClass    the class of the item
         * @param pItemType the item type
         */
        protected MoneyWiseSecurityPriceBaseList(final MoneyWiseDataSet pData,
                                                 final Class&lt;T&gt; pClass,
                                                 final MoneyWiseBasicDataType pItemType) {
            /* Call super-constructor */
<span class="fc" id="L513">            super(pClass, pData, pItemType, PrometheusListStyle.CORE);</span>
<span class="fc" id="L514">        }</span>

        /**
         * Constructor for a cloned List.
         *
         * @param pSource the source List
         */
        protected MoneyWiseSecurityPriceBaseList(final MoneyWiseSecurityPriceBaseList&lt;T&gt; pSource) {
            /* Call super-constructor */
<span class="fc" id="L523">            super(pSource);</span>
<span class="fc" id="L524">        }</span>

        @Override
        public MoneyWiseSecurityPriceDataMap getDataMap() {
<span class="fc" id="L528">            return (MoneyWiseSecurityPriceDataMap) super.getDataMap();</span>
        }

        @Override
        protected MoneyWiseSecurityPriceDataMap allocateDataMap() {
<span class="fc" id="L533">            return new MoneyWiseSecurityPriceDataMap();</span>
        }
    }

    /**
     * Price List.
     */
    public static class MoneyWiseSecurityPriceList
            extends MoneyWiseSecurityPriceBaseList&lt;MoneyWiseSecurityPrice&gt; {
        /**
         * Report fields.
         */
<span class="fc" id="L545">        private static final MetisFieldSet&lt;MoneyWiseSecurityPriceList&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseSecurityPriceList.class);</span>

        /**
         * Construct an empty CORE price list.
         *
         * @param pData the DataSet for the list
         */
        protected MoneyWiseSecurityPriceList(final MoneyWiseDataSet pData) {
<span class="fc" id="L553">            super(pData, MoneyWiseSecurityPrice.class, MoneyWiseBasicDataType.SECURITYPRICE);</span>
<span class="fc" id="L554">        }</span>

        /**
         * Constructor for a cloned List.
         *
         * @param pSource the source List
         */
        private MoneyWiseSecurityPriceList(final MoneyWiseSecurityPriceList pSource) {
<span class="fc" id="L562">            super(pSource);</span>
<span class="fc" id="L563">        }</span>

        @Override
        public MetisFieldSet&lt;MoneyWiseSecurityPriceList&gt; getDataFieldSet() {
<span class="nc" id="L567">            return FIELD_DEFS;</span>
        }

        @Override
        public String listName() {
<span class="fc" id="L572">            return LIST_NAME;</span>
        }

        @Override
        public MetisFieldSetDef getItemFields() {
<span class="fc" id="L577">            return MoneyWiseSecurityPrice.FIELD_DEFS;</span>
        }

        @Override
        public MoneyWiseDataSet getDataSet() {
<span class="fc" id="L582">            return (MoneyWiseDataSet) super.getDataSet();</span>
        }

        @Override
        protected MoneyWiseSecurityPriceList getEmptyList(final PrometheusListStyle pStyle) {
<span class="fc" id="L587">            final MoneyWiseSecurityPriceList myList = new MoneyWiseSecurityPriceList(this);</span>
<span class="fc" id="L588">            myList.setStyle(pStyle);</span>
<span class="fc" id="L589">            return myList;</span>
        }

        /**
         * Construct an edit extract of a Rate list.
         *
         * @param pEditSet the editSet
         * @return the edit list
         * @throws OceanusException on error
         */
        public MoneyWiseSecurityPriceList deriveEditList(final PrometheusEditSet pEditSet) throws OceanusException {
            /* Build an empty List */
<span class="fc" id="L601">            final MoneyWiseSecurityPriceList myList = getEmptyList(PrometheusListStyle.EDIT);</span>
<span class="fc" id="L602">            myList.ensureMap();</span>
<span class="fc" id="L603">            pEditSet.setEditEntryList(MoneyWiseBasicDataType.SECURITYPRICE, myList);</span>

            /* Loop through the list */
<span class="fc" id="L606">            final Iterator&lt;MoneyWiseSecurityPrice&gt; myIterator = iterator();</span>
<span class="fc bfc" id="L607" title="All 2 branches covered.">            while (myIterator.hasNext()) {</span>
<span class="fc" id="L608">                final MoneyWiseSecurityPrice myCurr = myIterator.next();</span>

                /* Copy the item */
<span class="fc" id="L611">                final MoneyWiseSecurityPrice myItem = new MoneyWiseSecurityPrice(myList, myCurr);</span>
<span class="fc" id="L612">                myItem.resolveEditSetLinks(pEditSet);</span>
<span class="fc" id="L613">                myList.add(myItem);</span>

                /* Adjust the map */
<span class="fc" id="L616">                myItem.adjustMapForItem();</span>
<span class="fc" id="L617">            }</span>

            /* Return the List */
<span class="fc" id="L620">            return myList;</span>
        }

        /**
         * Add a new item to the core list.
         *
         * @param pPrice item
         * @return the newly added item
         */
        @Override
        public MoneyWiseSecurityPrice addCopyItem(final PrometheusDataItem pPrice) {
<span class="pc bpc" id="L631" title="1 of 2 branches missed.">            if (pPrice instanceof MoneyWiseSecurityPrice p) {</span>
<span class="fc" id="L632">                final MoneyWiseSecurityPrice myPrice = new MoneyWiseSecurityPrice(this, p);</span>
<span class="fc" id="L633">                add(myPrice);</span>
<span class="fc" id="L634">                return myPrice;</span>
            } else {
<span class="nc" id="L636">                throw new UnsupportedOperationException();</span>
            }
        }

        /**
         * Add a new item to the edit list.
         *
         * @return the newly added item
         */
        @Override
        public MoneyWiseSecurityPrice addNewItem() {
<span class="fc" id="L647">            final MoneyWiseSecurityPrice myPrice = new MoneyWiseSecurityPrice(this);</span>
<span class="fc" id="L648">            add(myPrice);</span>
<span class="fc" id="L649">            return myPrice;</span>
        }

        @Override
        public MoneyWiseSecurityPrice addValuesItem(final PrometheusDataValues pValues) throws OceanusException {
            /* Create the price */
<span class="fc" id="L655">            final MoneyWiseSecurityPrice myPrice = new MoneyWiseSecurityPrice(this, pValues);</span>

            /* Check that this PriceId has not been previously added */
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">            if (!isIdUnique(myPrice.getIndexedId())) {</span>
<span class="nc" id="L659">                myPrice.addError(ERROR_DUPLICATE, MetisDataResource.DATA_ID);</span>
<span class="nc" id="L660">                throw new MoneyWiseDataException(myPrice, ERROR_VALIDATION);</span>
            }

            /* Add to the list */
<span class="fc" id="L664">            add(myPrice);</span>

            /* Return it */
<span class="fc" id="L667">            return myPrice;</span>
        }
    }

    /**
     * The dataMap class.
     */
    public static class MoneyWiseSecurityPriceDataMap
            implements PrometheusDataMapItem, MetisFieldItem {
        /**
         * Report fields.
         */
        @SuppressWarnings(&quot;rawtypes&quot;)
<span class="fc" id="L680">        private static final MetisFieldSet&lt;MoneyWiseSecurityPriceDataMap&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseSecurityPriceDataMap.class);</span>

        /*
         * UnderlyingMap Field Id.
         */
        static {
<span class="fc" id="L686">            FIELD_DEFS.declareLocalField(MoneyWiseBasicResource.MONEYWISEDATA_MAP_MAPOFMAPS, MoneyWiseSecurityPriceDataMap::getMapOfMaps);</span>
<span class="fc" id="L687">            FIELD_DEFS.declareLocalField(MoneyWiseBasicResource.SECURITYPRICE_MAP_MAPOFPRICES, MoneyWiseSecurityPriceDataMap::getMapOfPrices);</span>
<span class="fc" id="L688">        }</span>

        /**
         * Map of Maps.
         */
        private final Map&lt;MoneyWiseSecurity, Map&lt;OceanusDate, Integer&gt;&gt; theMapOfMaps;

        /**
         * Map of Prices.
         */
        private final Map&lt;MoneyWiseSecurity, MoneyWiseSecurityPriceList&gt; theMapOfPrices;

        /**
         * Constructor.
         */
<span class="fc" id="L703">        public MoneyWiseSecurityPriceDataMap() {</span>
            /* Create the maps */
<span class="fc" id="L705">            theMapOfMaps = new HashMap&lt;&gt;();</span>
<span class="fc" id="L706">            theMapOfPrices = new HashMap&lt;&gt;();</span>
<span class="fc" id="L707">        }</span>

        @SuppressWarnings(&quot;rawtypes&quot;)
        @Override
        public MetisFieldSet&lt;MoneyWiseSecurityPriceDataMap&gt; getDataFieldSet() {
<span class="nc" id="L712">            return FIELD_DEFS;</span>
        }

        @Override
        public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L717">            return FIELD_DEFS.getName();</span>
        }

        /**
         * Obtain mapOfMaps.
         *
         * @return the map
         */
        private Map&lt;MoneyWiseSecurity, Map&lt;OceanusDate, Integer&gt;&gt; getMapOfMaps() {
<span class="nc" id="L726">            return theMapOfMaps;</span>
        }

        /**
         * Obtain mapOfPrices.
         *
         * @return the map
         */
        private Map&lt;MoneyWiseSecurity, MoneyWiseSecurityPriceList&gt; getMapOfPrices() {
<span class="nc" id="L735">            return theMapOfPrices;</span>
        }

        @Override
        public void resetMap() {
<span class="fc" id="L740">            theMapOfMaps.clear();</span>
<span class="fc" id="L741">            theMapOfPrices.clear();</span>
<span class="fc" id="L742">        }</span>

        @Override
        public void adjustForItem(final PrometheusDataItem pItem) {
            /* Access the Security Id */
<span class="fc" id="L747">            final MoneyWiseSecurityPrice myItem = (MoneyWiseSecurityPrice) pItem;</span>
<span class="fc" id="L748">            final MoneyWiseSecurity mySecurity = myItem.getSecurity();</span>
<span class="pc bpc" id="L749" title="1 of 2 branches missed.">            if (mySecurity == null) {</span>
<span class="nc" id="L750">                return;</span>
            }

            /* Access the map */
<span class="fc" id="L754">            final Map&lt;OceanusDate, Integer&gt; myMap = theMapOfMaps.computeIfAbsent(mySecurity, s -&gt; new HashMap&lt;&gt;());</span>

            /* Adjust price count */
<span class="fc" id="L757">            final OceanusDate myDate = myItem.getDate();</span>
<span class="fc" id="L758">            final Integer myCount = myMap.get(myDate);</span>
<span class="pc bpc" id="L759" title="1 of 2 branches missed.">            if (myCount == null) {</span>
<span class="fc" id="L760">                myMap.put(myDate, PrometheusDataInstanceMap.ONE);</span>
            } else {
<span class="nc" id="L762">                myMap.put(myDate, myCount + 1);</span>
            }

            /* Access the list */
<span class="fc" id="L766">            final MoneyWiseSecurityPriceList myList = theMapOfPrices.computeIfAbsent(mySecurity, MoneyWiseSecurityPriceList::new);</span>

            /* Add element to the list */
<span class="fc" id="L769">            myList.add(myItem);</span>
<span class="fc" id="L770">        }</span>

        /**
         * Check validity of Price.
         *
         * @param pItem the price
         * @return true/false
         */
        public boolean validPriceCount(final MoneyWiseSecurityPrice pItem) {
            /* Access the Details */
<span class="fc" id="L780">            final MoneyWiseSecurity mySecurity = pItem.getSecurity();</span>
<span class="fc" id="L781">            final OceanusDate myDate = pItem.getDate();</span>

            /* Access the map */
<span class="fc" id="L784">            final Map&lt;OceanusDate, Integer&gt; myMap = theMapOfMaps.get(mySecurity);</span>
<span class="pc bpc" id="L785" title="1 of 2 branches missed.">            if (myMap != null) {</span>
<span class="fc" id="L786">                final Integer myResult = myMap.get(myDate);</span>
<span class="fc" id="L787">                return PrometheusDataInstanceMap.ONE.equals(myResult);</span>
            }
<span class="nc" id="L789">            return false;</span>
        }

        /**
         * Check availability of date for a security.
         *
         * @param pSecurity the security
         * @param pDate     the key to look up
         * @return true/false
         */
        public boolean availableDate(final MoneyWiseSecurity pSecurity,
                                     final OceanusDate pDate) {
            /* Access the map */
<span class="nc" id="L802">            final Map&lt;OceanusDate, Integer&gt; myMap = theMapOfMaps.get(pSecurity);</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">            return myMap == null</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">                    || myMap.get(pDate) == null;</span>
        }

        /**
         * Obtain price for date.
         *
         * @param pSecurity the security
         * @param pDate     the date
         * @return the latest price for the date.
         */
        public OceanusPrice getPriceForDate(final MoneyWiseAssetBase pSecurity,
                                            final OceanusDate pDate) {
            /* Access as security */
<span class="nc" id="L817">            final MoneyWiseSecurity mySecurity = MoneyWiseSecurity.class.cast(pSecurity);</span>

            /* Access list for security */
<span class="nc" id="L820">            final MoneyWiseSecurityPriceList myList = theMapOfPrices.get(mySecurity);</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">            if (myList != null) {</span>
                /* Loop through the prices */
<span class="nc" id="L823">                final Iterator&lt;MoneyWiseSecurityPrice&gt; myIterator = myList.iterator();</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">                while (myIterator.hasNext()) {</span>
<span class="nc" id="L825">                    final MoneyWiseSecurityPrice myCurr = myIterator.next();</span>

                    /* Return this price if this is earlier or equal to the the date */
<span class="nc bnc" id="L828" title="All 2 branches missed.">                    if (pDate.compareTo(myCurr.getDate()) &gt;= 0) {</span>
<span class="nc" id="L829">                        return myCurr.getPrice();</span>
                    }
<span class="nc" id="L831">                }</span>
            }

            /* return single unit price */
<span class="nc" id="L835">            final Currency myCurrency = mySecurity.getCurrency();</span>
<span class="nc" id="L836">            return OceanusPrice.getWholeUnits(PrometheusDataInstanceMap.ONE, myCurrency);</span>
        }

        /**
         * Obtain prices for range.
         *
         * @param pSecurity the security
         * @param pRange    the date range
         * @return the two deep array of prices for the range.
         */
        public OceanusPrice[] getPricesForRange(final MoneyWiseSecurity pSecurity,
                                                final OceanusDateRange pRange) {
            /* Set price */
<span class="nc" id="L849">            final Currency myCurrency = pSecurity.getCurrency();</span>
<span class="nc" id="L850">            OceanusPrice myFirst = OceanusPrice.getWholeUnits(PrometheusDataInstanceMap.ONE, myCurrency);</span>
<span class="nc" id="L851">            OceanusPrice myLatest = myFirst;</span>
<span class="nc" id="L852">            final OceanusDate myStart = pRange.getStart();</span>

            /* Access list for security */
<span class="nc" id="L855">            final MoneyWiseSecurityPriceList myList = theMapOfPrices.get(pSecurity);</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">            if (myList != null) {</span>
                /* Loop through the prices */
<span class="nc" id="L858">                final ListIterator&lt;MoneyWiseSecurityPrice&gt; myIterator = myList.listIterator(myList.size());</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">                while (myIterator.hasPrevious()) {</span>
<span class="nc" id="L860">                    final MoneyWiseSecurityPrice myCurr = myIterator.previous();</span>

                    /* Check for the range of the date */
<span class="nc" id="L863">                    final OceanusDate myDate = myCurr.getDate();</span>
<span class="nc" id="L864">                    final int iComp = pRange.compareToDate(myDate);</span>

                    /* If this is later than the range we are finished */
<span class="nc bnc" id="L867" title="All 2 branches missed.">                    if (iComp &lt; 0) {</span>
<span class="nc" id="L868">                        break;</span>
                    }

                    /* Record as best price */
<span class="nc" id="L872">                    myLatest = myCurr.getPrice();</span>

                    /* Record early price */
<span class="nc bnc" id="L875" title="All 2 branches missed.">                    if (iComp &gt; 0</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">                            || myDate.compareTo(myStart) == 0) {</span>
<span class="nc" id="L877">                        myFirst = myLatest;</span>
                    }
<span class="nc" id="L879">                }</span>
            }

            /* Return the prices */
<span class="nc" id="L883">            return new OceanusPrice[]</span>
                    {myFirst, myLatest};
        }

        /**
         * Obtain priceList cursor.
         *
         * @param pSecurity the security
         * @return the latest price for the date.
         */
        public ListIterator&lt;MoneyWiseSecurityPrice&gt; priceIterator(final MoneyWiseSecurity pSecurity) {
            /* Access list for currency */
<span class="nc" id="L895">            final MoneyWiseSecurityPriceList myList = theMapOfPrices.get(pSecurity);</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">            return myList != null</span>
<span class="nc" id="L897">                    ? myList.listIterator(myList.size())</span>
<span class="nc" id="L898">                    : null;</span>
        }

        /**
         * Price List class.
         */
        private static final class MoneyWiseSecurityPriceList
                implements MetisFieldItem, MetisDataList&lt;MoneyWiseSecurityPrice&gt; {
            /**
             * Report fields.
             */
<span class="fc" id="L909">            private static final MetisFieldSet&lt;MoneyWiseSecurityPriceList&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseSecurityPriceList.class);</span>

            /*
             * UnderlyingMap Field Id.
             */
            static {
<span class="fc" id="L915">                FIELD_DEFS.declareLocalField(MetisDataResource.LIST_SIZE, MoneyWiseSecurityPriceList::size);</span>
<span class="fc" id="L916">            }</span>

            /**
             * The list.
             */
            private final List&lt;MoneyWiseSecurityPrice&gt; theList;

            /**
             * The security.
             */
            private final MoneyWiseSecurity theSecurity;

            /**
             * Constructor.
             *
             * @param pSecurity the security
             */
<span class="fc" id="L933">            private MoneyWiseSecurityPriceList(final MoneyWiseSecurity pSecurity) {</span>
<span class="fc" id="L934">                theSecurity = pSecurity;</span>
<span class="fc" id="L935">                theList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L936">            }</span>

            @Override
            public MetisFieldSet&lt;MoneyWiseSecurityPriceList&gt; getDataFieldSet() {
<span class="nc" id="L940">                return FIELD_DEFS;</span>
            }

            @Override
            public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L945">                return theSecurity.formatObject(pFormatter)</span>
                        + &quot;(&quot;
<span class="nc" id="L947">                        + size()</span>
                        + &quot;)&quot;;
            }

            @Override
            public String toString() {
<span class="nc" id="L953">                return theSecurity.toString()</span>
                        + &quot;(&quot;
<span class="nc" id="L955">                        + size()</span>
                        + &quot;)&quot;;
            }

            @Override
            public List&lt;MoneyWiseSecurityPrice&gt; getUnderlyingList() {
<span class="fc" id="L961">                return theList;</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>