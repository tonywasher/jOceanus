<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseAnalysisTaxBasisBucket.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.lethe.data.analysis.data</a> &gt; <span class="el_source">MoneyWiseAnalysisTaxBasisBucket.java</span></div><h1>MoneyWiseAnalysisTaxBasisBucket.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.lethe.data.analysis.data;

import net.sourceforge.joceanus.metis.data.MetisDataFieldValue;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataList;
import net.sourceforge.joceanus.metis.field.MetisFieldItem;
import net.sourceforge.joceanus.metis.field.MetisFieldItem.MetisFieldTableItem;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.metis.list.MetisListIndexed;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetDirection;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseCurrency;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseStaticDataType;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTaxBasis;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTaxBasis.MoneyWiseTaxBasisList;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTaxClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.base.MoneyWiseAnalysisHistory;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisTaxBasisAccountBucket.MoneyWiseAnalysisTaxBasisAccountBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisTaxBasisAttr;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisTaxBasisValues;
import net.sourceforge.joceanus.moneywise.tax.MoneyWiseChargeableGainSlice.MoneyWiseChargeableGainSliceList;
import net.sourceforge.joceanus.moneywise.tax.MoneyWiseTaxSource;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.date.OceanusDateRange;
import net.sourceforge.joceanus.oceanus.decimal.OceanusDecimal;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditSet;

import java.util.Currency;
import java.util.Iterator;
import java.util.List;

/**
 * The TaxBasis Bucket class.
 */
public class MoneyWiseAnalysisTaxBasisBucket
        implements MetisFieldTableItem {
    /**
     * Local Report fields.
     */
<span class="fc" id="L61">    private static final MetisFieldSet&lt;MoneyWiseAnalysisTaxBasisBucket&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseAnalysisTaxBasisBucket.class);</span>

    /*
     * Declare Fields.
     */
    static {
<span class="fc" id="L67">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_NAME, MoneyWiseAnalysisTaxBasisBucket::getAnalysis);</span>
<span class="fc" id="L68">        FIELD_DEFS.declareLocalField(MoneyWiseStaticDataType.TAXBASIS, MoneyWiseAnalysisTaxBasisBucket::getTaxBasis);</span>
<span class="fc" id="L69">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.BUCKET_BASEVALUES, MoneyWiseAnalysisTaxBasisBucket::getBaseValues);</span>
<span class="fc" id="L70">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.BUCKET_HISTORY, MoneyWiseAnalysisTaxBasisBucket::getHistoryMap);</span>
<span class="fc" id="L71">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.TAXBASIS_ACCOUNTLIST, MoneyWiseAnalysisTaxBasisBucket::getAccounts);</span>
<span class="fc" id="L72">        FIELD_DEFS.declareLocalFieldsForEnum(MoneyWiseAnalysisTaxBasisAttr.class, MoneyWiseAnalysisTaxBasisBucket::getAttributeValue);</span>
    }

    /**
     * Totals bucket name.
     */
<span class="fc" id="L78">    private static final MetisDataFieldId NAME_TOTALS = MoneyWiseAnalysisDataResource.ANALYSIS_TOTALS;</span>

    /**
     * The analysis.
     */
    private final MoneyWiseAnalysis theAnalysis;

    /**
     * Tax Basis.
     */
    private final MoneyWiseTaxBasis theTaxBasis;

    /**
     * Values.
     */
    private final MoneyWiseAnalysisTaxBasisValues theValues;

    /**
     * The base values.
     */
    private final MoneyWiseAnalysisTaxBasisValues theBaseValues;

    /**
     * History Map.
     */
    private final MoneyWiseAnalysisHistory&lt;MoneyWiseAnalysisTaxBasisValues, MoneyWiseAnalysisTaxBasisAttr&gt; theHistory;

    /**
     * Do we have accounts?
     */
    private final boolean hasAccounts;

    /**
     * Are we an expense bucket?
     */
    private final boolean isExpense;

    /**
     * AccountBucketList.
     */
    private final MoneyWiseAnalysisTaxBasisAccountBucketList theAccounts;

    /**
     * Constructor.
     * @param pAnalysis the analysis
     * @param pTaxBasis the basis
     */
    protected MoneyWiseAnalysisTaxBasisBucket(final MoneyWiseAnalysis pAnalysis,
<span class="fc" id="L126">                                              final MoneyWiseTaxBasis pTaxBasis) {</span>
        /* Store the parameters */
<span class="fc" id="L128">        theTaxBasis = pTaxBasis;</span>
<span class="fc" id="L129">        theAnalysis = pAnalysis;</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        isExpense = theTaxBasis != null</span>
<span class="pc bnc" id="L131" title="All 2 branches missed.">                &amp;&amp; theTaxBasis.getTaxClass().isExpense();</span>

        /* Create the history map */
<span class="fc" id="L134">        final MoneyWiseCurrency myDefault = theAnalysis.getCurrency();</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        final Currency myCurrency = myDefault == null</span>
<span class="fc" id="L136">                ? MoneyWiseAnalysisAccountBucket.DEFAULT_CURRENCY</span>
<span class="pc" id="L137">                : myDefault.getCurrency();</span>
<span class="fc" id="L138">        final MoneyWiseAnalysisTaxBasisValues myValues = new MoneyWiseAnalysisTaxBasisValues(myCurrency);</span>
<span class="fc" id="L139">        theHistory = new MoneyWiseAnalysisHistory&lt;&gt;(myValues);</span>

        /* Create the account list */
<span class="pc bpc" id="L142" title="3 of 4 branches missed.">        hasAccounts = theTaxBasis != null</span>
                &amp;&amp; !(this instanceof MoneyWiseAnalysisTaxBasisAccountBucket)
<span class="pc bnc" id="L144" title="All 2 branches missed.">                &amp;&amp; theTaxBasis.getTaxClass().analyseAccounts();</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        theAccounts = hasAccounts</span>
<span class="nc" id="L146">                ? new MoneyWiseAnalysisTaxBasisAccountBucketList(theAnalysis, this)</span>
<span class="fc" id="L147">                : null;</span>

        /* Access the key value maps */
<span class="fc" id="L150">        theValues = theHistory.getValues();</span>
<span class="fc" id="L151">        theBaseValues = theHistory.getBaseValues();</span>
<span class="fc" id="L152">    }</span>

    /**
     * Constructor.
     * @param pAnalysis the analysis
     * @param pBase the underlying bucket
     * @param pDate the date for the bucket
     */
    protected MoneyWiseAnalysisTaxBasisBucket(final MoneyWiseAnalysis pAnalysis,
                                              final MoneyWiseAnalysisTaxBasisBucket pBase,
<span class="nc" id="L162">                                              final OceanusDate pDate) {</span>
        /* Copy details from base */
<span class="nc" id="L164">        theTaxBasis = pBase.getTaxBasis();</span>
<span class="nc" id="L165">        theAnalysis = pAnalysis;</span>
<span class="nc" id="L166">        isExpense = pBase.isExpense();</span>

        /* Access the relevant history */
<span class="nc" id="L169">        theHistory = new MoneyWiseAnalysisHistory&lt;&gt;(pBase.getHistoryMap(), pDate);</span>

        /* Create the account list */
<span class="nc" id="L172">        hasAccounts = pBase.hasAccounts();</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        theAccounts = hasAccounts</span>
<span class="nc" id="L174">                ? new MoneyWiseAnalysisTaxBasisAccountBucketList(theAnalysis, this, pBase.getAccounts(), pDate)</span>
<span class="nc" id="L175">                : null;</span>

        /* Access the key value maps */
<span class="nc" id="L178">        theValues = theHistory.getValues();</span>
<span class="nc" id="L179">        theBaseValues = theHistory.getBaseValues();</span>
<span class="nc" id="L180">    }</span>

    /**
     * Constructor.
     * @param pAnalysis the analysis
     * @param pBase the underlying bucket
     * @param pRange the range for the bucket
     */
    protected MoneyWiseAnalysisTaxBasisBucket(final MoneyWiseAnalysis pAnalysis,
                                              final MoneyWiseAnalysisTaxBasisBucket pBase,
<span class="nc" id="L190">                                              final OceanusDateRange pRange) {</span>
        /* Copy details from base */
<span class="nc" id="L192">        theTaxBasis = pBase.getTaxBasis();</span>
<span class="nc" id="L193">        theAnalysis = pAnalysis;</span>
<span class="nc" id="L194">        isExpense = pBase.isExpense();</span>

        /* Access the relevant history */
<span class="nc" id="L197">        theHistory = new MoneyWiseAnalysisHistory&lt;&gt;(pBase.getHistoryMap(), pRange);</span>

        /* Create the account list */
<span class="nc" id="L200">        hasAccounts = pBase.hasAccounts();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        theAccounts = hasAccounts</span>
<span class="nc" id="L202">                ? new MoneyWiseAnalysisTaxBasisAccountBucketList(theAnalysis, this, pBase.getAccounts(), pRange)</span>
<span class="nc" id="L203">                : null;</span>

        /* Access the key value maps */
<span class="nc" id="L206">        theValues = theHistory.getValues();</span>
<span class="nc" id="L207">        theBaseValues = theHistory.getBaseValues();</span>
<span class="nc" id="L208">    }</span>

    @Override
    public MetisFieldSet&lt;? extends MoneyWiseAnalysisTaxBasisBucket&gt; getDataFieldSet() {
<span class="nc" id="L212">        return FIELD_DEFS;</span>
    }

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L217">        return toString();</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L222">        return getName();</span>
    }

    @Override
    public Integer getIndexedId() {
<span class="nc" id="L227">        return theTaxBasis.getIndexedId();</span>
    }

    /**
     * Obtain name.
     * @return the name
     */
    public String getName() {
<span class="nc bnc" id="L235" title="All 2 branches missed.">        return theTaxBasis == null</span>
<span class="nc" id="L236">                ? NAME_TOTALS.getId()</span>
<span class="nc" id="L237">                : theTaxBasis.getName();</span>
    }

    /**
     * Obtain tax basis.
     * @return the basis
     */
    public MoneyWiseTaxBasis getTaxBasis() {
<span class="nc" id="L245">        return theTaxBasis;</span>
    }

    /**
     * Do we have accounts.
     * @return true/false
     */
    public boolean hasAccounts() {
<span class="nc" id="L253">        return hasAccounts;</span>
    }

    /**
     * Is this an expense bucket.
     * @return true/false
     */
    public boolean isExpense() {
<span class="nc" id="L261">        return isExpense;</span>
    }

    /**
     * Obtain account list.
     * @return the account list
     */
    private MoneyWiseAnalysisTaxBasisAccountBucketList getAccounts() {
<span class="nc" id="L269">        return theAccounts;</span>
    }

    /**
     * Obtain account list iterator.
     * @return the iterator
     */
    public Iterator&lt;MoneyWiseAnalysisTaxBasisAccountBucket&gt; accountIterator() {
<span class="nc bnc" id="L277" title="All 2 branches missed.">        return hasAccounts</span>
<span class="nc" id="L278">                ? theAccounts.iterator()</span>
<span class="nc" id="L279">                : null;</span>
    }

    /**
     * find an account bucket.
     * @param pAccount the account
     * @return the bucket
     */
    public MoneyWiseAnalysisTaxBasisAccountBucket findAccountBucket(final MoneyWiseTransAsset pAccount) {
<span class="nc bnc" id="L288" title="All 2 branches missed.">        return hasAccounts</span>
<span class="nc" id="L289">                ? theAccounts.findBucket(pAccount)</span>
<span class="nc" id="L290">                : null;</span>
    }

    /**
     * Is this bucket idle?
     * @return true/false
     */
    public Boolean isIdle() {
<span class="nc" id="L298">        return theHistory.isIdle();</span>
    }

    /**
     * Obtain the value map.
     * @return the value map
     */
    public MoneyWiseAnalysisTaxBasisValues getValues() {
<span class="nc" id="L306">        return theValues;</span>
    }

    /**
     * Obtain the value for a particular attribute.
     * @param pAttr the attribute
     * @return the value
     */
    public OceanusMoney getMoneyValue(final MoneyWiseAnalysisTaxBasisAttr pAttr) {
<span class="nc" id="L315">        return theValues.getMoneyValue(pAttr);</span>
    }

    /**
     * Obtain the base value map.
     * @return the base value map
     */
    public MoneyWiseAnalysisTaxBasisValues getBaseValues() {
<span class="nc" id="L323">        return theBaseValues;</span>
    }

    /**
     * Obtain values for transaction.
     * @param pTrans the event
     * @return the values (or null)
     */
    public MoneyWiseAnalysisTaxBasisValues getValuesForTransaction(final MoneyWiseTransaction pTrans) {
        /* Obtain values for event */
<span class="nc" id="L333">        return theHistory.getValuesForTransaction(pTrans);</span>
    }

    /**
     * Obtain previous values for transaction.
     * @param pTrans the transaction
     * @return the values (or null)
     */
    public MoneyWiseAnalysisTaxBasisValues getPreviousValuesForTransaction(final MoneyWiseTransaction pTrans) {
<span class="nc" id="L342">        return theHistory.getPreviousValuesForTransaction(pTrans);</span>
    }

    /**
     * Obtain delta for transaction.
     * @param pTrans the transaction
     * @param pAttr the attribute
     * @return the delta (or null)
     */
    public OceanusDecimal getDeltaForTransaction(final MoneyWiseTransaction pTrans,
                                                 final MoneyWiseAnalysisTaxBasisAttr pAttr) {
        /* Obtain delta for event */
<span class="nc" id="L354">        return theHistory.getDeltaValue(pTrans, pAttr);</span>
    }

    /**
     * Obtain the history map.
     * @return the history map
     */
    private MoneyWiseAnalysisHistory&lt;MoneyWiseAnalysisTaxBasisValues, MoneyWiseAnalysisTaxBasisAttr&gt; getHistoryMap() {
<span class="nc" id="L362">        return theHistory;</span>
    }

    /**
     * Obtain the analysis.
     * @return the analysis
     */
    protected MoneyWiseAnalysis getAnalysis() {
<span class="nc" id="L370">        return theAnalysis;</span>
    }

    /**
     * Obtain date range.
     * @return the range
     */
    public OceanusDateRange getDateRange() {
<span class="nc" id="L378">        return theAnalysis.getDateRange();</span>
    }

    /**
     * Set Attribute.
     * @param pAttr the attribute
     * @param pValue the value of the attribute
     */
    protected void setValue(final MoneyWiseAnalysisTaxBasisAttr pAttr,
                            final OceanusMoney pValue) {
        /* Set the value into the list */
<span class="nc" id="L389">        theValues.setValue(pAttr, pValue);</span>
<span class="nc" id="L390">    }</span>

    /**
     * Get an attribute value.
     * @param pAttr the attribute
     * @return the value to set
     */
    private Object getAttributeValue(final MoneyWiseAnalysisTaxBasisAttr pAttr) {
        /* Access value of object */
<span class="nc" id="L399">        final Object myValue = getValue(pAttr);</span>

        /* Return the value */
<span class="nc bnc" id="L402" title="All 2 branches missed.">        return myValue != null</span>
<span class="nc" id="L403">                ? myValue</span>
<span class="nc" id="L404">                : MetisDataFieldValue.SKIP;</span>
    }

    /**
     * Obtain an attribute value.
     * @param pAttr the attribute
     * @return the value of the attribute or null
     */
    private Object getValue(final MoneyWiseAnalysisTaxBasisAttr pAttr) {
        /* Obtain the attribute */
<span class="nc" id="L414">        return theValues.getValue(pAttr);</span>
    }

    /**
     * Add income transaction.
     * @param pTrans the transaction
     */
    protected void addIncomeTransaction(final MoneyWiseAnalysisTransactionHelper pTrans) {
        /* Access details */
<span class="nc" id="L423">        final OceanusMoney myAmount = pTrans.getCreditAmount();</span>
<span class="nc" id="L424">        final OceanusMoney myTaxCredit = pTrans.getTaxCredit();</span>
<span class="nc" id="L425">        final OceanusMoney myNatIns = pTrans.getEmployeeNatIns();</span>
<span class="nc" id="L426">        final OceanusMoney myBenefit = pTrans.getDeemedBenefit();</span>
<span class="nc" id="L427">        final OceanusMoney myWithheld = pTrans.getWithheld();</span>

        /* Determine style of transaction */
<span class="nc" id="L430">        MoneyWiseAssetDirection myDir = pTrans.getDirection();</span>

        /* If the account is special */
<span class="nc" id="L433">        final MoneyWiseTransCategoryClass myClass = pTrans.getCategoryClass();</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">        if (myClass.isSwitchDirection()) {</span>
            /* switch the direction */
<span class="nc" id="L436">            myDir = myDir.reverse();</span>
        }

        /* Obtain zeroed counters */
<span class="nc" id="L440">        OceanusMoney myGross = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L441">        myGross = new OceanusMoney(myGross);</span>
<span class="nc" id="L442">        myGross.setZero();</span>
<span class="nc" id="L443">        final OceanusMoney myNett = new OceanusMoney(myGross);</span>
<span class="nc" id="L444">        final OceanusMoney myTax = new OceanusMoney(myGross);</span>

        /* If this is an expense */
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (myDir.isTo()) {</span>
            /* Adjust the gross and net */
<span class="nc" id="L449">            myGross.subtractAmount(myAmount);</span>
<span class="nc" id="L450">            myNett.subtractAmount(myAmount);</span>

            /* If we have a tax credit */
<span class="nc bnc" id="L453" title="All 2 branches missed.">            if (myTaxCredit != null</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                    &amp;&amp; myTaxCredit.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L456">                myGross.subtractAmount(myTaxCredit);</span>
<span class="nc" id="L457">                myTax.subtractAmount(myTaxCredit);</span>
            }

            /* If we have a natInsurance payment */
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if (myNatIns != null</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                    &amp;&amp; myNatIns.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L464">                myGross.subtractAmount(myNatIns);</span>
            }

            /* If we have a Benefit payment */
<span class="nc bnc" id="L468" title="All 2 branches missed.">            if (myBenefit != null</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                    &amp;&amp; myBenefit.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L471">                myGross.subtractAmount(myBenefit);</span>
            }

            /* If we have a Withheld */
<span class="nc bnc" id="L475" title="All 2 branches missed.">            if (myWithheld != null</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                    &amp;&amp; myWithheld.isNonZero()) {</span>
                /* Adjust the gross and net */
<span class="nc" id="L478">                myGross.subtractAmount(myWithheld);</span>
<span class="nc" id="L479">                myNett.subtractAmount(myWithheld);</span>
            }

            /* else this is a standard income */
        } else {
            /* Adjust the gross and net */
<span class="nc" id="L485">            myGross.addAmount(myAmount);</span>
<span class="nc" id="L486">            myNett.addAmount(myAmount);</span>

            /* If we have a tax credit */
<span class="nc bnc" id="L489" title="All 2 branches missed.">            if (myTaxCredit != null</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">                    &amp;&amp; myTaxCredit.isNonZero()) {</span>
                /* Adjust the values */
<span class="nc" id="L492">                myGross.addAmount(myTaxCredit);</span>
<span class="nc" id="L493">                myTax.addAmount(myTaxCredit);</span>
            }

            /* If we have a natInsurance payment */
<span class="nc bnc" id="L497" title="All 2 branches missed.">            if (myNatIns != null</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">                    &amp;&amp; myNatIns.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L500">                myGross.addAmount(myNatIns);</span>
            }

            /* If we have a Benefit payment */
<span class="nc bnc" id="L504" title="All 2 branches missed.">            if (myBenefit != null</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                    &amp;&amp; myBenefit.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L507">                myGross.addAmount(myBenefit);</span>
            }

            /* If we have a Withheld */
<span class="nc bnc" id="L511" title="All 2 branches missed.">            if (myWithheld != null</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">                    &amp;&amp; myWithheld.isNonZero()) {</span>
                /* Adjust the gross and net */
<span class="nc" id="L514">                myGross.addAmount(myWithheld);</span>
<span class="nc" id="L515">                myNett.addAmount(myWithheld);</span>
            }
        }

        /* Register the delta values */
<span class="nc" id="L520">        registerDeltaValues(pTrans, myGross, myNett, myTax);</span>

        /* If we have accounts */
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (hasAccounts) {</span>
            /* register the changes against the accounts */
<span class="nc" id="L525">            theAccounts.registerDeltaValues(pTrans, myGross, myNett, myTax);</span>
        }
<span class="nc" id="L527">    }</span>

    /**
     * Add expense transaction.
     * @param pTrans the transaction
     */
    protected void addExpenseTransaction(final MoneyWiseAnalysisTransactionHelper pTrans) {
        /* Access details */
<span class="nc" id="L535">        final OceanusMoney myAmount = pTrans.getDebitAmount();</span>
<span class="nc" id="L536">        final OceanusMoney myTaxCredit = pTrans.getTaxCredit();</span>

        /* Determine style of event */
<span class="nc" id="L539">        final MoneyWiseAssetDirection myDir = pTrans.getDirection();</span>

        /* Obtain zeroed counters */
<span class="nc" id="L542">        OceanusMoney myGross = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L543">        myGross = new OceanusMoney(myGross);</span>
<span class="nc" id="L544">        myGross.setZero();</span>
<span class="nc" id="L545">        final OceanusMoney myNett = new OceanusMoney(myGross);</span>
<span class="nc" id="L546">        final OceanusMoney myTax = new OceanusMoney(myGross);</span>

        /* If this is a refunded expense */
<span class="nc bnc" id="L549" title="All 2 branches missed.">        if (myDir.isFrom()) {</span>
            /* Adjust the gross and net */
<span class="nc" id="L551">            myGross.addAmount(myAmount);</span>
<span class="nc" id="L552">            myNett.addAmount(myAmount);</span>

            /* If we have a tax relief */
<span class="nc bnc" id="L555" title="All 2 branches missed.">            if (myTaxCredit != null</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">                    &amp;&amp; myTaxCredit.isNonZero()) {</span>
                /* Adjust the values */
<span class="nc" id="L558">                myGross.addAmount(myTaxCredit);</span>
<span class="nc" id="L559">                myNett.addAmount(myTaxCredit);</span>
<span class="nc" id="L560">                myTax.addAmount(myTaxCredit);</span>
            }

            /* else this is a standard expense */
        } else {
            /* Adjust the gross and net */
<span class="nc" id="L566">            myGross.subtractAmount(myAmount);</span>
<span class="nc" id="L567">            myNett.subtractAmount(myAmount);</span>

            /* If we have a tax relief */
<span class="nc bnc" id="L570" title="All 2 branches missed.">            if (myTaxCredit != null</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                    &amp;&amp; myTaxCredit.isNonZero()) {</span>
                /* Adjust the values */
<span class="nc" id="L573">                myGross.subtractAmount(myTaxCredit);</span>
<span class="nc" id="L574">                myNett.subtractAmount(myTaxCredit);</span>
<span class="nc" id="L575">                myTax.subtractAmount(myTaxCredit);</span>
            }
        }

        /* Register the delta values */
<span class="nc" id="L580">        registerDeltaValues(pTrans, myGross, myNett, myTax);</span>

        /* If we have accounts */
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if (hasAccounts) {</span>
            /* register the changes against the accounts */
<span class="nc" id="L585">            theAccounts.registerDeltaValues(pTrans, myGross, myNett, myTax);</span>
        }
<span class="nc" id="L587">    }</span>

    /**
     * Register delta transaction value.
     * @param pTrans the transaction helper
     * @param pGross the gross delta value
     * @param pNett the net delta value
     * @param pTax the tax delta value
     */
    protected void registerDeltaValues(final MoneyWiseAnalysisTransactionHelper pTrans,
                                       final OceanusMoney pGross,
                                       final OceanusMoney pNett,
                                       final OceanusMoney pTax) {
        /* If we have a change to the gross value */
<span class="nc bnc" id="L601" title="All 2 branches missed.">        if (pGross.isNonZero()) {</span>
            /* Adjust Gross figure */
<span class="nc" id="L603">            OceanusMoney myGross = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L604">            myGross = new OceanusMoney(myGross);</span>
<span class="nc" id="L605">            myGross.addAmount(pGross);</span>
<span class="nc" id="L606">            setValue(MoneyWiseAnalysisTaxBasisAttr.GROSS, myGross);</span>
        }

        /* If we have a change to the net value */
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (pNett.isNonZero()) {</span>
            /* Adjust Net figure */
<span class="nc" id="L612">            OceanusMoney myNett = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.NETT);</span>
<span class="nc" id="L613">            myNett = new OceanusMoney(myNett);</span>
<span class="nc" id="L614">            myNett.addAmount(pNett);</span>
<span class="nc" id="L615">            setValue(MoneyWiseAnalysisTaxBasisAttr.NETT, myNett);</span>
        }

        /* If we have a change to the tax value */
<span class="nc bnc" id="L619" title="All 2 branches missed.">        if (pTax.isNonZero()) {</span>
            /* Adjust Tax figure */
<span class="nc" id="L621">            OceanusMoney myTax = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.TAXCREDIT);</span>
<span class="nc" id="L622">            myTax = new OceanusMoney(myTax);</span>
<span class="nc" id="L623">            myTax.addAmount(pTax);</span>
<span class="nc" id="L624">            setValue(MoneyWiseAnalysisTaxBasisAttr.TAXCREDIT, myTax);</span>
        }

        /* Register the transaction */
<span class="nc" id="L628">        registerTransaction(pTrans);</span>
<span class="nc" id="L629">    }</span>

    /**
     * Adjust transaction value.
     * @param pTrans the transaction
     * @param pValue the value
     * @param pAdjust adjustment control
     */
    protected void adjustValue(final MoneyWiseAnalysisTransactionHelper pTrans,
                               final OceanusMoney pValue,
                               final MoneyWiseTaxBasisAdjust pAdjust) {
        /* Adjust the value */
<span class="nc" id="L641">        adjustValue(pValue, pAdjust);</span>

        /* Register the transaction */
<span class="nc" id="L644">        registerTransaction(pTrans);</span>

        /* If we have accounts */
<span class="nc bnc" id="L647" title="All 2 branches missed.">        if (hasAccounts) {</span>
            /* register the adjustment against the accounts */
<span class="nc" id="L649">            theAccounts.adjustValue(pTrans, pValue, pAdjust);</span>
        }
<span class="nc" id="L651">    }</span>

    /**
     * Adjust value.
     * @param pValue the value
     * @param pAdjust adjustment control
     */
    protected void adjustValue(final OceanusMoney pValue,
                               final MoneyWiseTaxBasisAdjust pAdjust) {
        /* If we are adjusting Gross */
<span class="nc bnc" id="L661" title="All 2 branches missed.">        if (pAdjust.adjustGross()) {</span>
            /* Access the existing value */
<span class="nc" id="L663">            OceanusMoney myGross = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L664">            myGross = new OceanusMoney(myGross);</span>

            /* Subtract or add the value depending as to whether we are an expense bucket */
<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (isExpense) {</span>
<span class="nc" id="L668">                myGross.subtractAmount(pValue);</span>
            } else {
<span class="nc" id="L670">                myGross.addAmount(pValue);</span>
            }

            /* Record the new value */
<span class="nc" id="L674">            setValue(MoneyWiseAnalysisTaxBasisAttr.GROSS, myGross);</span>
        }

        /* If we are adjusting Nett */
<span class="nc bnc" id="L678" title="All 2 branches missed.">        if (pAdjust.adjustNett()) {</span>
            /* Access the existing value */
<span class="nc" id="L680">            OceanusMoney myNett = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.NETT);</span>
<span class="nc" id="L681">            myNett = new OceanusMoney(myNett);</span>

            /* Subtract or add the value depending as to whether we are an expense bucket */
<span class="nc bnc" id="L684" title="All 2 branches missed.">            if (isExpense) {</span>
<span class="nc" id="L685">                myNett.subtractAmount(pValue);</span>
            } else {
<span class="nc" id="L687">                myNett.addAmount(pValue);</span>
            }

            /* Record the new value */
<span class="nc" id="L691">            setValue(MoneyWiseAnalysisTaxBasisAttr.NETT, myNett);</span>
        }
<span class="nc" id="L693">    }</span>

    /**
     * Register the transaction.
     * @param pTrans the transaction helper
     */
    protected void registerTransaction(final MoneyWiseAnalysisTransactionHelper pTrans) {
        /* Register the transaction in the history */
<span class="nc" id="L701">        theHistory.registerTransaction(pTrans.getTransaction(), theValues);</span>
<span class="nc" id="L702">    }</span>

    /**
     * Add values.
     * @param pBucket tax category bucket
     */
    protected void addValues(final MoneyWiseAnalysisTaxBasisBucket pBucket) {
        /* Add the values */
<span class="nc" id="L710">        OceanusMoney myAmount = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L711">        myAmount.addAmount(pBucket.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS));</span>
<span class="nc" id="L712">        myAmount = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.NETT);</span>
<span class="nc" id="L713">        myAmount.addAmount(pBucket.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.NETT));</span>
<span class="nc" id="L714">    }</span>

    /**
     * Adjust to base.
     */
    protected void adjustToBase() {
        /* Adjust to base values */
<span class="nc" id="L721">        theValues.adjustToBaseValues(theBaseValues);</span>
<span class="nc" id="L722">        theBaseValues.resetBaseValues();</span>
<span class="nc" id="L723">    }</span>

    /**
     * Is the bucket active?
     * @return true/false
     */
    public boolean isActive() {
<span class="nc" id="L730">        return theValues.isActive();</span>
    }

    /**
     * Value adjust Modes.
     */
<span class="nc" id="L736">    protected enum MoneyWiseTaxBasisAdjust {</span>
        /**
         * Adjust both Gross and Nett.
         */
<span class="nc" id="L740">        STANDARD,</span>

        /**
         * Only adjust Nett figure.
         */
<span class="nc" id="L745">        NETT,</span>

        /**
         * Only adjust Gross figure.
         */
<span class="nc" id="L750">        GROSS;</span>

        /**
         * should we adjust Gross?
         * @return true/false
         */
        private boolean adjustGross() {
<span class="nc bnc" id="L757" title="All 2 branches missed.">            return this != NETT;</span>
        }

        /**
         * should we adjust Nett?
         * @return true/false
         */
        private boolean adjustNett() {
<span class="nc bnc" id="L765" title="All 2 branches missed.">            return this != GROSS;</span>
        }
    }

    /**
     * TaxBasisBucketList class.
     */
    public static class MoneyWiseAnalysisTaxBasisBucketList
            implements MetisFieldItem, MoneyWiseTaxSource, MetisDataList&lt;MoneyWiseAnalysisTaxBasisBucket&gt; {
        /**
         * Local Report fields.
         */
<span class="fc" id="L777">        private static final MetisFieldSet&lt;MoneyWiseAnalysisTaxBasisBucketList&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseAnalysisTaxBasisBucketList.class);</span>

        /*
         * Declare Fields.
         */
        static {
<span class="fc" id="L783">            FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_NAME, MoneyWiseAnalysisTaxBasisBucketList::getAnalysis);</span>
<span class="fc" id="L784">            FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_CHARGES, MoneyWiseAnalysisTaxBasisBucketList::getGainSlices);</span>
<span class="fc" id="L785">            FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_TOTALS, MoneyWiseAnalysisTaxBasisBucketList::getTotals);</span>
<span class="fc" id="L786">        }</span>

        /**
         * The analysis.
         */
        private final MoneyWiseAnalysis theAnalysis;

        /**
         * The list.
         */
        private final MetisListIndexed&lt;MoneyWiseAnalysisTaxBasisBucket&gt; theList;

        /**
         * The editSet.
         */
        private final PrometheusEditSet theEditSet;

        /**
         * The chargeableGains.
         */
        private final MoneyWiseChargeableGainSliceList theCharges;

        /**
         * The tax basis.
         */
        private final MoneyWiseAnalysisTaxBasisBucket theTotals;

        /**
         * Construct a top-level List.
         * @param pAnalysis the analysis
         * @param pGains the new Gains list
         */
        private MoneyWiseAnalysisTaxBasisBucketList(final MoneyWiseAnalysis pAnalysis,
<span class="fc" id="L819">                                                    final MoneyWiseChargeableGainSliceList pGains) {</span>
<span class="fc" id="L820">            theAnalysis = pAnalysis;</span>
<span class="fc" id="L821">            theEditSet = theAnalysis.getEditSet();</span>
<span class="fc" id="L822">            theCharges = pGains;</span>
<span class="fc" id="L823">            theTotals = allocateTotalsBucket();</span>
<span class="fc" id="L824">            theList = new MetisListIndexed&lt;&gt;();</span>
<span class="pc" id="L825">            theList.setComparator((l, r) -&gt; l.getTaxBasis().compareTo(r.getTaxBasis()));</span>
<span class="fc" id="L826">        }</span>

        /**
         * Construct a top-level List.
         * @param pAnalysis the analysis
         */
        protected MoneyWiseAnalysisTaxBasisBucketList(final MoneyWiseAnalysis pAnalysis) {
<span class="fc" id="L833">            this(pAnalysis, new MoneyWiseChargeableGainSliceList());</span>
<span class="fc" id="L834">        }</span>

        /**
         * Construct a dated List.
         * @param pAnalysis the analysis
         * @param pBase the base list
         * @param pDate the Date
         */
        protected MoneyWiseAnalysisTaxBasisBucketList(final MoneyWiseAnalysis pAnalysis,
                                                      final MoneyWiseAnalysisTaxBasisBucketList pBase,
                                                      final OceanusDate pDate) {
            /* Initialise class */
<span class="nc" id="L846">            this(pAnalysis, new MoneyWiseChargeableGainSliceList(pBase.getGainSlices(), pAnalysis.getDateRange()));</span>

            /* Loop through the buckets */
<span class="nc" id="L849">            final Iterator&lt;MoneyWiseAnalysisTaxBasisBucket&gt; myIterator = pBase.iterator();</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L851">                final MoneyWiseAnalysisTaxBasisBucket myCurr = myIterator.next();</span>

                /* Access the bucket for this date */
<span class="nc" id="L854">                final MoneyWiseAnalysisTaxBasisBucket myBucket = new MoneyWiseAnalysisTaxBasisBucket(pAnalysis, myCurr, pDate);</span>

                /* If the bucket is non-idle */
<span class="nc bnc" id="L857" title="All 2 branches missed.">                if (Boolean.FALSE.equals(myBucket.isIdle())) {</span>
                    /* Calculate the delta and add to the list */
<span class="nc" id="L859">                    theList.add(myBucket);</span>
                }
<span class="nc" id="L861">            }</span>
<span class="nc" id="L862">        }</span>

        /**
         * Construct a ranged List.
         * @param pAnalysis the analysis
         * @param pBase the base list
         * @param pRange the Date Range
         */
        protected MoneyWiseAnalysisTaxBasisBucketList(final MoneyWiseAnalysis pAnalysis,
                                                      final MoneyWiseAnalysisTaxBasisBucketList pBase,
                                                      final OceanusDateRange pRange) {
            /* Initialise class */
<span class="nc" id="L874">            this(pAnalysis, new MoneyWiseChargeableGainSliceList(pBase.getGainSlices(), pAnalysis.getDateRange()));</span>

            /* Loop through the buckets */
<span class="nc" id="L877">            final Iterator&lt;MoneyWiseAnalysisTaxBasisBucket&gt; myIterator = pBase.iterator();</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L879">                final MoneyWiseAnalysisTaxBasisBucket myCurr = myIterator.next();</span>

                /* Access the bucket for this range */
<span class="nc" id="L882">                final MoneyWiseAnalysisTaxBasisBucket myBucket = new MoneyWiseAnalysisTaxBasisBucket(pAnalysis, myCurr, pRange);</span>

                /* If the bucket is non-idle */
<span class="nc bnc" id="L885" title="All 2 branches missed.">                if (Boolean.FALSE.equals(myBucket.isIdle())) {</span>
                    /* Adjust to the base */
<span class="nc" id="L887">                    myBucket.adjustToBase();</span>
<span class="nc" id="L888">                    theList.add(myBucket);</span>
                }
<span class="nc" id="L890">            }</span>
<span class="nc" id="L891">        }</span>

        @Override
        public MetisFieldSet&lt;MoneyWiseAnalysisTaxBasisBucketList&gt; getDataFieldSet() {
<span class="nc" id="L895">            return FIELD_DEFS;</span>
        }

        @Override
        public List&lt;MoneyWiseAnalysisTaxBasisBucket&gt; getUnderlyingList() {
<span class="fc" id="L900">            return theList.getUnderlyingList();</span>
        }

        @Override
        public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L905">            return getDataFieldSet().getName();</span>
        }

        /**
         * Obtain the analysis.
         * @return the analysis
         */
        protected MoneyWiseAnalysis getAnalysis() {
<span class="nc" id="L913">            return theAnalysis;</span>
        }

        /**
         * Obtain item by id.
         * @param pId the id to lookup
         * @return the item (or null if not present)
         */
        public MoneyWiseAnalysisTaxBasisBucket findItemById(final Integer pId) {
            /* Return results */
<span class="nc" id="L923">            return theList.getItemById(pId);</span>
        }

        @Override
        public MoneyWiseChargeableGainSliceList getGainSlices() {
<span class="nc" id="L928">            return theCharges;</span>
        }

        /**
         * Obtain the Totals.
         * @return the totals bucket
         */
        public MoneyWiseAnalysisTaxBasisBucket getTotals() {
<span class="nc" id="L936">            return theTotals;</span>
        }

        /**
         * Allocate the Totals EventCategoryBucket.
         * @return the bucket
         */
        private MoneyWiseAnalysisTaxBasisBucket allocateTotalsBucket() {
            /* Obtain the totals category */
<span class="fc" id="L945">            return new MoneyWiseAnalysisTaxBasisBucket(theAnalysis, null);</span>
        }

        /**
         * Obtain the TaxBasisBucket for a given taxBasis.
         * @param pClass the taxBasis
         * @return the bucket
         */
        public MoneyWiseAnalysisTaxBasisBucket getBucket(final MoneyWiseTaxClass pClass) {
            /* Locate the bucket in the list */
<span class="nc" id="L955">            final MoneyWiseTaxBasis myBasis = theEditSet.getDataList(MoneyWiseStaticDataType.TAXBASIS, MoneyWiseTaxBasisList.class).findItemByClass(pClass);</span>
<span class="nc" id="L956">            MoneyWiseAnalysisTaxBasisBucket myItem = findItemById(myBasis.getIndexedId());</span>

            /* If the item does not yet exist */
<span class="nc bnc" id="L959" title="All 2 branches missed.">            if (myItem == null) {</span>
                /* Create the new bucket */
<span class="nc" id="L961">                myItem = new MoneyWiseAnalysisTaxBasisBucket(theAnalysis, myBasis);</span>

                /* Add to the list */
<span class="nc" id="L964">                theList.add(myItem);</span>
            }

            /* Return the bucket */
<span class="nc" id="L968">            return myItem;</span>
        }

        /**
         * Obtain the matching BasisBucket.
         * @param pTaxBasis the taxBasis
         * @return the matching bucket
         */
        public MoneyWiseAnalysisTaxBasisBucket getMatchingBasis(final MoneyWiseAnalysisTaxBasisBucket pTaxBasis) {
            /* Access the matching taxBasis bucket */
<span class="nc" id="L978">            MoneyWiseAnalysisTaxBasisBucket myBasis = findItemById(pTaxBasis.getTaxBasis().getIndexedId());</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">            if (myBasis == null) {</span>
<span class="nc" id="L980">                myBasis = new MoneyWiseAnalysisTaxBasisBucket(theAnalysis, pTaxBasis.getTaxBasis());</span>
            }

            /* If we are matching a TaxBasisAccount Bucket */
<span class="nc bnc" id="L984" title="All 2 branches missed.">            if (pTaxBasis instanceof MoneyWiseAnalysisTaxBasisAccountBucket) {</span>
                /* Look up the asset bucket */
<span class="nc" id="L986">                final MoneyWiseTransAsset myAsset = ((MoneyWiseAnalysisTaxBasisAccountBucket) pTaxBasis).getAccount();</span>
<span class="nc" id="L987">                MoneyWiseAnalysisTaxBasisAccountBucket myAccountBucket = myBasis.findAccountBucket(myAsset);</span>

                /* If there is no such bucket in the analysis */
<span class="nc bnc" id="L990" title="All 2 branches missed.">                if (myAccountBucket == null) {</span>
                    /* Allocate an orphan bucket */
<span class="nc" id="L992">                    myAccountBucket = new MoneyWiseAnalysisTaxBasisAccountBucket(theAnalysis, myBasis, myAsset);</span>
                }

                /* Set bucket as the account bucket */
<span class="nc" id="L996">                myBasis = myAccountBucket;</span>
            }

            /* Return the basis */
<span class="nc" id="L1000">            return myBasis;</span>
        }

        /**
         * Obtain the default BasisBucket.
         * @return the default bucket
         */
        public MoneyWiseAnalysisTaxBasisBucket getDefaultBasis() {
            /* Return the first basis in the list if it exists */
<span class="nc bnc" id="L1009" title="All 2 branches missed.">            return isEmpty()</span>
<span class="nc" id="L1010">                    ? null</span>
<span class="nc" id="L1011">                    : theList.getUnderlyingList().get(0);</span>
        }

        /**
         * Adjust basis buckets.
         * @param pTrans the transaction helper
         * @param pCategory primary category
         */
        protected void adjustBasis(final MoneyWiseAnalysisTransactionHelper pTrans,
                                   final MoneyWiseTransCategory pCategory) {
            /* Switch on the category type */
<span class="nc bnc" id="L1022" title="All 18 branches missed.">            switch (pCategory.getCategoryTypeClass()) {</span>
                case TAXEDINCOME:
                case GROSSINCOME:
<span class="nc" id="L1025">                    addIncome(pTrans, MoneyWiseTaxClass.SALARY);</span>
<span class="nc" id="L1026">                    break;</span>
                case OTHERINCOME:
<span class="nc" id="L1028">                    addIncome(pTrans, MoneyWiseTaxClass.OTHERINCOME);</span>
<span class="nc" id="L1029">                    break;</span>
                case INTEREST:
                case TAXEDINTEREST:
                case TAXEDLOYALTYBONUS:
<span class="nc" id="L1033">                    addIncome(pTrans, MoneyWiseTaxClass.TAXEDINTEREST);</span>
<span class="nc" id="L1034">                    break;</span>
                case GROSSINTEREST:
                case GROSSLOYALTYBONUS:
<span class="nc" id="L1037">                    addIncome(pTrans, MoneyWiseTaxClass.UNTAXEDINTEREST);</span>
<span class="nc" id="L1038">                    break;</span>
                case PEER2PEERINTEREST:
<span class="nc" id="L1040">                    addIncome(pTrans, MoneyWiseTaxClass.PEER2PEERINTEREST);</span>
<span class="nc" id="L1041">                    break;</span>
                case DIVIDEND:
                case SHAREDIVIDEND:
<span class="nc" id="L1044">                    addIncome(pTrans, MoneyWiseTaxClass.DIVIDEND);</span>
<span class="nc" id="L1045">                    break;</span>
                case UNITTRUSTDIVIDEND:
<span class="nc" id="L1047">                    addIncome(pTrans, MoneyWiseTaxClass.UNITTRUSTDIVIDEND);</span>
<span class="nc" id="L1048">                    break;</span>
                case FOREIGNDIVIDEND:
<span class="nc" id="L1050">                    addIncome(pTrans, MoneyWiseTaxClass.FOREIGNDIVIDEND);</span>
<span class="nc" id="L1051">                    break;</span>
                case RENTALINCOME:
<span class="nc" id="L1053">                    addIncome(pTrans, MoneyWiseTaxClass.RENTALINCOME);</span>
<span class="nc" id="L1054">                    break;</span>
                case ROOMRENTALINCOME:
<span class="nc" id="L1056">                    addIncome(pTrans, MoneyWiseTaxClass.ROOMRENTAL);</span>
<span class="nc" id="L1057">                    break;</span>
                case INCOMETAX:
<span class="nc" id="L1059">                    addExpense(pTrans, MoneyWiseTaxClass.TAXPAID);</span>
<span class="nc" id="L1060">                    break;</span>
                case TAXFREEINTEREST:
                case TAXFREEDIVIDEND:
                case LOANINTERESTEARNED:
                case INHERITED:
                case CASHBACK:
                case LOYALTYBONUS:
                case TAXFREELOYALTYBONUS:
                case GIFTEDINCOME:
<span class="nc" id="L1069">                    addIncome(pTrans, MoneyWiseTaxClass.TAXFREE);</span>
<span class="nc" id="L1070">                    break;</span>
                case PENSIONCONTRIB:
<span class="nc" id="L1072">                    addIncome(pTrans, MoneyWiseTaxClass.TAXFREE);</span>
<span class="nc" id="L1073">                    break;</span>
                case BADDEBTCAPITAL:
<span class="nc" id="L1075">                    addExpense(pTrans, MoneyWiseTaxClass.CAPITALGAINS);</span>
<span class="nc" id="L1076">                    break;</span>
                case BADDEBTINTEREST:
<span class="nc" id="L1078">                    addExpense(pTrans, MoneyWiseTaxClass.PEER2PEERINTEREST);</span>
<span class="nc" id="L1079">                    break;</span>
                case EXPENSE:
                case LOCALTAXES:
                case WRITEOFF:
                case LOANINTERESTCHARGED:
                case TAXRELIEF:
                case RECOVEREDEXPENSES:
<span class="nc" id="L1086">                    addExpense(pTrans, MoneyWiseTaxClass.EXPENSE);</span>
<span class="nc" id="L1087">                    break;</span>
                case RENTALEXPENSE:
<span class="nc" id="L1089">                    addExpense(pTrans, MoneyWiseTaxClass.RENTALINCOME);</span>
<span class="nc" id="L1090">                    break;</span>
                case UNITSADJUST:
                case SECURITYREPLACE:
                case STOCKTAKEOVER:
                case STOCKSPLIT:
                case STOCKDEMERGER:
                case STOCKRIGHTSISSUE:
                case PORTFOLIOXFER:
                case TRANSFER:
                default:
                    break;
            }
<span class="nc" id="L1102">        }</span>

        /**
         * Adjust basis for income.
         * @param pClass the class
         * @param pTrans the transaction
         */
        private void addIncome(final MoneyWiseAnalysisTransactionHelper pTrans,
                               final MoneyWiseTaxClass pClass) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1112">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1113">            myBucket.addIncomeTransaction(pTrans);</span>
<span class="nc" id="L1114">        }</span>

        /**
         * Adjust basis for expense.
         * @param pClass the class
         * @param pTrans the transaction
         */
        private void addExpense(final MoneyWiseAnalysisTransactionHelper pTrans,
                                final MoneyWiseTaxClass pClass) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1124">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1125">            myBucket.addExpenseTransaction(pTrans);</span>
<span class="nc" id="L1126">        }</span>

        /**
         * Adjust basis buckets.
         * @param pTrans the transaction
         * @param pClass the class
         * @param pIncome the income
         */
        protected void adjustValue(final MoneyWiseAnalysisTransactionHelper pTrans,
                                   final MoneyWiseTaxClass pClass,
                                   final OceanusMoney pIncome) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1138">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1139">            myBucket.adjustValue(pTrans, pIncome, MoneyWiseTaxBasisAdjust.STANDARD);</span>
<span class="nc" id="L1140">        }</span>

        /**
         * Adjust basis buckets for Gross only.
         * @param pTrans the transaction
         * @param pClass the class
         * @param pIncome the income
         */
        protected void adjustGrossValue(final MoneyWiseAnalysisTransactionHelper pTrans,
                                        final MoneyWiseTaxClass pClass,
                                        final OceanusMoney pIncome) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1152">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1153">            myBucket.adjustValue(pTrans, pIncome, MoneyWiseTaxBasisAdjust.GROSS);</span>
<span class="nc" id="L1154">        }</span>

        /**
         * Adjust basis buckets for Nett only.
         * @param pTrans the transaction
         * @param pClass the class
         * @param pIncome the income
         */
        protected void adjustNettValue(final MoneyWiseAnalysisTransactionHelper pTrans,
                                       final MoneyWiseTaxClass pClass,
                                       final OceanusMoney pIncome) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1166">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1167">            myBucket.adjustValue(pTrans, pIncome, MoneyWiseTaxBasisAdjust.NETT);</span>
<span class="nc" id="L1168">        }</span>

        /**
         * Adjust autoExpense.
         * @param pTrans the transaction
         * @param isExpense true/false
         */
        public void adjustAutoExpense(final MoneyWiseAnalysisTransactionHelper pTrans,
                                      final boolean isExpense) {
            /* Determine value */
<span class="nc" id="L1178">            OceanusMoney myAmount = pTrans.getLocalAmount();</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">            if (!isExpense) {</span>
<span class="nc" id="L1180">                myAmount = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1181">                myAmount.negate();</span>
            }

            /* Access the bucket and adjust it */
<span class="nc" id="L1185">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(MoneyWiseTaxClass.EXPENSE);</span>
<span class="nc" id="L1186">            myBucket.adjustValue(pTrans, myAmount, MoneyWiseTaxBasisAdjust.STANDARD);</span>
<span class="nc" id="L1187">        }</span>

        /**
         * Adjust for market growth.
         * @param pIncome the income
         * @param pExpense the expense
         */
        protected void adjustMarket(final OceanusMoney pIncome,
                                    final OceanusMoney pExpense) {
            /* Calculate the delta */
<span class="nc" id="L1197">            final OceanusMoney myDelta = new OceanusMoney(pIncome);</span>
<span class="nc" id="L1198">            myDelta.subtractAmount(pExpense);</span>

            /* Access the bucket and adjust it */
<span class="nc" id="L1201">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(MoneyWiseTaxClass.MARKET);</span>
<span class="nc" id="L1202">            myBucket.adjustValue(myDelta, MoneyWiseTaxBasisAdjust.STANDARD);</span>
<span class="nc" id="L1203">        }</span>

        /**
         * record ChargeableGain.
         * @param pTrans the transaction
         * @param pGain the gain
         */
        public void recordChargeableGain(final MoneyWiseTransaction pTrans,
                                         final OceanusMoney pGain) {
            /* record the chargeable gain */
<span class="nc" id="L1213">            theCharges.addTransaction(pTrans, pGain);</span>
<span class="nc" id="L1214">        }</span>

        /**
         * produce Totals.
         */
        protected void produceTotals() {
            /* Loop through the buckets */
<span class="fc" id="L1221">            final Iterator&lt;MoneyWiseAnalysisTaxBasisBucket&gt; myIterator = iterator();</span>
<span class="pc bpc" id="L1222" title="1 of 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L1223">                final MoneyWiseAnalysisTaxBasisBucket myBucket = myIterator.next();</span>

                /* Sort the accounts */
<span class="nc bnc" id="L1226" title="All 2 branches missed.">                if (myBucket.hasAccounts()) {</span>
<span class="nc" id="L1227">                    myBucket.getAccounts().sortBuckets();</span>
                }

                /* Adjust the Total Profit buckets */
<span class="nc" id="L1231">                theTotals.addValues(myBucket);</span>
<span class="nc" id="L1232">            }</span>

            /* Sort the bases */
<span class="fc" id="L1235">            theList.sortList();</span>
<span class="fc" id="L1236">        }</span>

        /**
         * Prune the list to remove irrelevant items.
         */
        protected void prune() {
            /* Loop through the buckets */
<span class="nc" id="L1243">            final Iterator&lt;MoneyWiseAnalysisTaxBasisBucket&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L1245">                final MoneyWiseAnalysisTaxBasisBucket myCurr = myIterator.next();</span>

                /* Remove the bucket if it is inactive */
<span class="nc bnc" id="L1248" title="All 2 branches missed.">                if (!myCurr.isActive()) {</span>
<span class="nc" id="L1249">                    myIterator.remove();</span>
                }
<span class="nc" id="L1251">            }</span>
<span class="nc" id="L1252">        }</span>

        @Override
        public OceanusMoney getAmountForTaxBasis(final MoneyWiseTaxClass pBasis) {
            /* Access the bucket */
<span class="nc" id="L1257">            final MoneyWiseAnalysisTaxBasisBucket myItem = findItemById(pBasis.getClassId());</span>

            /* If the bucket is not found */
<span class="nc bnc" id="L1260" title="All 2 branches missed.">            if (myItem == null) {</span>
<span class="nc" id="L1261">                final MoneyWiseCurrency myAssetCurrency = theAnalysis.getCurrency();</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">                final Currency myCurrency = myAssetCurrency == null</span>
<span class="nc" id="L1263">                        ? OceanusMoney.getDefaultCurrency()</span>
<span class="nc" id="L1264">                        : myAssetCurrency.getCurrency();</span>
<span class="nc" id="L1265">                return new OceanusMoney(myCurrency);</span>
            }

<span class="nc" id="L1268">            return myItem.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>