<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseAnalysisTransactionHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.lethe.data.analysis.data</a> &gt; <span class="el_source">MoneyWiseAnalysisTransactionHelper.java</span></div><h1>MoneyWiseAnalysisTransactionHelper.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.lethe.data.analysis.data;

import java.util.Currency;

import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetDirection;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurity;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseCurrency;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.decimal.OceanusPrice;
import net.sourceforge.joceanus.oceanus.decimal.OceanusRatio;
import net.sourceforge.joceanus.oceanus.decimal.OceanusUnits;

/**
 * Transaction Analysis Helper.
 */
public class MoneyWiseAnalysisTransactionHelper {
    /**
     * Currency Cursor.
     */
    private final MoneyWiseAnalysisExchangeRateCursor theRateCursor;

    /**
     * Security Cursor.
     */
    private final MoneyWiseAnalysisSecurityPriceCursor thePriceCursor;

    /**
     * Reporting currency.
     */
    private final MoneyWiseCurrency theCurrency;

    /**
     * The current transaction.
     */
    private MoneyWiseTransaction theCurrent;

    /**
     * The current date.
     */
    private OceanusDate theDate;

    /**
     * The account detail.
     */
    private TransactionDetail theAccountDetail;

    /**
     * The debit XchangeRate.
     */
    private OceanusRatio theDebitXchangeRate;

    /**
     * Constructor.
     * @param pData the dataSet
     */
<span class="fc" id="L80">    public MoneyWiseAnalysisTransactionHelper(final MoneyWiseDataSet pData) {</span>
        /* Create the cursors */
<span class="fc" id="L82">        theRateCursor = new MoneyWiseAnalysisExchangeRateCursor(pData);</span>
<span class="fc" id="L83">        thePriceCursor = new MoneyWiseAnalysisSecurityPriceCursor(pData);</span>

        /* Note the reporting currency */
<span class="fc" id="L86">        theCurrency = pData.getReportingCurrency();</span>
<span class="fc" id="L87">    }</span>

    /**
     * Obtain transaction.
     * @return the transaction
     */
    public MoneyWiseTransaction getTransaction() {
<span class="nc" id="L94">        return theCurrent;</span>
    }

    /**
     * Set the transaction.
     * @param pTrans the transaction.
     */
    public void setTransaction(final MoneyWiseTransaction pTrans) {
        /* Record date */
<span class="nc" id="L103">        theCurrent = pTrans;</span>
<span class="nc" id="L104">        theDate = theCurrent.getDate();</span>

        /* Reset details */
<span class="nc" id="L107">        theAccountDetail = new TransactionDetail();</span>
<span class="nc" id="L108">        theDebitXchangeRate = theAccountDetail.getDebitExchangeRate();</span>
<span class="nc" id="L109">    }</span>

    /**
     * Set the security (for PortfolioXfer).
     * @param pSecurity the security.
     */
    public void setSecurity(final MoneyWiseSecurity pSecurity) {
<span class="nc" id="L116">        final MoneyWiseCurrency myCurr = pSecurity.getAssetCurrency();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        final boolean isForeign = !MetisDataDifference.isEqual(myCurr, theCurrency);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        theDebitXchangeRate = isForeign ? theRateCursor.getExchangeRate(myCurr, theDate) : null;</span>
<span class="nc" id="L119">    }</span>

    /**
     * Obtain date.
     * @return the date
     */
    public OceanusDate getDate() {
<span class="nc" id="L126">        return theDate;</span>
    }

    /**
     * Obtain account.
     * @return the account
     */
    public MoneyWiseTransAsset getAccount() {
<span class="nc" id="L134">        return theAccountDetail.getAccount();</span>
    }

    /**
     * Obtain partner.
     * @return the partner
     */
    public MoneyWiseTransAsset getPartner() {
<span class="nc" id="L142">        return theAccountDetail.getPartner();</span>
    }

    /**
     * Obtain direction.
     * @return the direction
     */
    public MoneyWiseAssetDirection getDirection() {
<span class="nc" id="L150">        return theAccountDetail.getDirection();</span>
    }

    /**
     * Obtain debit asset.
     * @return the debit asset
     */
    public MoneyWiseTransAsset getDebitAsset() {
<span class="nc" id="L158">        return theAccountDetail.getDebitAsset();</span>
    }

    /**
     * Obtain credit asset.
     * @return the credit asset
     */
    public MoneyWiseTransAsset getCreditAsset() {
<span class="nc" id="L166">        return theAccountDetail.getCreditAsset();</span>
    }

    /**
     * Obtain the category.
     * @return the category
     */
    public MoneyWiseTransCategory getCategory() {
<span class="nc" id="L174">        return theAccountDetail.getCategory();</span>
    }

    /**
     * Is this a particular category class?
     * @param pClass the category class
     * @return true/false
     */
    public boolean isCategoryClass(final MoneyWiseTransCategoryClass pClass) {
<span class="nc" id="L183">        return theAccountDetail.isCategoryClass(pClass);</span>
    }

    /**
     * Obtain the category class.
     * @return the category class
     */
    public MoneyWiseTransCategoryClass getCategoryClass() {
<span class="nc" id="L191">        return theAccountDetail.getCategoryClass();</span>
    }

    /**
     * Obtain debit amount.
     * @return the debit amount.
     */
    public OceanusMoney getDebitAmount() {
<span class="nc" id="L199">        return theAccountDetail.getDebitAmount();</span>
    }

    /**
     * Obtain local amount.
     * @return the amount.
     */
    public OceanusMoney getLocalAmount() {
<span class="nc" id="L207">        return theAccountDetail.getLocalAmount();</span>
    }

    /**
     * Obtain credit amount.
     * @return the credit amount.
     */
    public OceanusMoney getCreditAmount() {
<span class="nc" id="L215">        return theAccountDetail.getCreditAmount();</span>
    }

    /**
     * Obtain local returnedCash.
     * @return the returnedCash.
     */
    public OceanusMoney getLocalReturnedCash() {
<span class="nc" id="L223">        return theAccountDetail.getLocalReturnedCash();</span>
    }

    /**
     * Obtain returnedCash.
     * @return the returned cash.
     */
    public OceanusMoney getReturnedCash() {
<span class="nc" id="L231">        return theAccountDetail.getReturnedCash();</span>
    }

    /**
     * Obtain tax credit.
     * @return the tax credit.
     */
    public OceanusMoney getTaxCredit() {
<span class="nc" id="L239">        return theAccountDetail.getTaxCredit();</span>
    }

    /**
     * Obtain employer national insurance.
     * @return the national insurance.
     */
    public OceanusMoney getEmployerNatIns() {
<span class="nc" id="L247">        return theAccountDetail.getEmployerNatIns();</span>
    }

    /**
     * Obtain employee national insurance.
     * @return the national insurance.
     */
    public OceanusMoney getEmployeeNatIns() {
<span class="nc" id="L255">        return theAccountDetail.getEmployeeNatIns();</span>
    }

    /**
     * Obtain benefit.
     * @return the benefit.
     */
    public OceanusMoney getDeemedBenefit() {
<span class="nc" id="L263">        return theAccountDetail.getBenefit();</span>
    }

    /**
     * Obtain withheld.
     * @return the withheld.
     */
    public OceanusMoney getWithheld() {
<span class="nc" id="L271">        return theAccountDetail.getWithheld();</span>
    }

    /**
     * Obtain returnedCash Account.
     * @return the returnedCash account
     */
    public MoneyWiseTransAsset getReturnedCashAccount() {
<span class="nc" id="L279">        return theAccountDetail.getReturnedCashAccount();</span>
    }

    /**
     * Obtain debit units.
     * @return the debit units
     */
    public OceanusUnits getDebitUnits() {
<span class="nc bnc" id="L287" title="All 2 branches missed.">        OceanusUnits myUnits = getDirection().isTo()</span>
<span class="nc" id="L288">                ? getAccountDeltaUnits()</span>
<span class="nc" id="L289">                : getPartnerDeltaUnits();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (myUnits != null) {</span>
<span class="nc" id="L291">            myUnits = new OceanusUnits(myUnits);</span>
<span class="nc" id="L292">            myUnits.negate();</span>
        }
<span class="nc" id="L294">        return myUnits;</span>
    }

    /**
     * Obtain credit units.
     * @return the debit units
     */
    public OceanusUnits getCreditUnits() {
<span class="nc bnc" id="L302" title="All 2 branches missed.">        return getDirection().isFrom()</span>
<span class="nc" id="L303">                ? getAccountDeltaUnits()</span>
<span class="nc" id="L304">                : getPartnerDeltaUnits();</span>
    }

    /**
     * Obtain account delta units.
     * @return the delta units
     */
    public OceanusUnits getAccountDeltaUnits() {
<span class="nc" id="L312">        return theAccountDetail.getAccountDeltaUnits();</span>
    }

    /**
     * Obtain partner delta units.
     * @return the delta units
     */
    public OceanusUnits getPartnerDeltaUnits() {
<span class="nc" id="L320">        return theAccountDetail.getPartnerDeltaUnits();</span>
    }

    /**
     * Obtain dilution.
     * @return the dilution
     */
    public OceanusRatio getDilution() {
<span class="nc" id="L328">        return theAccountDetail.getDilution();</span>
    }

    /**
     * Obtain debit price.
     * @return the debit price
     */
    public OceanusPrice getDebitPrice() {
<span class="nc" id="L336">        return theAccountDetail.getDebitPrice();</span>
    }

    /**
     * Obtain credit price.
     * @return the credit price
     */
    public OceanusPrice getCreditPrice() {
<span class="nc" id="L344">        return theAccountDetail.getCreditPrice();</span>
    }

    /**
     * Obtain debit exchangeRate.
     * @return the rate
     */
    public OceanusRatio getDebitExchangeRate() {
<span class="nc" id="L352">        return theDebitXchangeRate;</span>
    }

    /**
     * Obtain credit exchangeRate.
     * @return the rate
     */
    public OceanusRatio getCreditExchangeRate() {
<span class="nc" id="L360">        return theAccountDetail.getCreditExchangeRate();</span>
    }

    /**
     * Obtain returnedCash exchangeRate.
     * @return the rate
     */
    public OceanusRatio getReturnedCashExchangeRate() {
<span class="nc" id="L368">        return theAccountDetail.getReturnedCashExchangeRate();</span>
    }

    /**
     * Convert amount to reporting currency.
     * @param pCurrency the currency
     * @param pDate the date for the conversion
     * @return the reporting amount
     */
    protected OceanusRatio getExchangeRate(final MoneyWiseCurrency pCurrency,
                                           final OceanusDate pDate) {
<span class="nc" id="L379">        return theRateCursor.getExchangeRate(pCurrency, pDate);</span>
    }

    /**
     * Transaction Detail class.
     */
    private final class TransactionDetail {
        /**
         * The account.
         */
        private final MoneyWiseTransAsset theAccount;

        /**
         * The partner.
         */
        private final MoneyWiseTransAsset thePartner;

        /**
         * The direction.
         */
        private final MoneyWiseAssetDirection theDirection;

        /**
         * The category.
         */
        private final MoneyWiseTransCategory theCategory;

        /**
         * The amount.
         */
        private final OceanusMoney theAmount;

        /**
         * The ReturnedCashAccount.
         */
        private final MoneyWiseTransAsset theReturnedCashAccount;

        /**
         * The returnedCash.
         */
        private final OceanusMoney theReturnedCash;

        /**
         * The tax credit.
         */
        private final OceanusMoney theTaxCredit;

        /**
         * The Employer natIns.
         */
        private final OceanusMoney theEmployerNatIns;

        /**
         * The Employee natIns.
         */
        private final OceanusMoney theEmployeeNatIns;

        /**
         * The benefit amount.
         */
        private final OceanusMoney theBenefit;

        /**
         * The withheld amount.
         */
        private final OceanusMoney theWithheld;

        /**
         * The account delta units.
         */
        private final OceanusUnits theAccountUnits;

        /**
         * The partner delta units.
         */
        private final OceanusUnits thePartnerUnits;

        /**
         * The dilution.
         */
        private final OceanusRatio theDilution;

        /**
         * The account price.
         */
        private final OceanusPrice theAccountPrice;

        /**
         * The partner price.
         */
        private final OceanusPrice thePartnerPrice;

        /**
         * The foreign account details.
         */
        private final ForeignAccountDetail theForeignAccount;

        /**
         * The foreign partner details.
         */
        private final ForeignPartnerDetail theForeignPartner;

        /**
         * The foreign returnedCash details.
         */
        private final ForeignPartnerDetail theForeignReturnedCash;

        /**
         * Constructor.
         */
<span class="nc" id="L489">        private TransactionDetail() {</span>
            /* Store detail */
<span class="nc" id="L491">            theAccount = theCurrent.getAccount();</span>
<span class="nc" id="L492">            thePartner = theCurrent.getPartner();</span>
<span class="nc" id="L493">            theDirection = theCurrent.getDirection();</span>
<span class="nc" id="L494">            theCategory = theCurrent.getCategory();</span>
<span class="nc" id="L495">            theTaxCredit = theCurrent.getTaxCredit();</span>
<span class="nc" id="L496">            theEmployerNatIns = theCurrent.getEmployerNatIns();</span>
<span class="nc" id="L497">            theEmployeeNatIns = theCurrent.getEmployeeNatIns();</span>
<span class="nc" id="L498">            theBenefit = theCurrent.getDeemedBenefit();</span>
<span class="nc" id="L499">            theWithheld = theCurrent.getWithheld();</span>
<span class="nc" id="L500">            theReturnedCashAccount = theCurrent.getReturnedCashAccount();</span>
<span class="nc" id="L501">            theAccountUnits = theCurrent.getAccountDeltaUnits();</span>
<span class="nc" id="L502">            thePartnerUnits = theCurrent.getPartnerDeltaUnits();</span>
<span class="nc" id="L503">            theDilution = theCurrent.getDilution();</span>

            /* Obtain the amounts */
<span class="nc" id="L506">            final OceanusMoney myAmount = theCurrent.getAmount();</span>
<span class="nc" id="L507">            final OceanusMoney myPartnerAmount = theCurrent.getPartnerAmount();</span>
<span class="nc" id="L508">            final OceanusMoney myReturnedCash = theCurrent.getReturnedCash();</span>

            /* Determine account prices */
<span class="nc bnc" id="L511" title="All 2 branches missed.">            theAccountPrice = theAccount instanceof MoneyWiseSecurityHolding</span>
<span class="nc" id="L512">                    ? thePriceCursor.getSecurityPrice(((MoneyWiseSecurityHolding) theAccount).getSecurity(), theDate)</span>
<span class="nc" id="L513">                    : null;</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">            thePartnerPrice = thePartner instanceof MoneyWiseSecurityHolding</span>
<span class="nc" id="L515">                    ? thePriceCursor.getSecurityPrice(((MoneyWiseSecurityHolding) thePartner).getSecurity(), theDate)</span>
<span class="nc" id="L516">                    : null;</span>

            /* Determine foreign account detail */
<span class="nc" id="L519">            MoneyWiseCurrency myActCurrency = theAccount.getAssetCurrency();</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">            theForeignAccount = MetisDataDifference.isEqual(myActCurrency, theCurrency)</span>
<span class="nc" id="L521">                    ? null</span>
<span class="nc" id="L522">                    : new ForeignAccountDetail(this, myActCurrency, myAmount);</span>

            /* If we have a partner amount */
<span class="nc" id="L525">            myActCurrency = thePartner.getAssetCurrency();</span>
<span class="nc" id="L526">            theForeignPartner = myActCurrency == null</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">                    || MetisDataDifference.isEqual(myActCurrency, theCurrency)</span>
<span class="nc" id="L528">                    ? null</span>
<span class="nc" id="L529">                    : new ForeignPartnerDetail(myActCurrency, myPartnerAmount);</span>

            /* If we have a returnedCash account */
<span class="nc bnc" id="L532" title="All 2 branches missed.">            if (theReturnedCashAccount != null) {</span>
                /* Determine foreign returnedCash detail */
<span class="nc" id="L534">                myActCurrency = theReturnedCashAccount.getAssetCurrency();</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                theForeignReturnedCash = MetisDataDifference.isEqual(myActCurrency, theCurrency)</span>
<span class="nc" id="L536">                        ? null</span>
<span class="nc" id="L537">                        : new ForeignPartnerDetail(myActCurrency, myReturnedCash);</span>
            } else {
<span class="nc" id="L539">                theForeignReturnedCash = null;</span>
            }

            /* Determine the local amounts */
<span class="nc bnc" id="L543" title="All 2 branches missed.">            theAmount = theForeignAccount == null</span>
<span class="nc" id="L544">                    ? myAmount</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">                    : theForeignPartner == null</span>
<span class="nc" id="L546">                    ? myPartnerAmount</span>
<span class="nc" id="L547">                    : theForeignAccount.theAmount;</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">            theReturnedCash = theForeignReturnedCash == null</span>
<span class="nc" id="L549">                    ? myReturnedCash</span>
<span class="nc" id="L550">                    : theForeignReturnedCash.theAmount;</span>
<span class="nc" id="L551">        }</span>

        /**
         * Obtain account.
         * @return the account
         */
        private MoneyWiseTransAsset getAccount() {
<span class="nc" id="L558">            return theAccount;</span>
        }

        /**
         * Obtain partner.
         * @return the partner
         */
        private MoneyWiseTransAsset getPartner() {
<span class="nc" id="L566">            return thePartner;</span>
        }

        /**
         * Obtain direction.
         * @return the direction
         */
        private MoneyWiseAssetDirection getDirection() {
<span class="nc" id="L574">            return theDirection;</span>
        }

        /**
         * Obtain debit asset.
         * @return the debit asset
         */
        private MoneyWiseTransAsset getDebitAsset() {
<span class="nc bnc" id="L582" title="All 2 branches missed.">            return theDirection.isFrom()</span>
<span class="nc" id="L583">                    ? thePartner</span>
<span class="nc" id="L584">                    : theAccount;</span>
        }

        /**
         * Obtain credit asset.
         * @return the credit asset
         */
        private MoneyWiseTransAsset getCreditAsset() {
<span class="nc bnc" id="L592" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc" id="L593">                    ? thePartner</span>
<span class="nc" id="L594">                    : theAccount;</span>
        }

        /**
         * Obtain returnedCash account.
         * @return the returnedCash account
         */
        private MoneyWiseTransAsset getReturnedCashAccount() {
<span class="nc" id="L602">            return theReturnedCashAccount;</span>
        }

        /**
         * Obtain category.
         * @return the category class
         */
        private MoneyWiseTransCategory getCategory() {
<span class="nc" id="L610">            return theCategory;</span>
        }

        /**
         * Is this a particular category class?
         * @param pClass the category class
         * @return true/false
         */
        private boolean isCategoryClass(final MoneyWiseTransCategoryClass pClass) {
<span class="nc" id="L619">            return theCategory.isCategoryClass(pClass);</span>
        }

        /**
         * Obtain category class?
         * @return the category class
         */
        private MoneyWiseTransCategoryClass getCategoryClass() {
<span class="nc" id="L627">            return theCategory.getCategoryTypeClass();</span>
        }

        /**
         * Obtain debit amount.
         * @return the debit amount
         */
        private OceanusMoney getDebitAmount() {
<span class="nc bnc" id="L635" title="All 2 branches missed.">            return theDirection.isFrom()</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                    ? theForeignPartner == null</span>
<span class="nc" id="L637">                    ? theAmount</span>
<span class="nc" id="L638">                    : theForeignPartner.theBase</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                    : theForeignAccount == null</span>
<span class="nc" id="L640">                    ? theAmount</span>
<span class="nc" id="L641">                    : theForeignAccount.theBase;</span>
        }

        /**
         * Obtain local debit amount.
         * @return the local debit amount
         */
        private OceanusMoney getLocalAmount() {
<span class="nc" id="L649">            return theAmount;</span>
        }

        /**
         * Obtain credit amount.
         * @return the credit amount
         */
        private OceanusMoney getCreditAmount() {
<span class="nc bnc" id="L657" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                    ? theForeignPartner == null</span>
<span class="nc" id="L659">                    ? theAmount</span>
<span class="nc" id="L660">                    : theForeignPartner.theBase</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">                    : theForeignAccount == null</span>
<span class="nc" id="L662">                    ? theAmount</span>
<span class="nc" id="L663">                    : theForeignAccount.theBase;</span>
        }

        /**
         * Obtain local returnedCash.
         * @return the local returnedCash
         */
        private OceanusMoney getLocalReturnedCash() {
<span class="nc" id="L671">            return theReturnedCash;</span>
        }

        /**
         * Obtain returnedCash.
         * @return the returnedCash
         */
        private OceanusMoney getReturnedCash() {
<span class="nc bnc" id="L679" title="All 2 branches missed.">            return theForeignReturnedCash == null</span>
<span class="nc" id="L680">                    ? theReturnedCash</span>
<span class="nc" id="L681">                    : theForeignReturnedCash.theBase;</span>
        }

        /**
         * Obtain debit price.
         * @return the debit price
         */
        private OceanusPrice getDebitPrice() {
<span class="nc bnc" id="L689" title="All 2 branches missed.">            return theDirection.isFrom()</span>
<span class="nc" id="L690">                    ? thePartnerPrice</span>
<span class="nc" id="L691">                    : theAccountPrice;</span>
        }

        /**
         * Obtain credit price.
         * @return the credit price
         */
        private OceanusPrice getCreditPrice() {
<span class="nc bnc" id="L699" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc" id="L700">                    ? thePartnerPrice</span>
<span class="nc" id="L701">                    : theAccountPrice;</span>
        }

        /**
         * Obtain debit exchangeRate.
         * @return the rate
         */
        private OceanusRatio getDebitExchangeRate() {
<span class="nc bnc" id="L709" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                    ? theForeignAccount == null</span>
<span class="nc" id="L711">                    ? null</span>
<span class="nc" id="L712">                    : theForeignAccount.theExchangeRate</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                    : theForeignPartner == null</span>
<span class="nc" id="L714">                    ? null</span>
<span class="nc" id="L715">                    : theForeignPartner.theExchangeRate;</span>
        }

        /**
         * Obtain credit exchangeRate.
         * @return the rate
         */
        private OceanusRatio getCreditExchangeRate() {
<span class="nc bnc" id="L723" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">                    ? theForeignPartner == null</span>
<span class="nc" id="L725">                    ? null</span>
<span class="nc" id="L726">                    : theForeignPartner.theExchangeRate</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">                    : theForeignAccount == null</span>
<span class="nc" id="L728">                    ? null</span>
<span class="nc" id="L729">                    : theForeignAccount.theExchangeRate;</span>
        }

        /**
         * Obtain thirdParty exchangeRate.
         * @return the rate
         */
        private OceanusRatio getReturnedCashExchangeRate() {
<span class="nc bnc" id="L737" title="All 2 branches missed.">            return theForeignReturnedCash == null</span>
<span class="nc" id="L738">                    ? null</span>
<span class="nc" id="L739">                    : theForeignReturnedCash.theExchangeRate;</span>
        }

        /**
         * Obtain taxCredit.
         * @return the tax credit
         */
        private OceanusMoney getTaxCredit() {
<span class="nc bnc" id="L747" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L748">                    ? theForeignAccount.theTaxCredit</span>
<span class="nc" id="L749">                    : theTaxCredit;</span>
        }

        /**
         * Obtain employer natInsurance.
         * @return the national insurance
         */
        private OceanusMoney getEmployerNatIns() {
<span class="nc bnc" id="L757" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L758">                    ? theForeignAccount.theEmployerNatIns</span>
<span class="nc" id="L759">                    : theEmployerNatIns;</span>
        }

        /**
         * Obtain employee natInsurance.
         * @return the national insurance
         */
        private OceanusMoney getEmployeeNatIns() {
<span class="nc bnc" id="L767" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L768">                    ? theForeignAccount.theEmployeeNatIns</span>
<span class="nc" id="L769">                    : theEmployeeNatIns;</span>
        }

        /**
         * Obtain benefit.
         * @return the benefit
         */
        private OceanusMoney getBenefit() {
<span class="nc bnc" id="L777" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L778">                    ? theForeignAccount.theBenefit</span>
<span class="nc" id="L779">                    : theBenefit;</span>
        }

        /**
         * Obtain donation.
         * @return the donation
         */
        private OceanusMoney getWithheld() {
<span class="nc bnc" id="L787" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L788">                    ? theForeignAccount.theWithheld</span>
<span class="nc" id="L789">                    : theWithheld;</span>
        }

        /**
         * Obtain account delta units.
         * @return the delta units
         */
        private OceanusUnits getAccountDeltaUnits() {
<span class="nc" id="L797">            return theAccountUnits;</span>
        }

        /**
         * Obtain partner delta units.
         * @return the partner delta units
         */
        private OceanusUnits getPartnerDeltaUnits() {
<span class="nc" id="L805">            return thePartnerUnits;</span>
        }

        /**
         * Obtain dilution.
         * @return the dilution
         */
        private OceanusRatio getDilution() {
<span class="nc" id="L813">            return theDilution;</span>
        }
    }

    /**
     * Foreign Account class.
     */
    private final class ForeignAccountDetail {
        /**
         * The exchange rate.
         */
        private final OceanusRatio theExchangeRate;

        /**
         * The base amount.
         */
        private final OceanusMoney theBase;

        /**
         * The amount.
         */
        private final OceanusMoney theAmount;

        /**
         * The tax credit.
         */
        private final OceanusMoney theTaxCredit;

        /**
         * The employer natInsurance.
         */
        private final OceanusMoney theEmployerNatIns;

        /**
         * The employee natInsurance.
         */
        private final OceanusMoney theEmployeeNatIns;

        /**
         * The benefit amount.
         */
        private final OceanusMoney theBenefit;

        /**
         * The withheld amount.
         */
        private final OceanusMoney theWithheld;

        /**
         * Constructor.
         * @param pTrans the transaction detail
         * @param pCurrency the foreign currency
         * @param pAmount the amount
         */
        private ForeignAccountDetail(final TransactionDetail pTrans,
                                     final MoneyWiseCurrency pCurrency,
<span class="nc" id="L869">                                     final OceanusMoney pAmount) {</span>
            /* Obtain the required exchange rate */
<span class="nc" id="L871">            theBase = pAmount;</span>
<span class="nc" id="L872">            final OceanusRatio myEventRate = theCurrent.getExchangeRate();</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">            final OceanusRatio myRate = myEventRate == null</span>
<span class="nc" id="L874">                    ? theRateCursor.getExchangeRate(pCurrency, theDate)</span>
<span class="nc" id="L875">                    : myEventRate;</span>
<span class="nc" id="L876">            theExchangeRate = myRate;</span>
<span class="nc" id="L877">            final Currency myCurrency = theCurrency.getCurrency();</span>

            /* Obtain local amount */
<span class="nc bnc" id="L880" title="All 2 branches missed.">            theAmount = theBase != null</span>
<span class="nc" id="L881">                    ? theBase.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L882">                    : null;</span>

            /* Obtain tax value */
<span class="nc" id="L885">            OceanusMoney myValue = pTrans.theTaxCredit;</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">            theTaxCredit = myValue != null</span>
<span class="nc" id="L887">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L888">                    : null;</span>
            /* Obtain Employer NatIns */
<span class="nc" id="L890">            myValue = pTrans.theEmployerNatIns;</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">            theEmployerNatIns = myValue != null</span>
<span class="nc" id="L892">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L893">                    : null;</span>

            /* Obtain Employee NatIns */
<span class="nc" id="L896">            myValue = pTrans.theEmployeeNatIns;</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">            theEmployeeNatIns = myValue != null</span>
<span class="nc" id="L898">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L899">                    : null;</span>

            /* Obtain benefit */
<span class="nc" id="L902">            myValue = pTrans.theBenefit;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">            theBenefit = myValue != null</span>
<span class="nc" id="L904">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L905">                    : null;</span>

            /* Obtain withheld */
<span class="nc" id="L908">            myValue = pTrans.theWithheld;</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">            theWithheld = myValue != null</span>
<span class="nc" id="L910">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L911">                    : null;</span>
<span class="nc" id="L912">        }</span>
    }

    /**
     * Foreign Partner class.
     */
    private final class ForeignPartnerDetail {
        /**
         * The exchange rate.
         */
        private final OceanusRatio theExchangeRate;

        /**
         * The base amount.
         */
        private final OceanusMoney theBase;

        /**
         * The local amount.
         */
        private final OceanusMoney theAmount;

        /**
         * Constructor.
         * @param pCurrency the foreign currency
         * @param pAmount the amount
         */
        private ForeignPartnerDetail(final MoneyWiseCurrency pCurrency,
<span class="nc" id="L940">                                     final OceanusMoney pAmount) {</span>
            /* Obtain the required exchange rate */
<span class="nc" id="L942">            theBase = pAmount;</span>
<span class="nc" id="L943">            theExchangeRate = theRateCursor.getExchangeRate(pCurrency, theDate);</span>
<span class="nc" id="L944">            final OceanusRatio myRate = theExchangeRate;</span>
<span class="nc" id="L945">            final Currency myCurrency = theCurrency.getCurrency();</span>

            /* Obtain local amount */
<span class="nc bnc" id="L948" title="All 2 branches missed.">            theAmount = theBase != null</span>
<span class="nc" id="L949">                    ? theBase.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L950">                    : null;</span>
<span class="nc" id="L951">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>