<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseTransactionDialog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.moneywise.lethe.ui.dialog</a> &gt; <span class="el_source">MoneyWiseTransactionDialog.java</span></div><h1>MoneyWiseTransactionDialog.java</h1><pre class="source lang-java linenums">/*
 * MoneyWise: Finance Application
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.moneywise.lethe.ui.dialog;

import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDate;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDateConfig;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDateRange;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusMoney;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusPrice;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusRatio;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusUnits;
import io.github.tonywasher.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import io.github.tonywasher.joceanus.metis.field.MetisFieldRequired;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetBase;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetBase.MoneyWiseAssetBaseList;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetDirection;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetType;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseBasicDataType;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseBasicResource;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseCash.MoneyWiseCashList;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseDataSet;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseDataValidator.MoneyWiseDataValidatorTrans;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseDeposit.MoneyWiseDepositList;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseLoan.MoneyWiseLoanList;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWisePayee.MoneyWisePayeeList;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWisePortfolio;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWisePortfolio.MoneyWisePortfolioList;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurity;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding.MoneyWiseSecurityHoldingMap;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransCategory.MoneyWiseTransCategoryList;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransInfoSet;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransTag;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransaction.MoneyWiseTransactionList;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTransInfoClass;
import io.github.tonywasher.joceanus.moneywise.data.validate.MoneyWiseValidateTransaction;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysis;
import io.github.tonywasher.joceanus.moneywise.lethe.ui.controls.MoneyWiseAnalysisSelect;
import io.github.tonywasher.joceanus.moneywise.lethe.views.MoneyWiseAnalysisFilter;
import io.github.tonywasher.joceanus.moneywise.lethe.views.MoneyWiseTransactionFilters;
import io.github.tonywasher.joceanus.moneywise.ui.MoneyWiseIcon;
import io.github.tonywasher.joceanus.moneywise.ui.MoneyWiseUIResource;
import io.github.tonywasher.joceanus.moneywise.ui.base.MoneyWiseBaseTable;
import io.github.tonywasher.joceanus.moneywise.ui.base.MoneyWiseItemPanel;
import io.github.tonywasher.joceanus.prometheus.ui.fieldset.PrometheusFieldSet;
import io.github.tonywasher.joceanus.prometheus.ui.fieldset.PrometheusFieldSetEvent;
import io.github.tonywasher.joceanus.prometheus.views.PrometheusEditSet;
import io.github.tonywasher.joceanus.tethys.api.control.TethysUIControl.TethysUIIconMapSet;
import io.github.tonywasher.joceanus.tethys.api.factory.TethysUIFactory;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIDateButtonField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIIconButtonField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIIntegerEditField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIListButtonField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIMoneyEditField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIPriceEditField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIRatioEditField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIScrollButtonField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIStringEditField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIDataEditField.TethysUIUnitsEditField;
import io.github.tonywasher.joceanus.tethys.api.field.TethysUIFieldFactory;
import io.github.tonywasher.joceanus.tethys.api.menu.TethysUIScrollItem;
import io.github.tonywasher.joceanus.tethys.api.menu.TethysUIScrollMenu;
import io.github.tonywasher.joceanus.tethys.api.menu.TethysUIScrollSubMenu;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * Panel to display/edit/create a Transaction.
 */
public class MoneyWiseTransactionDialog
        extends MoneyWiseItemPanel&lt;MoneyWiseTransaction&gt; {
    /**
     * Info Tab Title.
     */
<span class="nc" id="L98">    private static final String TAB_INFO = MoneyWiseUIResource.TRANSPANEL_TAB_INFO.getValue();</span>

    /**
     * Tax Tab Title.
     */
<span class="nc" id="L103">    private static final String TAB_TAXES = MoneyWiseUIResource.TRANSPANEL_TAB_TAXES.getValue();</span>

    /**
     * Securities Tab Title.
     */
<span class="nc" id="L108">    private static final String TAB_SECURITIES = MoneyWiseUIResource.TRANSPANEL_TAB_SECURITIES.getValue();</span>

    /**
     * Returned Tab Title.
     */
<span class="nc" id="L113">    private static final String TAB_RETURNED = MoneyWiseUIResource.TRANSPANEL_TAB_RETURNED.getValue();</span>

    /**
     * The fieldSet.
     */
    private final PrometheusFieldSet&lt;MoneyWiseTransaction&gt; theFieldSet;

    /**
     * Analysis selection panel.
     */
    private final MoneyWiseAnalysisSelect theAnalysisSelect;

    /**
     * dateRange.
     */
    private OceanusDateRange theRange;

    /**
     * reconciledState.
     */
<span class="nc" id="L133">    private Boolean theReconciledState = Boolean.FALSE;</span>

    /**
     * directionState.
     */
<span class="nc" id="L138">    private Boolean theDirectionState = Boolean.FALSE;</span>

    /**
     * Constructor.
     *
     * @param pFactory        the GUI factory
     * @param pEditSet        the edit set
     * @param pAnalysisSelect the analysis selection panel
     * @param pOwner          the owning table
     */
    public MoneyWiseTransactionDialog(final TethysUIFactory&lt;?&gt; pFactory,
                                      final PrometheusEditSet pEditSet,
                                      final MoneyWiseAnalysisSelect pAnalysisSelect,
                                      final MoneyWiseBaseTable&lt;MoneyWiseTransaction&gt; pOwner) {
        /* Initialise the panel */
<span class="nc" id="L153">        super(pFactory, pEditSet, pOwner);</span>
<span class="nc" id="L154">        theAnalysisSelect = pAnalysisSelect;</span>

        /* Access the fieldSet */
<span class="nc" id="L157">        theFieldSet = getFieldSet();</span>

        /* Build the main panel */
<span class="nc" id="L160">        buildMainPanel(pFactory);</span>

        /* Build the info panel */
<span class="nc" id="L163">        buildInfoPanel(pFactory);</span>

        /* Build the tax panel */
<span class="nc" id="L166">        buildTaxPanel(pFactory);</span>

        /* Build the securities panel */
<span class="nc" id="L169">        buildSecuritiesPanel(pFactory);</span>

        /* Build the returned panel */
<span class="nc" id="L172">        buildReturnedPanel(pFactory);</span>
<span class="nc" id="L173">    }</span>

    /**
     * Build Main subPanel.
     *
     * @param pFactory the GUI factory
     */
    private void buildMainPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Allocate fields */
<span class="nc" id="L182">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L183">        final TethysUIMoneyEditField myAmount = myFields.newMoneyField();</span>

        /* Create the buttons */
<span class="nc" id="L186">        final TethysUIDateButtonField myDateButton = myFields.newDateField();</span>
<span class="nc" id="L187">        final TethysUIScrollButtonField&lt;MoneyWiseTransAsset&gt; myAccountButton = myFields.newScrollField(MoneyWiseTransAsset.class);</span>
<span class="nc" id="L188">        final TethysUIScrollButtonField&lt;MoneyWiseTransAsset&gt; myPartnerButton = myFields.newScrollField(MoneyWiseTransAsset.class);</span>
<span class="nc" id="L189">        final TethysUIScrollButtonField&lt;MoneyWiseTransCategory&gt; myCategoryButton = myFields.newScrollField(MoneyWiseTransCategory.class);</span>
<span class="nc" id="L190">        final TethysUIIconButtonField&lt;Boolean&gt; myReconciledButton = myFields.newIconField(Boolean.class);</span>
<span class="nc" id="L191">        final TethysUIIconButtonField&lt;MoneyWiseAssetDirection&gt; myDirectionButton = myFields.newIconField(MoneyWiseAssetDirection.class);</span>

        /* Assign the fields to the panel */
<span class="nc" id="L194">        theFieldSet.addField(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE, myDateButton, MoneyWiseTransaction::getDate);</span>
<span class="nc" id="L195">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, myAccountButton, MoneyWiseTransaction::getAccount);</span>
<span class="nc" id="L196">        theFieldSet.addField(MoneyWiseBasicDataType.TRANSCATEGORY, myCategoryButton, MoneyWiseTransaction::getCategory);</span>
<span class="nc" id="L197">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_DIRECTION, myDirectionButton, MoneyWiseTransaction::getDirection);</span>
<span class="nc" id="L198">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_PARTNER, myPartnerButton, MoneyWiseTransaction::getPartner);</span>
<span class="nc" id="L199">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_AMOUNT, myAmount, MoneyWiseTransaction::getAmount);</span>
<span class="nc" id="L200">        theFieldSet.addField(MoneyWiseBasicResource.TRANSACTION_RECONCILED, myReconciledButton, MoneyWiseTransaction::isReconciled);</span>

        /* Configure the menuBuilders */
<span class="nc" id="L203">        myDateButton.setDateConfigurator(this::handleDateConfig);</span>
<span class="nc" id="L204">        myAccountButton.setMenuConfigurator(c -&gt; buildAccountMenu(c, getItem()));</span>
<span class="nc" id="L205">        myCategoryButton.setMenuConfigurator(c -&gt; buildCategoryMenu(c, getItem()));</span>
<span class="nc" id="L206">        myPartnerButton.setMenuConfigurator(c -&gt; buildPartnerMenu(c, getItem()));</span>
<span class="nc" id="L207">        final Map&lt;Boolean, TethysUIIconMapSet&lt;Boolean&gt;&gt; myRecMapSets = MoneyWiseIcon.configureReconciledIconButton(pFactory);</span>
<span class="nc" id="L208">        myReconciledButton.setIconMapSet(() -&gt; myRecMapSets.get(theReconciledState));</span>
<span class="nc" id="L209">        final Map&lt;Boolean, TethysUIIconMapSet&lt;MoneyWiseAssetDirection&gt;&gt; myDirMapSets = MoneyWiseIcon.configureDirectionIconButton(pFactory);</span>
<span class="nc" id="L210">        myDirectionButton.setIconMapSet(() -&gt; myDirMapSets.get(theDirectionState));</span>
<span class="nc" id="L211">        myAmount.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L212">    }</span>

    /**
     * Build info subPanel.
     *
     * @param pFactory the GUI factory
     */
    private void buildInfoPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create a new panel */
<span class="nc" id="L221">        theFieldSet.newPanel(TAB_INFO);</span>

        /* Allocate fields */
<span class="nc" id="L224">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L225">        final TethysUIMoneyEditField myAmount = myFields.newMoneyField();</span>
<span class="nc" id="L226">        final TethysUIStringEditField myComments = myFields.newStringField();</span>
<span class="nc" id="L227">        final TethysUIStringEditField myReference = myFields.newStringField();</span>
<span class="nc" id="L228">        final TethysUIRatioEditField myRate = myFields.newRatioField();</span>

        /* Create the buttons */
<span class="nc" id="L231">        final TethysUIListButtonField&lt;MoneyWiseTransTag&gt; myTagButton = myFields.newListField();</span>

        /* Assign the fields to the panel */
<span class="nc" id="L234">        theFieldSet.addField(MoneyWiseTransInfoClass.PARTNERAMOUNT, myAmount, MoneyWiseTransaction::getPartnerAmount);</span>
<span class="nc" id="L235">        theFieldSet.addField(MoneyWiseTransInfoClass.COMMENTS, myComments, MoneyWiseTransaction::getComments);</span>
<span class="nc" id="L236">        theFieldSet.addField(MoneyWiseTransInfoClass.REFERENCE, myReference, MoneyWiseTransaction::getReference);</span>
<span class="nc" id="L237">        theFieldSet.addField(MoneyWiseTransInfoClass.TRANSTAG, myTagButton, MoneyWiseTransaction::getTransactionTags);</span>
<span class="nc" id="L238">        theFieldSet.addField(MoneyWiseTransInfoClass.XCHANGERATE, myRate, MoneyWiseTransaction::getExchangeRate);</span>

        /* Configure the tag button */
<span class="nc" id="L241">        myTagButton.setSelectables(this::buildTransactionTags);</span>

        /* Set currency */
<span class="nc" id="L244">        myAmount.setDeemedCurrency(() -&gt; getItem().getPartner().getCurrency());</span>
<span class="nc" id="L245">    }</span>

    /**
     * Build tax subPanel.
     *
     * @param pFactory the GUI factory
     */
    private void buildTaxPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create a new panel */
<span class="nc" id="L254">        theFieldSet.newPanel(TAB_TAXES);</span>

        /* Allocate fields */
<span class="nc" id="L257">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L258">        final TethysUIMoneyEditField myTaxCredit = myFields.newMoneyField();</span>
<span class="nc" id="L259">        final TethysUIMoneyEditField myEeNatIns = myFields.newMoneyField();</span>
<span class="nc" id="L260">        final TethysUIMoneyEditField myErNatIns = myFields.newMoneyField();</span>
<span class="nc" id="L261">        final TethysUIMoneyEditField myBenefit = myFields.newMoneyField();</span>
<span class="nc" id="L262">        final TethysUIMoneyEditField myWithheld = myFields.newMoneyField();</span>
<span class="nc" id="L263">        final TethysUIIntegerEditField myYears = myFields.newIntegerField();</span>

        /* Assign the fields to the panel */
<span class="nc" id="L266">        theFieldSet.addField(MoneyWiseTransInfoClass.TAXCREDIT, myTaxCredit, MoneyWiseTransaction::getTaxCredit);</span>
<span class="nc" id="L267">        theFieldSet.addField(MoneyWiseTransInfoClass.EMPLOYEENATINS, myEeNatIns, MoneyWiseTransaction::getEmployeeNatIns);</span>
<span class="nc" id="L268">        theFieldSet.addField(MoneyWiseTransInfoClass.EMPLOYERNATINS, myErNatIns, MoneyWiseTransaction::getEmployerNatIns);</span>
<span class="nc" id="L269">        theFieldSet.addField(MoneyWiseTransInfoClass.DEEMEDBENEFIT, myBenefit, MoneyWiseTransaction::getDeemedBenefit);</span>
<span class="nc" id="L270">        theFieldSet.addField(MoneyWiseTransInfoClass.WITHHELD, myWithheld, MoneyWiseTransaction::getWithheld);</span>
<span class="nc" id="L271">        theFieldSet.addField(MoneyWiseTransInfoClass.QUALIFYYEARS, myYears, MoneyWiseTransaction::getYears);</span>

        /* Set currency */
<span class="nc" id="L274">        myTaxCredit.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L275">        myEeNatIns.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L276">        myErNatIns.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L277">        myBenefit.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L278">        myWithheld.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L279">    }</span>

    /**
     * Build securities subPanel.
     *
     * @param pFactory the GUI factory
     */
    private void buildSecuritiesPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create a new panel */
<span class="nc" id="L288">        theFieldSet.newPanel(TAB_SECURITIES);</span>

        /* Allocate fields */
<span class="nc" id="L291">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L292">        final TethysUIUnitsEditField myAccountUnits = myFields.newUnitsField();</span>
<span class="nc" id="L293">        final TethysUIUnitsEditField myPartnerUnits = myFields.newUnitsField();</span>
<span class="nc" id="L294">        final TethysUIMoneyEditField myCommission = myFields.newMoneyField();</span>
<span class="nc" id="L295">        final TethysUIPriceEditField myPrice = myFields.newPriceField();</span>
<span class="nc" id="L296">        final TethysUIRatioEditField myDilution = myFields.newRatioField();</span>

        /* Assign the fields to the panel */
<span class="nc" id="L299">        theFieldSet.addField(MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS, myAccountUnits, MoneyWiseTransaction::getAccountDeltaUnits);</span>
<span class="nc" id="L300">        theFieldSet.addField(MoneyWiseTransInfoClass.PARTNERDELTAUNITS, myPartnerUnits, MoneyWiseTransaction::getPartnerDeltaUnits);</span>
<span class="nc" id="L301">        theFieldSet.addField(MoneyWiseTransInfoClass.PRICE, myPrice, MoneyWiseTransaction::getPrice);</span>
<span class="nc" id="L302">        theFieldSet.addField(MoneyWiseTransInfoClass.COMMISSION, myCommission, MoneyWiseTransaction::getCommission);</span>
<span class="nc" id="L303">        theFieldSet.addField(MoneyWiseTransInfoClass.DILUTION, myDilution, MoneyWiseTransaction::getDilution);</span>

        /* Set currency */
<span class="nc" id="L306">        myCommission.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L307">        myPrice.setDeemedCurrency(() -&gt; getItem().getAccount().getCurrency());</span>
<span class="nc" id="L308">    }</span>

    /**
     * Build returned subPanel.
     *
     * @param pFactory the GUI factory
     */
    private void buildReturnedPanel(final TethysUIFactory&lt;?&gt; pFactory) {
        /* Create a new panel */
<span class="nc" id="L317">        theFieldSet.newPanel(TAB_RETURNED);</span>

        /* Allocate fields */
<span class="nc" id="L320">        final TethysUIFieldFactory myFields = pFactory.fieldFactory();</span>
<span class="nc" id="L321">        final TethysUIMoneyEditField myReturnedCash = myFields.newMoneyField();</span>

        /* Create the buttons */
<span class="nc" id="L324">        final TethysUIScrollButtonField&lt;MoneyWiseTransAsset&gt; myReturnedAccountButton = myFields.newScrollField(MoneyWiseTransAsset.class);</span>

        /* Assign the fields to the panel */
<span class="nc" id="L327">        theFieldSet.addField(MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT, myReturnedAccountButton, MoneyWiseTransaction::getReturnedCashAccount);</span>
<span class="nc" id="L328">        theFieldSet.addField(MoneyWiseTransInfoClass.RETURNEDCASH, myReturnedCash, MoneyWiseTransaction::getReturnedCash);</span>

        /* Configure the menuBuilders */
<span class="nc" id="L331">        myReturnedAccountButton.setMenuConfigurator(c -&gt; buildReturnedAccountMenu(c, getItem()));</span>

        /* Set currency */
<span class="nc" id="L334">        myReturnedCash.setDeemedCurrency(() -&gt; getItem().getReturnedCashAccount().getCurrency());</span>
<span class="nc" id="L335">    }</span>

    @Override
    public void refreshData() {
        /* If we have an item */
<span class="nc" id="L340">        final MoneyWiseTransaction myItem = getItem();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (myItem != null) {</span>
<span class="nc" id="L342">            final MoneyWiseTransactionList myTrans = getDataList(MoneyWiseBasicDataType.TRANSACTION, MoneyWiseTransactionList.class);</span>
<span class="nc" id="L343">            setItem(myTrans.findItemById(myItem.getIndexedId()));</span>
        }

        /* Make sure that the item is not editable */
<span class="nc" id="L347">        setEditable(false);</span>
<span class="nc" id="L348">    }</span>

    /**
     * Update editors.
     *
     * @param pRange the date range.
     */
    public void updateEditors(final OceanusDateRange pRange) {
        /* Update the range */
<span class="nc" id="L357">        theRange = pRange;</span>
<span class="nc" id="L358">    }</span>

    /**
     * Handle dateConfig.
     *
     * @param pConfig the dateConfig
     */
    private void handleDateConfig(final OceanusDateConfig pConfig) {
        /* Update Date button */
<span class="nc bnc" id="L367" title="All 2 branches missed.">        pConfig.setEarliestDate(theRange != null</span>
<span class="nc" id="L368">                ? theRange.getStart()</span>
<span class="nc" id="L369">                : null);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        pConfig.setLatestDate(theRange != null</span>
<span class="nc" id="L371">                ? theRange.getEnd()</span>
<span class="nc" id="L372">                : null);</span>
<span class="nc" id="L373">    }</span>

    @Override
    public boolean isDeletable() {
<span class="nc bnc" id="L377" title="All 4 branches missed.">        return getItem() != null &amp;&amp; !getItem().isReconciled();</span>
    }

    @Override
    protected void adjustFields(final boolean isEditable) {
        /* Access the item */
<span class="nc" id="L383">        final MoneyWiseTransaction myTrans = getItem();</span>
<span class="nc" id="L384">        final boolean bIsReconciled = myTrans.isReconciled();</span>
<span class="nc" id="L385">        final boolean bIsLocked = myTrans.isLocked();</span>

        /* Determine whether the comments field should be visible */
<span class="nc bnc" id="L388" title="All 4 branches missed.">        boolean bShowField = isEditable || myTrans.getComments() != null;</span>
<span class="nc" id="L389">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.COMMENTS, bShowField);</span>

        /* Determine whether the reference field should be visible */
<span class="nc bnc" id="L392" title="All 4 branches missed.">        bShowField = isEditable || myTrans.getReference() != null;</span>
<span class="nc" id="L393">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.REFERENCE, bShowField);</span>

        /* Determine whether the tags field should be visible */
<span class="nc bnc" id="L396" title="All 4 branches missed.">        bShowField = isEditable || myTrans.getTransactionTags() != null;</span>
<span class="nc" id="L397">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.TRANSTAG, bShowField);</span>

        /* Determine whether the partnerAmount field should be visible */
<span class="nc bnc" id="L400" title="All 4 branches missed.">        boolean bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.PARTNERAMOUNT);</span>
<span class="nc bnc" id="L401" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getPartnerAmount() != null;</span>
<span class="nc" id="L402">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.PARTNERAMOUNT, bShowField);</span>
<span class="nc" id="L403">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.PARTNERAMOUNT, bEditField);</span>

        /* Determine whether the exchangeRate field should be visible */
<span class="nc bnc" id="L406" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.XCHANGERATE);</span>
<span class="nc bnc" id="L407" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getExchangeRate() != null;</span>
<span class="nc" id="L408">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.XCHANGERATE, bShowField);</span>
<span class="nc" id="L409">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.XCHANGERATE, bEditField);</span>

        /* Determine whether the taxCredit field should be visible */
<span class="nc bnc" id="L412" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.TAXCREDIT);</span>
<span class="nc bnc" id="L413" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getTaxCredit() != null;</span>
<span class="nc" id="L414">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.TAXCREDIT, bShowField);</span>
<span class="nc" id="L415">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.TAXCREDIT, bEditField);</span>

        /* Determine whether the EeNatIns field should be visible */
<span class="nc bnc" id="L418" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.EMPLOYEENATINS);</span>
<span class="nc bnc" id="L419" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getEmployeeNatIns() != null;</span>
<span class="nc" id="L420">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.EMPLOYEENATINS, bShowField);</span>
<span class="nc" id="L421">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.EMPLOYEENATINS, bEditField);</span>

        /* Determine whether the ErnatIns field should be visible */
<span class="nc bnc" id="L424" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.EMPLOYERNATINS);</span>
<span class="nc bnc" id="L425" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getEmployerNatIns() != null;</span>
<span class="nc" id="L426">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.EMPLOYERNATINS, bShowField);</span>
<span class="nc" id="L427">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.EMPLOYERNATINS, bEditField);</span>

        /* Determine whether the benefit field should be visible */
<span class="nc bnc" id="L430" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.DEEMEDBENEFIT);</span>
<span class="nc bnc" id="L431" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getDeemedBenefit() != null;</span>
<span class="nc" id="L432">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.DEEMEDBENEFIT, bShowField);</span>
<span class="nc" id="L433">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.DEEMEDBENEFIT, bEditField);</span>

        /* Determine whether the donation field should be visible */
<span class="nc bnc" id="L436" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.WITHHELD);</span>
<span class="nc bnc" id="L437" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getWithheld() != null;</span>
<span class="nc" id="L438">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.WITHHELD, bShowField);</span>
<span class="nc" id="L439">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.WITHHELD, bEditField);</span>

        /* Determine whether the account units field should be visible */
<span class="nc bnc" id="L442" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS);</span>
<span class="nc bnc" id="L443" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getAccountDeltaUnits() != null;</span>
<span class="nc" id="L444">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS, bShowField);</span>
<span class="nc" id="L445">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS, bEditField);</span>

        /* Determine whether the partnerDeltaUnits field should be visible */
<span class="nc bnc" id="L448" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.PARTNERDELTAUNITS);</span>
<span class="nc bnc" id="L449" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getPartnerDeltaUnits() != null;</span>
<span class="nc" id="L450">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.PARTNERDELTAUNITS, bShowField);</span>
<span class="nc" id="L451">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.PARTNERDELTAUNITS, bEditField);</span>

        /* Determine whether the price field should be visible */
<span class="nc bnc" id="L454" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.PRICE);</span>
<span class="nc bnc" id="L455" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getPrice() != null;</span>
<span class="nc" id="L456">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.PRICE, bShowField);</span>
<span class="nc" id="L457">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.PRICE, bEditField);</span>

        /* Determine whether the commission field should be visible */
<span class="nc bnc" id="L460" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.COMMISSION);</span>
<span class="nc bnc" id="L461" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getCommission() != null;</span>
<span class="nc" id="L462">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.COMMISSION, bShowField);</span>
<span class="nc" id="L463">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.COMMISSION, bEditField);</span>

        /* Determine whether the dilution field should be visible */
<span class="nc bnc" id="L466" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.DILUTION);</span>
<span class="nc bnc" id="L467" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getDilution() != null;</span>
<span class="nc" id="L468">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.DILUTION, bShowField);</span>
<span class="nc" id="L469">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.DILUTION, bEditField);</span>

        /* Determine whether the returnedAccount field should be visible */
<span class="nc bnc" id="L472" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT);</span>
<span class="nc bnc" id="L473" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getReturnedCashAccount() != null;</span>
<span class="nc" id="L474">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT, bShowField);</span>
<span class="nc" id="L475">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT, bEditField);</span>

        /* Determine whether the returnedCash field should be visible */
<span class="nc bnc" id="L478" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.RETURNEDCASH);</span>
<span class="nc bnc" id="L479" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getReturnedCash() != null;</span>
<span class="nc" id="L480">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.RETURNEDCASH, bShowField);</span>
<span class="nc" id="L481">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.RETURNEDCASH, bEditField);</span>

        /* Determine whether the years field should be visible */
<span class="nc bnc" id="L484" title="All 4 branches missed.">        bEditField = isEditable &amp;&amp; isEditableField(myTrans, MoneyWiseTransInfoClass.QUALIFYYEARS);</span>
<span class="nc bnc" id="L485" title="All 4 branches missed.">        bShowField = bEditField || myTrans.getYears() != null;</span>
<span class="nc" id="L486">        theFieldSet.setFieldVisible(MoneyWiseTransInfoClass.QUALIFYYEARS, bShowField);</span>
<span class="nc" id="L487">        theFieldSet.setFieldEditable(MoneyWiseTransInfoClass.QUALIFYYEARS, bEditField);</span>

        /* Determine whether the reconciled field should be visible */
<span class="nc bnc" id="L490" title="All 4 branches missed.">        final boolean bShowReconciled = isEditable || bIsReconciled;</span>
<span class="nc" id="L491">        theReconciledState = bIsLocked;</span>
<span class="nc" id="L492">        theDirectionState = bIsReconciled;</span>
<span class="nc" id="L493">        theFieldSet.setFieldVisible(MoneyWiseBasicResource.TRANSACTION_RECONCILED, bShowReconciled);</span>
<span class="nc bnc" id="L494" title="All 4 branches missed.">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_RECONCILED, isEditable &amp;&amp; !bIsLocked);</span>

        /* Determine basic editing */
<span class="nc bnc" id="L497" title="All 4 branches missed.">        final boolean canEdit = isEditable &amp;&amp; !bIsReconciled;</span>
<span class="nc" id="L498">        final boolean needsNullAmount = myTrans.needsNullAmount();</span>
<span class="nc bnc" id="L499" title="All 4 branches missed.">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_DIRECTION, canEdit &amp;&amp; myTrans.canSwitchDirection());</span>
<span class="nc" id="L500">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, canEdit);</span>
<span class="nc" id="L501">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_PARTNER, canEdit);</span>
<span class="nc" id="L502">        theFieldSet.setFieldEditable(MoneyWiseBasicDataType.TRANSCATEGORY, canEdit);</span>
<span class="nc" id="L503">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE, canEdit);</span>
<span class="nc bnc" id="L504" title="All 4 branches missed.">        theFieldSet.setFieldEditable(MoneyWiseBasicResource.TRANSACTION_AMOUNT, canEdit &amp;&amp; !needsNullAmount);</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">        theFieldSet.setFieldVisible(MoneyWiseBasicResource.TRANSACTION_AMOUNT, !needsNullAmount);</span>

        /* Set the range for the dateButton */
<span class="nc" id="L508">        final MoneyWiseValidateTransaction myBuilder = (MoneyWiseValidateTransaction) myTrans.getList().getValidator();</span>
<span class="nc" id="L509">        theRange = myBuilder.getRange();</span>
<span class="nc" id="L510">    }</span>

    /**
     * Is the field editable?
     *
     * @param pTrans the transaction
     * @param pField the field class
     * @return true/false
     */
    public static boolean isEditableField(final MoneyWiseTransaction pTrans,
                                          final MoneyWiseTransInfoClass pField) {
        /* Access the infoSet */
<span class="nc" id="L522">        final MoneyWiseTransInfoSet myInfoSet = pTrans.getInfoSet();</span>

        /* If the transaction is reconciled */
<span class="nc bnc" id="L525" title="All 2 branches missed.">        if (Boolean.TRUE.equals(pTrans.isReconciled())) {</span>
            /* Only allow editing of metaData */
<span class="nc" id="L527">            return myInfoSet.isMetaData(pField);</span>
        }

        /* Check whether the field is available */
<span class="nc" id="L531">        final MoneyWiseValidateTransaction myValidator = (MoneyWiseValidateTransaction) pTrans.getList().getValidator();</span>
<span class="nc" id="L532">        final MetisFieldRequired isRequired = myValidator.isClassRequired(pTrans, pField);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">        return !isRequired.equals(MetisFieldRequired.NOTALLOWED);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    protected void updateField(final PrometheusFieldSetEvent pUpdate) throws OceanusException {
        /* Access the field */
<span class="nc" id="L540">        final MetisDataFieldId myField = pUpdate.getFieldId();</span>
<span class="nc" id="L541">        final MoneyWiseTransaction myTrans = getItem();</span>
<span class="nc" id="L542">        final MoneyWiseValidateTransaction myBuilder = (MoneyWiseValidateTransaction) myTrans.getList().getValidator();</span>

        /* Process updates */
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE.equals(myField)) {</span>
            /* Update the Date */
<span class="nc" id="L547">            myTrans.setDate(pUpdate.getValue(OceanusDate.class));</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_AMOUNT.equals(myField)) {</span>
            /* Update the Amount */
<span class="nc" id="L550">            myTrans.setAmount(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc" id="L551">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_ACCOUNT.equals(myField)) {</span>
            /* Update the Account */
<span class="nc" id="L554">            myTrans.setAccount(resolveAsset(pUpdate.getValue(MoneyWiseTransAsset.class)));</span>
<span class="nc" id="L555">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_DIRECTION.equals(myField)) {</span>
            /* Update the Direction */
<span class="nc" id="L558">            myTrans.switchDirection();</span>
<span class="nc" id="L559">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_PARTNER.equals(myField)) {</span>
            /* Update the Partner */
<span class="nc" id="L562">            myTrans.setPartner(resolveAsset(pUpdate.getValue(MoneyWiseTransAsset.class)));</span>
<span class="nc" id="L563">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">        } else if (MoneyWiseBasicDataType.TRANSCATEGORY.equals(myField)) {</span>
            /* Update the Category */
<span class="nc" id="L566">            myTrans.setCategory(pUpdate.getValue(MoneyWiseTransCategory.class));</span>
<span class="nc" id="L567">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">        } else if (MoneyWiseBasicResource.TRANSACTION_RECONCILED.equals(myField)) {</span>
            /* Update the Reconciled indication */
<span class="nc" id="L570">            myTrans.setReconciled(pUpdate.getValue(Boolean.class));</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.COMMENTS.equals(myField)) {</span>
            /* Update the Comments */
<span class="nc" id="L573">            myTrans.setComments(pUpdate.getValue(String.class));</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.REFERENCE.equals(myField)) {</span>
            /* Update the Reference */
<span class="nc" id="L576">            myTrans.setReference(pUpdate.getValue(String.class));</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.TRANSTAG.equals(myField)) {</span>
            /* Update the Tag indication */
<span class="nc" id="L579">            myTrans.setTransactionTags(pUpdate.getValue(List.class));</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.PARTNERAMOUNT.equals(myField)) {</span>
            /* Update the PartnerAmount */
<span class="nc" id="L582">            myTrans.setPartnerAmount(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.XCHANGERATE.equals(myField)) {</span>
            /* Update the ExchangeRate */
<span class="nc" id="L585">            myTrans.setExchangeRate(pUpdate.getValue(OceanusRatio.class));</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.ACCOUNTDELTAUNITS.equals(myField)) {</span>
            /* Update the AccountDeltaUnits */
<span class="nc" id="L588">            myTrans.setAccountDeltaUnits(pUpdate.getValue(OceanusUnits.class));</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.PARTNERDELTAUNITS.equals(myField)) {</span>
            /* Update the PartnerDeltaUnits */
<span class="nc" id="L591">            myTrans.setPartnerDeltaUnits(pUpdate.getValue(OceanusUnits.class));</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.PRICE.equals(myField)) {</span>
            /* Update the Price */
<span class="nc" id="L594">            myTrans.setPrice(pUpdate.getValue(OceanusPrice.class));</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.COMMISSION.equals(myField)) {</span>
            /* Update the Commission */
<span class="nc" id="L597">            myTrans.setCommission(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.DILUTION.equals(myField)) {</span>
            /* Update the Dilution */
<span class="nc" id="L600">            myTrans.setDilution(pUpdate.getValue(OceanusRatio.class));</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.QUALIFYYEARS.equals(myField)) {</span>
            /* Update the QualifyYears */
<span class="nc" id="L603">            myTrans.setYears(pUpdate.getValue(Integer.class));</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.RETURNEDCASHACCOUNT.equals(myField)) {</span>
            /* Update the ReturnedCashAccount */
<span class="nc" id="L606">            myTrans.setReturnedCashAccount(pUpdate.getValue(MoneyWiseTransAsset.class));</span>
<span class="nc" id="L607">            myBuilder.autoCorrect(myTrans);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.RETURNEDCASH.equals(myField)) {</span>
            /* Update the ReturnedCash */
<span class="nc" id="L610">            myTrans.setReturnedCash(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.TAXCREDIT.equals(myField)) {</span>
            /* Update the TaxCredit */
<span class="nc" id="L613">            myTrans.setTaxCredit(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.EMPLOYEENATINS.equals(myField)) {</span>
            /* Update the EmployeeNatIns */
<span class="nc" id="L616">            myTrans.setEmployeeNatIns(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.EMPLOYERNATINS.equals(myField)) {</span>
            /* Update the EmployerNayIns */
<span class="nc" id="L619">            myTrans.setEmployerNatIns(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.DEEMEDBENEFIT.equals(myField)) {</span>
            /* Update the Benefit */
<span class="nc" id="L622">            myTrans.setDeemedBenefit(pUpdate.getValue(OceanusMoney.class));</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">        } else if (MoneyWiseTransInfoClass.WITHHELD.equals(myField)) {</span>
            /* Update the Withheld */
<span class="nc" id="L625">            myTrans.setWithheld(pUpdate.getValue(OceanusMoney.class));</span>
        }
<span class="nc" id="L627">    }</span>

    @Override
    protected void declareGoToItems(final boolean pUpdates) {
        /* Access the item */
<span class="nc" id="L632">        final MoneyWiseTransaction myItem = getItem();</span>

        /* Access the analysis and the relevant filters */
<span class="nc" id="L635">        final MoneyWiseAnalysis myAnalysis = theAnalysisSelect.getAnalysis();</span>
<span class="nc" id="L636">        final OceanusDateRange myDateRange = theAnalysisSelect.getRange();</span>
<span class="nc" id="L637">        final MoneyWiseTransactionFilters myFilters = new MoneyWiseTransactionFilters(myAnalysis, myDateRange, myItem);</span>

        /* Remove the current filter */
<span class="nc" id="L640">        final MoneyWiseAnalysisFilter&lt;?, ?&gt; myCurrent = theAnalysisSelect.getFilter();</span>
<span class="nc" id="L641">        myFilters.remove(myCurrent);</span>

        /* Loop through the filters */
<span class="nc" id="L644">        final Iterator&lt;MoneyWiseAnalysisFilter&lt;?, ?&gt;&gt; myIterator = myFilters.iterator();</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L646">            final MoneyWiseAnalysisFilter&lt;?, ?&gt; myFilter = myIterator.next();</span>

            /* declare it */
<span class="nc" id="L649">            declareGoToFilter(myFilter);</span>
<span class="nc" id="L650">        }</span>

        /* If we have not had updates */
<span class="nc bnc" id="L653" title="All 2 branches missed.">        if (!pUpdates) {</span>
            /* Allow GoTo different panels */
<span class="nc" id="L655">            buildAssetGoTo(myItem.getAccount());</span>
<span class="nc" id="L656">            buildAssetGoTo(myItem.getPartner());</span>
<span class="nc" id="L657">            declareGoToItem(myItem.getCategory());</span>
<span class="nc" id="L658">            buildAssetGoTo(myItem.getReturnedCashAccount());</span>
        }
<span class="nc" id="L660">    }</span>

    /**
     * Handle goto declarations for TransactionAssets.
     *
     * @param pAsset the asset
     */
    private void buildAssetGoTo(final MoneyWiseTransAsset pAsset) {
<span class="nc bnc" id="L668" title="All 2 branches missed.">        if (pAsset instanceof MoneyWiseSecurityHolding) {</span>
            /* Build menu Items for Portfolio and Security */
<span class="nc" id="L670">            final MoneyWiseSecurityHolding myHolding = (MoneyWiseSecurityHolding) pAsset;</span>
<span class="nc" id="L671">            declareGoToItem(myHolding.getPortfolio());</span>
<span class="nc" id="L672">            declareGoToItem(myHolding.getSecurity());</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">        } else if (pAsset instanceof MoneyWiseAssetBase) {</span>
<span class="nc" id="L674">            declareGoToItem((MoneyWiseAssetBase) pAsset);</span>
        }
<span class="nc" id="L676">    }</span>

    /**
     * Resolve Asset.
     *
     * @param pAsset the asset to resolve
     * @return the resolved asset
     */
    public static MoneyWiseTransAsset resolveAsset(final MoneyWiseTransAsset pAsset) {
        /* If this is a security holding */
<span class="nc bnc" id="L686" title="All 2 branches missed.">        if (pAsset instanceof MoneyWiseSecurityHolding) {</span>
            /* declare holding via map */
<span class="nc" id="L688">            final MoneyWiseSecurityHolding myHolding = (MoneyWiseSecurityHolding) pAsset;</span>
<span class="nc" id="L689">            final MoneyWisePortfolio myPortfolio = myHolding.getPortfolio();</span>
<span class="nc" id="L690">            final MoneyWiseSecurity mySecurity = myHolding.getSecurity();</span>
<span class="nc" id="L691">            final MoneyWiseDataSet myData = myPortfolio.getDataSet();</span>
<span class="nc" id="L692">            final MoneyWiseSecurityHoldingMap myMap = myData.getPortfolios().getSecurityHoldingsMap();</span>
<span class="nc" id="L693">            return myMap.declareHolding(myPortfolio, mySecurity);</span>
        }

        /* Just return the asset */
<span class="nc" id="L697">        return pAsset;</span>
    }

    /**
     * Build the account menu for an item.
     *
     * @param pMenu  the menu
     * @param pTrans the transaction to build for
     */
    public void buildAccountMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                 final MoneyWiseTransaction pTrans) {
        /* Clear the menu */
<span class="nc" id="L709">        pMenu.removeAllItems();</span>

        /* Add possible items */
<span class="nc" id="L712">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class), true, pTrans);</span>
<span class="nc" id="L713">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.CASH, MoneyWiseCashList.class), true, pTrans);</span>
<span class="nc" id="L714">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.LOAN, MoneyWiseLoanList.class), true, pTrans);</span>
<span class="nc" id="L715">        buildHoldingMenu(pMenu, true, pTrans);</span>
<span class="nc" id="L716">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class), true, pTrans);</span>
<span class="nc" id="L717">    }</span>

    /**
     * Build the partner menu for an item.
     *
     * @param pMenu  the menu
     * @param pTrans the transaction to build for
     */
    public void buildPartnerMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                 final MoneyWiseTransaction pTrans) {
        /* Clear the menu */
<span class="nc" id="L728">        pMenu.removeAllItems();</span>

        /* Add possible items */
<span class="nc" id="L731">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class), false, pTrans);</span>
<span class="nc" id="L732">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.CASH, MoneyWiseCashList.class), false, pTrans);</span>
<span class="nc" id="L733">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.LOAN, MoneyWiseLoanList.class), false, pTrans);</span>
<span class="nc" id="L734">        buildHoldingMenu(pMenu, false, pTrans);</span>
<span class="nc" id="L735">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class), false, pTrans);</span>
<span class="nc" id="L736">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.PAYEE, MoneyWisePayeeList.class), false, pTrans);</span>
<span class="nc" id="L737">    }</span>

    /**
     * Build the asset menu for an item.
     *
     * @param &lt;T&gt;        the Asset type
     * @param pMenu      the menu
     * @param pIsAccount is this item the account rather than partner
     * @param pList      the asset list
     * @param pTrans     the transaction to build for
     */
    private static &lt;T extends MoneyWiseAssetBase&gt; void buildAssetMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                                                      final MoneyWiseAssetBaseList&lt;T&gt; pList,
                                                                      final boolean pIsAccount,
                                                                      final MoneyWiseTransaction pTrans) {
        /* Record active item */
<span class="nc" id="L753">        final MoneyWiseTransAsset myAccount = pTrans.getAccount();</span>
<span class="nc" id="L754">        final MoneyWiseTransCategory myCategory = pTrans.getCategory();</span>
<span class="nc" id="L755">        final MoneyWiseDataValidatorTrans&lt;?&gt; myValidator = pTrans.getList().getValidator();</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">        final MoneyWiseTransAsset myCurr = pIsAccount</span>
<span class="nc" id="L757">                ? myAccount</span>
<span class="nc" id="L758">                : pTrans.getPartner();</span>
<span class="nc" id="L759">        TethysUIScrollItem&lt;MoneyWiseTransAsset&gt; myActive = null;</span>
<span class="nc" id="L760">        TethysUIScrollSubMenu&lt;MoneyWiseTransAsset&gt; myMenu = null;</span>

        /* Loop through the available values */
<span class="nc" id="L763">        final Iterator&lt;T&gt; myIterator = pList.iterator();</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L765">            final T myAsset = myIterator.next();</span>

            /* Only process non-deleted/non-closed items */
<span class="nc bnc" id="L768" title="All 4 branches missed.">            boolean bIgnore = myAsset.isDeleted() || myAsset.isClosed();</span>

            /* Check whether the asset is allowable for the owner */
<span class="nc bnc" id="L771" title="All 2 branches missed.">            bIgnore |= !(pIsAccount</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                    ? myValidator.isValidAccount(myAsset)</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">                    : myValidator.isValidPartner(myAccount, myCategory, myAsset));</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">            if (bIgnore) {</span>
<span class="nc" id="L775">                continue;</span>
            }

            /* If this the first item */
<span class="nc bnc" id="L779" title="All 2 branches missed.">            if (myMenu == null) {</span>
                /* Create a new subMenu and add it to the popUp */
<span class="nc" id="L781">                myMenu = pMenu.addSubMenu(pList.getItemType().getItemName());</span>
            }

            /* Create a new MenuItem and add it to the popUp */
<span class="nc" id="L785">            final TethysUIScrollItem&lt;MoneyWiseTransAsset&gt; myItem = myMenu.getSubMenu().addItem(myAsset);</span>

            /* If this is the active category */
<span class="nc bnc" id="L788" title="All 2 branches missed.">            if (myAsset.equals(myCurr)) {</span>
                /* Record it */
<span class="nc" id="L790">                myActive = myItem;</span>
            }
<span class="nc" id="L792">        }</span>

        /* Ensure active item is visible */
<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (myActive != null) {</span>
<span class="nc" id="L796">            myActive.scrollToItem();</span>
        }
<span class="nc" id="L798">    }</span>

    /**
     * Build the holding asset menu for an item.
     *
     * @param pMenu      the menu
     * @param pIsAccount is this item the account rather than partner
     * @param pTrans     the transaction to build for
     */
    private static void buildHoldingMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                         final boolean pIsAccount,
                                         final MoneyWiseTransaction pTrans) {
        /* Record active item */
<span class="nc" id="L811">        final MoneyWiseTransAsset myAccount = pTrans.getAccount();</span>
<span class="nc" id="L812">        final MoneyWiseTransCategory myCategory = pTrans.getCategory();</span>
<span class="nc" id="L813">        final MoneyWiseDataValidatorTrans&lt;?&gt; myValidator = pTrans.getList().getValidator();</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">        final MoneyWiseTransAsset myCurr = pIsAccount</span>
<span class="nc" id="L815">                ? myAccount</span>
<span class="nc" id="L816">                : pTrans.getPartner();</span>
<span class="nc" id="L817">        TethysUIScrollItem&lt;MoneyWiseTransAsset&gt; myActive = null;</span>
<span class="nc" id="L818">        TethysUIScrollSubMenu&lt;MoneyWiseTransAsset&gt; myMenu = null;</span>

        /* Access Portfolios and Holdings Map */
<span class="nc" id="L821">        final MoneyWiseDataSet myData = pTrans.getDataSet();</span>
<span class="nc" id="L822">        final MoneyWisePortfolioList myPortfolios = myData.getPortfolios();</span>
<span class="nc" id="L823">        final MoneyWiseSecurityHoldingMap myMap = myPortfolios.getSecurityHoldingsMap();</span>

        /* Loop through the Portfolios */
<span class="nc" id="L826">        final Iterator&lt;MoneyWisePortfolio&gt; myPortIterator = myPortfolios.iterator();</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">        while (myPortIterator.hasNext()) {</span>
<span class="nc" id="L828">            final MoneyWisePortfolio myPortfolio = myPortIterator.next();</span>
<span class="nc" id="L829">            TethysUIScrollSubMenu&lt;MoneyWiseTransAsset&gt; myCoreMenu = null;</span>

            /* Ignore deleted or closed */
<span class="nc bnc" id="L832" title="All 2 branches missed.">            if (myPortfolio.isDeleted()</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">                    || Boolean.TRUE.equals(myPortfolio.isClosed())) {</span>
<span class="nc" id="L834">                continue;</span>
            }

            /* Look for existing and new holdings */
<span class="nc" id="L838">            final Iterator&lt;MoneyWiseSecurityHolding&gt; myExistIterator = myMap.existingIterator(myPortfolio);</span>
<span class="nc" id="L839">            final Iterator&lt;MoneyWiseSecurityHolding&gt; myNewIterator = myMap.newIterator(myPortfolio);</span>
<span class="nc bnc" id="L840" title="All 4 branches missed.">            if ((myExistIterator != null) || (myNewIterator != null)) {</span>
                /* If there are existing elements */
<span class="nc bnc" id="L842" title="All 2 branches missed.">                if (myExistIterator != null) {</span>
                    /* Loop through them */
<span class="nc bnc" id="L844" title="All 2 branches missed.">                    while (myExistIterator.hasNext()) {</span>
<span class="nc" id="L845">                        final MoneyWiseSecurityHolding myHolding = myExistIterator.next();</span>
<span class="nc" id="L846">                        final MoneyWiseSecurity mySecurity = myHolding.getSecurity();</span>

                        /* Check whether the asset is allowable for the owner */
<span class="nc bnc" id="L849" title="All 2 branches missed.">                        final boolean bIgnore = !(pIsAccount</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">                                ? myValidator.isValidAccount(myHolding)</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">                                : myValidator.isValidPartner(myAccount, myCategory, myHolding));</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">                        if (bIgnore) {</span>
<span class="nc" id="L853">                            continue;</span>
                        }

                        /* Ensure that hierarchy is created */
<span class="nc bnc" id="L857" title="All 2 branches missed.">                        if (myMenu == null) {</span>
                            /* Create a new JMenu and add it to the popUp */
<span class="nc" id="L859">                            myMenu = pMenu.addSubMenu(MoneyWiseAssetType.SECURITYHOLDING.toString());</span>
                        }
<span class="nc bnc" id="L861" title="All 2 branches missed.">                        if (myCoreMenu == null) {</span>
                            /* Create a new JMenu and add it to the popUp */
<span class="nc" id="L863">                            myCoreMenu = myMenu.getSubMenu().addSubMenu(myPortfolio.getName());</span>
                        }

                        /* Add the item to the menu */
<span class="nc" id="L867">                        final TethysUIScrollItem&lt;MoneyWiseTransAsset&gt; myItem = myCoreMenu.getSubMenu().addItem(myHolding, mySecurity.getName());</span>

                        /* If this is the active holding */
<span class="nc bnc" id="L870" title="All 2 branches missed.">                        if (mySecurity.equals(myCurr)) {</span>
                            /* Record it */
<span class="nc" id="L872">                            myActive = myItem;</span>
                        }
<span class="nc" id="L874">                    }</span>
                }

                /* If there are new elements */
<span class="nc bnc" id="L878" title="All 2 branches missed.">                if (myNewIterator != null) {</span>
                    /* Loop through them */
<span class="nc" id="L880">                    TethysUIScrollSubMenu&lt;MoneyWiseTransAsset&gt; mySubMenu = null;</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">                    while (myNewIterator.hasNext()) {</span>
<span class="nc" id="L882">                        final MoneyWiseSecurityHolding myHolding = myNewIterator.next();</span>
<span class="nc" id="L883">                        final MoneyWiseSecurity mySecurity = myHolding.getSecurity();</span>

                        /* Check whether the asset is allowable for the owner */
<span class="nc bnc" id="L886" title="All 2 branches missed.">                        final boolean bIgnore = !(pIsAccount</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">                                ? myValidator.isValidAccount(myHolding)</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">                                : myValidator.isValidPartner(myAccount, myCategory, myHolding));</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">                        if (bIgnore) {</span>
<span class="nc" id="L890">                            continue;</span>
                        }

                        /* Ensure that hierarchy is created */
<span class="nc bnc" id="L894" title="All 2 branches missed.">                        if (myMenu == null) {</span>
                            /* Create a new subMenu and add it to the popUp */
<span class="nc" id="L896">                            myMenu = pMenu.addSubMenu(MoneyWiseAssetType.SECURITYHOLDING.toString());</span>
                        }
<span class="nc bnc" id="L898" title="All 2 branches missed.">                        if (myCoreMenu == null) {</span>
                            /* Create a new subMenu and add it to the popUp */
<span class="nc" id="L900">                            myCoreMenu = myMenu.getSubMenu().addSubMenu(myPortfolio.getName());</span>
                        }
<span class="nc bnc" id="L902" title="All 2 branches missed.">                        if (mySubMenu == null) {</span>
                            /* Create a new subMenu */
<span class="nc" id="L904">                            mySubMenu = myCoreMenu.getSubMenu().addSubMenu(MoneyWiseSecurityHolding.SECURITYHOLDING_NEW);</span>
                        }

                        /* Add the item to the menu */
<span class="nc" id="L908">                        mySubMenu.getSubMenu().addItem(myHolding, mySecurity.getName());</span>
<span class="nc" id="L909">                    }</span>
                }
            }
<span class="nc" id="L912">        }</span>

        /* Ensure active item is visible */
<span class="nc bnc" id="L915" title="All 2 branches missed.">        if (myActive != null) {</span>
<span class="nc" id="L916">            myActive.scrollToItem();</span>
        }
<span class="nc" id="L918">    }</span>

    /**
     * Build the category menu for an item.
     *
     * @param pMenu  the menu
     * @param pTrans the transaction to build for
     */
    public void buildCategoryMenu(final TethysUIScrollMenu&lt;MoneyWiseTransCategory&gt; pMenu,
                                  final MoneyWiseTransaction pTrans) {
        /* Clear the menu */
<span class="nc" id="L929">        pMenu.removeAllItems();</span>

        /* Record active item */
<span class="nc" id="L932">        final MoneyWiseTransAsset myAccount = pTrans.getAccount();</span>
<span class="nc" id="L933">        final MoneyWiseTransCategory myCurr = pTrans.getCategory();</span>
<span class="nc" id="L934">        TethysUIScrollItem&lt;MoneyWiseTransCategory&gt; myActive = null;</span>
        TethysUIScrollItem&lt;MoneyWiseTransCategory&gt; myItem;

        /* Create a simple map for top-level categories */
<span class="nc" id="L938">        final Map&lt;String, TethysUIScrollSubMenu&lt;MoneyWiseTransCategory&gt;&gt; myMap = new HashMap&lt;&gt;();</span>

        /* Access Categories */
<span class="nc" id="L941">        final MoneyWiseTransCategoryList myCategories = getDataList(MoneyWiseBasicDataType.TRANSCATEGORY, MoneyWiseTransCategoryList.class);</span>
<span class="nc" id="L942">        final MoneyWiseDataValidatorTrans&lt;?&gt; myValidator = pTrans.getList().getValidator();</span>

        /* Loop through the available category values */
<span class="nc" id="L945">        final Iterator&lt;MoneyWiseTransCategory&gt; myIterator = myCategories.iterator();</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L947">            final MoneyWiseTransCategory myCategory = myIterator.next();</span>

            /* Only process non-deleted low-level items */
<span class="nc" id="L950">            final MoneyWiseTransCategoryClass myClass = myCategory.getCategoryTypeClass();</span>
<span class="nc bnc" id="L951" title="All 4 branches missed.">            boolean bIgnore = myCategory.isDeleted() || myClass.canParentCategory();</span>

            /* Check whether the category is allowable for the owner */
<span class="nc bnc" id="L954" title="All 2 branches missed.">            bIgnore |= !myValidator.isValidCategory(myAccount, myCategory);</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">            if (bIgnore) {</span>
<span class="nc" id="L956">                continue;</span>
            }

            /* Determine parent */
<span class="nc" id="L960">            final MoneyWiseTransCategory myParent = myCategory.getParentCategory();</span>

            /* If we have a parent */
<span class="nc bnc" id="L963" title="All 2 branches missed.">            if (myParent != null) {</span>
<span class="nc" id="L964">                final String myParentName = myParent.getName();</span>
<span class="nc" id="L965">                final TethysUIScrollSubMenu&lt;MoneyWiseTransCategory&gt; myMenu = myMap.computeIfAbsent(myParentName, pMenu::addSubMenu);</span>

                /* Create a new MenuItem and add it to the subMenu */
<span class="nc" id="L968">                myItem = myMenu.getSubMenu().addItem(myCategory, myCategory.getSubCategory());</span>

<span class="nc" id="L970">            } else {</span>
                /* Create a new MenuItem and add it to the popUp */
<span class="nc" id="L972">                myItem = pMenu.addItem(myCategory);</span>
            }

            /* If this is the active category */
<span class="nc bnc" id="L976" title="All 2 branches missed.">            if (myCategory.equals(myCurr)) {</span>
                /* Record it */
<span class="nc" id="L978">                myActive = myItem;</span>
            }
<span class="nc" id="L980">        }</span>

        /* Ensure active item is visible */
<span class="nc bnc" id="L983" title="All 2 branches missed.">        if (myActive != null) {</span>
<span class="nc" id="L984">            myActive.scrollToItem();</span>
        }
<span class="nc" id="L986">    }</span>

    /**
     * Build the ReturnedAccount menu for an item.
     *
     * @param pMenu  the menu
     * @param pTrans the transaction to build for
     */
    public void buildReturnedAccountMenu(final TethysUIScrollMenu&lt;MoneyWiseTransAsset&gt; pMenu,
                                         final MoneyWiseTransaction pTrans) {
        /* Clear the menu */
<span class="nc" id="L997">        pMenu.removeAllItems();</span>

        /* Add possible items */
<span class="nc" id="L1000">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class), false, pTrans);</span>
<span class="nc" id="L1001">        buildAssetMenu(pMenu, getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class), false, pTrans);</span>
<span class="nc" id="L1002">    }</span>

    /**
     * Build the possible TransactionTag list.
     *
     * @return the transaction tag iterator
     */
    public Iterator&lt;MoneyWiseTransTag&gt; buildTransactionTags() {
        /* Create a list */
<span class="nc" id="L1011">        final List&lt;MoneyWiseTransTag&gt; myList = new ArrayList&lt;&gt;();</span>

        /* Loop through the TransactionTags */
<span class="nc" id="L1014">        final Iterator&lt;MoneyWiseTransTag&gt; myIterator = getItem().getDataSet().getTransactionTags().iterator();</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1016">            final MoneyWiseTransTag myTag = myIterator.next();</span>

            /* Add to list if available */
<span class="nc bnc" id="L1019" title="All 2 branches missed.">            if (!myTag.isDeleted()) {</span>
<span class="nc" id="L1020">                myList.add(myTag);</span>
            }
<span class="nc" id="L1022">        }</span>

        /* Return the iterator */
<span class="nc" id="L1025">        return myList.iterator();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>