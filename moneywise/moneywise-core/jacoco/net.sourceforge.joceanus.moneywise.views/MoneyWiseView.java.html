<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.views</a> &gt; <span class="el_source">MoneyWiseView.java</span></div><h1>MoneyWiseView.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.views;

import net.sourceforge.joceanus.metis.viewer.MetisViewerEntry;
import net.sourceforge.joceanus.moneywise.data.validate.MoneyWiseValidatorFactory;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.analyse.MoneyWiseAnalysisTransAnalyser;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysis;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisManager;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTax.MoneyWiseTaxFactory;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseCurrency;
import net.sourceforge.joceanus.moneywise.database.MoneyWiseDataStore;
import net.sourceforge.joceanus.moneywise.sheets.MoneyWiseSheet;
import net.sourceforge.joceanus.prometheus.toolkit.PrometheusToolkit;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataSet;
import net.sourceforge.joceanus.prometheus.database.PrometheusDBConfig;
import net.sourceforge.joceanus.prometheus.database.PrometheusDataStore;
import net.sourceforge.joceanus.prometheus.database.PrometheusDatabase.PrometheusDatabasePreferenceKey;
import net.sourceforge.joceanus.prometheus.database.PrometheusDatabase.PrometheusDatabasePreferences;
import net.sourceforge.joceanus.prometheus.sheets.PrometheusSpreadSheet;
import net.sourceforge.joceanus.prometheus.views.PrometheusDataControl;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditSet;
import net.sourceforge.joceanus.prometheus.views.PrometheusViewerEntryId;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.date.OceanusDateRange;
import net.sourceforge.joceanus.oceanus.profile.OceanusProfile;

/**
 * Data Control for MoneyWiseApp.
 */
public class MoneyWiseView
        extends PrometheusDataControl {
    /**
     * The TaxFactory.
     */
    private final MoneyWiseTaxFactory theTaxFactory;

    /**
     * The Maps.
     */
    private final MoneyWiseMaps theMaps;

    /**
     * The DataSet.
     */
    private MoneyWiseDataSet theData;

    /**
     * The analysis manager.
     */
    private MoneyWiseAnalysisManager theAnalysisMgr;

    /**
     * Do we have security buckets?.
     */
    private boolean hasActiveSecurities;

    /**
     * Do we have multiple currencies?
     */
    private boolean hasMultiCurrency;

    /**
     * Constructor.
     * @param pUtilitySet the utility set
     * @param pTaxFactory the tax factory
     */
    public MoneyWiseView(final PrometheusToolkit pUtilitySet,
                         final MoneyWiseTaxFactory pTaxFactory) {
        /* Call super-constructor */
<span class="fc" id="L86">        super(pUtilitySet);</span>

        /* Record the tax factory */
<span class="fc" id="L89">        theTaxFactory = pTaxFactory;</span>

        /* Create the validator factory */
<span class="fc" id="L92">        setValidatorFactory(new MoneyWiseValidatorFactory());</span>

        /* Create an empty data set */
<span class="fc" id="L95">        setData(getNewData());</span>

        /* Create the maps */
<span class="fc" id="L98">        theMaps = new MoneyWiseMaps(this);</span>
<span class="fc" id="L99">    }</span>

    /**
     * Obtain the date range.
     * @return the date range
     */
    public OceanusDateRange getRange() {
<span class="nc" id="L106">        return theTaxFactory.getDateRange();</span>
    }

    /**
     * Obtain the analysis manager.
     * @return the analyser.
     */
    public MoneyWiseAnalysisManager getAnalysisManager() {
<span class="nc" id="L114">        return theAnalysisMgr;</span>
    }

    /**
     * Do we have active securities?
     * @return true/false.
     */
    public boolean hasActiveSecurities() {
<span class="nc" id="L122">        return hasActiveSecurities;</span>
    }

    /**
     * Do we have multiple currencies?
     * @return true/false.
     */
    public boolean hasMultipleCurrencies() {
<span class="nc" id="L130">        return hasMultiCurrency;</span>
    }

    /**
     * Obtain a new DataSet.
     * @return new DataSet
     */
    @Override
    public final MoneyWiseDataSet getNewData() {
<span class="fc" id="L139">        final MoneyWiseDataSet myDataSet = new MoneyWiseDataSet(getToolkit(), theTaxFactory);</span>
<span class="fc" id="L140">        myDataSet.setValidatorFactory(getValidatorFactory());</span>
<span class="fc" id="L141">        return myDataSet;</span>
    }

    @Override
    public String getDatabaseName() {
<span class="nc" id="L146">        final PrometheusDatabasePreferences myPrefs = getPreferenceManager().getPreferenceSet(PrometheusDatabasePreferences.class);</span>
<span class="nc" id="L147">        return myPrefs.getStringValue(PrometheusDatabasePreferenceKey.DBNAME);</span>
    }

    @Override
    public PrometheusDataStore getDatabase() throws OceanusException {
<span class="nc" id="L152">        final PrometheusDatabasePreferences myPrefs = getPreferenceManager().getPreferenceSet(PrometheusDatabasePreferences.class);</span>
<span class="nc" id="L153">        final PrometheusDBConfig myConfig = PrometheusDBConfig.fromPrefs(myPrefs);</span>
<span class="nc" id="L154">        return new MoneyWiseDataStore(myPrefs.getStringValue(PrometheusDatabasePreferenceKey.DBNAME), myConfig);</span>
    }

    @Override
    public PrometheusDataStore getNullDatabase() throws OceanusException {
<span class="nc" id="L159">        final PrometheusDatabasePreferences myPrefs = getPreferenceManager().getPreferenceSet(PrometheusDatabasePreferences.class);</span>
<span class="nc" id="L160">        final PrometheusDBConfig myConfig = PrometheusDBConfig.fromPrefs(myPrefs);</span>
<span class="nc" id="L161">        return new MoneyWiseDataStore(myConfig);</span>
    }

    /**
     * Obtain a Database interface.
     * @return new DataSet
     */
    @Override
    public PrometheusSpreadSheet getSpreadSheet() {
<span class="nc" id="L170">        return new MoneyWiseSheet(getGuiFactory());</span>
    }

    /**
     * Update the data for a view.
     * @param pData the new data set
     */
    @Override
    public final void setData(final PrometheusDataSet pData) {
        /* Record the data */
<span class="fc" id="L180">        theData = (MoneyWiseDataSet) pData;</span>
<span class="fc" id="L181">        super.setData(pData);</span>

<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (theMaps != null) {</span>
<span class="nc" id="L184">            theMaps.adjustForDataSet(pData);</span>
        }
<span class="fc" id="L186">    }</span>

    @Override
    public MoneyWiseDataSet getData() {
<span class="fc" id="L190">        return theData;</span>
    }

    /**
     * Analyse the data.
     * @param pData the data
     * @return the analysis
     * @throws OceanusException on error
     */
    public final MoneyWiseAnalysisTransAnalyser analyseData(final MoneyWiseDataSet pData) throws OceanusException {
        /* Obtain the active profile */
<span class="fc" id="L201">        OceanusProfile myTask = getActiveTask();</span>
<span class="fc" id="L202">        myTask = myTask.startTask(&quot;analyseData&quot;);</span>

        /* Update the maps */
<span class="fc" id="L205">        myTask.startTask(&quot;updateMaps&quot;);</span>
<span class="fc" id="L206">        pData.updateMaps();</span>

        /* Create the analysis */
<span class="fc" id="L209">        final PrometheusEditSet myEditSet = new PrometheusEditSet(this);</span>
<span class="fc" id="L210">        final MoneyWiseAnalysisTransAnalyser myAnalyser = new MoneyWiseAnalysisTransAnalyser(myTask, myEditSet, getPreferenceManager());</span>

        /* Post process the analysis */
<span class="fc" id="L213">        myAnalyser.postProcessAnalysis();</span>

        /* Complete the task */
<span class="fc" id="L216">        myTask.end();</span>

        /* Return the analyser */
<span class="fc" id="L219">        return myAnalyser;</span>
    }

    @Override
    protected boolean analyseData(final boolean bPreserve) {
        /* Obtain the active profile */
<span class="fc" id="L225">        OceanusProfile myTask = getActiveTask();</span>
<span class="fc" id="L226">        myTask = myTask.startTask(&quot;analyseTheData&quot;);</span>

        /* Clear the errors */
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">        if (!bPreserve) {</span>
<span class="fc" id="L230">            clearErrors();</span>
        }

        /* Protect against exceptions */
        try {
            /* Analyse the data */
<span class="fc" id="L236">            final MoneyWiseAnalysisTransAnalyser myAnalyser = analyseData(theData);</span>
<span class="fc" id="L237">            final MoneyWiseAnalysis myAnalysis = myAnalyser.getAnalysis();</span>
<span class="fc" id="L238">            theAnalysisMgr = new MoneyWiseAnalysisManager(myAnalysis);</span>

            /* Analyse the basic ranged analysis */
<span class="fc" id="L241">            myTask.startTask(&quot;AnalyseBase&quot;);</span>
<span class="fc" id="L242">            theAnalysisMgr.analyseBase();</span>
<span class="fc" id="L243">            hasMultiCurrency = theAnalysisMgr.haveForeignCurrency();</span>
<span class="fc" id="L244">            hasActiveSecurities = theAnalysisMgr.haveActiveSecurities();</span>

            /* Update the Data entry */
<span class="fc" id="L247">            final MetisViewerEntry myData = getViewerEntry(PrometheusViewerEntryId.ANALYSIS);</span>
<span class="fc" id="L248">            myData.setTreeObject(theAnalysisMgr);</span>

            /* Derive the update Set */
<span class="fc" id="L251">            myTask.startTask(&quot;deriveUpdates&quot;);</span>
<span class="fc" id="L252">            deriveUpdates();</span>

            /* Catch any exceptions */
<span class="nc" id="L255">        } catch (OceanusException e) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (!bPreserve) {</span>
<span class="nc" id="L257">                addError(e);</span>
            }
<span class="fc" id="L259">        }</span>

        /* Complete the task */
<span class="fc" id="L262">        myTask.end();</span>

        /* Return whether there was success */
<span class="fc" id="L265">        return getErrors().isEmpty();</span>
    }

    /**
     * Set the reporting currency.
     * @param pCurrency the new reporting currency
     */
    public void setReportingCurrency(final MoneyWiseCurrency pCurrency) {
        /* Set default currency in AccountCurrencies */
<span class="nc" id="L274">        theData.getAccountCurrencies().setReportingCurrency(pCurrency);</span>

        /* Set default currency in ExchangeRates */
<span class="nc" id="L277">        theData.getExchangeRates().setReportingCurrency(pCurrency);</span>

        /* Register the changes */
<span class="nc" id="L280">        incrementVersion();</span>
<span class="nc" id="L281">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>