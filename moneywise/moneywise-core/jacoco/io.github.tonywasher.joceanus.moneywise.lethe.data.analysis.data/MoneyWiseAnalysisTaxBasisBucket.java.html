<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseAnalysisTaxBasisBucket.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.data</a> &gt; <span class="el_source">MoneyWiseAnalysisTaxBasisBucket.java</span></div><h1>MoneyWiseAnalysisTaxBasisBucket.java</h1><pre class="source lang-java linenums">/*
 * MoneyWise: Finance Application
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.data;

import io.github.tonywasher.joceanus.oceanus.date.OceanusDate;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDateRange;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusDecimal;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusMoney;
import io.github.tonywasher.joceanus.oceanus.format.OceanusDataFormatter;
import io.github.tonywasher.joceanus.metis.data.MetisDataFieldValue;
import io.github.tonywasher.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import io.github.tonywasher.joceanus.metis.data.MetisDataItem.MetisDataList;
import io.github.tonywasher.joceanus.metis.field.MetisFieldItem;
import io.github.tonywasher.joceanus.metis.field.MetisFieldItem.MetisFieldTableItem;
import io.github.tonywasher.joceanus.metis.field.MetisFieldSet;
import io.github.tonywasher.joceanus.metis.list.MetisListIndexed;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetDirection;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseCurrency;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseStaticDataType;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTaxBasis;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTaxBasis.MoneyWiseTaxBasisList;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTaxClass;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.base.MoneyWiseAnalysisHistory;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisTaxBasisAccountBucket.MoneyWiseAnalysisTaxBasisAccountBucketList;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisTaxBasisAttr;
import io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisTaxBasisValues;
import io.github.tonywasher.joceanus.moneywise.tax.MoneyWiseChargeableGainSlice.MoneyWiseChargeableGainSliceList;
import io.github.tonywasher.joceanus.moneywise.tax.MoneyWiseTaxSource;
import io.github.tonywasher.joceanus.prometheus.views.PrometheusEditSet;

import java.util.Currency;
import java.util.Iterator;
import java.util.List;

/**
 * The TaxBasis Bucket class.
 */
public class MoneyWiseAnalysisTaxBasisBucket
        implements MetisFieldTableItem {
    /**
     * Local Report fields.
     */
<span class="fc" id="L61">    private static final MetisFieldSet&lt;MoneyWiseAnalysisTaxBasisBucket&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseAnalysisTaxBasisBucket.class);</span>

    /*
     * Declare Fields.
     */
    static {
<span class="fc" id="L67">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_NAME, MoneyWiseAnalysisTaxBasisBucket::getAnalysis);</span>
<span class="fc" id="L68">        FIELD_DEFS.declareLocalField(MoneyWiseStaticDataType.TAXBASIS, MoneyWiseAnalysisTaxBasisBucket::getTaxBasis);</span>
<span class="fc" id="L69">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.BUCKET_BASEVALUES, MoneyWiseAnalysisTaxBasisBucket::getBaseValues);</span>
<span class="fc" id="L70">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.BUCKET_HISTORY, MoneyWiseAnalysisTaxBasisBucket::getHistoryMap);</span>
<span class="fc" id="L71">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.TAXBASIS_ACCOUNTLIST, MoneyWiseAnalysisTaxBasisBucket::getAccounts);</span>
<span class="fc" id="L72">        FIELD_DEFS.declareLocalFieldsForEnum(MoneyWiseAnalysisTaxBasisAttr.class, MoneyWiseAnalysisTaxBasisBucket::getAttributeValue);</span>
    }

    /**
     * Totals bucket name.
     */
<span class="fc" id="L78">    private static final MetisDataFieldId NAME_TOTALS = MoneyWiseAnalysisDataResource.ANALYSIS_TOTALS;</span>

    /**
     * The analysis.
     */
    private final MoneyWiseAnalysis theAnalysis;

    /**
     * Tax Basis.
     */
    private final MoneyWiseTaxBasis theTaxBasis;

    /**
     * Values.
     */
    private final MoneyWiseAnalysisTaxBasisValues theValues;

    /**
     * The base values.
     */
    private final MoneyWiseAnalysisTaxBasisValues theBaseValues;

    /**
     * History Map.
     */
    private final MoneyWiseAnalysisHistory&lt;MoneyWiseAnalysisTaxBasisValues, MoneyWiseAnalysisTaxBasisAttr&gt; theHistory;

    /**
     * Do we have accounts?
     */
    private final boolean hasAccounts;

    /**
     * Are we an expense bucket?
     */
    private final boolean isExpense;

    /**
     * AccountBucketList.
     */
    private final MoneyWiseAnalysisTaxBasisAccountBucketList theAccounts;

    /**
     * Constructor.
     *
     * @param pAnalysis the analysis
     * @param pTaxBasis the basis
     */
    protected MoneyWiseAnalysisTaxBasisBucket(final MoneyWiseAnalysis pAnalysis,
<span class="fc" id="L127">                                              final MoneyWiseTaxBasis pTaxBasis) {</span>
        /* Store the parameters */
<span class="fc" id="L129">        theTaxBasis = pTaxBasis;</span>
<span class="fc" id="L130">        theAnalysis = pAnalysis;</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        isExpense = theTaxBasis != null</span>
<span class="pc bnc" id="L132" title="All 2 branches missed.">                &amp;&amp; theTaxBasis.getTaxClass().isExpense();</span>

        /* Create the history map */
<span class="fc" id="L135">        final MoneyWiseCurrency myDefault = theAnalysis.getCurrency();</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        final Currency myCurrency = myDefault == null</span>
<span class="fc" id="L137">                ? MoneyWiseAnalysisAccountBucket.DEFAULT_CURRENCY</span>
<span class="pc" id="L138">                : myDefault.getCurrency();</span>
<span class="fc" id="L139">        final MoneyWiseAnalysisTaxBasisValues myValues = new MoneyWiseAnalysisTaxBasisValues(myCurrency);</span>
<span class="fc" id="L140">        theHistory = new MoneyWiseAnalysisHistory&lt;&gt;(myValues);</span>

        /* Create the account list */
<span class="pc bpc" id="L143" title="3 of 4 branches missed.">        hasAccounts = theTaxBasis != null</span>
                &amp;&amp; !(this instanceof MoneyWiseAnalysisTaxBasisAccountBucket)
<span class="pc bnc" id="L145" title="All 2 branches missed.">                &amp;&amp; theTaxBasis.getTaxClass().analyseAccounts();</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        theAccounts = hasAccounts</span>
<span class="nc" id="L147">                ? new MoneyWiseAnalysisTaxBasisAccountBucketList(theAnalysis, this)</span>
<span class="fc" id="L148">                : null;</span>

        /* Access the key value maps */
<span class="fc" id="L151">        theValues = theHistory.getValues();</span>
<span class="fc" id="L152">        theBaseValues = theHistory.getBaseValues();</span>
<span class="fc" id="L153">    }</span>

    /**
     * Constructor.
     *
     * @param pAnalysis the analysis
     * @param pBase     the underlying bucket
     * @param pDate     the date for the bucket
     */
    protected MoneyWiseAnalysisTaxBasisBucket(final MoneyWiseAnalysis pAnalysis,
                                              final MoneyWiseAnalysisTaxBasisBucket pBase,
<span class="nc" id="L164">                                              final OceanusDate pDate) {</span>
        /* Copy details from base */
<span class="nc" id="L166">        theTaxBasis = pBase.getTaxBasis();</span>
<span class="nc" id="L167">        theAnalysis = pAnalysis;</span>
<span class="nc" id="L168">        isExpense = pBase.isExpense();</span>

        /* Access the relevant history */
<span class="nc" id="L171">        theHistory = new MoneyWiseAnalysisHistory&lt;&gt;(pBase.getHistoryMap(), pDate);</span>

        /* Create the account list */
<span class="nc" id="L174">        hasAccounts = pBase.hasAccounts();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        theAccounts = hasAccounts</span>
<span class="nc" id="L176">                ? new MoneyWiseAnalysisTaxBasisAccountBucketList(theAnalysis, this, pBase.getAccounts(), pDate)</span>
<span class="nc" id="L177">                : null;</span>

        /* Access the key value maps */
<span class="nc" id="L180">        theValues = theHistory.getValues();</span>
<span class="nc" id="L181">        theBaseValues = theHistory.getBaseValues();</span>
<span class="nc" id="L182">    }</span>

    /**
     * Constructor.
     *
     * @param pAnalysis the analysis
     * @param pBase     the underlying bucket
     * @param pRange    the range for the bucket
     */
    protected MoneyWiseAnalysisTaxBasisBucket(final MoneyWiseAnalysis pAnalysis,
                                              final MoneyWiseAnalysisTaxBasisBucket pBase,
<span class="nc" id="L193">                                              final OceanusDateRange pRange) {</span>
        /* Copy details from base */
<span class="nc" id="L195">        theTaxBasis = pBase.getTaxBasis();</span>
<span class="nc" id="L196">        theAnalysis = pAnalysis;</span>
<span class="nc" id="L197">        isExpense = pBase.isExpense();</span>

        /* Access the relevant history */
<span class="nc" id="L200">        theHistory = new MoneyWiseAnalysisHistory&lt;&gt;(pBase.getHistoryMap(), pRange);</span>

        /* Create the account list */
<span class="nc" id="L203">        hasAccounts = pBase.hasAccounts();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        theAccounts = hasAccounts</span>
<span class="nc" id="L205">                ? new MoneyWiseAnalysisTaxBasisAccountBucketList(theAnalysis, this, pBase.getAccounts(), pRange)</span>
<span class="nc" id="L206">                : null;</span>

        /* Access the key value maps */
<span class="nc" id="L209">        theValues = theHistory.getValues();</span>
<span class="nc" id="L210">        theBaseValues = theHistory.getBaseValues();</span>
<span class="nc" id="L211">    }</span>

    @Override
    public MetisFieldSet&lt;? extends MoneyWiseAnalysisTaxBasisBucket&gt; getDataFieldSet() {
<span class="nc" id="L215">        return FIELD_DEFS;</span>
    }

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L220">        return toString();</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L225">        return getName();</span>
    }

    @Override
    public Integer getIndexedId() {
<span class="nc" id="L230">        return theTaxBasis.getIndexedId();</span>
    }

    /**
     * Obtain name.
     *
     * @return the name
     */
    public String getName() {
<span class="nc bnc" id="L239" title="All 2 branches missed.">        return theTaxBasis == null</span>
<span class="nc" id="L240">                ? NAME_TOTALS.getId()</span>
<span class="nc" id="L241">                : theTaxBasis.getName();</span>
    }

    /**
     * Obtain tax basis.
     *
     * @return the basis
     */
    public MoneyWiseTaxBasis getTaxBasis() {
<span class="nc" id="L250">        return theTaxBasis;</span>
    }

    /**
     * Do we have accounts.
     *
     * @return true/false
     */
    public boolean hasAccounts() {
<span class="nc" id="L259">        return hasAccounts;</span>
    }

    /**
     * Is this an expense bucket.
     *
     * @return true/false
     */
    public boolean isExpense() {
<span class="nc" id="L268">        return isExpense;</span>
    }

    /**
     * Obtain account list.
     *
     * @return the account list
     */
    private MoneyWiseAnalysisTaxBasisAccountBucketList getAccounts() {
<span class="nc" id="L277">        return theAccounts;</span>
    }

    /**
     * Obtain account list iterator.
     *
     * @return the iterator
     */
    public Iterator&lt;MoneyWiseAnalysisTaxBasisAccountBucket&gt; accountIterator() {
<span class="nc bnc" id="L286" title="All 2 branches missed.">        return hasAccounts</span>
<span class="nc" id="L287">                ? theAccounts.iterator()</span>
<span class="nc" id="L288">                : null;</span>
    }

    /**
     * find an account bucket.
     *
     * @param pAccount the account
     * @return the bucket
     */
    public MoneyWiseAnalysisTaxBasisAccountBucket findAccountBucket(final MoneyWiseTransAsset pAccount) {
<span class="nc bnc" id="L298" title="All 2 branches missed.">        return hasAccounts</span>
<span class="nc" id="L299">                ? theAccounts.findBucket(pAccount)</span>
<span class="nc" id="L300">                : null;</span>
    }

    /**
     * Is this bucket idle?
     *
     * @return true/false
     */
    public Boolean isIdle() {
<span class="nc" id="L309">        return theHistory.isIdle();</span>
    }

    /**
     * Obtain the value map.
     *
     * @return the value map
     */
    public MoneyWiseAnalysisTaxBasisValues getValues() {
<span class="nc" id="L318">        return theValues;</span>
    }

    /**
     * Obtain the value for a particular attribute.
     *
     * @param pAttr the attribute
     * @return the value
     */
    public OceanusMoney getMoneyValue(final MoneyWiseAnalysisTaxBasisAttr pAttr) {
<span class="nc" id="L328">        return theValues.getMoneyValue(pAttr);</span>
    }

    /**
     * Obtain the base value map.
     *
     * @return the base value map
     */
    public MoneyWiseAnalysisTaxBasisValues getBaseValues() {
<span class="nc" id="L337">        return theBaseValues;</span>
    }

    /**
     * Obtain values for transaction.
     *
     * @param pTrans the event
     * @return the values (or null)
     */
    public MoneyWiseAnalysisTaxBasisValues getValuesForTransaction(final MoneyWiseTransaction pTrans) {
        /* Obtain values for event */
<span class="nc" id="L348">        return theHistory.getValuesForTransaction(pTrans);</span>
    }

    /**
     * Obtain previous values for transaction.
     *
     * @param pTrans the transaction
     * @return the values (or null)
     */
    public MoneyWiseAnalysisTaxBasisValues getPreviousValuesForTransaction(final MoneyWiseTransaction pTrans) {
<span class="nc" id="L358">        return theHistory.getPreviousValuesForTransaction(pTrans);</span>
    }

    /**
     * Obtain delta for transaction.
     *
     * @param pTrans the transaction
     * @param pAttr  the attribute
     * @return the delta (or null)
     */
    public OceanusDecimal getDeltaForTransaction(final MoneyWiseTransaction pTrans,
                                                 final MoneyWiseAnalysisTaxBasisAttr pAttr) {
        /* Obtain delta for event */
<span class="nc" id="L371">        return theHistory.getDeltaValue(pTrans, pAttr);</span>
    }

    /**
     * Obtain the history map.
     *
     * @return the history map
     */
    private MoneyWiseAnalysisHistory&lt;MoneyWiseAnalysisTaxBasisValues, MoneyWiseAnalysisTaxBasisAttr&gt; getHistoryMap() {
<span class="nc" id="L380">        return theHistory;</span>
    }

    /**
     * Obtain the analysis.
     *
     * @return the analysis
     */
    protected MoneyWiseAnalysis getAnalysis() {
<span class="nc" id="L389">        return theAnalysis;</span>
    }

    /**
     * Obtain date range.
     *
     * @return the range
     */
    public OceanusDateRange getDateRange() {
<span class="nc" id="L398">        return theAnalysis.getDateRange();</span>
    }

    /**
     * Set Attribute.
     *
     * @param pAttr  the attribute
     * @param pValue the value of the attribute
     */
    protected void setValue(final MoneyWiseAnalysisTaxBasisAttr pAttr,
                            final OceanusMoney pValue) {
        /* Set the value into the list */
<span class="nc" id="L410">        theValues.setValue(pAttr, pValue);</span>
<span class="nc" id="L411">    }</span>

    /**
     * Get an attribute value.
     *
     * @param pAttr the attribute
     * @return the value to set
     */
    private Object getAttributeValue(final MoneyWiseAnalysisTaxBasisAttr pAttr) {
        /* Access value of object */
<span class="nc" id="L421">        final Object myValue = getValue(pAttr);</span>

        /* Return the value */
<span class="nc bnc" id="L424" title="All 2 branches missed.">        return myValue != null</span>
<span class="nc" id="L425">                ? myValue</span>
<span class="nc" id="L426">                : MetisDataFieldValue.SKIP;</span>
    }

    /**
     * Obtain an attribute value.
     *
     * @param pAttr the attribute
     * @return the value of the attribute or null
     */
    private Object getValue(final MoneyWiseAnalysisTaxBasisAttr pAttr) {
        /* Obtain the attribute */
<span class="nc" id="L437">        return theValues.getValue(pAttr);</span>
    }

    /**
     * Add income transaction.
     *
     * @param pTrans the transaction
     */
    protected void addIncomeTransaction(final MoneyWiseAnalysisTransactionHelper pTrans) {
        /* Access details */
<span class="nc" id="L447">        final OceanusMoney myAmount = pTrans.getCreditAmount();</span>
<span class="nc" id="L448">        final OceanusMoney myTaxCredit = pTrans.getTaxCredit();</span>
<span class="nc" id="L449">        final OceanusMoney myNatIns = pTrans.getEmployeeNatIns();</span>
<span class="nc" id="L450">        final OceanusMoney myBenefit = pTrans.getDeemedBenefit();</span>
<span class="nc" id="L451">        final OceanusMoney myWithheld = pTrans.getWithheld();</span>

        /* Determine style of transaction */
<span class="nc" id="L454">        MoneyWiseAssetDirection myDir = pTrans.getDirection();</span>

        /* If the account is special */
<span class="nc" id="L457">        final MoneyWiseTransCategoryClass myClass = pTrans.getCategoryClass();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (myClass.isSwitchDirection()) {</span>
            /* switch the direction */
<span class="nc" id="L460">            myDir = myDir.reverse();</span>
        }

        /* Obtain zeroed counters */
<span class="nc" id="L464">        OceanusMoney myGross = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L465">        myGross = new OceanusMoney(myGross);</span>
<span class="nc" id="L466">        myGross.setZero();</span>
<span class="nc" id="L467">        final OceanusMoney myNett = new OceanusMoney(myGross);</span>
<span class="nc" id="L468">        final OceanusMoney myTax = new OceanusMoney(myGross);</span>

        /* If this is an expense */
<span class="nc bnc" id="L471" title="All 2 branches missed.">        if (myDir.isTo()) {</span>
            /* Adjust the gross and net */
<span class="nc" id="L473">            myGross.subtractAmount(myAmount);</span>
<span class="nc" id="L474">            myNett.subtractAmount(myAmount);</span>

            /* If we have a tax credit */
<span class="nc bnc" id="L477" title="All 2 branches missed.">            if (myTaxCredit != null</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">                    &amp;&amp; myTaxCredit.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L480">                myGross.subtractAmount(myTaxCredit);</span>
<span class="nc" id="L481">                myTax.subtractAmount(myTaxCredit);</span>
            }

            /* If we have a natInsurance payment */
<span class="nc bnc" id="L485" title="All 2 branches missed.">            if (myNatIns != null</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                    &amp;&amp; myNatIns.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L488">                myGross.subtractAmount(myNatIns);</span>
            }

            /* If we have a Benefit payment */
<span class="nc bnc" id="L492" title="All 2 branches missed.">            if (myBenefit != null</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                    &amp;&amp; myBenefit.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L495">                myGross.subtractAmount(myBenefit);</span>
            }

            /* If we have a Withheld */
<span class="nc bnc" id="L499" title="All 2 branches missed.">            if (myWithheld != null</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">                    &amp;&amp; myWithheld.isNonZero()) {</span>
                /* Adjust the gross and net */
<span class="nc" id="L502">                myGross.subtractAmount(myWithheld);</span>
<span class="nc" id="L503">                myNett.subtractAmount(myWithheld);</span>
            }

            /* else this is a standard income */
        } else {
            /* Adjust the gross and net */
<span class="nc" id="L509">            myGross.addAmount(myAmount);</span>
<span class="nc" id="L510">            myNett.addAmount(myAmount);</span>

            /* If we have a tax credit */
<span class="nc bnc" id="L513" title="All 2 branches missed.">            if (myTaxCredit != null</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                    &amp;&amp; myTaxCredit.isNonZero()) {</span>
                /* Adjust the values */
<span class="nc" id="L516">                myGross.addAmount(myTaxCredit);</span>
<span class="nc" id="L517">                myTax.addAmount(myTaxCredit);</span>
            }

            /* If we have a natInsurance payment */
<span class="nc bnc" id="L521" title="All 2 branches missed.">            if (myNatIns != null</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                    &amp;&amp; myNatIns.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L524">                myGross.addAmount(myNatIns);</span>
            }

            /* If we have a Benefit payment */
<span class="nc bnc" id="L528" title="All 2 branches missed.">            if (myBenefit != null</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">                    &amp;&amp; myBenefit.isNonZero()) {</span>
                /* Adjust the gross */
<span class="nc" id="L531">                myGross.addAmount(myBenefit);</span>
            }

            /* If we have a Withheld */
<span class="nc bnc" id="L535" title="All 2 branches missed.">            if (myWithheld != null</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                    &amp;&amp; myWithheld.isNonZero()) {</span>
                /* Adjust the gross and net */
<span class="nc" id="L538">                myGross.addAmount(myWithheld);</span>
<span class="nc" id="L539">                myNett.addAmount(myWithheld);</span>
            }
        }

        /* Register the delta values */
<span class="nc" id="L544">        registerDeltaValues(pTrans, myGross, myNett, myTax);</span>

        /* If we have accounts */
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (hasAccounts) {</span>
            /* register the changes against the accounts */
<span class="nc" id="L549">            theAccounts.registerDeltaValues(pTrans, myGross, myNett, myTax);</span>
        }
<span class="nc" id="L551">    }</span>

    /**
     * Add expense transaction.
     *
     * @param pTrans the transaction
     */
    protected void addExpenseTransaction(final MoneyWiseAnalysisTransactionHelper pTrans) {
        /* Access details */
<span class="nc" id="L560">        final OceanusMoney myAmount = pTrans.getDebitAmount();</span>
<span class="nc" id="L561">        final OceanusMoney myTaxCredit = pTrans.getTaxCredit();</span>

        /* Determine style of event */
<span class="nc" id="L564">        final MoneyWiseAssetDirection myDir = pTrans.getDirection();</span>

        /* Obtain zeroed counters */
<span class="nc" id="L567">        OceanusMoney myGross = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L568">        myGross = new OceanusMoney(myGross);</span>
<span class="nc" id="L569">        myGross.setZero();</span>
<span class="nc" id="L570">        final OceanusMoney myNett = new OceanusMoney(myGross);</span>
<span class="nc" id="L571">        final OceanusMoney myTax = new OceanusMoney(myGross);</span>

        /* If this is a refunded expense */
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (myDir.isFrom()) {</span>
            /* Adjust the gross and net */
<span class="nc" id="L576">            myGross.addAmount(myAmount);</span>
<span class="nc" id="L577">            myNett.addAmount(myAmount);</span>

            /* If we have a tax relief */
<span class="nc bnc" id="L580" title="All 2 branches missed.">            if (myTaxCredit != null</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                    &amp;&amp; myTaxCredit.isNonZero()) {</span>
                /* Adjust the values */
<span class="nc" id="L583">                myGross.addAmount(myTaxCredit);</span>
<span class="nc" id="L584">                myNett.addAmount(myTaxCredit);</span>
<span class="nc" id="L585">                myTax.addAmount(myTaxCredit);</span>
            }

            /* else this is a standard expense */
        } else {
            /* Adjust the gross and net */
<span class="nc" id="L591">            myGross.subtractAmount(myAmount);</span>
<span class="nc" id="L592">            myNett.subtractAmount(myAmount);</span>

            /* If we have a tax relief */
<span class="nc bnc" id="L595" title="All 2 branches missed.">            if (myTaxCredit != null</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                    &amp;&amp; myTaxCredit.isNonZero()) {</span>
                /* Adjust the values */
<span class="nc" id="L598">                myGross.subtractAmount(myTaxCredit);</span>
<span class="nc" id="L599">                myNett.subtractAmount(myTaxCredit);</span>
<span class="nc" id="L600">                myTax.subtractAmount(myTaxCredit);</span>
            }
        }

        /* Register the delta values */
<span class="nc" id="L605">        registerDeltaValues(pTrans, myGross, myNett, myTax);</span>

        /* If we have accounts */
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (hasAccounts) {</span>
            /* register the changes against the accounts */
<span class="nc" id="L610">            theAccounts.registerDeltaValues(pTrans, myGross, myNett, myTax);</span>
        }
<span class="nc" id="L612">    }</span>

    /**
     * Register delta transaction value.
     *
     * @param pTrans the transaction helper
     * @param pGross the gross delta value
     * @param pNett  the net delta value
     * @param pTax   the tax delta value
     */
    protected void registerDeltaValues(final MoneyWiseAnalysisTransactionHelper pTrans,
                                       final OceanusMoney pGross,
                                       final OceanusMoney pNett,
                                       final OceanusMoney pTax) {
        /* If we have a change to the gross value */
<span class="nc bnc" id="L627" title="All 2 branches missed.">        if (pGross.isNonZero()) {</span>
            /* Adjust Gross figure */
<span class="nc" id="L629">            OceanusMoney myGross = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L630">            myGross = new OceanusMoney(myGross);</span>
<span class="nc" id="L631">            myGross.addAmount(pGross);</span>
<span class="nc" id="L632">            setValue(MoneyWiseAnalysisTaxBasisAttr.GROSS, myGross);</span>
        }

        /* If we have a change to the net value */
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (pNett.isNonZero()) {</span>
            /* Adjust Net figure */
<span class="nc" id="L638">            OceanusMoney myNett = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.NETT);</span>
<span class="nc" id="L639">            myNett = new OceanusMoney(myNett);</span>
<span class="nc" id="L640">            myNett.addAmount(pNett);</span>
<span class="nc" id="L641">            setValue(MoneyWiseAnalysisTaxBasisAttr.NETT, myNett);</span>
        }

        /* If we have a change to the tax value */
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (pTax.isNonZero()) {</span>
            /* Adjust Tax figure */
<span class="nc" id="L647">            OceanusMoney myTax = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.TAXCREDIT);</span>
<span class="nc" id="L648">            myTax = new OceanusMoney(myTax);</span>
<span class="nc" id="L649">            myTax.addAmount(pTax);</span>
<span class="nc" id="L650">            setValue(MoneyWiseAnalysisTaxBasisAttr.TAXCREDIT, myTax);</span>
        }

        /* Register the transaction */
<span class="nc" id="L654">        registerTransaction(pTrans);</span>
<span class="nc" id="L655">    }</span>

    /**
     * Adjust transaction value.
     *
     * @param pTrans  the transaction
     * @param pValue  the value
     * @param pAdjust adjustment control
     */
    protected void adjustValue(final MoneyWiseAnalysisTransactionHelper pTrans,
                               final OceanusMoney pValue,
                               final MoneyWiseTaxBasisAdjust pAdjust) {
        /* Adjust the value */
<span class="nc" id="L668">        adjustValue(pValue, pAdjust);</span>

        /* Register the transaction */
<span class="nc" id="L671">        registerTransaction(pTrans);</span>

        /* If we have accounts */
<span class="nc bnc" id="L674" title="All 2 branches missed.">        if (hasAccounts) {</span>
            /* register the adjustment against the accounts */
<span class="nc" id="L676">            theAccounts.adjustValue(pTrans, pValue, pAdjust);</span>
        }
<span class="nc" id="L678">    }</span>

    /**
     * Adjust value.
     *
     * @param pValue  the value
     * @param pAdjust adjustment control
     */
    protected void adjustValue(final OceanusMoney pValue,
                               final MoneyWiseTaxBasisAdjust pAdjust) {
        /* If we are adjusting Gross */
<span class="nc bnc" id="L689" title="All 2 branches missed.">        if (pAdjust.adjustGross()) {</span>
            /* Access the existing value */
<span class="nc" id="L691">            OceanusMoney myGross = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L692">            myGross = new OceanusMoney(myGross);</span>

            /* Subtract or add the value depending as to whether we are an expense bucket */
<span class="nc bnc" id="L695" title="All 2 branches missed.">            if (isExpense) {</span>
<span class="nc" id="L696">                myGross.subtractAmount(pValue);</span>
            } else {
<span class="nc" id="L698">                myGross.addAmount(pValue);</span>
            }

            /* Record the new value */
<span class="nc" id="L702">            setValue(MoneyWiseAnalysisTaxBasisAttr.GROSS, myGross);</span>
        }

        /* If we are adjusting Nett */
<span class="nc bnc" id="L706" title="All 2 branches missed.">        if (pAdjust.adjustNett()) {</span>
            /* Access the existing value */
<span class="nc" id="L708">            OceanusMoney myNett = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.NETT);</span>
<span class="nc" id="L709">            myNett = new OceanusMoney(myNett);</span>

            /* Subtract or add the value depending as to whether we are an expense bucket */
<span class="nc bnc" id="L712" title="All 2 branches missed.">            if (isExpense) {</span>
<span class="nc" id="L713">                myNett.subtractAmount(pValue);</span>
            } else {
<span class="nc" id="L715">                myNett.addAmount(pValue);</span>
            }

            /* Record the new value */
<span class="nc" id="L719">            setValue(MoneyWiseAnalysisTaxBasisAttr.NETT, myNett);</span>
        }
<span class="nc" id="L721">    }</span>

    /**
     * Register the transaction.
     *
     * @param pTrans the transaction helper
     */
    protected void registerTransaction(final MoneyWiseAnalysisTransactionHelper pTrans) {
        /* Register the transaction in the history */
<span class="nc" id="L730">        theHistory.registerTransaction(pTrans.getTransaction(), theValues);</span>
<span class="nc" id="L731">    }</span>

    /**
     * Add values.
     *
     * @param pBucket tax category bucket
     */
    protected void addValues(final MoneyWiseAnalysisTaxBasisBucket pBucket) {
        /* Add the values */
<span class="nc" id="L740">        OceanusMoney myAmount = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
<span class="nc" id="L741">        myAmount.addAmount(pBucket.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS));</span>
<span class="nc" id="L742">        myAmount = theValues.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.NETT);</span>
<span class="nc" id="L743">        myAmount.addAmount(pBucket.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.NETT));</span>
<span class="nc" id="L744">    }</span>

    /**
     * Adjust to base.
     */
    protected void adjustToBase() {
        /* Adjust to base values */
<span class="nc" id="L751">        theValues.adjustToBaseValues(theBaseValues);</span>
<span class="nc" id="L752">        theBaseValues.resetBaseValues();</span>
<span class="nc" id="L753">    }</span>

    /**
     * Is the bucket active?
     *
     * @return true/false
     */
    public boolean isActive() {
<span class="nc" id="L761">        return theValues.isActive();</span>
    }

    /**
     * Value adjust Modes.
     */
<span class="nc" id="L767">    protected enum MoneyWiseTaxBasisAdjust {</span>
        /**
         * Adjust both Gross and Nett.
         */
<span class="nc" id="L771">        STANDARD,</span>

        /**
         * Only adjust Nett figure.
         */
<span class="nc" id="L776">        NETT,</span>

        /**
         * Only adjust Gross figure.
         */
<span class="nc" id="L781">        GROSS;</span>

        /**
         * should we adjust Gross?
         *
         * @return true/false
         */
        private boolean adjustGross() {
<span class="nc bnc" id="L789" title="All 2 branches missed.">            return this != NETT;</span>
        }

        /**
         * should we adjust Nett?
         *
         * @return true/false
         */
        private boolean adjustNett() {
<span class="nc bnc" id="L798" title="All 2 branches missed.">            return this != GROSS;</span>
        }
    }

    /**
     * TaxBasisBucketList class.
     */
    public static class MoneyWiseAnalysisTaxBasisBucketList
            implements MetisFieldItem, MoneyWiseTaxSource, MetisDataList&lt;MoneyWiseAnalysisTaxBasisBucket&gt; {
        /**
         * Local Report fields.
         */
<span class="fc" id="L810">        private static final MetisFieldSet&lt;MoneyWiseAnalysisTaxBasisBucketList&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseAnalysisTaxBasisBucketList.class);</span>

        /*
         * Declare Fields.
         */
        static {
<span class="fc" id="L816">            FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_NAME, MoneyWiseAnalysisTaxBasisBucketList::getAnalysis);</span>
<span class="fc" id="L817">            FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_CHARGES, MoneyWiseAnalysisTaxBasisBucketList::getGainSlices);</span>
<span class="fc" id="L818">            FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_TOTALS, MoneyWiseAnalysisTaxBasisBucketList::getTotals);</span>
<span class="fc" id="L819">        }</span>

        /**
         * The analysis.
         */
        private final MoneyWiseAnalysis theAnalysis;

        /**
         * The list.
         */
        private final MetisListIndexed&lt;MoneyWiseAnalysisTaxBasisBucket&gt; theList;

        /**
         * The editSet.
         */
        private final PrometheusEditSet theEditSet;

        /**
         * The chargeableGains.
         */
        private final MoneyWiseChargeableGainSliceList theCharges;

        /**
         * The tax basis.
         */
        private final MoneyWiseAnalysisTaxBasisBucket theTotals;

        /**
         * Construct a top-level List.
         *
         * @param pAnalysis the analysis
         * @param pGains    the new Gains list
         */
        private MoneyWiseAnalysisTaxBasisBucketList(final MoneyWiseAnalysis pAnalysis,
<span class="fc" id="L853">                                                    final MoneyWiseChargeableGainSliceList pGains) {</span>
<span class="fc" id="L854">            theAnalysis = pAnalysis;</span>
<span class="fc" id="L855">            theEditSet = theAnalysis.getEditSet();</span>
<span class="fc" id="L856">            theCharges = pGains;</span>
<span class="fc" id="L857">            theTotals = allocateTotalsBucket();</span>
<span class="fc" id="L858">            theList = new MetisListIndexed&lt;&gt;();</span>
<span class="pc" id="L859">            theList.setComparator((l, r) -&gt; l.getTaxBasis().compareTo(r.getTaxBasis()));</span>
<span class="fc" id="L860">        }</span>

        /**
         * Construct a top-level List.
         *
         * @param pAnalysis the analysis
         */
        protected MoneyWiseAnalysisTaxBasisBucketList(final MoneyWiseAnalysis pAnalysis) {
<span class="fc" id="L868">            this(pAnalysis, new MoneyWiseChargeableGainSliceList());</span>
<span class="fc" id="L869">        }</span>

        /**
         * Construct a dated List.
         *
         * @param pAnalysis the analysis
         * @param pBase     the base list
         * @param pDate     the Date
         */
        protected MoneyWiseAnalysisTaxBasisBucketList(final MoneyWiseAnalysis pAnalysis,
                                                      final MoneyWiseAnalysisTaxBasisBucketList pBase,
                                                      final OceanusDate pDate) {
            /* Initialise class */
<span class="nc" id="L882">            this(pAnalysis, new MoneyWiseChargeableGainSliceList(pBase.getGainSlices(), pAnalysis.getDateRange()));</span>

            /* Loop through the buckets */
<span class="nc" id="L885">            final Iterator&lt;MoneyWiseAnalysisTaxBasisBucket&gt; myIterator = pBase.iterator();</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L887">                final MoneyWiseAnalysisTaxBasisBucket myCurr = myIterator.next();</span>

                /* Access the bucket for this date */
<span class="nc" id="L890">                final MoneyWiseAnalysisTaxBasisBucket myBucket = new MoneyWiseAnalysisTaxBasisBucket(pAnalysis, myCurr, pDate);</span>

                /* If the bucket is non-idle */
<span class="nc bnc" id="L893" title="All 2 branches missed.">                if (Boolean.FALSE.equals(myBucket.isIdle())) {</span>
                    /* Calculate the delta and add to the list */
<span class="nc" id="L895">                    theList.add(myBucket);</span>
                }
<span class="nc" id="L897">            }</span>
<span class="nc" id="L898">        }</span>

        /**
         * Construct a ranged List.
         *
         * @param pAnalysis the analysis
         * @param pBase     the base list
         * @param pRange    the Date Range
         */
        protected MoneyWiseAnalysisTaxBasisBucketList(final MoneyWiseAnalysis pAnalysis,
                                                      final MoneyWiseAnalysisTaxBasisBucketList pBase,
                                                      final OceanusDateRange pRange) {
            /* Initialise class */
<span class="nc" id="L911">            this(pAnalysis, new MoneyWiseChargeableGainSliceList(pBase.getGainSlices(), pAnalysis.getDateRange()));</span>

            /* Loop through the buckets */
<span class="nc" id="L914">            final Iterator&lt;MoneyWiseAnalysisTaxBasisBucket&gt; myIterator = pBase.iterator();</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L916">                final MoneyWiseAnalysisTaxBasisBucket myCurr = myIterator.next();</span>

                /* Access the bucket for this range */
<span class="nc" id="L919">                final MoneyWiseAnalysisTaxBasisBucket myBucket = new MoneyWiseAnalysisTaxBasisBucket(pAnalysis, myCurr, pRange);</span>

                /* If the bucket is non-idle */
<span class="nc bnc" id="L922" title="All 2 branches missed.">                if (Boolean.FALSE.equals(myBucket.isIdle())) {</span>
                    /* Adjust to the base */
<span class="nc" id="L924">                    myBucket.adjustToBase();</span>
<span class="nc" id="L925">                    theList.add(myBucket);</span>
                }
<span class="nc" id="L927">            }</span>
<span class="nc" id="L928">        }</span>

        @Override
        public MetisFieldSet&lt;MoneyWiseAnalysisTaxBasisBucketList&gt; getDataFieldSet() {
<span class="nc" id="L932">            return FIELD_DEFS;</span>
        }

        @Override
        public List&lt;MoneyWiseAnalysisTaxBasisBucket&gt; getUnderlyingList() {
<span class="fc" id="L937">            return theList.getUnderlyingList();</span>
        }

        @Override
        public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L942">            return getDataFieldSet().getName();</span>
        }

        /**
         * Obtain the analysis.
         *
         * @return the analysis
         */
        protected MoneyWiseAnalysis getAnalysis() {
<span class="nc" id="L951">            return theAnalysis;</span>
        }

        /**
         * Obtain item by id.
         *
         * @param pId the id to lookup
         * @return the item (or null if not present)
         */
        public MoneyWiseAnalysisTaxBasisBucket findItemById(final Integer pId) {
            /* Return results */
<span class="nc" id="L962">            return theList.getItemById(pId);</span>
        }

        @Override
        public MoneyWiseChargeableGainSliceList getGainSlices() {
<span class="nc" id="L967">            return theCharges;</span>
        }

        /**
         * Obtain the Totals.
         *
         * @return the totals bucket
         */
        public MoneyWiseAnalysisTaxBasisBucket getTotals() {
<span class="nc" id="L976">            return theTotals;</span>
        }

        /**
         * Allocate the Totals EventCategoryBucket.
         *
         * @return the bucket
         */
        private MoneyWiseAnalysisTaxBasisBucket allocateTotalsBucket() {
            /* Obtain the totals category */
<span class="fc" id="L986">            return new MoneyWiseAnalysisTaxBasisBucket(theAnalysis, null);</span>
        }

        /**
         * Obtain the TaxBasisBucket for a given taxBasis.
         *
         * @param pClass the taxBasis
         * @return the bucket
         */
        public MoneyWiseAnalysisTaxBasisBucket getBucket(final MoneyWiseTaxClass pClass) {
            /* Locate the bucket in the list */
<span class="nc" id="L997">            final MoneyWiseTaxBasis myBasis = theEditSet.getDataList(MoneyWiseStaticDataType.TAXBASIS, MoneyWiseTaxBasisList.class).findItemByClass(pClass);</span>
<span class="nc" id="L998">            MoneyWiseAnalysisTaxBasisBucket myItem = findItemById(myBasis.getIndexedId());</span>

            /* If the item does not yet exist */
<span class="nc bnc" id="L1001" title="All 2 branches missed.">            if (myItem == null) {</span>
                /* Create the new bucket */
<span class="nc" id="L1003">                myItem = new MoneyWiseAnalysisTaxBasisBucket(theAnalysis, myBasis);</span>

                /* Add to the list */
<span class="nc" id="L1006">                theList.add(myItem);</span>
            }

            /* Return the bucket */
<span class="nc" id="L1010">            return myItem;</span>
        }

        /**
         * Obtain the matching BasisBucket.
         *
         * @param pTaxBasis the taxBasis
         * @return the matching bucket
         */
        public MoneyWiseAnalysisTaxBasisBucket getMatchingBasis(final MoneyWiseAnalysisTaxBasisBucket pTaxBasis) {
            /* Access the matching taxBasis bucket */
<span class="nc" id="L1021">            MoneyWiseAnalysisTaxBasisBucket myBasis = findItemById(pTaxBasis.getTaxBasis().getIndexedId());</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">            if (myBasis == null) {</span>
<span class="nc" id="L1023">                myBasis = new MoneyWiseAnalysisTaxBasisBucket(theAnalysis, pTaxBasis.getTaxBasis());</span>
            }

            /* If we are matching a TaxBasisAccount Bucket */
<span class="nc bnc" id="L1027" title="All 2 branches missed.">            if (pTaxBasis instanceof MoneyWiseAnalysisTaxBasisAccountBucket) {</span>
                /* Look up the asset bucket */
<span class="nc" id="L1029">                final MoneyWiseTransAsset myAsset = ((MoneyWiseAnalysisTaxBasisAccountBucket) pTaxBasis).getAccount();</span>
<span class="nc" id="L1030">                MoneyWiseAnalysisTaxBasisAccountBucket myAccountBucket = myBasis.findAccountBucket(myAsset);</span>

                /* If there is no such bucket in the analysis */
<span class="nc bnc" id="L1033" title="All 2 branches missed.">                if (myAccountBucket == null) {</span>
                    /* Allocate an orphan bucket */
<span class="nc" id="L1035">                    myAccountBucket = new MoneyWiseAnalysisTaxBasisAccountBucket(theAnalysis, myBasis, myAsset);</span>
                }

                /* Set bucket as the account bucket */
<span class="nc" id="L1039">                myBasis = myAccountBucket;</span>
            }

            /* Return the basis */
<span class="nc" id="L1043">            return myBasis;</span>
        }

        /**
         * Obtain the default BasisBucket.
         *
         * @return the default bucket
         */
        public MoneyWiseAnalysisTaxBasisBucket getDefaultBasis() {
            /* Return the first basis in the list if it exists */
<span class="nc bnc" id="L1053" title="All 2 branches missed.">            return isEmpty()</span>
<span class="nc" id="L1054">                    ? null</span>
<span class="nc" id="L1055">                    : theList.getUnderlyingList().get(0);</span>
        }

        /**
         * Adjust basis buckets.
         *
         * @param pTrans    the transaction helper
         * @param pCategory primary category
         */
        protected void adjustBasis(final MoneyWiseAnalysisTransactionHelper pTrans,
                                   final MoneyWiseTransCategory pCategory) {
            /* Switch on the category type */
<span class="nc bnc" id="L1067" title="All 18 branches missed.">            switch (pCategory.getCategoryTypeClass()) {</span>
                case TAXEDINCOME:
                case GROSSINCOME:
<span class="nc" id="L1070">                    addIncome(pTrans, MoneyWiseTaxClass.SALARY);</span>
<span class="nc" id="L1071">                    break;</span>
                case OTHERINCOME:
<span class="nc" id="L1073">                    addIncome(pTrans, MoneyWiseTaxClass.OTHERINCOME);</span>
<span class="nc" id="L1074">                    break;</span>
                case INTEREST:
                case TAXEDINTEREST:
                case TAXEDLOYALTYBONUS:
<span class="nc" id="L1078">                    addIncome(pTrans, MoneyWiseTaxClass.TAXEDINTEREST);</span>
<span class="nc" id="L1079">                    break;</span>
                case GROSSINTEREST:
                case GROSSLOYALTYBONUS:
<span class="nc" id="L1082">                    addIncome(pTrans, MoneyWiseTaxClass.UNTAXEDINTEREST);</span>
<span class="nc" id="L1083">                    break;</span>
                case PEER2PEERINTEREST:
<span class="nc" id="L1085">                    addIncome(pTrans, MoneyWiseTaxClass.PEER2PEERINTEREST);</span>
<span class="nc" id="L1086">                    break;</span>
                case DIVIDEND:
                case SHAREDIVIDEND:
<span class="nc" id="L1089">                    addIncome(pTrans, MoneyWiseTaxClass.DIVIDEND);</span>
<span class="nc" id="L1090">                    break;</span>
                case UNITTRUSTDIVIDEND:
<span class="nc" id="L1092">                    addIncome(pTrans, MoneyWiseTaxClass.UNITTRUSTDIVIDEND);</span>
<span class="nc" id="L1093">                    break;</span>
                case FOREIGNDIVIDEND:
<span class="nc" id="L1095">                    addIncome(pTrans, MoneyWiseTaxClass.FOREIGNDIVIDEND);</span>
<span class="nc" id="L1096">                    break;</span>
                case RENTALINCOME:
<span class="nc" id="L1098">                    addIncome(pTrans, MoneyWiseTaxClass.RENTALINCOME);</span>
<span class="nc" id="L1099">                    break;</span>
                case ROOMRENTALINCOME:
<span class="nc" id="L1101">                    addIncome(pTrans, MoneyWiseTaxClass.ROOMRENTAL);</span>
<span class="nc" id="L1102">                    break;</span>
                case INCOMETAX:
<span class="nc" id="L1104">                    addExpense(pTrans, MoneyWiseTaxClass.TAXPAID);</span>
<span class="nc" id="L1105">                    break;</span>
                case TAXFREEINTEREST:
                case TAXFREEDIVIDEND:
                case LOANINTERESTEARNED:
                case INHERITED:
                case CASHBACK:
                case LOYALTYBONUS:
                case TAXFREELOYALTYBONUS:
                case GIFTEDINCOME:
<span class="nc" id="L1114">                    addIncome(pTrans, MoneyWiseTaxClass.TAXFREE);</span>
<span class="nc" id="L1115">                    break;</span>
                case PENSIONCONTRIB:
<span class="nc" id="L1117">                    addIncome(pTrans, MoneyWiseTaxClass.TAXFREE);</span>
<span class="nc" id="L1118">                    break;</span>
                case BADDEBTCAPITAL:
<span class="nc" id="L1120">                    addExpense(pTrans, MoneyWiseTaxClass.CAPITALGAINS);</span>
<span class="nc" id="L1121">                    break;</span>
                case BADDEBTINTEREST:
<span class="nc" id="L1123">                    addExpense(pTrans, MoneyWiseTaxClass.PEER2PEERINTEREST);</span>
<span class="nc" id="L1124">                    break;</span>
                case EXPENSE:
                case LOCALTAXES:
                case WRITEOFF:
                case LOANINTERESTCHARGED:
                case TAXRELIEF:
                case RECOVEREDEXPENSES:
<span class="nc" id="L1131">                    addExpense(pTrans, MoneyWiseTaxClass.EXPENSE);</span>
<span class="nc" id="L1132">                    break;</span>
                case RENTALEXPENSE:
<span class="nc" id="L1134">                    addExpense(pTrans, MoneyWiseTaxClass.RENTALINCOME);</span>
<span class="nc" id="L1135">                    break;</span>
                case UNITSADJUST:
                case SECURITYREPLACE:
                case STOCKTAKEOVER:
                case STOCKSPLIT:
                case STOCKDEMERGER:
                case STOCKRIGHTSISSUE:
                case PORTFOLIOXFER:
                case TRANSFER:
                default:
                    break;
            }
<span class="nc" id="L1147">        }</span>

        /**
         * Adjust basis for income.
         *
         * @param pClass the class
         * @param pTrans the transaction
         */
        private void addIncome(final MoneyWiseAnalysisTransactionHelper pTrans,
                               final MoneyWiseTaxClass pClass) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1158">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1159">            myBucket.addIncomeTransaction(pTrans);</span>
<span class="nc" id="L1160">        }</span>

        /**
         * Adjust basis for expense.
         *
         * @param pClass the class
         * @param pTrans the transaction
         */
        private void addExpense(final MoneyWiseAnalysisTransactionHelper pTrans,
                                final MoneyWiseTaxClass pClass) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1171">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1172">            myBucket.addExpenseTransaction(pTrans);</span>
<span class="nc" id="L1173">        }</span>

        /**
         * Adjust basis buckets.
         *
         * @param pTrans  the transaction
         * @param pClass  the class
         * @param pIncome the income
         */
        protected void adjustValue(final MoneyWiseAnalysisTransactionHelper pTrans,
                                   final MoneyWiseTaxClass pClass,
                                   final OceanusMoney pIncome) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1186">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1187">            myBucket.adjustValue(pTrans, pIncome, MoneyWiseTaxBasisAdjust.STANDARD);</span>
<span class="nc" id="L1188">        }</span>

        /**
         * Adjust basis buckets for Gross only.
         *
         * @param pTrans  the transaction
         * @param pClass  the class
         * @param pIncome the income
         */
        protected void adjustGrossValue(final MoneyWiseAnalysisTransactionHelper pTrans,
                                        final MoneyWiseTaxClass pClass,
                                        final OceanusMoney pIncome) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1201">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1202">            myBucket.adjustValue(pTrans, pIncome, MoneyWiseTaxBasisAdjust.GROSS);</span>
<span class="nc" id="L1203">        }</span>

        /**
         * Adjust basis buckets for Nett only.
         *
         * @param pTrans  the transaction
         * @param pClass  the class
         * @param pIncome the income
         */
        protected void adjustNettValue(final MoneyWiseAnalysisTransactionHelper pTrans,
                                       final MoneyWiseTaxClass pClass,
                                       final OceanusMoney pIncome) {
            /* Access the bucket and adjust it */
<span class="nc" id="L1216">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(pClass);</span>
<span class="nc" id="L1217">            myBucket.adjustValue(pTrans, pIncome, MoneyWiseTaxBasisAdjust.NETT);</span>
<span class="nc" id="L1218">        }</span>

        /**
         * Adjust autoExpense.
         *
         * @param pTrans    the transaction
         * @param isExpense true/false
         */
        public void adjustAutoExpense(final MoneyWiseAnalysisTransactionHelper pTrans,
                                      final boolean isExpense) {
            /* Determine value */
<span class="nc" id="L1229">            OceanusMoney myAmount = pTrans.getLocalAmount();</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">            if (!isExpense) {</span>
<span class="nc" id="L1231">                myAmount = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1232">                myAmount.negate();</span>
            }

            /* Access the bucket and adjust it */
<span class="nc" id="L1236">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(MoneyWiseTaxClass.EXPENSE);</span>
<span class="nc" id="L1237">            myBucket.adjustValue(pTrans, myAmount, MoneyWiseTaxBasisAdjust.STANDARD);</span>
<span class="nc" id="L1238">        }</span>

        /**
         * Adjust for market growth.
         *
         * @param pIncome  the income
         * @param pExpense the expense
         */
        protected void adjustMarket(final OceanusMoney pIncome,
                                    final OceanusMoney pExpense) {
            /* Calculate the delta */
<span class="nc" id="L1249">            final OceanusMoney myDelta = new OceanusMoney(pIncome);</span>
<span class="nc" id="L1250">            myDelta.subtractAmount(pExpense);</span>

            /* Access the bucket and adjust it */
<span class="nc" id="L1253">            final MoneyWiseAnalysisTaxBasisBucket myBucket = getBucket(MoneyWiseTaxClass.MARKET);</span>
<span class="nc" id="L1254">            myBucket.adjustValue(myDelta, MoneyWiseTaxBasisAdjust.STANDARD);</span>
<span class="nc" id="L1255">        }</span>

        /**
         * record ChargeableGain.
         *
         * @param pTrans the transaction
         * @param pGain  the gain
         */
        public void recordChargeableGain(final MoneyWiseTransaction pTrans,
                                         final OceanusMoney pGain) {
            /* record the chargeable gain */
<span class="nc" id="L1266">            theCharges.addTransaction(pTrans, pGain);</span>
<span class="nc" id="L1267">        }</span>

        /**
         * produce Totals.
         */
        protected void produceTotals() {
            /* Loop through the buckets */
<span class="fc" id="L1274">            final Iterator&lt;MoneyWiseAnalysisTaxBasisBucket&gt; myIterator = iterator();</span>
<span class="pc bpc" id="L1275" title="1 of 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L1276">                final MoneyWiseAnalysisTaxBasisBucket myBucket = myIterator.next();</span>

                /* Sort the accounts */
<span class="nc bnc" id="L1279" title="All 2 branches missed.">                if (myBucket.hasAccounts()) {</span>
<span class="nc" id="L1280">                    myBucket.getAccounts().sortBuckets();</span>
                }

                /* Adjust the Total Profit buckets */
<span class="nc" id="L1284">                theTotals.addValues(myBucket);</span>
<span class="nc" id="L1285">            }</span>

            /* Sort the bases */
<span class="fc" id="L1288">            theList.sortList();</span>
<span class="fc" id="L1289">        }</span>

        /**
         * Prune the list to remove irrelevant items.
         */
        protected void prune() {
            /* Loop through the buckets */
<span class="nc" id="L1296">            final Iterator&lt;MoneyWiseAnalysisTaxBasisBucket&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L1298">                final MoneyWiseAnalysisTaxBasisBucket myCurr = myIterator.next();</span>

                /* Remove the bucket if it is inactive */
<span class="nc bnc" id="L1301" title="All 2 branches missed.">                if (!myCurr.isActive()) {</span>
<span class="nc" id="L1302">                    myIterator.remove();</span>
                }
<span class="nc" id="L1304">            }</span>
<span class="nc" id="L1305">        }</span>

        @Override
        public OceanusMoney getAmountForTaxBasis(final MoneyWiseTaxClass pBasis) {
            /* Access the bucket */
<span class="nc" id="L1310">            final MoneyWiseAnalysisTaxBasisBucket myItem = findItemById(pBasis.getClassId());</span>

            /* If the bucket is not found */
<span class="nc bnc" id="L1313" title="All 2 branches missed.">            if (myItem == null) {</span>
<span class="nc" id="L1314">                final MoneyWiseCurrency myAssetCurrency = theAnalysis.getCurrency();</span>
<span class="nc bnc" id="L1315" title="All 2 branches missed.">                final Currency myCurrency = myAssetCurrency == null</span>
<span class="nc" id="L1316">                        ? OceanusMoney.getDefaultCurrency()</span>
<span class="nc" id="L1317">                        : myAssetCurrency.getCurrency();</span>
<span class="nc" id="L1318">                return new OceanusMoney(myCurrency);</span>
            }

<span class="nc" id="L1321">            return myItem.getMoneyValue(MoneyWiseAnalysisTaxBasisAttr.GROSS);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>