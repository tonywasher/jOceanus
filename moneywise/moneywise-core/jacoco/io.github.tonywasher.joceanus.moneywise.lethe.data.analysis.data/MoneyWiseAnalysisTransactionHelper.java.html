<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseAnalysisTransactionHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.data</a> &gt; <span class="el_source">MoneyWiseAnalysisTransactionHelper.java</span></div><h1>MoneyWiseAnalysisTransactionHelper.java</h1><pre class="source lang-java linenums">/*
 * MoneyWise: Finance Application
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.moneywise.lethe.data.analysis.data;

import io.github.tonywasher.joceanus.oceanus.date.OceanusDate;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusMoney;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusPrice;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusRatio;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusUnits;
import io.github.tonywasher.joceanus.metis.data.MetisDataDifference;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseAssetDirection;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseDataSet;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurity;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import io.github.tonywasher.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseCurrency;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;

import java.util.Currency;

/**
 * Transaction Analysis Helper.
 */
public class MoneyWiseAnalysisTransactionHelper {
    /**
     * Currency Cursor.
     */
    private final MoneyWiseAnalysisExchangeRateCursor theRateCursor;

    /**
     * Security Cursor.
     */
    private final MoneyWiseAnalysisSecurityPriceCursor thePriceCursor;

    /**
     * Reporting currency.
     */
    private final MoneyWiseCurrency theCurrency;

    /**
     * The current transaction.
     */
    private MoneyWiseTransaction theCurrent;

    /**
     * The current date.
     */
    private OceanusDate theDate;

    /**
     * The account detail.
     */
    private TransactionDetail theAccountDetail;

    /**
     * The debit XchangeRate.
     */
    private OceanusRatio theDebitXchangeRate;

    /**
     * Constructor.
     *
     * @param pData the dataSet
     */
<span class="fc" id="L81">    public MoneyWiseAnalysisTransactionHelper(final MoneyWiseDataSet pData) {</span>
        /* Create the cursors */
<span class="fc" id="L83">        theRateCursor = new MoneyWiseAnalysisExchangeRateCursor(pData);</span>
<span class="fc" id="L84">        thePriceCursor = new MoneyWiseAnalysisSecurityPriceCursor(pData);</span>

        /* Note the reporting currency */
<span class="fc" id="L87">        theCurrency = pData.getReportingCurrency();</span>
<span class="fc" id="L88">    }</span>

    /**
     * Obtain transaction.
     *
     * @return the transaction
     */
    public MoneyWiseTransaction getTransaction() {
<span class="nc" id="L96">        return theCurrent;</span>
    }

    /**
     * Set the transaction.
     *
     * @param pTrans the transaction.
     */
    public void setTransaction(final MoneyWiseTransaction pTrans) {
        /* Record date */
<span class="nc" id="L106">        theCurrent = pTrans;</span>
<span class="nc" id="L107">        theDate = theCurrent.getDate();</span>

        /* Reset details */
<span class="nc" id="L110">        theAccountDetail = new TransactionDetail();</span>
<span class="nc" id="L111">        theDebitXchangeRate = theAccountDetail.getDebitExchangeRate();</span>
<span class="nc" id="L112">    }</span>

    /**
     * Set the security (for PortfolioXfer).
     *
     * @param pSecurity the security.
     */
    public void setSecurity(final MoneyWiseSecurity pSecurity) {
<span class="nc" id="L120">        final MoneyWiseCurrency myCurr = pSecurity.getAssetCurrency();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        final boolean isForeign = !MetisDataDifference.isEqual(myCurr, theCurrency);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        theDebitXchangeRate = isForeign ? theRateCursor.getExchangeRate(myCurr, theDate) : null;</span>
<span class="nc" id="L123">    }</span>

    /**
     * Obtain date.
     *
     * @return the date
     */
    public OceanusDate getDate() {
<span class="nc" id="L131">        return theDate;</span>
    }

    /**
     * Obtain account.
     *
     * @return the account
     */
    public MoneyWiseTransAsset getAccount() {
<span class="nc" id="L140">        return theAccountDetail.getAccount();</span>
    }

    /**
     * Obtain partner.
     *
     * @return the partner
     */
    public MoneyWiseTransAsset getPartner() {
<span class="nc" id="L149">        return theAccountDetail.getPartner();</span>
    }

    /**
     * Obtain direction.
     *
     * @return the direction
     */
    public MoneyWiseAssetDirection getDirection() {
<span class="nc" id="L158">        return theAccountDetail.getDirection();</span>
    }

    /**
     * Obtain debit asset.
     *
     * @return the debit asset
     */
    public MoneyWiseTransAsset getDebitAsset() {
<span class="nc" id="L167">        return theAccountDetail.getDebitAsset();</span>
    }

    /**
     * Obtain credit asset.
     *
     * @return the credit asset
     */
    public MoneyWiseTransAsset getCreditAsset() {
<span class="nc" id="L176">        return theAccountDetail.getCreditAsset();</span>
    }

    /**
     * Obtain the category.
     *
     * @return the category
     */
    public MoneyWiseTransCategory getCategory() {
<span class="nc" id="L185">        return theAccountDetail.getCategory();</span>
    }

    /**
     * Is this a particular category class?
     *
     * @param pClass the category class
     * @return true/false
     */
    public boolean isCategoryClass(final MoneyWiseTransCategoryClass pClass) {
<span class="nc" id="L195">        return theAccountDetail.isCategoryClass(pClass);</span>
    }

    /**
     * Obtain the category class.
     *
     * @return the category class
     */
    public MoneyWiseTransCategoryClass getCategoryClass() {
<span class="nc" id="L204">        return theAccountDetail.getCategoryClass();</span>
    }

    /**
     * Obtain debit amount.
     *
     * @return the debit amount.
     */
    public OceanusMoney getDebitAmount() {
<span class="nc" id="L213">        return theAccountDetail.getDebitAmount();</span>
    }

    /**
     * Obtain local amount.
     *
     * @return the amount.
     */
    public OceanusMoney getLocalAmount() {
<span class="nc" id="L222">        return theAccountDetail.getLocalAmount();</span>
    }

    /**
     * Obtain credit amount.
     *
     * @return the credit amount.
     */
    public OceanusMoney getCreditAmount() {
<span class="nc" id="L231">        return theAccountDetail.getCreditAmount();</span>
    }

    /**
     * Obtain local returnedCash.
     *
     * @return the returnedCash.
     */
    public OceanusMoney getLocalReturnedCash() {
<span class="nc" id="L240">        return theAccountDetail.getLocalReturnedCash();</span>
    }

    /**
     * Obtain returnedCash.
     *
     * @return the returned cash.
     */
    public OceanusMoney getReturnedCash() {
<span class="nc" id="L249">        return theAccountDetail.getReturnedCash();</span>
    }

    /**
     * Obtain tax credit.
     *
     * @return the tax credit.
     */
    public OceanusMoney getTaxCredit() {
<span class="nc" id="L258">        return theAccountDetail.getTaxCredit();</span>
    }

    /**
     * Obtain employer national insurance.
     *
     * @return the national insurance.
     */
    public OceanusMoney getEmployerNatIns() {
<span class="nc" id="L267">        return theAccountDetail.getEmployerNatIns();</span>
    }

    /**
     * Obtain employee national insurance.
     *
     * @return the national insurance.
     */
    public OceanusMoney getEmployeeNatIns() {
<span class="nc" id="L276">        return theAccountDetail.getEmployeeNatIns();</span>
    }

    /**
     * Obtain benefit.
     *
     * @return the benefit.
     */
    public OceanusMoney getDeemedBenefit() {
<span class="nc" id="L285">        return theAccountDetail.getBenefit();</span>
    }

    /**
     * Obtain withheld.
     *
     * @return the withheld.
     */
    public OceanusMoney getWithheld() {
<span class="nc" id="L294">        return theAccountDetail.getWithheld();</span>
    }

    /**
     * Obtain returnedCash Account.
     *
     * @return the returnedCash account
     */
    public MoneyWiseTransAsset getReturnedCashAccount() {
<span class="nc" id="L303">        return theAccountDetail.getReturnedCashAccount();</span>
    }

    /**
     * Obtain debit units.
     *
     * @return the debit units
     */
    public OceanusUnits getDebitUnits() {
<span class="nc bnc" id="L312" title="All 2 branches missed.">        OceanusUnits myUnits = getDirection().isTo()</span>
<span class="nc" id="L313">                ? getAccountDeltaUnits()</span>
<span class="nc" id="L314">                : getPartnerDeltaUnits();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (myUnits != null) {</span>
<span class="nc" id="L316">            myUnits = new OceanusUnits(myUnits);</span>
<span class="nc" id="L317">            myUnits.negate();</span>
        }
<span class="nc" id="L319">        return myUnits;</span>
    }

    /**
     * Obtain credit units.
     *
     * @return the debit units
     */
    public OceanusUnits getCreditUnits() {
<span class="nc bnc" id="L328" title="All 2 branches missed.">        return getDirection().isFrom()</span>
<span class="nc" id="L329">                ? getAccountDeltaUnits()</span>
<span class="nc" id="L330">                : getPartnerDeltaUnits();</span>
    }

    /**
     * Obtain account delta units.
     *
     * @return the delta units
     */
    public OceanusUnits getAccountDeltaUnits() {
<span class="nc" id="L339">        return theAccountDetail.getAccountDeltaUnits();</span>
    }

    /**
     * Obtain partner delta units.
     *
     * @return the delta units
     */
    public OceanusUnits getPartnerDeltaUnits() {
<span class="nc" id="L348">        return theAccountDetail.getPartnerDeltaUnits();</span>
    }

    /**
     * Obtain dilution.
     *
     * @return the dilution
     */
    public OceanusRatio getDilution() {
<span class="nc" id="L357">        return theAccountDetail.getDilution();</span>
    }

    /**
     * Obtain debit price.
     *
     * @return the debit price
     */
    public OceanusPrice getDebitPrice() {
<span class="nc" id="L366">        return theAccountDetail.getDebitPrice();</span>
    }

    /**
     * Obtain credit price.
     *
     * @return the credit price
     */
    public OceanusPrice getCreditPrice() {
<span class="nc" id="L375">        return theAccountDetail.getCreditPrice();</span>
    }

    /**
     * Obtain debit exchangeRate.
     *
     * @return the rate
     */
    public OceanusRatio getDebitExchangeRate() {
<span class="nc" id="L384">        return theDebitXchangeRate;</span>
    }

    /**
     * Obtain credit exchangeRate.
     *
     * @return the rate
     */
    public OceanusRatio getCreditExchangeRate() {
<span class="nc" id="L393">        return theAccountDetail.getCreditExchangeRate();</span>
    }

    /**
     * Obtain returnedCash exchangeRate.
     *
     * @return the rate
     */
    public OceanusRatio getReturnedCashExchangeRate() {
<span class="nc" id="L402">        return theAccountDetail.getReturnedCashExchangeRate();</span>
    }

    /**
     * Convert amount to reporting currency.
     *
     * @param pCurrency the currency
     * @param pDate     the date for the conversion
     * @return the reporting amount
     */
    protected OceanusRatio getExchangeRate(final MoneyWiseCurrency pCurrency,
                                           final OceanusDate pDate) {
<span class="nc" id="L414">        return theRateCursor.getExchangeRate(pCurrency, pDate);</span>
    }

    /**
     * Transaction Detail class.
     */
    private final class TransactionDetail {
        /**
         * The account.
         */
        private final MoneyWiseTransAsset theAccount;

        /**
         * The partner.
         */
        private final MoneyWiseTransAsset thePartner;

        /**
         * The direction.
         */
        private final MoneyWiseAssetDirection theDirection;

        /**
         * The category.
         */
        private final MoneyWiseTransCategory theCategory;

        /**
         * The amount.
         */
        private final OceanusMoney theAmount;

        /**
         * The ReturnedCashAccount.
         */
        private final MoneyWiseTransAsset theReturnedCashAccount;

        /**
         * The returnedCash.
         */
        private final OceanusMoney theReturnedCash;

        /**
         * The tax credit.
         */
        private final OceanusMoney theTaxCredit;

        /**
         * The Employer natIns.
         */
        private final OceanusMoney theEmployerNatIns;

        /**
         * The Employee natIns.
         */
        private final OceanusMoney theEmployeeNatIns;

        /**
         * The benefit amount.
         */
        private final OceanusMoney theBenefit;

        /**
         * The withheld amount.
         */
        private final OceanusMoney theWithheld;

        /**
         * The account delta units.
         */
        private final OceanusUnits theAccountUnits;

        /**
         * The partner delta units.
         */
        private final OceanusUnits thePartnerUnits;

        /**
         * The dilution.
         */
        private final OceanusRatio theDilution;

        /**
         * The account price.
         */
        private final OceanusPrice theAccountPrice;

        /**
         * The partner price.
         */
        private final OceanusPrice thePartnerPrice;

        /**
         * The foreign account details.
         */
        private final ForeignAccountDetail theForeignAccount;

        /**
         * The foreign partner details.
         */
        private final ForeignPartnerDetail theForeignPartner;

        /**
         * The foreign returnedCash details.
         */
        private final ForeignPartnerDetail theForeignReturnedCash;

        /**
         * Constructor.
         */
<span class="nc" id="L524">        private TransactionDetail() {</span>
            /* Store detail */
<span class="nc" id="L526">            theAccount = theCurrent.getAccount();</span>
<span class="nc" id="L527">            thePartner = theCurrent.getPartner();</span>
<span class="nc" id="L528">            theDirection = theCurrent.getDirection();</span>
<span class="nc" id="L529">            theCategory = theCurrent.getCategory();</span>
<span class="nc" id="L530">            theTaxCredit = theCurrent.getTaxCredit();</span>
<span class="nc" id="L531">            theEmployerNatIns = theCurrent.getEmployerNatIns();</span>
<span class="nc" id="L532">            theEmployeeNatIns = theCurrent.getEmployeeNatIns();</span>
<span class="nc" id="L533">            theBenefit = theCurrent.getDeemedBenefit();</span>
<span class="nc" id="L534">            theWithheld = theCurrent.getWithheld();</span>
<span class="nc" id="L535">            theReturnedCashAccount = theCurrent.getReturnedCashAccount();</span>
<span class="nc" id="L536">            theAccountUnits = theCurrent.getAccountDeltaUnits();</span>
<span class="nc" id="L537">            thePartnerUnits = theCurrent.getPartnerDeltaUnits();</span>
<span class="nc" id="L538">            theDilution = theCurrent.getDilution();</span>

            /* Obtain the amounts */
<span class="nc" id="L541">            final OceanusMoney myAmount = theCurrent.getAmount();</span>
<span class="nc" id="L542">            final OceanusMoney myPartnerAmount = theCurrent.getPartnerAmount();</span>
<span class="nc" id="L543">            final OceanusMoney myReturnedCash = theCurrent.getReturnedCash();</span>

            /* Determine account prices */
<span class="nc bnc" id="L546" title="All 2 branches missed.">            theAccountPrice = theAccount instanceof MoneyWiseSecurityHolding</span>
<span class="nc" id="L547">                    ? thePriceCursor.getSecurityPrice(((MoneyWiseSecurityHolding) theAccount).getSecurity(), theDate)</span>
<span class="nc" id="L548">                    : null;</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">            thePartnerPrice = thePartner instanceof MoneyWiseSecurityHolding</span>
<span class="nc" id="L550">                    ? thePriceCursor.getSecurityPrice(((MoneyWiseSecurityHolding) thePartner).getSecurity(), theDate)</span>
<span class="nc" id="L551">                    : null;</span>

            /* Determine foreign account detail */
<span class="nc" id="L554">            MoneyWiseCurrency myActCurrency = theAccount.getAssetCurrency();</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">            theForeignAccount = MetisDataDifference.isEqual(myActCurrency, theCurrency)</span>
<span class="nc" id="L556">                    ? null</span>
<span class="nc" id="L557">                    : new ForeignAccountDetail(this, myActCurrency, myAmount);</span>

            /* If we have a partner amount */
<span class="nc" id="L560">            myActCurrency = thePartner.getAssetCurrency();</span>
<span class="nc" id="L561">            theForeignPartner = myActCurrency == null</span>
<span class="nc bnc" id="L562" title="All 4 branches missed.">                    || MetisDataDifference.isEqual(myActCurrency, theCurrency)</span>
<span class="nc" id="L563">                    ? null</span>
<span class="nc" id="L564">                    : new ForeignPartnerDetail(myActCurrency, myPartnerAmount);</span>

            /* If we have a returnedCash account */
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if (theReturnedCashAccount != null) {</span>
                /* Determine foreign returnedCash detail */
<span class="nc" id="L569">                myActCurrency = theReturnedCashAccount.getAssetCurrency();</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                theForeignReturnedCash = MetisDataDifference.isEqual(myActCurrency, theCurrency)</span>
<span class="nc" id="L571">                        ? null</span>
<span class="nc" id="L572">                        : new ForeignPartnerDetail(myActCurrency, myReturnedCash);</span>
            } else {
<span class="nc" id="L574">                theForeignReturnedCash = null;</span>
            }

            /* Determine the local amounts */
<span class="nc bnc" id="L578" title="All 2 branches missed.">            theAmount = theForeignAccount == null</span>
<span class="nc" id="L579">                    ? myAmount</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">                    : theForeignPartner == null</span>
<span class="nc" id="L581">                    ? myPartnerAmount</span>
<span class="nc" id="L582">                    : theForeignAccount.theAmount;</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">            theReturnedCash = theForeignReturnedCash == null</span>
<span class="nc" id="L584">                    ? myReturnedCash</span>
<span class="nc" id="L585">                    : theForeignReturnedCash.theAmount;</span>
<span class="nc" id="L586">        }</span>

        /**
         * Obtain account.
         *
         * @return the account
         */
        private MoneyWiseTransAsset getAccount() {
<span class="nc" id="L594">            return theAccount;</span>
        }

        /**
         * Obtain partner.
         *
         * @return the partner
         */
        private MoneyWiseTransAsset getPartner() {
<span class="nc" id="L603">            return thePartner;</span>
        }

        /**
         * Obtain direction.
         *
         * @return the direction
         */
        private MoneyWiseAssetDirection getDirection() {
<span class="nc" id="L612">            return theDirection;</span>
        }

        /**
         * Obtain debit asset.
         *
         * @return the debit asset
         */
        private MoneyWiseTransAsset getDebitAsset() {
<span class="nc bnc" id="L621" title="All 2 branches missed.">            return theDirection.isFrom()</span>
<span class="nc" id="L622">                    ? thePartner</span>
<span class="nc" id="L623">                    : theAccount;</span>
        }

        /**
         * Obtain credit asset.
         *
         * @return the credit asset
         */
        private MoneyWiseTransAsset getCreditAsset() {
<span class="nc bnc" id="L632" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc" id="L633">                    ? thePartner</span>
<span class="nc" id="L634">                    : theAccount;</span>
        }

        /**
         * Obtain returnedCash account.
         *
         * @return the returnedCash account
         */
        private MoneyWiseTransAsset getReturnedCashAccount() {
<span class="nc" id="L643">            return theReturnedCashAccount;</span>
        }

        /**
         * Obtain category.
         *
         * @return the category class
         */
        private MoneyWiseTransCategory getCategory() {
<span class="nc" id="L652">            return theCategory;</span>
        }

        /**
         * Is this a particular category class?
         *
         * @param pClass the category class
         * @return true/false
         */
        private boolean isCategoryClass(final MoneyWiseTransCategoryClass pClass) {
<span class="nc" id="L662">            return theCategory.isCategoryClass(pClass);</span>
        }

        /**
         * Obtain category class?
         *
         * @return the category class
         */
        private MoneyWiseTransCategoryClass getCategoryClass() {
<span class="nc" id="L671">            return theCategory.getCategoryTypeClass();</span>
        }

        /**
         * Obtain debit amount.
         *
         * @return the debit amount
         */
        private OceanusMoney getDebitAmount() {
<span class="nc bnc" id="L680" title="All 2 branches missed.">            return theDirection.isFrom()</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                    ? theForeignPartner == null</span>
<span class="nc" id="L682">                    ? theAmount</span>
<span class="nc" id="L683">                    : theForeignPartner.theBase</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">                    : theForeignAccount == null</span>
<span class="nc" id="L685">                    ? theAmount</span>
<span class="nc" id="L686">                    : theForeignAccount.theBase;</span>
        }

        /**
         * Obtain local debit amount.
         *
         * @return the local debit amount
         */
        private OceanusMoney getLocalAmount() {
<span class="nc" id="L695">            return theAmount;</span>
        }

        /**
         * Obtain credit amount.
         *
         * @return the credit amount
         */
        private OceanusMoney getCreditAmount() {
<span class="nc bnc" id="L704" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">                    ? theForeignPartner == null</span>
<span class="nc" id="L706">                    ? theAmount</span>
<span class="nc" id="L707">                    : theForeignPartner.theBase</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                    : theForeignAccount == null</span>
<span class="nc" id="L709">                    ? theAmount</span>
<span class="nc" id="L710">                    : theForeignAccount.theBase;</span>
        }

        /**
         * Obtain local returnedCash.
         *
         * @return the local returnedCash
         */
        private OceanusMoney getLocalReturnedCash() {
<span class="nc" id="L719">            return theReturnedCash;</span>
        }

        /**
         * Obtain returnedCash.
         *
         * @return the returnedCash
         */
        private OceanusMoney getReturnedCash() {
<span class="nc bnc" id="L728" title="All 2 branches missed.">            return theForeignReturnedCash == null</span>
<span class="nc" id="L729">                    ? theReturnedCash</span>
<span class="nc" id="L730">                    : theForeignReturnedCash.theBase;</span>
        }

        /**
         * Obtain debit price.
         *
         * @return the debit price
         */
        private OceanusPrice getDebitPrice() {
<span class="nc bnc" id="L739" title="All 2 branches missed.">            return theDirection.isFrom()</span>
<span class="nc" id="L740">                    ? thePartnerPrice</span>
<span class="nc" id="L741">                    : theAccountPrice;</span>
        }

        /**
         * Obtain credit price.
         *
         * @return the credit price
         */
        private OceanusPrice getCreditPrice() {
<span class="nc bnc" id="L750" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc" id="L751">                    ? thePartnerPrice</span>
<span class="nc" id="L752">                    : theAccountPrice;</span>
        }

        /**
         * Obtain debit exchangeRate.
         *
         * @return the rate
         */
        private OceanusRatio getDebitExchangeRate() {
<span class="nc bnc" id="L761" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">                    ? theForeignAccount == null</span>
<span class="nc" id="L763">                    ? null</span>
<span class="nc" id="L764">                    : theForeignAccount.theExchangeRate</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">                    : theForeignPartner == null</span>
<span class="nc" id="L766">                    ? null</span>
<span class="nc" id="L767">                    : theForeignPartner.theExchangeRate;</span>
        }

        /**
         * Obtain credit exchangeRate.
         *
         * @return the rate
         */
        private OceanusRatio getCreditExchangeRate() {
<span class="nc bnc" id="L776" title="All 2 branches missed.">            return theDirection.isTo()</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                    ? theForeignPartner == null</span>
<span class="nc" id="L778">                    ? null</span>
<span class="nc" id="L779">                    : theForeignPartner.theExchangeRate</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">                    : theForeignAccount == null</span>
<span class="nc" id="L781">                    ? null</span>
<span class="nc" id="L782">                    : theForeignAccount.theExchangeRate;</span>
        }

        /**
         * Obtain thirdParty exchangeRate.
         *
         * @return the rate
         */
        private OceanusRatio getReturnedCashExchangeRate() {
<span class="nc bnc" id="L791" title="All 2 branches missed.">            return theForeignReturnedCash == null</span>
<span class="nc" id="L792">                    ? null</span>
<span class="nc" id="L793">                    : theForeignReturnedCash.theExchangeRate;</span>
        }

        /**
         * Obtain taxCredit.
         *
         * @return the tax credit
         */
        private OceanusMoney getTaxCredit() {
<span class="nc bnc" id="L802" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L803">                    ? theForeignAccount.theTaxCredit</span>
<span class="nc" id="L804">                    : theTaxCredit;</span>
        }

        /**
         * Obtain employer natInsurance.
         *
         * @return the national insurance
         */
        private OceanusMoney getEmployerNatIns() {
<span class="nc bnc" id="L813" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L814">                    ? theForeignAccount.theEmployerNatIns</span>
<span class="nc" id="L815">                    : theEmployerNatIns;</span>
        }

        /**
         * Obtain employee natInsurance.
         *
         * @return the national insurance
         */
        private OceanusMoney getEmployeeNatIns() {
<span class="nc bnc" id="L824" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L825">                    ? theForeignAccount.theEmployeeNatIns</span>
<span class="nc" id="L826">                    : theEmployeeNatIns;</span>
        }

        /**
         * Obtain benefit.
         *
         * @return the benefit
         */
        private OceanusMoney getBenefit() {
<span class="nc bnc" id="L835" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L836">                    ? theForeignAccount.theBenefit</span>
<span class="nc" id="L837">                    : theBenefit;</span>
        }

        /**
         * Obtain donation.
         *
         * @return the donation
         */
        private OceanusMoney getWithheld() {
<span class="nc bnc" id="L846" title="All 2 branches missed.">            return theForeignAccount != null</span>
<span class="nc" id="L847">                    ? theForeignAccount.theWithheld</span>
<span class="nc" id="L848">                    : theWithheld;</span>
        }

        /**
         * Obtain account delta units.
         *
         * @return the delta units
         */
        private OceanusUnits getAccountDeltaUnits() {
<span class="nc" id="L857">            return theAccountUnits;</span>
        }

        /**
         * Obtain partner delta units.
         *
         * @return the partner delta units
         */
        private OceanusUnits getPartnerDeltaUnits() {
<span class="nc" id="L866">            return thePartnerUnits;</span>
        }

        /**
         * Obtain dilution.
         *
         * @return the dilution
         */
        private OceanusRatio getDilution() {
<span class="nc" id="L875">            return theDilution;</span>
        }
    }

    /**
     * Foreign Account class.
     */
    private final class ForeignAccountDetail {
        /**
         * The exchange rate.
         */
        private final OceanusRatio theExchangeRate;

        /**
         * The base amount.
         */
        private final OceanusMoney theBase;

        /**
         * The amount.
         */
        private final OceanusMoney theAmount;

        /**
         * The tax credit.
         */
        private final OceanusMoney theTaxCredit;

        /**
         * The employer natInsurance.
         */
        private final OceanusMoney theEmployerNatIns;

        /**
         * The employee natInsurance.
         */
        private final OceanusMoney theEmployeeNatIns;

        /**
         * The benefit amount.
         */
        private final OceanusMoney theBenefit;

        /**
         * The withheld amount.
         */
        private final OceanusMoney theWithheld;

        /**
         * Constructor.
         *
         * @param pTrans    the transaction detail
         * @param pCurrency the foreign currency
         * @param pAmount   the amount
         */
        private ForeignAccountDetail(final TransactionDetail pTrans,
                                     final MoneyWiseCurrency pCurrency,
<span class="nc" id="L932">                                     final OceanusMoney pAmount) {</span>
            /* Obtain the required exchange rate */
<span class="nc" id="L934">            theBase = pAmount;</span>
<span class="nc" id="L935">            final OceanusRatio myEventRate = theCurrent.getExchangeRate();</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">            final OceanusRatio myRate = myEventRate == null</span>
<span class="nc" id="L937">                    ? theRateCursor.getExchangeRate(pCurrency, theDate)</span>
<span class="nc" id="L938">                    : myEventRate;</span>
<span class="nc" id="L939">            theExchangeRate = myRate;</span>
<span class="nc" id="L940">            final Currency myCurrency = theCurrency.getCurrency();</span>

            /* Obtain local amount */
<span class="nc bnc" id="L943" title="All 2 branches missed.">            theAmount = theBase != null</span>
<span class="nc" id="L944">                    ? theBase.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L945">                    : null;</span>

            /* Obtain tax value */
<span class="nc" id="L948">            OceanusMoney myValue = pTrans.theTaxCredit;</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">            theTaxCredit = myValue != null</span>
<span class="nc" id="L950">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L951">                    : null;</span>
            /* Obtain Employer NatIns */
<span class="nc" id="L953">            myValue = pTrans.theEmployerNatIns;</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">            theEmployerNatIns = myValue != null</span>
<span class="nc" id="L955">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L956">                    : null;</span>

            /* Obtain Employee NatIns */
<span class="nc" id="L959">            myValue = pTrans.theEmployeeNatIns;</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">            theEmployeeNatIns = myValue != null</span>
<span class="nc" id="L961">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L962">                    : null;</span>

            /* Obtain benefit */
<span class="nc" id="L965">            myValue = pTrans.theBenefit;</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">            theBenefit = myValue != null</span>
<span class="nc" id="L967">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L968">                    : null;</span>

            /* Obtain withheld */
<span class="nc" id="L971">            myValue = pTrans.theWithheld;</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">            theWithheld = myValue != null</span>
<span class="nc" id="L973">                    ? myValue.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L974">                    : null;</span>
<span class="nc" id="L975">        }</span>
    }

    /**
     * Foreign Partner class.
     */
    private final class ForeignPartnerDetail {
        /**
         * The exchange rate.
         */
        private final OceanusRatio theExchangeRate;

        /**
         * The base amount.
         */
        private final OceanusMoney theBase;

        /**
         * The local amount.
         */
        private final OceanusMoney theAmount;

        /**
         * Constructor.
         *
         * @param pCurrency the foreign currency
         * @param pAmount   the amount
         */
        private ForeignPartnerDetail(final MoneyWiseCurrency pCurrency,
<span class="nc" id="L1004">                                     final OceanusMoney pAmount) {</span>
            /* Obtain the required exchange rate */
<span class="nc" id="L1006">            theBase = pAmount;</span>
<span class="nc" id="L1007">            theExchangeRate = theRateCursor.getExchangeRate(pCurrency, theDate);</span>
<span class="nc" id="L1008">            final OceanusRatio myRate = theExchangeRate;</span>
<span class="nc" id="L1009">            final Currency myCurrency = theCurrency.getCurrency();</span>

            /* Obtain local amount */
<span class="nc bnc" id="L1012" title="All 2 branches missed.">            theAmount = theBase != null</span>
<span class="nc" id="L1013">                    ? theBase.convertCurrency(myCurrency, myRate)</span>
<span class="nc" id="L1014">                    : null;</span>
<span class="nc" id="L1015">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>