<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseValidateTransaction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.data.validate</a> &gt; <span class="el_source">MoneyWiseValidateTransaction.java</span></div><h1>MoneyWiseValidateTransaction.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.data.validate;

import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.metis.field.MetisFieldRequired;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetDirection;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetType;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseBasicDataType;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseBasicResource;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataValidator.MoneyWiseDataValidatorTrans;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDeposit;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseLoan;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePayee;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePortfolio;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurity;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransBase;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransInfoSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseDepositCategoryClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWisePayeeClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWisePortfolioClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseSecurityClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransInfoClass;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.date.OceanusDateRange;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.decimal.OceanusUnits;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataItem;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditSet;

import java.util.Currency;
import java.util.Objects;

/**
 * Validator for transaction.
 */
public class MoneyWiseValidateTransaction
        implements MoneyWiseDataValidatorTrans&lt;MoneyWiseTransaction&gt; {
    /**
     * Are we using new validation?
     */
    private final boolean newValidation;

    /**
     * The infoSet validator.
     */
    private final MoneyWiseValidateTransInfoSet theInfoSet;

    /**
     * The defaults engine.
     */
    private final MoneyWiseValidateTransDefaults theDefaults;

    /**
     * Set the editSet.
     */
    private PrometheusEditSet theEditSet;

    /**
     * Constructor.
     * @param pNewValidation true/false
     */
<span class="fc" id="L83">    MoneyWiseValidateTransaction(final boolean pNewValidation) {</span>
<span class="fc" id="L84">        newValidation = pNewValidation;</span>
<span class="fc" id="L85">        theInfoSet = new MoneyWiseValidateTransInfoSet(pNewValidation);</span>
<span class="fc" id="L86">        theDefaults = new MoneyWiseValidateTransDefaults(this);</span>
<span class="fc" id="L87">    }</span>

    @Override
    public void setEditSet(final PrometheusEditSet pEditSet) {
<span class="fc" id="L91">        theEditSet = pEditSet;</span>
<span class="fc" id="L92">        theInfoSet.storeEditSet(pEditSet);</span>
<span class="fc" id="L93">    }</span>

    /**
     * Obtain the editSet.
     * @return the editSet
     */
    PrometheusEditSet getEditSet() {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (theEditSet == null) {</span>
<span class="nc" id="L101">            throw new IllegalStateException(&quot;editSet not set up&quot;);</span>
        }
<span class="nc" id="L103">        return theEditSet;</span>
    }

    /**
     * Obtain the transInfoSet validator.
     * @return the validator
     */
    public MoneyWiseValidateTransInfoSet getInfoSetValidator() {
<span class="nc" id="L111">        return theInfoSet;</span>
    }

    /**
     * Should we perform new validity checks?
     * @return true/false
     */
    public boolean newValidation() {
<span class="nc" id="L119">        return newValidation;</span>
    }

    @Override
    public void validate(final PrometheusDataItem pTrans) {
<span class="fc" id="L124">        final MoneyWiseTransaction myTrans = (MoneyWiseTransaction) pTrans;</span>
<span class="fc" id="L125">        final OceanusDate myDate = myTrans.getDate();</span>
<span class="fc" id="L126">        final MoneyWiseTransAsset myAccount = myTrans.getAccount();</span>
<span class="fc" id="L127">        final MoneyWiseTransAsset myPartner = myTrans.getPartner();</span>
<span class="fc" id="L128">        final MoneyWiseTransCategory myCategory = myTrans.getCategory();</span>
<span class="fc" id="L129">        final MoneyWiseAssetDirection myDir = myTrans.getDirection();</span>
<span class="fc" id="L130">        final OceanusMoney myAmount = myTrans.getAmount();</span>
<span class="fc" id="L131">        final OceanusUnits myAccountUnits = myTrans.getAccountDeltaUnits();</span>
<span class="fc" id="L132">        final OceanusUnits myPartnerUnits = myTrans.getPartnerDeltaUnits();</span>
<span class="fc" id="L133">        boolean doCheckCombo = true;</span>

        /* Header is always valid */
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (pTrans.isHeader()) {</span>
<span class="nc" id="L137">            pTrans.setValidEdit();</span>
<span class="nc" id="L138">            return;</span>
        }

        /* Determine date range to check for */
<span class="fc" id="L142">        final OceanusDateRange myRange = myTrans.getDataSet().getDateRange();</span>

        /* The date must be non-null */
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (myDate == null) {</span>
<span class="nc" id="L146">            pTrans.addError(PrometheusDataItem.ERROR_MISSING, MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE);</span>
            /* The date must be in-range */
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        } else if (myRange.compareToDate(myDate) != 0) {</span>
<span class="nc" id="L149">            pTrans.addError(PrometheusDataItem.ERROR_RANGE, MoneyWiseBasicResource.MONEYWISEDATA_FIELD_DATE);</span>
        }

        /* Account must be non-null */
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">        if (myAccount == null) {</span>
<span class="nc" id="L154">            pTrans.addError(PrometheusDataItem.ERROR_MISSING, MoneyWiseBasicResource.TRANSACTION_ACCOUNT);</span>
<span class="nc" id="L155">            doCheckCombo = false;</span>

        } else {
            /* Account must be valid */
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">            if (!isValidAccount(myAccount)) {</span>
<span class="nc" id="L160">                pTrans.addError(MoneyWiseTransBase.ERROR_COMBO, MoneyWiseBasicResource.TRANSACTION_ACCOUNT);</span>
<span class="nc" id="L161">                doCheckCombo = false;</span>
            }
        }

        /* Category must be non-null */
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        if (myCategory == null) {</span>
<span class="nc" id="L167">            pTrans.addError(PrometheusDataItem.ERROR_MISSING, MoneyWiseBasicDataType.TRANSCATEGORY);</span>
<span class="nc" id="L168">            doCheckCombo = false;</span>

            /* Category must be valid for Account */
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        } else if (doCheckCombo</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">                &amp;&amp; !isValidCategory(myAccount, myCategory)) {</span>
<span class="nc" id="L173">            pTrans.addError(MoneyWiseTransBase.ERROR_COMBO, MoneyWiseBasicDataType.TRANSCATEGORY);</span>
<span class="nc" id="L174">            doCheckCombo = false;</span>
        }

        /* Direction must be non-null */
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        if (myDir == null) {</span>
<span class="nc" id="L179">            pTrans.addError(PrometheusDataItem.ERROR_MISSING, MoneyWiseBasicResource.TRANSACTION_DIRECTION);</span>
<span class="nc" id="L180">            doCheckCombo = false;</span>

            /* Direction must be valid for Account */
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        } else if (doCheckCombo</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">                &amp;&amp; !isValidDirection(myAccount, myCategory, myDir)) {</span>
<span class="nc" id="L185">            pTrans.addError(MoneyWiseTransBase.ERROR_COMBO, MoneyWiseBasicResource.TRANSACTION_DIRECTION);</span>
<span class="nc" id="L186">            doCheckCombo = false;</span>
        }

        /* Partner must be non-null */
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        if (myPartner == null) {</span>
<span class="nc" id="L191">            pTrans.addError(PrometheusDataItem.ERROR_MISSING, MoneyWiseBasicResource.TRANSACTION_PARTNER);</span>

        } else {
            /* Partner must be valid for Account */
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">            if (doCheckCombo</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">                    &amp;&amp; !isValidPartner(myAccount, myCategory, myPartner)) {</span>
<span class="fc" id="L197">                pTrans.addError(MoneyWiseTransBase.ERROR_COMBO, MoneyWiseBasicResource.TRANSACTION_PARTNER);</span>
            }
        }

        /* If money is null */
<span class="fc bfc" id="L202" title="All 2 branches covered.">        if (myAmount == null) {</span>
            /* Check that it must be null */
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">            if (!needsNullAmount(myTrans)) {</span>
<span class="nc" id="L205">                pTrans.addError(PrometheusDataItem.ERROR_MISSING, MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>
            }

            /* else non-null money */
        } else {
            /* Check that it must be null */
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">            if (needsNullAmount(myTrans)) {</span>
<span class="nc" id="L212">                pTrans.addError(PrometheusDataItem.ERROR_EXIST, MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>
            }

            /* Money must not be negative */
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">            if (!myAmount.isPositive()) {</span>
<span class="nc" id="L217">                pTrans.addError(PrometheusDataItem.ERROR_NEGATIVE, MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>
            }

            /* Check that amount is correct currency */
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">            if (myAccount != null) {</span>
<span class="fc" id="L222">                final Currency myCurrency = myAccount.getCurrency();</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">                if (!myAmount.getCurrency().equals(myCurrency)) {</span>
<span class="nc" id="L224">                    pTrans.addError(MoneyWiseTransBase.ERROR_CURRENCY, MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>
                }
            }
        }

        /* Cannot have PartnerUnits if securities are identical */
<span class="pc bpc" id="L230" title="1 of 4 branches missed.">        if (myAccountUnits != null</span>
                &amp;&amp; myPartnerUnits != null
<span class="nc bnc" id="L232" title="All 2 branches missed.">                &amp;&amp; MetisDataDifference.isEqual(myAccount, myPartner)) {</span>
<span class="nc" id="L233">            pTrans.addError(MoneyWiseTransaction.ERROR_CIRCULAR, MoneyWiseTransInfoSet.getFieldForClass(MoneyWiseTransInfoClass.PARTNERDELTAUNITS));</span>
        }

        /* If we have a category and an infoSet */
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        if (myCategory != null</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">                &amp;&amp; myTrans.getInfoSet() != null) {</span>
            /* Validate the InfoSet */
<span class="fc" id="L240">            theInfoSet.validate(myTrans.getInfoSet());</span>
        }

        /* Set validation flag */
<span class="fc bfc" id="L244" title="All 2 branches covered.">        if (!pTrans.hasErrors()) {</span>
<span class="fc" id="L245">            pTrans.setValidEdit();</span>
        }
<span class="fc" id="L247">    }</span>

    /**
     * Determines whether an event needs a zero amount.
     * @param pTrans the transaction
     * @return true/false
     */
    public boolean needsNullAmount(final MoneyWiseTransaction pTrans) {
<span class="fc" id="L255">        final MoneyWiseTransCategoryClass myClass = pTrans.getCategoryClass();</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">        return myClass != null</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">                &amp;&amp; myClass.needsNullAmount();</span>
    }

    @Override
    public boolean isValidAccount(final MoneyWiseTransAsset pAccount) {
        /* Validate securityHolding */
<span class="fc bfc" id="L263" title="All 2 branches covered.">        if (pAccount instanceof MoneyWiseSecurityHolding myHolding</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">                &amp;&amp; !checkSecurityHolding(myHolding)) {</span>
<span class="nc" id="L265">            return false;</span>
        }

        /* Reject pensions portfolio */
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (pAccount instanceof MoneyWisePortfolio myPortfolio</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                &amp;&amp; myPortfolio.getCategoryClass().holdsPensions()) {</span>
<span class="nc" id="L271">            return false;</span>
        }

        /* Check type of account */
<span class="fc" id="L275">        final MoneyWiseAssetType myType = pAccount.getAssetType();</span>
<span class="pc bpc" id="L276" title="2 of 4 branches missed.">        return myType.isBaseAccount() &amp;&amp; !pAccount.isHidden();</span>
    }

    @Override
    public boolean isValidCategory(final MoneyWiseTransAsset pAccount,
                                   final MoneyWiseTransCategory pCategory) {
        /* Access details */
<span class="fc" id="L283">        final MoneyWiseAssetType myType = pAccount.getAssetType();</span>
<span class="fc" id="L284">        final MoneyWiseTransCategoryClass myCatClass = Objects.requireNonNull(pCategory.getCategoryTypeClass());</span>

        /* Immediately reject hidden categories */
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">        if (myCatClass.isHiddenType()) {</span>
<span class="nc" id="L288">            return false;</span>
        }

        /* Switch on the CategoryClass */
<span class="pc bpc" id="L292" title="6 of 17 branches missed.">        switch (myCatClass) {</span>
            case TAXEDINCOME:
            case GROSSINCOME:
            case RECOVEREDEXPENSES:
            case OTHERINCOME:
                /* Taxed/Other income must be to deposit/cash/loan */
<span class="fc" id="L298">                return myType.isValued();</span>

            case PENSIONCONTRIB:
                /* Pension contribution must be to a Pension holding or to a SIPP */
<span class="nc" id="L302">                return (pAccount instanceof MoneyWiseSecurityHolding myHolding</span>
<span class="nc bnc" id="L303" title="All 4 branches missed.">                        &amp;&amp; myHolding.getSecurity().getCategoryClass().isPension())</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                        || (pAccount instanceof MoneyWisePortfolio myPortfolio</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                        &amp;&amp; myPortfolio.isPortfolioClass(MoneyWisePortfolioClass.SIPP));</span>

            case GIFTEDINCOME:
            case INHERITED:
                /* Inheritance/Gifted must be to asset */
<span class="fc" id="L310">                return myType.isAsset();</span>

            case INTEREST:
                /* Account must be deposit or portfolio */
<span class="pc bpc" id="L314" title="3 of 4 branches missed.">                return myType.isDeposit() || myType.isPortfolio();</span>

            case DIVIDEND:
            case SECURITYCLOSURE:
                /* Account must be SecurityHolding */
<span class="fc" id="L319">                return myType.isSecurityHolding();</span>

            case BADDEBTCAPITAL:
            case BADDEBTINTEREST:
                /* Account must be peer2Peer */
<span class="nc" id="L324">                return pAccount instanceof MoneyWiseDeposit myDeposit</span>
<span class="nc bnc" id="L325" title="All 4 branches missed.">                        &amp;&amp; myDeposit.isDepositClass(MoneyWiseDepositCategoryClass.PEER2PEER);</span>

            case CASHBACK:
<span class="fc" id="L328">                return checkCashBack(pAccount);</span>

            case LOYALTYBONUS:
<span class="fc" id="L331">                return checkLoyaltyBonus(pAccount);</span>

            case RENTALINCOME:
            case RENTALEXPENSE:
            case ROOMRENTALINCOME:
                /* Account must be property */
<span class="nc" id="L337">                return pAccount instanceof MoneyWiseSecurityHolding myHolding</span>
<span class="nc bnc" id="L338" title="All 4 branches missed.">                        &amp;&amp; myHolding.getSecurity().isSecurityClass(MoneyWiseSecurityClass.PROPERTY);</span>

            case UNITSADJUST:
            case SECURITYREPLACE:
                /* Account must be capital */
<span class="fc" id="L343">                return pAccount.isCapital();</span>

            case STOCKSPLIT:
            case STOCKTAKEOVER:
            case STOCKDEMERGER:
            case STOCKRIGHTSISSUE:
                /* Account must be shares */
<span class="fc" id="L350">                return pAccount.isShares();</span>

            case WRITEOFF:
            case LOANINTERESTEARNED:
            case LOANINTERESTCHARGED:
            case TAXRELIEF:
<span class="fc" id="L356">                return myType.isLoan();</span>

            case LOCALTAXES:
            case INCOMETAX:
<span class="nc" id="L360">                return myType.isValued();</span>

            case EXPENSE:
<span class="pc bpc" id="L363" title="1 of 4 branches missed.">                return myType.isValued() || myType.isAutoExpense();</span>

            case PORTFOLIOXFER:
<span class="nc bnc" id="L366" title="All 4 branches missed.">                return pAccount instanceof MoneyWiseSecurityHolding</span>
                        || pAccount instanceof MoneyWisePortfolio;

            case TRANSFER:
<span class="fc" id="L370">                return true;</span>

            /* Reject other categories */
            default:
<span class="nc" id="L374">                return false;</span>
        }
    }

    @Override
    public boolean isValidDirection(final MoneyWiseTransAsset pAccount,
                                    final MoneyWiseTransCategory pCategory,
                                    final MoneyWiseAssetDirection pDirection) {
        /* TODO relax some of these rules */

        /* Access details */
<span class="fc" id="L385">        final MoneyWiseTransCategoryClass myCatClass = pCategory.getCategoryTypeClass();</span>

        /* Switch on the CategoryClass */
<span class="pc bpc" id="L388" title="3 of 12 branches missed.">        switch (myCatClass) {</span>
            case TAXEDINCOME:
            case GROSSINCOME:
                /* Cannot refund Taxed Income yet */
<span class="pc bpc" id="L392" title="3 of 4 branches missed.">                return newValidation || pDirection.isFrom();</span>

            case PENSIONCONTRIB:
                /* Cannot refund Pension Contribution */
<span class="nc" id="L396">                return pDirection.isFrom();</span>

            case GIFTEDINCOME:
            case INHERITED:
                /* Cannot refund Gifted/Inherited Income yet */
<span class="pc bpc" id="L401" title="3 of 4 branches missed.">                return newValidation || pDirection.isFrom();</span>

            case RENTALINCOME:
            case ROOMRENTALINCOME:
                /* Cannot refund Rental Income */
<span class="nc" id="L406">                return pDirection.isTo();</span>

            case RENTALEXPENSE:
                /* Cannot refund Rental Expense */
<span class="nc" id="L410">                return pDirection.isFrom();</span>

            case INTEREST:
                /* Cannot refund Interest yet */
<span class="pc bpc" id="L414" title="3 of 4 branches missed.">                return newValidation || pDirection.isTo();</span>

            case DIVIDEND:
            case SECURITYCLOSURE:
                /* Cannot refund Dividend yet */
<span class="fc" id="L419">                return pDirection.isTo();</span>

            case LOYALTYBONUS:
                /* Cannot refund loyaltyBonus yet */
<span class="pc bpc" id="L423" title="3 of 4 branches missed.">                return newValidation || pDirection.isTo();</span>

            case WRITEOFF:
            case LOANINTERESTCHARGED:
                /* All need to be TO */
<span class="pc bpc" id="L428" title="3 of 4 branches missed.">                return newValidation || pDirection.isTo();</span>

            case LOANINTERESTEARNED:
                /* All need to be FROM */
<span class="pc bpc" id="L432" title="3 of 4 branches missed.">                return newValidation || pDirection.isFrom();</span>

            case UNITSADJUST:
            case STOCKSPLIT:
            case STOCKDEMERGER:
            case STOCKTAKEOVER:
            case SECURITYREPLACE:
            case PORTFOLIOXFER:
                /* All need to be To */
<span class="fc" id="L441">                return pDirection.isTo();</span>

            default:
<span class="fc" id="L444">                return true;</span>
        }
    }

    @Override
    public boolean isValidPartner(final MoneyWiseTransAsset pAccount,
                                  final MoneyWiseTransCategory pCategory,
                                  final MoneyWiseTransAsset pPartner) {
        /* Access details */
<span class="fc" id="L453">        final boolean isRecursive = MetisDataDifference.isEqual(pAccount, pPartner);</span>
<span class="fc" id="L454">        final MoneyWiseAssetType myPartnerType = pPartner.getAssetType();</span>
<span class="fc" id="L455">        final MoneyWiseTransCategoryClass myCatClass = Objects.requireNonNull(pCategory.getCategoryTypeClass());</span>

        /* Immediately reject hidden partners */
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">        if (pPartner.isHidden()) {</span>
<span class="nc" id="L459">            return false;</span>
        }

        /* Validate securityHolding */
<span class="fc bfc" id="L463" title="All 2 branches covered.">        if (pPartner instanceof MoneyWiseSecurityHolding myHolding</span>
<span class="pc bpc" id="L464" title="1 of 2 branches missed.">                &amp;&amp; !checkSecurityHolding(myHolding)) {</span>
<span class="nc" id="L465">            return false;</span>
        }

        /* Reject pensions portfolio */
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">        if (pPartner instanceof MoneyWisePortfolio myPortfolio</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">                &amp;&amp; myPortfolio.getCategoryClass().holdsPensions()) {</span>
<span class="nc" id="L471">            return false;</span>
        }

        /* If this involves auto-expense */
<span class="fc bfc" id="L475" title="All 2 branches covered.">        if (pAccount.isAutoExpense()</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">                || pPartner.isAutoExpense()) {</span>
            /* Access account type */
<span class="fc" id="L478">            final MoneyWiseAssetType myAccountType = pAccount.getAssetType();</span>

            /* Special processing */
<span class="pc bpc" id="L481" title="1 of 3 branches missed.">            switch (myCatClass) {</span>
                case TRANSFER:
                    /* Transfer must be to/from deposit/cash/loan */
<span class="fc bfc" id="L484" title="All 2 branches covered.">                    return myPartnerType.isAutoExpense()</span>
<span class="fc" id="L485">                            ? myAccountType.isValued()</span>
<span class="fc" id="L486">                            : myPartnerType.isValued();</span>

                case EXPENSE:
                    /* Transfer must be to/from payee */
<span class="fc" id="L490">                    return pPartner instanceof MoneyWisePayee;</span>

                /* Auto Expense cannot be used for other categories */
                default:
<span class="nc" id="L494">                    return false;</span>
            }
        }

        /* Switch on the CategoryClass */
<span class="pc bpc" id="L499" title="9 of 20 branches missed.">        switch (myCatClass) {</span>
            case TAXEDINCOME:
            case GROSSINCOME:
                /* Taxed Income must have a Payee that can provide income */
<span class="fc" id="L503">                return pPartner instanceof MoneyWisePayee myPayee</span>
<span class="pc bpc" id="L504" title="2 of 4 branches missed.">                        &amp;&amp; myPayee.getCategoryClass().canProvideTaxedIncome();</span>

            case PENSIONCONTRIB:
                /* Pension Contribution must be a payee that can parent */
<span class="nc" id="L508">                return pPartner instanceof MoneyWisePayee myPayee</span>
<span class="nc bnc" id="L509" title="All 4 branches missed.">                        &amp;&amp; myPayee.getCategoryClass().canContribPension();</span>

            case OTHERINCOME:
            case RECOVEREDEXPENSES:
                /* Other Income must have a Payee partner */
<span class="nc" id="L514">                return pPartner instanceof MoneyWisePayee;</span>

            case LOCALTAXES:
                /* LocalTaxes must have a Government Payee partner */
<span class="nc" id="L518">                return pPartner instanceof MoneyWisePayee myPayee</span>
<span class="nc bnc" id="L519" title="All 4 branches missed.">                        &amp;&amp; myPayee.isPayeeClass(MoneyWisePayeeClass.GOVERNMENT);</span>

            case GIFTEDINCOME:
            case INHERITED:
                /* Gifted/Inherited Income must have an Individual Payee partner */
<span class="fc" id="L524">                return pPartner instanceof MoneyWisePayee myPayee</span>
<span class="pc bpc" id="L525" title="2 of 4 branches missed.">                        &amp;&amp; myPayee.isPayeeClass(MoneyWisePayeeClass.INDIVIDUAL);</span>

            case RENTALINCOME:
            case RENTALEXPENSE:
            case ROOMRENTALINCOME:
                /* RentalIncome/Expense must have a loan partner */
<span class="nc" id="L531">                return myPartnerType.isLoan();</span>

            case WRITEOFF:
            case LOANINTERESTEARNED:
            case LOANINTERESTCHARGED:
                /* WriteOff/LoanInterestEarned/Charged must be recursive */
<span class="fc" id="L537">                return isRecursive;</span>

            case INTEREST:
            case CASHBACK:
                /* Interest/CashBack is to a valued account */
<span class="fc" id="L542">                return myPartnerType.isValued();</span>

            case DIVIDEND:
<span class="fc" id="L545">                return checkDividend(pAccount, pPartner);</span>

            case LOYALTYBONUS:
<span class="fc" id="L548">                return checkLoyaltyBonus(pAccount, pPartner);</span>

            case BADDEBTCAPITAL:
            case BADDEBTINTEREST:
<span class="nc bnc" id="L552" title="All 2 branches missed.">                return pPartner instanceof MoneyWisePayee</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">                        &amp;&amp; MetisDataDifference.isEqual(pPartner, pAccount.getParent());</span>

            case UNITSADJUST:
            case STOCKSPLIT:
                /* Must be recursive */
<span class="fc" id="L558">                return isRecursive;</span>

            case SECURITYREPLACE:
            case STOCKTAKEOVER:
            case STOCKDEMERGER:
<span class="nc" id="L563">                return checkTakeOver(pAccount, pPartner);</span>

            case STOCKRIGHTSISSUE:
<span class="fc" id="L566">                return checkStockRights(pAccount, pPartner);</span>

            case TRANSFER:
<span class="fc" id="L569">                return checkTransfer(pAccount, pPartner);</span>

            case SECURITYCLOSURE:
<span class="fc" id="L572">                return checkSecurityClosure(pAccount, pPartner);</span>

            case EXPENSE:
                /* Expense must have a Payee partner */
<span class="fc" id="L576">                return pPartner instanceof MoneyWisePayee;</span>

            case INCOMETAX:
            case TAXRELIEF:
<span class="nc" id="L580">                return pPartner instanceof MoneyWisePayee myPayee</span>
<span class="nc bnc" id="L581" title="All 4 branches missed.">                        &amp;&amp; myPayee.isPayeeClass(MoneyWisePayeeClass.TAXMAN);</span>

            case PORTFOLIOXFER:
<span class="nc" id="L584">                return checkPortfolioXfer(pAccount, pPartner);</span>

            default:
<span class="nc" id="L587">                return false;</span>
        }
    }

    /**
     * Check securityHolding.
     * @param pHolding the securityHolding
     * @return valid true/false
     */
    private static boolean checkSecurityHolding(final MoneyWiseSecurityHolding pHolding) {
        /* Access the components */
<span class="fc" id="L598">        final MoneyWisePortfolio myPortfolio = pHolding.getPortfolio();</span>
<span class="fc" id="L599">        final MoneyWiseSecurity mySecurity = pHolding.getSecurity();</span>

        /* If the portfolio can hold pensions */
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">        if (myPortfolio.getCategoryClass().holdsPensions()) {</span>
            /* Can only hold pensions */
<span class="nc" id="L604">            return mySecurity.getCategoryClass().isPension();</span>
        }

        /* cannot be a pension */
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">        return !mySecurity.getCategoryClass().isPension();</span>
    }

    /**
     * Check dividend.
     * @param pAccount the holding providing the dividend.
     * @param pPartner the partner
     * @return valid true/false
     */
    private static boolean checkDividend(final MoneyWiseTransAsset pAccount,
                                         final MoneyWiseTransAsset pPartner) {
        /* Recursive is allowed */
<span class="fc bfc" id="L620" title="All 2 branches covered.">        if (MetisDataDifference.isEqual(pAccount, pPartner)) {</span>
<span class="fc" id="L621">            return true;</span>
        }

        /* partner must be valued */
<span class="fc" id="L625">        return pPartner.getAssetType().isValued();</span>
    }

    /**
     * Check TakeOver.
     * @param pAccount the holding being acted on.
     * @param pPartner the partner
     * @return valid true/false
     */
    private static boolean checkTakeOver(final MoneyWiseTransAsset pAccount,
                                         final MoneyWiseTransAsset pPartner) {
        /* Must be holding &lt;-&gt; holding */
<span class="nc bnc" id="L637" title="All 4 branches missed.">        if (!(pAccount instanceof MoneyWiseSecurityHolding)</span>
                || !(pPartner instanceof MoneyWiseSecurityHolding)) {
<span class="nc" id="L639">            return false;</span>
        }

        /* Recursive is not allowed */
<span class="nc bnc" id="L643" title="All 2 branches missed.">        if (MetisDataDifference.isEqual(pAccount, pPartner)) {</span>
<span class="nc" id="L644">            return false;</span>
        }

        /* Access holdings */
<span class="nc" id="L648">        final MoneyWiseSecurityHolding myAccount = (MoneyWiseSecurityHolding) pAccount;</span>
<span class="nc" id="L649">        final MoneyWiseSecurityHolding myPartner = (MoneyWiseSecurityHolding) pPartner;</span>

        /* Portfolios must be the same */
<span class="nc bnc" id="L652" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(myAccount.getPortfolio(), myPartner.getPortfolio())) {</span>
<span class="nc" id="L653">            return false;</span>
        }

        /* Security types must be the same */
<span class="nc" id="L657">        return MetisDataDifference.isEqual(myAccount.getSecurity().getCategory(), myPartner.getSecurity().getCategory());</span>
    }

    /**
     * Check stock rights.
     * @param pAccount the account being transferred.
     * @param pPartner the partner
     * @return valid true/false
     */
    private static boolean checkStockRights(final MoneyWiseTransAsset pAccount,
                                            final MoneyWiseTransAsset pPartner) {
        /* If this is security -&gt; portfolio */
<span class="pc bpc" id="L669" title="2 of 4 branches missed.">        if (pAccount instanceof MoneyWiseSecurityHolding myHolding</span>
                &amp;&amp; pPartner instanceof MoneyWisePortfolio) {
            /* Must be same portfolios */
<span class="nc" id="L672">            return MetisDataDifference.isEqual(myHolding.getPortfolio(), pPartner);</span>
        }

        /* partner must be valued */
<span class="fc" id="L676">        return pPartner.getAssetType().isValued();</span>
    }

    /**
     * Check cashBack.
     * @param pAccount the account providing cashBack.
     * @return valid true/false
     */
    private static boolean checkCashBack(final MoneyWiseTransAsset pAccount) {
        /* If this is deposit then check whether it can support cashBack */
<span class="fc bfc" id="L686" title="All 2 branches covered.">        if (pAccount instanceof MoneyWiseDeposit myDeposit) {</span>
<span class="fc" id="L687">            return myDeposit.getCategoryClass().canCashBack();</span>
        }

        /* If this is loan then check whether it can support cashBack */
<span class="pc bpc" id="L691" title="1 of 2 branches missed.">        if (pAccount instanceof MoneyWiseLoan myLoan) {</span>
<span class="fc" id="L692">            return myLoan.getCategoryClass().canCashBack();</span>
        }

        /* not allowed */
<span class="nc" id="L696">        return false;</span>
    }

    /**
     * Check loyalty bonus.
     * @param pAccount the account providing bonus.
     * @return valid true/false
     */
    private boolean checkLoyaltyBonus(final MoneyWiseTransAsset pAccount) {
        /* If this is deposit then check whether it can support loyaltyBonus */
<span class="pc bpc" id="L706" title="1 of 2 branches missed.">        if (pAccount instanceof MoneyWiseDeposit myDeposit) {</span>
<span class="pc bpc" id="L707" title="1 of 2 branches missed.">            return newValidation</span>
<span class="pc bnc" id="L708" title="All 2 branches missed.">                    || myDeposit.getCategoryClass().canLoyaltyBonus();</span>
        }

        /* must be portfolio */
<span class="nc" id="L712">        return pAccount instanceof MoneyWisePortfolio;</span>
    }

    /**
     * Check loyalty bonus.
     * @param pAccount the account providing bonus.
     * @param pPartner the partner
     * @return valid true/false
     */
    private static boolean checkLoyaltyBonus(final MoneyWiseTransAsset pAccount,
                                             final MoneyWiseTransAsset pPartner) {
        /* If this is portfolio -&gt; security holding */
<span class="pc bpc" id="L724" title="3 of 4 branches missed.">        if (pAccount instanceof MoneyWisePortfolio</span>
<span class="nc" id="L725">                &amp;&amp; pPartner instanceof MoneyWiseSecurityHolding myHolding) {</span>
            /* Must be same portfolios */
<span class="nc" id="L727">            return MetisDataDifference.isEqual(myHolding.getPortfolio(), pAccount);</span>
        }

        /* must be recursive */
<span class="fc" id="L731">        return MetisDataDifference.isEqual(pAccount, pPartner);</span>
    }

    /**
     * Check transfer.
     * @param pAccount the account being transferred.
     * @param pPartner the partner
     * @return valid true/false
     */
    private static boolean checkTransfer(final MoneyWiseTransAsset pAccount,
                                         final MoneyWiseTransAsset pPartner) {
        /* Must not be recursive */
<span class="fc bfc" id="L743" title="All 2 branches covered.">        if (MetisDataDifference.isEqual(pAccount, pPartner)) {</span>
<span class="fc" id="L744">            return false;</span>
        }

        /* If this is security -&gt; portfolio */
<span class="pc bpc" id="L748" title="1 of 4 branches missed.">        if (pAccount instanceof MoneyWiseSecurityHolding myHolding</span>
                &amp;&amp; pPartner instanceof MoneyWisePortfolio) {
            /* Must be same portfolios */
<span class="nc bnc" id="L751" title="All 2 branches missed.">            if (!MetisDataDifference.isEqual(myHolding.getPortfolio(), pPartner)) {</span>
<span class="nc" id="L752">                return false;</span>
            }
        }

        /* If this is security &lt;- portfolio */
<span class="pc bpc" id="L757" title="1 of 4 branches missed.">        if (pPartner instanceof MoneyWiseSecurityHolding myHolding</span>
                &amp;&amp; pAccount instanceof MoneyWisePortfolio) {
            /* Must be same portfolios */
<span class="nc bnc" id="L760" title="All 2 branches missed.">            if (!MetisDataDifference.isEqual(myHolding.getPortfolio(), pAccount)) {</span>
<span class="nc" id="L761">                return false;</span>
            }
        }

        /* partner must be asset */
<span class="fc" id="L766">        return pPartner.getAssetType().isAsset();</span>
    }

    /**
     * Check securityClosure.
     * @param pAccount the account being closed.
     * @param pPartner the partner
     * @return valid true/false
     */
    private static boolean checkSecurityClosure(final MoneyWiseTransAsset pAccount,
                                                final MoneyWiseTransAsset pPartner) {
        /* Must not be recursive */
<span class="pc bpc" id="L778" title="1 of 2 branches missed.">        if (MetisDataDifference.isEqual(pAccount, pPartner)) {</span>
<span class="nc" id="L779">            return false;</span>
        }

        /* partner must be valued */
<span class="fc" id="L783">        return pPartner.getAssetType().isValued();</span>
    }

    /**
     * Check portfolioXfer.
     * @param pAccount the account being transferred.
     * @param pPartner the partner
     * @return valid true/false
     */
    private static boolean checkPortfolioXfer(final MoneyWiseTransAsset pAccount,
                                              final MoneyWiseTransAsset pPartner) {
        /* Partner must be portfolio */
<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (!(pPartner instanceof MoneyWisePortfolio)) {</span>
<span class="nc" id="L796">            return false;</span>
        }

        /* If account is portfolio */
<span class="nc bnc" id="L800" title="All 2 branches missed.">        if (pAccount instanceof MoneyWisePortfolio) {</span>
            /* Cannot be recursive */
<span class="nc bnc" id="L802" title="All 2 branches missed.">            if (MetisDataDifference.isEqual(pAccount, pPartner)) {</span>
<span class="nc" id="L803">                return false;</span>
            }

            /* Must be same currency */
<span class="nc" id="L807">            return MetisDataDifference.isEqual(pAccount.getAssetCurrency(), pPartner.getAssetCurrency());</span>
        }

        /* If account is security holding */
<span class="nc bnc" id="L811" title="All 2 branches missed.">        if (pAccount instanceof MoneyWiseSecurityHolding myHolding) {</span>
            /* Must be different portfolios */
<span class="nc bnc" id="L813" title="All 2 branches missed.">            return !MetisDataDifference.isEqual(myHolding.getPortfolio(), pPartner);</span>
        }

        /* Not allowed */
<span class="nc" id="L817">        return false;</span>
    }

    /**
     * Determine if an infoSet class is required.
     * @param pTrans the transaction
     * @param pClass the infoSet class
     * @return the status
     */
    public MetisFieldRequired isClassRequired(final MoneyWiseTransaction pTrans,
                                              final MoneyWiseTransInfoClass pClass) {
<span class="nc" id="L828">        theInfoSet.storeInfoSet(pTrans.getInfoSet());</span>
<span class="nc" id="L829">        return theInfoSet.isClassRequired(pClass);</span>
    }

    @Override
    public void autoCorrect(final MoneyWiseTransaction pItem) throws OceanusException {
<span class="nc" id="L834">        theDefaults.autoCorrect(pItem);</span>
<span class="nc" id="L835">    }</span>

    @Override
    public MoneyWiseTransaction buildTransaction(final Object pKey) {
<span class="nc" id="L839">        return theDefaults.buildTransaction(pKey);</span>
    }

    @Override
    public void setRange(final OceanusDateRange pRange) {
<span class="nc" id="L844">        theDefaults.setRange(pRange);</span>
<span class="nc" id="L845">    }</span>

    @Override
    public OceanusDateRange getRange() {
<span class="nc" id="L849">        return theDefaults.getRange();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>