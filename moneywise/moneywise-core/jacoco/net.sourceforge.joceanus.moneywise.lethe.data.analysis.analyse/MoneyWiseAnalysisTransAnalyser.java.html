<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseAnalysisTransAnalyser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.lethe.data.analysis.analyse</a> &gt; <span class="el_source">MoneyWiseAnalysisTransAnalyser.java</span></div><h1>MoneyWiseAnalysisTransAnalyser.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.lethe.data.analysis.analyse;

import net.sourceforge.joceanus.metis.field.MetisFieldItem;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.metis.preference.MetisPreferenceManager;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetBase;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseAssetType;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseBasicDataType;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseCash;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDeposit;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseLoan;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePortfolio;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePortfolio.MoneyWisePortfolioList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurity;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding.MoneyWiseSecurityHoldingMap;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurityPrice.MoneyWiseSecurityPriceDataMap;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTax.MoneyWiseTaxCredit;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransAsset;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransCategory;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransTag;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction.MoneyWiseTransactionList;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWisePayeeClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWisePortfolioClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseSecurityClass;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import net.sourceforge.joceanus.moneywise.exc.MoneyWiseLogicException;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysis;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisAccountBucket;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisCashBucket.MoneyWiseAnalysisCashBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisDataResource;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisDepositBucket.MoneyWiseAnalysisDepositBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisLoanBucket.MoneyWiseAnalysisLoanBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisPayeeBucket;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisPayeeBucket.MoneyWiseAnalysisPayeeBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisPortfolioBucket;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisPortfolioBucket.MoneyWiseAnalysisPortfolioBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisPortfolioCashBucket;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisSecurityBucket;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisTaxBasisBucket.MoneyWiseAnalysisTaxBasisBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisTransCategoryBucket;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisTransCategoryBucket.MoneyWiseAnalysisTransCategoryBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisTransTagBucket.MoneyWiseAnalysisTransTagBucketList;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.data.MoneyWiseAnalysisTransactionHelper;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisSecurityAttr;
import net.sourceforge.joceanus.moneywise.lethe.data.analysis.values.MoneyWiseAnalysisSecurityValues;
import net.sourceforge.joceanus.moneywise.tax.MoneyWiseCashType;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.decimal.OceanusPrice;
import net.sourceforge.joceanus.oceanus.decimal.OceanusRate;
import net.sourceforge.joceanus.oceanus.decimal.OceanusRatio;
import net.sourceforge.joceanus.oceanus.decimal.OceanusUnits;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.oceanus.profile.OceanusProfile;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditSet;

import java.util.Currency;
import java.util.Iterator;
import java.util.List;
import java.util.Objects;

/**
 * Class to analyse transactions.
 * @author Tony Washer
 */
public class MoneyWiseAnalysisTransAnalyser
        implements MetisFieldItem {
    /**
     * Local Report fields.
     */
    private static final String ERROR_CATEGORY = &quot;Unexpected Category Type: &quot;;

    /**
     * Local Report fields.
     */
<span class="fc" id="L96">    private static final MetisFieldSet&lt;MoneyWiseAnalysisTransAnalyser&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseAnalysisTransAnalyser.class);</span>

    /*
     * Declare Fields.
     */
    static {
<span class="fc" id="L102">        FIELD_DEFS.declareLocalField(MoneyWiseAnalysisDataResource.ANALYSIS_NAME, MoneyWiseAnalysisTransAnalyser::getAnalysis);</span>
    }

    /**
     * The Amount Tax threshold for &quot;small&quot; transactions (Â£3000).
     */
<span class="fc" id="L108">    private static final OceanusMoney LIMIT_VALUE = OceanusMoney.getWholeUnits(3000);</span>

    /**
     * The Rate Tax threshold for &quot;small&quot; transactions (5%).
     */
<span class="fc" id="L113">    private static final OceanusRate LIMIT_RATE = OceanusRate.getWholePercentage(5);</span>

    /**
     * The security holding map.
     */
    private final MoneyWiseSecurityHoldingMap theHoldingMap;

    /**
     * The security price map.
     */
    private final MoneyWiseSecurityPriceDataMap thePriceMap;

    /**
     * The analysis.
     */
    private final MoneyWiseAnalysis theAnalysis;

    /**
     * The transaction helper.
     */
    private final MoneyWiseAnalysisTransactionHelper theHelper;

    /**
     * The deposit bucket list.
     */
    private final MoneyWiseAnalysisDepositBucketList theDepositBuckets;

    /**
     * The cash bucket list.
     */
    private final MoneyWiseAnalysisCashBucketList theCashBuckets;

    /**
     * The deposit bucket list.
     */
    private final MoneyWiseAnalysisLoanBucketList theLoanBuckets;

    /**
     * The portfolio bucket list.
     */
    private final MoneyWiseAnalysisPortfolioBucketList thePortfolioBuckets;

    /**
     * The payee bucket list.
     */
    private final MoneyWiseAnalysisPayeeBucketList thePayeeBuckets;

    /**
     * The transaction category buckets.
     */
    private final MoneyWiseAnalysisTransCategoryBucketList theCategoryBuckets;

    /**
     * The transactionTag buckets.
     */
    private final MoneyWiseAnalysisTransTagBucketList theTagBuckets;

    /**
     * The taxBasis buckets.
     */
    private final MoneyWiseAnalysisTaxBasisBucketList theTaxBasisBuckets;

    /**
     * The taxMan account.
     */
    private final MoneyWiseAnalysisPayeeBucket theTaxMan;

    /**
     * The statePension account.
     */
    private final MoneyWiseAnalysisSecurityBucket theStatePension;

    /**
     * The profile.
     */
    private final OceanusProfile theProfile;

    /**
     * Constructor for a complete set of accounts.
     * @param pTask the profiled task
     * @param pEditSet the EditSet to analyse
     * @param pPreferenceMgr the preference manager
     * @throws OceanusException on error
     */
    public MoneyWiseAnalysisTransAnalyser(final OceanusProfile pTask,
                                          final PrometheusEditSet pEditSet,
<span class="fc" id="L199">                                          final MetisPreferenceManager pPreferenceMgr) throws OceanusException {</span>
        /* Start a new task */
<span class="fc" id="L201">        theProfile = pTask;</span>
<span class="fc" id="L202">        final OceanusProfile myTask = theProfile.startTask(&quot;analyseTransactions&quot;);</span>
<span class="fc" id="L203">        final MoneyWiseDataSet myDataSet = (MoneyWiseDataSet) pEditSet.getDataSet();</span>

        /* Store the parameters */
<span class="fc" id="L206">        theHoldingMap = pEditSet.getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class).getSecurityHoldingsMap();</span>
<span class="fc" id="L207">        thePriceMap = myDataSet.getSecurityPriceDataMap();</span>

        /* Access the lists */
<span class="fc" id="L210">        final MoneyWiseTransactionList myTrans = pEditSet.getDataList(MoneyWiseBasicDataType.TRANSACTION, MoneyWiseTransactionList.class);</span>

        /* Create a new analysis */
<span class="fc" id="L213">        myTask.startTask(&quot;Initialise&quot;);</span>
<span class="fc" id="L214">        theAnalysis = new MoneyWiseAnalysis(pEditSet, pPreferenceMgr);</span>

        /* Create new helper and set opening balances */
<span class="fc" id="L217">        theHelper = new MoneyWiseAnalysisTransactionHelper(myDataSet);</span>
<span class="fc" id="L218">        theAnalysis.addOpeningBalances(theHelper);</span>

        /* Access details from the analysis */
<span class="fc" id="L221">        theDepositBuckets = theAnalysis.getDeposits();</span>
<span class="fc" id="L222">        theCashBuckets = theAnalysis.getCash();</span>
<span class="fc" id="L223">        theLoanBuckets = theAnalysis.getLoans();</span>
<span class="fc" id="L224">        thePortfolioBuckets = theAnalysis.getPortfolios();</span>
<span class="fc" id="L225">        thePayeeBuckets = theAnalysis.getPayees();</span>
<span class="fc" id="L226">        theCategoryBuckets = theAnalysis.getTransCategories();</span>
<span class="fc" id="L227">        theTagBuckets = theAnalysis.getTransactionTags();</span>
<span class="fc" id="L228">        theTaxBasisBuckets = theAnalysis.getTaxBasis();</span>
<span class="fc" id="L229">        theTaxMan = thePayeeBuckets.getBucket(MoneyWisePayeeClass.TAXMAN);</span>

        /* Access the StatePension security holding */
<span class="fc" id="L232">        theStatePension = getStatePension(myDataSet);</span>

        /* Loop through the Transactions extracting relevant elements */
<span class="fc" id="L235">        myTask.startTask(&quot;Transactions&quot;);</span>
<span class="fc" id="L236">        final Iterator&lt;MoneyWiseTransaction&gt; myIterator = myTrans.iterator();</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L238">            final MoneyWiseTransaction myCurr = myIterator.next();</span>

            /* Ignore deleted/header transactions */
<span class="nc bnc" id="L241" title="All 4 branches missed.">            if (myCurr.isDeleted() || myCurr.isHeader()) {</span>
<span class="nc" id="L242">                continue;</span>
            }

            /* Touch underlying items */
<span class="nc" id="L246">            myCurr.touchUnderlyingItems();</span>

            /* Process the transaction in the report set */
<span class="nc" id="L249">            processTransaction(myCurr);</span>
<span class="nc" id="L250">        }</span>

        /* Complete the task */
<span class="fc" id="L253">        myTask.end();</span>
<span class="fc" id="L254">    }</span>

    /**
     * Obtain statePension bucket.
     * @param pData the dataSet
     * @return the statePension bucket
     */
    private MoneyWiseAnalysisSecurityBucket getStatePension(final MoneyWiseDataSet pData) {
        /* Access the singular portfolio and security */
<span class="fc" id="L263">        final MoneyWisePortfolio myPensionPort = pData.getPortfolios().getSingularClass(MoneyWisePortfolioClass.PENSION);</span>
<span class="fc" id="L264">        final MoneyWiseSecurity myStatePension = pData.getSecurities().getSingularClass(MoneyWiseSecurityClass.STATEPENSION);</span>

        /* If they exist, access the bucket */
<span class="pc bpc" id="L267" title="3 of 4 branches missed.">        if (myPensionPort != null</span>
                &amp;&amp; myStatePension != null) {
<span class="nc" id="L269">            final MoneyWiseSecurityHolding myHolding = pData.getPortfolios().getSecurityHoldingsMap().declareHolding(myPensionPort, myStatePension);</span>
<span class="nc" id="L270">            return thePortfolioBuckets.getBucket(myHolding);</span>
        }

        /* Default to no bucket */
<span class="fc" id="L274">        return null;</span>
    }

    @Override
    public MetisFieldSet&lt;MoneyWiseAnalysisTransAnalyser&gt; getDataFieldSet() {
<span class="nc" id="L279">        return FIELD_DEFS;</span>
    }

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L284">        return FIELD_DEFS.getName();</span>
    }

    /**
     * Obtain the analysis.
     * @return the analysis
     */
    public MoneyWiseAnalysis getAnalysis() {
<span class="fc" id="L292">        return theAnalysis;</span>
    }

    /**
     * Mark active accounts.
     * @throws OceanusException on error
     */
    public void postProcessAnalysis() throws OceanusException {
        /* Start a new task */
<span class="fc" id="L301">        final OceanusProfile myTask = theProfile.startTask(&quot;postProcessAnalysis&quot;);</span>
<span class="fc" id="L302">        myTask.startTask(&quot;markActiveAccounts&quot;);</span>

        /* Mark relevant accounts */
<span class="fc" id="L305">        theDepositBuckets.markActiveAccounts();</span>
<span class="fc" id="L306">        theCashBuckets.markActiveAccounts();</span>
<span class="fc" id="L307">        theLoanBuckets.markActiveAccounts();</span>

        /* Mark relevant securities */
<span class="fc" id="L310">        thePortfolioBuckets.markActiveSecurities();</span>

        /* Complete the task */
<span class="fc" id="L313">        myTask.end();</span>
<span class="fc" id="L314">    }</span>

    /**
     * Process a transaction.
     * @param pTrans the transaction to process
     * @throws OceanusException on error
     */
    private void processTransaction(final MoneyWiseTransaction pTrans) throws OceanusException {
        /* Declare to helper */
<span class="nc" id="L323">        theHelper.setTransaction(pTrans);</span>

        /* Access key details */
<span class="nc" id="L326">        final MoneyWiseTransAsset myDebitAsset = theHelper.getDebitAsset();</span>
<span class="nc" id="L327">        final MoneyWiseTransAsset myCreditAsset = theHelper.getCreditAsset();</span>
<span class="nc" id="L328">        final MoneyWiseTaxCredit myYear = pTrans.getTaxYear();</span>

        /* Look for tags */
<span class="nc" id="L331">        final List&lt;MoneyWiseTransTag&gt; myTags = pTrans.getTransactionTags();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (myTags != null) {</span>
            /* Process the transaction tags */
<span class="nc" id="L334">            theTagBuckets.processTransaction(pTrans, myTags.iterator());</span>
        }

        /* If the event relates to a security item, split out the workings */
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (myDebitAsset instanceof MoneyWiseSecurityHolding) {</span>
            /* Process as a Security transaction */
<span class="nc" id="L340">            processDebitSecurityTransaction((MoneyWiseSecurityHolding) myDebitAsset, myCreditAsset);</span>

            /* If the event relates to a security item, split out the workings */
<span class="nc bnc" id="L343" title="All 2 branches missed.">        } else if (myCreditAsset instanceof MoneyWiseSecurityHolding) {</span>
            /* Process as a Security transaction */
<span class="nc" id="L345">            processCreditSecurityTransaction(myDebitAsset, (MoneyWiseSecurityHolding) myCreditAsset);</span>

            /* Else handle the portfolio transfer */
<span class="nc bnc" id="L348" title="All 4 branches missed.">        } else if (myDebitAsset instanceof MoneyWisePortfolio</span>
                &amp;&amp; myCreditAsset instanceof MoneyWisePortfolio
<span class="nc bnc" id="L350" title="All 2 branches missed.">                &amp;&amp; pTrans.getCategoryClass() == MoneyWiseTransCategoryClass.PORTFOLIOXFER</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                &amp;&amp; !myDebitAsset.equals(myCreditAsset)) {</span>
            /* Process portfolio transfer */
<span class="nc" id="L353">            processPortfolioXfer((MoneyWisePortfolio) myDebitAsset, (MoneyWisePortfolio) myCreditAsset);</span>

            /* Else handle the event normally */
<span class="nc bnc" id="L356" title="All 4 branches missed.">        } else if (myDebitAsset instanceof MoneyWiseAssetBase</span>
                &amp;&amp; myCreditAsset instanceof MoneyWiseAssetBase) {
            /* Access correctly */
<span class="nc" id="L359">            MoneyWiseAssetBase myDebit = (MoneyWiseAssetBase) myDebitAsset;</span>
<span class="nc" id="L360">            MoneyWiseAssetBase myCredit = (MoneyWiseAssetBase) myCreditAsset;</span>
<span class="nc" id="L361">            MoneyWiseAssetBase myChild = null;</span>
<span class="nc" id="L362">            final OceanusMoney myAmount = pTrans.getAmount();</span>
<span class="nc" id="L363">            MoneyWiseTransCategory myCat = pTrans.getCategory();</span>

            /* Switch on category class */
<span class="nc bnc" id="L366" title="All 5 branches missed.">            switch (myCat.getCategoryTypeClass()) {</span>
                case INTEREST:
                case LOYALTYBONUS:
                    /* Obtain detailed category */
<span class="nc" id="L370">                    myCat = myDebit.getDetailedCategory(myCat, myYear);</span>

                    /* True debit account is the parent */
<span class="nc bnc" id="L373" title="All 2 branches missed.">                    myChild = myDebit.equals(myCredit)</span>
<span class="nc" id="L374">                            ? null</span>
<span class="nc" id="L375">                            : myDebit;</span>
<span class="nc" id="L376">                    myDebit = myDebit.getParent();</span>
<span class="nc" id="L377">                    break;</span>
                case LOANINTERESTEARNED:
                case CASHBACK:
                    /* True debit account is the parent of the asset */
<span class="nc" id="L381">                    myDebit = myDebit.getParent();</span>
<span class="nc" id="L382">                    break;</span>
                case RENTALINCOME:
                case ROOMRENTALINCOME:
                    /* True debit account is the parent of the security */
<span class="nc bnc" id="L386" title="All 2 branches missed.">                    myChild = myDebit.equals(myCredit)</span>
<span class="nc" id="L387">                            ? null</span>
<span class="nc" id="L388">                            : myDebit;</span>
<span class="nc" id="L389">                    myDebit = myCredit.getParent();</span>
<span class="nc" id="L390">                    break;</span>
                case WRITEOFF:
                case LOANINTERESTCHARGED:
                    /* True credit account is the parent of the loan */
<span class="nc" id="L394">                    myCredit = myCredit.getParent();</span>
<span class="nc" id="L395">                    break;</span>
                default:
                    break;
            }

            /* If the debit account is auto-Expense */
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (myDebit instanceof MoneyWiseCash</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">                    &amp;&amp; myDebit.getAssetType() == MoneyWiseAssetType.AUTOEXPENSE) {</span>
                /* Access debit as cash */
<span class="nc" id="L404">                final MoneyWiseCash myCash = (MoneyWiseCash) myDebit;</span>
<span class="nc" id="L405">                final MoneyWiseTransCategory myAuto = myCash.getAutoExpense();</span>
<span class="nc" id="L406">                myDebit = myCash.getAutoPayee();</span>
<span class="nc" id="L407">                myDebit.touchItem(pTrans);</span>

                /* Subtract expense from Payee bucket */
<span class="nc" id="L410">                final MoneyWiseAnalysisPayeeBucket myPayee = thePayeeBuckets.getBucket(myDebit);</span>
<span class="nc" id="L411">                myPayee.subtractExpense(theHelper, myAmount);</span>

                /* Subtract expense from Category bucket */
<span class="nc" id="L414">                final MoneyWiseAnalysisTransCategoryBucket myCatBucket = theCategoryBuckets.getBucket(myAuto);</span>
<span class="nc" id="L415">                myCatBucket.subtractExpense(theHelper, myAmount);</span>
<span class="nc" id="L416">                theTaxBasisBuckets.adjustAutoExpense(theHelper, false);</span>

                /* handle Payees */
<span class="nc bnc" id="L419" title="All 2 branches missed.">            } else if (MoneyWiseAssetType.PAYEE.equals(myDebit.getAssetType())) {</span>
<span class="nc" id="L420">                final MoneyWiseAnalysisPayeeBucket myPayee = thePayeeBuckets.getBucket(myDebit);</span>
<span class="nc" id="L421">                myPayee.adjustForDebit(theHelper);</span>

                /* handle valued assets */
<span class="nc" id="L424">            } else {</span>
<span class="nc" id="L425">                final MoneyWiseAnalysisAccountBucket&lt;?&gt; myBucket = getAccountBucket(myDebit);</span>
<span class="nc" id="L426">                myBucket.adjustForDebit(theHelper);</span>
            }

            /* If the credit account is auto-Expense */
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (myCredit instanceof MoneyWiseCash</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                    &amp;&amp; myCredit.getAssetType() == MoneyWiseAssetType.AUTOEXPENSE) {</span>
                /* Access credit as cash */
<span class="nc" id="L433">                final MoneyWiseCash myCash = (MoneyWiseCash) myCredit;</span>
<span class="nc" id="L434">                final MoneyWiseTransCategory myAuto = myCash.getAutoExpense();</span>
<span class="nc" id="L435">                myCredit = myCash.getAutoPayee();</span>
<span class="nc" id="L436">                myCredit.touchItem(pTrans);</span>

                /* Add expense to Payee bucket */
<span class="nc" id="L439">                final MoneyWiseAnalysisPayeeBucket myPayee = thePayeeBuckets.getBucket(myCredit);</span>
<span class="nc" id="L440">                myPayee.addExpense(theHelper, myAmount);</span>

                /* Adjust the relevant category bucket */
<span class="nc" id="L443">                final MoneyWiseAnalysisTransCategoryBucket myCatBucket = theCategoryBuckets.getBucket(myAuto);</span>
<span class="nc" id="L444">                myCatBucket.addExpense(theHelper, myAmount);</span>
<span class="nc" id="L445">                theTaxBasisBuckets.adjustAutoExpense(theHelper, true);</span>

                /* handle Payees */
<span class="nc bnc" id="L448" title="All 2 branches missed.">            } else if (MoneyWiseAssetType.PAYEE.equals(myCredit.getAssetType())) {</span>
<span class="nc" id="L449">                final MoneyWiseAnalysisPayeeBucket myPayee = thePayeeBuckets.getBucket(myCredit);</span>
<span class="nc" id="L450">                myPayee.adjustForCredit(theHelper);</span>

                /* handle valued assets */
<span class="nc" id="L453">            } else {</span>
<span class="nc" id="L454">                final MoneyWiseAnalysisAccountBucket&lt;?&gt; myBucket = getAccountBucket(myCredit);</span>
<span class="nc" id="L455">                myBucket.adjustForCredit(theHelper);</span>
            }

            /* If we should register the event with a child */
<span class="nc bnc" id="L459" title="All 2 branches missed.">            if (myChild != null) {</span>
                /* Access bucket and register it */
<span class="nc" id="L461">                final MoneyWiseAnalysisAccountBucket&lt;?&gt; myBucket = getAccountBucket(myChild);</span>
<span class="nc" id="L462">                myBucket.registerTransaction(pTrans);</span>
            }

            /* Adjust the tax and NI payments */
<span class="nc" id="L466">            theTaxMan.adjustForTaxPayments(theHelper);</span>
<span class="nc" id="L467">            theStatePension.adjustForNIPayments(theHelper);</span>

            /* If the event category is not a transfer */
<span class="nc bnc" id="L470" title="All 2 branches missed.">            if (!myCat.isTransfer()) {</span>
                /* Adjust the relevant category buckets */
<span class="nc" id="L472">                theCategoryBuckets.adjustCategories(theHelper, myCat);</span>
            }

            /* Unknown combination */
<span class="nc" id="L476">        } else {</span>
<span class="nc" id="L477">            throw new MoneyWiseLogicException(&quot;Invalid Asset Pair: &quot;</span>
<span class="nc" id="L478">                    + pTrans.getAccount().getAssetType()</span>
                    + &quot; &quot;
<span class="nc" id="L480">                    + pTrans.getDirection()</span>
                    + &quot; &quot;
<span class="nc" id="L482">                    + pTrans.getPartner().getAssetType());</span>
        }
<span class="nc" id="L484">    }</span>

    /**
     * Process a debit security transaction.
     * @param pDebit the debit security
     * @param pCredit the credit account
     * @throws OceanusException on error
     */
    private void processDebitSecurityTransaction(final MoneyWiseSecurityHolding pDebit,
                                                 final MoneyWiseTransAsset pCredit) throws OceanusException {
        /* If credit account is also SecurityHolding */
<span class="nc bnc" id="L495" title="All 2 branches missed.">        if (pCredit instanceof MoneyWiseSecurityHolding) {</span>
            /* Split out working */
<span class="nc" id="L497">            processDebitCreditSecurityTransaction(pDebit, (MoneyWiseSecurityHolding) pCredit);</span>
<span class="nc" id="L498">            return;</span>
        }

        /* Switch on the category */
<span class="nc" id="L502">        final MoneyWiseTransCategory myCat = theHelper.getCategory();</span>
<span class="nc bnc" id="L503" title="All 5 branches missed.">        switch (myCat.getCategoryTypeClass()) {</span>
            /* Process a stock right waived */
            case STOCKRIGHTSISSUE:
<span class="nc" id="L506">                processTransferOut(pDebit, (MoneyWiseAssetBase) pCredit);</span>
<span class="nc" id="L507">                break;</span>
            /* Process a dividend */
            case DIVIDEND:
<span class="nc" id="L510">                processDividend(pDebit, pCredit);</span>
<span class="nc" id="L511">                break;</span>
            case PORTFOLIOXFER:
<span class="nc" id="L513">                processPortfolioXfer(pDebit, (MoneyWisePortfolio) pCredit);</span>
<span class="nc" id="L514">                break;</span>
            /* Process standard transfer in/out */
            case TRANSFER:
            case SECURITYCLOSURE:
            case EXPENSE:
            case INHERITED:
            case OTHERINCOME:
<span class="nc bnc" id="L521" title="All 2 branches missed.">                if (pDebit.getSecurity().isSecurityClass(MoneyWiseSecurityClass.LIFEBOND)) {</span>
<span class="nc" id="L522">                    processChargeableGain(pDebit, (MoneyWiseAssetBase) pCredit);</span>
                } else {
<span class="nc" id="L524">                    processTransferOut(pDebit, (MoneyWiseAssetBase) pCredit);</span>
                }
<span class="nc" id="L526">                break;</span>
            /* Throw an Exception */
            default:
<span class="nc" id="L529">                throw new MoneyWiseLogicException(ERROR_CATEGORY</span>
<span class="nc" id="L530">                        + myCat.getCategoryTypeClass());</span>
        }
<span class="nc" id="L532">    }</span>

    /**
     * Process a debit+credit security transaction.
     * @param pDebit the debit security
     * @param pCredit the credit security
     * @throws OceanusException on error
     */
    private void processDebitCreditSecurityTransaction(final MoneyWiseSecurityHolding pDebit,
                                                       final MoneyWiseSecurityHolding pCredit) throws OceanusException {
        /* Switch on the category */
<span class="nc" id="L543">        final MoneyWiseTransCategory myCat = theHelper.getCategory();</span>
<span class="nc bnc" id="L544" title="All 6 branches missed.">        switch (myCat.getCategoryTypeClass()) {</span>
            /* Process a stock split */
            case STOCKSPLIT:
            case UNITSADJUST:
<span class="nc" id="L548">                processUnitsAdjust(pDebit);</span>
<span class="nc" id="L549">                break;</span>
            /* Process a stock DeMerger */
            case STOCKDEMERGER:
<span class="nc" id="L552">                processStockDeMerger(pDebit, pCredit);</span>
<span class="nc" id="L553">                break;</span>
            /* Process a Stock TakeOver */
            case SECURITYREPLACE:
            case STOCKTAKEOVER:
<span class="nc" id="L557">                processStockTakeover(pDebit, pCredit);</span>
<span class="nc" id="L558">                break;</span>
            /* Process a dividend */
            case DIVIDEND:
<span class="nc" id="L561">                processDividend(pDebit, pCredit);</span>
<span class="nc" id="L562">                break;</span>
            /* Process standard transfer in/out */
            case TRANSFER:
            case EXPENSE:
            case INHERITED:
            case OTHERINCOME:
<span class="nc" id="L568">                processStockXchange(pDebit, pCredit);</span>
<span class="nc" id="L569">                break;</span>
            /* Throw an Exception */
            default:
<span class="nc" id="L572">                throw new MoneyWiseLogicException(ERROR_CATEGORY</span>
<span class="nc" id="L573">                        + myCat.getCategoryTypeClass());</span>
        }
<span class="nc" id="L575">    }</span>

    /**
     * Process a credit security transaction.
     * @param pDebit the debit account
     * @param pCredit the credit security holding
     * @throws OceanusException on error
     */
    private void processCreditSecurityTransaction(final MoneyWiseTransAsset pDebit,
                                                  final MoneyWiseSecurityHolding pCredit) throws OceanusException {
        /* Input asset must be AssetBase */
<span class="nc bnc" id="L586" title="All 2 branches missed.">        if (!(pDebit instanceof MoneyWiseAssetBase)) {</span>
<span class="nc" id="L587">            throw new MoneyWiseLogicException(&quot;Invalid Debit Asset: &quot;</span>
<span class="nc" id="L588">                    + pDebit.getAssetType());</span>
        }
<span class="nc" id="L590">        final MoneyWiseAssetBase myDebit = (MoneyWiseAssetBase) pDebit;</span>

        /* Switch on the category */
<span class="nc" id="L593">        final MoneyWiseTransCategory myCat = theHelper.getCategory();</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">        switch (myCat.getCategoryTypeClass()) {</span>
            /* Process standard transfer in/out */
            case STOCKRIGHTSISSUE:
            case TRANSFER:
            case EXPENSE:
            case INHERITED:
            case OTHERINCOME:
            case PENSIONCONTRIB:
<span class="nc" id="L602">                processTransferIn(myDebit, pCredit);</span>
<span class="nc" id="L603">                break;</span>
            /* Throw an Exception */
            default:
<span class="nc" id="L606">                throw new MoneyWiseLogicException(ERROR_CATEGORY</span>
<span class="nc" id="L607">                        + myCat.getCategoryTypeClass());</span>
        }
<span class="nc" id="L609">    }</span>

    /**
     * Process a transaction that is a portfolio transfer.
     * &lt;p&gt;
     * This capital event relates only to both Debit and credit accounts.
     * @param pSource the source portfolio
     * @param pTarget the target portfolio
     */
    private void processPortfolioXfer(final MoneyWisePortfolio pSource,
                                      final MoneyWisePortfolio pTarget) {
        /* Access the portfolio buckets */
<span class="nc" id="L621">        final MoneyWiseAnalysisPortfolioBucket mySource = thePortfolioBuckets.getBucket(pSource);</span>
<span class="nc" id="L622">        final MoneyWiseAnalysisPortfolioBucket myTarget = thePortfolioBuckets.getBucket(pTarget);</span>

        /* Access source cash bucket */
<span class="nc" id="L625">        final MoneyWiseAnalysisPortfolioCashBucket mySourceCash = mySource.getPortfolioCash();</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">        if (mySourceCash.isActive()) {</span>
            /* Transfer any cash element */
<span class="nc" id="L628">            final MoneyWiseAnalysisPortfolioCashBucket myTargetCash = myTarget.getPortfolioCash();</span>
<span class="nc" id="L629">            myTargetCash.adjustForXfer(mySourceCash, theHelper);</span>
        }

        /* Loop through the source portfolio */
<span class="nc" id="L633">        final Iterator&lt;MoneyWiseAnalysisSecurityBucket&gt; myIterator = mySource.securityIterator();</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L635">            final MoneyWiseAnalysisSecurityBucket myBucket = myIterator.next();</span>

            /* If the bucket is active */
<span class="nc bnc" id="L638" title="All 2 branches missed.">            if (myBucket.isActive()) {</span>
                /* Adjust the Target Bucket */
<span class="nc" id="L640">                final MoneyWiseSecurityHolding myTargetHolding = theHoldingMap.declareHolding(pTarget, myBucket.getSecurity());</span>
<span class="nc" id="L641">                final MoneyWiseAnalysisSecurityBucket myTargetBucket = myTarget.getSecurityBucket(myTargetHolding);</span>
<span class="nc" id="L642">                theHelper.setSecurity(myBucket.getSecurity());</span>

                /* Process the Transfer */
<span class="nc" id="L645">                processPortfolioXfer(myBucket, myTargetBucket);</span>
            }
<span class="nc" id="L647">        }</span>

        /* PortfolioXfer is a transfer, so no need to update the categories */
<span class="nc" id="L650">    }</span>

    /**
     * Process a portfolio transfer.
     * @param pSource the source holding
     * @param pTarget the target holding
     */
    private void processPortfolioXfer(final MoneyWiseAnalysisSecurityBucket pSource,
                                      final MoneyWiseAnalysisSecurityBucket pTarget) {
        /* Access source details */
<span class="nc" id="L660">        MoneyWiseAnalysisSecurityValues mySourceValues = pSource.getValues();</span>
<span class="nc" id="L661">        OceanusUnits myUnits = mySourceValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L662">        OceanusMoney myCost = mySourceValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L663">        OceanusMoney myGains = mySourceValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS);</span>
<span class="nc" id="L664">        OceanusMoney myInvested = mySourceValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.INVESTED);</span>
<span class="nc" id="L665">        OceanusMoney myForeignInvested = mySourceValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED);</span>
<span class="nc" id="L666">        final boolean isForeign = pSource.isForeignCurrency();</span>

        /* Determine value of the stock being transferred */
<span class="nc" id="L669">        final OceanusPrice myPrice = thePriceMap.getPriceForDate(pSource.getSecurity(), theHelper.getDate());</span>
<span class="nc" id="L670">        OceanusMoney myStockValue = myUnits.valueAtPrice(myPrice);</span>
<span class="nc" id="L671">        OceanusMoney myForeignValue = null;</span>
<span class="nc" id="L672">        OceanusRatio myRate = null;</span>

        /* If we are foreign */
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (isForeign) {</span>
            /* Determine foreign and local value */
<span class="nc" id="L677">            myRate = theHelper.getDebitExchangeRate();</span>
<span class="nc" id="L678">            myForeignValue = myStockValue;</span>
<span class="nc" id="L679">            myStockValue = myStockValue.convertCurrency(theAnalysis.getCurrency().getCurrency(), myRate);</span>
        }

        /* Allocate current profit between the two stocks */
<span class="nc" id="L683">        OceanusMoney myProfit = new OceanusMoney(myStockValue);</span>
<span class="nc" id="L684">        myProfit.subtractAmount(myCost);</span>
<span class="nc" id="L685">        pSource.adjustCounter(MoneyWiseAnalysisSecurityAttr.GROWTHADJUST, myProfit);</span>
<span class="nc" id="L686">        myProfit = new OceanusMoney(myProfit);</span>
<span class="nc" id="L687">        myProfit.negate();</span>
<span class="nc" id="L688">        pTarget.adjustCounter(MoneyWiseAnalysisSecurityAttr.GROWTHADJUST, myProfit);</span>

        /* Transfer Units/Cost/Invested to target */
<span class="nc" id="L691">        pTarget.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits);</span>
<span class="nc" id="L692">        pTarget.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost);</span>
<span class="nc" id="L693">        pTarget.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myInvested);</span>
<span class="nc" id="L694">        pTarget.adjustCounter(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myGains);</span>
<span class="nc" id="L695">        final MoneyWiseAnalysisSecurityValues myTargetValues = pTarget.registerTransaction(theHelper);</span>
<span class="nc" id="L696">        myTargetValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myPrice);</span>
<span class="nc" id="L697">        myTargetValues.setValue(MoneyWiseAnalysisSecurityAttr.VALUATION, myStockValue);</span>
<span class="nc" id="L698">        myTargetValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCost);</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (isForeign) {</span>
<span class="nc" id="L700">            myTargetValues.setValue(MoneyWiseAnalysisSecurityAttr.FOREIGNVALUE, myForeignValue);</span>
<span class="nc" id="L701">            myTargetValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myRate);</span>
<span class="nc" id="L702">            pTarget.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myForeignInvested);</span>
        }

        /* Adjust the Source Units/Cost/Invested to zero */
<span class="nc" id="L706">        myUnits = new OceanusUnits(myUnits);</span>
<span class="nc" id="L707">        myUnits.negate();</span>
<span class="nc" id="L708">        pSource.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myUnits);</span>
<span class="nc" id="L709">        myCost = new OceanusMoney(myCost);</span>
<span class="nc" id="L710">        myCost.negate();</span>
<span class="nc" id="L711">        pSource.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCost);</span>
<span class="nc" id="L712">        myCost.negate();</span>
<span class="nc" id="L713">        myInvested = new OceanusMoney(myInvested);</span>
<span class="nc" id="L714">        myInvested.negate();</span>
<span class="nc" id="L715">        pSource.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myInvested);</span>
<span class="nc" id="L716">        myGains = new OceanusMoney(myGains);</span>
<span class="nc" id="L717">        myGains.negate();</span>
<span class="nc" id="L718">        pSource.adjustCounter(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myGains);</span>
<span class="nc" id="L719">        mySourceValues = pSource.registerTransaction(theHelper);</span>
<span class="nc" id="L720">        mySourceValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myPrice);</span>
<span class="nc" id="L721">        mySourceValues.setValue(MoneyWiseAnalysisSecurityAttr.VALUATION, myStockValue);</span>
<span class="nc" id="L722">        mySourceValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCost);</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">        if (isForeign) {</span>
<span class="nc" id="L724">            mySourceValues.setValue(MoneyWiseAnalysisSecurityAttr.FOREIGNVALUE, myForeignValue);</span>
<span class="nc" id="L725">            mySourceValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myRate);</span>
<span class="nc" id="L726">            myForeignInvested = new OceanusMoney(myForeignInvested);</span>
<span class="nc" id="L727">            myForeignInvested.negate();</span>
<span class="nc" id="L728">            pTarget.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myForeignInvested);</span>
        }
<span class="nc" id="L730">    }</span>

    /**
     * Process a transaction that is a portfolio transfer.
     * &lt;p&gt;
     * This capital event relates only to both Debit and credit accounts.
     * @param pSource the source holding
     * @param pTarget the target portfolio
     */
    private void processPortfolioXfer(final MoneyWiseSecurityHolding pSource,
                                      final MoneyWisePortfolio pTarget) {
        /* Access the portfolio buckets */
<span class="nc" id="L742">        final MoneyWiseAnalysisPortfolioBucket mySource = thePortfolioBuckets.getBucket(pSource.getPortfolio());</span>
<span class="nc" id="L743">        final MoneyWiseAnalysisPortfolioBucket myTarget = thePortfolioBuckets.getBucket(pTarget);</span>

        /* Access source security bucket */
<span class="nc" id="L746">        final MoneyWiseAnalysisSecurityBucket myBucket = mySource.getSecurityBucket(pSource);</span>

        /* If the bucket is active */
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if (myBucket.isActive()) {</span>
            /* Adjust the Target Bucket */
<span class="nc" id="L751">            final MoneyWiseSecurityHolding myTargetHolding = theHoldingMap.declareHolding(pTarget, myBucket.getSecurity());</span>
<span class="nc" id="L752">            final MoneyWiseAnalysisSecurityBucket myTargetBucket = myTarget.getSecurityBucket(myTargetHolding);</span>

            /* Process the Transfer */
<span class="nc" id="L755">            processPortfolioXfer(myBucket, myTargetBucket);</span>
        }

        /* PortfolioXfer is a transfer, so no need to update the categories */
<span class="nc" id="L759">    }</span>

    /**
     * Process a transaction that is a stock split.
     * &lt;p&gt;
     * This capital event relates only to the Debit Account since the credit account is the same.
     * @param pHolding the security holding
     */
    private void processUnitsAdjust(final MoneyWiseSecurityHolding pHolding) {
        /* Access the units */
<span class="nc" id="L769">        final OceanusUnits myDelta = theHelper.getAccountDeltaUnits();</span>

        /* Adjust the Security Units */
<span class="nc" id="L772">        final MoneyWiseAnalysisSecurityBucket myAsset = thePortfolioBuckets.getBucket(pHolding);</span>
<span class="nc" id="L773">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myDelta);</span>

        /* Register the transaction */
<span class="nc" id="L776">        myAsset.registerTransaction(theHelper);</span>

        /* StockSplit/Adjust is a transfer, so no need to update the categories */
<span class="nc" id="L779">    }</span>

    /**
     * Process a transaction that is a transfer into capital (also StockRightTaken).
     * &lt;p&gt;
     * This capital event relates only to the Credit Account.
     * @param pDebit the debit account
     * @param pCredit the credit security holding
     */
    private void processTransferIn(final MoneyWiseAssetBase pDebit,
                                   final MoneyWiseSecurityHolding pCredit) {
        /* Access debit account and category */
<span class="nc" id="L791">        final MoneyWiseTransCategory myCat = theHelper.getCategory();</span>

        /* Adjust the credit transfer details */
<span class="nc" id="L794">        processCreditXferIn(pCredit);</span>

        /* Adjust the tax payments */
<span class="nc" id="L797">        theTaxMan.adjustForTaxPayments(theHelper);</span>

        /* Determine the type of the debit account */
<span class="nc bnc" id="L800" title="All 2 branches missed.">        switch (pDebit.getAssetType()) {</span>
            case PAYEE:
<span class="nc" id="L802">                final MoneyWiseAnalysisPayeeBucket myPayee = thePayeeBuckets.getBucket(pDebit);</span>
<span class="nc" id="L803">                myPayee.adjustForDebit(theHelper);</span>
<span class="nc" id="L804">                break;</span>
            default:
<span class="nc" id="L806">                final MoneyWiseAnalysisAccountBucket&lt;?&gt; myAccount = getAccountBucket(pDebit);</span>
<span class="nc" id="L807">                myAccount.adjustForDebit(theHelper);</span>
                break;
        }

        /* If the event category is not a transfer */
<span class="nc bnc" id="L812" title="All 2 branches missed.">        if (!myCat.isTransfer()) {</span>
            /* Adjust the relevant category buckets */
<span class="nc" id="L814">            theCategoryBuckets.adjustCategories(theHelper, myCat);</span>
        }
<span class="nc" id="L816">    }</span>

    /**
     * Process the credit side of a transfer in transaction.
     * @param pHolding the credit holding
     */
    private void processCreditXferIn(final MoneyWiseSecurityHolding pHolding) {
        /* Transfer is to the credit account and may or may not have a change to the units */
<span class="nc" id="L824">        OceanusMoney myAmount = theHelper.getCreditAmount();</span>
<span class="nc" id="L825">        final OceanusRatio myExchangeRate = theHelper.getCreditExchangeRate();</span>
<span class="nc" id="L826">        final MoneyWiseSecurity mySecurity = pHolding.getSecurity();</span>

        /* Access the Asset Security Bucket */
<span class="nc" id="L829">        final MoneyWiseAnalysisSecurityBucket myAsset = thePortfolioBuckets.getBucket(pHolding);</span>
<span class="nc" id="L830">        final boolean isForeign = myAsset.isForeignCurrency();</span>

        /* If this is a foreign currency asset */
<span class="nc bnc" id="L833" title="All 2 branches missed.">        if (isForeign) {</span>
            /* Adjust foreign invested amount */
<span class="nc" id="L835">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myAmount);</span>

            /* Switch to local amount */
<span class="nc" id="L838">            myAmount = theHelper.getLocalAmount();</span>
        }

        /* Adjust the cost and investment */
<span class="nc" id="L842">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myAmount);</span>
<span class="nc" id="L843">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myAmount);</span>

        /* Determine the delta units */
<span class="nc" id="L846">        final MoneyWiseSecurityClass mySecClass = mySecurity.getCategoryClass();</span>
<span class="nc" id="L847">        OceanusUnits myDeltaUnits = theHelper.getCreditUnits();</span>
<span class="nc" id="L848">        OceanusUnits myUnits = myAsset.getValues().getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc bnc" id="L849" title="All 4 branches missed.">        if (mySecClass.isAutoUnits() &amp;&amp; myUnits.isZero()) {</span>
<span class="nc" id="L850">            myDeltaUnits = OceanusUnits.getWholeUnits(mySecClass.getAutoUnits());</span>
        }

        /* If we have new units */
<span class="nc bnc" id="L854" title="All 2 branches missed.">        if (myDeltaUnits != null) {</span>
            /* Record change in units */
<span class="nc" id="L856">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myDeltaUnits);</span>
        }

        /* Adjust for National Insurance */
<span class="nc" id="L860">        myAsset.adjustForNIPayments(theHelper);</span>

        /* Get the appropriate price for the account */
<span class="nc" id="L863">        final OceanusPrice myPrice = thePriceMap.getPriceForDate(mySecurity, theHelper.getDate());</span>

        /* Determine value of this stock after the transaction */
<span class="nc" id="L866">        myUnits = myAsset.getValues().getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L867">        OceanusMoney myValue = myUnits.valueAtPrice(myPrice);</span>

        /* If we are foreign */
<span class="nc bnc" id="L870" title="All 2 branches missed.">        if (isForeign) {</span>
            /* Determine local value */
<span class="nc" id="L872">            myValue = myValue.convertCurrency(theAnalysis.getCurrency().getCurrency(), myExchangeRate);</span>
        }

        /* Register the transaction */
<span class="nc" id="L876">        final MoneyWiseAnalysisSecurityValues myValues = myAsset.registerTransaction(theHelper);</span>
<span class="nc" id="L877">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myPrice);</span>
<span class="nc" id="L878">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.VALUATION, myValue);</span>
<span class="nc" id="L879">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.CASHINVESTED, myAmount);</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">        if (isForeign) {</span>
<span class="nc" id="L881">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myExchangeRate);</span>
        }
<span class="nc" id="L883">    }</span>

    /**
     * Process a dividend transaction.
     * &lt;p&gt;
     * This capital event relates to the only to Debit account, although the Credit account may be
     * identical to the credit account in which case the dividend is re-invested
     * @param pHolding the debit security holding
     * @param pCredit the credit account
     */
    private void processDividend(final MoneyWiseSecurityHolding pHolding,
                                 final MoneyWiseTransAsset pCredit) {
        /* The main security that we are interested in is the debit account */
<span class="nc" id="L896">        final MoneyWisePortfolio myPortfolio = pHolding.getPortfolio();</span>
<span class="nc" id="L897">        final MoneyWiseSecurity mySecurity = pHolding.getSecurity();</span>
<span class="nc" id="L898">        OceanusMoney myAmount = theHelper.getDebitAmount();</span>
<span class="nc" id="L899">        final OceanusMoney myTaxCredit = theHelper.getTaxCredit();</span>
<span class="nc" id="L900">        final OceanusUnits myDeltaUnits = theHelper.getAccountDeltaUnits();</span>
<span class="nc" id="L901">        final MoneyWiseTaxCredit myYear = theHelper.getTransaction().getTaxYear();</span>

        /* Obtain detailed category */
<span class="nc" id="L904">        MoneyWiseTransCategory myCat = myPortfolio.getDetailedCategory(theHelper.getCategory(), myYear);</span>
<span class="nc" id="L905">        myCat = mySecurity.getDetailedCategory(myCat, myYear);</span>

        /* True debit account is the parent */
<span class="nc" id="L908">        final MoneyWiseAssetBase myDebit = mySecurity.getParent();</span>

        /* Adjust the debit payee bucket */
<span class="nc" id="L911">        final MoneyWiseAnalysisPayeeBucket myPayee = thePayeeBuckets.getBucket(myDebit);</span>
<span class="nc" id="L912">        myPayee.adjustForDebit(theHelper);</span>

        /* Access the Asset Account Bucket */
<span class="nc" id="L915">        final MoneyWiseAnalysisSecurityBucket myAsset = thePortfolioBuckets.getBucket(pHolding);</span>
<span class="nc" id="L916">        final boolean isForeign = myAsset.isForeignCurrency();</span>
<span class="nc" id="L917">        final boolean isReInvest = pCredit instanceof MoneyWiseSecurityHolding;</span>

        /* If this is a foreign dividend */
<span class="nc bnc" id="L920" title="All 2 branches missed.">        if (isForeign) {</span>
            /* If this is a reInvestment */
<span class="nc bnc" id="L922" title="All 2 branches missed.">            if (isReInvest) {</span>
                /* Adjust counters */
<span class="nc" id="L924">                myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myAmount);</span>
<span class="nc" id="L925">                myAsset.getValues().setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, theHelper.getCreditExchangeRate());</span>
            }

            /* Switch to local amount */
<span class="nc" id="L929">            myAmount = theHelper.getLocalAmount();</span>
        }

        /* If this is a re-investment */
<span class="nc bnc" id="L933" title="All 2 branches missed.">        if (isReInvest) {</span>
            /* This amount is added to the cost, so record as the delta cost */
<span class="nc" id="L935">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myAmount);</span>

            /* Record the investment */
<span class="nc" id="L938">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myAmount);</span>

            /* If we have new units */
<span class="nc bnc" id="L941" title="All 2 branches missed.">            if (myDeltaUnits != null) {</span>
                /* Record delta units */
<span class="nc" id="L943">                myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myDeltaUnits);</span>
            }

            /* If we have a tax credit */
<span class="nc bnc" id="L947" title="All 2 branches missed.">            if (myTaxCredit != null) {</span>
                /* The Tax Credit is viewed as a received dividend from the account */
<span class="nc" id="L949">                myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.DIVIDEND, myTaxCredit);</span>
            }

            /* else we are paying out to another account */
        } else {
            /* Adjust the dividend total for this asset */
<span class="nc" id="L955">            final OceanusMoney myAdjust = new OceanusMoney(myAmount);</span>

            /* Any tax credit is viewed as a realised dividend from the account */
<span class="nc bnc" id="L958" title="All 2 branches missed.">            if (myTaxCredit != null) {</span>
<span class="nc" id="L959">                myAdjust.addAmount(myTaxCredit);</span>
            }

            /* The Dividend is viewed as a dividend from the account */
<span class="nc" id="L963">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.DIVIDEND, myAdjust);</span>

            /* Adjust the credit account bucket */
<span class="nc" id="L966">            final MoneyWiseAnalysisAccountBucket&lt;?&gt; myBucket = getAccountBucket((MoneyWiseAssetBase) pCredit);</span>
<span class="nc" id="L967">            myBucket.adjustForCredit(theHelper);</span>
        }

        /* Register the transaction */
<span class="nc" id="L971">        myAsset.registerTransaction(theHelper);</span>

        /* Adjust the tax payments */
<span class="nc" id="L974">        theTaxMan.adjustForTaxPayments(theHelper);</span>

        /* Adjust the relevant category buckets */
<span class="nc" id="L977">        theCategoryBuckets.adjustCategories(theHelper, myCat);</span>
<span class="nc" id="L978">    }</span>

    /**
     * Process a transaction that is a transfer from capital.
     * &lt;p&gt;
     * This capital event relates only to the Debit Account
     * @param pHolding the debit holding
     * @param pCredit the credit account
     */
    private void processTransferOut(final MoneyWiseSecurityHolding pHolding,
                                    final MoneyWiseAssetBase pCredit) {
        /* Access credit account and category */
<span class="nc" id="L990">        final MoneyWiseTransCategory myCat = theHelper.getCategory();</span>

        /* Adjust the debit transfer details */
<span class="nc" id="L993">        processDebitXferOut(pHolding);</span>

        /* Adjust the credit account bucket */
<span class="nc" id="L996">        final MoneyWiseAnalysisAccountBucket&lt;?&gt; myBucket = getAccountBucket(pCredit);</span>
<span class="nc" id="L997">        myBucket.adjustForCredit(theHelper);</span>

        /* If the event category is not a transfer */
<span class="nc bnc" id="L1000" title="All 2 branches missed.">        if (!myCat.isTransfer()) {</span>
            /* Adjust the relevant category buckets */
<span class="nc" id="L1002">            theCategoryBuckets.adjustCategories(theHelper, myCat);</span>
        }
<span class="nc" id="L1004">    }</span>

    /**
     * Process the debit side of a transfer out transaction.
     * &lt;p&gt;
     * This capital event relates only to the Debit Account
     * @param pHolding the debit holding
     */
    private void processDebitXferOut(final MoneyWiseSecurityHolding pHolding) {
        /* Transfer out is from the debit account and may or may not have units */
<span class="nc" id="L1014">        final MoneyWiseSecurity myDebit = pHolding.getSecurity();</span>
<span class="nc" id="L1015">        OceanusMoney myAmount = theHelper.getDebitAmount();</span>
<span class="nc" id="L1016">        boolean isLargeCash = false;</span>

        /* Access the Asset Security Bucket */
<span class="nc" id="L1019">        final MoneyWiseAnalysisSecurityBucket myAsset = thePortfolioBuckets.getBucket(pHolding);</span>
<span class="nc" id="L1020">        MoneyWiseAnalysisSecurityValues myValues = myAsset.getValues();</span>
<span class="nc" id="L1021">        final OceanusRatio myXchangeRate = theHelper.getDebitExchangeRate();</span>
<span class="nc" id="L1022">        final boolean isForeign = myAsset.isForeignCurrency();</span>

        /* If this is a foreign currency asset */
<span class="nc bnc" id="L1025" title="All 2 branches missed.">        if (isForeign) {</span>
            /* Adjust foreign invested amount */
<span class="nc" id="L1027">            final OceanusMoney myDelta = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1028">            myDelta.negate();</span>
<span class="nc" id="L1029">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myDelta);</span>

            /* Switch to local amount */
<span class="nc" id="L1032">            myAmount = theHelper.getLocalAmount();</span>
        }

        /* Record the delta investment */
<span class="nc" id="L1036">        final OceanusMoney myDelta = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1037">        myDelta.negate();</span>
<span class="nc" id="L1038">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myDelta);</span>

        /* Get the appropriate price for the account */
<span class="nc" id="L1041">        final OceanusPrice myPrice = thePriceMap.getPriceForDate(myDebit, theHelper.getDate());</span>

        /* Assume that the allowed cost is the full value */
<span class="nc" id="L1044">        OceanusUnits myUnits = Objects.requireNonNull(myValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS));</span>
<span class="nc" id="L1045">        OceanusMoney myAllowedCost = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1046">        final OceanusMoney myCost = myValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L1047">        OceanusRatio myCostDilution = null;</span>
<span class="nc" id="L1048">        OceanusMoney myConsideration = null;</span>

        /* Determine the delta units */
<span class="nc bnc" id="L1051" title="All 2 branches missed.">        OceanusUnits myDeltaUnits = theHelper.getCategoryClass().isSecurityClosure()</span>
<span class="nc" id="L1052">                ? myUnits</span>
<span class="nc" id="L1053">                : theHelper.getDebitUnits();</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">        final boolean isCapitalDistribution = myDeltaUnits == null;</span>

        /* If this is not a capital distribution */
<span class="nc bnc" id="L1057" title="All 2 branches missed.">        if (!isCapitalDistribution) {</span>
            /* The allowed cost is the relevant fraction of the cost */
<span class="nc" id="L1059">            myAllowedCost = myCost.valueAtWeight(myDeltaUnits, myUnits);</span>

            /* Access units as negative value */
<span class="nc" id="L1062">            myDeltaUnits = new OceanusUnits(myDeltaUnits);</span>
<span class="nc" id="L1063">            myDeltaUnits.negate();</span>

            /* Record delta to units */
<span class="nc" id="L1066">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myDeltaUnits);</span>
<span class="nc" id="L1067">            final OceanusUnits myNewUnits = myValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>

            /* Determine the cost dilution */
<span class="nc" id="L1070">            myCostDilution = new OceanusRatio(myNewUnits, myUnits);</span>
<span class="nc" id="L1071">            myUnits = myNewUnits;</span>
        }

        /* Determine value of this stock after the transaction */
<span class="nc" id="L1075">        OceanusMoney myValue = myUnits.valueAtPrice(myPrice);</span>

        /* If we are foreign */
<span class="nc bnc" id="L1078" title="All 2 branches missed.">        if (isForeign) {</span>
            /* Determine local value */
<span class="nc" id="L1080">            myValue = myValue.convertCurrency(theAnalysis.getCurrency().getCurrency(), myXchangeRate);</span>
        }

        /* If we are performing a capital distribution */
<span class="nc bnc" id="L1084" title="All 2 branches missed.">        if (isCapitalDistribution) {</span>
            /* Determine condition as to whether this is a large cash transaction */
<span class="nc" id="L1086">            final OceanusMoney myPortion = myValue.valueAtRate(LIMIT_RATE);</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">            isLargeCash = (myAmount.compareTo(LIMIT_VALUE) &gt; 0)</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">                    &amp;&amp; (myAmount.compareTo(myPortion) &gt; 0);</span>

            /* If this is large cash */
<span class="nc bnc" id="L1091" title="All 2 branches missed.">            if (isLargeCash) {</span>
                /* Determine the total value of rights plus share value */
<span class="nc" id="L1093">                myConsideration = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1094">                myConsideration.addAmount(myValue);</span>

                /* Determine the allowedCost as a proportion of the total value */
<span class="nc" id="L1097">                myAllowedCost = myCost.valueAtWeight(myAmount, myConsideration);</span>

                /* Determine the cost dilution */
<span class="nc" id="L1100">                myCostDilution = new OceanusRatio(myValue, myConsideration);</span>

                /* else this is viewed as small and is taken out of the cost */
            } else {
                /* Set the allowed cost to be the least of the cost or the returned cash */
<span class="nc bnc" id="L1105" title="All 2 branches missed.">                myAllowedCost = myAmount.compareTo(myCost) &gt; 0</span>
<span class="nc" id="L1106">                        ? new OceanusMoney(myCost)</span>
<span class="nc" id="L1107">                        : new OceanusMoney(myAmount);</span>
            }
        }

        /* Determine the delta to the cost */
<span class="nc" id="L1112">        final OceanusMoney myDeltaCost = new OceanusMoney(myAllowedCost);</span>
<span class="nc" id="L1113">        myDeltaCost.negate();</span>

        /* If we have a delta to the cost */
<span class="nc bnc" id="L1116" title="All 2 branches missed.">        if (myDeltaCost.isNonZero()) {</span>
            /* Adjust the cost */
<span class="nc" id="L1118">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myDeltaCost);</span>
        }

        /* Determine the capital gain */
<span class="nc" id="L1122">        final OceanusMoney myCapitalGain = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1123">        myCapitalGain.addAmount(myDeltaCost);</span>

        /* If we have a delta to the gains */
<span class="nc bnc" id="L1126" title="All 2 branches missed.">        if (myCapitalGain.isNonZero()) {</span>
            /* Adjust the gains */
<span class="nc" id="L1128">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myCapitalGain);</span>

            /* Adjust the capitalGains category bucket */
<span class="nc" id="L1131">            theCategoryBuckets.adjustStandardGain(theHelper, pHolding, myCapitalGain);</span>
        }

        /* Register the transaction */
<span class="nc" id="L1135">        myValues = myAsset.registerTransaction(theHelper);</span>

        /* record details */
<span class="nc" id="L1138">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myPrice);</span>
<span class="nc" id="L1139">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.VALUATION, myValue);</span>
<span class="nc" id="L1140">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH, myAmount);</span>
<span class="nc" id="L1141">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost);</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">        if (myCostDilution != null) {</span>
<span class="nc" id="L1143">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution);</span>
        }
<span class="nc bnc" id="L1145" title="All 2 branches missed.">        if (myConsideration != null) {</span>
<span class="nc" id="L1146">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.CONSIDERATION, myConsideration);</span>
        }
<span class="nc bnc" id="L1148" title="All 2 branches missed.">        if (myCapitalGain.isNonZero()) {</span>
<span class="nc" id="L1149">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN, myCapitalGain);</span>
        }
<span class="nc bnc" id="L1151" title="All 2 branches missed.">        if (isForeign) {</span>
<span class="nc" id="L1152">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myXchangeRate);</span>
        }
<span class="nc bnc" id="L1154" title="All 2 branches missed.">        if (isCapitalDistribution) {</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, isLargeCash</span>
<span class="nc" id="L1156">                    ? MoneyWiseCashType.LARGECASH</span>
<span class="nc" id="L1157">                    : MoneyWiseCashType.SMALLCASH);</span>
        }
<span class="nc" id="L1159">    }</span>

    /**
     * Process a transaction that is a exchange between two capital accounts.
     * &lt;p&gt;
     * This represent a transfer out from the debit account and a transfer in to the credit account
     * @param pDebit the debit holding
     * @param pCredit the credit holding
     */
    private void processStockXchange(final MoneyWiseSecurityHolding pDebit,
                                     final MoneyWiseSecurityHolding pCredit) {
        /* Adjust the debit transfer details */
<span class="nc" id="L1171">        processDebitXferOut(pDebit);</span>

        /* Adjust the credit transfer details */
<span class="nc" id="L1174">        processCreditXferIn(pCredit);</span>
<span class="nc" id="L1175">    }</span>

    /**
     * Process a transaction that is a chargeable gain.
     * &lt;p&gt;
     * This capital event relates only to the Debit Asset
     * @param pHolding the debit security holding
     * @param pCredit the credit account
     */
    private void processChargeableGain(final MoneyWiseSecurityHolding pHolding,
                                       final MoneyWiseAssetBase pCredit) {
        /* Chargeable Gain is from the debit account and may or may not have units */
<span class="nc" id="L1187">        final MoneyWiseSecurity myDebit = pHolding.getSecurity();</span>
<span class="nc" id="L1188">        OceanusMoney myAmount = theHelper.getDebitAmount();</span>
<span class="nc" id="L1189">        OceanusUnits myDeltaUnits = theHelper.getDebitUnits();</span>

        /* Access the Asset Security Bucket */
<span class="nc" id="L1192">        final MoneyWiseAnalysisSecurityBucket myAsset = thePortfolioBuckets.getBucket(pHolding);</span>
<span class="nc" id="L1193">        final MoneyWiseAnalysisSecurityValues myValues = myAsset.getValues();</span>

        /* If this is a foreign currency asset */
<span class="nc bnc" id="L1196" title="All 2 branches missed.">        if (Boolean.TRUE.equals(myAsset.isForeignCurrency())) {</span>
            /* Adjust foreign invested amount */
<span class="nc" id="L1198">            final OceanusMoney myDelta = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1199">            myDelta.negate();</span>
<span class="nc" id="L1200">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, theHelper.getDebitExchangeRate());</span>
<span class="nc" id="L1201">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myDelta);</span>

            /* Switch to local amount */
<span class="nc" id="L1204">            myAmount = theHelper.getLocalAmount();</span>
        }

        /* Record the delta investment */
<span class="nc" id="L1208">        final OceanusMoney myDelta = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1209">        myDelta.negate();</span>
<span class="nc" id="L1210">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myDelta);</span>

        /* Assume the cost reduction is the full value */
<span class="nc" id="L1213">        OceanusMoney myReduction = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1214">        final OceanusMoney myCost = myValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>

        /* If we are reducing units in the account */
<span class="nc bnc" id="L1217" title="All 2 branches missed.">        if (myDeltaUnits != null) {</span>
            /* The reduction is the relevant fraction of the cost */
<span class="nc" id="L1219">            final OceanusUnits myUnits = myValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L1220">            myReduction = myCost.valueAtWeight(myDeltaUnits, myUnits);</span>

            /* Access units as negative value */
<span class="nc" id="L1223">            myDeltaUnits = new OceanusUnits(myDeltaUnits);</span>
<span class="nc" id="L1224">            myDeltaUnits.negate();</span>

            /* Record delta to units */
<span class="nc" id="L1227">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myDeltaUnits);</span>
        }

        /* If the reduction is greater than the total cost */
<span class="nc bnc" id="L1231" title="All 2 branches missed.">        if (myReduction.compareTo(myCost) &gt; 0) {</span>
            /* Reduction is the total cost */
<span class="nc" id="L1233">            myReduction = new OceanusMoney(myCost);</span>
        }

        /* Determine the delta to the cost */
<span class="nc" id="L1237">        final OceanusMoney myDeltaCost = new OceanusMoney(myReduction);</span>
<span class="nc" id="L1238">        myDeltaCost.negate();</span>

        /* If we have a delta to the cost */
<span class="nc bnc" id="L1241" title="All 2 branches missed.">        if (myDeltaCost.isNonZero()) {</span>
            /* Adjust the cost */
<span class="nc" id="L1243">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myDeltaCost);</span>
        }

        /* Determine the delta to the gains */
<span class="nc" id="L1247">        final OceanusMoney myDeltaGains = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1248">        myDeltaGains.addAmount(myDeltaCost);</span>

        /* If we have a delta to the gains */
<span class="nc bnc" id="L1251" title="All 2 branches missed.">        if (myDeltaGains.isNonZero()) {</span>
            /* Adjust the gains */
<span class="nc" id="L1253">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myDeltaGains);</span>
        }

        /* Register the event */
<span class="nc" id="L1257">        myAsset.registerTransaction(theHelper);</span>

        /* True debit account is the parent */
<span class="nc" id="L1260">        final MoneyWiseAssetBase myParent = myDebit.getParent();</span>

        /* Adjust the debit account bucket */
<span class="nc" id="L1263">        final MoneyWiseAnalysisPayeeBucket myPayee = thePayeeBuckets.getBucket(myParent);</span>
<span class="nc" id="L1264">        myPayee.adjustForTaxCredit(theHelper);</span>

        /* Adjust the credit account bucket */
<span class="nc" id="L1267">        final MoneyWiseAnalysisAccountBucket&lt;?&gt; myBucket = getAccountBucket(pCredit);</span>
<span class="nc" id="L1268">        myBucket.adjustForCredit(theHelper);</span>

        /* Adjust the chargeableGains category bucket */
<span class="nc" id="L1271">        theCategoryBuckets.adjustChargeableGain(theHelper, myReduction);</span>

        /* Adjust the TaxMan account for the tax credit */
<span class="nc" id="L1274">        theTaxMan.adjustForTaxPayments(theHelper);</span>

        /* Add the chargeable event */
<span class="nc" id="L1277">        theTaxBasisBuckets.recordChargeableGain(theHelper.getTransaction(), myDeltaGains);</span>
<span class="nc" id="L1278">    }</span>

    /**
     * Process a transaction that is Stock DeMerger.
     * &lt;p&gt;
     * This capital event relates to both the Credit and Debit accounts
     * @param pDebit the debit account
     * @param pCredit the credit account
     */
    private void processStockDeMerger(final MoneyWiseSecurityHolding pDebit,
                                      final MoneyWiseSecurityHolding pCredit) {
        /* Access the Debit Asset Security Bucket */
<span class="nc" id="L1290">        MoneyWiseAnalysisSecurityBucket myAsset = thePortfolioBuckets.getBucket(pDebit);</span>
<span class="nc" id="L1291">        MoneyWiseAnalysisSecurityValues myValues = myAsset.getValues();</span>
<span class="nc" id="L1292">        final OceanusRatio myDebitRate = theHelper.getDebitExchangeRate();</span>

        /* Obtain current cost */
<span class="nc" id="L1295">        final OceanusMoney myCost = myValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L1296">        final OceanusRatio myDilution = theHelper.getDilution();</span>
<span class="nc" id="L1297">        final OceanusUnits myDeltaUnits = theHelper.getAccountDeltaUnits();</span>

        /* If we reduced the units */
<span class="nc bnc" id="L1300" title="All 2 branches missed.">        if (myDeltaUnits != null) {</span>
            /* Record the delta units */
<span class="nc" id="L1302">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myDeltaUnits);</span>
        }

        /* Calculate the cost dilution */
<span class="nc" id="L1306">        final OceanusMoney myNewCost = myCost.getDilutedMoney(myDilution);</span>
<span class="nc" id="L1307">        final OceanusRatio myCostDilution = new OceanusRatio(myNewCost, myCost);</span>

        /* Calculate the delta to the cost */
<span class="nc" id="L1310">        OceanusMoney myDeltaCost = new OceanusMoney(myNewCost);</span>
<span class="nc" id="L1311">        myDeltaCost.subtractAmount(myCost);</span>

        /* Record the delta cost/investment */
<span class="nc" id="L1314">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myDeltaCost);</span>
<span class="nc" id="L1315">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myDeltaCost);</span>
<span class="nc" id="L1316">        final boolean isForeignDebit = myAsset.isForeignCurrency();</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">        if (isForeignDebit) {</span>
<span class="nc" id="L1318">            final OceanusMoney myInvested = myDeltaCost.convertCurrency(myAsset.getCurrency().getCurrency(), myDebitRate);</span>
<span class="nc" id="L1319">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myInvested);</span>
        }

        /* Register the event */
<span class="nc" id="L1323">        myValues = myAsset.registerTransaction(theHelper);</span>

        /* Access the Credit Asset Account Bucket */
<span class="nc" id="L1326">        myAsset = thePortfolioBuckets.getBucket(pCredit);</span>

        /* The deltaCost is transferred to the credit account */
<span class="nc" id="L1329">        myDeltaCost = new OceanusMoney(myDeltaCost);</span>
<span class="nc" id="L1330">        myDeltaCost.negate();</span>

        /* Record details */
<span class="nc" id="L1333">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myDeltaCost);</span>
<span class="nc" id="L1334">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution);</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">        if (isForeignDebit) {</span>
<span class="nc" id="L1336">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myDebitRate);</span>
        }

        /* Record the delta cost/investment */
<span class="nc" id="L1340">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myDeltaCost);</span>
<span class="nc" id="L1341">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myDeltaCost);</span>
<span class="nc" id="L1342">        final boolean isForeignCredit = myAsset.isForeignCurrency();</span>
<span class="nc" id="L1343">        final OceanusRatio myCreditRate = theHelper.getCreditExchangeRate();</span>
<span class="nc bnc" id="L1344" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1345">            final OceanusMoney myInvested = myDeltaCost.convertCurrency(myAsset.getCurrency().getCurrency(), myCreditRate);</span>
<span class="nc" id="L1346">            myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myInvested);</span>
        }

        /* Get the appropriate prices/rates for the stock */
<span class="nc" id="L1350">        final OceanusDate myDate = theHelper.getDate();</span>
<span class="nc" id="L1351">        final OceanusPrice myCreditPrice = thePriceMap.getPriceForDate(myAsset.getSecurity(), myDate);</span>
<span class="nc" id="L1352">        final Currency myCurrency = theAnalysis.getCurrency().getCurrency();</span>

        /* Determine value of the stock being deMerged */
<span class="nc" id="L1355">        final OceanusUnits myCreditUnits = theHelper.getPartnerDeltaUnits();</span>
<span class="nc" id="L1356">        OceanusMoney myCreditXferValue = myCreditUnits.valueAtPrice(myCreditPrice);</span>
<span class="nc bnc" id="L1357" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1358">            myCreditXferValue = myCreditXferValue.convertCurrency(myCurrency, myCreditRate);</span>
        }

        /* Record the current/delta units */
<span class="nc" id="L1362">        myAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myCreditUnits);</span>

        /* Register the transaction */
<span class="nc" id="L1365">        myValues = myAsset.registerTransaction(theHelper);</span>

        /* Record values */
<span class="nc" id="L1368">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myDeltaCost);</span>
<span class="nc" id="L1369">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myCreditPrice);</span>
<span class="nc" id="L1370">        myValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myCreditXferValue);</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1372">            myValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myCreditRate);</span>
        }

        /* StockDeMerger is a transfer, so no need to update the categories */
<span class="nc" id="L1376">    }</span>

    /**
     * Process a transaction that is StockTakeover.
     * &lt;p&gt;
     * This can be accomplished using a cash portion (to a ThirdParty account) and these workings
     * are split out.
     * @param pDebit the debit holding
     * @param pCredit the credit holding
     */
    private void processStockTakeover(final MoneyWiseSecurityHolding pDebit,
                                      final MoneyWiseSecurityHolding pCredit) {
<span class="nc" id="L1388">        final OceanusMoney myAmount = theHelper.getReturnedCash();</span>
<span class="nc" id="L1389">        final MoneyWiseTransAsset myReturnedCashAct = theHelper.getReturnedCashAccount();</span>

        /* If we have a returned cash part of the transaction */
<span class="nc bnc" id="L1392" title="All 2 branches missed.">        if (myReturnedCashAct != null</span>
<span class="nc bnc" id="L1393" title="All 2 branches missed.">                &amp;&amp; myAmount.isNonZero()) {</span>
            /* Process a Stock And Cash TakeOver */
<span class="nc" id="L1395">            processStockAndCashTakeOver(pDebit, pCredit);</span>
        } else {
            /* Process a StockOnly TakeOver */
<span class="nc" id="L1398">            processStockOnlyTakeOver(pDebit, pCredit);</span>
        }
<span class="nc" id="L1400">    }</span>

    /**
     * Process a transaction that is a StockOnlyTakeover.
     * &lt;p&gt;
     * This capital event relates to both the Credit and Debit accounts
     * @param pDebit the debit holding
     * @param pCredit the credit holding
     */
    private void processStockOnlyTakeOver(final MoneyWiseSecurityHolding pDebit,
                                          final MoneyWiseSecurityHolding pCredit) {
        /* Access details */
<span class="nc" id="L1412">        final MoneyWiseSecurity myCredit = pCredit.getSecurity();</span>
<span class="nc" id="L1413">        final MoneyWiseSecurity myDebit = pDebit.getSecurity();</span>

        /* Access the Asset Security Buckets */
<span class="nc" id="L1416">        final MoneyWiseAnalysisSecurityBucket myDebitAsset = thePortfolioBuckets.getBucket(pDebit);</span>
<span class="nc" id="L1417">        MoneyWiseAnalysisSecurityValues myDebitValues = myDebitAsset.getValues();</span>
<span class="nc" id="L1418">        final MoneyWiseAnalysisSecurityBucket myCreditAsset = thePortfolioBuckets.getBucket(pCredit);</span>
<span class="nc" id="L1419">        final OceanusDate myDate = theHelper.getDate();</span>

        /* Get the appropriate prices/rates for the stock */
<span class="nc" id="L1422">        final OceanusPrice myCreditPrice = thePriceMap.getPriceForDate(myCredit, myDate);</span>
<span class="nc" id="L1423">        final OceanusPrice myDebitPrice = thePriceMap.getPriceForDate(myDebit, myDate);</span>
<span class="nc" id="L1424">        final OceanusRatio myDebitRate = theHelper.getDebitExchangeRate();</span>
<span class="nc" id="L1425">        final OceanusRatio myCreditRate = theHelper.getCreditExchangeRate();</span>
<span class="nc" id="L1426">        final Currency myCurrency = theAnalysis.getCurrency().getCurrency();</span>

        /* Determine value of the stock in both parts of the takeOver */
<span class="nc" id="L1429">        OceanusUnits myCreditUnits = theHelper.getPartnerDeltaUnits();</span>
<span class="nc" id="L1430">        OceanusMoney myCreditXferValue = myCreditUnits.valueAtPrice(myCreditPrice);</span>
<span class="nc" id="L1431">        OceanusUnits myDebitUnits = myDebitValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L1432">        OceanusMoney myDebitValue = myDebitUnits.valueAtPrice(myDebitPrice);</span>
<span class="nc" id="L1433">        OceanusMoney myInvested = myDebitValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.INVESTED);</span>

        /* Handle foreign debit */
<span class="nc" id="L1436">        final boolean isForeignDebit = myDebitAsset.isForeignCurrency();</span>
<span class="nc bnc" id="L1437" title="All 2 branches missed.">        if (isForeignDebit) {</span>
<span class="nc" id="L1438">            myDebitValue = myDebitValue.convertCurrency(myCurrency, myDebitRate);</span>
        }

        /* Handle foreign credit */
<span class="nc" id="L1442">        final boolean isForeignCredit = myCreditAsset.isForeignCurrency();</span>
<span class="nc bnc" id="L1443" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1444">            myCreditXferValue = myCreditXferValue.convertCurrency(myCurrency, myCreditRate);</span>
        }

        /* Determine the residual cost of the old stock */
<span class="nc" id="L1448">        final OceanusMoney myDebitCost = myDebitValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>

        /* Allocate current profit between the two stocks */
<span class="nc" id="L1451">        OceanusMoney myProfit = new OceanusMoney(myDebitValue);</span>
<span class="nc" id="L1452">        myProfit.subtractAmount(myDebitCost);</span>
<span class="nc" id="L1453">        myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.GROWTHADJUST, myProfit);</span>
<span class="nc" id="L1454">        myProfit = new OceanusMoney(myProfit);</span>
<span class="nc" id="L1455">        myProfit.negate();</span>
<span class="nc" id="L1456">        myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.GROWTHADJUST, myProfit);</span>

        /* Adjust cost/units/invested of the credit account */
<span class="nc" id="L1459">        myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myDebitCost);</span>
<span class="nc" id="L1460">        myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myCreditUnits);</span>
<span class="nc" id="L1461">        myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myInvested);</span>
<span class="nc bnc" id="L1462" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1463">            final OceanusMoney myForeign = myInvested.convertCurrency(myCreditAsset.getCurrency().getCurrency(), myCreditRate);</span>
<span class="nc" id="L1464">            myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myForeign);</span>
        }

        /* Determine final value of the credit stock after the takeOver */
<span class="nc" id="L1468">        myCreditUnits = myCreditAsset.getValues().getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L1469">        OceanusMoney myCreditValue = myCreditUnits.valueAtPrice(myCreditPrice);</span>
<span class="nc bnc" id="L1470" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1471">            myCreditValue = myCreditValue.convertCurrency(myCurrency, myCreditRate);</span>
        }

        /* Register the transaction */
<span class="nc" id="L1475">        final MoneyWiseAnalysisSecurityValues myCreditValues = myCreditAsset.registerTransaction(theHelper);</span>
<span class="nc" id="L1476">        myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myCreditPrice);</span>
<span class="nc" id="L1477">        myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myCreditXferValue);</span>
<span class="nc" id="L1478">        myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myDebitCost);</span>
<span class="nc" id="L1479">        myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.VALUATION, myCreditValue);</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1481">            myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myCreditRate);</span>
        }

        /* Drive debit cost down to zero */
<span class="nc" id="L1485">        final OceanusMoney myDeltaCost = new OceanusMoney(myDebitCost);</span>
<span class="nc" id="L1486">        myDeltaCost.negate();</span>
<span class="nc" id="L1487">        myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myDeltaCost);</span>
<span class="nc" id="L1488">        myDeltaCost.negate();</span>

        /* Drive debit units down to zero */
<span class="nc" id="L1491">        myDebitUnits = new OceanusUnits(myDebitUnits);</span>
<span class="nc" id="L1492">        myDebitUnits.negate();</span>
<span class="nc" id="L1493">        myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myDebitUnits);</span>

        /* Adjust debit Invested amount */
<span class="nc" id="L1496">        myInvested = new OceanusMoney(myInvested);</span>
<span class="nc" id="L1497">        myInvested.negate();</span>
<span class="nc" id="L1498">        myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myInvested);</span>
<span class="nc bnc" id="L1499" title="All 2 branches missed.">        if (isForeignDebit) {</span>
<span class="nc" id="L1500">            myInvested = new OceanusMoney(myDebitValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED));</span>
<span class="nc" id="L1501">            myInvested.negate();</span>
<span class="nc" id="L1502">            myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myInvested);</span>
        }

        /* Register the transaction */
<span class="nc" id="L1506">        myDebitValues = myDebitAsset.registerTransaction(theHelper);</span>
<span class="nc" id="L1507">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myDebitPrice);</span>
<span class="nc" id="L1508">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.VALUATION, myDebitValue);</span>
<span class="nc" id="L1509">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myCreditXferValue);</span>
<span class="nc" id="L1510">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myDeltaCost);</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">        if (isForeignDebit) {</span>
<span class="nc" id="L1512">            myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myDebitRate);</span>
        }
<span class="nc" id="L1514">    }</span>

    /**
     * Process a transaction that is StockAndCashTakeover.
     * &lt;p&gt;
     * This capital event relates to both the Credit and Debit accounts. In particular it makes
     * reference to the CashTakeOver aspect of the debit account
     * @param pDebit the debit holding
     * @param pCredit the credit holding
     */
    private void processStockAndCashTakeOver(final MoneyWiseSecurityHolding pDebit,
                                             final MoneyWiseSecurityHolding pCredit) {
        /* Access details */
<span class="nc" id="L1527">        final MoneyWiseSecurity myDebit = pDebit.getSecurity();</span>
<span class="nc" id="L1528">        final MoneyWiseSecurity myCredit = pCredit.getSecurity();</span>
<span class="nc" id="L1529">        final OceanusDate myDate = theHelper.getDate();</span>
<span class="nc" id="L1530">        final MoneyWiseTransAsset myReturnedCashAccount = theHelper.getReturnedCashAccount();</span>
<span class="nc" id="L1531">        final OceanusMoney myAmount = theHelper.getLocalReturnedCash();</span>

        /* Access the Asset Security Buckets */
<span class="nc" id="L1534">        final MoneyWiseAnalysisSecurityBucket myDebitAsset = thePortfolioBuckets.getBucket(pDebit);</span>
<span class="nc" id="L1535">        MoneyWiseAnalysisSecurityValues myDebitValues = myDebitAsset.getValues();</span>
<span class="nc" id="L1536">        final MoneyWiseAnalysisSecurityBucket myCreditAsset = thePortfolioBuckets.getBucket(pCredit);</span>

        /* Get the appropriate prices for the assets */
<span class="nc" id="L1539">        final OceanusPrice myDebitPrice = thePriceMap.getPriceForDate(myDebit, myDate);</span>
<span class="nc" id="L1540">        final OceanusPrice myCreditPrice = thePriceMap.getPriceForDate(myCredit, myDate);</span>
<span class="nc" id="L1541">        final OceanusRatio myDebitRate = theHelper.getDebitExchangeRate();</span>
<span class="nc" id="L1542">        final OceanusRatio myCreditRate = theHelper.getCreditExchangeRate();</span>
<span class="nc" id="L1543">        final Currency myCurrency = theAnalysis.getCurrency().getCurrency();</span>

        /* Determine value of the base stock */
<span class="nc" id="L1546">        OceanusUnits myDebitUnits = myDebitValues.getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L1547">        OceanusMoney myDebitValue = myDebitUnits.valueAtPrice(myDebitPrice);</span>

        /* Determine value of the stock part of the takeOver */
<span class="nc" id="L1550">        OceanusUnits myCreditUnits = theHelper.getPartnerDeltaUnits();</span>
<span class="nc" id="L1551">        OceanusMoney myCreditXferValue = myCreditUnits.valueAtPrice(myCreditPrice);</span>

        /* Handle foreign debit */
<span class="nc" id="L1554">        final boolean isForeignDebit = myDebitAsset.isForeignCurrency();</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">        if (isForeignDebit) {</span>
<span class="nc" id="L1556">            myDebitValue = myDebitValue.convertCurrency(myCurrency, myDebitRate);</span>
        }

        /* Handle foreign credit */
<span class="nc" id="L1560">        final boolean isForeignCredit = myCreditAsset.isForeignCurrency();</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1562">            myCreditXferValue = myCreditXferValue.convertCurrency(myCurrency, myCreditRate);</span>
        }

        /* Calculate the total consideration */
<span class="nc" id="L1566">        final OceanusMoney myConsideration = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1567">        myConsideration.addAmount(myCreditXferValue);</span>

        /* Access the current debit cost */
<span class="nc" id="L1570">        final OceanusMoney myCost = myDebitValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST);</span>
<span class="nc" id="L1571">        OceanusRatio myCostDilution = null;</span>
        final OceanusMoney myCostXfer;
        final OceanusMoney myAllowedCost;

        /* Determine condition as to whether this is a large cash transaction */
<span class="nc" id="L1576">        final OceanusMoney myPortion = myDebitValue.valueAtRate(LIMIT_RATE);</span>
<span class="nc bnc" id="L1577" title="All 2 branches missed.">        final boolean isLargeCash = (myAmount.compareTo(LIMIT_VALUE) &gt; 0)</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">                &amp;&amp; (myAmount.compareTo(myPortion) &gt; 0);</span>

        /* If this is a large cash takeOver */
<span class="nc bnc" id="L1581" title="All 2 branches missed.">        if (isLargeCash) {</span>
            /* Determine the transferable cost */
<span class="nc" id="L1583">            myCostXfer = myCost.valueAtWeight(myCreditXferValue, myConsideration);</span>

            /* Determine the cost dilution */
<span class="nc" id="L1586">            myCostDilution = new OceanusRatio(myAmount, myConsideration);</span>

            /* Determine the allowed cost */
<span class="nc" id="L1589">            myAllowedCost = new OceanusMoney(myCost);</span>
<span class="nc" id="L1590">            myAllowedCost.subtractAmount(myCostXfer);</span>

            /* else this is viewed as small and is taken out of the cost */
        } else {
            /* Set the allowed cost to be the least of the cost or the returned cash */
<span class="nc bnc" id="L1595" title="All 2 branches missed.">            myAllowedCost = myAmount.compareTo(myCost) &gt; 0</span>
<span class="nc" id="L1596">                    ? new OceanusMoney(myCost)</span>
<span class="nc" id="L1597">                    : new OceanusMoney(myAmount);</span>

            /* Transferred cost is cost minus the allowed cost */
<span class="nc" id="L1600">            myCostXfer = new OceanusMoney(myCost);</span>
<span class="nc" id="L1601">            myCostXfer.subtractAmount(myAllowedCost);</span>
        }

        /* Determine the capital gain */
<span class="nc" id="L1605">        final OceanusMoney myCapitalGain = new OceanusMoney(myAmount);</span>
<span class="nc" id="L1606">        myCapitalGain.subtractAmount(myAllowedCost);</span>
<span class="nc bnc" id="L1607" title="All 2 branches missed.">        if (myCapitalGain.isNonZero()) {</span>
            /* Record the delta gains */
<span class="nc" id="L1609">            myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.REALISEDGAINS, myCapitalGain);</span>

            /* Adjust the capitalGains category bucket */
<span class="nc" id="L1612">            theCategoryBuckets.adjustStandardGain(theHelper, pDebit, myCapitalGain);</span>
        }

        /* Allocate current profit between the two stocks */
<span class="nc" id="L1616">        OceanusMoney myProfit = new OceanusMoney(myCreditXferValue);</span>
<span class="nc" id="L1617">        myProfit.subtractAmount(myCostXfer);</span>
<span class="nc" id="L1618">        myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.GROWTHADJUST, myProfit);</span>
<span class="nc" id="L1619">        myProfit = new OceanusMoney(myProfit);</span>
<span class="nc" id="L1620">        myProfit.negate();</span>
<span class="nc" id="L1621">        myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.GROWTHADJUST, myProfit);</span>

        /* Adjust cost/units/invested of the credit account */
<span class="nc" id="L1624">        myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myCostXfer);</span>
<span class="nc" id="L1625">        myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myCreditUnits);</span>
<span class="nc" id="L1626">        myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myCostXfer);</span>
<span class="nc bnc" id="L1627" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1628">            final OceanusMoney myForeign = myCostXfer.convertCurrency(myCreditAsset.getCurrency().getCurrency(), myCreditRate);</span>
<span class="nc" id="L1629">            myCreditAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myForeign);</span>
        }

        /* Determine final value of the credit stock after the takeOver */
<span class="nc" id="L1633">        myCreditUnits = myCreditAsset.getValues().getUnitsValue(MoneyWiseAnalysisSecurityAttr.UNITS);</span>
<span class="nc" id="L1634">        OceanusMoney myCreditValue = myCreditUnits.valueAtPrice(myCreditPrice);</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1636">            myCreditValue = myCreditValue.convertCurrency(myCurrency, myCreditRate);</span>
        }

        /* Register the transaction */
<span class="nc" id="L1640">        final MoneyWiseAnalysisSecurityValues myCreditValues = myCreditAsset.registerTransaction(theHelper);</span>
<span class="nc" id="L1641">        myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myCreditPrice);</span>
<span class="nc" id="L1642">        myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myCreditXferValue);</span>
<span class="nc" id="L1643">        myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer);</span>
<span class="nc" id="L1644">        myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.VALUATION, myCreditValue);</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">        if (isForeignCredit) {</span>
<span class="nc" id="L1646">            myCreditValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myCreditRate);</span>
        }

        /* Drive debit cost down to zero */
<span class="nc" id="L1650">        final OceanusMoney myDeltaCost = new OceanusMoney(myCost);</span>
<span class="nc" id="L1651">        myDeltaCost.negate();</span>
<span class="nc" id="L1652">        myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.RESIDUALCOST, myDeltaCost);</span>

        /* Drive debit units down to zero */
<span class="nc" id="L1655">        myDebitUnits = new OceanusUnits(myDebitUnits);</span>
<span class="nc" id="L1656">        myDebitUnits.negate();</span>
<span class="nc" id="L1657">        myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.UNITS, myDebitUnits);</span>

        /* Adjust debit Invested amount */
<span class="nc" id="L1660">        OceanusMoney myInvested = myDebitValues.getMoneyValue(MoneyWiseAnalysisSecurityAttr.INVESTED);</span>
<span class="nc" id="L1661">        myInvested = new OceanusMoney(myInvested);</span>
<span class="nc" id="L1662">        myInvested.setZero();</span>
<span class="nc" id="L1663">        myInvested.subtractAmount(myAmount);</span>
<span class="nc" id="L1664">        myInvested.subtractAmount(myCostXfer);</span>
<span class="nc" id="L1665">        myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.INVESTED, myInvested);</span>
<span class="nc bnc" id="L1666" title="All 2 branches missed.">        if (isForeignDebit) {</span>
<span class="nc" id="L1667">            myInvested = myInvested.convertCurrency(myDebitAsset.getCurrency().getCurrency(), myDebitRate);</span>
<span class="nc" id="L1668">            myInvested.negate();</span>
<span class="nc" id="L1669">            myDebitAsset.adjustCounter(MoneyWiseAnalysisSecurityAttr.FOREIGNINVESTED, myInvested);</span>
        }

        /* Register the transaction */
<span class="nc" id="L1673">        myDebitValues = myDebitAsset.registerTransaction(theHelper);</span>
<span class="nc" id="L1674">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.PRICE, myDebitPrice);</span>
<span class="nc" id="L1675">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.VALUATION, myDebitValue);</span>
<span class="nc" id="L1676">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.CONSIDERATION, myConsideration);</span>
<span class="nc" id="L1677">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.RETURNEDCASH, myAmount);</span>
<span class="nc" id="L1678">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDVALUE, myCreditXferValue);</span>
<span class="nc" id="L1679">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.XFERREDCOST, myCostXfer);</span>
<span class="nc" id="L1680">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.ALLOWEDCOST, myAllowedCost);</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">        if (myCostDilution != null) {</span>
<span class="nc" id="L1682">            myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.COSTDILUTION, myCostDilution);</span>
        }
<span class="nc bnc" id="L1684" title="All 2 branches missed.">        if (myCapitalGain.isNonZero()) {</span>
<span class="nc" id="L1685">            myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.CAPITALGAIN, myCapitalGain);</span>
        }
<span class="nc bnc" id="L1687" title="All 2 branches missed.">        if (isForeignDebit) {</span>
<span class="nc" id="L1688">            myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.EXCHANGERATE, myDebitRate);</span>
        }
<span class="nc bnc" id="L1690" title="All 2 branches missed.">        myDebitValues.setValue(MoneyWiseAnalysisSecurityAttr.CASHTYPE, isLargeCash</span>
<span class="nc" id="L1691">                ? MoneyWiseCashType.LARGECASH</span>
<span class="nc" id="L1692">                : MoneyWiseCashType.SMALLCASH);</span>

        /* Adjust the ThirdParty account bucket */
<span class="nc" id="L1695">        final MoneyWiseAnalysisAccountBucket&lt;?&gt; myBucket = getAccountBucket((MoneyWiseAssetBase) myReturnedCashAccount);</span>
<span class="nc" id="L1696">        myBucket.adjustForReturnedCashCredit(theHelper);</span>
<span class="nc" id="L1697">    }</span>

    /**
     * Obtain Account bucket for asset.
     * @param pAsset the asset
     * @return the bucket
     */
    private MoneyWiseAnalysisAccountBucket&lt;?&gt; getAccountBucket(final MoneyWiseAssetBase pAsset) {
<span class="nc bnc" id="L1705" title="All 5 branches missed.">        switch (pAsset.getAssetType()) {</span>
            case DEPOSIT:
<span class="nc" id="L1707">                return theDepositBuckets.getBucket((MoneyWiseDeposit) pAsset);</span>
            case CASH:
<span class="nc" id="L1709">                return theCashBuckets.getBucket((MoneyWiseCash) pAsset);</span>
            case LOAN:
<span class="nc" id="L1711">                return theLoanBuckets.getBucket((MoneyWiseLoan) pAsset);</span>
            case PORTFOLIO:
<span class="nc" id="L1713">                return thePortfolioBuckets.getCashBucket((MoneyWisePortfolio) pAsset);</span>
            default:
<span class="nc" id="L1715">                throw new IllegalArgumentException();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>