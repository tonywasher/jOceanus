<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseDepositRate.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.data.basic</a> &gt; <span class="el_source">MoneyWiseDepositRate.java</span></div><h1>MoneyWiseDepositRate.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.data.basic;

import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataList;
import net.sourceforge.joceanus.metis.data.MetisDataResource;
import net.sourceforge.joceanus.metis.field.MetisFieldItem;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDeposit.MoneyWiseDepositList;
import net.sourceforge.joceanus.moneywise.exc.MoneyWiseDataException;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.date.OceanusDateFormatter;
import net.sourceforge.joceanus.oceanus.decimal.OceanusRate;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataInstanceMap;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataMapItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataValues;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedDataItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedFieldSet;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedPair;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedValues;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditSet;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;

/**
 * DepositRate data type.
 * @author Tony Washer
 */
public class MoneyWiseDepositRate
        extends PrometheusEncryptedDataItem {
    /**
     * Object name.
     */
<span class="fc" id="L58">    public static final String OBJECT_NAME = MoneyWiseBasicDataType.DEPOSITRATE.getItemName();</span>

    /**
     * List name.
     */
<span class="fc" id="L63">    public static final String LIST_NAME = MoneyWiseBasicDataType.DEPOSITRATE.getListName();</span>

    /**
     * Report fields.
     */
<span class="fc" id="L68">    private static final PrometheusEncryptedFieldSet&lt;MoneyWiseDepositRate&gt; FIELD_DEFS = PrometheusEncryptedFieldSet.newEncryptedFieldSet(MoneyWiseDepositRate.class);</span>

    /*
     * FieldIds.
     */
    static {
<span class="fc" id="L74">        FIELD_DEFS.declareLinkField(MoneyWiseBasicDataType.DEPOSIT);</span>
<span class="fc" id="L75">        FIELD_DEFS.declareEncryptedRateField(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE);</span>
<span class="fc" id="L76">        FIELD_DEFS.declareEncryptedRateField(MoneyWiseBasicResource.DEPOSITRATE_BONUS);</span>
<span class="fc" id="L77">        FIELD_DEFS.declareDateField(MoneyWiseBasicResource.DEPOSITRATE_ENDDATE);</span>
    }

    /**
     * Null Date Error.
     */
<span class="fc" id="L83">    public static final String ERROR_NULLDATE = MoneyWiseBasicResource.DEPOSITRATE_ERROR_NULLDATE.getValue();</span>

    /**
     * Copy Constructor.
     * @param pList the list
     * @param pPeriod The Period to copy
     */
    protected MoneyWiseDepositRate(final MoneyWiseDepositRateList pList,
                                   final MoneyWiseDepositRate pPeriod) {
        /* Set standard values */
<span class="nc" id="L93">        super(pList, pPeriod);</span>
<span class="nc" id="L94">    }</span>

    /**
     * Edit Constructor.
     * @param pList the list
     */
    public MoneyWiseDepositRate(final MoneyWiseDepositRateList pList) {
<span class="nc" id="L101">        super(pList, 0);</span>
<span class="nc" id="L102">    }</span>

    /**
     * Values constructor.
     * @param pList the List to add to
     * @param pValues the values constructor
     * @throws OceanusException on error
     */
    private MoneyWiseDepositRate(final MoneyWiseDepositRateList pList,
                                 final PrometheusDataValues pValues) throws OceanusException {
        /* Initialise the item */
<span class="nc" id="L113">        super(pList, pValues);</span>

        /* Access the formatter */
<span class="nc" id="L116">        final OceanusDataFormatter myFormatter = getDataSet().getDataFormatter();</span>

        /* Protect against exceptions */
        try {
            /* Store the Account */
<span class="nc" id="L121">            Object myValue = pValues.getValue(MoneyWiseBasicDataType.DEPOSIT);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (myValue instanceof Integer i) {</span>
<span class="nc" id="L123">                setValueDeposit(i);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="nc" id="L125">                setValueDeposit(s);</span>
            }

            /* Store the Rate */
<span class="nc" id="L129">            myValue = pValues.getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (myValue instanceof OceanusRate r) {</span>
<span class="nc" id="L131">                setValueRate(r);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            } else if (myValue instanceof byte[] ba) {</span>
<span class="nc" id="L133">                setValueRate(ba);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            } else if (myValue instanceof String myString) {</span>
<span class="nc" id="L135">                setValueRate(myString);</span>
<span class="nc" id="L136">                setValueRate(myFormatter.parseValue(myString, OceanusRate.class));</span>
            }

            /* Store the Bonus */
<span class="nc" id="L140">            myValue = pValues.getValue(MoneyWiseBasicResource.DEPOSITRATE_BONUS);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (myValue instanceof OceanusRate r) {</span>
<span class="nc" id="L142">                setValueBonus(r);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            } else if (myValue instanceof byte[] ba) {</span>
<span class="nc" id="L144">                setValueBonus(ba);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            } else if (myValue instanceof String myString) {</span>
<span class="nc" id="L146">                setValueBonus(myString);</span>
<span class="nc" id="L147">                setValueBonus(myFormatter.parseValue(myString, OceanusRate.class));</span>
            }

            /* Store the EndDate */
<span class="nc" id="L151">            myValue = pValues.getValue(MoneyWiseBasicResource.DEPOSITRATE_ENDDATE);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (myValue instanceof OceanusDate d) {</span>
<span class="nc" id="L153">                setValueEndDate(d);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="nc" id="L155">                final OceanusDateFormatter myParser = myFormatter.getDateFormatter();</span>
<span class="nc" id="L156">                setValueEndDate(myParser.parseDate(s));</span>
            }

            /* Catch Exceptions */
<span class="nc" id="L160">        } catch (IllegalArgumentException</span>
                 | OceanusException e) {
            /* Pass on exception */
<span class="nc" id="L163">            throw new MoneyWiseDataException(this, ERROR_CREATEITEM, e);</span>
<span class="nc" id="L164">        }</span>
<span class="nc" id="L165">    }</span>

    @Override
    public MetisFieldSetDef getDataFieldSet() {
<span class="nc" id="L169">        return FIELD_DEFS;</span>
    }

    @Override
    public boolean includeXmlField(final MetisDataFieldId pField) {
        /* Determine whether fields should be included */
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (MoneyWiseBasicDataType.DEPOSIT.equals(pField)) {</span>
<span class="nc" id="L176">            return true;</span>
        }
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE.equals(pField)) {</span>
<span class="nc" id="L179">            return true;</span>
        }
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (MoneyWiseBasicResource.DEPOSITRATE_BONUS.equals(pField)) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            return getBonus() != null;</span>
        }
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (MoneyWiseBasicResource.DEPOSITRATE_ENDDATE.equals(pField)) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            return getEndDate() != null;</span>
        }

        /* Pass call on */
<span class="nc" id="L189">        return super.includeXmlField(pField);</span>
    }

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L194">        return toString();</span>
    }

    @Override
    public String toString() {
        /* Access Key Values */
<span class="nc" id="L200">        final PrometheusEncryptedValues myValues = getValues();</span>
<span class="nc" id="L201">        final Object myDeposit = myValues.getValue(MoneyWiseBasicDataType.DEPOSIT);</span>
<span class="nc" id="L202">        final Object myRate = myValues.getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE);</span>
<span class="nc" id="L203">        final Object myEndDate = myValues.getValue(MoneyWiseBasicResource.DEPOSITRATE_ENDDATE);</span>

        /* Access formatter */
<span class="nc" id="L206">        final OceanusDataFormatter myFormatter = getDataSet().getDataFormatter();</span>

        /* Create string builder */
<span class="nc" id="L209">        final StringBuilder myBuilder = new StringBuilder();</span>
<span class="nc" id="L210">        myBuilder.append(myFormatter.formatObject(myDeposit));</span>
<span class="nc" id="L211">        myBuilder.append('@');</span>
<span class="nc" id="L212">        myBuilder.append(myFormatter.formatObject(myRate));</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (myEndDate != null) {</span>
<span class="nc" id="L214">            myBuilder.append(&quot;-&gt;&quot;);</span>
<span class="nc" id="L215">            myBuilder.append(myFormatter.formatObject(myEndDate));</span>
        }

        /* return it */
<span class="nc" id="L219">        return myBuilder.toString();</span>
    }

    /**
     * Obtain Rate.
     * @return the rate
     */
    public OceanusRate getRate() {
<span class="nc" id="L227">        return getValues().getValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE, OceanusRate.class);</span>
    }

    /**
     * Obtain Encrypted rate.
     * @return the Bytes
     */
    public byte[] getRateBytes() {
<span class="nc" id="L235">        return getValues().getEncryptedBytes(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE);</span>
    }

    /**
     * Obtain Encrypted Rate Field.
     * @return the Field
     */
    private PrometheusEncryptedPair getRateField() {
<span class="nc" id="L243">        return getValues().getEncryptedPair(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE);</span>
    }

    /**
     * Obtain Bonus.
     * @return the bonus rate
     */
    public OceanusRate getBonus() {
<span class="nc" id="L251">        return getValues().getValue(MoneyWiseBasicResource.DEPOSITRATE_BONUS, OceanusRate.class);</span>
    }

    /**
     * Obtain Encrypted bonus.
     * @return the Bytes
     */
    public byte[] getBonusBytes() {
<span class="nc" id="L259">        return getValues().getEncryptedBytes(MoneyWiseBasicResource.DEPOSITRATE_BONUS);</span>
    }

    /**
     * Obtain Encrypted Rate Field.
     * @return the Field
     */
    private PrometheusEncryptedPair getBonusField() {
<span class="nc" id="L267">        return getValues().getEncryptedPair(MoneyWiseBasicResource.DEPOSITRATE_BONUS);</span>
    }

    /**
     * Obtain date.
     * @return the date
     */
    public OceanusDate getDate() {
<span class="nc" id="L275">        return getEndDate();</span>
    }

    /**
     * Obtain End Date.
     * @return the End Date
     */
    public OceanusDate getEndDate() {
<span class="nc" id="L283">        return getValues().getValue(MoneyWiseBasicResource.DEPOSITRATE_ENDDATE, OceanusDate.class);</span>
    }

    /**
     * Obtain Deposit.
     * @return the deposit
     */
    public MoneyWiseDeposit getDeposit() {
<span class="nc" id="L291">        return getValues().getValue(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDeposit.class);</span>
    }

    /**
     * Obtain DepositId.
     * @return the depositId
     */
    public Integer getDepositId() {
<span class="nc" id="L299">        final MoneyWiseDeposit myDeposit = getDeposit();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        return myDeposit == null</span>
<span class="nc" id="L301">                ? null</span>
<span class="nc" id="L302">                : myDeposit.getIndexedId();</span>
    }

    /**
     * Obtain DepositName.
     * @return the depositName
     */
    public String getDepositName() {
<span class="nc" id="L310">        final MoneyWiseDeposit myDeposit = getDeposit();</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        return myDeposit == null</span>
<span class="nc" id="L312">                ? null</span>
<span class="nc" id="L313">                : myDeposit.getName();</span>
    }

    /**
     * Set the account.
     * @param pValue the account
     */
    private void setValueDeposit(final MoneyWiseDeposit pValue) {
<span class="nc" id="L321">        getValues().setUncheckedValue(MoneyWiseBasicDataType.DEPOSIT, pValue);</span>
<span class="nc" id="L322">    }</span>

    /**
     * Set the deposit id.
     * @param pId the deposit id
     */
    private void setValueDeposit(final Integer pId) {
<span class="nc" id="L329">        getValues().setUncheckedValue(MoneyWiseBasicDataType.DEPOSIT, pId);</span>
<span class="nc" id="L330">    }</span>

    /**
     * Set the deposit name.
     * @param pName the deposit name
     */
    private void setValueDeposit(final String pName) {
<span class="nc" id="L337">        getValues().setUncheckedValue(MoneyWiseBasicDataType.DEPOSIT, pName);</span>
<span class="nc" id="L338">    }</span>

    /**
     * Set the rate.
     * @param pValue the rate
     * @throws OceanusException on error
     */
    private void setValueRate(final OceanusRate pValue) throws OceanusException {
<span class="nc" id="L346">        setEncryptedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE, pValue);</span>
<span class="nc" id="L347">    }</span>

    /**
     * Set the rate.
     * @param pBytes the encrypted rate
     * @throws OceanusException on error
     */
    private void setValueRate(final byte[] pBytes) throws OceanusException {
<span class="nc" id="L355">        setEncryptedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE, pBytes, OceanusRate.class);</span>
<span class="nc" id="L356">    }</span>

    /**
     * Set the rate.
     * @param pValue the rate
     */
    private void setValueRate(final PrometheusEncryptedPair pValue) {
<span class="nc" id="L363">        getValues().setUncheckedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE, pValue);</span>
<span class="nc" id="L364">    }</span>

    /**
     * Set the rate.
     * @param pValue the rate
     */
    private void setValueRate(final String pValue) {
<span class="nc" id="L371">        getValues().setUncheckedValue(MoneyWiseBasicResource.MONEYWISEDATA_FIELD_RATE, pValue);</span>
<span class="nc" id="L372">    }</span>

    /**
     * Set the bonus rate.
     * @param pValue the bonus rate
     * @throws OceanusException on error
     */
    private void setValueBonus(final OceanusRate pValue) throws OceanusException {
<span class="nc" id="L380">        setEncryptedValue(MoneyWiseBasicResource.DEPOSITRATE_BONUS, pValue);</span>
<span class="nc" id="L381">    }</span>

    /**
     * Set the encrypted bonus.
     * @param pBytes the encrypted bonus
     * @throws OceanusException on error
     */
    private void setValueBonus(final byte[] pBytes) throws OceanusException {
<span class="nc" id="L389">        setEncryptedValue(MoneyWiseBasicResource.DEPOSITRATE_BONUS, pBytes, OceanusRate.class);</span>
<span class="nc" id="L390">    }</span>

    /**
     * Set the bonus.
     * @param pValue the bonus
     */
    private void setValueBonus(final PrometheusEncryptedPair pValue) {
<span class="nc" id="L397">        getValues().setUncheckedValue(MoneyWiseBasicResource.DEPOSITRATE_BONUS, pValue);</span>
<span class="nc" id="L398">    }</span>

    /**
     * Set the bonus.
     * @param pValue the bonus
     */
    private void setValueBonus(final String pValue) {
<span class="nc" id="L405">        getValues().setUncheckedValue(MoneyWiseBasicResource.DEPOSITRATE_BONUS, pValue);</span>
<span class="nc" id="L406">    }</span>

    /**
     * Set the end date.
     * @param pValue the date
     */
    private void setValueEndDate(final OceanusDate pValue) {
<span class="nc" id="L413">        getValues().setUncheckedValue(MoneyWiseBasicResource.DEPOSITRATE_ENDDATE, pValue);</span>
<span class="nc" id="L414">    }</span>

    @Override
    public MoneyWiseDataSet getDataSet() {
<span class="nc" id="L418">        return (MoneyWiseDataSet) super.getDataSet();</span>
    }

    @Override
    public MoneyWiseDepositRate getBase() {
<span class="nc" id="L423">        return (MoneyWiseDepositRate) super.getBase();</span>
    }

    @Override
    public MoneyWiseDepositRateList getList() {
<span class="nc" id="L428">        return (MoneyWiseDepositRateList) super.getList();</span>
    }

    /**
     * Compare this rate to another to establish sort order.
     * @param pThat The Rate to compare to
     * @return (-1,0,1) depending of whether this object is before, equal, or after the passed
     * object in the sort order
     */
    @Override
    public int compareValues(final PrometheusDataItem pThat) {
        /* Access as DepositRate */
<span class="nc" id="L440">        final MoneyWiseDepositRate myThat = (MoneyWiseDepositRate) pThat;</span>

        /* If header settings differ */
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (isHeader() != pThat.isHeader()) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            return isHeader()</span>
<span class="nc" id="L445">                    ? -1</span>
<span class="nc" id="L446">                    : 1;</span>
        }

        /* If the date differs */
<span class="nc" id="L450">        final int iDiff = MetisDataDifference.compareObject(getDate(), myThat.getDate());</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (iDiff != 0) {</span>
            /* Sort in reverse date order !! */
<span class="nc" id="L453">            return -iDiff;</span>
        }

        /* Compare the deposits */
<span class="nc" id="L457">        return getDeposit().compareTo(myThat.getDeposit());</span>
    }

    @Override
    public void resolveDataSetLinks() throws OceanusException {
        /* Update the Encryption details */
<span class="nc" id="L463">        super.resolveDataSetLinks();</span>

        /* Resolve data links */
<span class="nc" id="L466">        final MoneyWiseDataSet myData = getDataSet();</span>
<span class="nc" id="L467">        resolveDataLink(MoneyWiseBasicDataType.DEPOSIT, myData.getDeposits());</span>
<span class="nc" id="L468">    }</span>

    /**
     * Resolve links in an updateSet.
     * @param pEditSet the edit Set
     * @throws OceanusException on error
     */
    private void resolveEditSetLinks(final PrometheusEditSet pEditSet) throws OceanusException {
        /* Resolve parent within list */
<span class="nc" id="L477">        final MoneyWiseDepositList myDeposits = pEditSet.getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class);</span>
<span class="nc" id="L478">        resolveDataLink(MoneyWiseBasicDataType.DEPOSIT, myDeposits);</span>
<span class="nc" id="L479">    }</span>

    /**
     * Set the deposit.
     * @param pValue the deposit
     */
    public void setDeposit(final MoneyWiseDeposit pValue) {
<span class="nc" id="L486">        setValueDeposit(pValue);</span>
<span class="nc" id="L487">    }</span>

    /**
     * Set a new rate.
     * @param pRate the rate
     * @throws OceanusException on error
     */
    public void setRate(final OceanusRate pRate) throws OceanusException {
<span class="nc" id="L495">        setValueRate(pRate);</span>
<span class="nc" id="L496">    }</span>

    /**
     * Set a new bonus.
     * @param pBonus the rate
     * @throws OceanusException on error
     */
    public void setBonus(final OceanusRate pBonus) throws OceanusException {
<span class="nc" id="L504">        setValueBonus(pBonus);</span>
<span class="nc" id="L505">    }</span>

    /**
     * Set a new date.
     * @param pDate the new date
     */
    public void setEndDate(final OceanusDate pDate) {
<span class="nc bnc" id="L512" title="All 2 branches missed.">        setValueEndDate(pDate == null</span>
<span class="nc" id="L513">                ? null</span>
<span class="nc" id="L514">                : new OceanusDate(pDate));</span>
<span class="nc" id="L515">    }</span>

    @Override
    public void touchUnderlyingItems() {
        /* touch the underlying deposit */
<span class="nc" id="L520">        getDeposit().touchItem(this);</span>
<span class="nc" id="L521">    }</span>

    @Override
    public void touchOnUpdate() {
        /* Touch deposit */
<span class="nc" id="L526">        getDeposit().touchItem(this);</span>
<span class="nc" id="L527">    }</span>

    /**
     * Update Rate from a Rate extract.
     * @param pRate the updated item
     * @return whether changes have been made
     */
    @Override
    public boolean applyChanges(final PrometheusDataItem pRate) {
        /* Can only update from an DepositRate */
<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (!(pRate instanceof MoneyWiseDepositRate)) {</span>
<span class="nc" id="L538">            return false;</span>
        }
<span class="nc" id="L540">        final MoneyWiseDepositRate myRate = (MoneyWiseDepositRate) pRate;</span>

        /* Store the current detail into history */
<span class="nc" id="L543">        pushHistory();</span>

        /* Update the rate if required */
<span class="nc bnc" id="L546" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getRate(), myRate.getRate())) {</span>
<span class="nc" id="L547">            setValueRate(myRate.getRateField());</span>
        }

        /* Update the bonus if required */
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getBonus(), myRate.getBonus())) {</span>
<span class="nc" id="L552">            setValueBonus(myRate.getBonusField());</span>
        }

        /* Update the date if required */
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getEndDate(), myRate.getEndDate())) {</span>
<span class="nc" id="L557">            setValueEndDate(myRate.getEndDate());</span>
        }

        /* Check for changes */
<span class="nc" id="L561">        return checkForHistory();</span>
    }

    @Override
    public void adjustMapForItem() {
<span class="nc" id="L566">        final MoneyWiseDepositRateList myList = getList();</span>
<span class="nc" id="L567">        final MoneyWiseDepositRateDataMap myMap = myList.getDataMap();</span>
<span class="nc" id="L568">        myMap.adjustForItem(this);</span>
<span class="nc" id="L569">    }</span>

    /**
     * List class.
     */
    public static class MoneyWiseDepositRateList
            extends PrometheusEncryptedList&lt;MoneyWiseDepositRate&gt; {
        /**
         * Report fields.
         */
<span class="fc" id="L579">        private static final MetisFieldSet&lt;MoneyWiseDepositRateList&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseDepositRateList.class);</span>

        /**
         * Construct an empty CORE rate list.
         * @param pData the DataSet for the list
         */
        protected MoneyWiseDepositRateList(final MoneyWiseDataSet pData) {
<span class="fc" id="L586">            super(MoneyWiseDepositRate.class, pData, MoneyWiseBasicDataType.DEPOSITRATE);</span>
<span class="fc" id="L587">        }</span>

        /**
         * Constructor for a cloned List.
         * @param pSource the source List
         */
        private MoneyWiseDepositRateList(final MoneyWiseDepositRateList pSource) {
<span class="fc" id="L594">            super(pSource);</span>
<span class="fc" id="L595">        }</span>

        @Override
        protected MoneyWiseDepositRateList getEmptyList(final PrometheusListStyle pStyle) {
<span class="fc" id="L599">            final MoneyWiseDepositRateList myList = new MoneyWiseDepositRateList(this);</span>
<span class="fc" id="L600">            myList.setStyle(pStyle);</span>
<span class="fc" id="L601">            return myList;</span>
        }

        @Override
        public MetisFieldSet&lt;MoneyWiseDepositRateList&gt; getDataFieldSet() {
<span class="nc" id="L606">            return FIELD_DEFS;</span>
        }

        @Override
        public MetisFieldSetDef getItemFields() {
<span class="fc" id="L611">            return MoneyWiseDepositRate.FIELD_DEFS;</span>
        }

        @Override
        public String listName() {
<span class="fc" id="L616">            return LIST_NAME;</span>
        }

        @Override
        public MoneyWiseDataSet getDataSet() {
<span class="fc" id="L621">            return (MoneyWiseDataSet) super.getDataSet();</span>
        }

        @Override
        public MoneyWiseDepositRateDataMap getDataMap() {
<span class="nc" id="L626">            return (MoneyWiseDepositRateDataMap) super.getDataMap();</span>
        }

        /**
         * Construct an edit extract of a Rate list.
         * @param pEditSet the editSet
         * @return the edit list
         * @throws OceanusException on error
         */
        public MoneyWiseDepositRateList deriveEditList(final PrometheusEditSet pEditSet) throws OceanusException {
            /* Build an empty List */
<span class="fc" id="L637">            final MoneyWiseDepositRateList myList = getEmptyList(PrometheusListStyle.EDIT);</span>
<span class="fc" id="L638">            myList.ensureMap();</span>
<span class="fc" id="L639">            pEditSet.setEditEntryList(MoneyWiseBasicDataType.DEPOSITRATE, myList);</span>

            /* Loop through the list */
<span class="fc" id="L642">            final Iterator&lt;MoneyWiseDepositRate&gt; myIterator = iterator();</span>
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L644">                final MoneyWiseDepositRate myCurr = myIterator.next();</span>

                /* Copy the item */
<span class="nc" id="L647">                final MoneyWiseDepositRate myItem = new MoneyWiseDepositRate(myList, myCurr);</span>
<span class="nc" id="L648">                myItem.resolveEditSetLinks(pEditSet);</span>
<span class="nc" id="L649">                myList.add(myItem);</span>

                /* Adjust the map */
<span class="nc" id="L652">                myItem.adjustMapForItem();</span>
<span class="nc" id="L653">            }</span>

            /* Return the List */
<span class="fc" id="L656">            return myList;</span>
        }

        /**
         * Add a new item to the core list.
         * @param pRate item
         * @return the newly added item
         */
        @Override
        public MoneyWiseDepositRate addCopyItem(final PrometheusDataItem pRate) {
            /* Can only clone a DepositRate */
<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (!(pRate instanceof MoneyWiseDepositRate)) {</span>
<span class="nc" id="L668">                throw new UnsupportedOperationException();</span>
            }

<span class="nc" id="L671">            final MoneyWiseDepositRate myRate = new MoneyWiseDepositRate(this, (MoneyWiseDepositRate) pRate);</span>
<span class="nc" id="L672">            add(myRate);</span>
<span class="nc" id="L673">            return myRate;</span>
        }

        /**
         * Add a new item to the edit list.
         * @return the new item
         */
        @Override
        public MoneyWiseDepositRate addNewItem() {
<span class="nc" id="L682">            final MoneyWiseDepositRate myRate = new MoneyWiseDepositRate(this);</span>
<span class="nc" id="L683">            add(myRate);</span>
<span class="nc" id="L684">            return myRate;</span>
        }

        @Override
        public MoneyWiseDepositRate addValuesItem(final PrometheusDataValues pValues) throws OceanusException {
            /* Create the rate */
<span class="nc" id="L690">            final MoneyWiseDepositRate myRate = new MoneyWiseDepositRate(this, pValues);</span>

            /* Check that this RateId has not been previously added */
<span class="nc bnc" id="L693" title="All 2 branches missed.">            if (!isIdUnique(myRate.getIndexedId())) {</span>
<span class="nc" id="L694">                myRate.addError(ERROR_DUPLICATE, MetisDataResource.DATA_ID);</span>
<span class="nc" id="L695">                throw new MoneyWiseDataException(myRate, ERROR_VALIDATION);</span>
            }

            /* Add to the list */
<span class="nc" id="L699">            add(myRate);</span>

            /* Return it */
<span class="nc" id="L702">            return myRate;</span>
        }

        @Override
        protected MoneyWiseDepositRateDataMap allocateDataMap() {
<span class="fc" id="L707">            return new MoneyWiseDepositRateDataMap();</span>
        }
    }

    /**
     * The dataMap class.
     */
    public static class MoneyWiseDepositRateDataMap
            implements PrometheusDataMapItem, MetisFieldItem {
        /**
         * Report fields.
         */
<span class="fc" id="L719">        private static final MetisFieldSet&lt;MoneyWiseDepositRateDataMap&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseDepositRateDataMap.class);</span>

        /*
         * UnderlyingMap Field Id.
         */
        static {
<span class="fc" id="L725">            FIELD_DEFS.declareLocalField(MoneyWiseBasicResource.MONEYWISEDATA_MAP_MAPOFMAPS, MoneyWiseDepositRateDataMap::getMapOfMaps);</span>
<span class="fc" id="L726">            FIELD_DEFS.declareLocalField(MoneyWiseBasicResource.DEPOSITRATE_MAP_MAPOFRATES, MoneyWiseDepositRateDataMap::getMapOfRates);</span>
<span class="fc" id="L727">        }</span>

        /**
         * Map of Maps.
         */
        private final Map&lt;MoneyWiseDeposit, Map&lt;OceanusDate, Integer&gt;&gt; theMapOfMaps;

        /**
         * Map of Rates.
         */
        private final Map&lt;MoneyWiseDeposit, MoneyWiseRateList&gt; theMapOfRates;

        /**
         * Constructor.
         */
<span class="fc" id="L742">        public MoneyWiseDepositRateDataMap() {</span>
            /* Create the maps */
<span class="fc" id="L744">            theMapOfMaps = new HashMap&lt;&gt;();</span>
<span class="fc" id="L745">            theMapOfRates = new HashMap&lt;&gt;();</span>
<span class="fc" id="L746">        }</span>

        @Override
        public MetisFieldSet&lt;MoneyWiseDepositRateDataMap&gt; getDataFieldSet() {
<span class="nc" id="L750">            return FIELD_DEFS;</span>
        }

        @Override
        public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L755">            return FIELD_DEFS.getName();</span>
        }

        /**
         * Obtain mapOfMaps.
         * @return the map
         */
        private Map&lt;MoneyWiseDeposit, Map&lt;OceanusDate, Integer&gt;&gt; getMapOfMaps() {
<span class="nc" id="L763">            return theMapOfMaps;</span>
        }

        /**
         * Obtain mapOfRates.
         * @return the map
         */
        private Map&lt;MoneyWiseDeposit, MoneyWiseRateList&gt; getMapOfRates() {
<span class="nc" id="L771">            return theMapOfRates;</span>
        }

        @Override
        public void resetMap() {
<span class="fc" id="L776">            theMapOfMaps.clear();</span>
<span class="fc" id="L777">            theMapOfRates.clear();</span>
<span class="fc" id="L778">        }</span>

        @Override
        public void adjustForItem(final PrometheusDataItem pItem) {
            /* Access the Deposit Id */
<span class="nc" id="L783">            final MoneyWiseDepositRate myItem = (MoneyWiseDepositRate) pItem;</span>
<span class="nc" id="L784">            final MoneyWiseDeposit myDeposit = myItem.getDeposit();</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">            if (myDeposit == null) {</span>
<span class="nc" id="L786">                return;</span>
            }

            /* Access the map */
<span class="nc" id="L790">            final Map&lt;OceanusDate, Integer&gt; myMap = theMapOfMaps.computeIfAbsent(myDeposit, m -&gt; new HashMap&lt;&gt;());</span>

            /* Adjust rate count */
<span class="nc" id="L793">            final OceanusDate myDate = myItem.getEndDate();</span>
<span class="nc" id="L794">            final Integer myCount = myMap.get(myDate);</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">            if (myCount == null) {</span>
<span class="nc" id="L796">                myMap.put(myDate, PrometheusDataInstanceMap.ONE);</span>
            } else {
<span class="nc" id="L798">                myMap.put(myDate, myCount + 1);</span>
            }

            /* Access the list */
<span class="nc" id="L802">            final MoneyWiseRateList myList = theMapOfRates.computeIfAbsent(myDeposit, MoneyWiseRateList::new);</span>

            /* Add element to the list */
<span class="nc" id="L805">            myList.add(myItem);</span>
<span class="nc" id="L806">        }</span>

        /**
         * Check validity of Rate.
         * @param pItem the rate
         * @return true/false
         */
        public boolean validRateCount(final MoneyWiseDepositRate pItem) {
            /* Access the Details */
<span class="nc" id="L815">            final MoneyWiseDeposit myDeposit = pItem.getDeposit();</span>
<span class="nc" id="L816">            final OceanusDate myDate = pItem.getEndDate();</span>

            /* Access the map */
<span class="nc" id="L819">            final Map&lt;OceanusDate, Integer&gt; myMap = theMapOfMaps.get(myDeposit);</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">            if (myMap != null) {</span>
<span class="nc" id="L821">                final Integer myResult = myMap.get(myDate);</span>
<span class="nc" id="L822">                return PrometheusDataInstanceMap.ONE.equals(myResult);</span>
            }
<span class="nc" id="L824">            return false;</span>
        }

        /**
         * Check availability of date for a deposit.
         * @param pDeposit the deposit
         * @param pDate the key to look up
         * @return true/false
         */
        public boolean availableDate(final MoneyWiseDeposit pDeposit,
                                     final OceanusDate pDate) {
            /* Access the map */
<span class="nc" id="L836">            final Map&lt;OceanusDate, Integer&gt; myMap = theMapOfMaps.get(pDeposit);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            return myMap == null</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">                    || myMap.get(pDate) == null;</span>
        }

        /**
         * Obtain rate for date.
         * @param pDeposit the deposit
         * @param pDate the date
         * @return the latest rate for the date.
         */
        public MoneyWiseDepositRate getRateForDate(final MoneyWiseDeposit pDeposit,
                                                   final OceanusDate pDate) {
            /* Access list for deposit */
<span class="nc" id="L850">            final MoneyWiseRateList myList = theMapOfRates.get(pDeposit);</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">            if (myList != null) {</span>
                /* Loop through the rates */
<span class="nc" id="L853">                final ListIterator&lt;MoneyWiseDepositRate&gt; myIterator = myList.listIterator(myList.size());</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">                while (myIterator.hasPrevious()) {</span>
<span class="nc" id="L855">                    final MoneyWiseDepositRate myCurr = myIterator.previous();</span>

                    /* Access the date */
<span class="nc" id="L858">                    final OceanusDate myDate = myCurr.getDate();</span>

                    /* break loop if we have the correct record */
<span class="nc bnc" id="L861" title="All 2 branches missed.">                    if (myDate == null</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">                            || myDate.compareTo(pDate) &gt;= 0) {</span>
<span class="nc" id="L863">                        return myCurr;</span>
                    }
<span class="nc" id="L865">                }</span>
            }

            /* return null */
<span class="nc" id="L869">            return null;</span>
        }

        /**
         * Rate List class.
         */
        private static final class MoneyWiseRateList
                implements MetisFieldItem, MetisDataList&lt;MoneyWiseDepositRate&gt; {
            /**
             * Report fields.
             */
<span class="nc" id="L880">            private static final MetisFieldSet&lt;MoneyWiseRateList&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseRateList.class);</span>

            /*
             * UnderlyingMap Field Id.
             */
            static {
<span class="nc" id="L886">                FIELD_DEFS.declareLocalField(MetisDataResource.LIST_SIZE, MoneyWiseRateList::size);</span>
<span class="nc" id="L887">            }</span>

            /**
             * The list.
             */
            private final List&lt;MoneyWiseDepositRate&gt; theList;

            /**
             * The deposit.
             */
            private final MoneyWiseDeposit theDeposit;

            /**
             * Constructor.
             * @param pDeposit the deposit
             */
<span class="nc" id="L903">            private MoneyWiseRateList(final MoneyWiseDeposit pDeposit) {</span>
<span class="nc" id="L904">                theDeposit = pDeposit;</span>
<span class="nc" id="L905">                theList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L906">            }</span>

            @Override
            public MetisFieldSet&lt;MoneyWiseRateList&gt; getDataFieldSet() {
<span class="nc" id="L910">                return FIELD_DEFS;</span>
            }

            @Override
            public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L915">                return theDeposit.formatObject(pFormatter)</span>
                        + &quot;(&quot;
<span class="nc" id="L917">                        + size()</span>
                        + &quot;)&quot;;
            }

            @Override
            public String toString() {
<span class="nc" id="L923">                return theDeposit.toString()</span>
                        + &quot;(&quot;
<span class="nc" id="L925">                        + size()</span>
                        + &quot;)&quot;;
            }

            @Override
            public List&lt;MoneyWiseDepositRate&gt; getUnderlyingList() {
<span class="nc" id="L931">                return theList;</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>