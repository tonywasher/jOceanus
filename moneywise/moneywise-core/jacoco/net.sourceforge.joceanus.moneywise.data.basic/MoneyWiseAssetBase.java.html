<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseAssetBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.data.basic</a> &gt; <span class="el_source">MoneyWiseAssetBase.java</span></div><h1>MoneyWiseAssetBase.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.data.basic;

import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataValidator.MoneyWiseDataValidatorAccount;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTax.MoneyWiseTaxCredit;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseTransaction.MoneyWiseTransactionList;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseAssetCategory;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseCurrency;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseStaticDataType;
import net.sourceforge.joceanus.moneywise.exc.MoneyWiseDataException;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataInstanceMap;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataList.PrometheusListStyle;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataResource;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataValues;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedDataItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedFieldSet;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedPair;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedValues;
import net.sourceforge.joceanus.prometheus.views.PrometheusEditSet;

import java.util.Currency;
import java.util.Iterator;

/**
 * Class representing an account that can be part of a transaction.
 */
public abstract class MoneyWiseAssetBase
        extends PrometheusEncryptedDataItem
        implements MoneyWiseTransAsset {
    /**
     * Report fields.
     */
<span class="fc" id="L56">    private static final PrometheusEncryptedFieldSet&lt;MoneyWiseAssetBase&gt; FIELD_DEFS = PrometheusEncryptedFieldSet.newEncryptedFieldSet(MoneyWiseAssetBase.class);</span>

    /*
     * FieldIds.
     */
    static {
<span class="fc" id="L62">        FIELD_DEFS.declareEncryptedStringField(PrometheusDataResource.DATAITEM_FIELD_NAME, NAMELEN);</span>
<span class="fc" id="L63">        FIELD_DEFS.declareEncryptedStringField(PrometheusDataResource.DATAITEM_FIELD_DESC, DESCLEN);</span>
<span class="fc" id="L64">        FIELD_DEFS.declareLinkField(MoneyWiseBasicResource.CATEGORY_NAME);</span>
<span class="fc" id="L65">        FIELD_DEFS.declareLinkField(MoneyWiseBasicResource.ASSET_PARENT);</span>
<span class="fc" id="L66">        FIELD_DEFS.declareLinkField(MoneyWiseStaticDataType.CURRENCY);</span>
<span class="fc" id="L67">        FIELD_DEFS.declareBooleanField(MoneyWiseBasicResource.ASSET_CLOSED);</span>
<span class="fc" id="L68">        FIELD_DEFS.declareLocalField(MoneyWiseBasicResource.ASSET_CLOSEDATE, MoneyWiseAssetBase::getCloseDate);</span>
<span class="fc" id="L69">        FIELD_DEFS.declareLocalField(MoneyWiseBasicResource.ASSET_FIRSTEVENT, MoneyWiseAssetBase::getEarliest);</span>
<span class="fc" id="L70">        FIELD_DEFS.declareLocalField(MoneyWiseBasicResource.ASSET_LASTEVENT, MoneyWiseAssetBase::getLatest);</span>
<span class="fc" id="L71">        FIELD_DEFS.declareLocalField(MoneyWiseBasicResource.ASSET_RELEVANT, MoneyWiseAssetBase::isRelevant);</span>
    }

    /**
     * Bad InfoSet Error Text.
     */
<span class="fc" id="L77">    protected static final String ERROR_BADINFOSET = PrometheusDataResource.DATAINFOSET_ERROR_BADSET.getValue();</span>

    /**
     * Close Date.
     */
    private OceanusDate theCloseDate;

    /**
     * Earliest Transaction.
     */
    private MoneyWiseTransaction theEarliest;

    /**
     * Latest Transaction.
     */
    private MoneyWiseTransaction theLatest;

    /**
     * Is this relevant?
     */
    private boolean isRelevant;

    /**
     * Copy Constructor.
     * @param pList the list
     * @param pAsset The Asset to copy
     */
    protected MoneyWiseAssetBase(final MoneyWiseAssetBaseList&lt;?&gt; pList,
                                 final MoneyWiseAssetBase pAsset) {
        /* Set standard values */
<span class="fc" id="L107">        super(pList, pAsset);</span>

        /* If we are creating an edit copy from core */
<span class="fc" id="L110">        final PrometheusListStyle myBaseStyle = pAsset.getList().getStyle();</span>
<span class="pc bpc" id="L111" title="1 of 4 branches missed.">        if (pList.getStyle() == PrometheusListStyle.EDIT</span>
                &amp;&amp; myBaseStyle == PrometheusListStyle.CORE) {
            /* Update underlying flags */
<span class="fc" id="L114">            theCloseDate = pAsset.getCloseDate();</span>
<span class="fc" id="L115">            theEarliest = pAsset.getEarliest();</span>
<span class="fc" id="L116">            theLatest = pAsset.getLatest();</span>
<span class="fc" id="L117">            isRelevant = pAsset.isRelevant();</span>
        }
<span class="fc" id="L119">    }</span>

    /**
     * Values constructor.
     * @param pList the List to add to
     * @param pValues the values constructor
     * @throws OceanusException on error
     */
    protected MoneyWiseAssetBase(final MoneyWiseAssetBaseList&lt;?&gt; pList,
                                 final PrometheusDataValues pValues) throws OceanusException {
        /* Initialise the item */
<span class="fc" id="L130">        super(pList, pValues);</span>

        /* Access formatter */
<span class="fc" id="L133">        final OceanusDataFormatter myFormatter = getDataSet().getDataFormatter();</span>

        /* Protect against exceptions */
        try {
            /* Store the name */
<span class="fc" id="L138">            Object myValue = pValues.getValue(PrometheusDataResource.DATAITEM_FIELD_NAME);</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">            if (myValue instanceof String s) {</span>
<span class="fc" id="L140">                setValueName(s);</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">            } else if (myValue instanceof byte[] ba) {</span>
<span class="fc" id="L142">                setValueName(ba);</span>
            }

            /* Store the Description */
<span class="fc" id="L146">            myValue = pValues.getValue(PrometheusDataResource.DATAITEM_FIELD_DESC);</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">            if (myValue instanceof String s) {</span>
<span class="nc" id="L148">                setValueDesc(s);</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            } else if (myValue instanceof byte[] ba) {</span>
<span class="nc" id="L150">                setValueDesc(ba);</span>
            }

            /* Store the Category */
<span class="fc" id="L154">            myValue = pValues.getValue(MoneyWiseBasicResource.CATEGORY_NAME);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            if (myValue instanceof Integer i) {</span>
<span class="fc" id="L156">                setValueCategory(i);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L158">                setValueCategory(s);</span>
            }

            /* Store the Parent */
<span class="fc" id="L162">            myValue = pValues.getValue(MoneyWiseBasicResource.ASSET_PARENT);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">            if (myValue instanceof Integer i) {</span>
<span class="fc" id="L164">                setValueParent(i);</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L166">                setValueParent(s);</span>
            }

            /* Store the Currency */
<span class="fc" id="L170">            myValue = pValues.getValue(MoneyWiseStaticDataType.CURRENCY);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">            if (myValue instanceof Integer i) {</span>
<span class="fc" id="L172">                setValueCurrency(i);</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L174">                setValueCurrency(s);</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">            } else if (myValue instanceof MoneyWiseCurrency c) {</span>
<span class="nc" id="L176">                setValueCurrency(c);</span>
            }

            /* Store the closed flag */
<span class="fc" id="L180">            myValue = pValues.getValue(MoneyWiseBasicResource.ASSET_CLOSED);</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">            if (myValue instanceof Boolean b) {</span>
<span class="fc" id="L182">                setValueClosed(b);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="nc" id="L184">                setValueClosed(myFormatter.parseValue(s, Boolean.class));</span>
            }

            /* Catch Exceptions */
<span class="nc" id="L188">        } catch (OceanusException e) {</span>
            /* Pass on exception */
<span class="nc" id="L190">            throw new MoneyWiseDataException(this, ERROR_CREATEITEM, e);</span>
<span class="fc" id="L191">        }</span>
<span class="fc" id="L192">    }</span>

    /**
     * Edit Constructor.
     * @param pList the list
     */
    protected MoneyWiseAssetBase(final MoneyWiseAssetBaseList&lt;?&gt; pList) {
<span class="fc" id="L199">        super(pList, 0);</span>
<span class="fc" id="L200">        setNextDataKeySet();</span>
<span class="fc" id="L201">    }</span>

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="fc" id="L205">        return toString();</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L210">        return getName();</span>
    }

    @Override
    public boolean includeXmlField(final MetisDataFieldId pField) {
        /* Determine whether fields should be included */
<span class="fc bfc" id="L216" title="All 2 branches covered.">        if (PrometheusDataResource.DATAITEM_FIELD_NAME.equals(pField)) {</span>
<span class="fc" id="L217">            return true;</span>
        }
<span class="fc bfc" id="L219" title="All 2 branches covered.">        if (PrometheusDataResource.DATAITEM_FIELD_DESC.equals(pField)) {</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">            return getDesc() != null;</span>
        }
<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (MoneyWiseBasicResource.ASSET_CLOSED.equals(pField)) {</span>
<span class="fc" id="L223">            return isClosed();</span>
        }

        /* Pass call on */
<span class="fc" id="L227">        return super.includeXmlField(pField);</span>
    }

    /**
     * Obtain Category.
     * @return the category
     */
    public abstract MoneyWiseAssetCategory getCategory();

    @Override
    public MoneyWisePayee getParent() {
<span class="fc" id="L238">        return getValues().getValue(MoneyWiseBasicResource.ASSET_PARENT, MoneyWisePayee.class);</span>
    }

    /**
     * Obtain ParentId.
     * @return the parentId
     */
    public Integer getParentId() {
<span class="fc" id="L246">        final MoneyWisePayee myParent = getParent();</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        return myParent == null</span>
<span class="nc" id="L248">                ? null</span>
<span class="fc" id="L249">                : myParent.getIndexedId();</span>
    }

    /**
     * Obtain ParentName.
     * @return the parentName
     */
    public String getParentName() {
<span class="nc" id="L257">        final MoneyWisePayee myParent = getParent();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        return myParent == null</span>
<span class="nc" id="L259">                ? null</span>
<span class="nc" id="L260">                : myParent.getName();</span>
    }

    @Override
    public MoneyWiseCurrency getAssetCurrency() {
<span class="fc" id="L265">        return getValues().getValue(MoneyWiseStaticDataType.CURRENCY, MoneyWiseCurrency.class);</span>
     }

    /**
     * Obtain CurrencyId.
     * @return the currencyId
     */
    public Integer getAssetCurrencyId() {
<span class="fc" id="L273">        final MoneyWiseCurrency myCurrency = getAssetCurrency();</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">        return myCurrency == null ? null : myCurrency.getIndexedId();</span>
    }

    /**
     * Obtain CurrencyName.
     * @return the currencyName
     */
    public String getAssetCurrencyName() {
<span class="nc" id="L282">        final MoneyWiseCurrency myCurrency = getAssetCurrency();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        return myCurrency == null ? null : myCurrency.getName();</span>
    }

    @Override
    public Currency getCurrency() {
<span class="fc" id="L288">        MoneyWiseCurrency myCurrency = getAssetCurrency();</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">        myCurrency = myCurrency == null</span>
<span class="nc" id="L290">                ? getDataSet().getReportingCurrency()</span>
<span class="fc" id="L291">                : myCurrency;</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">        return myCurrency == null ? null : myCurrency.getCurrency();</span>
    }

    /**
     * Obtain Opening Balance.
     * @return the Opening balance
     */
    public OceanusMoney getOpeningBalance() {
<span class="fc" id="L300">        return null;</span>
    }

    @Override
    public boolean isTaxFree() {
<span class="nc" id="L305">        return false;</span>
    }

    @Override
    public boolean isGross() {
<span class="nc" id="L310">        return false;</span>
    }

    @Override
    public boolean isForeign() {
<span class="nc" id="L315">        return false;</span>
    }

    /**
     * Get the close Date of the account.
     * @return the closeDate
     */
    public OceanusDate getCloseDate() {
<span class="fc" id="L323">        return theCloseDate;</span>
    }

    /**
     * Obtain Earliest transaction.
     * @return the event
     */
    public MoneyWiseTransaction getEarliest() {
<span class="fc" id="L331">        return theEarliest;</span>
    }

    /**
     * Obtain Latest Transaction.
     * @return the event
     */
    public MoneyWiseTransaction getLatest() {
<span class="fc" id="L339">        return theLatest;</span>
    }

    /**
     * Is the account relevant (i.e. non-closeable)?
     * @return true/false
     */
    public boolean isRelevant() {
<span class="fc" id="L347">        return isRelevant;</span>
    }

    @Override
    public boolean isAutoExpense() {
<span class="fc" id="L352">        return false;</span>
    }

    @Override
    public boolean isShares() {
<span class="nc" id="L357">        return false;</span>
    }

    @Override
    public boolean isCapital() {
<span class="nc" id="L362">        return false;</span>
    }

    @Override
    public boolean isHidden() {
<span class="fc" id="L367">        return false;</span>
    }

    @Override
    public MoneyWiseAssetType getAssetType() {
<span class="pc bpc" id="L372" title="4 of 7 branches missed.">        switch ((MoneyWiseBasicDataType) getItemType()) {</span>
            case DEPOSIT:
<span class="fc" id="L374">                return MoneyWiseAssetType.DEPOSIT;</span>
            case CASH:
<span class="nc" id="L376">                return MoneyWiseAssetType.CASH;</span>
            case LOAN:
<span class="fc" id="L378">                return MoneyWiseAssetType.LOAN;</span>
            case PORTFOLIO:
<span class="nc" id="L380">                return MoneyWiseAssetType.PORTFOLIO;</span>
            case SECURITY:
<span class="nc" id="L382">                return MoneyWiseAssetType.SECURITY;</span>
            case PAYEE:
<span class="fc" id="L384">                return MoneyWiseAssetType.PAYEE;</span>
            default:
<span class="nc" id="L386">                throw new IllegalStateException();</span>
        }
    }

    @Override
    public String getName() {
<span class="fc" id="L392">        return getValues().getValue(PrometheusDataResource.DATAITEM_FIELD_NAME, String.class);</span>
    }

    /**
     * Obtain Encrypted name.
     * @return the bytes
     */
    public byte[] getNameBytes() {
<span class="fc" id="L400">        return getValues().getEncryptedBytes(PrometheusDataResource.DATAITEM_FIELD_NAME);</span>
    }

    /**
     * Obtain Encrypted Name Field.
     * @return the Field
     */
    private PrometheusEncryptedPair getNameField() {
<span class="nc" id="L408">        return getValues().getEncryptedPair(PrometheusDataResource.DATAITEM_FIELD_NAME);</span>
    }

    /**
     * Obtain Description.
     * @return the description
     */
    public String getDesc() {
<span class="fc" id="L416">        return getValues().getValue(PrometheusDataResource.DATAITEM_FIELD_DESC, String.class);</span>
    }

    /**
     * Obtain Encrypted description.
     * @return the bytes
     */
    public byte[] getDescBytes() {
<span class="fc" id="L424">        return getValues().getEncryptedBytes(PrometheusDataResource.DATAITEM_FIELD_DESC);</span>
    }

    /**
     * Obtain Encrypted Description Field.
     * @return the Field
     */
    private PrometheusEncryptedPair getDescField() {
<span class="nc" id="L432">        return getValues().getEncryptedPair(PrometheusDataResource.DATAITEM_FIELD_DESC);</span>
    }

    @Override
    public Boolean isClosed() {
<span class="fc" id="L437">        return getValues().getValue(MoneyWiseBasicResource.ASSET_CLOSED, Boolean.class);</span>
    }

    @Override
    public boolean isDisabled() {
<span class="nc" id="L442">        return isClosed();</span>
    }

    /**
     * Set name value.
     * @param pValue the value
     * @throws OceanusException on error
     */
    private void setValueName(final String pValue) throws OceanusException {
<span class="fc" id="L451">        setEncryptedValue(PrometheusDataResource.DATAITEM_FIELD_NAME, pValue);</span>
<span class="fc" id="L452">    }</span>

    /**
     * Set name value.
     * @param pBytes the value
     * @throws OceanusException on error
     */
    private void setValueName(final byte[] pBytes) throws OceanusException {
<span class="fc" id="L460">        setEncryptedValue(PrometheusDataResource.DATAITEM_FIELD_NAME, pBytes, String.class);</span>
<span class="fc" id="L461">    }</span>

    /**
     * Set name value.
     * @param pValue the value
     */
    private void setValueName(final PrometheusEncryptedPair pValue) {
<span class="nc" id="L468">        getValues().setUncheckedValue(PrometheusDataResource.DATAITEM_FIELD_NAME, pValue);</span>
<span class="nc" id="L469">    }</span>

    /**
     * Set description value.
     * @param pValue the value
     * @throws OceanusException on error
     */
    private void setValueDesc(final String pValue) throws OceanusException {
<span class="nc" id="L477">        setEncryptedValue(PrometheusDataResource.DATAITEM_FIELD_DESC, pValue);</span>
<span class="nc" id="L478">    }</span>

    /**
     * Set description value.
     * @param pBytes the value
     * @throws OceanusException on error
     */
    private void setValueDesc(final byte[] pBytes) throws OceanusException {
<span class="nc" id="L486">        setEncryptedValue(PrometheusDataResource.DATAITEM_FIELD_DESC, pBytes, String.class);</span>
<span class="nc" id="L487">    }</span>

    /**
     * Set description value.
     * @param pValue the value
     */
    private void setValueDesc(final PrometheusEncryptedPair pValue) {
<span class="nc" id="L494">        getValues().setUncheckedValue(PrometheusDataResource.DATAITEM_FIELD_DESC, pValue);</span>
<span class="nc" id="L495">    }</span>

    /**
     * Set category value.
     * @param pValue the value
     */
    private void setValueCategory(final MoneyWiseAssetCategory pValue) {
<span class="fc" id="L502">        getValues().setUncheckedValue(MoneyWiseBasicResource.CATEGORY_NAME, pValue);</span>
<span class="fc" id="L503">    }</span>

    /**
     * Set category id.
     * @param pValue the value
     */
    private void setValueCategory(final Integer pValue) {
<span class="fc" id="L510">        getValues().setUncheckedValue(MoneyWiseBasicResource.CATEGORY_NAME, pValue);</span>
<span class="fc" id="L511">    }</span>

    /**
     * Set category name.
     * @param pValue the value
     */
    private void setValueCategory(final String pValue) {
<span class="fc" id="L518">        getValues().setUncheckedValue(MoneyWiseBasicResource.CATEGORY_NAME, pValue);</span>
<span class="fc" id="L519">    }</span>

    /**
     * Set parent value.
     * @param pValue the value
     */
    private void setValueParent(final MoneyWisePayee pValue) {
<span class="fc" id="L526">        getValues().setUncheckedValue(MoneyWiseBasicResource.ASSET_PARENT, pValue);</span>
<span class="fc" id="L527">    }</span>

    /**
     * Set parent id.
     * @param pValue the value
     */
    private void setValueParent(final Integer pValue) {
<span class="fc" id="L534">        getValues().setUncheckedValue(MoneyWiseBasicResource.ASSET_PARENT, pValue);</span>
<span class="fc" id="L535">    }</span>

    /**
     * Set parent name.
     * @param pValue the value
     */
    private void setValueParent(final String pValue) {
<span class="fc" id="L542">        getValues().setUncheckedValue(MoneyWiseBasicResource.ASSET_PARENT, pValue);</span>
<span class="fc" id="L543">    }</span>

    /**
     * Set currency value.
     * @param pValue the value
     */
    private void setValueCurrency(final MoneyWiseCurrency pValue) {
<span class="fc" id="L550">        getValues().setUncheckedValue(MoneyWiseStaticDataType.CURRENCY, pValue);</span>
<span class="fc" id="L551">    }</span>

    /**
     * Set currency id.
     * @param pValue the value
     */
    private void setValueCurrency(final Integer pValue) {
<span class="fc" id="L558">        getValues().setUncheckedValue(MoneyWiseStaticDataType.CURRENCY, pValue);</span>
<span class="fc" id="L559">    }</span>

    /**
     * Set currency name.
     * @param pValue the value
     */
    private void setValueCurrency(final String pValue) {
<span class="fc" id="L566">        getValues().setUncheckedValue(MoneyWiseStaticDataType.CURRENCY, pValue);</span>
<span class="fc" id="L567">    }</span>

    /**
     * Set closed indication.
     * @param pValue the value
     */
    private void setValueClosed(final Boolean pValue) {
<span class="fc" id="L574">        getValues().setUncheckedValue(MoneyWiseBasicResource.ASSET_CLOSED, pValue);</span>
<span class="fc" id="L575">    }</span>

    @Override
    public MoneyWiseDataSet getDataSet() {
<span class="fc" id="L579">        return (MoneyWiseDataSet) super.getDataSet();</span>
    }

    @Override
    public MoneyWiseAssetBaseList&lt;?&gt; getList() {
<span class="fc" id="L584">        return (MoneyWiseAssetBaseList&lt;?&gt;) super.getList();</span>
    }

    @Override
    public boolean isLocked() {
<span class="nc" id="L589">        return isClosed();</span>
    }

    /**
     * Set relevant.
     */
    public void setRelevant() {
<span class="fc" id="L596">        isRelevant = true;</span>
<span class="fc" id="L597">    }</span>

    /**
     * Obtain detailed category.
     * @param pCategory current category
     * @param pYear the taxYear
     * @return detailed category
     */
    public MoneyWiseTransCategory getDetailedCategory(final MoneyWiseTransCategory pCategory,
                                                      final MoneyWiseTaxCredit pYear) {
        /* return the unchanged category */
<span class="nc" id="L608">        return pCategory;</span>
    }

    /**
     * Adjust closed date.
     * @throws OceanusException on error
     */
    public void adjustClosed() throws OceanusException {
        /* Access latest activity date */
<span class="nc bnc" id="L617" title="All 2 branches missed.">        theCloseDate = theLatest == null ? null : theLatest.getDate();</span>
<span class="nc" id="L618">    }</span>

    @Override
    public void clearActive() {
        /* Reset flags */
<span class="fc" id="L623">        theCloseDate = null;</span>
<span class="fc" id="L624">        theEarliest = null;</span>
<span class="fc" id="L625">        theLatest = null;</span>
<span class="fc" id="L626">        isRelevant = false;</span>

        /* Pass call onwards */
<span class="fc" id="L629">        super.clearActive();</span>
<span class="fc" id="L630">    }</span>

    @Override
    public void touchItem(final PrometheusDataItem pSource) {
        /* If we are being touched by a transaction */
<span class="fc bfc" id="L635" title="All 2 branches covered.">        if (pSource instanceof MoneyWiseTransaction myTrans) {</span>
           /* Record the transaction */
<span class="fc bfc" id="L637" title="All 2 branches covered.">            if (theEarliest == null) {</span>
<span class="fc" id="L638">                theEarliest = myTrans;</span>
            }
<span class="fc" id="L640">            theLatest = myTrans;</span>

            /* if this transaction is not reconciled */
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">            if (!myTrans.isReconciled()) {</span>
                /* Mark account as relevant */
<span class="fc" id="L645">                setRelevant();</span>
            }

            /* Touch parent if it exists */
<span class="fc" id="L649">            final MoneyWiseAssetBase myParent = getParent();</span>
<span class="fc bfc" id="L650" title="All 2 branches covered.">            if (myParent != null) {</span>
<span class="fc" id="L651">                myParent.touchItem(pSource);</span>
            }
        }

        /* If we are being touched by an asset */
<span class="fc bfc" id="L656" title="All 2 branches covered.">        if (pSource instanceof MoneyWiseAssetBase myAsset) {</span>
            /* Mark as relevant if child is open */
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">            if (!myAsset.isClosed()) {</span>
<span class="fc" id="L659">                setRelevant();</span>
            }
        }

        /* Pass call onwards */
<span class="fc" id="L664">        super.touchItem(pSource);</span>
<span class="fc" id="L665">    }</span>

    @Override
    public void resolveDataSetLinks() throws OceanusException {
        /* Update the Encryption details */
<span class="fc" id="L670">        super.resolveDataSetLinks();</span>

        /* Resolve data links */
<span class="fc" id="L673">        final PrometheusEncryptedValues myValues = getValues();</span>

        /* Adjust Closed */
<span class="fc" id="L676">        final Object myClosed = myValues.getValue(MoneyWiseBasicResource.ASSET_CLOSED);</span>
<span class="fc bfc" id="L677" title="All 2 branches covered.">        if (myClosed == null) {</span>
<span class="fc" id="L678">            setValueClosed(Boolean.FALSE);</span>
        }
<span class="fc" id="L680">    }</span>

    /**
     * resolve EditSet links.
     * @throws OceanusException on error
     */
    protected abstract void resolveEditSetLinks() throws OceanusException;

    /**
     * Resolve late edit Set links.
     * @throws OceanusException on error
     */
    public void resolveLateEditSetLinks() throws OceanusException {
        /* Access the editSet */
<span class="fc" id="L694">        final PrometheusEditSet myEditSet = getList().getEditSet();</span>

        /* Resolve First/LastEvent if required */
<span class="fc" id="L697">        final MoneyWiseTransactionList myTransList = myEditSet.getDataList(MoneyWiseBasicDataType.TRANSACTION, MoneyWiseTransactionList.class);</span>
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">        if (theEarliest != null) {</span>
<span class="nc" id="L699">            theEarliest = myTransList.findItemById(theEarliest.getIndexedId());</span>
        }
<span class="pc bpc" id="L701" title="1 of 2 branches missed.">        if (theLatest != null) {</span>
<span class="nc" id="L702">            theLatest = myTransList.findItemById(theLatest.getIndexedId());</span>
        }
<span class="fc" id="L704">    }</span>

    /**
     * Set a new name.
     * @param pName the new name
     * @throws OceanusException on error
     */
    public void setName(final String pName) throws OceanusException {
<span class="fc" id="L712">        setValueName(pName);</span>
<span class="fc" id="L713">    }</span>

    /**
     * Set a new description.
     * @param pDesc the description
     * @throws OceanusException on error
     */
    public void setDescription(final String pDesc) throws OceanusException {
<span class="nc" id="L721">        setValueDesc(pDesc);</span>
<span class="nc" id="L722">    }</span>

    /**
     * Set a new category.
     * @param pCategory the new category
     */
    public void setCategory(final MoneyWiseAssetCategory pCategory) {
<span class="fc" id="L729">        setValueCategory(pCategory);</span>
<span class="fc" id="L730">    }</span>

    /**
     * Set a new currency.
     * @param pCurrency the new currency
     */
    public void setAssetCurrency(final MoneyWiseCurrency pCurrency) {
<span class="fc" id="L737">        setValueCurrency(pCurrency);</span>
<span class="fc" id="L738">    }</span>

    /**
     * Set a new parent.
     * @param pParent the parent
     */
    public void setParent(final MoneyWisePayee pParent) {
<span class="fc" id="L745">        setValueParent(pParent);</span>
<span class="fc" id="L746">    }</span>

    /**
     * Set a new closed indication.
     * @param isClosed the new closed indication
     */
    public void setClosed(final Boolean isClosed) {
<span class="fc" id="L753">        setValueClosed(isClosed);</span>
<span class="fc" id="L754">    }</span>

    /**
     * Update base asset from an edited asset.
     * @param pAsset the edited asset
     */
    protected void applyBasicChanges(final MoneyWiseAssetBase pAsset) {
        /* Update the name if required */
<span class="nc bnc" id="L762" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getName(), pAsset.getName())) {</span>
<span class="nc" id="L763">            setValueName(pAsset.getNameField());</span>
        }

        /* Update the description if required */
<span class="nc bnc" id="L767" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getDesc(), pAsset.getDesc())) {</span>
<span class="nc" id="L768">            setValueDesc(pAsset.getDescField());</span>
        }

        /* Update the category if required */
<span class="nc bnc" id="L772" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getCategory(), pAsset.getCategory())) {</span>
<span class="nc" id="L773">            setValueCategory(pAsset.getCategory());</span>
        }

        /* Update the parent if required */
<span class="nc bnc" id="L777" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getParent(), pAsset.getParent())) {</span>
<span class="nc" id="L778">            setValueParent(pAsset.getParent());</span>
        }

        /* Update the currency if required */
<span class="nc bnc" id="L782" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getAssetCurrency(), pAsset.getAssetCurrency())) {</span>
<span class="nc" id="L783">            setValueCurrency(pAsset.getAssetCurrency());</span>
        }

        /* Update the closed indication if required */
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(isClosed(), pAsset.isClosed())) {</span>
<span class="nc" id="L788">            setValueClosed(pAsset.isClosed());</span>
        }
<span class="nc" id="L790">    }</span>

    /**
     * The Asset List class.
     * @param &lt;T&gt; the dataType
     */
    public abstract static class MoneyWiseAssetBaseList&lt;T extends MoneyWiseAssetBase&gt;
            extends PrometheusEncryptedList&lt;T&gt; {
        /*
         * Report fields.
         */
        static {
<span class="fc" id="L802">            MetisFieldSet.newFieldSet(MoneyWiseAssetBaseList.class);</span>
<span class="fc" id="L803">        }</span>

        /**
         * The EditSet.
         */
        private PrometheusEditSet theEditSet;

        /**
         * Construct an empty CORE list.
         * @param pData the DataSet for the list
         * @param pClass the class of the item
         * @param pItemType the item type
         */
        protected MoneyWiseAssetBaseList(final MoneyWiseDataSet pData,
                                         final Class&lt;T&gt; pClass,
                                         final MoneyWiseBasicDataType pItemType) {
<span class="fc" id="L819">            super(pClass, pData, pItemType, PrometheusListStyle.CORE);</span>
<span class="fc" id="L820">        }</span>

        /**
         * Constructor for a cloned List.
         * @param pSource the source List
         */
        protected MoneyWiseAssetBaseList(final MoneyWiseAssetBaseList&lt;T&gt; pSource) {
<span class="fc" id="L827">            super(pSource);</span>
<span class="fc" id="L828">        }</span>

        @Override
        public MoneyWiseDataSet getDataSet() {
<span class="fc" id="L832">            return (MoneyWiseDataSet) super.getDataSet();</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public MoneyWiseDataValidatorAccount&lt;T&gt; getValidator() {
<span class="fc" id="L838">            return (MoneyWiseDataValidatorAccount&lt;T&gt;) super.getValidator();</span>
        }

        /**
         * Obtain editSet.
         * @return the editSet
         */
        public PrometheusEditSet getEditSet() {
<span class="fc" id="L846">            return theEditSet;</span>
        }

        /**
         * Set editSet.
         * @param pEditSet the editSet
         */
        protected void setEditSet(final PrometheusEditSet pEditSet) {
<span class="fc" id="L854">            theEditSet = pEditSet;</span>
<span class="fc" id="L855">        }</span>

        @Override
        public abstract T findItemByName(String pName);

        /**
         * Check whether a name is available for use.
         * @param pName Name of item
         * @return true/false
         */
        public abstract boolean checkAvailableName(String pName);

        /**
         * Check whether a name is validly used.
         * @param pName Name of item
         * @return true/false
         */
        public abstract boolean validNameCount(String pName);

        @Override
        public void postProcessOnLoad() throws OceanusException {
            /* Resolve links and sort the data */
<span class="nc" id="L877">            super.resolveDataSetLinks();</span>
<span class="nc" id="L878">            reSort();</span>

            /* Map the data */
<span class="nc" id="L881">            mapData();</span>
<span class="nc" id="L882">        }</span>

        /**
         * Resolve late edit Set links.
         * @throws OceanusException on error
         */
        public void resolveLateEditSetLinks() throws OceanusException {
<span class="fc" id="L889">            final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="fc bfc" id="L890" title="All 2 branches covered.">            while (myIterator.hasNext()) {</span>
<span class="fc" id="L891">                final T myItem = myIterator.next();</span>
<span class="fc" id="L892">                myItem.resolveLateEditSetLinks();</span>
<span class="fc" id="L893">            }</span>
<span class="fc" id="L894">        }</span>
    }

    /**
     * The dataMap class.
     */
<span class="fc" id="L900">    protected static class MoneyWiseAssetDataMap</span>
            extends PrometheusDataInstanceMap&lt;MoneyWiseAssetBase, String&gt; {
        @Override
        public void adjustForItem(final PrometheusDataItem pItem) {
            /* Access item */
<span class="fc" id="L905">            final MoneyWiseAssetBase myItem = (MoneyWiseAssetBase) pItem;</span>

            /* Adjust name count */
<span class="fc" id="L908">            adjustForItem(myItem, myItem.getName());</span>
<span class="fc" id="L909">        }</span>

        /**
         * find item by name.
         * @param pName the name to look up
         * @return the matching item
         */
        public MoneyWiseAssetBase findAssetByName(final String pName) {
<span class="fc" id="L917">            return findItemByKey(pName);</span>
        }

        /**
         * Check validity of name.
         * @param pName the name to look up
         * @return true/false
         */
        public boolean validNameCount(final String pName) {
<span class="fc" id="L926">            return validKeyCount(pName);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>