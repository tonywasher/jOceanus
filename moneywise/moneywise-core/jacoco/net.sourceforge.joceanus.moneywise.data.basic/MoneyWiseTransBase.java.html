<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseTransBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.moneywise.data.basic</a> &gt; <span class="el_source">MoneyWiseTransBase.java</span></div><h1>MoneyWiseTransBase.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * MoneyWise: Finance Application
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.moneywise.data.basic;

import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseCash.MoneyWiseCashList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDataValidator.MoneyWiseDataValidatorTrans;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseDeposit.MoneyWiseDepositList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseLoan.MoneyWiseLoanList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePayee.MoneyWisePayeeList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWisePortfolio.MoneyWisePortfolioList;
import net.sourceforge.joceanus.moneywise.data.basic.MoneyWiseSecurityHolding.MoneyWiseSecurityHoldingMap;
import net.sourceforge.joceanus.moneywise.data.statics.MoneyWiseTransCategoryClass;
import net.sourceforge.joceanus.moneywise.exc.MoneyWiseDataException;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataList.PrometheusDataListSet;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataResource;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataValues;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedDataItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedFieldSet;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedPair;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedValues;

/**
 * Transaction data type.
 * @author Tony Washer
 */
public abstract class MoneyWiseTransBase
        extends PrometheusEncryptedDataItem {
    /**
     * Object name.
     */
<span class="fc" id="L52">    public static final String OBJECT_NAME = MoneyWiseTransBase.class.getSimpleName();</span>

    /**
     * Blank character.
     */
    private static final char CHAR_BLANK = ' ';

    /**
     * Local Report fields.
     */
<span class="fc" id="L62">    private static final PrometheusEncryptedFieldSet&lt;MoneyWiseTransBase&gt; FIELD_DEFS = PrometheusEncryptedFieldSet.newEncryptedFieldSet(MoneyWiseTransBase.class);</span>

    /*
     * FieldIds.
     */
    static {
<span class="fc" id="L68">        FIELD_DEFS.declareLinkField(MoneyWiseBasicResource.TRANSACTION_ACCOUNT);</span>
<span class="fc" id="L69">        FIELD_DEFS.declareEnumField(MoneyWiseBasicResource.TRANSACTION_DIRECTION);</span>
<span class="fc" id="L70">        FIELD_DEFS.declareLinkField(MoneyWiseBasicResource.TRANSACTION_PARTNER);</span>
<span class="fc" id="L71">        FIELD_DEFS.declareEncryptedMoneyField(MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>
<span class="fc" id="L72">        FIELD_DEFS.declareLinkField(MoneyWiseBasicDataType.TRANSCATEGORY);</span>
<span class="fc" id="L73">        FIELD_DEFS.declareBooleanField(MoneyWiseBasicResource.TRANSACTION_RECONCILED);</span>
    }

    /**
     * Invalid Debit/Credit/Category Combination Error Text.
     */
<span class="fc" id="L79">    public static final String ERROR_COMBO = MoneyWiseBasicResource.TRANSACTION_ERROR_ASSETPAIR.getValue();</span>

    /**
     * Zero Amount Error Text.
     */
<span class="fc" id="L84">    protected static final String ERROR_ZEROAMOUNT = MoneyWiseBasicResource.TRANSACTION_ERROR_ZERO.getValue();</span>

    /**
     * Currency Error Text.
     */
<span class="fc" id="L89">    public static final String ERROR_CURRENCY = MoneyWiseBasicResource.MONEYWISEDATA_ERROR_CURRENCY.getValue();</span>

    /**
     * Copy Constructor.
     * @param pList the event list
     * @param pTrans The Transaction to copy
     */
    protected MoneyWiseTransBase(final MoneyWiseTransBaseList&lt;?&gt; pList,
                                 final MoneyWiseTransBase pTrans) {
        /* Set standard values */
<span class="fc" id="L99">        super(pList, pTrans);</span>
<span class="fc" id="L100">    }</span>

    /**
     * Edit constructor.
     * @param pList the list
     */
    protected MoneyWiseTransBase(final MoneyWiseTransBaseList&lt;?&gt; pList) {
<span class="fc" id="L107">        super(pList, 0);</span>
<span class="fc" id="L108">        setNextDataKeySet();</span>
<span class="fc" id="L109">        setValueReconciled(Boolean.FALSE);</span>
<span class="fc" id="L110">    }</span>

    /**
     * Values constructor.
     * @param pList the List to add to
     * @param pValues the values constructor
     * @throws OceanusException on error
     */
    protected MoneyWiseTransBase(final MoneyWiseTransBaseList&lt;?&gt; pList,
                                 final PrometheusDataValues pValues) throws OceanusException {
        /* Initialise the item */
<span class="fc" id="L121">        super(pList, pValues);</span>

        /* Access formatter */
<span class="fc" id="L124">        final OceanusDataFormatter myFormatter = getDataSet().getDataFormatter();</span>

        /* Protect against exceptions */
        try {
            /* Store the AssetPair */
<span class="fc" id="L129">            Object myValue = pValues.getValue(MoneyWiseBasicResource.TRANSACTION_DIRECTION);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">            if (myValue instanceof Boolean b) {</span>
<span class="fc" id="L131">                setValueDirection(b);</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L133">                setValueDirection(s);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            } else if (myValue instanceof MoneyWiseAssetDirection d) {</span>
<span class="nc" id="L135">                setValueDirection(d);</span>
            }

            /* Store the Account */
<span class="fc" id="L139">            myValue = pValues.getValue(MoneyWiseBasicResource.TRANSACTION_ACCOUNT);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">            if (myValue instanceof Long l) {</span>
<span class="fc" id="L141">                setValueAccount(l);</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L143">                setValueAccount(s);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            } else if (myValue instanceof MoneyWiseTransAsset a) {</span>
<span class="nc" id="L145">                setValueAccount(a);</span>
            }

            /* Store the Partner */
<span class="fc" id="L149">            myValue = pValues.getValue(MoneyWiseBasicResource.TRANSACTION_PARTNER);</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">            if (myValue instanceof Long l) {</span>
<span class="fc" id="L151">                setValuePartner(l);</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L153">                setValuePartner(s);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            } else if (myValue instanceof MoneyWiseTransAsset a) {</span>
<span class="nc" id="L155">                setValuePartner(a);</span>
            }

            /* Store the Category */
<span class="fc" id="L159">            myValue = pValues.getValue(MoneyWiseBasicDataType.TRANSCATEGORY);</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">            if (myValue instanceof Integer i) {</span>
<span class="fc" id="L161">                setValueCategory(i);</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="fc" id="L163">                setValueCategory(s);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            } else if (myValue instanceof MoneyWiseTransCategory c) {</span>
<span class="nc" id="L165">                setValueCategory(c);</span>
            }

            /* Store the Amount */
<span class="fc" id="L169">            myValue = pValues.getValue(MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">            if (myValue instanceof OceanusMoney m) {</span>
<span class="nc" id="L171">                setValueAmount(m);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">            } else if (myValue instanceof byte[] ba) {</span>
<span class="fc" id="L173">                setValueAmount(ba);</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">            } else if (myValue instanceof String myString) {</span>
<span class="fc" id="L175">                setValueAmount(myString);</span>
<span class="fc" id="L176">                setValueAmount(myFormatter.parseValue(myString, OceanusMoney.class));</span>
            }

            /* Store the reconciled flag */
<span class="fc" id="L180">            myValue = pValues.getValue(MoneyWiseBasicResource.TRANSACTION_RECONCILED);</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">            if (myValue instanceof Boolean b) {</span>
<span class="fc" id="L182">                setValueReconciled(b);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">            } else if (myValue instanceof String s) {</span>
<span class="nc" id="L184">                setValueReconciled(myFormatter.parseValue(s, Boolean.class));</span>
            }

            /* Catch Exceptions */
<span class="nc" id="L188">        } catch (IllegalArgumentException</span>
                 | OceanusException e) {
            /* Pass on exception */
<span class="nc" id="L191">            throw new MoneyWiseDataException(this, ERROR_CREATEITEM, e);</span>
<span class="fc" id="L192">        }</span>
<span class="fc" id="L193">    }</span>

    @Override
    public boolean includeXmlField(final MetisDataFieldId pField) {
        /* Determine whether fields should be included */
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (MoneyWiseBasicResource.TRANSACTION_DIRECTION.equals(pField)) {</span>
<span class="fc" id="L199">            return true;</span>
        }
<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (MoneyWiseBasicDataType.TRANSCATEGORY.equals(pField)) {</span>
<span class="fc" id="L202">            return true;</span>
        }
<span class="fc bfc" id="L204" title="All 2 branches covered.">        if (MoneyWiseBasicResource.TRANSACTION_ACCOUNT.equals(pField)) {</span>
<span class="fc" id="L205">            return true;</span>
        }
<span class="fc bfc" id="L207" title="All 2 branches covered.">        if (MoneyWiseBasicResource.TRANSACTION_PARTNER.equals(pField)) {</span>
<span class="fc" id="L208">            return true;</span>
        }
<span class="fc bfc" id="L210" title="All 2 branches covered.">        if (MoneyWiseBasicResource.TRANSACTION_AMOUNT.equals(pField)) {</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">            return getAmount() != null;</span>
        }
<span class="fc bfc" id="L213" title="All 2 branches covered.">        if (MoneyWiseBasicResource.TRANSACTION_RECONCILED.equals(pField)) {</span>
<span class="fc" id="L214">            return isReconciled();</span>
        }

        /* Pass call on */
<span class="fc" id="L218">        return super.includeXmlField(pField);</span>
    }

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L223">        return toString();</span>
    }

    @Override
    public String toString() {
        /* Handle header */
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (isHeader()) {</span>
<span class="nc" id="L230">            return PrometheusDataResource.DATAITEM_HEADER.getValue();</span>
        }

        /* Access Key Values */
<span class="nc" id="L234">        final PrometheusEncryptedValues myValues = getValues();</span>
<span class="nc" id="L235">        final Object myAccount = myValues.getValue(MoneyWiseBasicResource.TRANSACTION_ACCOUNT);</span>
<span class="nc" id="L236">        final Object myPartner = myValues.getValue(MoneyWiseBasicResource.TRANSACTION_PARTNER);</span>
<span class="nc" id="L237">        final Object myDir = myValues.getValue(MoneyWiseBasicResource.TRANSACTION_DIRECTION);</span>
<span class="nc" id="L238">        final Object myCategory = myValues.getValue(MoneyWiseBasicDataType.TRANSCATEGORY);</span>
<span class="nc" id="L239">        final Object myAmount = myValues.getValue(MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>

        /* Access formatter */
<span class="nc" id="L242">        final OceanusDataFormatter myFormatter = getDataSet().getDataFormatter();</span>

        /* Create string builder */
<span class="nc" id="L245">        final StringBuilder myBuilder = new StringBuilder();</span>
<span class="nc" id="L246">        myBuilder.append(myFormatter.formatObject(myCategory));</span>
<span class="nc" id="L247">        myBuilder.append(CHAR_BLANK);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        myBuilder.append(myAmount == null</span>
<span class="nc" id="L249">                ? &quot;&quot;</span>
<span class="nc" id="L250">                : myFormatter.formatObject(myAmount));</span>
<span class="nc" id="L251">        myBuilder.append(CHAR_BLANK);</span>
<span class="nc" id="L252">        myBuilder.append(myFormatter.formatObject(myAccount));</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (myDir == null) {</span>
<span class="nc" id="L254">            myBuilder.append(&quot;??&quot;);</span>
        } else {
<span class="nc bnc" id="L256" title="All 2 branches missed.">            myBuilder.append(MoneyWiseAssetDirection.FROM.equals(myDir)</span>
<span class="nc" id="L257">                    ? &quot;&lt;-&quot;</span>
<span class="nc" id="L258">                    : &quot;-&gt;&quot;);</span>
        }
<span class="nc" id="L260">        myBuilder.append(myFormatter.formatObject(myPartner));</span>

        /* return it */
<span class="nc" id="L263">        return myBuilder.toString();</span>
    }

    /**
     * Obtain category.
     * @return the category
     */
    public final MoneyWiseTransCategory getCategory() {
<span class="fc" id="L271">        return getValues().getValue(MoneyWiseBasicDataType.TRANSCATEGORY, MoneyWiseTransCategory.class);</span>
    }

    /**
     * Obtain CategoryId.
     * @return the categoryId
     */
    public Integer getCategoryId() {
<span class="fc" id="L279">        final MoneyWiseTransCategory myCategory = getCategory();</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">        return myCategory == null</span>
<span class="nc" id="L281">                ? null</span>
<span class="fc" id="L282">                : myCategory.getIndexedId();</span>
    }

    /**
     * Obtain categoryName.
     * @return the categoryName
     */
    public String getCategoryName() {
<span class="nc" id="L290">        final MoneyWiseTransCategory myCategory = getCategory();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        return myCategory == null</span>
<span class="nc" id="L292">                ? null</span>
<span class="nc" id="L293">                : myCategory.getName();</span>
    }

    /**
     * Obtain EventCategoryClass.
     * @return the eventCategoryClass
     */
    public MoneyWiseTransCategoryClass getCategoryClass() {
<span class="fc" id="L301">        final MoneyWiseTransCategory myCategory = getCategory();</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">        return myCategory == null</span>
<span class="nc" id="L303">                ? null</span>
<span class="fc" id="L304">                : myCategory.getCategoryTypeClass();</span>
    }

    /**
     * Obtain Amount.
     * @return the amount
     */
    public OceanusMoney getAmount() {
<span class="fc" id="L312">        return getValues().getValue(MoneyWiseBasicResource.TRANSACTION_AMOUNT, OceanusMoney.class);</span>
    }

    /**
     * Obtain Encrypted amount.
     * @return the bytes
     */
    public byte[] getAmountBytes() {
<span class="fc" id="L320">        return getValues().getEncryptedBytes(MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>
    }

    /**
     * Obtain Encrypted Amount Field.
     * @return the Field
     */
    protected PrometheusEncryptedPair getAmountField() {
<span class="nc" id="L328">        return getValues().getEncryptedPair(MoneyWiseBasicResource.TRANSACTION_AMOUNT);</span>
    }

    /**
     * Obtain Account asset.
     * @return the account
     */
    public MoneyWiseTransAsset getAccount() {
<span class="fc" id="L336">        return getValues().getValue(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, MoneyWiseTransAsset.class);</span>
    }

    /**
     * Obtain AccountId.
     * @return the accountId
     */
    public Long getAccountId() {
<span class="fc" id="L344">        final MoneyWiseTransAsset myAccount = getAccount();</span>
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">        return myAccount == null</span>
<span class="nc" id="L346">                ? null</span>
<span class="fc" id="L347">                : myAccount.getExternalId();</span>
    }

    /**
     * Obtain Partner asset.
     * @return the partner
     */
    public MoneyWiseTransAsset getPartner() {
<span class="fc" id="L355">        return getValues().getValue(MoneyWiseBasicResource.TRANSACTION_PARTNER, MoneyWiseTransAsset.class);</span>
    }

    /**
     * Obtain PartnerId.
     * @return the partnerId
     */
    public Long getPartnerId() {
<span class="fc" id="L363">        final MoneyWiseTransAsset myPartner = getPartner();</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">        return myPartner == null</span>
<span class="nc" id="L365">                ? null</span>
<span class="fc" id="L366">                : myPartner.getExternalId();</span>
    }

    /**
     * Obtain Direction.
     * @return the direction
     */
    public MoneyWiseAssetDirection getDirection() {
<span class="fc" id="L374">        return getValues().getValue(MoneyWiseBasicResource.TRANSACTION_DIRECTION, MoneyWiseAssetDirection.class);</span>
    }

    /**
     * Obtain Reconciled State.
     * @return the reconciled state
     */
    public Boolean isReconciled() {
<span class="fc" id="L382">        return getValues().getValue(MoneyWiseBasicResource.TRANSACTION_RECONCILED, Boolean.class);</span>
    }

    /**
     * Set category value.
     * @param pValue the value
     */
    private void setValueCategory(final MoneyWiseTransCategory pValue) {
<span class="fc" id="L390">        getValues().setUncheckedValue(MoneyWiseBasicDataType.TRANSCATEGORY, pValue);</span>
<span class="fc" id="L391">    }</span>

    /**
     * Set category id.
     * @param pId the id
     */
    private void setValueCategory(final Integer pId) {
<span class="fc" id="L398">        getValues().setUncheckedValue(MoneyWiseBasicDataType.TRANSCATEGORY, pId);</span>
<span class="fc" id="L399">    }</span>

    /**
     * Set category name.
     * @param pName the name
     */
    private void setValueCategory(final String pName) {
<span class="fc" id="L406">        getValues().setUncheckedValue(MoneyWiseBasicDataType.TRANSCATEGORY, pName);</span>
<span class="fc" id="L407">    }</span>

    /**
     * Set description value.
     * @param pValue the value
     * @throws OceanusException on error
     */
    private void setValueAmount(final OceanusMoney pValue) throws OceanusException {
<span class="fc" id="L415">        setEncryptedValue(MoneyWiseBasicResource.TRANSACTION_AMOUNT, pValue);</span>
<span class="fc" id="L416">    }</span>

    /**
     * Set amount value.
     * @param pBytes the value
     * @throws OceanusException on error
     */
    private void setValueAmount(final byte[] pBytes) throws OceanusException {
<span class="fc" id="L424">        setEncryptedValue(MoneyWiseBasicResource.TRANSACTION_AMOUNT, pBytes, OceanusMoney.class);</span>
<span class="fc" id="L425">    }</span>

    /**
     * Set amount value.
     * @param pValue the value
     */
    protected final void setValueAmount(final PrometheusEncryptedPair pValue) {
<span class="nc" id="L432">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_AMOUNT, pValue);</span>
<span class="nc" id="L433">    }</span>

    /**
     * Set amount value.
     * @param pValue the value
     */
    private void setValueAmount(final String pValue) {
<span class="fc" id="L440">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_AMOUNT, pValue);</span>
<span class="fc" id="L441">    }</span>

    /**
     * Set account value.
     * @param pValue the value
     */
    protected final void setValueAccount(final MoneyWiseTransAsset pValue) {
<span class="fc" id="L448">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, pValue);</span>
<span class="fc" id="L449">    }</span>

    /**
     * Set debit name.
     * @param pName the name
     */
    private void setValueAccount(final String pName) {
<span class="fc" id="L456">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, pName);</span>
<span class="fc" id="L457">    }</span>

    /**
     * Set debit id.
     * @param pId the value
     */
    private void setValueAccount(final Long pId) {
<span class="fc" id="L464">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_ACCOUNT, pId);</span>
<span class="fc" id="L465">    }</span>

    /**
     * Set partner value.
     * @param pValue the value
     */
    protected final void setValuePartner(final MoneyWiseTransAsset pValue) {
<span class="fc" id="L472">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_PARTNER, pValue);</span>
<span class="fc" id="L473">    }</span>

    /**
     * Set partner id.
     * @param pId the id
     */
    private void setValuePartner(final Long pId) {
<span class="fc" id="L480">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_PARTNER, pId);</span>
<span class="fc" id="L481">    }</span>

    /**
     * Set partner name.
     * @param pName the name
     */
    private void setValuePartner(final String pName) {
<span class="fc" id="L488">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_PARTNER, pName);</span>
<span class="fc" id="L489">    }</span>

    /**
     * Set direction state.
     * @param pValue the value
     */
    protected final void setValueDirection(final MoneyWiseAssetDirection pValue) {
<span class="fc" id="L496">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_DIRECTION, pValue);</span>
<span class="fc" id="L497">    }</span>

    /**
     * Set direction state.
     * @param pValue the value
     */
    private void setValueDirection(final Boolean pValue) {
<span class="fc bfc" id="L504" title="All 2 branches covered.">        final MoneyWiseAssetDirection myValue = Boolean.TRUE.equals(pValue)</span>
<span class="fc" id="L505">                ? MoneyWiseAssetDirection.FROM</span>
<span class="fc" id="L506">                : MoneyWiseAssetDirection.TO;</span>
<span class="fc" id="L507">        setValueDirection(myValue);</span>
<span class="fc" id="L508">    }</span>

    /**
     * Set direction state.
     * @param pValue the value
     */
    private void setValueDirection(final String pValue) {
<span class="fc" id="L515">        final MoneyWiseAssetDirection myValue = MoneyWiseAssetDirection.fromName(pValue);</span>
<span class="fc" id="L516">        setValueDirection(myValue);</span>
<span class="fc" id="L517">    }</span>

    /**
     * Set reconciled state.
     * @param pValue the value
     */
    protected final void setValueReconciled(final Boolean pValue) {
<span class="fc" id="L524">        getValues().setUncheckedValue(MoneyWiseBasicResource.TRANSACTION_RECONCILED, pValue);</span>
<span class="fc" id="L525">    }</span>

    @Override
    public final MoneyWiseDataSet getDataSet() {
<span class="fc" id="L529">        return (MoneyWiseDataSet) super.getDataSet();</span>
    }

    @Override
    public MoneyWiseTransBaseList&lt;?&gt; getList() {
<span class="fc" id="L534">        return (MoneyWiseTransBaseList&lt;?&gt;) super.getList();</span>
    }

    /**
     * Obtain portfolio for transaction.
     * @return the portfolio (or null)
     */
    public MoneyWisePortfolio getPortfolio() {
        /* Access account portfolio if it is a security holding */
<span class="nc" id="L543">        MoneyWiseTransAsset myAsset = getAccount();</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (myAsset instanceof MoneyWiseSecurityHolding myHolding) {</span>
<span class="nc" id="L545">            return myHolding.getPortfolio();</span>
        }

        /* Access partner portfolio if it is a security holding */
<span class="nc" id="L549">        myAsset = getPartner();</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (myAsset instanceof MoneyWiseSecurityHolding myHolding) {</span>
<span class="nc" id="L551">            return myHolding.getPortfolio();</span>
        }

        /* No portfolio */
<span class="nc" id="L555">        return null;</span>
    }

    /**
     * Compare this event to another to establish sort order.
     * @param pThat The Event to compare to
     * @return (-1,0,1) depending of whether this object is before, equal, or after the passed
     * object in the sort order
     */
    @Override
    public int compareValues(final PrometheusDataItem pThat) {
        /* Check the category */
<span class="fc" id="L567">        final MoneyWiseTransBase myThat = (MoneyWiseTransBase) pThat;</span>
<span class="fc" id="L568">        return MetisDataDifference.compareObject(getCategory(), myThat.getCategory());</span>
    }

    @Override
    public void resolveDataSetLinks() throws OceanusException {
        /* Update the Encryption details */
<span class="fc" id="L574">        super.resolveDataSetLinks();</span>

        /* Resolve data links */
<span class="fc" id="L577">        final MoneyWiseDataSet myData = getDataSet();</span>
<span class="fc" id="L578">        final PrometheusEncryptedValues myValues = getValues();</span>

        /* Adjust Reconciled */
<span class="fc" id="L581">        final Object myReconciled = myValues.getValue(MoneyWiseBasicResource.TRANSACTION_RECONCILED);</span>
<span class="fc bfc" id="L582" title="All 2 branches covered.">        if (myReconciled == null) {</span>
<span class="fc" id="L583">            setValueReconciled(Boolean.FALSE);</span>
        }

        /* Adjust Reconciled */
<span class="fc" id="L587">        final Object myDirection = myValues.getValue(MoneyWiseBasicResource.TRANSACTION_DIRECTION);</span>
<span class="pc bpc" id="L588" title="1 of 2 branches missed.">        if (myDirection == null) {</span>
<span class="nc" id="L589">            setValueDirection(MoneyWiseAssetDirection.TO);</span>
        }

        /* Resolve data links */
<span class="fc" id="L593">        resolveTransactionAsset(myData, this, MoneyWiseBasicResource.TRANSACTION_ACCOUNT);</span>
<span class="fc" id="L594">        resolveTransactionAsset(myData, this, MoneyWiseBasicResource.TRANSACTION_PARTNER);</span>
<span class="fc" id="L595">        resolveDataLink(MoneyWiseBasicDataType.TRANSCATEGORY, myData.getTransCategories());</span>
<span class="fc" id="L596">    }</span>

    @Override
    public boolean isLocked() {
<span class="nc" id="L600">        final MoneyWiseTransAsset myAccount = getAccount();</span>
<span class="nc" id="L601">        final MoneyWiseTransAsset myPartner = getPartner();</span>

        /* Check credit and debit accounts */
<span class="nc bnc" id="L604" title="All 6 branches missed.">        return (myAccount != null &amp;&amp; myAccount.isClosed())</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                || (myPartner != null &amp;&amp; myPartner.isClosed());</span>
    }

    /**
     * Is this event category the required class.
     * @param pClass the required category class.
     * @return true/false
     */
    public boolean isCategoryClass(final MoneyWiseTransCategoryClass pClass) {
        /* Check for match */
<span class="nc" id="L615">        return getCategoryClass().equals(pClass);</span>
    }

    /**
     * Determines whether an event is a dividend re-investment.
     * @return dividend re-investment true/false
     */
    public boolean isDividendReInvestment() {
        /* Check for dividend re-investment */
<span class="nc bnc" id="L624" title="All 2 branches missed.">        if (!isDividend()) {</span>
<span class="nc" id="L625">            return false;</span>
        }
<span class="nc bnc" id="L627" title="All 2 branches missed.">        return getAccount() != null</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">                &amp;&amp; MetisDataDifference.isEqual(getAccount(), getPartner());</span>
    }

    /**
     * Determines whether an event is an interest payment.
     * @return interest true/false
     */
    public boolean isInterest() {
        /* Check for interest */
<span class="nc" id="L637">        final MoneyWiseTransCategoryClass myClass = getCategoryClass();</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">        return myClass != null</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                &amp;&amp; myClass.isInterest();</span>
    }

    /**
     * Determines whether an event is a dividend payment.
     * @return dividend true/false
     */
    public boolean isDividend() {
<span class="nc" id="L647">        final MoneyWiseTransCategoryClass myClass = getCategoryClass();</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">        return myClass != null</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">                &amp;&amp; myClass.isDividend();</span>
    }

    /**
     * Determines whether an event needs a zero amount.
     * @return true/false
     */
    public boolean needsNullAmount() {
<span class="nc" id="L657">        final MoneyWiseTransCategoryClass myClass = getCategoryClass();</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">        return myClass != null</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">                &amp;&amp; myClass.needsNullAmount();</span>
    }

    /**
     * Determines whether we can switch direction.
     * @return true/false
     */
    public boolean canSwitchDirection() {
<span class="nc" id="L667">        return getList().getValidator().isValidDirection(getAccount(), getCategory(), getDirection().reverse());</span>
    }

    /**
     * Set a new account.
     * @param pAccount the account
     */
    public void setAccount(final MoneyWiseTransAsset pAccount) {
        /* Set account value */
<span class="fc" id="L676">        setValueAccount(pAccount);</span>
<span class="fc" id="L677">    }</span>

    /**
     * Set a new partner.
     * @param pPartner the partner
     */
    public void setPartner(final MoneyWiseTransAsset pPartner) {
        /* Set partner value */
<span class="fc" id="L685">        setValuePartner(pPartner);</span>
<span class="fc" id="L686">    }</span>

    /**
     * Set a direction.
     * @param pDirection the direction
     */
    public void setDirection(final MoneyWiseAssetDirection pDirection) {
        /* Set partner value */
<span class="fc" id="L694">        setValueDirection(pDirection);</span>
<span class="fc" id="L695">    }</span>

    /**
     * Switch direction.
     */
    public void switchDirection() {
<span class="nc" id="L701">         setValueDirection(getDirection().reverse());</span>
<span class="nc" id="L702">    }</span>

    /**
     * Flip assets.
     * @throws OceanusException on error
     */
    public void flipAssets() throws OceanusException {
        /* Flip details */
<span class="nc" id="L710">        final MoneyWiseTransAsset myAccount = getAccount();</span>
<span class="nc" id="L711">        final MoneyWiseTransAsset myPartner = getPartner();</span>
<span class="nc" id="L712">        setValueAccount(myPartner);</span>
<span class="nc" id="L713">        setValuePartner(myAccount);</span>
<span class="nc" id="L714">        switchDirection();</span>
<span class="nc" id="L715">    }</span>

    /**
     * Set a new category.
     * @param pCategory the category
     */
    public void setCategory(final MoneyWiseTransCategory pCategory) {
<span class="fc" id="L722">        setValueCategory(pCategory);</span>
<span class="fc" id="L723">    }</span>

    /**
     * Set a new amount.
     * @param pAmount the amount
     * @throws OceanusException on error
     */
    public void setAmount(final OceanusMoney pAmount) throws OceanusException {
<span class="fc" id="L731">        setValueAmount(pAmount);</span>
<span class="fc" id="L732">    }</span>

    /**
     * Set a reconciled indication.
     * @param pReconciled the reconciled state
     */
    public void setReconciled(final Boolean pReconciled) {
<span class="fc" id="L739">        setValueReconciled(pReconciled);</span>
<span class="fc" id="L740">    }</span>

    @Override
    public void touchUnderlyingItems() {
        /* touch the event category referred to */
<span class="fc" id="L745">        getCategory().touchItem(this);</span>

        /* Touch the account and partner */
<span class="fc" id="L748">        getAccount().touchItem(this);</span>
<span class="fc" id="L749">        getPartner().touchItem(this);</span>
<span class="fc" id="L750">    }</span>

    /**
     * Resolve transAsset.
     * @param pData the dataSet
     * @param pOwner the owning object
     * @param pField the fieldId
     * @throws OceanusException on error
     */
    public void resolveTransactionAsset(final PrometheusDataListSet pData,
                                        final PrometheusDataItem pOwner,
                                        final MetisDataFieldId pField) throws OceanusException {
        /* Obtain baseValue, and then resolve */
<span class="fc" id="L763">        final Object myBaseValue = pOwner.getValues().getValue(pField);</span>
<span class="fc" id="L764">        final Object myValue = resolveTransactionAsset(pData, myBaseValue);</span>
<span class="pc bpc" id="L765" title="1 of 2 branches missed.">        if (myValue == null) {</span>
<span class="nc" id="L766">            pOwner.addError(ERROR_UNKNOWN, pField);</span>
<span class="nc" id="L767">            throw new MoneyWiseDataException(this, ERROR_RESOLUTION);</span>
        }
<span class="fc" id="L769">        pOwner.getValues().setUncheckedValue(pField, myValue);</span>
<span class="fc" id="L770">    }</span>

    /**
     * Resolve transAsset.
     * @param pData the dataSet
     * @param pValue the value to convert
     * @return the asset
     * @throws OceanusException on error
     */
    private MoneyWiseTransAsset resolveTransactionAsset(final PrometheusDataListSet pData,
                                                        final Object pValue) throws OceanusException {
        /* If we are being passed a TransactionAsset, convert to Id */
<span class="fc" id="L782">        Object myValue = pValue;</span>
<span class="fc bfc" id="L783" title="All 2 branches covered.">        if (myValue instanceof MoneyWiseTransAsset myAsset) {</span>
<span class="fc" id="L784">            myValue = myAsset.getExternalId();</span>
        }

        /* Access the values */
<span class="fc bfc" id="L788" title="All 2 branches covered.">        if (myValue instanceof String s) {</span>
<span class="fc" id="L789">            return resolveTransAsset(pData, s);</span>
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">        } else if (myValue instanceof Long l) {</span>
<span class="fc" id="L791">            return resolveTransAsset(pData, l);</span>
        }
<span class="nc" id="L793">        return null;</span>
    }

    /**
     * Resolve transAsset.
     * @param pData the owning dataSet
     * @param pId the item id
     * @return the asset
     * @throws OceanusException on error
     */
    private static MoneyWiseTransAsset resolveTransAsset(final PrometheusDataListSet pData,
                                                         final Long pId) throws OceanusException {
         /* Access the assetType */
<span class="fc" id="L806">        final MoneyWiseAssetType myAssetType = MoneyWiseAssetType.getAssetType(pId);</span>

        /* If the name is a security holding */
<span class="fc bfc" id="L809" title="All 2 branches covered.">        if (myAssetType.isSecurityHolding()) {</span>
<span class="fc" id="L810">            final MoneyWiseSecurityHoldingMap myMap = pData.getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class).getSecurityHoldingsMap();</span>
<span class="fc" id="L811">            return myMap.findHoldingById(pId);</span>
<span class="fc bfc" id="L812" title="All 2 branches covered.">        } else if (myAssetType.isPayee()) {</span>
<span class="fc" id="L813">            return pData.getDataList(MoneyWiseBasicDataType.PAYEE, MoneyWisePayeeList.class).findItemById(MoneyWiseAssetType.getBaseId(pId));</span>
<span class="fc bfc" id="L814" title="All 2 branches covered.">        } else if (myAssetType.isDeposit()) {</span>
<span class="fc" id="L815">            return pData.getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class).findItemById(MoneyWiseAssetType.getBaseId(pId));</span>
<span class="fc bfc" id="L816" title="All 4 branches covered.">        } else if (myAssetType.isCash() || myAssetType.isAutoExpense()) {</span>
<span class="fc" id="L817">            return pData.getDataList(MoneyWiseBasicDataType.CASH, MoneyWiseCashList.class).findItemById(MoneyWiseAssetType.getBaseId(pId));</span>
<span class="pc bpc" id="L818" title="1 of 2 branches missed.">        } else if (myAssetType.isLoan()) {</span>
<span class="fc" id="L819">            return pData.getDataList(MoneyWiseBasicDataType.LOAN, MoneyWiseLoanList.class).findItemById(MoneyWiseAssetType.getBaseId(pId));</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">        } else if (myAssetType.isPortfolio()) {</span>
<span class="nc" id="L821">            return pData.getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class).findItemById(MoneyWiseAssetType.getBaseId(pId));</span>
        } else {
<span class="nc" id="L823">            return null;</span>
        }
    }

    /**
     * Resolve transAsset.
     * @param pData the owning dataSet
     * @param pName the item name
     * @return the asset
     */
    private static MoneyWiseTransAsset resolveTransAsset(final PrometheusDataListSet pData,
                                                         final String pName) {
        /* If the name is a security holding */
<span class="fc bfc" id="L836" title="All 2 branches covered.">        if (pName.contains(MoneyWiseSecurityHolding.SECURITYHOLDING_SEP)) {</span>
<span class="fc" id="L837">            final MoneyWiseSecurityHoldingMap myMap = pData.getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class).getSecurityHoldingsMap();</span>
<span class="fc" id="L838">            return myMap.findHoldingByName(pName);</span>
        } else {
<span class="fc" id="L840">            MoneyWiseTransAsset myAsset = pData.getDataList(MoneyWiseBasicDataType.PAYEE, MoneyWisePayeeList.class).findItemByName(pName);</span>
<span class="fc bfc" id="L841" title="All 2 branches covered.">            if (myAsset == null) {</span>
<span class="fc" id="L842">                myAsset = pData.getDataList(MoneyWiseBasicDataType.DEPOSIT, MoneyWiseDepositList.class).findItemByName(pName);</span>
            }
<span class="fc bfc" id="L844" title="All 2 branches covered.">            if (myAsset == null) {</span>
<span class="fc" id="L845">                myAsset = pData.getDataList(MoneyWiseBasicDataType.CASH, MoneyWiseCashList.class).findItemByName(pName);</span>
            }
<span class="fc bfc" id="L847" title="All 2 branches covered.">            if (myAsset == null) {</span>
<span class="fc" id="L848">                myAsset = pData.getDataList(MoneyWiseBasicDataType.LOAN, MoneyWiseLoanList.class).findItemByName(pName);</span>
            }
<span class="pc bpc" id="L850" title="1 of 2 branches missed.">            if (myAsset == null) {</span>
<span class="nc" id="L851">                myAsset = pData.getDataList(MoneyWiseBasicDataType.PORTFOLIO, MoneyWisePortfolioList.class).findItemByName(pName);</span>
            }
<span class="fc" id="L853">            return myAsset;</span>
        }
    }

    /**
     * Update base transaction from an edited transaction.
     * @param pTrans the edited transaction
     */
    protected void applyBasicChanges(final MoneyWiseTransBase pTrans) {
        /* Update the assetPair if required */
<span class="nc bnc" id="L863" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getDirection(), pTrans.getDirection())) {</span>
<span class="nc" id="L864">            setValueDirection(pTrans.getDirection());</span>
        }

        /* Update the category if required */
<span class="nc bnc" id="L868" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getCategory(), pTrans.getCategory())) {</span>
<span class="nc" id="L869">            setValueCategory(pTrans.getCategory());</span>
        }

        /* Update the account if required */
<span class="nc bnc" id="L873" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getAccount(), pTrans.getAccount())) {</span>
<span class="nc" id="L874">            setValueAccount(pTrans.getAccount());</span>
        }

        /* Update the partner if required */
<span class="nc bnc" id="L878" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getPartner(), pTrans.getPartner())) {</span>
<span class="nc" id="L879">            setValuePartner(pTrans.getPartner());</span>
        }

        /* Update the amount if required */
<span class="nc bnc" id="L883" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(getAmount(), pTrans.getAmount())) {</span>
<span class="nc" id="L884">            setValueAmount(pTrans.getAmountField());</span>
        }

        /* Update the reconciled state if required */
<span class="nc bnc" id="L888" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(isReconciled(), pTrans.isReconciled())) {</span>
<span class="nc" id="L889">            setValueReconciled(pTrans.isReconciled());</span>
        }
<span class="nc" id="L891">    }</span>

    /**
     * The Event List class.
     * @param &lt;T&gt; the dataType
     */
    public abstract static class MoneyWiseTransBaseList&lt;T extends MoneyWiseTransBase&gt;
            extends PrometheusEncryptedList&lt;T&gt; {
        /*
         * Report fields.
         */
        static {
<span class="fc" id="L903">            MetisFieldSet.newFieldSet(MoneyWiseTransBaseList.class);</span>
<span class="fc" id="L904">        }</span>

        /**
         * Construct an empty CORE Event list.
         * @param pData the DataSet for the list
         * @param pClass the class of the item
         * @param pItemType the item type
         */
        protected MoneyWiseTransBaseList(final MoneyWiseDataSet pData,
                                         final Class&lt;T&gt; pClass,
                                         final MoneyWiseBasicDataType pItemType) {
            /* Call super-constructor */
<span class="fc" id="L916">            super(pClass, pData, pItemType, PrometheusListStyle.CORE);</span>
<span class="fc" id="L917">        }</span>

        /**
         * Constructor for a cloned List.
         * @param pSource the source List
         */
        protected MoneyWiseTransBaseList(final MoneyWiseTransBaseList&lt;T&gt; pSource) {
            /* Call super-constructor */
<span class="fc" id="L925">            super(pSource);</span>
<span class="fc" id="L926">        }</span>

        @Override
        public MoneyWiseDataSet getDataSet() {
<span class="fc" id="L930">            return (MoneyWiseDataSet) super.getDataSet();</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public MoneyWiseDataValidatorTrans&lt;T&gt; getValidator() {
<span class="fc" id="L936">            return (MoneyWiseDataValidatorTrans&lt;T&gt;) super.getValidator();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>