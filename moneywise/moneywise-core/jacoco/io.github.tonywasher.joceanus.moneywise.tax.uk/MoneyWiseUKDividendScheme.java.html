<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoneyWiseUKDividendScheme.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MoneyWise Personal Finance - Core</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.moneywise.tax.uk</a> &gt; <span class="el_source">MoneyWiseUKDividendScheme.java</span></div><h1>MoneyWiseUKDividendScheme.java</h1><pre class="source lang-java linenums">/*
 * MoneyWise: Finance Application
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.moneywise.tax.uk;

import io.github.tonywasher.joceanus.oceanus.decimal.OceanusMoney;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusRate;
import io.github.tonywasher.joceanus.metis.field.MetisFieldSet;
import io.github.tonywasher.joceanus.moneywise.data.statics.MoneyWiseTaxClass;
import io.github.tonywasher.joceanus.moneywise.tax.MoneyWiseTaxBandSet.MoneyWiseTaxBand;
import io.github.tonywasher.joceanus.moneywise.tax.MoneyWiseTaxResource;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

/**
 * Dividend Tax Scheme.
 */
public abstract class MoneyWiseUKDividendScheme
        extends MoneyWiseUKIncomeScheme {
    /*
     * Local Report fields.
     */
    static {
<span class="fc" id="L39">        MetisFieldSet.newFieldSet(MoneyWiseUKDividendScheme.class);</span>
<span class="fc" id="L40">    }</span>

    /**
     * Constructor.
     */
    protected MoneyWiseUKDividendScheme() {
<span class="fc" id="L46">        this(Boolean.TRUE);</span>
<span class="fc" id="L47">    }</span>

    /**
     * Constructor.
     *
     * @param pReliefAvailable Is tax relief available?
     */
    protected MoneyWiseUKDividendScheme(final Boolean pReliefAvailable) {
<span class="fc" id="L55">        super(pReliefAvailable);</span>
<span class="fc" id="L56">    }</span>

    /**
     * Obtain theTaxCredit rate for dividend.
     *
     * @param pTaxYear the taxYear
     * @return the taxCredit rate
     */
    protected abstract OceanusRate getTaxCreditRate(MoneyWiseUKTaxYear pTaxYear);

    @Override
    protected OceanusMoney adjustAllowances(final MoneyWiseUKTaxConfig pConfig,
                                            final OceanusMoney pAmount) {
        /* Adjust against the basic allowance */
<span class="nc" id="L70">        final OceanusMoney myRemaining = super.adjustAllowances(pConfig, pAmount);</span>

        /* If we have any dividends left */
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (myRemaining.isNonZero()) {</span>
            /* Adjust the dividend allowance noting that it still counts against the taxBand */
<span class="nc" id="L75">            adjustForAllowance(pConfig.getDividendAllowance(), myRemaining);</span>
        }

        /* Return unallocated income */
<span class="nc" id="L79">        return myRemaining;</span>
    }

    @Override
    protected OceanusMoney getAmountInAllowance(final MoneyWiseUKTaxConfig pConfig,
                                                final OceanusMoney pAmount) {
        /* Obtain the amount covered by the basic allowance */
<span class="nc" id="L86">        OceanusMoney myAmount = super.getAmountInAllowance(pConfig, pAmount);</span>

        /* If we have income left over */
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (myAmount.compareTo(pAmount) &lt; 0) {</span>
            /* Calculate remaining amount */
<span class="nc" id="L91">            final OceanusMoney myRemaining = new OceanusMoney(pAmount);</span>
<span class="nc" id="L92">            myRemaining.subtractAmount(myAmount);</span>

            /* Calculate the amount covered by dividend allowance */
<span class="nc" id="L95">            final OceanusMoney myXtra = getAmountInBand(pConfig.getDividendAllowance(), myRemaining);</span>

            /* Determine the total amount covered by the allowance */
<span class="nc" id="L98">            myAmount = new OceanusMoney(myAmount);</span>
<span class="nc" id="L99">            myAmount.addAmount(myXtra);</span>
        }

        /* return the amount */
<span class="nc" id="L103">        return myAmount;</span>
    }

    /**
     * Obtain the base rate.
     *
     * @return the base rate
     */
    protected OceanusRate getBaseRate() {
<span class="nc" id="L112">        return null;</span>
    }

    /**
     * Obtain the higher rate.
     *
     * @return the higher rate
     */
    protected OceanusRate getHigherRate() {
<span class="nc" id="L121">        return null;</span>
    }

    /**
     * Obtain the additional rate.
     *
     * @return the additional rate
     */
    protected OceanusRate getAdditionalRate() {
<span class="nc" id="L130">        return null;</span>
    }

    @Override
    protected Iterator&lt;MoneyWiseTaxBand&gt; taxBandIterator(final MoneyWiseUKTaxConfig pConfig,
                                                         final MoneyWiseTaxClass pBasis) {

        /* Create a new List */
<span class="nc" id="L138">        final List&lt;MoneyWiseTaxBand&gt; myList = new ArrayList&lt;&gt;();</span>

        /* Access underlying iterator */
<span class="nc" id="L141">        final Iterator&lt;MoneyWiseTaxBand&gt; myIterator = super.taxBandIterator(pConfig, pBasis);</span>
<span class="nc" id="L142">        MoneyWiseTaxBand myBand = myIterator.next();</span>
<span class="nc" id="L143">        OceanusMoney myAmount = myBand.getAmount();</span>
<span class="nc" id="L144">        OceanusRate myRate = getBaseRate();</span>

        /* If we are a LoHigher instance */
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (this instanceof MoneyWiseUKDividendLoHigherRateScheme) {</span>
            /* Access the true basic band and merge in the lower rate */
<span class="nc" id="L149">            myBand = myIterator.next();</span>
<span class="nc" id="L150">            myAmount = new OceanusMoney(myAmount);</span>
<span class="nc" id="L151">            myAmount.addAmount(myBand.getAmount());</span>
        }

        /* Add the basic band */
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (myRate == null) {</span>
<span class="nc" id="L156">            myRate = myBand.getRate();</span>
        }
<span class="nc" id="L158">        myList.add(new MoneyWiseTaxBand(myAmount, myRate));</span>

        /* If we have a &quot;higher&quot; band */
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (myIterator.hasNext()) {</span>
            /* Add the higher band */
<span class="nc" id="L163">            myBand = myIterator.next();</span>
<span class="nc" id="L164">            myRate = getHigherRate();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (myRate == null) {</span>
<span class="nc" id="L166">                myRate = myBand.getRate();</span>
            }
<span class="nc" id="L168">            myList.add(new MoneyWiseTaxBand(myBand.getAmount(), myRate));</span>
        }

        /* If we have an &quot;additional&quot; band */
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (myIterator.hasNext()) {</span>
            /* Add the higher band */
<span class="nc" id="L174">            myBand = myIterator.next();</span>
<span class="nc" id="L175">            myRate = getAdditionalRate();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (myRate == null) {</span>
<span class="nc" id="L177">                myRate = myBand.getRate();</span>
            }
<span class="nc" id="L179">            myList.add(new MoneyWiseTaxBand(myBand.getAmount(), myRate));</span>
        }

        /* Loop through remaining tax bands */
<span class="nc bnc" id="L183" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L184">            myBand = myIterator.next();</span>
<span class="nc" id="L185">            myList.add(myBand);</span>
        }

        /* Return the iterator */
<span class="nc" id="L189">        return myList.iterator();</span>
    }

    /**
     * As Income Scheme.
     */
    public static class MoneyWiseUKDividendAsIncomeScheme
            extends MoneyWiseUKDividendScheme {
        /**
         * Local Report fields.
         */
<span class="fc" id="L200">        private static final MetisFieldSet&lt;MoneyWiseUKDividendAsIncomeScheme&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseUKDividendAsIncomeScheme.class);</span>

        /**
         * Constructor.
         */
<span class="fc" id="L205">        protected MoneyWiseUKDividendAsIncomeScheme() {</span>
<span class="fc" id="L206">        }</span>

        @Override
        protected OceanusRate getTaxCreditRate(final MoneyWiseUKTaxYear pTaxYear) {
<span class="nc" id="L210">            return pTaxYear.getTaxBands().getBasicTaxRate();</span>
        }

        @Override
        public MetisFieldSet&lt;MoneyWiseUKDividendAsIncomeScheme&gt; getDataFieldSet() {
<span class="nc" id="L215">            return FIELD_DEFS;</span>
        }
    }

    /**
     * Base Rate Scheme.
     */
    public static class MoneyWiseUKDividendBaseRateScheme
            extends MoneyWiseUKDividendScheme {
        /**
         * Local Report fields.
         */
<span class="fc" id="L227">        private static final MetisFieldSet&lt;MoneyWiseUKDividendBaseRateScheme&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseUKDividendBaseRateScheme.class);</span>

        /*
         * Declare Fields.
         */
        static {
<span class="fc" id="L233">            FIELD_DEFS.declareLocalField(MoneyWiseTaxResource.SCHEME_BASE_RATE, MoneyWiseUKDividendBaseRateScheme::getBaseRate);</span>
<span class="fc" id="L234">        }</span>

        /**
         * The Base Rate.
         */
        private final OceanusRate theBaseRate;

        /**
         * Constructor.
         *
         * @param pRate            the base rate
         * @param pReliefAvailable Is tax relief available?
         */
        protected MoneyWiseUKDividendBaseRateScheme(final OceanusRate pRate,
                                                    final Boolean pReliefAvailable) {
<span class="fc" id="L249">            super(pReliefAvailable);</span>
<span class="fc" id="L250">            theBaseRate = pRate;</span>
<span class="fc" id="L251">        }</span>

        /**
         * Constructor.
         *
         * @param pRate the base rate
         */
        protected MoneyWiseUKDividendBaseRateScheme(final OceanusRate pRate) {
<span class="fc" id="L259">            this(pRate, Boolean.TRUE);</span>
<span class="fc" id="L260">        }</span>

        @Override
        protected OceanusRate getBaseRate() {
<span class="nc" id="L264">            return theBaseRate;</span>
        }

        @Override
        protected OceanusRate getTaxCreditRate(final MoneyWiseUKTaxYear pTaxYear) {
<span class="nc" id="L269">            return theBaseRate;</span>
        }

        @Override
        public MetisFieldSet&lt;? extends MoneyWiseUKDividendBaseRateScheme&gt; getDataFieldSet() {
<span class="nc" id="L274">            return FIELD_DEFS;</span>
        }
    }

    /**
     * Higher Rate Scheme.
     */
    public static class MoneyWiseUKDividendHigherRateScheme
            extends MoneyWiseUKDividendBaseRateScheme {
        /**
         * Local Report fields.
         */
<span class="fc" id="L286">        private static final MetisFieldSet&lt;MoneyWiseUKDividendHigherRateScheme&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseUKDividendHigherRateScheme.class);</span>

        /*
         * Declare Fields.
         */
        static {
<span class="fc" id="L292">            FIELD_DEFS.declareLocalField(MoneyWiseTaxResource.SCHEME_HIGH_RATE, MoneyWiseUKDividendHigherRateScheme::getHigherRate);</span>
<span class="fc" id="L293">        }</span>

        /**
         * The Higher Rate.
         */
        private final OceanusRate theHighRate;

        /**
         * Constructor.
         *
         * @param pRate     the base rate
         * @param pHighRate the higher rate
         */
        protected MoneyWiseUKDividendHigherRateScheme(final OceanusRate pRate,
                                                      final OceanusRate pHighRate) {
<span class="fc" id="L308">            this(pRate, pHighRate, Boolean.FALSE);</span>
<span class="fc" id="L309">        }</span>

        /**
         * Constructor.
         *
         * @param pRate            the base rate
         * @param pHighRate        the higher rate
         * @param pReliefAvailable Is tax relief available?
         */
        protected MoneyWiseUKDividendHigherRateScheme(final OceanusRate pRate,
                                                      final OceanusRate pHighRate,
                                                      final Boolean pReliefAvailable) {
<span class="fc" id="L321">            super(pRate, pReliefAvailable);</span>
<span class="fc" id="L322">            theHighRate = pHighRate;</span>
<span class="fc" id="L323">        }</span>

        @Override
        protected OceanusRate getHigherRate() {
<span class="nc" id="L327">            return theHighRate;</span>
        }

        @Override
        public MetisFieldSet&lt;? extends MoneyWiseUKDividendHigherRateScheme&gt; getDataFieldSet() {
<span class="nc" id="L332">            return FIELD_DEFS;</span>
        }
    }

    /**
     * LoHigher Rate Scheme.
     */
    public static class MoneyWiseUKDividendLoHigherRateScheme
            extends MoneyWiseUKDividendHigherRateScheme {
        /**
         * Local Report fields.
         */
<span class="fc" id="L344">        private static final MetisFieldSet&lt;MoneyWiseUKDividendLoHigherRateScheme&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseUKDividendLoHigherRateScheme.class);</span>

        /**
         * Constructor.
         *
         * @param pRate       the base rate
         * @param pHigherRate the higher rate
         */
        protected MoneyWiseUKDividendLoHigherRateScheme(final OceanusRate pRate,
                                                        final OceanusRate pHigherRate) {
<span class="fc" id="L354">            super(pRate, pHigherRate);</span>
<span class="fc" id="L355">        }</span>

        @Override
        public MetisFieldSet&lt;MoneyWiseUKDividendLoHigherRateScheme&gt; getDataFieldSet() {
<span class="nc" id="L359">            return FIELD_DEFS;</span>
        }
    }

    /**
     * Additional Rate Scheme.
     */
    public static class MoneyWiseUKDividendAdditionalRateScheme
            extends MoneyWiseUKDividendHigherRateScheme {
        /**
         * Local Report fields.
         */
<span class="fc" id="L371">        private static final MetisFieldSet&lt;MoneyWiseUKDividendAdditionalRateScheme&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(MoneyWiseUKDividendAdditionalRateScheme.class);</span>

        /*
         * Declare Fields.
         */
        static {
<span class="fc" id="L377">            FIELD_DEFS.declareLocalField(MoneyWiseTaxResource.SCHEME_ADDITIONAL_RATE, MoneyWiseUKDividendHigherRateScheme::getAdditionalRate);</span>
<span class="fc" id="L378">        }</span>

        /**
         * The Additional Rate.
         */
        private final OceanusRate theAdditionalRate;

        /**
         * Constructor.
         *
         * @param pRate     the base rate
         * @param pHighRate the higher rate
         * @param pAddRate  the additional rate
         */
        protected MoneyWiseUKDividendAdditionalRateScheme(final OceanusRate pRate,
                                                          final OceanusRate pHighRate,
                                                          final OceanusRate pAddRate) {
<span class="fc" id="L395">            this(pRate, pHighRate, pAddRate, Boolean.FALSE);</span>
<span class="fc" id="L396">        }</span>

        /**
         * Constructor.
         *
         * @param pRate            the base rate
         * @param pHighRate        the higher rate
         * @param pAddRate         the additional rate
         * @param pReliefAvailable Is tax relief available?
         */
        protected MoneyWiseUKDividendAdditionalRateScheme(final OceanusRate pRate,
                                                          final OceanusRate pHighRate,
                                                          final OceanusRate pAddRate,
                                                          final Boolean pReliefAvailable) {
<span class="fc" id="L410">            super(pRate, pHighRate, pReliefAvailable);</span>
<span class="fc" id="L411">            theAdditionalRate = pAddRate;</span>
<span class="fc" id="L412">        }</span>

        @Override
        protected OceanusRate getAdditionalRate() {
<span class="nc" id="L416">            return theAdditionalRate;</span>
        }

        @Override
        public MetisFieldSet&lt;MoneyWiseUKDividendAdditionalRateScheme&gt; getDataFieldSet() {
<span class="nc" id="L421">            return FIELD_DEFS;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>