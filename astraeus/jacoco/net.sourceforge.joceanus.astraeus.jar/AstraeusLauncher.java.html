<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AstraeusLauncher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jOceanus Post Processing</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.astraeus.jar</a> &gt; <span class="el_source">AstraeusLauncher.java</span></div><h1>AstraeusLauncher.java</h1><pre class="source lang-java linenums">/* *****************************************************************************
 * Astraeus: Post-Processing
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/
package net.sourceforge.joceanus.astraeus.jar;

import net.sourceforge.joceanus.astraeus.exc.AstraeusException;
import net.sourceforge.joceanus.oceanus.base.OceanusSystem;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.nio.charset.StandardCharsets;
import java.util.Objects;
import java.util.jar.Attributes;
import java.util.jar.Manifest;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

/**
 * Launcher utilities.
 */
public final class AstraeusLauncher {
    /**
     * Are we windows?
     */
<span class="fc" id="L43">    private static final boolean OS_WINDOWS = OceanusSystem.WINDOWS.equals(OceanusSystem.determineSystem());</span>

    /**
     * NewLine character.
     */
    private static final String NEWLINE = &quot;\n&quot;;

    /**
     * Resources directory.
     */
    private static final String RESOURCES = &quot;../resources&quot;;

    /**
     * Private constructor.
     */
    private AstraeusLauncher() {
    }

    /**
     * Create launchers for jars in directory.
     * @param pDirectory the directory.
     * @throws AstraeusException on error
     */
    public static void processJarFiles(final File pDirectory) throws AstraeusException {
        /* Loop through the jar files in the directory */
<span class="fc bfc" id="L68" title="All 2 branches covered.">        for (File myJar: Objects.requireNonNull(pDirectory.listFiles(f -&gt; f.getName().endsWith(&quot;.jar&quot;)))) {</span>
            /* Process jar file */
<span class="fc" id="L70">            final Manifest myManifest = loadManifest(myJar);</span>
<span class="fc" id="L71">            writeLauncher(myJar, myManifest.getMainAttributes());</span>
        }
<span class="fc" id="L73">    }</span>

    /**
     * Write launcher.
     * @param pJar the Jar file.
     * @param pAttrs the attributes
     * @throws AstraeusException on error
     */
    private static void writeLauncher(final File pJar,
                                      final Attributes pAttrs) throws AstraeusException {
        /* Access details */
<span class="fc" id="L84">        final String myPreLoader = pAttrs.getValue(&quot;JavaFX-Preloader-Class&quot;);</span>
<span class="fc" id="L85">        final String myMainClass = pAttrs.getValue(&quot;Main-Class&quot;);</span>
<span class="fc" id="L86">        final String myClassPath = pAttrs.getValue(&quot;Class-Path&quot;);</span>
<span class="fc" id="L87">        final String mySplash = pAttrs.getValue(&quot;SplashScreen-Image&quot;);</span>
<span class="fc" id="L88">        final String myModule = pAttrs.getValue(&quot;Automatic-Module-Name&quot;);</span>

        /* If there is no mainClass, then just return */
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        if (myMainClass == null) {</span>
<span class="nc" id="L92">            return;</span>
        }

        /* Create the StringBuilder */
<span class="fc" id="L96">        final StringBuilder myBuilder = new StringBuilder();</span>
<span class="fc" id="L97">        final String myName = pJar.getName();</span>

        /* Output the header */
<span class="fc" id="L100">        myBuilder.append(getBatchHeader())</span>
<span class="fc" id="L101">                .append(getComment(&quot;make sure that we are in the same directory as the jar file&quot;))</span>
<span class="fc" id="L102">                .append(setDirectory());</span>

        /* Report details */
<span class="fc" id="L105">        myBuilder.append(getComment(&quot;set up details of the jarFile&quot;))</span>
<span class="fc" id="L106">                .append(setVariable(&quot;JARFILE&quot;)).append(myName).append(NEWLINE)</span>
<span class="fc" id="L107">                .append(setVariable(&quot;MODULE&quot;)).append(myModule).append(NEWLINE)</span>
<span class="fc" id="L108">                .append(setVariable(&quot;MAIN&quot;)).append(myMainClass).append(NEWLINE);</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (myPreLoader != null) {</span>
<span class="fc" id="L110">            myBuilder.append(setVariable(&quot;PRELOADER&quot;)).append(myPreLoader).append(NEWLINE);</span>
        }
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (mySplash != null) {</span>
<span class="fc" id="L113">            myBuilder.append(setVariable(&quot;SPLASH&quot;)).append(RESOURCES).append(&quot;/&quot;).append(mySplash).append(NEWLINE);</span>
<span class="fc" id="L114">            extractSplash(pJar, mySplash);</span>
        }
<span class="fc" id="L116">        myBuilder.append(NEWLINE);</span>

        /* Obtain and process the classPath */
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        if (myClassPath != null) {</span>
<span class="fc" id="L120">            final String[] myClasses = myClassPath.split(&quot; &quot;);</span>
<span class="fc" id="L121">            myBuilder.append(getComment(&quot;build the modulePath from the classPath&quot;));</span>
<span class="fc" id="L122">            myBuilder.append(setVariable(&quot;JARS&quot;)).append(myClasses[0]).append(NEWLINE);</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">            for (int i = 1; i &lt; myClasses.length; i++) {</span>
<span class="fc" id="L124">                myBuilder.append(setVariable(&quot;JARS&quot;)).append(getValue(&quot;JARS&quot;)).append(File.pathSeparatorChar).append(myClasses[i]).append(NEWLINE);</span>
            }
<span class="fc" id="L126">            myBuilder.append(NEWLINE);</span>
        }

        /* Output the commandLine */
<span class="fc" id="L130">        myBuilder.append(getComment(&quot;run the jar&quot;));</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (OS_WINDOWS) {</span>
<span class="fc" id="L132">            myBuilder.append(&quot;start /B &quot;);</span>
        }
<span class="fc" id="L134">        myBuilder.append(&quot;..&quot;).append(File.separatorChar).append(&quot;java&quot;).append(File.separatorChar)</span>
<span class="fc" id="L135">                .append(&quot;bin&quot;).append(File.separatorChar).append(&quot;java &quot;);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (myPreLoader != null) {</span>
<span class="fc" id="L137">            myBuilder.append(&quot;-Djavafx.preloader=&quot;).append(getValue(&quot;PRELOADER&quot;)).append(&quot; &quot;);</span>
        }
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (mySplash != null) {</span>
<span class="fc" id="L140">            myBuilder.append(&quot;-splash:&quot;).append(getValue(&quot;SPLASH&quot;)).append(&quot; &quot;);</span>
        }
<span class="fc" id="L142">        myBuilder.append(&quot;-p &quot;).append(getValue(&quot;JARFILE&quot;));</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (myClassPath != null) {</span>
<span class="fc" id="L144">            myBuilder.append(File.pathSeparatorChar).append(getValue(&quot;JARS&quot;));</span>
        }
<span class="fc" id="L146">        myBuilder.append(&quot; -m &quot;).append(getValue(&quot;MODULE&quot;)).append(&quot;/&quot;).append(getValue(&quot;MAIN&quot;));</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">        if (!OS_WINDOWS) {</span>
<span class="nc" id="L148">            myBuilder.append(&quot; &amp;&quot;);</span>
        }
<span class="fc" id="L150">        myBuilder.append(getBatchTrailer());</span>

        /* determine the launch file name */
<span class="fc" id="L153">        final String mySuffix = &quot;-&quot; + pAttrs.getValue(&quot;Implementation-Version&quot;) + &quot;.jar&quot;;</span>
<span class="fc" id="L154">        final String myFileName = myName.substring(0, myName.length() - mySuffix.length()) + getBatchSuffix();</span>
<span class="fc" id="L155">        final File myOutFile = new File(pJar.getParent(), myFileName);</span>
<span class="fc" id="L156">        writeBatchFile(myOutFile, myBuilder.toString());</span>
<span class="fc" id="L157">    }</span>

    /**
     * Load Manifest.
     * @param pJar the Jar file.
     * @return the manifest
     * @throws AstraeusException on error
     */
    private static Manifest loadManifest(final File pJar) throws AstraeusException {
<span class="fc" id="L166">        try (FileInputStream myInStream = new FileInputStream(pJar);</span>
<span class="fc" id="L167">             BufferedInputStream myInBuffer = new BufferedInputStream(myInStream);</span>
<span class="fc" id="L168">             ZipInputStream myZipStream = new ZipInputStream(myInBuffer)) {</span>
            /* Loop through the Zip file entries */
            for (;;) {
                /* Read next entry */
<span class="fc" id="L172">                final ZipEntry myEntry = myZipStream.getNextEntry();</span>

                /* If this is EOF we did not find the manifest */
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">                if (myEntry == null) {</span>
<span class="nc" id="L176">                    throw new AstraeusException(&quot;Manifest not found&quot;);</span>
                }

                /* Process manifest file if found */
<span class="fc bfc" id="L180" title="All 2 branches covered.">                if (&quot;META-INF/MANIFEST.MF&quot;.equals(myEntry.getName())) {</span>
<span class="fc" id="L181">                    return new Manifest(myZipStream);</span>
                }
<span class="fc" id="L183">            }</span>

            /* Handle exceptions */
<span class="nc" id="L186">        } catch (IOException e) {</span>
<span class="nc" id="L187">            throw new AstraeusException(&quot;Exception accessing Zip file&quot;, e);</span>
        }
    }

    /**
     * Extract splash file.
     * @param pJar the Jar file.
     * @param pSplash the path to the splash file
     * @throws AstraeusException on error
     */
    private static void extractSplash(final File pJar,
                                      final String pSplash) throws AstraeusException {
<span class="fc" id="L199">        try (FileInputStream myInStream = new FileInputStream(pJar);</span>
<span class="fc" id="L200">             BufferedInputStream myInBuffer = new BufferedInputStream(myInStream);</span>
<span class="fc" id="L201">             ZipInputStream myZipStream = new ZipInputStream(myInBuffer)) {</span>
            /* Loop through the Zip file entries */
            for (;;) {
                /* Read next entry */
<span class="fc" id="L205">                final ZipEntry myEntry = myZipStream.getNextEntry();</span>

                /* If this is EOF we did not find the manifest */
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">                if (myEntry == null) {</span>
<span class="nc" id="L209">                    throw new AstraeusException(&quot;Splash not found&quot;);</span>
                }

                /* Process manifest file if found */
<span class="fc bfc" id="L213" title="All 2 branches covered.">                if (pSplash.equals(myEntry.getName())) {</span>
                    /* Determine location for splashFile */
<span class="fc" id="L215">                    final File myBase = new File(pJar.getParent(), RESOURCES);</span>
<span class="fc" id="L216">                    final File myTarget = new File(myBase, pSplash);</span>
<span class="fc" id="L217">                    final File myDir = new File(myTarget.getParent());</span>

                    /* If we created the directory OK */
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">                    if (myDir.mkdirs()) {</span>
                        /* Copy the splashScreen */
<span class="fc" id="L222">                        try (FileOutputStream myStream = new FileOutputStream(myTarget)) {</span>
<span class="fc" id="L223">                            myZipStream.transferTo(myStream);</span>
                        }
                    }

                    /* Return */
<span class="fc" id="L228">                    return;</span>
                }
<span class="fc" id="L230">            }</span>

            /* Handle exceptions */
<span class="nc" id="L233">        } catch (IOException e) {</span>
<span class="nc" id="L234">            throw new AstraeusException(&quot;Exception copying Splash file&quot;, e);</span>
        }
    }

    /**
     * Write batchFile.
     * @param pTarget the target batchFile.
     * @param pText the contents of the batch file
     * @throws AstraeusException on error
     */
    private static void writeBatchFile(final File pTarget,
                                       final String pText) throws AstraeusException {
<span class="fc" id="L246">        try (FileOutputStream myOutput = new FileOutputStream(pTarget);</span>
<span class="fc" id="L247">             BufferedOutputStream myBuffer = new BufferedOutputStream(myOutput);</span>
<span class="fc" id="L248">             OutputStreamWriter myWriter = new OutputStreamWriter(myBuffer, StandardCharsets.UTF_8)) {</span>
            /* Write the text to the file */
<span class="fc" id="L250">            myWriter.write(pText);</span>

            /* Handle exceptions */
<span class="nc" id="L253">        } catch (IOException e) {</span>
<span class="nc" id="L254">            throw new AstraeusException(&quot;Exception writing batch file&quot;, e);</span>
<span class="fc" id="L255">        }</span>

        /* Try to make file executable */
<span class="pc bpc" id="L258" title="3 of 4 branches missed.">        if (!OS_WINDOWS &amp;&amp; !pTarget.setExecutable(true)) {</span>
<span class="nc" id="L259">            throw new AstraeusException(&quot;Failed to set executable indication&quot;);</span>
        }
<span class="fc" id="L261">    }</span>

    /**
     * Obtain the batch file header.
     * @return the header.
     */
    private static String getBatchHeader() {
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">        return OS_WINDOWS ? &quot;@echo off\nsetlocal\n\n&quot; : &quot;#!/usr/bin/ksh\n\n&quot;;</span>
    }

    /**
     * Obtain the batch setDirectory command.
     * @return the command.
     */
    private static String setDirectory() {
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">        return OS_WINDOWS ? &quot;cd %0\\..\n\n&quot; : &quot;cd $(dirname %0)\n\n&quot;;</span>
    }

    /**
     * Obtain the batch file trailer.
     * @return the trailer.
     */
    private static String getBatchTrailer() {
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">        return OS_WINDOWS ? &quot;\n\nendlocal\n&quot; : &quot;\n\n&quot;;</span>
    }

    /**
     * Obtain the batch file comment.
     * @param pComment the comment
     * @return the comment.
     */
    private static String getComment(final String pComment) {
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">        return (OS_WINDOWS ? &quot;rem &quot; : &quot;# &quot;) + pComment + NEWLINE;</span>
    }

    /**
     * Set a variable's value.
     * @param pVar the variable
     * @return the set clause.
     */
    private static String setVariable(final String pVar) {
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">        return (OS_WINDOWS ? &quot;set &quot; : &quot;&quot;) + pVar + '=';</span>
    }

    /**
     * Obtain a variable's value.
     * @param pVar the variable
     * @return the value.
     */
    private static String getValue(final String pVar) {
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        return OS_WINDOWS ? &quot;%&quot; + pVar + &quot;%&quot; : &quot;$&quot; + pVar;</span>
    }

    /**
     * Obtain the batch suffix.
     * @return the suffix.
     */
    private static String getBatchSuffix() {
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">        return OS_WINDOWS ? &quot;.bat&quot; : &quot;.ksh&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>