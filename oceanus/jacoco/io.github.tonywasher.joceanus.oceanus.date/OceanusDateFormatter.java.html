<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OceanusDateFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Oceanus Java Core Utilities</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.oceanus.date</a> &gt; <span class="el_source">OceanusDateFormatter.java</span></div><h1>OceanusDateFormatter.java</h1><pre class="source lang-java linenums">/*
 * Oceanus: Java Utilities
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.oceanus.date;

import io.github.tonywasher.joceanus.oceanus.base.OceanusLocale;
import io.github.tonywasher.joceanus.oceanus.convert.OceanusDataConverter;
import io.github.tonywasher.joceanus.oceanus.event.OceanusEventManager;
import io.github.tonywasher.joceanus.oceanus.event.OceanusEventRegistrar;
import io.github.tonywasher.joceanus.oceanus.event.OceanusEventRegistrar.OceanusEventProvider;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.Calendar;
import java.util.Date;
import java.util.Locale;

/**
 * Formatter for Date objects.
 *
 * @author Tony Washer
 */
public class OceanusDateFormatter
        implements OceanusEventProvider&lt;OceanusDateEvent&gt; {
    /**
     * Date Byte length.
     */
    public static final int BYTE_LEN = Long.BYTES;

    /**
     * As of Java 16.0.2 the short format for September is Sept instead of Sep.
     */
    private static final int PATCH_JAVA_VER = 16;

    /**
     * As of Java 16.0.2 the short format for September is Sept instead of Sep.
     */
    private static final String PATCH_SEPT_NEW = &quot;-Sept-&quot;;

    /**
     * As of Java 16.0.2 the short format for September is Sept instead of Sep.
     */
    private static final String PATCH_SEPT_OLD = &quot;-Sep-&quot;;

    /**
     * The default format.
     */
    private static final String DEFAULT_FORMAT = &quot;dd-MMM-yyyy&quot;;

    /**
     * One hundred years.
     */
    private static final int YEARS_CENTURY = 100;

    /**
     * The Event Manager.
     */
    private final OceanusEventManager&lt;OceanusDateEvent&gt; theEventManager;

    /**
     * The locale.
     */
    private Locale theLocale;

    /**
     * The Simple Date format for the locale and format string.
     */
    private String theFormat;

    /**
     * The Simple Date format for the locale and format string.
     */
    private SimpleDateFormat theDateFormat;

    /**
     * The DateTime format for the locale and format string.
     */
    private DateTimeFormatter theLocalDateFormat;

    /**
     * Constructor.
     */
    public OceanusDateFormatter() {
        /* Use default locale */
<span class="fc" id="L101">        this(OceanusLocale.getDefaultLocale());</span>
<span class="fc" id="L102">    }</span>

    /**
     * Constructor.
     *
     * @param pLocale the locale
     */
<span class="fc" id="L109">    public OceanusDateFormatter(final Locale pLocale) {</span>
        /* Store locale */
<span class="fc" id="L111">        theLocale = pLocale;</span>
<span class="fc" id="L112">        theEventManager = new OceanusEventManager&lt;&gt;();</span>
<span class="fc" id="L113">        setFormat(DEFAULT_FORMAT);</span>
<span class="fc" id="L114">    }</span>

    @Override
    public OceanusEventRegistrar&lt;OceanusDateEvent&gt; getEventRegistrar() {
<span class="nc" id="L118">        return theEventManager.getEventRegistrar();</span>
    }

    /**
     * Set the date format.
     *
     * @param pFormat the format string
     */
    public final void setFormat(final String pFormat) {
        /* If the format is the same */
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (pFormat.equals(theFormat)) {</span>
            /* Ignore */
<span class="nc" id="L130">            return;</span>
        }

        /* Create the simple date format */
<span class="fc" id="L134">        theFormat = pFormat;</span>
<span class="fc" id="L135">        theDateFormat = new SimpleDateFormat(theFormat, theLocale);</span>
<span class="fc" id="L136">        theLocalDateFormat = DateTimeFormatter.ofPattern(theFormat, theLocale);</span>

        /* Notify of the change */
<span class="fc" id="L139">        theEventManager.fireEvent(OceanusDateEvent.FORMATCHANGED);</span>
<span class="fc" id="L140">    }</span>

    /**
     * Set the locale.
     *
     * @param pLocale the locale
     */
    public final void setLocale(final Locale pLocale) {
        /* If the locale is the same */
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (theLocale.equals(pLocale)) {</span>
            /* Ignore */
<span class="nc" id="L151">            return;</span>
        }

        /* Store the locale */
<span class="nc" id="L155">        theLocale = pLocale;</span>
<span class="nc" id="L156">        final String pFormat = theFormat;</span>
<span class="nc" id="L157">        theFormat = null;</span>
<span class="nc" id="L158">        setFormat(pFormat);</span>
<span class="nc" id="L159">    }</span>

    /**
     * Format a calendar Date.
     *
     * @param pDate the date to format
     * @return the formatted date
     */
    public String formatCalendarDay(final Calendar pDate) {
        /* Handle null */
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (pDate == null) {</span>
<span class="nc" id="L170">            return null;</span>
        }

        /* Format the date */
<span class="nc" id="L174">        return formatJavaDate(pDate.getTime());</span>
    }

    /**
     * Format a local Date.
     *
     * @param pDate the date to format
     * @return the formatted date
     */
    public String formatLocalDate(final LocalDate pDate) {
        /* Handle null */
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (pDate == null) {</span>
<span class="nc" id="L186">            return null;</span>
        }

        /* Format the date */
<span class="nc" id="L190">        return pDate.format(theLocalDateFormat);</span>
    }

    /**
     * Format a java Date.
     *
     * @param pDate the date to format
     * @return the formatted date
     */
    public String formatJavaDate(final Date pDate) {
        /* Handle null */
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (pDate == null) {</span>
<span class="nc" id="L202">            return null;</span>
        }

        /* Format the date */
<span class="nc" id="L206">        return theDateFormat.format(pDate);</span>
    }

    /**
     * Format a Date.
     *
     * @param pDate the date to format
     * @return the formatted date
     */
    public String formatDate(final OceanusDate pDate) {
        /* Handle null */
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (pDate == null) {</span>
<span class="nc" id="L218">            return null;</span>
        }

        /* Format the date */
<span class="nc" id="L222">        return formatLocalDate(pDate.getDate());</span>
    }

    /**
     * Format a DateRange.
     *
     * @param pRange the range to format
     * @return the formatted date
     */
    public String formatDateRange(final OceanusDateRange pRange) {
        /* Handle null */
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (pRange == null) {</span>
<span class="nc" id="L234">            return null;</span>
        }

        /* Access components */
<span class="nc" id="L238">        final OceanusDate myStart = pRange.getStart();</span>
<span class="nc" id="L239">        final OceanusDate myEnd = pRange.getEnd();</span>

        /* Build range description */
<span class="nc bnc" id="L242" title="All 2 branches missed.">        return ((myStart == null)</span>
<span class="nc" id="L243">                ? OceanusDateRange.DESC_UNBOUNDED</span>
<span class="nc" id="L244">                : formatDate(myStart))</span>
                + OceanusDateRange.CHAR_BLANK
                + OceanusDateRange.DESC_LINK
                + OceanusDateRange.CHAR_BLANK
<span class="nc bnc" id="L248" title="All 2 branches missed.">                + ((myEnd == null)</span>
<span class="nc" id="L249">                ? OceanusDateRange.DESC_UNBOUNDED</span>
<span class="nc" id="L250">                : formatDate(myEnd));</span>
    }

    /**
     * Parse Java Date.
     *
     * @param pValue Formatted Date
     * @return the Date
     * @throws IllegalArgumentException on error
     */
    public Date parseJavaDate(final String pValue) {
        /* Parse the date */
        try {
<span class="nc" id="L263">            return theDateFormat.parse(pValue);</span>
<span class="nc" id="L264">        } catch (ParseException e) {</span>
<span class="nc" id="L265">            throw new IllegalArgumentException(&quot;Invalid date: &quot;</span>
                    + pValue, e);
        }
    }

    /**
     * Parse LocalDate.
     *
     * @param pValue Formatted Date
     * @return the Date
     * @throws IllegalArgumentException on error
     */
    public LocalDate parseLocalDate(final String pValue) {
        /* Parse the date */
        try {
<span class="nc" id="L280">            return LocalDate.parse(pValue, theLocalDateFormat);</span>
<span class="nc" id="L281">        } catch (DateTimeParseException e) {</span>
            /* Handle Patch for Java 16.0.2 change for September */
<span class="nc" id="L283">            final int myVersion = Runtime.version().feature();</span>
<span class="nc bnc" id="L284" title="All 4 branches missed.">            if (pValue.contains(PATCH_SEPT_OLD)</span>
                    &amp;&amp; myVersion &gt;= PATCH_JAVA_VER) {
<span class="nc" id="L286">                return parsePatchedLocalDate(pValue.replace(PATCH_SEPT_OLD, PATCH_SEPT_NEW));</span>
            }
<span class="nc bnc" id="L288" title="All 2 branches missed.">            if (pValue.contains(PATCH_SEPT_NEW)</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                    &amp;&amp; Runtime.version().feature() &lt; PATCH_JAVA_VER) {</span>
<span class="nc" id="L290">                return parsePatchedLocalDate(pValue.replace(PATCH_SEPT_NEW, PATCH_SEPT_OLD));</span>
            }

            /* throw exception */
<span class="nc" id="L294">            throw new IllegalArgumentException(&quot;Invalid date: &quot;</span>
                    + pValue, e);
        }
    }

    /**
     * Parse LocalDate.
     *
     * @param pValue Formatted Date
     * @return the Date
     * @throws IllegalArgumentException on error
     */
    private LocalDate parsePatchedLocalDate(final String pValue) {
        /* Parse the date */
        try {
<span class="nc" id="L309">            return LocalDate.parse(pValue, theLocalDateFormat);</span>
<span class="nc" id="L310">        } catch (DateTimeParseException e) {</span>
            /* throw exception */
<span class="nc" id="L312">            throw new IllegalArgumentException(&quot;Invalid date: &quot;</span>
                    + pValue, e);
        }
    }

    /**
     * Parse CalendarDay.
     *
     * @param pValue Formatted CalendarDay
     * @return the CalendarDay
     * @throws IllegalArgumentException on error
     */
    public Calendar parseCalendarDay(final String pValue) {
<span class="nc" id="L325">        final Date myDate = parseJavaDate(pValue);</span>
<span class="nc" id="L326">        final Calendar myCalendar = Calendar.getInstance(theLocale);</span>
<span class="nc" id="L327">        myCalendar.setTime(myDate);</span>
<span class="nc" id="L328">        return myCalendar;</span>
    }

    /**
     * Parse Date.
     *
     * @param pValue Formatted Date
     * @return the DateDay
     * @throws IllegalArgumentException on error
     */
    public OceanusDate parseDate(final String pValue) {
<span class="nc" id="L339">        final LocalDate myDate = parseLocalDate(pValue);</span>
<span class="nc" id="L340">        return new OceanusDate(myDate);</span>
    }

    /**
     * Parse Date using the passed year as base date.
     * &lt;p&gt;
     * This is used when a two digit year is utilised
     *
     * @param pValue    Formatted DateDay
     * @param pBaseYear the base year
     * @return the DateDay
     * @throws IllegalArgumentException on error
     */
    public OceanusDate parseDateBase(final String pValue,
                                     final int pBaseYear) {
<span class="nc" id="L355">        LocalDate myDate = parseLocalDate(pValue);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (myDate.getYear() &gt;= pBaseYear + YEARS_CENTURY) {</span>
<span class="nc" id="L357">            myDate = myDate.minusYears(YEARS_CENTURY);</span>
        }
<span class="nc" id="L359">        return new OceanusDate(myDate);</span>
    }

    /**
     * Obtain the locale.
     *
     * @return the locale
     */
    public Locale getLocale() {
<span class="nc" id="L368">        return theLocale;</span>
    }

    /**
     * Create a byte array representation of a date.
     *
     * @param pDate the date to process
     * @return the processed date
     */
    public byte[] toBytes(final OceanusDate pDate) {
<span class="fc" id="L378">        final long myEpoch = pDate.getDate().toEpochDay();</span>
<span class="fc" id="L379">        return OceanusDataConverter.longToByteArray(myEpoch);</span>
    }

    /**
     * Parse a byte array representation of a date.
     *
     * @param pBuffer the byte representation
     * @return the date
     */
    public OceanusDate fromBytes(final byte[] pBuffer) {
<span class="pc bpc" id="L389" title="2 of 4 branches missed.">        if (pBuffer == null || pBuffer.length &lt; Long.BYTES) {</span>
<span class="nc" id="L390">            throw new IllegalArgumentException();</span>
        }
<span class="fc" id="L392">        final long myEpoch = OceanusDataConverter.byteArrayToLong(pBuffer);</span>
<span class="fc" id="L393">        final LocalDate myDate = LocalDate.ofEpochDay(myEpoch);</span>
<span class="fc" id="L394">        return new OceanusDate(myDate);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>