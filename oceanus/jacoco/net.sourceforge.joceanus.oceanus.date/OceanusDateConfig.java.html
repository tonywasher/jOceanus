<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OceanusDateConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Oceanus Java Core Utilities</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.oceanus.date</a> &gt; <span class="el_source">OceanusDateConfig.java</span></div><h1>OceanusDateConfig.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Oceanus: Java Utilities
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/
package net.sourceforge.joceanus.oceanus.date;

import java.time.LocalDate;
import java.util.Locale;
import java.util.function.Predicate;

import net.sourceforge.joceanus.oceanus.event.OceanusEventManager;
import net.sourceforge.joceanus.oceanus.event.OceanusEventRegistrar;
import net.sourceforge.joceanus.oceanus.event.OceanusEventRegistrar.OceanusEventProvider;

/**
 * Date Configuration.
 */
public class OceanusDateConfig
        implements OceanusEventProvider&lt;OceanusDateEvent&gt; {
    /**
     * The Event Manager.
     */
    private final OceanusEventManager&lt;OceanusDateEvent&gt; theEventManager;

    /**
     * The formatter.
     */
    private final OceanusDateFormatter theFormatter;

    /**
     * The Locale.
     */
    private Locale theLocale;

    /**
     * Show Narrow days.
     */
    private boolean doShowNarrowDays;

    /**
     * Allow null date selection.
     */
    private boolean allowNullDateSelection;

    /**
     * The selected date.
     */
    private OceanusDate theSelected;

    /**
     * The earliest select-able date (or null if no lower bound).
     */
    private OceanusDate theEarliest;

    /**
     * The latest select-able date (or null if no upper bound).
     */
    private OceanusDate theLatest;

    /**
     * The list of disallowed dates.
     */
    private Predicate&lt;OceanusDate&gt; theAllowed;

    /**
     * The active display month.
     */
    private OceanusDate theMonth;

    /**
     * Constructor.
     * @param pFormatter the date formatter
     */
<span class="nc" id="L86">    public OceanusDateConfig(final OceanusDateFormatter pFormatter) {</span>
        /* Create resources */
<span class="nc" id="L88">        theFormatter = pFormatter;</span>
<span class="nc" id="L89">        theEventManager = new OceanusEventManager&lt;&gt;();</span>
<span class="nc" id="L90">        setLocale(pFormatter.getLocale());</span>

        /* Initialise the allowed predicate */
<span class="nc" id="L93">        theAllowed = d -&gt; true;</span>

        /* Listen to locale changes */
<span class="nc" id="L96">        theFormatter.getEventRegistrar().addEventListener(e -&gt; setLocale(theFormatter.getLocale()));</span>
<span class="nc" id="L97">    }</span>

    @Override
    public OceanusEventRegistrar&lt;OceanusDateEvent&gt; getEventRegistrar() {
<span class="nc" id="L101">        return theEventManager.getEventRegistrar();</span>
    }

    /**
     * Get the locale.
     * @return the locale
     */
    public Locale getLocale() {
<span class="nc" id="L109">        return theLocale;</span>
    }

    /**
     * Get the selected date.
     * @return the Selected date
     */
    public OceanusDate getSelectedDate() {
<span class="nc" id="L117">        return theSelected;</span>
    }

    /**
     * Get the earliest select-able date.
     * @return the Earliest date
     */
    public OceanusDate getEarliestDate() {
<span class="nc" id="L125">        return theEarliest;</span>
    }

    /**
     * Get the latest select-able date.
     * @return the Latest date
     */
    public OceanusDate getLatestDate() {
<span class="nc" id="L133">        return theLatest;</span>
    }

    /**
     * Get the current month.
     * @return the current month
     */
    public OceanusDate getCurrentMonth() {
<span class="nc" id="L141">        return theMonth;</span>
    }

    /**
     * Allow Null Date selection.
     * @return true/false
     */
    public boolean allowNullDateSelection() {
<span class="nc" id="L149">        return allowNullDateSelection;</span>
    }

    /**
     * Show Narrow Days.
     * @return true/false
     */
    public boolean showNarrowDays() {
<span class="nc" id="L157">        return doShowNarrowDays;</span>
    }

    /**
     * Set the Allowed predicate.
     * @param pAllowed the predicate
     */
    public void setAllowed(final Predicate&lt;OceanusDate&gt; pAllowed) {
<span class="nc" id="L165">        theAllowed = pAllowed;</span>
<span class="nc" id="L166">    }</span>

    /**
     * Determine whether the day in the month is allowed.
     * @param pDay the day of the current month
     * @return true/false
     */
    public boolean isAllowed(final int pDay) {
<span class="nc" id="L174">        final OceanusDate myDate = new OceanusDate(theMonth);</span>
<span class="nc" id="L175">        myDate.adjustDay(pDay - 1);</span>
<span class="nc" id="L176">        return theAllowed.test(myDate);</span>
    }

    /**
     * Set the Locale.
     * @param pLocale the Locale
     */
    public final void setLocale(final Locale pLocale) {
        /* Store locale */
<span class="nc" id="L185">        theLocale = pLocale;</span>

        /* Request rebuild of names */
<span class="nc" id="L188">        rebuildNames();</span>
<span class="nc" id="L189">    }</span>

    /**
     * Allow null date selection. If this flag is set an additional button will be displayed
     * allowing the user to explicitly select no date, thus setting the SelectedDate to null.
     * @param pAllowNullDateSelection true/false
     */
    public void setAllowNullDateSelection(final boolean pAllowNullDateSelection) {
<span class="nc" id="L197">        allowNullDateSelection = pAllowNullDateSelection;</span>
<span class="nc" id="L198">    }</span>

    /**
     * Show Narrow Days. If this flag is set Days are show in narrow rather than short form.
     * @param pShowNarrowDays true/false
     */
    public void setShowNarrowDays(final boolean pShowNarrowDays) {
        /* Set options */
<span class="nc" id="L206">        doShowNarrowDays = pShowNarrowDays;</span>

        /* Request rebuild of names */
<span class="nc" id="L209">        rebuildNames();</span>
<span class="nc" id="L210">    }</span>

    /**
     * Rebuild names.
     */
    protected final void rebuildNames() {
        /* Fire event */
<span class="nc" id="L217">        theEventManager.fireEvent(OceanusDateEvent.FORMATCHANGED);</span>
<span class="nc" id="L218">    }</span>

    /**
     * Set the earliest date. This is the earliest date that may be selected. If the configured
     * latest date is earlier than this date, it will be set to this date to ensure a valid range.
     * @param pEarliest the Earliest select-able date (or null if unlimited)
     */
    public final void setEarliestDate(final OceanusDate pEarliest) {
        /* Default the field to null */
<span class="nc" id="L227">        theEarliest = null;</span>

        /* If we have an earliest */
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (pEarliest != null) {</span>
            /* Store the date */
<span class="nc" id="L232">            theEarliest = pEarliest;</span>

            /* If we have a latest date, reset if necessary */
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (theLatest != null</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                &amp;&amp; theLatest.compareTo(theEarliest) &lt; 0) {</span>
<span class="nc" id="L237">                theLatest = theEarliest;</span>
            }
        }
<span class="nc" id="L240">    }</span>

    /**
     * Set the latest date. This is the latest date that may be selected. If the configured earliest
     * date is later than this date, it will be set to this date to ensure a valid range.
     * @param pLatest the Latest select-able date (or null if unlimited)
     */
    public final void setLatestDate(final OceanusDate pLatest) {
        /* Null the field */
<span class="nc" id="L249">        theLatest = null;</span>

        /* If we have an earliest */
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (pLatest != null) {</span>
            /* Store the date */
<span class="nc" id="L254">            theLatest = pLatest;</span>

            /* If we have an earliest date, reset if necessary */
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if (theEarliest != null</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                &amp;&amp; theLatest.compareTo(theEarliest) &lt; 0) {</span>
<span class="nc" id="L259">                theEarliest = theLatest;</span>
            }
        }
<span class="nc" id="L262">    }</span>

    /**
     * Format a date according to configured rules.
     * @param pDate the date to format
     * @return the formatted date
     */
    public String formatDate(final LocalDate pDate) {
        /* Handle null */
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (pDate == null) {</span>
<span class="nc" id="L272">            return null;</span>
        }

        /* Format the date */
<span class="nc" id="L276">        return theFormatter.formatLocalDate(pDate);</span>
    }

    /**
     * Capitalise first letter of string.
     * @param pValue the string to capitalise the first letter of
     * @return the capitalised string
     */
    public String capitaliseString(final String pValue) {
<span class="nc" id="L285">        String myValue = pValue;</span>

        /* If the first UniCode item is lowerCase */
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (Character.isLowerCase(pValue.codePointAt(0))) {</span>
            /* Locate the length of the first character */
<span class="nc" id="L290">            final int iCharLen = pValue.offsetByCodePoints(0, 1);</span>

            /* UpperCase the first iCharLen letters */
<span class="nc" id="L293">            myValue = pValue.substring(0, iCharLen).toUpperCase(theLocale)</span>
<span class="nc" id="L294">                      + pValue.substring(iCharLen);</span>
        }

        /* Return the capitalised value */
<span class="nc" id="L298">        return myValue;</span>
    }

    /**
     * Obtain current date.
     * @return the current date
     */
    public OceanusDate currentDate() {
<span class="nc" id="L306">        return new OceanusDate();</span>
    }

    /**
     * Obtain current day of month or zero if not current month.
     * @return the current month day
     */
    public int getCurrentDay() {
<span class="nc" id="L314">        final OceanusDate myDate = currentDate();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        return isSameMonth(myDate, theMonth)</span>
<span class="nc" id="L316">                                             ? myDate.getDay()</span>
<span class="nc" id="L317">                                             : 0;</span>
    }

    /**
     * Obtain Selected day of month or zero if not current month.
     * @return the selected month day
     */
    public int getSelectedDay() {
<span class="nc" id="L325">        final OceanusDate myDate = getSelectedDate();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">        return isSameMonth(myDate, theMonth)</span>
<span class="nc" id="L327">                                             ? myDate.getDay()</span>
<span class="nc" id="L328">                                             : 0;</span>
    }

    /**
     * Obtain Earliest day of month or zero if not current month.
     * @return the earliest month day
     */
    public int getEarliestDay() {
<span class="nc bnc" id="L336" title="All 2 branches missed.">        return isSameMonth(theEarliest, theMonth)</span>
<span class="nc" id="L337">                                                  ? theEarliest.getDay()</span>
<span class="nc" id="L338">                                                  : 0;</span>
    }

    /**
     * Obtain Latest day of month or zero if not current month.
     * @return the latest month day
     */
    public int getLatestDay() {
<span class="nc bnc" id="L346" title="All 2 branches missed.">        return isSameMonth(theLatest, theMonth)</span>
<span class="nc" id="L347">                                                ? theLatest.getDay()</span>
<span class="nc" id="L348">                                                : 0;</span>
    }

    /**
     * Adjust current month to previous month.
     */
    public void previousMonth() {
<span class="nc" id="L355">        theMonth.adjustMonth(-1);</span>
<span class="nc" id="L356">    }</span>

    /**
     * Adjust current month to next month.
     */
    public void nextMonth() {
<span class="nc" id="L362">        theMonth.adjustMonth(1);</span>
<span class="nc" id="L363">    }</span>

    /**
     * Adjust current month to previous year.
     */
    public void previousYear() {
<span class="nc" id="L369">        theMonth.adjustYear(-1);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (theEarliest != null</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">            &amp;&amp; theMonth.compareTo(theEarliest) &lt; 0) {</span>
<span class="nc" id="L372">            theMonth = new OceanusDate(theEarliest);</span>
<span class="nc" id="L373">            theMonth.startCalendarMonth();</span>
        }
<span class="nc" id="L375">    }</span>

    /**
     * Adjust current month to next year.
     */
    public void nextYear() {
<span class="nc" id="L381">        theMonth.adjustYear(1);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">        if (theLatest != null</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            &amp;&amp; theMonth.compareTo(theLatest) &gt; 0) {</span>
<span class="nc" id="L384">            theMonth = new OceanusDate(theLatest);</span>
<span class="nc" id="L385">            theMonth.startCalendarMonth();</span>
        }
<span class="nc" id="L387">    }</span>

    /**
     * Set the selected date.
     * @param pDate the Selected date
     */
    public final void setSelectedDate(final OceanusDate pDate) {
        /* Store the date */
<span class="nc" id="L395">        theSelected = pDate;</span>
<span class="nc" id="L396">    }</span>

    /**
     * Set selected day in current month (called from dialog).
     * @param pDay the selected day
     */
    public void setSelectedDay(final int pDay) {
<span class="nc" id="L403">        final OceanusDate myOld = getSelectedDate();</span>
<span class="nc" id="L404">        OceanusDate myNew = null;</span>

        /* If we are selecting a proper date */
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (pDay &gt; 0) {</span>
            /* Build the new selected date */
<span class="nc" id="L409">            myNew = new OceanusDate(theMonth);</span>
<span class="nc" id="L410">            myNew.adjustDay(pDay - 1);</span>
        }

        /* Ignore if there is no change */
<span class="nc bnc" id="L414" title="All 2 branches missed.">        if (!isDateChanged(myOld, myNew)) {</span>
<span class="nc" id="L415">            return;</span>
        }

        /* Store the explicitly selected date */
<span class="nc" id="L419">        theSelected = myNew;</span>
<span class="nc" id="L420">    }</span>

    /**
     * Initialise the current month.
     */
    public void initialiseCurrent() {
        /* Access Selected Date */
<span class="nc" id="L427">        OceanusDate myDate = theSelected;</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (myDate == null) {</span>
<span class="nc" id="L429">            myDate = currentDate();</span>
        }

        /* Move to start date if we are earlier */
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (theEarliest != null</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            &amp;&amp; myDate.compareTo(theEarliest) &lt; 0) {</span>
<span class="nc" id="L435">            myDate = theEarliest;</span>
        }

        /* Move to end date if we are later */
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (theLatest != null</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">            &amp;&amp; myDate.compareTo(theLatest) &gt; 0) {</span>
<span class="nc" id="L441">            myDate = theLatest;</span>
        }

        /* Set to 1st of month and record it */
<span class="nc" id="L445">        theMonth = new OceanusDate(myDate);</span>
<span class="nc" id="L446">        theMonth.startCalendarMonth();</span>
<span class="nc" id="L447">    }</span>

    /**
     * Has the date changed?
     * @param pFirst the first date
     * @param pSecond the second date
     * @return &lt;code&gt;true/false&lt;/code&gt;
     */
    public static boolean isDateChanged(final OceanusDate pFirst,
                                        final OceanusDate pSecond) {
<span class="nc bnc" id="L457" title="All 2 branches missed.">        if (pFirst == null) {</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">            return pSecond != null;</span>
        } else {
<span class="nc bnc" id="L460" title="All 2 branches missed.">            return !pFirst.equals(pSecond);</span>
        }
    }

    /**
     * Are the dates in the same month.
     * @param pFirst the first date (maybe null)
     * @param pSecond the second date
     * @return true/false
     */
    public static boolean isSameMonth(final OceanusDate pFirst,
                                      final OceanusDate pSecond) {
<span class="nc bnc" id="L472" title="All 2 branches missed.">        if (!isSameYear(pFirst, pSecond)) {</span>
<span class="nc" id="L473">            return false;</span>
        } else {
<span class="nc bnc" id="L475" title="All 2 branches missed.">            return pFirst.getMonth() == pSecond.getMonth();</span>
        }
    }

    /**
     * Are the dates in the same year.
     * @param pFirst the first date (maybe null)
     * @param pSecond the second date
     * @return true/false
     */
    public static boolean isSameYear(final OceanusDate pFirst,
                                     final OceanusDate pSecond) {
<span class="nc bnc" id="L487" title="All 2 branches missed.">        if (pFirst == null) {</span>
<span class="nc" id="L488">            return false;</span>
        }
<span class="nc bnc" id="L490" title="All 2 branches missed.">        return pFirst.getYear() == pSecond.getYear();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>