<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianCoreSignedAgreement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.core.agree</a> &gt; <span class="el_source">GordianCoreSignedAgreement.java</span></div><h1>GordianCoreSignedAgreement.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.core.agree;

import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementSpec;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementStatus;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianSignedAgreement;
import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairFactory;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPair;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairGenerator;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairSpec;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignParams;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignature;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignatureSpec;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianAgreementMessageASN1.GordianMessageType;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianDataException;
import net.sourceforge.joceanus.gordianknot.impl.core.sign.GordianCoreSignatureFactory;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;

import java.security.spec.X509EncodedKeySpec;

/**
 * Signed Agreement.
 */
public abstract class GordianCoreSignedAgreement
        extends GordianCoreKeyPairAgreement
        implements GordianSignedAgreement {
    /**
     * The client ephemeral KeyPair.
     */
    private GordianKeyPair theClientEphemeral;

    /**
     * The server ephemeral KeyPair.
     */
    private GordianKeyPair theServerEphemeral;

    /**
     * Constructor.
     * @param pFactory the factory
     * @param pSpec the agreementSpec
     */
    protected GordianCoreSignedAgreement(final GordianBaseFactory pFactory,
                                         final GordianAgreementSpec pSpec) {
<span class="fc" id="L61">        super(pFactory, pSpec);</span>
<span class="fc" id="L62">    }</span>

    /**
     * Obtain the client Ephemeral keyPair.
     * @return  the keyPair
     */
    protected GordianKeyPair getClientEphemeralKeyPair() {
<span class="fc" id="L69">        return theClientEphemeral;</span>
    }

    /**
     * Obtain the server Ephemeral keyPair.
     * @return  the keyPair
     */
    protected GordianKeyPair getServerEphemeralKeyPair() {
<span class="fc" id="L77">        return theServerEphemeral;</span>
    }

    @Override
    public void reset() {
        /* Reset underlying details */
<span class="fc" id="L83">        super.reset();</span>

        /* Reset keyPair details */
<span class="fc" id="L86">        theClientEphemeral = null;</span>
<span class="fc" id="L87">        theServerEphemeral = null;</span>
<span class="fc" id="L88">    }</span>

    /**
     * Store client ephemeral.
     * @param pEphemeral the server ephemeral
     */
    protected void storeClientEphemeral(final GordianKeyPair pEphemeral) {
        /* Store the ephemeral */
<span class="fc" id="L96">        theClientEphemeral = pEphemeral;</span>
<span class="fc" id="L97">    }</span>

    /**
     * Store server ephemeral.
     * @param pEphemeral the server ephemeral
     */
    protected void storeServerEphemeral(final GordianKeyPair pEphemeral) {
        /* Store the ephemeral */
<span class="fc" id="L105">        theServerEphemeral = pEphemeral;</span>
<span class="fc" id="L106">    }</span>

    @Override
    public byte[] createClientHello() throws GordianException {
        /* Create the clientHello and extract the encoded bytes */
<span class="fc" id="L111">        return createClientHelloASN1().getEncodedBytes();</span>
    }

    /**
     * Create the clientHello ASN1.
     * @return the clientHello message
     * @throws GordianException on error
     */
    public GordianAgreementMessageASN1 createClientHelloASN1() throws GordianException {
        /* Create ephemeral key */
<span class="fc" id="L121">        final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L122">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(getAgreementSpec().getKeyPairSpec());</span>
<span class="fc" id="L123">        theClientEphemeral = myGenerator.generateKeyPair();</span>
<span class="fc" id="L124">        final X509EncodedKeySpec myKeySpec = myGenerator.getX509Encoding(theClientEphemeral);</span>

        /* Create the clientHello message */
<span class="fc" id="L127">        final GordianAgreementMessageASN1 myClientHello = buildClientHelloASN1(myKeySpec);</span>

        /* Set status */
<span class="fc" id="L130">        setStatus(GordianAgreementStatus.AWAITING_SERVERHELLO);</span>

        /* Return the clientHello */
<span class="fc" id="L133">        return myClientHello;</span>
    }

    @Override
    public byte[] acceptClientHello(final GordianKeyPair pServer,
                                    final byte[] pClientHello) throws GordianException {
        /* Must be in clean state */
<span class="fc" id="L140">        checkStatus(GordianAgreementStatus.CLEAN);</span>

        /* Access the sequence */
<span class="fc" id="L143">        final GordianAgreementMessageASN1 myClientHello = GordianAgreementMessageASN1.getInstance(pClientHello);</span>
<span class="fc" id="L144">        myClientHello.checkMessageType(GordianMessageType.CLIENTHELLO);</span>

        /* Accept the ASN1 */
<span class="fc" id="L147">        final GordianAgreementMessageASN1 myServerHello = acceptClientHelloASN1(pServer, myClientHello);</span>
<span class="fc" id="L148">        return myServerHello.getEncodedBytes();</span>
    }

    /**
     * Accept the clientHello.
     * @param pServer the server keyPair
     * @param pClientHello the incoming clientHello message
     * @return the serverHello message
     * @throws GordianException on error
     */
    public abstract GordianAgreementMessageASN1 acceptClientHelloASN1(GordianKeyPair pServer,
                                                                      GordianAgreementMessageASN1 pClientHello) throws GordianException;

    /**
     * Process the incoming clientHello message request.
     * @param pClientHello the incoming clientHello message
     * @throws GordianException on error
     */
    protected void processClientHelloASN1(final GordianAgreementMessageASN1 pClientHello) throws GordianException {
        /* Parse the request */
<span class="fc" id="L168">        parseClientHelloASN1(pClientHello);</span>

        /* Parse the ephemeral encoding */
<span class="fc" id="L171">        final X509EncodedKeySpec myEncodedKeySpec = pClientHello.getEphemeral();</span>

        /* Create ephemeral key */
<span class="fc" id="L174">        final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L175">        final GordianKeyPairSpec myKeySpec = myFactory.determineKeyPairSpec(myEncodedKeySpec);</span>
<span class="fc" id="L176">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(myKeySpec);</span>
<span class="fc" id="L177">        theServerEphemeral = myGenerator.generateKeyPair();</span>

        /* Derive partner ephemeral key */
<span class="fc" id="L180">        theClientEphemeral = myGenerator.derivePublicOnlyKeyPair(myEncodedKeySpec);</span>

        /* Create the new serverIV */
<span class="fc" id="L183">        newServerIV();</span>
<span class="fc" id="L184">    }</span>

    /**
     * build the serverHello message.
     * @param pServer the server keyPair
     * @return the serverHello message
     * @throws GordianException on error
     */
    protected GordianAgreementMessageASN1 buildServerHelloASN1(final GordianKeyPair pServer) throws GordianException {
        /* Obtain the encoding for the server ephemeral publicKey */
<span class="fc" id="L194">        final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L195">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(theServerEphemeral.getKeyPairSpec());</span>
<span class="fc" id="L196">        final byte[] myClientEncoded = myGenerator.getX509Encoding(theClientEphemeral).getEncoded();</span>
<span class="fc" id="L197">        final X509EncodedKeySpec myServerKeySpec = myGenerator.getX509Encoding(theServerEphemeral);</span>

        /* Create the signer */
<span class="fc" id="L200">        final GordianSignatureSpec mySpec = getFactory().getAsyncFactory().getSignatureFactory().defaultForKeyPair(pServer.getKeyPairSpec());</span>
<span class="fc" id="L201">        final GordianCoreSignatureFactory mySigns = (GordianCoreSignatureFactory) getFactory().getAsyncFactory().getSignatureFactory();</span>
<span class="fc" id="L202">        final AlgorithmIdentifier myAlgId = mySigns.getIdentifierForSpecAndKeyPair(mySpec, pServer);</span>
<span class="fc" id="L203">        final GordianSignature mySigner = mySigns.createSigner(mySpec);</span>

        /* Build the signature */
<span class="fc" id="L206">        mySigner.initForSigning(GordianSignParams.keyPair(pServer));</span>
<span class="fc" id="L207">        mySigner.update(myClientEncoded);</span>
<span class="fc" id="L208">        mySigner.update(getClientIV());</span>
<span class="fc" id="L209">        mySigner.update(myServerKeySpec.getEncoded());</span>
<span class="fc" id="L210">        mySigner.update(getServerIV());</span>
<span class="fc" id="L211">        final byte[] mySignature = mySigner.sign();</span>

        /* Build the server hello */
<span class="fc" id="L214">        return buildServerHello(myServerKeySpec, myAlgId, mySignature);</span>
    }

    @Override
    public void acceptServerHello(final GordianKeyPair pServer,
                                  final byte[] pServerHello) throws GordianException {
        /* Must be in clean state */
<span class="fc" id="L221">        checkStatus(GordianAgreementStatus.AWAITING_SERVERHELLO);</span>

        /* Access the sequence */
<span class="fc" id="L224">        final GordianAgreementMessageASN1 myServerHello = GordianAgreementMessageASN1.getInstance(pServerHello);</span>
<span class="fc" id="L225">        myServerHello.checkMessageType(GordianMessageType.SERVERHELLO);</span>

        /* Accept the ASN1 */
<span class="fc" id="L228">        acceptServerHelloASN1(pServer, myServerHello);</span>
<span class="fc" id="L229">    }</span>

    /**
     * Accept the serverHello.
     * @param pServer the server keyPair
     * @param pServerHello the incoming serverHello message
     * @throws GordianException on error
     */
    public abstract void acceptServerHelloASN1(GordianKeyPair pServer,
                                               GordianAgreementMessageASN1 pServerHello) throws GordianException;

    /**
     * Process the serverHello.
     * @param pServer the server keyPair
     * @param pServerHello the serverHello message
     * @throws GordianException on error
     */
    protected void processServerHelloASN1(final GordianKeyPair pServer,
                                          final GordianAgreementMessageASN1 pServerHello) throws GordianException {
        /* Obtain keySpec */
<span class="fc" id="L249">        parseServerHelloASN1(pServerHello);</span>
<span class="fc" id="L250">        final X509EncodedKeySpec myKeySpec = pServerHello.getEphemeral();</span>

        /* Derive partner ephemeral key */
<span class="fc" id="L253">        final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L254">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(theClientEphemeral.getKeyPairSpec());</span>
<span class="fc" id="L255">        theServerEphemeral = myGenerator.derivePublicOnlyKeyPair(myKeySpec);</span>
<span class="fc" id="L256">        final byte[] myClientEncoded = myGenerator.getX509Encoding(theClientEphemeral).getEncoded();</span>

        /* Create the signer */
<span class="fc" id="L259">        final GordianCoreSignatureFactory mySigns = (GordianCoreSignatureFactory) getFactory().getAsyncFactory().getSignatureFactory();</span>
<span class="fc" id="L260">        final AlgorithmIdentifier myAlgId = pServerHello.getSignatureId();</span>
<span class="fc" id="L261">        final byte[] mySignature = pServerHello.getSignature();</span>
<span class="fc" id="L262">        final GordianSignatureSpec mySignSpec = mySigns.getSpecForIdentifier(myAlgId);</span>
<span class="fc" id="L263">        final GordianSignature mySigner = mySigns.createSigner(mySignSpec);</span>

        /* Build the signature */
<span class="fc" id="L266">        mySigner.initForVerify(GordianSignParams.keyPair(pServer));</span>
<span class="fc" id="L267">        mySigner.update(myClientEncoded);</span>
<span class="fc" id="L268">        mySigner.update(getClientIV());</span>
<span class="fc" id="L269">        mySigner.update(myKeySpec.getEncoded());</span>
<span class="fc" id="L270">        mySigner.update(getServerIV());</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">        if (!mySigner.verify(mySignature)) {</span>
<span class="nc" id="L272">            throw new GordianDataException(&quot;Signature failed&quot;);</span>
        }
<span class="fc" id="L274">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>