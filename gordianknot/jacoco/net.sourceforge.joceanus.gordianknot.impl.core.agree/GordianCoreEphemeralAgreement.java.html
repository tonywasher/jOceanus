<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianCoreEphemeralAgreement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.core.agree</a> &gt; <span class="el_source">GordianCoreEphemeralAgreement.java</span></div><h1>GordianCoreEphemeralAgreement.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.core.agree;

import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementSpec;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementStatus;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementType;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianHandshakeAgreement;
import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.base.GordianLength;
import net.sourceforge.joceanus.gordianknot.api.factory.GordianFactory;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairFactory;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPair;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairGenerator;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMac;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacFactory;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacSpec;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacSpecBuilder;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianAgreementMessageASN1.GordianMessageType;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianAgreementResult.GordianDerivationId;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianDataException;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;
import org.bouncycastle.util.Arrays;

import java.security.spec.X509EncodedKeySpec;
import java.util.Objects;

/**
 * Ephemeral Agreement.
 */
public abstract class GordianCoreEphemeralAgreement
        extends GordianCoreKeyPairAgreement
        implements GordianHandshakeAgreement {
    /**
     * The client KeyPair.
     */
    private GordianKeyPair theClient;

    /**
     * The server KeyPair.
     */
    private GordianKeyPair theServer;

    /**
     * The client ephemeral KeyPair.
     */
    private GordianKeyPair theClientEphemeral;

    /**
     * The server ephemeral KeyPair.
     */
    private GordianKeyPair theServerEphemeral;

    /**
     * The client confirmation tag.
     */
    private byte[] theClientConfirmation;

    /**
     * The server confirmation tag.
     */
    private byte[] theServerConfirmation;

    /**
     * The serverId.
     */
    private Integer theServerId;

    /**
     * Constructor.
     * @param pFactory the factory
     * @param pSpec the agreementSpec
     */
    protected GordianCoreEphemeralAgreement(final GordianBaseFactory pFactory,
                                            final GordianAgreementSpec pSpec) {
<span class="fc" id="L91">        super(pFactory, pSpec);</span>
<span class="fc" id="L92">    }</span>

    /**
     * Obtain the client keyPair.
     * @return  the keyPair
     */
    protected GordianKeyPair getClientKeyPair() {
<span class="fc" id="L99">        return theClient;</span>
    }

    /**
     * Obtain the client keyPair.
     * @return  the keyPair
     */
    protected GordianKeyPair getServerKeyPair() {
<span class="fc" id="L107">        return theServer;</span>
    }

    /**
     * Obtain the client Ephemeral keyPair.
     * @return  the keyPair
     */
    protected GordianKeyPair getClientEphemeralKeyPair() {
<span class="fc" id="L115">        return theClientEphemeral;</span>
    }

    /**
     * Obtain the server Ephemeral keyPair.
     * @return  the keyPair
     */
    protected GordianKeyPair getServerEphemeralKeyPair() {
<span class="fc" id="L123">        return theServerEphemeral;</span>
    }

    /**
     * Obtain the server Confirmation Tag.
     * @return  the tag
     */
    protected byte[] getServerConfirmationTag() {
<span class="fc" id="L131">        return theServerConfirmation;</span>
    }

    @Override
    public void reset() {
        /* Reset underlying details */
<span class="fc" id="L137">        super.reset();</span>

        /* Reset client details */
<span class="fc" id="L140">        theClient = null;</span>
<span class="fc" id="L141">        theClientEphemeral = null;</span>
<span class="fc" id="L142">        theClientConfirmation = null;</span>

        /* Reset server details */
<span class="fc" id="L145">        theServer = null;</span>
<span class="fc" id="L146">        theServerId = null;</span>
<span class="fc" id="L147">        theServerEphemeral = null;</span>
<span class="fc" id="L148">        theServerConfirmation = null;</span>
<span class="fc" id="L149">    }</span>

    @Override
    protected void processSecret(final byte[] pSecret) throws GordianException {
        /* If we are using confirmation and are not SM2 */
<span class="fc" id="L154">        final GordianAgreementSpec mySpec = getAgreementSpec();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        if (Boolean.TRUE.equals(mySpec.withConfirm())</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">                &amp;&amp; mySpec.getAgreementType() != GordianAgreementType.SM2) {</span>
            /* calculate the confirmation tags */
<span class="fc" id="L158">            calculateConfirmationTags(pSecret);</span>
        }

        /* Pass the call down */
<span class="fc" id="L162">        super.processSecret(pSecret);</span>
<span class="fc" id="L163">    }</span>

    /**
     * Store client.
     * @param pClient the client
     */
    protected void storeClient(final GordianKeyPair pClient) {
        /* Store the client */
<span class="fc" id="L171">        theClient = pClient;</span>
<span class="fc" id="L172">    }</span>

    /**
     * Store server.
     * @param pServer the server
     */
    protected void storeServer(final GordianKeyPair pServer) {
        /* Store the server */
<span class="fc" id="L180">        theServer = pServer;</span>
<span class="fc" id="L181">    }</span>

    /**
     * Store client ephemeral.
     * @param pEphemeral the client ephemeral
     */
    protected void storeClientEphemeral(final GordianKeyPair pEphemeral) {
        /* Store the ephemeral */
<span class="fc" id="L189">        theClientEphemeral = pEphemeral;</span>
<span class="fc" id="L190">    }</span>

    /**
     * Store server ephemeral.
     * @param pEphemeral the server ephemeral
     */
    protected void storeServerEphemeral(final GordianKeyPair pEphemeral) {
        /* Store the ephemeral */
<span class="fc" id="L198">        theServerEphemeral = pEphemeral;</span>
<span class="fc" id="L199">    }</span>

    /**
     * Record confirmation tags.
     * @param pServerConfirmation the server confirmation
     * @param pClientConfirmation the client confirmation
     */
    protected void storeConfirmationTags(final byte[] pServerConfirmation,
                                         final byte[] pClientConfirmation) {
<span class="fc" id="L208">        theServerConfirmation = pServerConfirmation;</span>
<span class="fc" id="L209">        theClientConfirmation = pClientConfirmation;</span>
<span class="fc" id="L210">    }</span>

    /**
     * Record confirmation tag.
     * @param pClientConfirmation the client confirmation
     */
    protected void storeConfirmationTag(final byte[] pClientConfirmation) {
<span class="fc" id="L217">        theClientConfirmation = pClientConfirmation;</span>
<span class="fc" id="L218">    }</span>

    @Override
    public byte[] createClientHello(final GordianKeyPair pClient) throws GordianException {
        /* Create the clientHello and extract the encoded bytes */
<span class="fc" id="L223">        return createClientHelloASN1(pClient).getEncodedBytes();</span>
    }

    /**
     * Create the clientHello ASN1.
     * @param pClient the client keyPair
     * @return the clientHello message
     * @throws GordianException on error
     */
    public GordianAgreementMessageASN1 createClientHelloASN1(final GordianKeyPair pClient) throws GordianException {
        /* Check the keyPair */
<span class="fc" id="L234">        checkKeyPair(pClient);</span>

        /* Store the keyPair */
<span class="fc" id="L237">        theClient = pClient;</span>

        /* Create ephemeral key */
<span class="fc" id="L240">        final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L241">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(theClient.getKeyPairSpec());</span>
<span class="fc" id="L242">        theClientEphemeral = myGenerator.generateKeyPair();</span>
<span class="fc" id="L243">        final X509EncodedKeySpec myKeySpec = myGenerator.getX509Encoding(theClientEphemeral);</span>

        /* Create the clientHello message */
<span class="fc" id="L246">        final GordianAgreementMessageASN1 myClientHello = buildClientHelloASN1(myKeySpec);</span>

        /* Set status */
<span class="fc" id="L249">        setStatus(GordianAgreementStatus.AWAITING_SERVERHELLO);</span>

        /* Return the clientHello */
<span class="fc" id="L252">        return myClientHello;</span>
    }

    @Override
    public byte[] acceptClientHello(final GordianKeyPair pClient,
                                    final GordianKeyPair pServer,
                                    final byte[] pClientHello) throws GordianException {
        /* Must be in clean state */
<span class="fc" id="L260">        checkStatus(GordianAgreementStatus.CLEAN);</span>

        /* Access the sequence */
<span class="fc" id="L263">        final GordianAgreementMessageASN1 myClientHello = GordianAgreementMessageASN1.getInstance(pClientHello);</span>
<span class="fc" id="L264">        myClientHello.checkMessageType(GordianMessageType.CLIENTHELLO);</span>

        /* Accept the ASN1 */
<span class="fc" id="L267">        final GordianAgreementMessageASN1 myServerHello = acceptClientHelloASN1(pClient, pServer, myClientHello);</span>
<span class="fc" id="L268">        return myServerHello.getEncodedBytes();</span>
    }

    /**
     * Accept the clientHello.
     * @param pClient the client keyPair
     * @param pServer the server keyPair
     * @param pClientHello the incoming clientHello message
     * @return the serverHello message
     * @throws GordianException on error
     */
    public abstract GordianAgreementMessageASN1 acceptClientHelloASN1(GordianKeyPair pClient,
                                                                      GordianKeyPair pServer,
                                                                      GordianAgreementMessageASN1 pClientHello) throws GordianException;

    /**
     * Process the incoming clientHello message request.
     * @param pClient the client keyPair
     * @param pServer the server keyPair
     * @param pClientHello the incoming clientHello message
     * @throws GordianException on error
     */
    protected void processClientHelloASN1(final GordianKeyPair pClient,
                                          final GordianKeyPair pServer,
                                          final GordianAgreementMessageASN1 pClientHello) throws GordianException {
        /* Check the keyPair */
<span class="fc" id="L294">        checkKeyPair(pClient);</span>
<span class="fc" id="L295">        checkKeyPair(pServer);</span>

        /* Store the keyPair */
<span class="fc" id="L298">        theClient = pClient;</span>
<span class="fc" id="L299">        theServer = pServer;</span>

        /* Parse the request */
<span class="fc" id="L302">        parseClientHelloASN1(pClientHello);</span>

        /* Parse the ephemeral encoding */
<span class="fc" id="L305">        final X509EncodedKeySpec myKeySpec = pClientHello.getEphemeral();</span>

        /* Create ephemeral key */
<span class="fc" id="L308">        final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L309">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(theServer.getKeyPairSpec());</span>
<span class="fc" id="L310">        theServerEphemeral = myGenerator.generateKeyPair();</span>

        /* Derive partner ephemeral key */
<span class="fc" id="L313">        theClientEphemeral = myGenerator.derivePublicOnlyKeyPair(myKeySpec);</span>

        /* Create the new serverIV */
<span class="fc" id="L316">        newServerIV();</span>
<span class="fc" id="L317">    }</span>

    @Override
    protected GordianAgreementMessageASN1 buildServerHello() throws GordianException {
        /* Add server ephemeral and any server confirmation tag to the serverHello */
<span class="fc" id="L322">        final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L323">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(theServerEphemeral.getKeyPairSpec());</span>
<span class="fc" id="L324">        final GordianAgreementMessageASN1 myHello = buildServerHello(myGenerator.getX509Encoding(theServerEphemeral), theServerConfirmation);</span>
<span class="fc" id="L325">        theServerId = myHello.getServerId();</span>
<span class="fc" id="L326">        return myHello;</span>
    }

    @Override
    public byte[] acceptServerHello(final GordianKeyPair pServer,
                                    final byte[] pServerHello) throws GordianException {
        /* Must be in clean state */
<span class="fc" id="L333">        checkStatus(GordianAgreementStatus.AWAITING_SERVERHELLO);</span>

        /* Access the sequence */
<span class="fc" id="L336">        final GordianAgreementMessageASN1 myServerHello = GordianAgreementMessageASN1.getInstance(pServerHello);</span>
<span class="fc" id="L337">        myServerHello.checkMessageType(GordianMessageType.SERVERHELLO);</span>

        /* Accept the ASN1 */
<span class="fc" id="L340">        final GordianAgreementMessageASN1 myConfirm = acceptServerHelloASN1(pServer, myServerHello);</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">        return myConfirm == null ? null : myConfirm.getEncodedBytes();</span>
    }

    /**
     * Accept the serverHello.
     * @param pServer the server keyPair
     * @param pServerHello the serverHello message
     * @return the clientConfirm (or null if no confirmation)
     * @throws GordianException on error
     */
    public abstract GordianAgreementMessageASN1 acceptServerHelloASN1(GordianKeyPair pServer,
                                                                      GordianAgreementMessageASN1 pServerHello) throws GordianException;

    /**
     * Process the serverHello.
     * @param pServer the server keyPair
     * @param pServerHello the serverHello message
     * @throws GordianException on error
     */
    protected void processServerHelloASN1(final GordianKeyPair pServer,
                                          final GordianAgreementMessageASN1 pServerHello) throws GordianException {
        /* Check the keyPair */
<span class="fc" id="L363">        checkKeyPair(pServer);</span>

        /* Store the server keyPair */
<span class="fc" id="L366">        theServer = pServer;</span>

        /* Obtain details from the serverHello */
<span class="fc" id="L369">        parseServerHelloASN1(pServerHello);</span>
<span class="fc" id="L370">        theServerConfirmation = pServerHello.getConfirmation();</span>
<span class="fc" id="L371">        theServerId = pServerHello.getServerId();</span>
<span class="fc" id="L372">        final X509EncodedKeySpec myKeySpec = pServerHello.getEphemeral();</span>

        /* Derive partner ephemeral key */
<span class="fc" id="L375">        final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L376">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(theClient.getKeyPairSpec());</span>
<span class="fc" id="L377">        theServerEphemeral = myGenerator.derivePublicOnlyKeyPair(myKeySpec);</span>
<span class="fc" id="L378">    }</span>

    /**
     * Build clientConfirm message.
     * @return the clientConfirm message
     * @throws GordianException on error
     */
    protected GordianAgreementMessageASN1 buildClientConfirmASN1() throws GordianException {
        /* If there is no client confirmation, return null */
<span class="fc bfc" id="L387" title="All 2 branches covered.">        if (theClientConfirmation == null) {</span>
<span class="fc" id="L388">            return null;</span>
        }

        /* Create the response */
<span class="fc" id="L392">        final GordianCoreAgreementFactory myFactory = getAgreementFactory();</span>
<span class="fc" id="L393">        final AlgorithmIdentifier myAlgId = myFactory.getIdentifierForSpec(getAgreementSpec());</span>
<span class="fc" id="L394">        return GordianAgreementMessageASN1.newClientConfirm(theServerId)</span>
<span class="fc" id="L395">                .setAgreementId(myAlgId)</span>
<span class="fc" id="L396">                .setConfirmation(theClientConfirmation);</span>
    }

    @Override
    public void acceptClientConfirm(final byte[] pClientConfirm) throws GordianException {
        /* Must be in awaiting clientConfirm state */
<span class="fc" id="L402">        checkStatus(GordianAgreementStatus.AWAITING_CLIENTCONFIRM);</span>

        /* Access the sequence */
<span class="fc" id="L405">        final GordianAgreementMessageASN1 myClientConfirm = GordianAgreementMessageASN1.getInstance(pClientConfirm);</span>
<span class="fc" id="L406">        myClientConfirm.checkMessageType(GordianMessageType.CLIENTCONFIRM);</span>

        /* Process the confirmation */
<span class="fc" id="L409">        acceptClientConfirmASN1(myClientConfirm);</span>

        /* Set result available status */
<span class="fc" id="L412">        setStatus(GordianAgreementStatus.RESULT_AVAILABLE);</span>
<span class="fc" id="L413">    }</span>

    /**
     * Accept a client confirm message.
     * @param pClientConfirm the confirm message
     * @throws GordianException on error
     */
    public void acceptClientConfirmASN1(final GordianAgreementMessageASN1 pClientConfirm) throws GordianException {
        /* Access message parts */
<span class="fc" id="L422">        final AlgorithmIdentifier myAlgId = pClientConfirm.getAgreementId();</span>
<span class="fc" id="L423">        final byte[] myConfirm = pClientConfirm.getConfirmation();</span>

        /* Check serverId */
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">        if (!Objects.equals(theServerId, pClientConfirm.getServerId())) {</span>
<span class="nc" id="L427">            throw new GordianDataException(&quot;Mismatch on serverId&quot;);</span>
        }

        /* Check agreementSpec */
<span class="fc" id="L431">        final GordianCoreAgreementFactory myFactory = getAgreementFactory();</span>
<span class="fc" id="L432">        final GordianAgreementSpec mySpec = myFactory.getSpecForIdentifier(myAlgId);</span>
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">        if (!Objects.equals(mySpec, getAgreementSpec())) {</span>
<span class="nc" id="L434">            throw new GordianDataException(ERROR_INVSPEC);</span>
        }

        /* Validate the confirmation */
<span class="pc bpc" id="L438" title="1 of 2 branches missed.">        if (!Arrays.constantTimeAreEqual(theClientConfirmation, myConfirm)) {</span>
<span class="nc" id="L439">            throw new GordianDataException(&quot;Confirmation failed&quot;);</span>
        }
<span class="fc" id="L441">    }</span>

    /**
     * Create the confirmation tags.
     * @param pSecret the secret
     * @throws GordianException on error
     */
    private void calculateConfirmationTags(final byte[] pSecret) throws GordianException {
        /* Derive the key */
<span class="fc" id="L450">        final byte[] myKey = calculateDerivedSecret(pSecret, GordianDerivationId.TAGS, GordianLength.LEN_512.getByteLength());</span>

        /* Create the hMac and initialise with the key */
<span class="fc" id="L453">        final GordianFactory myBaseFactory = getFactory();</span>
<span class="fc" id="L454">        final GordianMacFactory myMacs = myBaseFactory.getMacFactory();</span>
<span class="fc" id="L455">        final GordianMacSpec mySpec = GordianMacSpecBuilder.hMac(GordianDerivationId.TAGS.getDigestType());</span>
<span class="fc" id="L456">        final GordianMac myMac = myMacs.createMac(mySpec);</span>
<span class="fc" id="L457">        myMac.initKeyBytes(myKey);</span>

        /* Access the keyPairGenerator and obtain public encodings */
<span class="fc" id="L460">        final GordianKeyPairFactory myFactory = myBaseFactory.getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L461">        final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(getClientKeyPair().getKeyPairSpec());</span>
<span class="fc" id="L462">        final byte[] myClient = myGenerator.getX509Encoding(getClientKeyPair()).getEncoded();</span>
<span class="fc" id="L463">        final byte[] myClientEphemeral = myGenerator.getX509Encoding(getClientEphemeralKeyPair()).getEncoded();</span>
<span class="fc" id="L464">        final byte[] myServer = myGenerator.getX509Encoding(getServerKeyPair()).getEncoded();</span>
<span class="fc" id="L465">        final byte[] myServerEphemeral = myGenerator.getX509Encoding(getServerEphemeralKeyPair()).getEncoded();</span>

        /* Build Server Confirmation tag */
<span class="fc" id="L468">        myMac.update(myServer);</span>
<span class="fc" id="L469">        myMac.update(myClient);</span>
<span class="fc" id="L470">        myMac.update(myServerEphemeral);</span>
<span class="fc" id="L471">        myMac.update(myClientEphemeral);</span>
<span class="fc" id="L472">        final byte[] myServerConfirmation = myMac.finish();</span>

        /* Check that the server value matches any sent value */
<span class="fc bfc" id="L475" title="All 2 branches covered.">        if (theServerConfirmation != null</span>
<span class="pc bpc" id="L476" title="1 of 2 branches missed.">                &amp;&amp; !Arrays.constantTimeAreEqual(myServerConfirmation, theServerConfirmation)) {</span>
<span class="nc" id="L477">            throw new GordianDataException(&quot;Confirmation failed&quot;);</span>
        }
<span class="fc" id="L479">        theServerConfirmation = myServerConfirmation;</span>

        /* Build Client Confirmation tag */
<span class="fc" id="L482">        myMac.update(myClient);</span>
<span class="fc" id="L483">        myMac.update(myServer);</span>
<span class="fc" id="L484">        myMac.update(myClientEphemeral);</span>
<span class="fc" id="L485">        myMac.update(myServerEphemeral);</span>
<span class="fc" id="L486">        theClientConfirmation = myMac.finish();</span>
<span class="fc" id="L487">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>