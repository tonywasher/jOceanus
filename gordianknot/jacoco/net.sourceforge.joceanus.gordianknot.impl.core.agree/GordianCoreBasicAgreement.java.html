<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianCoreBasicAgreement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.core.agree</a> &gt; <span class="el_source">GordianCoreBasicAgreement.java</span></div><h1>GordianCoreBasicAgreement.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.core.agree;

import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementSpec;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementStatus;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianHandshakeAgreement;
import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPair;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianAgreementMessageASN1.GordianMessageType;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;

/**
 * New Handshake Basic Agreement.
 */
public abstract class GordianCoreBasicAgreement
        extends GordianCoreKeyPairAgreement
        implements GordianHandshakeAgreement {
    /**
     * The client KeyPair.
     */
    private GordianKeyPair theClient;

    /**
     * Constructor.
     * @param pFactory the factory
     * @param pSpec the agreementSpec
     */
    protected GordianCoreBasicAgreement(final GordianBaseFactory pFactory,
                                        final GordianAgreementSpec pSpec) {
<span class="fc" id="L45">        super(pFactory, pSpec);</span>
<span class="fc" id="L46">    }</span>

    /**
     * Obtain the Client keyPair.
     * @return  the keyPair
     */
    protected GordianKeyPair getClientKeyPair() {
<span class="fc" id="L53">        return theClient;</span>
    }

    @Override
    public byte[] createClientHello(final GordianKeyPair pServer) throws GordianException {
        /* Create the clientHello and extract the encoded bytes */
<span class="fc" id="L59">        return createClientHelloASN1(pServer).getEncodedBytes();</span>
    }

    /**
     * Create the clientHello ASN1.
     * @param pClient the client keyPair
     * @return the clientHello message
     * @throws GordianException on error
     */
    public GordianAgreementMessageASN1 createClientHelloASN1(final GordianKeyPair pClient) throws GordianException {
        /* Check the keyPair */
<span class="fc" id="L70">        checkKeyPair(pClient);</span>

        /* Store the keyPair */
<span class="fc" id="L73">        theClient = pClient;</span>

        /* Create the clientHello message */
<span class="fc" id="L76">        final GordianAgreementMessageASN1 myClientHello = buildClientHelloASN1();</span>

        /* Set status */
<span class="fc" id="L79">        setStatus(GordianAgreementStatus.AWAITING_SERVERHELLO);</span>

        /* Return the clientHello */
<span class="fc" id="L82">        return myClientHello;</span>
    }

    @Override
    public byte[] acceptClientHello(final GordianKeyPair pClient,
                                    final GordianKeyPair pServer,
                                    final byte[] pClientHello) throws GordianException {
        /* Must be in clean state */
<span class="fc" id="L90">        checkStatus(GordianAgreementStatus.CLEAN);</span>

        /* Access the sequence */
<span class="fc" id="L93">        final GordianAgreementMessageASN1 myClientHello = GordianAgreementMessageASN1.getInstance(pClientHello);</span>
<span class="fc" id="L94">        myClientHello.checkMessageType(GordianMessageType.CLIENTHELLO);</span>

        /* Accept the ASN1 */
<span class="fc" id="L97">        final GordianAgreementMessageASN1 myServerHello = acceptClientHelloASN1(pClient, pServer, myClientHello);</span>
<span class="fc" id="L98">        return myServerHello.getEncodedBytes();</span>
    }

    /**
     * Accept the clientHello.
     * @param pClient the client keyPair
     * @param pServer the server keyPair
     * @param pClientHello the incoming clientHello message
     * @return the serverHello message
     * @throws GordianException on error
     */
    public abstract GordianAgreementMessageASN1 acceptClientHelloASN1(GordianKeyPair pClient,
                                                                      GordianKeyPair pServer,
                                                                      GordianAgreementMessageASN1 pClientHello) throws GordianException;

    /**
     * Process the incoming clientHello message request.
     * @param pServer the server keyPair
     * @param pClientHello the incoming clientHello message
     * @throws GordianException on error
     */
    protected void processClientHelloASN1(final GordianKeyPair pServer,
                                          final GordianAgreementMessageASN1 pClientHello) throws GordianException {
        /* Check the keyPair */
<span class="fc" id="L122">        checkKeyPair(pServer);</span>

        /* Parse the request */
<span class="fc" id="L125">        parseClientHelloASN1(pClientHello);</span>

        /* Create the new serverIV */
<span class="fc" id="L128">        newServerIV();</span>
<span class="fc" id="L129">    }</span>

    @Override
    public byte[] acceptServerHello(final GordianKeyPair pServer,
                                    final byte[] pServerHello) throws GordianException {
        /* Must be in clean state */
<span class="fc" id="L135">        checkStatus(GordianAgreementStatus.AWAITING_SERVERHELLO);</span>

        /* Access the sequence */
<span class="fc" id="L138">        final GordianAgreementMessageASN1 myServerHello = GordianAgreementMessageASN1.getInstance(pServerHello);</span>
<span class="fc" id="L139">        myServerHello.checkMessageType(GordianMessageType.SERVERHELLO);</span>

        /* Accept the ASN1 */
<span class="fc" id="L142">        acceptServerHelloASN1(pServer, myServerHello);</span>
<span class="fc" id="L143">        return null;</span>
    }

    /**
     * Accept the serverHello.
     * @param pServer the server keyPair
     * @param pServerHello the incoming serverHello message
     * @throws GordianException on error
     */
    public abstract void acceptServerHelloASN1(GordianKeyPair pServer,
                                               GordianAgreementMessageASN1 pServerHello) throws GordianException;

    /**
     * Process the serverHello.
     * @param pServerHello the serverHello message
     * @throws GordianException on error
     */
    protected void processServerHelloASN1(final GordianAgreementMessageASN1 pServerHello) throws GordianException {
        /* Parse the server hello */
<span class="fc" id="L162">        parseServerHelloASN1(pServerHello);</span>
<span class="fc" id="L163">    }</span>

    @Override
    public void acceptClientConfirm(final byte[] pClientConfirm) throws GordianException {
        /* We will never hit this status so this will reject the request */
<span class="nc" id="L168">        checkStatus(GordianAgreementStatus.AWAITING_CLIENTCONFIRM);</span>
<span class="nc" id="L169">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>