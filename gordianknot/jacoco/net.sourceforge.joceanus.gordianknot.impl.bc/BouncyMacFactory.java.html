<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BouncyMacFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.bc</a> &gt; <span class="el_source">BouncyMacFactory.java</span></div><h1>BouncyMacFactory.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.bc;

import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.base.GordianKeySpec;
import net.sourceforge.joceanus.gordianknot.api.base.GordianLength;
import net.sourceforge.joceanus.gordianknot.api.cipher.GordianSymKeySpec;
import net.sourceforge.joceanus.gordianknot.api.cipher.GordianSymKeyType;
import net.sourceforge.joceanus.gordianknot.api.digest.GordianDigestSpec;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacSpec;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacType;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianSipHashSpec;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseData;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianDataException;
import net.sourceforge.joceanus.gordianknot.impl.core.mac.GordianCoreMacFactory;
import net.sourceforge.joceanus.gordianknot.impl.ext.digests.GordianBlake3Digest;
import net.sourceforge.joceanus.gordianknot.impl.ext.macs.GordianBlake2Mac;
import net.sourceforge.joceanus.gordianknot.impl.ext.macs.GordianBlake2XMac;
import net.sourceforge.joceanus.gordianknot.impl.ext.macs.GordianBlake3Mac;
import net.sourceforge.joceanus.gordianknot.impl.ext.macs.GordianKMACWrapper;
import net.sourceforge.joceanus.gordianknot.impl.ext.macs.GordianSkeinMac;
import net.sourceforge.joceanus.gordianknot.impl.ext.macs.GordianSkeinXMac;
import net.sourceforge.joceanus.gordianknot.impl.ext.macs.GordianZuc128Mac;
import net.sourceforge.joceanus.gordianknot.impl.ext.macs.GordianZuc256Mac;
import org.bouncycastle.crypto.CipherKeyGenerator;
import org.bouncycastle.crypto.Mac;
import org.bouncycastle.crypto.Xof;
import org.bouncycastle.crypto.generators.Poly1305KeyGenerator;
import org.bouncycastle.crypto.macs.CBCBlockCipherMac;
import org.bouncycastle.crypto.macs.CFBBlockCipherMac;
import org.bouncycastle.crypto.macs.CMac;
import org.bouncycastle.crypto.macs.DSTU7564Mac;
import org.bouncycastle.crypto.macs.GMac;
import org.bouncycastle.crypto.macs.GOST28147Mac;
import org.bouncycastle.crypto.macs.Poly1305;
import org.bouncycastle.crypto.macs.SipHash;
import org.bouncycastle.crypto.macs.SipHash128;
import org.bouncycastle.crypto.macs.VMPCMac;
import org.bouncycastle.crypto.modes.GCMBlockCipher;
import org.bouncycastle.crypto.patch.macs.GordianDSTU7624Mac;
import org.bouncycastle.crypto.patch.macs.GordianKGMac;
import org.bouncycastle.crypto.patch.modes.GordianKGCMBlockCipher;

import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

/**
 * Factory for BouncyCastle Macs.
 */
public class BouncyMacFactory
    extends GordianCoreMacFactory {
    /**
     * KeyPairGenerator Cache.
     */
    private final Map&lt;GordianKeySpec, BouncyKeyGenerator&lt;? extends GordianKeySpec&gt;&gt; theCache;

    /**
     * Constructor.
     *
     * @param pFactory the factory
     */
    BouncyMacFactory(final GordianBaseFactory pFactory) {
        /* Initialise underlying class */
<span class="fc" id="L81">        super(pFactory);</span>

        /* Create the cache */
<span class="fc" id="L84">        theCache = new HashMap&lt;&gt;();</span>
<span class="fc" id="L85">    }</span>

    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T extends GordianKeySpec&gt; BouncyKeyGenerator&lt;T&gt; getKeyGenerator(final T pMacSpec) throws GordianException {
        /* Look up in the cache */
<span class="fc" id="L91">        BouncyKeyGenerator&lt;T&gt; myGenerator = (BouncyKeyGenerator&lt;T&gt;) theCache.get(pMacSpec);</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (myGenerator == null) {</span>
            /* Check validity of MacSpec */
<span class="fc" id="L94">            checkMacSpec(pMacSpec);</span>

            /* Create the new generator */
<span class="fc" id="L97">            final CipherKeyGenerator myBCGenerator = getBCKeyGenerator((GordianMacSpec) pMacSpec);</span>
<span class="fc" id="L98">            myGenerator = new BouncyKeyGenerator&lt;&gt;(getFactory(), pMacSpec, myBCGenerator);</span>

            /* Add to cache */
<span class="fc" id="L101">            theCache.put(pMacSpec, myGenerator);</span>
        }
<span class="fc" id="L103">        return myGenerator;</span>
    }

    /**
     * Create the BouncyCastle KeyGenerator.
     *
     * @param pKeyType the keyType
     * @return the KeyGenerator
     */
    private static CipherKeyGenerator getBCKeyGenerator(final GordianMacSpec pKeyType) {
<span class="fc bfc" id="L113" title="All 2 branches covered.">        return GordianMacType.POLY1305.equals(pKeyType.getMacType())</span>
<span class="fc" id="L114">            ? new Poly1305KeyGenerator()</span>
<span class="fc" id="L115">            : new CipherKeyGenerator();</span>
    }

    @Override
    public BouncyMac createMac(final GordianMacSpec pMacSpec) throws GordianException {
        /* Check validity of MacSpec */
<span class="fc" id="L121">        checkMacSpec(pMacSpec);</span>

        /* Create Mac */
<span class="fc" id="L124">        final Mac myBCMac = getBCMac(pMacSpec);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">        return myBCMac instanceof Xof myXof</span>
<span class="fc" id="L126">                ? new BouncyMacXof(getFactory(), pMacSpec, myXof)</span>
<span class="fc" id="L127">                : new BouncyMac(getFactory(), pMacSpec, myBCMac);</span>
    }

    /**
     * Create the BouncyCastle MAC.
     *
     * @param pMacSpec the MacSpec
     * @return the MAC
     * @throws GordianException on error
     */
    private Mac getBCMac(final GordianMacSpec pMacSpec) throws GordianException {
<span class="pc bpc" id="L138" title="1 of 17 branches missed.">        switch (pMacSpec.getMacType()) {</span>
            case HMAC:
<span class="fc" id="L140">                return getBCHMac(pMacSpec);</span>
            case GMAC:
<span class="fc" id="L142">                return getBCGMac(Objects.requireNonNull(pMacSpec.getSymKeySpec()));</span>
            case CMAC:
<span class="fc" id="L144">                return getBCCMac(Objects.requireNonNull(pMacSpec.getSymKeySpec()));</span>
            case POLY1305:
<span class="fc" id="L146">                return getBCPoly1305Mac(pMacSpec.getSymKeySpec());</span>
            case SKEIN:
<span class="fc" id="L148">                return getBCSkeinMac(Objects.requireNonNull(pMacSpec.getDigestSpec()));</span>
            case BLAKE2:
<span class="fc" id="L150">                return getBCBlake2Mac(Objects.requireNonNull(pMacSpec.getDigestSpec()));</span>
            case BLAKE3:
<span class="fc" id="L152">                return getBCBlake3Mac(Objects.requireNonNull(pMacSpec.getDigestSpec()));</span>
            case KMAC:
<span class="fc" id="L154">                return getBCKMAC(Objects.requireNonNull(pMacSpec.getDigestSpec()));</span>
            case KALYNA:
<span class="fc" id="L156">                return getBCKalynaMac(Objects.requireNonNull(pMacSpec.getSymKeySpec()));</span>
            case KUPYNA:
<span class="fc" id="L158">                return getBCKupynaMac(Objects.requireNonNull(pMacSpec.getDigestSpec()));</span>
            case VMPC:
<span class="fc" id="L160">                return getBCVMPCMac();</span>
            case CBCMAC:
<span class="fc" id="L162">                return getBCCBCMac(Objects.requireNonNull(pMacSpec.getSymKeySpec()));</span>
            case CFBMAC:
<span class="fc" id="L164">                return getBCCFBMac(Objects.requireNonNull(pMacSpec.getSymKeySpec()));</span>
            case SIPHASH:
<span class="fc" id="L166">                return getBCSipHash(Objects.requireNonNull(pMacSpec.getSipHashSpec()));</span>
            case GOST:
<span class="fc" id="L168">                return getBCGOSTMac();</span>
            case ZUC:
<span class="fc" id="L170">                return getBCZucMac(pMacSpec);</span>
            default:
<span class="nc" id="L172">                throw new GordianDataException(GordianBaseData.getInvalidText(pMacSpec));</span>
        }
    }

    /**
     * Create the BouncyCastle HMAC.
     *
     * @param pMacSpec the macSpec
     * @return the MAC
     * @throws GordianException on error
     */
    private Mac getBCHMac(final GordianMacSpec pMacSpec) throws GordianException {
<span class="fc" id="L184">         return new BouncyHMac(getFactory().getDigestFactory(), pMacSpec);</span>
    }

    /**
     * Create the BouncyCastle GMac.
     *
     * @param pSymKeySpec the SymKeySpec
     * @return the MAC
     * @throws GordianException on error
     */
    private static Mac getBCGMac(final GordianSymKeySpec pSymKeySpec) throws GordianException {
<span class="fc bfc" id="L195" title="All 2 branches covered.">        return GordianSymKeyType.KALYNA.equals(pSymKeySpec.getSymKeyType())</span>
<span class="fc" id="L196">               ? new GordianKGMac(new GordianKGCMBlockCipher(BouncyCipherFactory.getBCSymEngine(pSymKeySpec)))</span>
<span class="fc" id="L197">               : new GMac(GCMBlockCipher.newInstance(BouncyCipherFactory.getBCSymEngine(pSymKeySpec)));</span>
    }

    /**
     * Create the BouncyCastle CMac.
     *
     * @param pSymKeySpec the SymKeySpec
     * @return the MAC
     * @throws GordianException on error
     */
    private static Mac getBCCMac(final GordianSymKeySpec pSymKeySpec) throws GordianException {
<span class="fc" id="L208">        return new CMac(BouncyCipherFactory.getBCSymEngine(pSymKeySpec));</span>
    }

    /**
     * Create the BouncyCastle Poly1305Mac.
     *
     * @param pSymKeySpec the SymKeySpec
     * @return the MAC
     * @throws GordianException on error
     */
    private static Mac getBCPoly1305Mac(final GordianSymKeySpec pSymKeySpec) throws GordianException {
<span class="fc bfc" id="L219" title="All 2 branches covered.">        return pSymKeySpec == null</span>
<span class="fc" id="L220">               ? new Poly1305()</span>
<span class="fc" id="L221">               : new Poly1305(BouncyCipherFactory.getBCSymEngine(pSymKeySpec));</span>
    }

    /**
     * Create the BouncyCastle SkeinMac.
     *
     * @param pSpec the digestSpec
     * @return the MAC
     */
    private static Mac getBCSkeinMac(final GordianDigestSpec pSpec) {
<span class="fc bfc" id="L231" title="All 2 branches covered.">        return pSpec.isXofMode()</span>
<span class="fc" id="L232">                    ? new GordianSkeinXMac(pSpec.getDigestState().getLength().getLength())</span>
<span class="fc" id="L233">                    : new GordianSkeinMac(pSpec.getDigestState().getLength().getLength(), pSpec.getDigestLength().getLength());</span>
    }

    /**
     * Create the BouncyCastle KalynaMac.
     *
     * @param pSymKeySpec the SymKeySpec
     * @return the MAC
     */
    private static Mac getBCKalynaMac(final GordianSymKeySpec pSymKeySpec) {
<span class="fc" id="L243">        final GordianLength myLen = pSymKeySpec.getBlockLength();</span>
<span class="fc" id="L244">        return new GordianDSTU7624Mac(myLen.getLength(), myLen.getLength());</span>
    }

    /**
     * Create the BouncyCastle kupynaMac.
     *
     * @param pSpec the digestSpec
     * @return the MAC
     */
    private static Mac getBCKupynaMac(final GordianDigestSpec pSpec) {
<span class="fc" id="L254">        return new DSTU7564Mac(pSpec.getDigestLength().getLength());</span>
    }

    /**
     * Create the BouncyCastle blakeMac.
     *
     * @param pSpec the digestSpec
     * @return the MAC
     */
    private static Mac getBCBlake2Mac(final GordianDigestSpec pSpec) {
<span class="fc bfc" id="L264" title="All 2 branches covered.">        return pSpec.isXofMode()</span>
<span class="fc" id="L265">                ? new GordianBlake2XMac(BouncyDigestFactory.getBlake2Xof(pSpec))</span>
<span class="fc" id="L266">                : new GordianBlake2Mac(BouncyDigestFactory.getBlake2Digest(pSpec));</span>
    }

    /**
     * Create the BouncyCastle blake3Mac.
     *
     * @param pSpec the digestSpec
     * @return the MAC
     */
    private static Mac getBCBlake3Mac(final GordianDigestSpec pSpec) {
<span class="fc" id="L276">        final GordianBlake3Digest myDigest = new GordianBlake3Digest(pSpec.getDigestLength().getByteLength());</span>
<span class="fc" id="L277">        return new GordianBlake3Mac(myDigest);</span>
    }

    /**
     * Create the BouncyCastle KMAC.
     *
     * @param pSpec the digestSpec
     * @return the MAC
     */
    private static Mac getBCKMAC(final GordianDigestSpec pSpec) {
<span class="fc" id="L287">        return new GordianKMACWrapper(pSpec.getDigestState().getLength().getLength());</span>
    }

    /**
     * Create the BouncyCastle VMPCMac.
     *
     * @return the MAC
     */
    private static Mac getBCVMPCMac() {
<span class="fc" id="L296">        return new VMPCMac();</span>
    }

    /**
     * Create the BouncyCastle CBCMac.
     *
     * @param pSymKeySpec the SymKeySpec
     * @return the MAC
     * @throws GordianException on error
     */
    private static Mac getBCCBCMac(final GordianSymKeySpec pSymKeySpec) throws GordianException {
<span class="fc" id="L307">        return new CBCBlockCipherMac(BouncyCipherFactory.getBCSymEngine(pSymKeySpec));</span>
    }

    /**
     * Create the BouncyCastle CFBMac.
     *
     * @param pSymKeySpec the SymKeySpec
     * @return the MAC
     * @throws GordianException on error
     */
    private static Mac getBCCFBMac(final GordianSymKeySpec pSymKeySpec) throws GordianException {
<span class="fc" id="L318">        return new CFBBlockCipherMac(BouncyCipherFactory.getBCSymEngine(pSymKeySpec));</span>
    }

    /**
     * Create the BouncyCastle SipHash.
     *
     * @param pSpec the SipHashSpec
     * @return the MAC
     */
    private static Mac getBCSipHash(final GordianSipHashSpec pSpec) {
<span class="fc bfc" id="L328" title="All 2 branches covered.">        return pSpec.isLong()</span>
<span class="fc" id="L329">                ? new SipHash128(pSpec.getCompression(), pSpec.getFinalisation())</span>
<span class="fc" id="L330">                : new SipHash(pSpec.getCompression(), pSpec.getFinalisation());</span>
    }

    /**
     * Create the BouncyCastle GOSTMac.
     *
     * @return the MAC
     */
    private static Mac getBCGOSTMac() {
<span class="fc" id="L339">        return new GOST28147Mac();</span>
    }

    /**
     * Create the BouncyCastle ZucMac.
     *
     * @param pMacSpec the macSpec
     * @return the MAC
     */
    private static Mac getBCZucMac(final GordianMacSpec pMacSpec) {
<span class="fc bfc" id="L349" title="All 2 branches covered.">        return GordianLength.LEN_128 == pMacSpec.getKeyLength()</span>
<span class="fc" id="L350">               ? new GordianZuc128Mac()</span>
<span class="fc" id="L351">               : new GordianZuc256Mac(pMacSpec.getMacLength().getLength());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>