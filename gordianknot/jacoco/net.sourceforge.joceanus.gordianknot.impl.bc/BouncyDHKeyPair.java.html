<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BouncyDHKeyPair.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.bc</a> &gt; <span class="el_source">BouncyDHKeyPair.java</span></div><h1>BouncyDHKeyPair.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.bc;

import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementSpec;
import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairFactory;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianDHGroup;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPair;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairGenerator;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairSpec;
import net.sourceforge.joceanus.gordianknot.impl.bc.BouncyKeyPair.BouncyPrivateKey;
import net.sourceforge.joceanus.gordianknot.impl.bc.BouncyKeyPair.BouncyPublicKey;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianAgreementMessageASN1;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianCoreAnonymousAgreement;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianCoreBasicAgreement;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianCoreEphemeralAgreement;
import net.sourceforge.joceanus.gordianknot.impl.core.agree.GordianCoreSignedAgreement;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianCryptoException;
import net.sourceforge.joceanus.gordianknot.impl.core.keypair.GordianKeyPairAlgId.GordianDHEncodedParser;
import net.sourceforge.joceanus.gordianknot.impl.core.keypair.GordianKeyPairValidity;
import net.sourceforge.joceanus.gordianknot.impl.core.xagree.GordianXCoreAgreementFactory;
import org.bouncycastle.asn1.ASN1Integer;
import org.bouncycastle.asn1.pkcs.DHParameter;
import org.bouncycastle.asn1.pkcs.PKCSObjectIdentifiers;
import org.bouncycastle.asn1.pkcs.PrivateKeyInfo;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;
import org.bouncycastle.asn1.x509.SubjectPublicKeyInfo;
import org.bouncycastle.asn1.x9.DomainParameters;
import org.bouncycastle.asn1.x9.X9ObjectIdentifiers;
import org.bouncycastle.crypto.AsymmetricCipherKeyPair;
import org.bouncycastle.crypto.agreement.DHBasicAgreement;
import org.bouncycastle.crypto.agreement.DHUnifiedAgreement;
import org.bouncycastle.crypto.agreement.MQVBasicAgreement;
import org.bouncycastle.crypto.generators.DHKeyPairGenerator;
import org.bouncycastle.crypto.params.AsymmetricKeyParameter;
import org.bouncycastle.crypto.params.DHKeyGenerationParameters;
import org.bouncycastle.crypto.params.DHMQVPrivateParameters;
import org.bouncycastle.crypto.params.DHMQVPublicParameters;
import org.bouncycastle.crypto.params.DHParameters;
import org.bouncycastle.crypto.params.DHPrivateKeyParameters;
import org.bouncycastle.crypto.params.DHPublicKeyParameters;
import org.bouncycastle.crypto.params.DHUPrivateParameters;
import org.bouncycastle.crypto.params.DHUPublicParameters;
import org.bouncycastle.crypto.params.XDHUPrivateParameters;
import org.bouncycastle.crypto.params.XDHUPublicParameters;
import org.bouncycastle.jcajce.provider.asymmetric.dh.BCDHPrivateKey;
import org.bouncycastle.jcajce.provider.asymmetric.dh.BCDHPublicKey;
import org.bouncycastle.jcajce.provider.asymmetric.util.KeyUtil;
import org.bouncycastle.util.BigIntegers;

import java.io.IOException;
import java.math.BigInteger;
import java.security.spec.PKCS8EncodedKeySpec;
import java.security.spec.X509EncodedKeySpec;

/**
 * DiffieHellman KeyPair classes.
 */
public final class BouncyDHKeyPair {
    /**
     * Private constructor.
     */
    private BouncyDHKeyPair() {
    }

    /**
     * Bouncy DH PublicKey.
     */
    public static class BouncyDHPublicKey
            extends BouncyPublicKey&lt;DHPublicKeyParameters&gt; {
        /**
         * Constructor.
         * @param pKeySpec the keySpec
         * @param pPublicKey the public key
         */
        BouncyDHPublicKey(final GordianKeyPairSpec pKeySpec,
                          final DHPublicKeyParameters pPublicKey) {
<span class="fc" id="L94">            super(pKeySpec, pPublicKey);</span>
<span class="fc" id="L95">        }</span>

        @Override
        protected boolean matchKey(final AsymmetricKeyParameter pThat) {
            /* Access keys */
<span class="fc" id="L100">            final DHPublicKeyParameters myThis = getPublicKey();</span>
<span class="fc" id="L101">            final DHPublicKeyParameters myThat = (DHPublicKeyParameters) pThat;</span>

            /* Compare keys */
<span class="fc" id="L104">            return compareKeys(myThis, myThat);</span>
        }

        /**
         * Is the private key valid for this public key?
         * @param pPrivate the private key
         * @return true/false
         */
        public boolean validPrivate(final BouncyDHPrivateKey pPrivate) {
<span class="nc" id="L113">            final DHPrivateKeyParameters myPrivate = pPrivate.getPrivateKey();</span>
<span class="nc" id="L114">            return getPublicKey().getParameters().equals(myPrivate.getParameters());</span>
        }

        /**
         * CompareKeys.
         * @param pFirst the first key
         * @param pSecond the second key
         * @return true/false
         */
        private static boolean compareKeys(final DHPublicKeyParameters pFirst,
                                           final DHPublicKeyParameters pSecond) {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">            return pFirst.getY().equals(pSecond.getY())</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">                    &amp;&amp; pFirst.getParameters().equals(pSecond.getParameters());</span>
        }
    }

    /**
     * Bouncy DH PrivateKey.
     */
    public static class BouncyDHPrivateKey
            extends BouncyPrivateKey&lt;DHPrivateKeyParameters&gt; {
        /**
         * Constructor.
         * @param pKeySpec the keySpec
         * @param pPrivateKey the private key
         */
        BouncyDHPrivateKey(final GordianKeyPairSpec pKeySpec,
                           final DHPrivateKeyParameters pPrivateKey) {
<span class="fc" id="L142">            super(pKeySpec, pPrivateKey);</span>
<span class="fc" id="L143">        }</span>

        @Override
        protected boolean matchKey(final AsymmetricKeyParameter pThat) {
            /* Access keys */
<span class="fc" id="L148">            final DHPrivateKeyParameters myThis = getPrivateKey();</span>
<span class="fc" id="L149">            final DHPrivateKeyParameters myThat = (DHPrivateKeyParameters) pThat;</span>

            /* Compare keys */
<span class="fc" id="L152">            return compareKeys(myThis, myThat);</span>
        }

        /**
         * CompareKeys.
         * @param pFirst the first key
         * @param pSecond the second key
         * @return true/false
         */
        private static boolean compareKeys(final DHPrivateKeyParameters pFirst,
                                           final DHPrivateKeyParameters pSecond) {
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            return pFirst.getX().equals(pSecond.getX())</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                    &amp;&amp; pFirst.getParameters().equals(pSecond.getParameters());</span>
        }
    }

    /**
     * BouncyCastle DH KeyPair generator.
     */
    public static class BouncyDHKeyPairGenerator
            extends BouncyKeyPairGenerator {
        /**
         * Generator.
         */
        private final DHKeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         */
        BouncyDHKeyPairGenerator(final GordianBaseFactory pFactory,
                                 final GordianKeyPairSpec pKeySpec) {
            /* Initialize underlying class */
<span class="fc" id="L186">            super(pFactory, pKeySpec);</span>

            /* Create the parameter generator */
<span class="fc" id="L189">            final GordianDHGroup myGroup = pKeySpec.getDHGroup();</span>
<span class="fc" id="L190">            final DHParameters myParms = myGroup.getParameters();</span>
<span class="fc" id="L191">            final DHKeyGenerationParameters myParams = new DHKeyGenerationParameters(getRandom(), myParms);</span>

            /* Create and initialize the generator */
<span class="fc" id="L194">            theGenerator = new DHKeyPairGenerator();</span>
<span class="fc" id="L195">            theGenerator.init(myParams);</span>
<span class="fc" id="L196">        }</span>

        @Override
        public BouncyKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L201">            final AsymmetricCipherKeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L202">            final BouncyDHPublicKey myPublic = new BouncyDHPublicKey(getKeySpec(), (DHPublicKeyParameters) myPair.getPublic());</span>
<span class="fc" id="L203">            final BouncyDHPrivateKey myPrivate = new BouncyDHPrivateKey(getKeySpec(), (DHPrivateKeyParameters) myPair.getPrivate());</span>
<span class="fc" id="L204">            return new BouncyKeyPair(myPublic, myPrivate);</span>
        }

        @Override
        public PKCS8EncodedKeySpec getPKCS8Encoding(final GordianKeyPair pKeyPair) throws GordianException {
            /* Protect against exceptions */
            try {
                /* Check the keyPair type and keySpecs */
<span class="fc" id="L212">                BouncyKeyPair.checkKeyPair(pKeyPair, getKeySpec());</span>

                /* build and return the encoding */
<span class="fc" id="L215">                final BouncyDHPrivateKey myPrivateKey = (BouncyDHPrivateKey) getPrivateKey(pKeyPair);</span>
<span class="fc" id="L216">                final DHPrivateKeyParameters myKey = myPrivateKey.getPrivateKey();</span>
<span class="fc" id="L217">                final DHParameters myParms = myKey.getParameters();</span>
<span class="fc" id="L218">                final AlgorithmIdentifier myId = getAlgorithmIdentifier(myParms);</span>
<span class="fc" id="L219">                final PrivateKeyInfo myInfo = new PrivateKeyInfo(myId, new ASN1Integer(myKey.getX()));</span>
<span class="fc" id="L220">                return new PKCS8EncodedKeySpec(myInfo.getEncoded());</span>

<span class="nc" id="L222">            } catch (IOException e) {</span>
<span class="nc" id="L223">                throw new GordianCryptoException(ERROR_PARSE, e);</span>
            }
        }

        @Override
        public BouncyKeyPair deriveKeyPair(final X509EncodedKeySpec pPublicKey,
                                           final PKCS8EncodedKeySpec pPrivateKey) throws GordianException {
            /* Protect against exceptions */
            try {
                /* Check the keySpecs */
<span class="fc" id="L233">                checkKeySpec(pPrivateKey);</span>

                /* derive keyPair */
<span class="fc" id="L236">                final BouncyDHPublicKey myPublic = derivePublicKey(pPublicKey);</span>
<span class="fc" id="L237">                final PrivateKeyInfo myInfo = PrivateKeyInfo.getInstance(pPrivateKey.getEncoded());</span>
<span class="fc" id="L238">                final BCDHPrivateKey myKey = new BCDHPrivateKey(myInfo);</span>
<span class="fc" id="L239">                final DHParameters myParms = GordianDHEncodedParser.determineParameters(myInfo.getPrivateKeyAlgorithm());</span>
<span class="fc" id="L240">                final BouncyDHPrivateKey myPrivate = new BouncyDHPrivateKey(getKeySpec(), new DHPrivateKeyParameters(myKey.getX(), myParms));</span>
<span class="fc" id="L241">                final BouncyKeyPair myPair = new BouncyKeyPair(myPublic, myPrivate);</span>

                /* Check that we have a matching pair */
<span class="fc" id="L244">                GordianKeyPairValidity.checkValidity(getFactory(), myPair);</span>

                /* Return the keyPair */
<span class="fc" id="L247">                return myPair;</span>

<span class="nc" id="L249">            } catch (IOException e) {</span>
<span class="nc" id="L250">                throw new GordianCryptoException(ERROR_PARSE, e);</span>
            }
        }

        @Override
        public X509EncodedKeySpec getX509Encoding(final GordianKeyPair pKeyPair) throws GordianException {
            /* Check the keyPair type and keySpecs */
<span class="fc" id="L257">            BouncyKeyPair.checkKeyPair(pKeyPair, getKeySpec());</span>

            /* build and return the encoding */
<span class="fc" id="L260">            final BouncyDHPublicKey myPublicKey = (BouncyDHPublicKey) getPublicKey(pKeyPair);</span>
<span class="fc" id="L261">            final DHPublicKeyParameters myKey = myPublicKey.getPublicKey();</span>
<span class="fc" id="L262">            final DHParameters myParms = myKey.getParameters();</span>
<span class="fc" id="L263">            final AlgorithmIdentifier myId = getAlgorithmIdentifier(myParms);</span>
<span class="fc" id="L264">            final byte[] myBytes = KeyUtil.getEncodedSubjectPublicKeyInfo(myId, new ASN1Integer(myKey.getY()));</span>
<span class="fc" id="L265">            return new X509EncodedKeySpec(myBytes);</span>
        }

        @Override
        public BouncyKeyPair derivePublicOnlyKeyPair(final X509EncodedKeySpec pEncodedKey) throws GordianException {
<span class="fc" id="L270">            final BouncyDHPublicKey myPublic = derivePublicKey(pEncodedKey);</span>
<span class="fc" id="L271">            return new BouncyKeyPair(myPublic);</span>
        }

        /**
         * Derive public key from encoded.
         * @param pEncodedKey the encoded key
         * @return the public key
         * @throws GordianException on error
         */
        private BouncyDHPublicKey derivePublicKey(final X509EncodedKeySpec pEncodedKey) throws GordianException {
            /* Check the keySpecs */
<span class="fc" id="L282">            checkKeySpec(pEncodedKey);</span>

            /* derive publicKey */
<span class="fc" id="L285">            final SubjectPublicKeyInfo myInfo = SubjectPublicKeyInfo.getInstance(pEncodedKey.getEncoded());</span>
<span class="fc" id="L286">            final BCDHPublicKey myKey = new BCDHPublicKey(myInfo);</span>
<span class="fc" id="L287">            return new BouncyDHPublicKey(getKeySpec(), myKey.engineGetKeyParameters());</span>
        }

        /**
         * Obtain algorithm Id from DHParameters.
         * @param pParams the parameters
         * @return the algorithmId.
         */
        private static AlgorithmIdentifier getAlgorithmIdentifier(final DHParameters pParams) {
            /* If this is a public # algorithm */
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">            return pParams.getQ() != null</span>
<span class="fc" id="L298">                   ? new AlgorithmIdentifier(X9ObjectIdentifiers.dhpublicnumber,</span>
<span class="fc" id="L299">                           new DomainParameters(pParams.getP(), pParams.getG(), pParams.getQ(), pParams.getJ(), null).toASN1Primitive())</span>
<span class="nc" id="L300">                   : new AlgorithmIdentifier(PKCSObjectIdentifiers.dhKeyAgreement,</span>
<span class="nc" id="L301">                           new DHParameter(pParams.getP(), pParams.getG(), pParams.getL()).toASN1Primitive());</span>
        }
    }

    /**
     * DH Anonymous.
     */
    public static class BouncyDHAnonymousAgreement
            extends GordianCoreAnonymousAgreement {
        /**
         * The agreement.
         */
        private final DHBasicAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         */
        BouncyDHAnonymousAgreement(final GordianBaseFactory pFactory,
                                   final GordianAgreementSpec pSpec) {
            /* Initialise underlying class */
<span class="fc" id="L323">            super(pFactory, pSpec);</span>

            /* Create the agreement */
<span class="fc" id="L326">            theAgreement = new DHBasicAgreement();</span>

            /* Add in the derivation function */
<span class="fc" id="L329">            enableDerivation();</span>
<span class="fc" id="L330">        }</span>

        @Override
        public GordianAgreementMessageASN1 createClientHelloASN1(final GordianKeyPair pServer) throws GordianException {
            /* Check keyPair */
<span class="fc" id="L335">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L336">            checkKeyPair(pServer);</span>

            /* Create an ephemeral keyPair */
<span class="fc" id="L339">            final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L340">            final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(pServer.getKeyPairSpec());</span>
<span class="fc" id="L341">            final GordianKeyPair myPair = myGenerator.generateKeyPair();</span>
<span class="fc" id="L342">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(myPair);</span>

            /* Create the clientHello */
<span class="fc" id="L345">            final X509EncodedKeySpec myKeySpec = myGenerator.getX509Encoding(myPair);</span>
<span class="fc" id="L346">            final GordianAgreementMessageASN1 myClientHello = buildClientHelloASN1(myKeySpec);</span>

            /* Derive the secret */
<span class="fc" id="L349">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="fc" id="L350">            final BouncyDHPublicKey myTarget = (BouncyDHPublicKey) getPublicKey(pServer);</span>
<span class="fc" id="L351">            final BigInteger mySecret = theAgreement.calculateAgreement(myTarget.getPublicKey());</span>

            /* Store secret */
<span class="fc" id="L354">            storeSecret(BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecret));</span>

            /* Return the clientHello  */
<span class="fc" id="L357">            return myClientHello;</span>
        }

        @Override
        public void acceptClientHelloASN1(final GordianKeyPair pServer,
                                          final GordianAgreementMessageASN1 pClientHello) throws GordianException {
            /* Check keyPair */
<span class="fc" id="L364">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L365">            checkKeyPair(pServer);</span>

            /* Process the clientHello */
<span class="fc" id="L368">            final X509EncodedKeySpec myKeySpec = pClientHello.getEphemeral();</span>
<span class="fc" id="L369">            final GordianKeyPairFactory myFactory = getFactory().getAsyncFactory().getKeyPairFactory();</span>
<span class="fc" id="L370">            final GordianKeyPairGenerator myGenerator = myFactory.getKeyPairGenerator(pServer.getKeyPairSpec());</span>
<span class="fc" id="L371">            final GordianKeyPair myPartner = myGenerator.derivePublicOnlyKeyPair(myKeySpec);</span>
<span class="fc" id="L372">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(pServer);</span>
<span class="fc" id="L373">            final BouncyDHPublicKey myPublic = (BouncyDHPublicKey) getPublicKey(myPartner);</span>

            /* Derive the secret */
<span class="fc" id="L376">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="fc" id="L377">            final BigInteger mySecretInt = theAgreement.calculateAgreement(myPublic.getPublicKey());</span>
<span class="fc" id="L378">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>

            /* Store secret */
<span class="fc" id="L381">            storeSecret(mySecret);</span>
<span class="fc" id="L382">        }</span>
    }

    /**
     * DH Basic Agreement.
     */
    public static class BouncyDHBasicAgreement
            extends GordianCoreBasicAgreement {
        /**
         * The agreement.
         */
        private final DHBasicAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         */
        BouncyDHBasicAgreement(final GordianBaseFactory pFactory,
                               final GordianAgreementSpec pSpec) {
            /* Initialise underlying class */
<span class="fc" id="L403">            super(pFactory, pSpec);</span>

            /* Create the agreement */
<span class="fc" id="L406">            theAgreement = new DHBasicAgreement();</span>
<span class="fc" id="L407">            enableDerivation();</span>
<span class="fc" id="L408">        }</span>

        @Override
        public GordianAgreementMessageASN1 acceptClientHelloASN1(final GordianKeyPair pClient,
                                                                 final GordianKeyPair pServer,
                                                                 final GordianAgreementMessageASN1 pClientHello) throws GordianException {
            /* Check keyPair */
<span class="fc" id="L415">            BouncyKeyPair.checkKeyPair(pClient);</span>
<span class="fc" id="L416">            checkKeyPair(pClient);</span>
<span class="fc" id="L417">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L418">            checkKeyPair(pServer);</span>

            /* Process the clientHello */
<span class="fc" id="L421">            processClientHelloASN1(pServer, pClientHello);</span>
<span class="fc" id="L422">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(pServer);</span>
<span class="fc" id="L423">            final BouncyDHPublicKey myPublic = (BouncyDHPublicKey) getPublicKey(pClient);</span>

            /* Derive the secret */
<span class="fc" id="L426">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="fc" id="L427">            final BigInteger mySecretInt = theAgreement.calculateAgreement(myPublic.getPublicKey());</span>
<span class="fc" id="L428">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>

            /* Store secret */
<span class="fc" id="L431">            storeSecret(mySecret);</span>

            /* Return the serverHello */
<span class="fc" id="L434">            return buildServerHello();</span>
        }

        @Override
        public void acceptServerHelloASN1(final GordianKeyPair pServer,
                                          final GordianAgreementMessageASN1 pServerHello) throws GordianException {
            /* Check keyPair */
<span class="fc" id="L441">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L442">            checkKeyPair(pServer);</span>

            /* process the serverHello */
<span class="fc" id="L445">            processServerHelloASN1(pServerHello);</span>
<span class="fc" id="L446">            final BouncyPrivateKey&lt;?&gt; myPrivate = (BouncyPrivateKey&lt;?&gt;) getPrivateKey(getClientKeyPair());</span>

            /* Calculate agreement */
<span class="fc" id="L449">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="fc" id="L450">            final BouncyPublicKey&lt;?&gt; mySrcPublic = (BouncyPublicKey&lt;?&gt;) getPublicKey(pServer);</span>
<span class="fc" id="L451">            final BigInteger mySecretInt = theAgreement.calculateAgreement(mySrcPublic.getPublicKey());</span>
<span class="fc" id="L452">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>
<span class="fc" id="L453">            storeSecret(mySecret);</span>
<span class="fc" id="L454">        }</span>
    }

    /**
     * DH Signed Agreement.
     */
    public static class BouncyDHSignedAgreement
            extends GordianCoreSignedAgreement {
        /**
         * Agreement.
         */
        private final DHBasicAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         */
        BouncyDHSignedAgreement(final GordianBaseFactory pFactory,
                                final GordianAgreementSpec pSpec) {
            /* Initialise underlying class */
<span class="fc" id="L475">            super(pFactory, pSpec);</span>

            /* Create the agreement */
<span class="fc" id="L478">            theAgreement = new DHBasicAgreement();</span>
<span class="fc" id="L479">            enableDerivation();</span>
<span class="fc" id="L480">        }</span>

        @Override
        public GordianAgreementMessageASN1 acceptClientHelloASN1(final GordianKeyPair pServer,
                                                                 final GordianAgreementMessageASN1 pClientHello) throws GordianException {
            /* Process clientHello */
<span class="fc" id="L486">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L487">            processClientHelloASN1(pClientHello);</span>
<span class="fc" id="L488">            final BouncyPrivateKey&lt;?&gt; myPrivate = (BouncyPrivateKey&lt;?&gt;) getPrivateKey(getServerEphemeralKeyPair());</span>
<span class="fc" id="L489">            final BouncyPublicKey&lt;?&gt; myPublic = (BouncyPublicKey&lt;?&gt;) getPublicKey(getClientEphemeralKeyPair());</span>

            /* Derive the secret */
<span class="fc" id="L492">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="fc" id="L493">            final BigInteger mySecretInt = theAgreement.calculateAgreement(myPublic.getPublicKey());</span>
<span class="fc" id="L494">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>

            /* Store secret */
<span class="fc" id="L497">            storeSecret(mySecret);</span>

            /* Return the serverHello */
<span class="fc" id="L500">            return buildServerHelloASN1(pServer);</span>
        }

        @Override
        public void acceptServerHelloASN1(final GordianKeyPair pServer,
                                          final GordianAgreementMessageASN1 pServerHello) throws GordianException {
            /* process the serverHello */
<span class="fc" id="L507">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L508">            processServerHelloASN1(pServer, pServerHello);</span>
<span class="fc" id="L509">            final BouncyPrivateKey&lt;?&gt; myPrivate = (BouncyPrivateKey&lt;?&gt;) getPrivateKey(getClientEphemeralKeyPair());</span>

            /* Calculate agreement */
<span class="fc" id="L512">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="fc" id="L513">            final BouncyPublicKey&lt;?&gt; myPublic = (BouncyPublicKey&lt;?&gt;) getPublicKey(getServerEphemeralKeyPair());</span>
<span class="fc" id="L514">            final BigInteger mySecretInt = theAgreement.calculateAgreement(myPublic.getPublicKey());</span>
<span class="fc" id="L515">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>

            /* Store secret */
<span class="fc" id="L518">            storeSecret(mySecret);</span>
<span class="fc" id="L519">        }</span>
    }

    /**
     * DH Unified Agreement.
     */
    public static class BouncyDHUnifiedAgreement
            extends GordianCoreEphemeralAgreement {
        /**
         * The agreement.
         */
        private final DHUnifiedAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         */
        BouncyDHUnifiedAgreement(final GordianBaseFactory pFactory,
                                 final GordianAgreementSpec pSpec) {
            /* Initialise underlying class */
<span class="fc" id="L540">            super(pFactory, pSpec);</span>

            /* Create Key Agreement */
<span class="fc" id="L543">            theAgreement = new DHUnifiedAgreement();</span>
<span class="fc" id="L544">            enableDerivation();</span>
<span class="fc" id="L545">        }</span>

        @Override
        public GordianAgreementMessageASN1 acceptClientHelloASN1(final GordianKeyPair pClient,
                                                                 final GordianKeyPair pServer,
                                                                 final GordianAgreementMessageASN1 pClientHello) throws GordianException {
            /* process clientHello */
<span class="fc" id="L552">            BouncyKeyPair.checkKeyPair(pClient);</span>
<span class="fc" id="L553">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L554">            processClientHelloASN1(pClient, pServer, pClientHello);</span>

            /* Initialise agreement */
<span class="fc" id="L557">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(pServer);</span>
<span class="fc" id="L558">            final BouncyDHPrivateKey myEphPrivate = (BouncyDHPrivateKey) getPrivateKey(getServerEphemeralKeyPair());</span>
<span class="fc" id="L559">            final BouncyDHPublicKey myEphPublic = (BouncyDHPublicKey) getPublicKey(getServerEphemeralKeyPair());</span>
<span class="fc" id="L560">            final DHUPrivateParameters myPrivParams = new DHUPrivateParameters(myPrivate.getPrivateKey(),</span>
<span class="fc" id="L561">                    myEphPrivate.getPrivateKey(), myEphPublic.getPublicKey());</span>
<span class="fc" id="L562">            theAgreement.init(myPrivParams);</span>

            /* Calculate agreement */
<span class="fc" id="L565">            final BouncyDHPublicKey mySrcPublic = (BouncyDHPublicKey) getPublicKey(pClient);</span>
<span class="fc" id="L566">            final BouncyDHPublicKey mySrcEphPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeralKeyPair());</span>
<span class="fc" id="L567">            final DHUPublicParameters myPubParams = new DHUPublicParameters(mySrcPublic.getPublicKey(),</span>
<span class="fc" id="L568">                    mySrcEphPublic.getPublicKey());</span>
<span class="fc" id="L569">            storeSecret(theAgreement.calculateAgreement(myPubParams));</span>

            /* Return the serverHello */
<span class="fc" id="L572">            return buildServerHello();</span>
        }

        @Override
        public GordianAgreementMessageASN1 acceptServerHelloASN1(final GordianKeyPair pServer,
                                                                 final GordianAgreementMessageASN1 pServerHello) throws GordianException {
            /* Check keyPair */
<span class="fc" id="L579">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L580">            checkKeyPair(pServer);</span>

            /* process the serverHello */
<span class="fc" id="L583">            processServerHelloASN1(pServer, pServerHello);</span>

            /* Initialise agreement */
<span class="fc" id="L586">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientKeyPair());</span>
<span class="fc" id="L587">            final BouncyDHPrivateKey myEphPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientEphemeralKeyPair());</span>
<span class="fc" id="L588">            final BouncyDHPublicKey myEphPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeralKeyPair());</span>
<span class="fc" id="L589">            final DHUPrivateParameters myPrivParams = new DHUPrivateParameters(myPrivate.getPrivateKey(),</span>
<span class="fc" id="L590">                    myEphPrivate.getPrivateKey(), myEphPublic.getPublicKey());</span>
<span class="fc" id="L591">            theAgreement.init(myPrivParams);</span>

            /* Calculate agreement */
<span class="fc" id="L594">            final BouncyDHPublicKey mySrcPublic = (BouncyDHPublicKey) getPublicKey(pServer);</span>
<span class="fc" id="L595">            final BouncyDHPublicKey mySrcEphPublic = (BouncyDHPublicKey) getPublicKey(getServerEphemeralKeyPair());</span>
<span class="fc" id="L596">            final DHUPublicParameters myPubParams = new DHUPublicParameters(mySrcPublic.getPublicKey(),</span>
<span class="fc" id="L597">                    mySrcEphPublic.getPublicKey());</span>
<span class="fc" id="L598">            storeSecret(theAgreement.calculateAgreement(myPubParams));</span>

            /* Return confirmation if needed */
<span class="fc" id="L601">            return buildClientConfirmASN1();</span>
         }
    }

    /**
     * DH MQV Agreement.
     */
    public static class BouncyDHMQVAgreement
            extends GordianCoreEphemeralAgreement {
        /**
         * The agreement.
         */
        private final MQVBasicAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         */
        BouncyDHMQVAgreement(final GordianBaseFactory pFactory,
                             final GordianAgreementSpec pSpec) {
            /* Initialise underlying class */
<span class="fc" id="L623">            super(pFactory, pSpec);</span>

            /* Create Key Agreement */
<span class="fc" id="L626">            theAgreement = new MQVBasicAgreement();</span>
<span class="fc" id="L627">            enableDerivation();</span>
<span class="fc" id="L628">        }</span>

        @Override
        public GordianAgreementMessageASN1 acceptClientHelloASN1(final GordianKeyPair pClient,
                                                                 final GordianKeyPair pServer,
                                                                 final GordianAgreementMessageASN1 pClientHello) throws GordianException {
            /* process clientHello */
<span class="fc" id="L635">            BouncyKeyPair.checkKeyPair(pClient);</span>
<span class="fc" id="L636">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L637">            processClientHelloASN1(pClient, pServer, pClientHello);</span>

            /* Initialise agreement */
<span class="fc" id="L640">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(pServer);</span>
<span class="fc" id="L641">            final BouncyDHPrivateKey myEphPrivate = (BouncyDHPrivateKey) getPrivateKey(getServerEphemeralKeyPair());</span>
<span class="fc" id="L642">            final BouncyDHPublicKey myEphPublic = (BouncyDHPublicKey) getPublicKey(getServerEphemeralKeyPair());</span>
<span class="fc" id="L643">            final DHMQVPrivateParameters myPrivParams = new DHMQVPrivateParameters(myPrivate.getPrivateKey(),</span>
<span class="fc" id="L644">                    myEphPrivate.getPrivateKey(), myEphPublic.getPublicKey());</span>
<span class="fc" id="L645">            theAgreement.init(myPrivParams);</span>

            /* Calculate agreement */
<span class="fc" id="L648">            final BouncyDHPublicKey mySrcPublic = (BouncyDHPublicKey) getPublicKey(pClient);</span>
<span class="fc" id="L649">            final BouncyDHPublicKey mySrcEphPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeralKeyPair());</span>
<span class="fc" id="L650">            final DHMQVPublicParameters myPubParams = new DHMQVPublicParameters(mySrcPublic.getPublicKey(),</span>
<span class="fc" id="L651">                    mySrcEphPublic.getPublicKey());</span>
<span class="fc" id="L652">            storeSecret(BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(),</span>
<span class="fc" id="L653">                    theAgreement.calculateAgreement(myPubParams)));</span>

            /* Return the serverHello */
<span class="fc" id="L656">            return buildServerHello();</span>
        }

        @Override
        public GordianAgreementMessageASN1 acceptServerHelloASN1(final GordianKeyPair pServer,
                                                                 final GordianAgreementMessageASN1 pServerHello) throws GordianException {
            /* Check keyPair */
<span class="fc" id="L663">            BouncyKeyPair.checkKeyPair(pServer);</span>
<span class="fc" id="L664">            checkKeyPair(pServer);</span>

            /* process the serverHello */
<span class="fc" id="L667">            processServerHelloASN1(pServer, pServerHello);</span>

            /* Initialise agreement */
<span class="fc" id="L670">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientKeyPair());</span>
<span class="fc" id="L671">            final BouncyDHPrivateKey myEphPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientEphemeralKeyPair());</span>
<span class="fc" id="L672">            final BouncyDHPublicKey myEphPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeralKeyPair());</span>
<span class="fc" id="L673">            final DHMQVPrivateParameters myPrivParams = new DHMQVPrivateParameters(myPrivate.getPrivateKey(),</span>
<span class="fc" id="L674">                    myEphPrivate.getPrivateKey(), myEphPublic.getPublicKey());</span>
<span class="fc" id="L675">            theAgreement.init(myPrivParams);</span>

            /* Calculate agreement */
<span class="fc" id="L678">            final BouncyDHPublicKey mySrcPublic = (BouncyDHPublicKey) getPublicKey(pServer);</span>
<span class="fc" id="L679">            final BouncyDHPublicKey mySrcEphPublic = (BouncyDHPublicKey) getPublicKey(getServerEphemeralKeyPair());</span>
<span class="fc" id="L680">            final DHMQVPublicParameters myPubParams = new DHMQVPublicParameters(mySrcPublic.getPublicKey(),</span>
<span class="fc" id="L681">                    mySrcEphPublic.getPublicKey());</span>
<span class="fc" id="L682">            storeSecret(BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(),</span>
<span class="fc" id="L683">                    theAgreement.calculateAgreement(myPubParams)));</span>

            /* Return confirmation if needed */
<span class="fc" id="L686">            return buildClientConfirmASN1();</span>
        }
    }

    /**
     * DH Anonymous XAgreement Engine.
     */
    public static class BouncyDHAnonXAgreementEngine
            extends BouncyXAgreementBase {
        /**
         * The agreement.
         */
        private final DHBasicAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         * @throws GordianException on error
         */
        BouncyDHAnonXAgreementEngine(final GordianXCoreAgreementFactory pFactory,
                                     final GordianAgreementSpec pSpec) throws GordianException {
            /* Initialize underlying class */
<span class="nc" id="L709">            super(pFactory, pSpec);</span>

            /* Create the agreement */
<span class="nc" id="L712">            theAgreement = new DHBasicAgreement();</span>
<span class="nc" id="L713">        }</span>

        @Override
        public void buildClientHello() throws GordianException {
            /* Access keys */
<span class="nc" id="L718">            final BouncyDHPublicKey myPublic = (BouncyDHPublicKey) getPublicKey(getServerKeyPair());</span>
<span class="nc" id="L719">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientEphemeral());</span>

            /* Derive the secret */
<span class="nc" id="L722">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="nc" id="L723">            final BigInteger mySecretInt = theAgreement.calculateAgreement(myPublic.getPublicKey());</span>
<span class="nc" id="L724">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>

            /* Store secret */
<span class="nc" id="L727">            storeSecret(mySecret);</span>
<span class="nc" id="L728">        }</span>

        @Override
        public void processClientHello() throws GordianException {
            /* Access keys */
<span class="nc" id="L733">            final BouncyDHPublicKey myPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeral());</span>
<span class="nc" id="L734">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getServerKeyPair());</span>

            /* Derive the secret */
<span class="nc" id="L737">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="nc" id="L738">            final BigInteger mySecretInt = theAgreement.calculateAgreement(myPublic.getPublicKey());</span>
<span class="nc" id="L739">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>

            /* Store secret */
<span class="nc" id="L742">            storeSecret(mySecret);</span>
<span class="nc" id="L743">        }</span>
    }

    /**
     * DH Basic XAgreement Engine.
     */
    public static class BouncyDHBasicXAgreementEngine
            extends BouncyXAgreementBase {
        /**
         * The agreement.
         */
        private final DHBasicAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         * @throws GordianException on error
         */
        BouncyDHBasicXAgreementEngine(final GordianXCoreAgreementFactory pFactory,
                                      final GordianAgreementSpec pSpec) throws GordianException {
            /* Initialize underlying class */
<span class="nc" id="L765">            super(pFactory, pSpec);</span>

            /* Create the agreement */
<span class="nc" id="L768">            theAgreement = new DHBasicAgreement();</span>
<span class="nc" id="L769">        }</span>

        @Override
        public void processClientHello() throws GordianException {
            /* Access keys */
<span class="nc" id="L774">            final BouncyDHPublicKey myPublic = (BouncyDHPublicKey) getPublicKey(getClientKeyPair());</span>
<span class="nc" id="L775">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getServerKeyPair());</span>

            /* Derive the secret */
<span class="nc" id="L778">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="nc" id="L779">            final BigInteger mySecretInt = theAgreement.calculateAgreement(myPublic.getPublicKey());</span>
<span class="nc" id="L780">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>

            /* Store secret */
<span class="nc" id="L783">            storeSecret(mySecret);</span>
<span class="nc" id="L784">        }</span>

        @Override
        public void processServerHello() throws GordianException {
            /* Access keys */
<span class="nc" id="L789">            final BouncyDHPublicKey myPublic = (BouncyDHPublicKey) getPublicKey(getServerKeyPair());</span>
<span class="nc" id="L790">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientKeyPair());</span>

            /* Derive the secret */
<span class="nc" id="L793">            theAgreement.init(myPrivate.getPrivateKey());</span>
<span class="nc" id="L794">            final BigInteger mySecretInt = theAgreement.calculateAgreement(myPublic.getPublicKey());</span>
<span class="nc" id="L795">            final byte[] mySecret = BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(), mySecretInt);</span>

            /* Store secret */
<span class="nc" id="L798">            storeSecret(mySecret);</span>
<span class="nc" id="L799">        }</span>
    }

    /**
     * DH Unified XAgreement Engine.
     */
    public static class BouncyDHUnifiedXAgreementEngine
            extends BouncyXAgreementBase {
        /**
         * The agreement.
         */
        private final DHUnifiedAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         * @throws GordianException on error
         */
        BouncyDHUnifiedXAgreementEngine(final GordianXCoreAgreementFactory pFactory,
                                        final GordianAgreementSpec pSpec) throws GordianException {
            /* Initialize underlying class */
<span class="nc" id="L821">            super(pFactory, pSpec);</span>

            /* Create the agreement */
<span class="nc" id="L824">            theAgreement = new DHUnifiedAgreement();</span>
<span class="nc" id="L825">        }</span>

        @Override
        public void processClientHello() throws GordianException {
            /* Access keys */
<span class="nc" id="L830">            final BouncyDHPublicKey myClientPublic = (BouncyDHPublicKey) getPublicKey(getClientKeyPair());</span>
<span class="nc" id="L831">            final BouncyDHPublicKey myClientEphPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeral());</span>
<span class="nc" id="L832">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getServerKeyPair());</span>
<span class="nc" id="L833">            final BouncyDHPublicKey myEphPublic = (BouncyDHPublicKey) getPublicKey(getServerEphemeral());</span>
<span class="nc" id="L834">            final BouncyDHPrivateKey myEphPrivate = (BouncyDHPrivateKey) getPrivateKey(getServerEphemeral());</span>

            /* Derive the secret */
<span class="nc" id="L837">            final DHUPrivateParameters myPrivParams</span>
<span class="nc" id="L838">                    = new DHUPrivateParameters(myPrivate.getPrivateKey(), myEphPrivate.getPrivateKey(), myEphPublic.getPublicKey());</span>
<span class="nc" id="L839">            theAgreement.init(myPrivParams);</span>

            /* Store secret */
<span class="nc" id="L842">            final DHUPublicParameters myPubParams</span>
<span class="nc" id="L843">                    = new DHUPublicParameters(myClientPublic.getPublicKey(), myClientEphPublic.getPublicKey());</span>
<span class="nc" id="L844">            storeSecret(theAgreement.calculateAgreement(myPubParams));</span>
<span class="nc" id="L845">        }</span>

        @Override
        public void processServerHello() throws GordianException {
            /* Access keys */
<span class="nc" id="L850">            final BouncyDHPublicKey myServerPublic = (BouncyDHPublicKey) getPublicKey(getServerKeyPair());</span>
<span class="nc" id="L851">            final BouncyDHPublicKey myServerEphPublic = (BouncyDHPublicKey) getPublicKey(getServerEphemeral());</span>
<span class="nc" id="L852">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientKeyPair());</span>
<span class="nc" id="L853">            final BouncyDHPublicKey myEphPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeral());</span>
<span class="nc" id="L854">            final BouncyDHPrivateKey myEphPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientEphemeral());</span>

            /* Derive the secret */
<span class="nc" id="L857">            final XDHUPrivateParameters myPrivParams</span>
<span class="nc" id="L858">                    = new XDHUPrivateParameters(myPrivate.getPrivateKey(), myEphPrivate.getPrivateKey(), myEphPublic.getPublicKey());</span>
<span class="nc" id="L859">            theAgreement.init(myPrivParams);</span>

            /* Store secret */
<span class="nc" id="L862">            final XDHUPublicParameters myPubParams</span>
<span class="nc" id="L863">                    = new XDHUPublicParameters(myServerPublic.getPublicKey(), myServerEphPublic.getPublicKey());</span>
<span class="nc" id="L864">            storeSecret(theAgreement.calculateAgreement(myPubParams));</span>
<span class="nc" id="L865">        }</span>
    }

    /**
     * DH MQV XAgreement Engine.
     */
    public static class BouncyDHMQVXAgreementEngine
            extends BouncyXAgreementBase {
        /**
         * The agreement.
         */
        private final MQVBasicAgreement theAgreement;

        /**
         * Constructor.
         * @param pFactory the security factory
         * @param pSpec the agreementSpec
         * @throws GordianException on error
         */
        BouncyDHMQVXAgreementEngine(final GordianXCoreAgreementFactory pFactory,
                                    final GordianAgreementSpec pSpec) throws GordianException {
            /* Initialize underlying class */
<span class="nc" id="L887">            super(pFactory, pSpec);</span>

            /* Create the agreement */
<span class="nc" id="L890">            theAgreement = new MQVBasicAgreement();</span>
<span class="nc" id="L891">        }</span>

        @Override
        public void processClientHello() throws GordianException {
            /* Access keys */
<span class="nc" id="L896">            final BouncyDHPublicKey myClientPublic = (BouncyDHPublicKey) getPublicKey(getClientKeyPair());</span>
<span class="nc" id="L897">            final BouncyDHPublicKey myClientEphPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeral());</span>
<span class="nc" id="L898">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getServerKeyPair());</span>
<span class="nc" id="L899">            final BouncyDHPublicKey myEphPublic = (BouncyDHPublicKey) getPublicKey(getServerEphemeral());</span>
<span class="nc" id="L900">            final BouncyDHPrivateKey myEphPrivate = (BouncyDHPrivateKey) getPrivateKey(getServerEphemeral());</span>

            /* Derive the secret */
<span class="nc" id="L903">            final DHMQVPrivateParameters myPrivParams</span>
<span class="nc" id="L904">                    = new DHMQVPrivateParameters(myPrivate.getPrivateKey(), myEphPrivate.getPrivateKey(), myEphPublic.getPublicKey());</span>
<span class="nc" id="L905">            theAgreement.init(myPrivParams);</span>

            /* Store secret */
<span class="nc" id="L908">            final DHMQVPublicParameters myPubParams</span>
<span class="nc" id="L909">                    = new DHMQVPublicParameters(myClientPublic.getPublicKey(), myClientEphPublic.getPublicKey());</span>
<span class="nc" id="L910">            storeSecret(BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(),</span>
<span class="nc" id="L911">                    theAgreement.calculateAgreement(myPubParams)));</span>
<span class="nc" id="L912">        }</span>

        @Override
        public void processServerHello() throws GordianException {
            /* Access keys */
<span class="nc" id="L917">            final BouncyDHPublicKey myServerPublic = (BouncyDHPublicKey) getPublicKey(getServerKeyPair());</span>
<span class="nc" id="L918">            final BouncyDHPublicKey myServerEphPublic = (BouncyDHPublicKey) getPublicKey(getServerEphemeral());</span>
<span class="nc" id="L919">            final BouncyDHPrivateKey myPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientKeyPair());</span>
<span class="nc" id="L920">            final BouncyDHPublicKey myEphPublic = (BouncyDHPublicKey) getPublicKey(getClientEphemeral());</span>
<span class="nc" id="L921">            final BouncyDHPrivateKey myEphPrivate = (BouncyDHPrivateKey) getPrivateKey(getClientEphemeral());</span>

            /* Derive the secret */
<span class="nc" id="L924">            final DHMQVPrivateParameters myPrivParams</span>
<span class="nc" id="L925">                    = new DHMQVPrivateParameters(myPrivate.getPrivateKey(), myEphPrivate.getPrivateKey(), myEphPublic.getPublicKey());</span>
<span class="nc" id="L926">            theAgreement.init(myPrivParams);</span>

            /* Store secret */
<span class="nc" id="L929">            final DHMQVPublicParameters myPubParams</span>
<span class="nc" id="L930">                    = new DHMQVPublicParameters(myServerPublic.getPublicKey(), myServerEphPublic.getPublicKey());</span>
<span class="nc" id="L931">            storeSecret(BigIntegers.asUnsignedByteArray(theAgreement.getFieldSize(),</span>
<span class="nc" id="L932">                    theAgreement.calculateAgreement(myPubParams)));</span>
<span class="nc" id="L933">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>