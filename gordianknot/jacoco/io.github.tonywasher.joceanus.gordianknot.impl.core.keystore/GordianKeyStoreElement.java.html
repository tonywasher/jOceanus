<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianKeyStoreElement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.gordianknot.impl.core.keystore</a> &gt; <span class="el_source">GordianKeyStoreElement.java</span></div><h1>GordianKeyStoreElement.java</h1><pre class="source lang-java linenums">/*
 * GordianKnot: Security Suite
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.gordianknot.impl.core.keystore;

import io.github.tonywasher.joceanus.gordianknot.api.base.GordianException;
import io.github.tonywasher.joceanus.gordianknot.api.base.GordianKeySpec;
import io.github.tonywasher.joceanus.gordianknot.api.cert.GordianCertificate;
import io.github.tonywasher.joceanus.gordianknot.api.factory.GordianFactory;
import io.github.tonywasher.joceanus.gordianknot.api.key.GordianKey;
import io.github.tonywasher.joceanus.gordianknot.api.keypair.GordianKeyPair;
import io.github.tonywasher.joceanus.gordianknot.api.keyset.GordianKeySet;
import io.github.tonywasher.joceanus.gordianknot.api.lock.GordianKeySetLock;
import io.github.tonywasher.joceanus.gordianknot.api.lock.GordianLockFactory;
import io.github.tonywasher.joceanus.gordianknot.api.lock.GordianPasswordLockSpec;
import io.github.tonywasher.joceanus.gordianknot.impl.core.cert.GordianCoreCertificate;
import io.github.tonywasher.joceanus.gordianknot.impl.core.keystore.GordianBaseKeyStore.GordianKeyStoreCertificateKey;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * KeyStoreElement.
 * &lt;p&gt;
 * These are the entries as held in the keyStore.
 * &lt;/p&gt;
 */
public interface GordianKeyStoreElement {
    /**
     * KeyStore Certificate.
     */
    interface GordianKeyStoreCertificateHolder {
        /**
         * Obtain the key.
         *
         * @return the key
         */
        GordianKeyStoreCertificateKey getCertificateKey();
    }

    /**
     * KeyStore Certificate Element.
     */
    class GordianKeyStoreCertificateElement
            extends GordianCoreKeyStoreEntry
            implements GordianKeyStoreCertificateHolder {
        /**
         * The certificate Id.
         */
        private final GordianKeyStoreCertificateKey theKey;

        /**
         * Constructor.
         *
         * @param pCertificate the certificate.
         */
<span class="fc" id="L72">        GordianKeyStoreCertificateElement(final GordianCertificate pCertificate) {</span>
<span class="fc" id="L73">            theKey = new GordianKeyStoreCertificateKey(pCertificate);</span>
<span class="fc" id="L74">        }</span>

        /**
         * Constructor.
         *
         * @param pKey  the key.
         * @param pDate the creation date
         */
        GordianKeyStoreCertificateElement(final GordianKeyStoreCertificateKey pKey,
                                          final LocalDate pDate) {
<span class="nc" id="L84">            super(pDate);</span>
<span class="nc" id="L85">            theKey = pKey;</span>
<span class="nc" id="L86">        }</span>

        @Override
        public GordianKeyStoreCertificateKey getCertificateKey() {
<span class="fc" id="L90">            return theKey;</span>
        }

        /**
         * Obtain the corresponding keyStoreEntry.
         *
         * @param pKeyStore the keyStore
         * @return the keyStore certificate entry
         */
        GordianCoreKeyStoreCertificate buildEntry(final GordianBaseKeyStore pKeyStore) {
<span class="nc" id="L100">            final GordianCoreCertificate myCert = (GordianCoreCertificate) pKeyStore.getCertificate(getCertificateKey());</span>
<span class="nc" id="L101">            return new GordianCoreKeyStoreCertificate(myCert, getCreationDate());</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L108">                return true;</span>
            }
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L111">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (!(pThat instanceof GordianKeyStoreCertificateElement)) {</span>
<span class="nc" id="L116">                return false;</span>
            }
<span class="nc" id="L118">            final GordianKeyStoreCertificateElement myThat = (GordianKeyStoreCertificateElement) pThat;</span>

            /* Check that the keys match */
<span class="nc bnc" id="L121" title="All 2 branches missed.">            return theKey.equals(myThat.getCertificateKey())</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L127">            return theKey.hashCode()</span>
<span class="nc" id="L128">                    + super.hashCode();</span>
        }
    }

    /**
     * KeyStore KeyPair Element.
     */
    class GordianKeyStorePairElement
            extends GordianCoreKeyStoreEntry
            implements GordianKeyStoreCertificateHolder {
        /**
         * The securedPrivateKey.
         */
        private final byte[] theSecuredKey;

        /**
         * The securing lock.
         */
        private final GordianKeyStoreLockElement theSecuringLock;

        /**
         * The certificate chain.
         */
        private final List&lt;GordianKeyStoreCertificateKey&gt; theChain;

        /**
         * Constructor.
         *
         * @param pFactory  the factory
         * @param pSpec     the passwordLockSpec
         * @param pKeyPair  the keyPair
         * @param pPassword the securing password.
         * @param pChain    the certificate chain.
         * @throws GordianException on error
         */
        GordianKeyStorePairElement(final GordianFactory pFactory,
                                   final GordianPasswordLockSpec pSpec,
                                   final GordianKeyPair pKeyPair,
                                   final char[] pPassword,
<span class="fc" id="L167">                                   final List&lt;GordianCertificate&gt; pChain) throws GordianException {</span>
            /* Create a securing lock */
<span class="fc" id="L169">            final GordianLockFactory myFactory = pFactory.getLockFactory();</span>
<span class="fc" id="L170">            final GordianKeySetLock myLock = myFactory.newKeySetLock(pSpec, pPassword);</span>
<span class="fc" id="L171">            theSecuringLock = new GordianKeyStoreLockElement(myLock);</span>
<span class="fc" id="L172">            final GordianKeySet myKeySet = myLock.getKeySet();</span>

            /* Secure the privateKey */
<span class="fc" id="L175">            theSecuredKey = securePrivateKey(myKeySet, pKeyPair);</span>

            /* Create the chain */
<span class="fc" id="L178">            theChain = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">            for (GordianCertificate myCert : pChain) {</span>
<span class="fc" id="L180">                theChain.add(new GordianKeyStoreCertificateKey(myCert));</span>
<span class="fc" id="L181">            }</span>
<span class="fc" id="L182">        }</span>

        /**
         * Constructor.
         *
         * @param pSecuredKey   the secured privateKey
         * @param pSecuringLock the securing keySetLock.
         * @param pChain        the certificate chain.
         * @param pDate         the creation date
         */
        GordianKeyStorePairElement(final byte[] pSecuredKey,
                                   final byte[] pSecuringLock,
                                   final List&lt;GordianKeyStoreCertificateKey&gt; pChain,
                                   final LocalDate pDate) {
            /* Store details */
<span class="fc" id="L197">            super(pDate);</span>
<span class="fc" id="L198">            theSecuredKey = pSecuredKey;</span>
<span class="fc" id="L199">            theSecuringLock = new GordianKeyStoreLockElement(pSecuringLock, pDate);</span>
<span class="fc" id="L200">            theChain = new ArrayList&lt;&gt;(pChain);</span>
<span class="fc" id="L201">        }</span>

        /**
         * Obtain the securedKey.
         *
         * @return the securedKey
         */
        byte[] getSecuredKey() {
<span class="fc" id="L209">            return theSecuredKey;</span>
        }

        /**
         * Obtain the securingLock.
         *
         * @return the securingLock
         */
        GordianKeyStoreLockElement getSecuringLock() {
<span class="fc" id="L218">            return theSecuringLock;</span>
        }

        /**
         * Obtain the securingLockBytes.
         *
         * @return the securingLockBytes
         */
        byte[] getSecuringLockBytes() {
<span class="fc" id="L227">            return theSecuringLock.getLock();</span>
        }

        @Override
        public GordianKeyStoreCertificateKey getCertificateKey() {
<span class="fc" id="L232">            return theChain.get(0);</span>
        }

        /**
         * Obtain the certificateChain.
         *
         * @return the certificateChain
         */
        List&lt;GordianKeyStoreCertificateKey&gt; getCertificateChain() {
<span class="fc" id="L241">            return theChain;</span>
        }

        /**
         * Update the chain.
         *
         * @param pChain the new chain.
         */
        void updateChain(final List&lt;GordianCertificate&gt; pChain) {
<span class="fc" id="L250">            theChain.clear();</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">            for (GordianCertificate myCert : pChain) {</span>
<span class="fc" id="L252">                theChain.add(new GordianKeyStoreCertificateKey(myCert));</span>
<span class="fc" id="L253">            }</span>
<span class="fc" id="L254">        }</span>

        /**
         * Obtain the secured privateKey.
         *
         * @param pKeySet  the keySet
         * @param pKeyPair the keyPair
         * @return the securedPrivateKey
         * @throws GordianException on error
         */
        byte[] securePrivateKey(final GordianKeySet pKeySet,
                                final GordianKeyPair pKeyPair) throws GordianException {
<span class="fc" id="L266">            return pKeySet.securePrivateKey(pKeyPair);</span>
        }

        /**
         * Build the corresponding certificate chain.
         *
         * @param pKeyStore the keyStore
         * @return the certificate chain
         */
        List&lt;GordianCertificate&gt; buildChain(final GordianBaseKeyStore pKeyStore) {
            /* Create the chain */
<span class="fc" id="L277">            final List&lt;GordianKeyStoreCertificateKey&gt; myKeys = getCertificateChain();</span>
<span class="fc" id="L278">            final List&lt;GordianCertificate&gt; myChain = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">            for (GordianKeyStoreCertificateKey myKey : myKeys) {</span>
<span class="fc" id="L280">                myChain.add(pKeyStore.getCertificate(myKey));</span>
<span class="fc" id="L281">            }</span>
<span class="fc" id="L282">            return myChain;</span>
        }

        /**
         * Build the corresponding keyStoreEntry.
         *
         * @param pKeyStore the keyStore
         * @param pPassword the password
         * @return the keyStorePair entry
         * @throws GordianException on error
         */
        GordianCoreKeyStorePair buildEntry(final GordianBaseKeyStore pKeyStore,
                                           final char[] pPassword) throws GordianException {
            /* Create the chain */
<span class="fc" id="L296">            final List&lt;GordianCertificate&gt; myChain = buildChain(pKeyStore);</span>

            /* Resolve securing lock */
<span class="fc" id="L299">            final GordianKeySetLock myHash = getSecuringLock().buildEntry(pKeyStore, pPassword);</span>

            /* derive the keyPair */
<span class="fc" id="L302">            final GordianKeySet myKeySet = myHash.getKeySet();</span>
<span class="fc" id="L303">            final GordianCoreCertificate myCert = (GordianCoreCertificate) myChain.get(0);</span>
<span class="fc" id="L304">            final GordianKeyPair myPair = myKeySet.deriveKeyPair(myCert.getX509KeySpec(), getSecuredKey());</span>

            /* Create the entry */
<span class="fc" id="L307">            return new GordianCoreKeyStorePair(myPair, myChain, getCreationDate());</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L314">                return true;</span>
            }
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L317">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">            if (!(pThat instanceof GordianKeyStorePairElement)) {</span>
<span class="nc" id="L322">                return false;</span>
            }
<span class="fc" id="L324">            final GordianKeyStorePairElement myThat = (GordianKeyStorePairElement) pThat;</span>

            /* Check that the hashes match */
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">            return Arrays.equals(theSecuredKey, myThat.getSecuredKey())</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(getSecuringLockBytes(), myThat.getSecuringLockBytes())</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">                    &amp;&amp; theChain.equals(myThat.getCertificateChain())</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L335">            return Arrays.hashCode(theSecuredKey)</span>
<span class="nc" id="L336">                    + Arrays.hashCode(getSecuringLockBytes())</span>
<span class="nc" id="L337">                    + theChain.hashCode()</span>
<span class="nc" id="L338">                    + super.hashCode();</span>
        }
    }

    /**
     * KeyStore lock Element.
     */
    class GordianKeyStoreLockElement
            extends GordianCoreKeyStoreEntry {
        /**
         * The hash.
         */
        private final byte[] theLock;

        /**
         * Constructor.
         *
         * @param pLock the lock.
         */
<span class="fc" id="L357">        GordianKeyStoreLockElement(final GordianKeySetLock pLock) {</span>
            /* Store details */
<span class="fc" id="L359">            theLock = pLock.getLockBytes();</span>
<span class="fc" id="L360">        }</span>

        /**
         * Constructor.
         *
         * @param pLock the lock.
         * @param pDate the creation date
         */
        GordianKeyStoreLockElement(final byte[] pLock,
                                   final LocalDate pDate) {
            /* Store details */
<span class="fc" id="L371">            super(pDate);</span>
<span class="fc" id="L372">            theLock = pLock;</span>
<span class="fc" id="L373">        }</span>

        /**
         * Obtain the hash.
         *
         * @return the hash
         */
        byte[] getLock() {
<span class="fc" id="L381">            return theLock;</span>
        }

        /**
         * Obtain the corresponding keyStoreEntry.
         *
         * @param pKeyStore the keyStore
         * @param pPassword the password
         * @return the keyStore certificate entry
         * @throws GordianException on error
         */
        GordianKeySetLock buildEntry(final GordianBaseKeyStore pKeyStore,
                                     final char[] pPassword) throws GordianException {
            /* Resolve the hash */
<span class="fc" id="L395">            final GordianLockFactory myFactory = pKeyStore.getFactory().getLockFactory();</span>
<span class="fc" id="L396">            return myFactory.resolveKeySetLock(theLock, pPassword);</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="nc bnc" id="L402" title="All 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L403">                return true;</span>
            }
<span class="nc bnc" id="L405" title="All 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L406">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="nc bnc" id="L410" title="All 2 branches missed.">            if (!(pThat instanceof GordianKeyStoreLockElement)) {</span>
<span class="nc" id="L411">                return false;</span>
            }
<span class="nc" id="L413">            final GordianKeyStoreLockElement myThat = (GordianKeyStoreLockElement) pThat;</span>

            /* Check that the hashes match */
<span class="nc bnc" id="L416" title="All 2 branches missed.">            return Arrays.equals(theLock, myThat.getLock())</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L422">            return Arrays.hashCode(theLock)</span>
<span class="nc" id="L423">                    + super.hashCode();</span>
        }
    }

    /**
     * KeyStore key Element.
     *
     * @param &lt;T&gt; the key type
     */
    class GordianKeyStoreKeyElement&lt;T extends GordianKeySpec&gt;
            extends GordianCoreKeyStoreEntry {
        /**
         * The keyType.
         */
        private final T theKeyType;

        /**
         * The securedKey.
         */
        private final byte[] theSecuredKey;

        /**
         * The securing lock.
         */
        private final GordianKeyStoreLockElement theSecuringLock;

        /**
         * Constructor.
         *
         * @param pFactory  the factory
         * @param pSpec     the passwordLockSpec
         * @param pKey      the key
         * @param pPassword the securing password.
         * @throws GordianException on error
         */
        GordianKeyStoreKeyElement(final GordianFactory pFactory,
                                  final GordianPasswordLockSpec pSpec,
                                  final GordianKey&lt;T&gt; pKey,
<span class="fc" id="L461">                                  final char[] pPassword) throws GordianException {</span>
            /* Create a securing lock */
<span class="fc" id="L463">            final GordianLockFactory myFactory = pFactory.getLockFactory();</span>
<span class="fc" id="L464">            final GordianKeySetLock myLock = myFactory.newKeySetLock(pSpec, pPassword);</span>
<span class="fc" id="L465">            final GordianKeySet myKeySet = myLock.getKeySet();</span>

            /* Store details */
<span class="fc" id="L468">            theKeyType = pKey.getKeyType();</span>
<span class="fc" id="L469">            theSecuredKey = myKeySet.secureKey(pKey);</span>
<span class="fc" id="L470">            theSecuringLock = new GordianKeyStoreLockElement(myLock);</span>
<span class="fc" id="L471">        }</span>

        /**
         * Constructor.
         *
         * @param pKeyType      the keyType
         * @param pSecuredKey   the key
         * @param pSecuringLock the securing lock.
         * @param pDate         the creation date
         */
        GordianKeyStoreKeyElement(final T pKeyType,
                                  final byte[] pSecuredKey,
                                  final byte[] pSecuringLock,
                                  final LocalDate pDate) {
            /* Store details */
<span class="fc" id="L486">            super(pDate);</span>
<span class="fc" id="L487">            theKeyType = pKeyType;</span>
<span class="fc" id="L488">            theSecuredKey = pSecuredKey;</span>
<span class="fc" id="L489">            theSecuringLock = new GordianKeyStoreLockElement(pSecuringLock, pDate);</span>
<span class="fc" id="L490">        }</span>

        /**
         * Obtain the keyType.
         *
         * @return the keyType
         */
        T getKeyType() {
<span class="fc" id="L498">            return theKeyType;</span>
        }

        /**
         * Obtain the securedKey.
         *
         * @return the securedKey
         */
        byte[] getSecuredKey() {
<span class="fc" id="L507">            return theSecuredKey;</span>
        }

        /**
         * Obtain the securingLock.
         *
         * @return the securingLock
         */
        GordianKeyStoreLockElement getSecuringLock() {
<span class="nc" id="L516">            return theSecuringLock;</span>
        }

        /**
         * Obtain the securingLockBytes.
         *
         * @return the securingLockBytes
         */
        byte[] getSecuringLockBytes() {
<span class="fc" id="L525">            return theSecuringLock.getLock();</span>
        }

        /**
         * Obtain the corresponding keyStoreEntry.
         *
         * @param pKeyStore the keyStore
         * @param pPassword the password
         * @return the keyStore certificate entry
         * @throws GordianException on error
         */
        GordianCoreKeyStoreKey&lt;T&gt; buildEntry(final GordianBaseKeyStore pKeyStore,
                                             final char[] pPassword) throws GordianException {
            /* Resolve securing lock */
<span class="fc" id="L539">            final GordianKeySetLock myLock = theSecuringLock.buildEntry(pKeyStore, pPassword);</span>

            /* derive the key */
<span class="fc" id="L542">            final GordianKeySet myKeySet = myLock.getKeySet();</span>
<span class="fc" id="L543">            final GordianKey&lt;T&gt; myKey = myKeySet.deriveKey(theSecuredKey, theKeyType);</span>
<span class="fc" id="L544">            return new GordianCoreKeyStoreKey&lt;&gt;(myKey, getCreationDate());</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="pc bpc" id="L550" title="1 of 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L551">                return true;</span>
            }
<span class="pc bpc" id="L553" title="1 of 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L554">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">            if (!(pThat instanceof GordianKeyStoreKeyElement)) {</span>
<span class="nc" id="L559">                return false;</span>
            }
<span class="fc" id="L561">            final GordianKeyStoreKeyElement&lt;?&gt; myThat = (GordianKeyStoreKeyElement&lt;?&gt;) pThat;</span>

            /* Check that the hashes match */
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">            return theKeyType.equals(myThat.getKeyType())</span>
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(theSecuredKey, myThat.getSecuredKey())</span>
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(getSecuringLockBytes(), myThat.getSecuringLockBytes())</span>
<span class="pc bpc" id="L567" title="1 of 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L572">            return theKeyType.hashCode()</span>
<span class="nc" id="L573">                    + Arrays.hashCode(theSecuredKey)</span>
<span class="nc" id="L574">                    + Arrays.hashCode(getSecuringLockBytes())</span>
<span class="nc" id="L575">                    + super.hashCode();</span>
        }
    }

    /**
     * KeyStore keySet Element.
     */
    class GordianKeyStoreSetElement
            extends GordianCoreKeyStoreEntry {
        /**
         * The keyMap.
         */
        private final byte[] theSecuredKeySet;

        /**
         * The securing lock.
         */
        private final GordianKeyStoreLockElement theSecuringLock;

        /**
         * Constructor.
         *
         * @param pFactory  the factory
         * @param pSpec     the keySetHashSpec
         * @param pKeySet   the keySet
         * @param pPassword the securing password.
         * @throws GordianException on error
         */
        GordianKeyStoreSetElement(final GordianFactory pFactory,
                                  final GordianPasswordLockSpec pSpec,
                                  final GordianKeySet pKeySet,
<span class="fc" id="L606">                                  final char[] pPassword) throws GordianException {</span>
            /* Create a securing hash */
<span class="fc" id="L608">            final GordianLockFactory myFactory = pFactory.getLockFactory();</span>
<span class="fc" id="L609">            final GordianKeySetLock myLock = myFactory.newKeySetLock(pSpec, pPassword);</span>
<span class="fc" id="L610">            final GordianKeySet myKeySet = myLock.getKeySet();</span>
<span class="fc" id="L611">            theSecuringLock = new GordianKeyStoreLockElement(myLock);</span>

            /* Secure the keySet */
<span class="fc" id="L614">            theSecuredKeySet = myKeySet.secureKeySet(pKeySet);</span>
<span class="fc" id="L615">        }</span>

        /**
         * Constructor.
         *
         * @param pSecuredKeySet the securedKeySet
         * @param pSecuringLock  the securing lock.
         * @param pDate          the creation date
         */
        GordianKeyStoreSetElement(final byte[] pSecuredKeySet,
                                  final byte[] pSecuringLock,
                                  final LocalDate pDate) {
            /* Store details */
<span class="fc" id="L628">            super(pDate);</span>
<span class="fc" id="L629">            theSecuredKeySet = pSecuredKeySet;</span>
<span class="fc" id="L630">            theSecuringLock = new GordianKeyStoreLockElement(pSecuringLock, pDate);</span>
<span class="fc" id="L631">        }</span>

        /**
         * Obtain the keyType.
         *
         * @return the keyType
         */
        byte[] getSecuredKeySet() {
<span class="fc" id="L639">            return theSecuredKeySet;</span>
        }

        /**
         * Obtain the securingLock.
         *
         * @return the securingLock
         */
        GordianKeyStoreLockElement getSecuringLock() {
<span class="nc" id="L648">            return theSecuringLock;</span>
        }

        /**
         * Obtain the securingLockBytes.
         *
         * @return the securingLockBytes
         */
        byte[] getSecuringLockBytes() {
<span class="fc" id="L657">            return theSecuringLock.getLock();</span>
        }

        /**
         * Obtain the corresponding keyStoreEntry.
         *
         * @param pKeyStore the keyStore
         * @param pPassword the password
         * @return the keyStore certificate entry
         * @throws GordianException on error
         */
        GordianCoreKeyStoreSet buildEntry(final GordianBaseKeyStore pKeyStore,
                                          final char[] pPassword) throws GordianException {
            /* Resolve the lock */
<span class="fc" id="L671">            final GordianKeySetLock myLock = theSecuringLock.buildEntry(pKeyStore, pPassword);</span>
<span class="fc" id="L672">            final GordianKeySet mySecuringKeySet = myLock.getKeySet();</span>

            /* Derive the keySet */
<span class="fc" id="L675">            final GordianKeySet myKeySet = mySecuringKeySet.deriveKeySet(theSecuredKeySet);</span>

            /* build the new entry */
<span class="fc" id="L678">            return new GordianCoreKeyStoreSet(myKeySet, getCreationDate());</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="pc bpc" id="L684" title="1 of 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L685">                return true;</span>
            }
<span class="pc bpc" id="L687" title="1 of 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L688">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="pc bpc" id="L692" title="1 of 2 branches missed.">            if (!(pThat instanceof GordianKeyStoreSetElement)) {</span>
<span class="nc" id="L693">                return false;</span>
            }
<span class="fc" id="L695">            final GordianKeyStoreSetElement myThat = (GordianKeyStoreSetElement) pThat;</span>

            /* Check that the hashes match */
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">            return Arrays.equals(theSecuredKeySet, myThat.getSecuredKeySet())</span>
<span class="pc bpc" id="L699" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(getSecuringLockBytes(), myThat.getSecuringLockBytes())</span>
<span class="pc bpc" id="L700" title="1 of 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L705">            return Arrays.hashCode(theSecuredKeySet)</span>
<span class="nc" id="L706">                    + Arrays.hashCode(getSecuringLockBytes())</span>
<span class="nc" id="L707">                    + super.hashCode();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>