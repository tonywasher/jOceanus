<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianKeyStoreDocument.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.gordianknot.impl.core.keystore</a> &gt; <span class="el_source">GordianKeyStoreDocument.java</span></div><h1>GordianKeyStoreDocument.java</h1><pre class="source lang-java linenums">/*
 * GordianKnot: Security Suite
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.gordianknot.impl.core.keystore;

import io.github.tonywasher.joceanus.gordianknot.api.base.GordianException;
import io.github.tonywasher.joceanus.gordianknot.api.base.GordianKeySpec;
import io.github.tonywasher.joceanus.gordianknot.api.cert.GordianCertificate;
import io.github.tonywasher.joceanus.gordianknot.api.cert.GordianCertificateId;
import io.github.tonywasher.joceanus.gordianknot.api.factory.GordianFactory;
import io.github.tonywasher.joceanus.gordianknot.api.factory.GordianKnuthObfuscater;
import io.github.tonywasher.joceanus.gordianknot.api.keystore.GordianKeyStoreEntry;
import io.github.tonywasher.joceanus.gordianknot.impl.core.base.GordianDataConverter;
import io.github.tonywasher.joceanus.gordianknot.impl.core.cert.GordianCoreCertificate;
import io.github.tonywasher.joceanus.gordianknot.impl.core.cert.GordianCoreCertificateId;
import io.github.tonywasher.joceanus.gordianknot.impl.core.exc.GordianDataException;
import io.github.tonywasher.joceanus.gordianknot.impl.core.exc.GordianIOException;
import io.github.tonywasher.joceanus.gordianknot.impl.core.keystore.GordianBaseKeyStore.GordianKeyStoreCertificateKey;
import io.github.tonywasher.joceanus.gordianknot.impl.core.keystore.GordianKeyStoreElement.GordianKeyStoreCertificateElement;
import io.github.tonywasher.joceanus.gordianknot.impl.core.keystore.GordianKeyStoreElement.GordianKeyStoreKeyElement;
import io.github.tonywasher.joceanus.gordianknot.impl.core.keystore.GordianKeyStoreElement.GordianKeyStoreLockElement;
import io.github.tonywasher.joceanus.gordianknot.impl.core.keystore.GordianKeyStoreElement.GordianKeyStorePairElement;
import io.github.tonywasher.joceanus.gordianknot.impl.core.keystore.GordianKeyStoreElement.GordianKeyStoreSetElement;
import io.github.tonywasher.joceanus.gordianknot.impl.core.lock.GordianPasswordLockSpecASN1;
import org.bouncycastle.asn1.x500.X500Name;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;

import javax.xml.XMLConstants;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import java.io.IOException;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

/**
 * KeyStore Document.
 */
public final class GordianKeyStoreDocument {
    /**
     * The Invalid XML error.
     */
<span class="fc" id="L62">    private static final DateTimeFormatter DATEFORMATTER = DateTimeFormatter.BASIC_ISO_DATE;</span>

    /**
     * The Invalid XML error.
     */
    private static final String ERROR_BADXML = &quot;Invalid XML&quot;;

    /**
     * The KeyStore element.
     */
    private static final String DOC_KEYSTORE = &quot;KeyStore&quot;;

    /**
     * The KeySetSpec attribute.
     */
    private static final String ATTR_KEYSETSPEC = &quot;KeySetSpec&quot;;

    /**
     * The CreationDate attribute.
     */
    private static final String ATTR_DATE = &quot;CreationDate&quot;;

    /**
     * The Aliases element.
     */
    private static final String ELEMENT_ALIASES = &quot;Aliases&quot;;

    /**
     * The Alias element.
     */
    private static final String ATTR_ALIAS = &quot;Alias&quot;;

    /**
     * The Certificates element.
     */
    private static final String ELEMENT_CERTIFICATES = &quot;Certificates&quot;;

    /**
     * The PairCertificate element.
     */
    private static final String ELEMENT_PAIRCERT = &quot;PairCertificate&quot;;

    /**
     * The keyType attribute.
     */
    private static final String ATTR_KEYSPEC = &quot;KeySpec&quot;;

    /**
     * The securedKey element.
     */
    private static final String ELEMENT_SECUREDKEY = &quot;SecuredKey&quot;;

    /**
     * The lock element.
     */
    private static final String ELEMENT_LOCK = &quot;LockBytes&quot;;

    /**
     * The CertificateKey element.
     */
    private static final String ELEMENT_CERTKEY = &quot;CertificateKey&quot;;

    /**
     * The Subject element.
     */
    private static final String ELEMENT_SUBJECT = &quot;Subject&quot;;

    /**
     * The Issuer element.
     */
    private static final String ELEMENT_ISSUER = &quot;Issuer&quot;;

    /**
     * The Name element.
     */
    private static final String ELEMENT_NAME = &quot;Name&quot;;

    /**
     * The Id element.
     */
    private static final String ELEMENT_ID = &quot;Id&quot;;

    /**
     * The keyStore.
     */
    private final GordianBaseKeyStore theKeyStore;

    /**
     * The document.
     */
    private final Document theDocument;

    /**
     * Constructor from keyStore.
     *
     * @param pKeyStore the keyStore
     * @throws GordianException on error
     */
<span class="fc" id="L160">    public GordianKeyStoreDocument(final GordianBaseKeyStore pKeyStore) throws GordianException {</span>
        try {
            /* Store the keyStore */
<span class="fc" id="L163">            theKeyStore = pKeyStore;</span>

            /* Create the document */
<span class="fc" id="L166">            final DocumentBuilderFactory myFactory = DocumentBuilderFactory.newInstance();</span>
<span class="fc" id="L167">            myFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>
<span class="fc" id="L168">            myFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, &quot;&quot;);</span>
<span class="fc" id="L169">            myFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, &quot;&quot;);</span>
<span class="fc" id="L170">            final DocumentBuilder myBuilder = myFactory.newDocumentBuilder();</span>
<span class="fc" id="L171">            theDocument = myBuilder.newDocument();</span>

            /* Create the main document node */
<span class="fc" id="L174">            final Element myMain = theDocument.createElement(DOC_KEYSTORE);</span>
<span class="fc" id="L175">            theDocument.appendChild(myMain);</span>

            /* Record the keySetSpec */
<span class="fc" id="L178">            final GordianPasswordLockSpecASN1 mySpecASN1 = new GordianPasswordLockSpecASN1(pKeyStore.getPasswordLockSpec());</span>
<span class="fc" id="L179">            final String myAttrSpec = GordianDataConverter.byteArrayToBase64(mySpecASN1.getEncodedBytes());</span>
<span class="fc" id="L180">            myMain.setAttribute(ATTR_KEYSETSPEC, myAttrSpec);</span>

            /* Create the aliases */
<span class="fc" id="L183">            final Element myAliases = theDocument.createElement(ELEMENT_ALIASES);</span>
<span class="fc" id="L184">            myMain.appendChild(myAliases);</span>
<span class="fc" id="L185">            buildAliases(myAliases);</span>

            /* Create the certificates */
<span class="fc" id="L188">            final Element myCerts = theDocument.createElement(ELEMENT_CERTIFICATES);</span>
<span class="fc" id="L189">            myMain.appendChild(myCerts);</span>
<span class="fc" id="L190">            buildCertificates(myCerts);</span>

<span class="nc" id="L192">        } catch (ParserConfigurationException e) {</span>
<span class="nc" id="L193">            throw new GordianIOException(&quot;Failed to initialise author&quot;, e);</span>
<span class="fc" id="L194">        }</span>
<span class="fc" id="L195">    }</span>

    /**
     * Constructor from document.
     *
     * @param pFactory  the factory
     * @param pDocument the document
     * @throws GordianException on error
     */
    public GordianKeyStoreDocument(final GordianFactory pFactory,
<span class="fc" id="L205">                                   final Document pDocument) throws GordianException {</span>
        /* Access the document element */
<span class="fc" id="L207">        final Element myDocElement = pDocument.getDocumentElement();</span>

        /* Check that it is correct document */
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (!DOC_KEYSTORE.equals(myDocElement.getNodeName())) {</span>
<span class="nc" id="L211">            throw new GordianDataException(&quot;Invalid Document&quot;);</span>
        }

        /* Access the keySetSpec */
<span class="fc" id="L215">        final String myAttrSpec = myDocElement.getAttribute(ATTR_KEYSETSPEC);</span>
<span class="fc" id="L216">        final byte[] myAttrArray = GordianDataConverter.base64ToByteArray(myAttrSpec);</span>
<span class="fc" id="L217">        final GordianPasswordLockSpecASN1 mySpecASN1 = GordianPasswordLockSpecASN1.getInstance(myAttrArray);</span>

        /* Create the empty keyStore */
<span class="fc" id="L220">        theKeyStore = (GordianBaseKeyStore) pFactory.getAsyncFactory().getKeyStoreFactory().createKeyStore(mySpecASN1.getLockSpec());</span>
<span class="fc" id="L221">        theDocument = pDocument;</span>

        /* Loop through the nodes */
<span class="fc" id="L224">        Node myNode = myDocElement.getFirstChild();</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="fc" id="L227">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is the aliases Node */
<span class="fc bfc" id="L230" title="All 2 branches covered.">            if (ELEMENT_ALIASES.equals(myNodeName)) {</span>
                /* Parse the aliases */
<span class="fc" id="L232">                parseAliases(myNode);</span>
            }

            /* If this is the certificates Node */
<span class="fc bfc" id="L236" title="All 2 branches covered.">            if (ELEMENT_CERTIFICATES.equals(myNodeName)) {</span>
                /* Parse the certificates */
<span class="fc" id="L238">                parseCertificates(myNode);</span>
            }

            /* Move to next node */
<span class="fc" id="L242">            myNode = myNode.getNextSibling();</span>
<span class="fc" id="L243">        }</span>
<span class="fc" id="L244">    }</span>

    /**
     * Obtain the keyStore.
     *
     * @return the keyStore
     */
    public GordianBaseKeyStore getKeyStore() {
<span class="fc" id="L252">        return theKeyStore;</span>
    }

    /**
     * Obtain the document.
     *
     * @return the document
     */
    public Document getDocument() {
<span class="fc" id="L261">        return theDocument;</span>
    }

    /**
     * build the aliases.
     *
     * @param pAliases the aliases element
     * @throws GordianException on error
     */
    private void buildAliases(final Node pAliases) throws GordianException {
        /* Access the Alias entries */
<span class="fc bfc" id="L272" title="All 2 branches covered.">        for (Entry&lt;String, GordianKeyStoreEntry&gt; myEntry : theKeyStore.getAliasMap().entrySet()) {</span>
            /* Determine the entry type */
<span class="fc" id="L274">            final GordianKeyStoreEntry myElement = myEntry.getValue();</span>
<span class="fc" id="L275">            final GordianStoreEntryType myType = GordianStoreEntryType.determineEntryType(myElement);</span>

            /* Build alias entry */
<span class="fc" id="L278">            final Element myAliasEl = theDocument.createElement(myType.getElementName());</span>
<span class="fc" id="L279">            myAliasEl.setAttribute(ATTR_ALIAS, myEntry.getKey());</span>
<span class="fc" id="L280">            myAliasEl.setAttribute(ATTR_DATE, myElement.getCreationDate().format(DATEFORMATTER));</span>
<span class="fc" id="L281">            pAliases.appendChild(myAliasEl);</span>

            /* Switch on element type */
<span class="pc bpc" id="L284" title="2 of 5 branches missed.">            switch (myType) {</span>
                case KEY:
<span class="fc" id="L286">                    buildKeyElement(myAliasEl, (GordianKeyStoreKeyElement&lt;?&gt;) myElement);</span>
<span class="fc" id="L287">                    break;</span>
                case KEYSET:
<span class="fc" id="L289">                    buildKeySetElement(myAliasEl, (GordianKeyStoreSetElement) myElement);</span>
<span class="fc" id="L290">                    break;</span>
                case KEYSETLOCK:
<span class="nc" id="L292">                    buildKeySetLockElement(myAliasEl, (GordianKeyStoreLockElement) myElement);</span>
<span class="nc" id="L293">                    break;</span>
                case PRIVATEKEYPAIR:
<span class="fc" id="L295">                    buildPrivateKeyElement(myAliasEl, (GordianKeyStorePairElement) myElement);</span>
<span class="fc" id="L296">                    break;</span>
                case TRUSTEDPAIRCERT:
                default:
<span class="nc" id="L299">                    buildCertificateElement(myAliasEl, (GordianKeyStoreCertificateElement) myElement);</span>
                    break;
            }
<span class="fc" id="L302">        }</span>
<span class="fc" id="L303">    }</span>

    /**
     * build the keySetHash element.
     *
     * @param pNode  the keySetHash node to build
     * @param pEntry the keySetHash entry
     */
    private void buildKeySetLockElement(final Element pNode,
                                        final GordianKeyStoreLockElement pEntry) {
        /* Build lock entry */
<span class="nc" id="L314">        final Element myLockEl = theDocument.createElement(ELEMENT_LOCK);</span>
<span class="nc" id="L315">        pNode.appendChild(myLockEl);</span>
<span class="nc" id="L316">        myLockEl.setTextContent(GordianDataConverter.byteArrayToBase64(pEntry.getLock()));</span>
<span class="nc" id="L317">    }</span>

    /**
     * build the keySet element.
     *
     * @param pNode  the keySet node to build
     * @param pEntry the keySet entry
     */
    private void buildKeySetElement(final Element pNode,
                                    final GordianKeyStoreSetElement pEntry) {
        /* Build securedKey entry */
<span class="fc" id="L328">        final Element myKeyEl = theDocument.createElement(ELEMENT_SECUREDKEY);</span>
<span class="fc" id="L329">        pNode.appendChild(myKeyEl);</span>
<span class="fc" id="L330">        myKeyEl.setTextContent(GordianDataConverter.byteArrayToBase64(pEntry.getSecuredKeySet()));</span>

        /* Build lock entry */
<span class="fc" id="L333">        final Element myLockEl = theDocument.createElement(ELEMENT_LOCK);</span>
<span class="fc" id="L334">        pNode.appendChild(myLockEl);</span>
<span class="fc" id="L335">        myLockEl.setTextContent(GordianDataConverter.byteArrayToBase64(pEntry.getSecuringLockBytes()));</span>
<span class="fc" id="L336">    }</span>

    /**
     * build the key element.
     *
     * @param pNode  the key node to build
     * @param pEntry the key entry
     * @throws GordianException on error
     */
    private void buildKeyElement(final Element pNode,
                                 final GordianKeyStoreKeyElement&lt;?&gt; pEntry) throws GordianException {
        /* Build securedKey entry */
<span class="fc" id="L348">        final Element myKeyEl = theDocument.createElement(ELEMENT_SECUREDKEY);</span>
<span class="fc" id="L349">        pNode.appendChild(myKeyEl);</span>
<span class="fc" id="L350">        myKeyEl.setTextContent(GordianDataConverter.byteArrayToBase64(pEntry.getSecuredKey()));</span>

        /* Add the keySpec */
<span class="fc" id="L353">        final GordianKnuthObfuscater myObfuscater = theKeyStore.getFactory().getObfuscater();</span>
<span class="fc" id="L354">        final int myId = myObfuscater.deriveExternalIdFromType(pEntry.getKeyType());</span>
<span class="fc" id="L355">        myKeyEl.setAttribute(ATTR_KEYSPEC, Integer.toString(myId));</span>

        /* Build lock entry */
<span class="fc" id="L358">        final Element myLockEl = theDocument.createElement(ELEMENT_LOCK);</span>
<span class="fc" id="L359">        pNode.appendChild(myLockEl);</span>
<span class="fc" id="L360">        myLockEl.setTextContent(GordianDataConverter.byteArrayToBase64(pEntry.getSecuringLockBytes()));</span>
<span class="fc" id="L361">    }</span>

    /**
     * build the privateKey element.
     *
     * @param pNode  the privateKey node to build
     * @param pEntry the privateKey entry
     * @throws GordianException on error
     */
    private void buildPrivateKeyElement(final Element pNode,
                                        final GordianKeyStorePairElement pEntry) throws GordianException {
        /* Build securedKey entry */
<span class="fc" id="L373">        final Element myKeyEl = theDocument.createElement(ELEMENT_SECUREDKEY);</span>
<span class="fc" id="L374">        pNode.appendChild(myKeyEl);</span>
<span class="fc" id="L375">        myKeyEl.setTextContent(GordianDataConverter.byteArrayToBase64(pEntry.getSecuredKey()));</span>

        /* Build lock entry */
<span class="fc" id="L378">        final Element myLockEl = theDocument.createElement(ELEMENT_LOCK);</span>
<span class="fc" id="L379">        pNode.appendChild(myLockEl);</span>
<span class="fc" id="L380">        myLockEl.setTextContent(GordianDataConverter.byteArrayToBase64(pEntry.getSecuringLockBytes()));</span>

        /* Build certificates entry */
<span class="fc" id="L383">        final Element myChainEl = theDocument.createElement(ELEMENT_CERTIFICATES);</span>
<span class="fc" id="L384">        pNode.appendChild(myChainEl);</span>

        /* Build the certificate chain */
<span class="fc bfc" id="L387" title="All 2 branches covered.">        for (GordianKeyStoreCertificateKey myCert : pEntry.getCertificateChain()) {</span>
            /* Build certificateKey */
<span class="fc" id="L389">            buildCertificateKey(myChainEl, myCert);</span>
<span class="fc" id="L390">        }</span>
<span class="fc" id="L391">    }</span>

    /**
     * build the certificate element.
     *
     * @param pNode  the certificate node to build
     * @param pEntry the certificate entry
     * @throws GordianException on error
     */
    private void buildCertificateElement(final Element pNode,
                                         final GordianKeyStoreCertificateElement pEntry) throws GordianException {
        /* Build certificateKey */
<span class="nc" id="L403">        buildCertificateKey(pNode, pEntry.getCertificateKey());</span>
<span class="nc" id="L404">    }</span>

    /**
     * build the certificateKey element.
     *
     * @param pNode the holding node
     * @param pKey  the certificate key
     * @throws GordianException on error
     */
    private void buildCertificateKey(final Element pNode,
                                     final GordianKeyStoreCertificateKey pKey) throws GordianException {
        /* Build certificateKey entry */
<span class="fc" id="L416">        final Element myKeyEl = theDocument.createElement(ELEMENT_CERTKEY);</span>
<span class="fc" id="L417">        pNode.appendChild(myKeyEl);</span>

        /* Build subject entry */
<span class="fc" id="L420">        final Element mySubEl = theDocument.createElement(ELEMENT_SUBJECT);</span>
<span class="fc" id="L421">        myKeyEl.appendChild(mySubEl);</span>
<span class="fc" id="L422">        buildCertificateId(mySubEl, pKey.getSubject());</span>

        /* Build issuer entry */
<span class="fc" id="L425">        final Element myIssEl = theDocument.createElement(ELEMENT_ISSUER);</span>
<span class="fc" id="L426">        myKeyEl.appendChild(myIssEl);</span>
<span class="fc" id="L427">        buildCertificateId(myIssEl, pKey.getIssuer());</span>
<span class="fc" id="L428">    }</span>

    /**
     * build the certificateId element.
     *
     * @param pNode the holding node
     * @param pId   the certificate id
     * @throws GordianException on error
     */
    private void buildCertificateId(final Element pNode,
                                    final GordianCertificateId pId) throws GordianException {
        /* protect against exceptions */
        try {
            /* Build Name entry */
<span class="fc" id="L442">            final Element myNameEl = theDocument.createElement(ELEMENT_NAME);</span>
<span class="fc" id="L443">            pNode.appendChild(myNameEl);</span>
<span class="fc" id="L444">            myNameEl.setTextContent(GordianDataConverter.byteArrayToBase64(pId.getName().toASN1Primitive().getEncoded()));</span>

            /* Build id entry */
<span class="fc" id="L447">            final Element myIdEl = theDocument.createElement(ELEMENT_ID);</span>
<span class="fc" id="L448">            pNode.appendChild(myIdEl);</span>
<span class="fc" id="L449">            myIdEl.setTextContent(GordianDataConverter.byteArrayToBase64(pId.getId()));</span>

            /* Handle exceptions */
<span class="nc" id="L452">        } catch (IOException e) {</span>
<span class="nc" id="L453">            throw new GordianIOException(&quot;Failed to parse certificate Id&quot;, e);</span>
<span class="fc" id="L454">        }</span>
<span class="fc" id="L455">    }</span>

    /**
     * build the certificates.
     *
     * @param pCerts the certificates element
     */
    private void buildCertificates(final Node pCerts) {
        /* Access the Subject MapOfMaps */
<span class="fc bfc" id="L464" title="All 2 branches covered.">        for (Map&lt;GordianCertificateId, GordianCertificate&gt; myMap : theKeyStore.getSubjectMapOfMaps().values()) {</span>
<span class="fc bfc" id="L465" title="All 2 branches covered.">            for (GordianCertificate myCert : myMap.values()) {</span>
                /* Build certificate entry */
<span class="fc" id="L467">                final Element myCertEl = theDocument.createElement(ELEMENT_PAIRCERT);</span>
<span class="fc" id="L468">                pCerts.appendChild(myCertEl);</span>

                /* Build the certificate element */
<span class="fc" id="L471">                myCertEl.setTextContent(GordianDataConverter.byteArrayToBase64(myCert.getEncoded()));</span>
<span class="fc" id="L472">            }</span>
<span class="fc" id="L473">        }</span>
<span class="fc" id="L474">    }</span>

    /**
     * parse the aliases.
     *
     * @param pAliases the aliases element
     * @throws GordianException on error
     */
    private void parseAliases(final Node pAliases) throws GordianException {
        /* Loop through the nodes */
<span class="fc" id="L484">        Node myNode = pAliases.getFirstChild();</span>
<span class="fc bfc" id="L485" title="All 2 branches covered.">        while (myNode != null) {</span>
            /* Determine the entry type */
<span class="fc" id="L487">            final GordianStoreEntryType myType = GordianStoreEntryType.determineEntryType(myNode.getNodeName());</span>

            /* Access alias and creationDate */
<span class="fc" id="L490">            final String myAlias = ((Element) myNode).getAttribute(ATTR_ALIAS);</span>
<span class="fc" id="L491">            final LocalDate myDate = LocalDate.parse(((Element) myNode).getAttribute(ATTR_DATE), DATEFORMATTER);</span>

            /* Switch on element type */
<span class="pc bpc" id="L494" title="2 of 5 branches missed.">            switch (myType) {</span>
                case KEY:
<span class="fc" id="L496">                    parseKeyElement(myNode, myAlias, myDate);</span>
<span class="fc" id="L497">                    break;</span>
                case KEYSET:
<span class="fc" id="L499">                    parseKeySetElement(myNode, myAlias, myDate);</span>
<span class="fc" id="L500">                    break;</span>
                case KEYSETLOCK:
<span class="nc" id="L502">                    parseKeySetLockElement(myNode, myAlias, myDate);</span>
<span class="nc" id="L503">                    break;</span>
                case PRIVATEKEYPAIR:
<span class="fc" id="L505">                    parsePrivateKeyElement(myNode, myAlias, myDate);</span>
<span class="fc" id="L506">                    break;</span>
                case TRUSTEDPAIRCERT:
                default:
<span class="nc" id="L509">                    parseCertificateElement(myNode, myAlias, myDate);</span>
                    break;
            }

            /* Move to next node */
<span class="fc" id="L514">            myNode = myNode.getNextSibling();</span>
<span class="fc" id="L515">        }</span>
<span class="fc" id="L516">    }</span>

    /**
     * parse the keySetLock alias.
     *
     * @param pNode  the node to parse
     * @param pAlias the alias
     * @param pDate  the creation date
     */
    private void parseKeySetLockElement(final Node pNode,
                                        final String pAlias,
                                        final LocalDate pDate) {
        /* Loop through the nodes */
<span class="nc" id="L529">        Node myNode = pNode.getFirstChild();</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="nc" id="L532">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is a lock node */
<span class="nc bnc" id="L535" title="All 2 branches missed.">            if (ELEMENT_LOCK.equals(myNodeName)) {</span>
                /* Obtain the hash and build the entry */
<span class="nc" id="L537">                final byte[] myLock = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
<span class="nc" id="L538">                final GordianKeyStoreLockElement myEntry = new GordianKeyStoreLockElement(myLock, pDate);</span>
<span class="nc" id="L539">                theKeyStore.getAliasMap().put(pAlias, myEntry);</span>
<span class="nc" id="L540">                return;</span>
            }

            /* Move to next node */
<span class="nc" id="L544">            myNode = myNode.getNextSibling();</span>
<span class="nc" id="L545">        }</span>
<span class="nc" id="L546">    }</span>

    /**
     * parse the keySet alias.
     *
     * @param pNode  the node to parse
     * @param pAlias the alias
     * @param pDate  the creation date
     * @throws GordianException on error
     */
    private void parseKeySetElement(final Node pNode,
                                    final String pAlias,
                                    final LocalDate pDate) throws GordianException {
        /* Loop through the nodes */
<span class="fc" id="L560">        byte[] mySecuredKey = null;</span>
<span class="fc" id="L561">        Node myNode = pNode.getFirstChild();</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="fc" id="L564">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is a securedKey node */
<span class="fc bfc" id="L567" title="All 2 branches covered.">            if (ELEMENT_SECUREDKEY.equals(myNodeName)) {</span>
                /* Obtain the securedKey */
<span class="fc" id="L569">                mySecuredKey = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
            }

            /* If this is a lock node */
<span class="fc bfc" id="L573" title="All 2 branches covered.">            if (ELEMENT_LOCK.equals(myNodeName)) {</span>
                /* Check for valid xml */
<span class="pc bpc" id="L575" title="1 of 2 branches missed.">                if (mySecuredKey == null) {</span>
<span class="nc" id="L576">                    throw new GordianDataException(ERROR_BADXML);</span>
                }

                /* Obtain the lock and build the entry */
<span class="fc" id="L580">                final byte[] myLock = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
<span class="fc" id="L581">                final GordianKeyStoreSetElement myEntry = new GordianKeyStoreSetElement(mySecuredKey, myLock, pDate);</span>
<span class="fc" id="L582">                theKeyStore.getAliasMap().put(pAlias, myEntry);</span>
<span class="fc" id="L583">                return;</span>
            }

            /* Move to next node */
<span class="fc" id="L587">            myNode = myNode.getNextSibling();</span>
<span class="fc" id="L588">        }</span>
<span class="nc" id="L589">    }</span>

    /**
     * parse the key alias.
     *
     * @param pNode  the node to parse
     * @param pAlias the alias
     * @param pDate  the creation date
     * @throws GordianException on error
     */
    private void parseKeyElement(final Node pNode,
                                 final String pAlias,
                                 final LocalDate pDate) throws GordianException {
        /* Loop through the nodes */
<span class="fc" id="L603">        byte[] mySecuredKey = null;</span>
<span class="fc" id="L604">        GordianKeySpec mySpec = null;</span>
<span class="fc" id="L605">        Node myNode = pNode.getFirstChild();</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="fc" id="L608">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is a securedKey node */
<span class="fc bfc" id="L611" title="All 2 branches covered.">            if (ELEMENT_SECUREDKEY.equals(myNodeName)) {</span>
                /* Obtain the securedKey */
<span class="fc" id="L613">                mySecuredKey = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>

                /* Obtain the keySpec */
<span class="fc" id="L616">                final GordianKnuthObfuscater myObfuscater = theKeyStore.getFactory().getObfuscater();</span>
<span class="fc" id="L617">                final String mySpecId = ((Element) myNode).getAttribute(ATTR_KEYSPEC);</span>
<span class="fc" id="L618">                mySpec = (GordianKeySpec) myObfuscater.deriveTypeFromExternalId(Integer.parseInt(mySpecId));</span>
            }

            /* If this is a lock node */
<span class="fc bfc" id="L622" title="All 2 branches covered.">            if (ELEMENT_LOCK.equals(myNodeName)) {</span>
                /* Check for valid xml */
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">                if (mySecuredKey == null) {</span>
<span class="nc" id="L625">                    throw new GordianDataException(ERROR_BADXML);</span>
                }

                /* Obtain the lock and build the entry */
<span class="fc" id="L629">                final byte[] myLock = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
<span class="fc" id="L630">                final GordianKeyStoreKeyElement&lt;GordianKeySpec&gt; myEntry = new GordianKeyStoreKeyElement&lt;&gt;(mySpec, mySecuredKey, myLock, pDate);</span>
<span class="fc" id="L631">                theKeyStore.getAliasMap().put(pAlias, myEntry);</span>
<span class="fc" id="L632">                return;</span>
            }

            /* Move to next node */
<span class="fc" id="L636">            myNode = myNode.getNextSibling();</span>
<span class="fc" id="L637">        }</span>
<span class="nc" id="L638">    }</span>


    /**
     * parse the key alias.
     *
     * @param pNode  the node to parse
     * @param pAlias the alias
     * @param pDate  the creation date
     * @throws GordianException on error
     */
    private void parsePrivateKeyElement(final Node pNode,
                                        final String pAlias,
                                        final LocalDate pDate) throws GordianException {
        /* Loop through the nodes */
<span class="fc" id="L653">        byte[] mySecuredKey = null;</span>
<span class="fc" id="L654">        byte[] myLock = null;</span>
<span class="fc" id="L655">        final List&lt;GordianKeyStoreCertificateKey&gt; myChain = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L656">        Node myNode = pNode.getFirstChild();</span>
<span class="pc bpc" id="L657" title="1 of 2 branches missed.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="fc" id="L659">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is a securedKey node */
<span class="fc bfc" id="L662" title="All 2 branches covered.">            if (ELEMENT_SECUREDKEY.equals(myNodeName)) {</span>
                /* Obtain the securedKey */
<span class="fc" id="L664">                mySecuredKey = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
            }

            /* If this is a lock node */
<span class="fc bfc" id="L668" title="All 2 branches covered.">            if (ELEMENT_LOCK.equals(myNodeName)) {</span>
                /* Obtain the lock */
<span class="fc" id="L670">                myLock = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
            }

            /* If this is a hash node */
<span class="fc bfc" id="L674" title="All 2 branches covered.">            if (ELEMENT_CERTIFICATES.equals(myNodeName)) {</span>
                /* Check for valid xml */
<span class="pc bpc" id="L676" title="2 of 4 branches missed.">                if (mySecuredKey == null || myLock == null) {</span>
<span class="nc" id="L677">                    throw new GordianDataException(ERROR_BADXML);</span>
                }

                /* Loop through the certificates */
<span class="fc" id="L681">                Node myChild = myNode.getFirstChild();</span>
<span class="fc bfc" id="L682" title="All 2 branches covered.">                while (myChild != null) {</span>
                    /* Access the Node name */
<span class="fc" id="L684">                    final String myName = myChild.getNodeName();</span>

                    /* If this is a certificateKey node */
<span class="pc bpc" id="L687" title="1 of 2 branches missed.">                    if (ELEMENT_CERTKEY.equals(myName)) {</span>
                        /* Add the certificate to the list */
<span class="fc" id="L689">                        myChain.add(parseCertificateKey(myChild));</span>
                    }

                    /* Move to next node */
<span class="fc" id="L693">                    myChild = myChild.getNextSibling();</span>
<span class="fc" id="L694">                }</span>

                /* build the entry */
<span class="fc" id="L697">                final GordianKeyStorePairElement myEntry = new GordianKeyStorePairElement(mySecuredKey, myLock, myChain, pDate);</span>
<span class="fc" id="L698">                theKeyStore.getAliasMap().put(pAlias, myEntry);</span>
<span class="fc" id="L699">                return;</span>
            }

            /* Move to next node */
<span class="fc" id="L703">            myNode = myNode.getNextSibling();</span>
<span class="fc" id="L704">        }</span>
<span class="nc" id="L705">    }</span>

    /**
     * parse the certificate alias.
     *
     * @param pNode  the node to parse
     * @param pAlias the alias
     * @param pDate  the creation date
     * @throws GordianException on error
     */
    private void parseCertificateElement(final Node pNode,
                                         final String pAlias,
                                         final LocalDate pDate) throws GordianException {
        /* Loop through the nodes */
<span class="nc" id="L719">        Node myNode = pNode.getFirstChild();</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="nc" id="L722">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is a certificateKey node */
<span class="nc bnc" id="L725" title="All 2 branches missed.">            if (ELEMENT_CERTKEY.equals(myNodeName)) {</span>
                /* Obtain the key and build the entry */
<span class="nc" id="L727">                final GordianKeyStoreCertificateKey myKey = parseCertificateKey(myNode);</span>
<span class="nc" id="L728">                final GordianKeyStoreCertificateElement myEntry = new GordianKeyStoreCertificateElement(myKey, pDate);</span>
<span class="nc" id="L729">                theKeyStore.getAliasMap().put(pAlias, myEntry);</span>
<span class="nc" id="L730">                return;</span>
            }

            /* Move to next node */
<span class="nc" id="L734">            myNode = myNode.getNextSibling();</span>
<span class="nc" id="L735">        }</span>
<span class="nc" id="L736">    }</span>

    /**
     * parse the certificateKey.
     *
     * @param pNode the node to parse
     * @return the key
     * @throws GordianException on error
     */
    private static GordianKeyStoreCertificateKey parseCertificateKey(final Node pNode) throws GordianException {
        /* Loop through the nodes */
<span class="fc" id="L747">        GordianCertificateId mySubject = null;</span>
<span class="fc" id="L748">        Node myNode = pNode.getFirstChild();</span>
<span class="pc bpc" id="L749" title="1 of 2 branches missed.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="fc" id="L751">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is a subject node */
<span class="fc bfc" id="L754" title="All 2 branches covered.">            if (ELEMENT_SUBJECT.equals(myNodeName)) {</span>
                /* Parse the subject */
<span class="fc" id="L756">                mySubject = parseCertificateId(myNode);</span>
            }

            /* If this is a issuer node */
<span class="fc bfc" id="L760" title="All 2 branches covered.">            if (ELEMENT_ISSUER.equals(myNodeName)) {</span>
                /* Check for valid xml */
<span class="pc bpc" id="L762" title="1 of 2 branches missed.">                if (mySubject == null) {</span>
<span class="nc" id="L763">                    throw new GordianDataException(ERROR_BADXML);</span>
                }

                /* Parse the issuer and build the key */
<span class="fc" id="L767">                final GordianCertificateId myIssuer = parseCertificateId(myNode);</span>
<span class="fc" id="L768">                return new GordianKeyStoreCertificateKey(myIssuer, mySubject);</span>
            }

            /* Move to next node */
<span class="fc" id="L772">            myNode = myNode.getNextSibling();</span>
<span class="fc" id="L773">        }</span>

        /* Failed to parse the key */
<span class="nc" id="L776">        throw new GordianDataException(&quot;Failed to parse certificate Key&quot;);</span>
    }

    /**
     * parse the certificateKey.
     *
     * @param pNode the node to parse
     * @return the key
     * @throws GordianException on error
     */
    private static GordianCertificateId parseCertificateId(final Node pNode) throws GordianException {
        /* Loop through the nodes */
<span class="fc" id="L788">        X500Name myName = null;</span>
<span class="fc" id="L789">        Node myNode = pNode.getFirstChild();</span>
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="fc" id="L792">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is a name node */
<span class="fc bfc" id="L795" title="All 2 branches covered.">            if (ELEMENT_NAME.equals(myNodeName)) {</span>
                /* Parse the name */
<span class="fc" id="L797">                final byte[] myNameBytes = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
<span class="fc" id="L798">                myName = X500Name.getInstance(myNameBytes);</span>
            }

            /* If this is a id node */
<span class="fc bfc" id="L802" title="All 2 branches covered.">            if (ELEMENT_ID.equals(myNodeName)) {</span>
                /* Check for valid xml */
<span class="pc bpc" id="L804" title="1 of 2 branches missed.">                if (myName == null) {</span>
<span class="nc" id="L805">                    throw new GordianDataException(ERROR_BADXML);</span>
                }

                /* Parse the issuer and build the key */
<span class="fc" id="L809">                final byte[] myId = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
<span class="fc" id="L810">                return new GordianCoreCertificateId(myName, myId);</span>
            }

            /* Move to next node */
<span class="fc" id="L814">            myNode = myNode.getNextSibling();</span>
<span class="fc" id="L815">        }</span>

        /* Failed to parse the id */
<span class="nc" id="L818">        throw new GordianDataException(&quot;Failed to parse certificate Id&quot;);</span>
    }

    /**
     * parse the certificates.
     *
     * @param pCerts the certificates element
     * @throws GordianException on error
     */
    private void parseCertificates(final Node pCerts) throws GordianException {
        /* Loop through the nodes */
<span class="fc" id="L829">        Node myNode = pCerts.getFirstChild();</span>
<span class="fc bfc" id="L830" title="All 2 branches covered.">        while (myNode != null) {</span>
            /* Access the Node name */
<span class="fc" id="L832">            final String myNodeName = myNode.getNodeName();</span>

            /* If this is a pairCertificate node */
<span class="pc bpc" id="L835" title="1 of 2 branches missed.">            if (ELEMENT_PAIRCERT.equals(myNodeName)) {</span>
                /* Access the encoded certificate */
<span class="fc" id="L837">                final byte[] myEncoded = GordianDataConverter.base64ToByteArray(myNode.getTextContent());</span>
<span class="fc" id="L838">                final GordianCoreCertificate myCert = new GordianCoreCertificate(theKeyStore.getFactory(), myEncoded);</span>
<span class="fc" id="L839">                theKeyStore.storeCertificate(myCert);</span>
            }

            /* Move to next node */
<span class="fc" id="L843">            myNode = myNode.getNextSibling();</span>
<span class="fc" id="L844">        }</span>
<span class="fc" id="L845">    }</span>

    /**
     * The Entry types.
     */
<span class="fc" id="L850">    private enum GordianStoreEntryType {</span>
        /**
         * Certificate.
         */
<span class="fc" id="L854">        TRUSTEDPAIRCERT(&quot;TrustedCertificate&quot;),</span>

        /**
         * PrivateKey.
         */
<span class="fc" id="L859">        PRIVATEKEYPAIR(&quot;PrivateKeyPair&quot;),</span>

        /**
         * Key.
         */
<span class="fc" id="L864">        KEY(&quot;Key&quot;),</span>

        /**
         * KeySet.
         */
<span class="fc" id="L869">        KEYSET(&quot;KeySet&quot;),</span>

        /**
         * KeySetLock.
         */
<span class="fc" id="L874">        KEYSETLOCK(&quot;KeySetLock&quot;);</span>

        /**
         * The Element Name.
         */
        private final String theElement;

        /**
         * Constructor.
         *
         * @param pElement the element name
         */
<span class="fc" id="L886">        GordianStoreEntryType(final String pElement) {</span>
<span class="fc" id="L887">            theElement = pElement;</span>
<span class="fc" id="L888">        }</span>

        /**
         * Obtain the element name.
         *
         * @return the element name
         */
        public String getElementName() {
<span class="fc" id="L896">            return theElement;</span>
        }

        /**
         * Determine entry type.
         *
         * @param pEntry the entry
         * @return the entry type
         */
        public static GordianStoreEntryType determineEntryType(final GordianKeyStoreEntry pEntry) {
<span class="fc bfc" id="L906" title="All 2 branches covered.">            if (pEntry instanceof GordianKeyStoreSetElement) {</span>
<span class="fc" id="L907">                return KEYSET;</span>
            }
<span class="pc bpc" id="L909" title="1 of 2 branches missed.">            if (pEntry instanceof GordianKeyStoreLockElement) {</span>
<span class="nc" id="L910">                return KEYSETLOCK;</span>
            }
<span class="fc bfc" id="L912" title="All 2 branches covered.">            if (pEntry instanceof GordianKeyStoreKeyElement) {</span>
<span class="fc" id="L913">                return KEY;</span>
            }
<span class="pc bpc" id="L915" title="1 of 2 branches missed.">            if (pEntry instanceof GordianKeyStorePairElement) {</span>
<span class="fc" id="L916">                return PRIVATEKEYPAIR;</span>
            }
<span class="nc bnc" id="L918" title="All 2 branches missed.">            if (pEntry instanceof GordianKeyStoreCertificateElement) {</span>
<span class="nc" id="L919">                return TRUSTEDPAIRCERT;</span>
            }
<span class="nc" id="L921">            throw new IllegalArgumentException();</span>
        }

        /**
         * Determine entry type.
         *
         * @param pElement the element
         * @return the entry type
         */
        public static GordianStoreEntryType determineEntryType(final String pElement) {
<span class="pc bpc" id="L931" title="1 of 2 branches missed.">            for (GordianStoreEntryType myType : values()) {</span>
<span class="fc bfc" id="L932" title="All 2 branches covered.">                if (pElement.equals(myType.getElementName())) {</span>
<span class="fc" id="L933">                    return myType;</span>
                }
            }
<span class="nc" id="L936">            throw new IllegalArgumentException();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>