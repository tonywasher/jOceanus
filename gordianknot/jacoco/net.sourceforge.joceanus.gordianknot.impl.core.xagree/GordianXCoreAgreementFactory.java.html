<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianXCoreAgreementFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.core.xagree</a> &gt; <span class="el_source">GordianXCoreAgreementFactory.java</span></div><h1>GordianXCoreAgreementFactory.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.core.xagree;

import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementSpec;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementSpecBuilder;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementType;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianKDFType;
import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.cert.GordianCertificate;
import net.sourceforge.joceanus.gordianknot.api.cert.GordianKeyPairUse;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianEdwardsElliptic;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPair;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairSpec;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairType;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignatureFactory;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignatureSpec;
import net.sourceforge.joceanus.gordianknot.api.xagree.GordianXAgreement;
import net.sourceforge.joceanus.gordianknot.api.xagree.GordianXAgreementParams;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseData;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianDataException;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianLogicException;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.function.Predicate;

/**
 * Core agreement factory.
 */
public abstract class GordianXCoreAgreementFactory
        implements GordianXCoreAgreementSupplier {
    /**
     * The factory.
     */
    private final GordianBaseFactory theFactory;

    /**
     * The id cache.
     */
    private final GordianXCoreAgreementCache theCache;

    /**
     * The algorithm Ids.
     */
    private GordianXCoreAgreementAlgId theAlgIds;

    /**
     * The signer certificate.
     */
    private GordianCertificate theSignerCertificate;

    /**
     * The signatureSpec.
     */
    private GordianSignatureSpec theSignSpec;

    /**
     * Constructor.
     *
     * @param pFactory the factory
     */
<span class="fc" id="L80">    protected GordianXCoreAgreementFactory(final GordianBaseFactory pFactory) {</span>
<span class="fc" id="L81">        theFactory = pFactory;</span>
<span class="fc" id="L82">        theCache = new GordianXCoreAgreementCache(theFactory.getRandomSource());</span>
<span class="fc" id="L83">    }</span>

    @Override
    public GordianBaseFactory getFactory() {
<span class="nc" id="L87">        return theFactory;</span>
    }

    @Override
    public GordianXAgreementParams newAgreementParams(final GordianAgreementSpec pSpec,
                                                      final Object pResultType) throws GordianException {
<span class="nc" id="L93">        return new GordianXCoreAgreementParams(this, pSpec, pResultType);</span>
    }

    @Override
    public GordianXAgreement createAgreement(final GordianXAgreementParams pParams) throws GordianException {
        /* Check validity of Agreement */
<span class="nc" id="L99">        final GordianAgreementSpec mySpec = pParams.getAgreementSpec();</span>
<span class="nc" id="L100">        checkAgreementSpec(mySpec);</span>

        /* Create the agreement */
<span class="nc" id="L103">        final GordianXCoreAgreementEngine myEngine = createEngine(mySpec);</span>
<span class="nc" id="L104">        final GordianXCoreAgreement myAgreement = new GordianXCoreAgreement(myEngine);</span>

        /* Set the details */
<span class="nc" id="L107">        myAgreement.setClientCertificate(pParams.getClientCertificate());</span>
<span class="nc" id="L108">        myAgreement.setServerCertificate(pParams.getServerCertificate());</span>
<span class="nc" id="L109">        myAgreement.setResultType(pParams.getResultType());</span>

        /* Store the parameters */

        /* Build the clientHello */
<span class="nc" id="L114">        myAgreement.buildClientHello();</span>

        /* Return the agreement */
<span class="nc" id="L117">        return myAgreement;</span>
    }

    @Override
    public GordianXAgreement parseAgreementMessage(final byte[] pMessage) throws GordianException {
        /* Parse the message */
<span class="nc" id="L123">        final GordianXCoreAgreementMessageASN1 myASN1 = GordianXCoreAgreementMessageASN1.getInstance(pMessage);</span>

        /* Switch on the messageType */
<span class="nc bnc" id="L126" title="All 4 branches missed.">        switch (myASN1.getMessageType()) {</span>
            case CLIENTHELLO:
<span class="nc" id="L128">                return parseClientHello(myASN1);</span>
            case SERVERHELLO:
<span class="nc" id="L130">                return parseServerHello(myASN1);</span>
            case CLIENTCONFIRM:
<span class="nc" id="L132">                return parseClientConfirm(myASN1);</span>
            default:
<span class="nc" id="L134">                throw new GordianDataException(&quot;Unexpected MessageType: &quot; +  myASN1.getMessageType());</span>
        }
    }

    /**
     * Parse a clientHello message.
     * @param pClientHello the message
     * @return the agreement
     * @throws GordianException error
     */
    private GordianXAgreement parseClientHello(final GordianXCoreAgreementMessageASN1 pClientHello) throws GordianException {
        /* Create a new agreement */
<span class="nc" id="L146">        final GordianAgreementSpec mySpec = getSpecForIdentifier(pClientHello.getAgreementId());</span>
<span class="nc" id="L147">        final GordianXCoreAgreementEngine myEngine = createEngine(mySpec);</span>
<span class="nc" id="L148">        final GordianXCoreAgreement myAgreement = new GordianXCoreAgreement(myEngine);</span>

        /* If this is a signed agreement */
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (GordianAgreementType.SIGNED.equals(mySpec.getAgreementType())) {</span>
            /* Handle no signer certificate */
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (theSignerCertificate == null) {</span>
<span class="nc" id="L154">                throw new GordianLogicException(&quot;No signer declared for Signed agreement&quot;);</span>
            }

            /* Declare the signer */
<span class="nc" id="L158">            myAgreement.setSignerCertificate(theSignSpec, theSignerCertificate);</span>
        }

        /* Parse the clientHello */
<span class="nc" id="L162">        myAgreement.parseClientHello(pClientHello);</span>

        /* Return the agreement */
<span class="nc" id="L165">        return myAgreement;</span>
    }

    /**
     * Parse a serverHello message.
     * @param pServerHello the message
     * @return the agreement
     * @throws GordianException error
     */
    private GordianXAgreement parseServerHello(final GordianXCoreAgreementMessageASN1 pServerHello) throws GordianException {
        /* Look up the agreement in the cache */
<span class="nc" id="L176">        final GordianAgreementSpec mySpec = getSpecForIdentifier(pServerHello.getAgreementId());</span>
<span class="nc" id="L177">        final GordianXCoreAgreement myAgreement = theCache.lookUpAgreement(pServerHello.getClientId(), mySpec);</span>

        /* Process the serverHello */
<span class="nc" id="L180">        myAgreement.processServerHello(pServerHello);</span>

        /* Return the agreement */
<span class="nc" id="L183">        return myAgreement;</span>
    }

    /**
     * Parse a clientConfirm message.
     * @param pClientConfirm the message
     * @return the agreement
     * @throws GordianException error
     */
    private GordianXAgreement parseClientConfirm(final GordianXCoreAgreementMessageASN1 pClientConfirm) throws GordianException {
        /* Look up the agreement in the cache */
<span class="nc" id="L194">        final GordianAgreementSpec mySpec = getSpecForIdentifier(pClientConfirm.getAgreementId());</span>
<span class="nc" id="L195">        final GordianXCoreAgreement myAgreement = theCache.lookUpAgreement(pClientConfirm.getServerId(), mySpec);</span>

        /* Process the clientConfirm */
<span class="nc" id="L198">        myAgreement.processClientConfirm(pClientConfirm);</span>

        /* Return the agreement */
<span class="nc" id="L201">        return myAgreement;</span>
    }

    /**
     * Create engine.
     * @param pSpec the agreement Spec
     * @return the engine
     * @throws GordianException on error
     */
    protected GordianXCoreAgreementEngine createEngine(final GordianAgreementSpec pSpec) throws GordianException {
        /* If this is a composite agreement */
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (pSpec.getKeyPairSpec().getKeyPairType() == GordianKeyPairType.COMPOSITE) {</span>
            /* Create an engine for each sub-agreement */
<span class="nc" id="L214">            final List&lt;GordianAgreementSpec&gt; mySpecs = GordianXCoreAgreementComposite.getSubAgreements(pSpec);</span>
<span class="nc" id="L215">            final List&lt;GordianXCoreAgreementEngine&gt; myEngines = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">            for (GordianAgreementSpec mySpec : mySpecs) {</span>
<span class="nc" id="L217">                myEngines.add(createEngine(mySpec));</span>
<span class="nc" id="L218">            }</span>
<span class="nc" id="L219">            return new GordianXCoreAgreementComposite(this, pSpec, myEngines);</span>
        }

        /* Unsupported spec */
<span class="nc" id="L223">        throw new GordianDataException(GordianBaseData.getInvalidText(pSpec));</span>
    }

    @Override
    public Predicate&lt;GordianAgreementSpec&gt; supportedAgreements() {
<span class="nc" id="L228">        return this::validAgreementSpec;</span>
    }

    @Override
    public void checkAgreementSpec(final GordianAgreementSpec pAgreementSpec) throws GordianException {
        /* Check validity of agreement */
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (!validAgreementSpec(pAgreementSpec)) {</span>
<span class="nc" id="L235">            throw new GordianDataException(GordianBaseData.getInvalidText(pAgreementSpec));</span>
        }
<span class="nc" id="L237">    }</span>

    @Override
    public Long getNextId() {
<span class="nc" id="L241">        return theCache.getNextId();</span>
    }

    @Override
    public void storeAgreement(final Long pId,
                               final GordianXAgreement pAgreement) {
<span class="nc" id="L247">        theCache.storeAgreement(pId, pAgreement);</span>
<span class="nc" id="L248">    }</span>

    @Override
    public void removeAgreement(final Long pId) {
<span class="nc" id="L252">        theCache.removeAgreement(pId);</span>
<span class="nc" id="L253">    }</span>

    @Override
    public void setSigner(final GordianCertificate pSigner) throws GordianException {
<span class="nc" id="L257">        final GordianSignatureFactory mySignFactory = theFactory.getAsyncFactory().getSignatureFactory();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        final GordianSignatureSpec mySignSpec = pSigner == null ? null : mySignFactory.defaultForKeyPair(pSigner.getKeyPair().getKeyPairSpec());</span>
<span class="nc" id="L259">        setSigner(pSigner, mySignSpec);</span>
<span class="nc" id="L260">    }</span>

    @Override
    public void setSigner(final GordianCertificate pSigner,
                          final GordianSignatureSpec pSignSpec) throws GordianException {
        /* Check that certificate can sign data */
<span class="nc bnc" id="L266" title="All 4 branches missed.">        if (pSigner == null || !pSigner.getUsage().hasUse(GordianKeyPairUse.SIGNATURE)) {</span>
<span class="nc" id="L267">            throw new GordianDataException(&quot;Certificate must be capable of signing data&quot;);</span>
        }

        /* Check that certificate can sign data */
<span class="nc" id="L271">        final GordianSignatureFactory mySignFactory = theFactory.getAsyncFactory().getSignatureFactory();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!mySignFactory.validSignatureSpecForKeyPair(pSigner.getKeyPair(), pSignSpec)) {</span>
<span class="nc" id="L273">            throw new GordianDataException(GordianBaseData.getInvalidText(pSignSpec));</span>
        }

        /* Store parameters */
<span class="nc" id="L277">        theSignerCertificate = pSigner;</span>
<span class="nc" id="L278">        theSignSpec = pSignSpec;</span>
<span class="nc" id="L279">    }</span>

    /**
     * Check AgreementSpec.
     *
     * @param pSpec the agreementSpec
     * @return true/false
     */
    protected boolean validAgreementSpec(final GordianAgreementSpec pSpec) {
        /* Reject invalid agreementSpec */
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if (pSpec == null || !pSpec.isValid()) {</span>
<span class="nc" id="L290">            return false;</span>
        }

        /* Check that spec is supported */
<span class="nc" id="L294">        return pSpec.isSupported();</span>
    }

    @Override
    public boolean validAgreementSpecForKeyPairSpec(final GordianKeyPairSpec pKeyPairSpec,
                                                    final GordianAgreementSpec pAgreementSpec) {
        /* Check that the agreementSpec is supported */
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (!validAgreementSpec(pAgreementSpec)) {</span>
<span class="nc" id="L302">            return false;</span>
        }

        /* Check agreement matches keySpec */
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (!pAgreementSpec.getKeyPairSpec().equals(pKeyPairSpec)) {</span>
<span class="nc" id="L307">            return false;</span>
        }

        /* For Edwards XDH, disallow 512KDF for 25519 and 256KDF for 448 */
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (pKeyPairSpec.getKeyPairType() == GordianKeyPairType.XDH) {</span>
<span class="nc" id="L312">            final GordianEdwardsElliptic myEdwards = pKeyPairSpec.getEdwardsElliptic();</span>
<span class="nc bnc" id="L313" title="All 3 branches missed.">            switch (pAgreementSpec.getKDFType()) {</span>
                case SHA256KDF:
                case SHA256CKDF:
<span class="nc" id="L316">                    return myEdwards.is25519();</span>
                case SHA512KDF:
                case SHA512CKDF:
<span class="nc bnc" id="L319" title="All 2 branches missed.">                    return !myEdwards.is25519();</span>
                default:
                    break;
            }
        }

        /* For Composite AgreementSpec */
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (pKeyPairSpec.getKeyPairType() == GordianKeyPairType.COMPOSITE) {</span>
            /* Access the subSpecs  */
<span class="nc" id="L328">            final List&lt;GordianAgreementSpec&gt; mySubAgrees = GordianXCoreAgreementComposite.getSubAgreements(pAgreementSpec);</span>

            /* Loop through the subAgreements */
<span class="nc bnc" id="L331" title="All 2 branches missed.">            for (GordianAgreementSpec mySpec : mySubAgrees) {</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                if (!validAgreementSpecForKeyPairSpec(mySpec.getKeyPairSpec(), mySpec)) {</span>
<span class="nc" id="L333">                    return false;</span>
                }
<span class="nc" id="L335">            }</span>

            /* Check confirmation */
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (Boolean.TRUE.equals(pAgreementSpec.withConfirm())</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                    &amp;&amp; !pAgreementSpec.getAgreementType().canConfirm()) {</span>
<span class="nc" id="L340">                return false;</span>
            }

            /* Disallow SM2 with confirm */
<span class="nc bnc" id="L344" title="All 2 branches missed.">            return pAgreementSpec.getAgreementType() != GordianAgreementType.SM2</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                    || !pAgreementSpec.withConfirm();</span>
        }

        /* OK */
<span class="nc" id="L349">        return true;</span>
    }

    @Override
    public AlgorithmIdentifier getIdentifierForSpec(final GordianAgreementSpec pSpec) {
<span class="nc" id="L354">        return getAlgorithmIds().determineIdentifier(pSpec);</span>
    }

    @Override
    public GordianAgreementSpec getSpecForIdentifier(final AlgorithmIdentifier pIdentifier) {
<span class="nc" id="L359">        return getAlgorithmIds().determineAgreementSpec(pIdentifier);</span>
    }

    @Override
    public AlgorithmIdentifier getIdentifierForResultType(final Object pResult) throws GordianException {
<span class="nc" id="L364">        return getAlgorithmIds().getIdentifierForResult(pResult);</span>
    }

    @Override
    public Object getResultTypeForIdentifier(final AlgorithmIdentifier pIdentifier) throws GordianException {
<span class="nc" id="L369">        return getAlgorithmIds().processResultIdentifier(pIdentifier);</span>
    }

    /**
     * Obtain the agreement algorithm Ids.
     * @return the agreement Algorithm Ids
     */
    private GordianXCoreAgreementAlgId getAlgorithmIds() {
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (theAlgIds == null) {</span>
<span class="nc" id="L378">            theAlgIds = new GordianXCoreAgreementAlgId(theFactory);</span>
        }
<span class="nc" id="L380">        return theAlgIds;</span>
    }

    @Override
    public List&lt;GordianAgreementSpec&gt; listAllSupportedAgreements(final GordianKeyPair pKeyPair) {
<span class="nc" id="L385">        return listAllSupportedAgreements(pKeyPair.getKeyPairSpec());</span>
    }

    @Override
    public List&lt;GordianAgreementSpec&gt; listAllSupportedAgreements(final GordianKeyPairSpec pKeyPairSpec) {
<span class="nc" id="L390">        return listPossibleAgreements(pKeyPairSpec)</span>
<span class="nc" id="L391">                .stream()</span>
<span class="nc" id="L392">                .filter(supportedAgreements())</span>
<span class="nc" id="L393">                .filter(s -&gt; validAgreementSpecForKeyPairSpec(pKeyPairSpec, s))</span>
<span class="nc" id="L394">                .toList();</span>
    }

    /**
     * Obtain a list of all possible agreements for the keyPairSpec.
     * @param pKeyPairSpec the keyPairSpec
     * @return the list
     */
    private List&lt;GordianAgreementSpec&gt; listPossibleAgreements(final GordianKeyPairSpec pKeyPairSpec) {
        /* Create list */
<span class="nc" id="L404">        final List&lt;GordianAgreementSpec&gt; myAgreements = new ArrayList&lt;&gt;();</span>

        /* Switch on keyPairType */
<span class="nc bnc" id="L407" title="All 8 branches missed.">        switch (pKeyPairSpec.getKeyPairType()) {</span>
            case RSA:
<span class="nc" id="L409">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.KEM));</span>
<span class="nc" id="L410">                break;</span>
            case NEWHOPE:
<span class="nc" id="L412">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.ANON));</span>
<span class="nc" id="L413">                break;</span>
            case CMCE:
            case FRODO:
            case SABER:
            case MLKEM:
            case HQC:
            case BIKE:
            case NTRU:
            case NTRUPRIME:
<span class="nc" id="L422">                myAgreements.add(GordianAgreementSpecBuilder.kem(pKeyPairSpec, GordianKDFType.NONE));</span>
<span class="nc" id="L423">                break;</span>
            case EC:
            case SM2:
            case GOST2012:
<span class="nc" id="L427">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.ANON));</span>
<span class="nc" id="L428">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.KEM));</span>
<span class="nc" id="L429">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.BASIC));</span>
<span class="nc" id="L430">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SIGNED));</span>
<span class="nc" id="L431">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED));</span>
<span class="nc" id="L432">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED, Boolean.TRUE));</span>
<span class="nc" id="L433">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.MQV));</span>
<span class="nc" id="L434">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.MQV, Boolean.TRUE));</span>
<span class="nc" id="L435">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SM2));</span>
<span class="nc" id="L436">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SM2, Boolean.TRUE));</span>
<span class="nc" id="L437">                break;</span>
            case DH:
            case DSTU4145:
<span class="nc" id="L440">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.ANON));</span>
<span class="nc" id="L441">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.KEM));</span>
<span class="nc" id="L442">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.BASIC));</span>
<span class="nc" id="L443">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SIGNED));</span>
<span class="nc" id="L444">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED));</span>
<span class="nc" id="L445">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED, Boolean.TRUE));</span>
<span class="nc" id="L446">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.MQV));</span>
<span class="nc" id="L447">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.MQV, Boolean.TRUE));</span>
<span class="nc" id="L448">                break;</span>
            case XDH:
<span class="nc" id="L450">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.ANON));</span>
<span class="nc" id="L451">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.BASIC));</span>
<span class="nc" id="L452">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SIGNED));</span>
<span class="nc" id="L453">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED));</span>
<span class="nc" id="L454">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED, Boolean.TRUE));</span>
<span class="nc" id="L455">                break;</span>
            case COMPOSITE:
                /* Loop through the possible keySpecs for the first key */
<span class="nc" id="L458">                final Iterator&lt;GordianKeyPairSpec&gt; myIterator = pKeyPairSpec.keySpecIterator();</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">                for (GordianAgreementSpec mySpec : listPossibleAgreements(myIterator.next())) {</span>
<span class="nc" id="L460">                    final GordianAgreementSpec myTest = new GordianAgreementSpec(pKeyPairSpec, mySpec.getAgreementType(), mySpec.getKDFType(), mySpec.withConfirm());</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                    if (myTest.isValid()) {</span>
<span class="nc" id="L462">                        myAgreements.add(myTest);</span>
                    }
<span class="nc" id="L464">                }</span>
<span class="nc" id="L465">                break;</span>
            default:
                break;
        }

        /* Return the list */
<span class="nc" id="L471">        return myAgreements;</span>
    }

    /**
     * Create list of KDF variants.
     * @param pKeyPairSpec the keyPairSpec
     * @param pAgreementType the agreementType
     * @return the list
     */
    private static List&lt;GordianAgreementSpec&gt; listAllKDFs(final GordianKeyPairSpec pKeyPairSpec,
                                                          final GordianAgreementType pAgreementType) {
<span class="nc" id="L482">        return listAllKDFs(pKeyPairSpec, pAgreementType, Boolean.FALSE);</span>
    }

    @Override
    public GordianAgreementSpec defaultForKeyPair(final GordianKeyPairSpec pKeySpec) {
<span class="nc" id="L487">        final Iterator&lt;GordianAgreementSpec&gt; myIterator = listAllSupportedAgreements(pKeySpec).iterator();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">        return myIterator.hasNext() ? myIterator.next() : null;</span>
    }

    /**
     * Create list of KDF variants.
     * @param pKeyPairSpec the keyPairSpec
     * @param pAgreementType the agreementType
     * @param pConfirm with key confirmation
     * @return the list
     */
    public static List&lt;GordianAgreementSpec&gt; listAllKDFs(final GordianKeyPairSpec pKeyPairSpec,
                                                         final GordianAgreementType pAgreementType,
                                                         final Boolean pConfirm) {
        /* Create list */
<span class="nc" id="L502">        final List&lt;GordianAgreementSpec&gt; myAgreements = new ArrayList&lt;&gt;();</span>

        /* Loop through the KDFs */
<span class="nc bnc" id="L505" title="All 2 branches missed.">        for (final GordianKDFType myKDF : GordianKDFType.values()) {</span>
<span class="nc" id="L506">            myAgreements.add(new GordianAgreementSpec(pKeyPairSpec, pAgreementType, myKDF, pConfirm));</span>
        }

        /* Return the list */
<span class="nc" id="L510">        return myAgreements;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>