<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianXCoreAgreement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.core.xagree</a> &gt; <span class="el_source">GordianXCoreAgreement.java</span></div><h1>GordianXCoreAgreement.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.core.xagree;

import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementSpec;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementType;
import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.cert.GordianCertificate;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairType;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignatureSpec;
import net.sourceforge.joceanus.gordianknot.api.xagree.GordianXAgreement;
import net.sourceforge.joceanus.gordianknot.api.xagree.GordianXAgreementParams;
import net.sourceforge.joceanus.gordianknot.api.xagree.GordianXAgreementStatus;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianDataException;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianLogicException;

import java.util.Objects;

/**
 * Key Agreement.
 */
public class GordianXCoreAgreement
        implements GordianXAgreement {
    /**
     * The Engine.
     */
    private final GordianXCoreAgreementEngine theEngine;

    /**
     * The supplier.
     */
    private final GordianXCoreAgreementSupplier theSupplier;

    /**
     * The Builder.
     */
    private final GordianXCoreAgreementBuilder theBuilder;

    /**
     * The State.
     */
    private final GordianXCoreAgreementState theState;

    /**
     * The Agreement Spec.
     */
    private final GordianAgreementSpec theSpec;

    /**
     * The Parameters.
     */
    private GordianXCoreAgreementParams theParams;

    /**
     * The Next Message.
     */
    private byte[] theNextMsg;

    /**
     * Constructor.
     * @param pEngine the engine
     * @throws GordianException on error
     */
<span class="nc" id="L78">    public GordianXCoreAgreement(final GordianXCoreAgreementEngine pEngine) throws GordianException {</span>
        /* Store details */
<span class="nc" id="L80">        theEngine = pEngine;</span>
<span class="nc" id="L81">        theSupplier = theEngine.getSupplier();</span>
<span class="nc" id="L82">        theBuilder = theEngine.getBuilder();</span>
<span class="nc" id="L83">        theState = theBuilder.getState();</span>
<span class="nc" id="L84">        theSpec = theState.getSpec();</span>
<span class="nc" id="L85">    }</span>

    @Override
    public GordianXAgreementParams getAgreementParams() {
<span class="nc" id="L89">        return new GordianXCoreAgreementParams(theParams);</span>
    }

    /**
     * Obtain the spec.
     * @return the spec
     */
    GordianAgreementSpec getAgreementSpec() {
<span class="nc" id="L97">        return theSpec;</span>
    }

    /**
     * Set the status.
     * @param pStatus the status
     */
    void setStatus(final GordianXAgreementStatus pStatus) {
<span class="nc" id="L105">        theState.setStatus(pStatus);</span>
<span class="nc" id="L106">    }</span>

    @Override
    public GordianXAgreementStatus getStatus() {
<span class="nc" id="L110">        return theState.getStatus();</span>
    }

    /**
     * Set the resultType.
     * @param pResultType the resultType
     * @throws GordianException on error
     */
    void setResultType(final Object pResultType) throws GordianException {
<span class="nc" id="L119">        theBuilder.setResultType(pResultType);</span>
<span class="nc" id="L120">    }</span>

    @Override
    public Object getResult() throws GordianException {
<span class="nc" id="L124">        checkStatus(GordianXAgreementStatus.RESULT_AVAILABLE);</span>
<span class="nc" id="L125">        return theState.getResult();</span>
    }

    /**
     * Check status.
     * @param pStatus the required status
     * @throws GordianException on error
     */
    protected void checkStatus(final GordianXAgreementStatus pStatus) throws GordianException {
        /* If we are in the wrong state */
<span class="nc" id="L135">        final GordianXAgreementStatus myStatus = theState.getStatus();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (myStatus != pStatus) {</span>
<span class="nc" id="L137">            throw new GordianLogicException(&quot;Invalid State: &quot; + myStatus);</span>
        }
<span class="nc" id="L139">    }</span>

    /**
     * Set the client certificate.
     * @param pClient the client certificate
     * @throws GordianException on error
     */
    void setClientCertificate(final GordianCertificate pClient) throws GordianException {
        /* Handle null client certificate */
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (pClient == null) {</span>
<span class="nc" id="L149">            final GordianAgreementType myType = theSpec.getAgreementType();</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">            if (!myType.isAnonymous() &amp;&amp; !myType.isSigned()) {</span>
<span class="nc" id="L151">                throw new GordianDataException(&quot;Client Certificate must be provided&quot;);</span>
            }
<span class="nc" id="L153">            return;</span>
        }

        /* Store the certificate */
<span class="nc" id="L157">        theBuilder.setClientCertificate(pClient);</span>
<span class="nc" id="L158">    }</span>

    /**
     * Set the server certificate.
     * @param pServer the server certificate
     * @throws GordianException on error
     */
    void setServerCertificate(final GordianCertificate pServer) throws GordianException {
        /* Check that we have a certificate */
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (pServer == null) {</span>
<span class="nc" id="L168">            final GordianAgreementType myType = theSpec.getAgreementType();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (!myType.isSigned()) {</span>
<span class="nc" id="L170">                throw new GordianDataException(&quot;Server Certificate must be provided&quot;);</span>
            }
        }

        /* Store the certificate */
<span class="nc" id="L175">        theBuilder.setServerCertificate(pServer);</span>
<span class="nc" id="L176">    }</span>

    /**
     * Set the signer details.
     * @param pSignSpec the signature spec
     * @param pSigner the signer certificate
     * @throws GordianException on error
     */
    void setSignerCertificate(final GordianSignatureSpec pSignSpec,
                              final GordianCertificate pSigner) throws GordianException {
<span class="nc" id="L186">        theBuilder.setSignSpec(pSignSpec)</span>
<span class="nc" id="L187">                .setSignerCertificate(pSigner);</span>
<span class="nc" id="L188">    }</span>

    /**
     * Set parameters.
     * @param pParams the parameters
     * @throws GordianException on error
     */
    void setParameters(final GordianXCoreAgreementParams pParams) throws GordianException {
        /* Set the details */
<span class="nc" id="L197">        setClientCertificate(pParams.getClientCertificate());</span>
<span class="nc" id="L198">        setServerCertificate(pParams.getServerCertificate());</span>
<span class="nc" id="L199">        setResultType(pParams.getResultType());</span>

        /* Store additional data */
<span class="nc" id="L202">        theState.setAdditionalData(pParams.getAdditionalData());</span>

        /* Update the parameters */
<span class="nc" id="L205">        theParams = new GordianXCoreAgreementParams(pParams);</span>
<span class="nc" id="L206">    }</span>

    @Override
    public GordianXAgreement updateParams(final GordianXAgreementParams pParams) throws GordianException {
        /* Must be looking for serverPrivate */
<span class="nc" id="L211">        checkStatus(GordianXAgreementStatus.AWAITING_SERVERPRIVATE);</span>

        /* Ensure that we are updating from correct parameters */
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (Objects.equals(theParams.getId(), ((GordianXCoreAgreementParams) pParams).getId())) {</span>
<span class="nc" id="L215">            throw new GordianDataException(&quot;Invalid parameters provided&quot;);</span>
        }

        /* Ensure that the server has a private key */
<span class="nc" id="L219">        final GordianAgreementSpec mySpec = theState.getSpec();</span>
<span class="nc" id="L220">        final GordianCertificate myServerCert = pParams.getSignerCertificate();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (myServerCert.getKeyPair().isPublicOnly()) {</span>
<span class="nc" id="L222">            throw new GordianDataException(&quot;Server Certificate is Public Only&quot;);</span>
        }

        /* Update the server certificate */
<span class="nc" id="L226">        setServerCertificate(myServerCert);</span>

        /* Store additional data */
<span class="nc" id="L229">        theState.setAdditionalData(pParams.getAdditionalData());</span>

        /* If this is a signed agreement */
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (GordianAgreementType.SIGNED.equals(mySpec.getAgreementType())) {</span>
             /* Handle no signer certificate */
<span class="nc" id="L234">            final GordianCertificate mySignerCert = pParams.getSignerCertificate();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (mySignerCert == null) {</span>
<span class="nc" id="L236">                throw new GordianLogicException(&quot;No signer declared for Signed agreement&quot;);</span>
            }

            /* Declare the signer */
<span class="nc" id="L240">            setSignerCertificate(pParams.getSignatureSpec(), mySignerCert);</span>
        }

        /* Update the parameters */
<span class="nc" id="L244">        theParams = new GordianXCoreAgreementParams((GordianXCoreAgreementParams) pParams);</span>

        /* Process the augmented clientHello and return the agreement */
<span class="nc" id="L247">        processClientHello();</span>
<span class="nc" id="L248">        return this;</span>
    }

    @Override
    public void setError(final String pError) throws GordianException {
        /* Only allowed while awaiting ServerPrivate */
<span class="nc" id="L254">        checkStatus(GordianXAgreementStatus.AWAITING_SERVERPRIVATE);</span>
<span class="nc" id="L255">        theBuilder.setError(pError);</span>

        /* If we are not anonymous */
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (!theSpec.getAgreementType().isAnonymous()) {</span>
            /* Create the rejection serverHello */
<span class="nc" id="L260">            setNextMessage(theBuilder.newServerHello());</span>
        }
<span class="nc" id="L262">    }</span>

    /**
     * Set the next message (or null).
     * @param pMessage the next message
     * @throws GordianException on error
     */
    void setNextMessage(final GordianXCoreAgreementMessageASN1 pMessage) throws GordianException {
<span class="nc bnc" id="L270" title="All 2 branches missed.">        theNextMsg = pMessage == null ? null : pMessage.getEncodedBytes();</span>
<span class="nc" id="L271">    }</span>

    @Override
    public byte[] nextMessage() {
<span class="nc" id="L275">        return theNextMsg;</span>
    }

    /**
     * Build the clientHello.
     * @throws GordianException on error
     */
    void buildClientHello() throws GordianException {
        /* Create ClientId and InitVector */
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (!theSpec.getAgreementType().isAnonymous()) {</span>
<span class="nc" id="L285">            theBuilder.newClientId();</span>
        }
<span class="nc" id="L287">        theBuilder.newClientIV();</span>

        /* Create clientEphemeral if needed */
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (needClientEphemeral()) {</span>
<span class="nc" id="L291">            theBuilder.newClientEphemeral();</span>
        }

        /* Create the new ClientHello */
<span class="nc" id="L295">        theEngine.buildClientHello();</span>
<span class="nc" id="L296">        final GordianXCoreAgreementMessageASN1 myMsg = theBuilder.newClientHello();</span>

        /* Set next message and status */
<span class="nc" id="L299">        setNextMessage(myMsg);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        theBuilder.setStatus(theSpec.getAgreementType().isAnonymous()</span>
<span class="nc" id="L301">                ? GordianXAgreementStatus.RESULT_AVAILABLE</span>
<span class="nc" id="L302">                : GordianXAgreementStatus.AWAITING_SERVERHELLO);</span>

        /* Store into cache if required */
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (!theSpec.getAgreementType().isAnonymous()) {</span>
<span class="nc" id="L306">            theSupplier.storeAgreement(myMsg.getClientId(), this);</span>
        }
<span class="nc" id="L308">    }</span>

    /**
     * Process the clientHello.
     * @param pClientHello the clientHello
     * @throws GordianException on error
     */
    void parseClientHello(final GordianXCoreAgreementMessageASN1 pClientHello) throws GordianException {
        /* Parse the clientHello */
<span class="nc" id="L317">        theBuilder.parseClientHello(pClientHello);</span>
<span class="nc" id="L318">        theParams = new GordianXCoreAgreementParams(theBuilder);</span>
<span class="nc" id="L319">        theBuilder.setStatus(GordianXAgreementStatus.AWAITING_SERVERPRIVATE);</span>
<span class="nc" id="L320">    }</span>

    /**
     * Process the clientHello.
     * @throws GordianException on error
     */
    void processClientHello() throws GordianException {
        /* Create ServerId and InitVector */
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (!theSpec.getAgreementType().isAnonymous()) {</span>
<span class="nc" id="L329">            theBuilder.newServerId();</span>
        }
<span class="nc" id="L331">        theBuilder.newServerIV();</span>

        /* Create serverEphemeral if needed */
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (needServerEphemeral()) {</span>
<span class="nc" id="L335">            theBuilder.newServerEphemeral();</span>
        }

        /* Copy ephemerals to keyPairs for signed */
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (theSpec.getAgreementType().isSigned()) {</span>
<span class="nc" id="L340">            theBuilder.copyEphemerals();</span>
        }

        /* Process the clientHello */
<span class="nc" id="L344">        theEngine.processClientHello();</span>

        /* If we are anonymous */
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (theSpec.getAgreementType().isAnonymous()) {</span>
            /* Set that the result is available */
<span class="nc" id="L349">            theBuilder.setStatus(GordianXAgreementStatus.RESULT_AVAILABLE);</span>

            /* Else we need to build a serverHello */
        } else {
            /* Build the new serverHello */
<span class="nc" id="L354">            final GordianXCoreAgreementMessageASN1 myMsg = theBuilder.newServerHello();</span>
<span class="nc" id="L355">            setNextMessage(myMsg);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">            theBuilder.setStatus(Boolean.TRUE.equals(theSpec.withConfirm())</span>
<span class="nc" id="L357">                    ? GordianXAgreementStatus.AWAITING_CLIENTCONFIRM</span>
<span class="nc" id="L358">                    : GordianXAgreementStatus.RESULT_AVAILABLE);</span>

            /* Store into cache if required */
<span class="nc bnc" id="L361" title="All 2 branches missed.">            if (Boolean.TRUE.equals(theSpec.withConfirm())) {</span>
<span class="nc" id="L362">                theSupplier.storeAgreement(myMsg.getServerId(), this);</span>
            }
        }
<span class="nc" id="L365">    }</span>

    /**
     * Process the serverHello.
     * @param pServerHello the serverHello
     * @throws GordianException on error
     */
    public void processServerHello(final GordianXCoreAgreementMessageASN1 pServerHello) throws GordianException {
        /* Check that we are expecting a serverHello */
<span class="nc" id="L374">        checkStatus(GordianXAgreementStatus.AWAITING_SERVERHELLO);</span>

        /* Parse the serverHello */
<span class="nc" id="L377">        theBuilder.parseServerHello(pServerHello);</span>

        /* Copy ephemerals to keyPairs for signed */
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (theSpec.getAgreementType().isSigned()) {</span>
<span class="nc" id="L381">            theBuilder.copyEphemerals();</span>
        }

        /* If we have no error */
<span class="nc" id="L385">        theEngine.processServerHello();</span>

        /* If we need to send confirm */
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (Boolean.TRUE.equals(theSpec.withConfirm())) {</span>
            /* Build the new clientConfirm */
<span class="nc" id="L390">            setNextMessage(theBuilder.newClientConfirm());</span>
        } else {
<span class="nc" id="L392">            setNextMessage(null);</span>
        }
<span class="nc" id="L394">        theBuilder.setStatus(GordianXAgreementStatus.RESULT_AVAILABLE);</span>

        /* remove from cache */
<span class="nc" id="L397">        theSupplier.removeAgreement(pServerHello.getClientId());</span>
<span class="nc" id="L398">    }</span>

    /**
     * Process the clientConfirm.
     * @param pClientConfirm the clientConfirm
     * @throws GordianException on error
     */
    public void processClientConfirm(final GordianXCoreAgreementMessageASN1 pClientConfirm) throws GordianException {
        /* Check that we are expecting a confirmation */
<span class="nc" id="L407">        checkStatus(GordianXAgreementStatus.AWAITING_CLIENTCONFIRM);</span>

        /* Parse the clientConfirm */
<span class="nc" id="L410">        theBuilder.parseClientConfirm(pClientConfirm);</span>

        /* If we have no error */
<span class="nc" id="L413">        theEngine.processClientConfirm();</span>

        /* Update status */
<span class="nc" id="L416">        setNextMessage(null);</span>
<span class="nc" id="L417">        theBuilder.setStatus(GordianXAgreementStatus.RESULT_AVAILABLE);</span>

        /* remove from cache */
<span class="nc" id="L420">        theSupplier.removeAgreement(pClientConfirm.getServerId());</span>
<span class="nc" id="L421">    }</span>

    /**
     * Do we need a client ephemeral?
     * @return true/false
     */
    private boolean needClientEphemeral() {
<span class="nc bnc" id="L428" title="All 3 branches missed.">        switch (theSpec.getAgreementType()) {</span>
            case SIGNED:
            case SM2:
            case MQV:
<span class="nc" id="L432">            case UNIFIED: return true;</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            case ANON: return !GordianKeyPairType.NEWHOPE.equals(theSpec.getKeyPairSpec().getKeyPairType());</span>
            case KEM:
            case BASIC:
<span class="nc" id="L436">            default: return false;</span>
        }
    }

    /**
     * Do we need a server ephemeral?
     * @return true/false
     */
    private boolean needServerEphemeral() {
<span class="nc bnc" id="L445" title="All 2 branches missed.">        switch (theSpec.getAgreementType()) {</span>
            case SIGNED:
            case SM2:
            case MQV:
<span class="nc" id="L449">            case UNIFIED: return true;</span>
            case ANON:
            case KEM:
            case BASIC:
<span class="nc" id="L453">            default: return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>