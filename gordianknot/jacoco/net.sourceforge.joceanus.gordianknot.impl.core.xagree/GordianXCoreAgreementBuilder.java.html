<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianXCoreAgreementBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.core.xagree</a> &gt; <span class="el_source">GordianXCoreAgreementBuilder.java</span></div><h1>GordianXCoreAgreementBuilder.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.core.xagree;

import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementSpec;
import net.sourceforge.joceanus.gordianknot.api.agree.GordianAgreementType;
import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.base.GordianLength;
import net.sourceforge.joceanus.gordianknot.api.cert.GordianCertificate;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairFactory;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPair;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairGenerator;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMac;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacFactory;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacSpec;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacSpecBuilder;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignParams;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignature;
import net.sourceforge.joceanus.gordianknot.api.sign.GordianSignatureSpec;
import net.sourceforge.joceanus.gordianknot.api.xagree.GordianXAgreementStatus;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.cert.GordianCoreCertificate;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianDataException;
import net.sourceforge.joceanus.gordianknot.impl.core.sign.GordianCoreSignatureFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.xagree.GordianXCoreAgreementCalculator.GordianXDerivationId;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;
import org.bouncycastle.asn1.x509.Certificate;
import org.bouncycastle.util.Arrays;

import java.security.SecureRandom;
import java.security.spec.X509EncodedKeySpec;

/**
 * Agreement Builder.
 */
public class GordianXCoreAgreementBuilder {
    /**
     * InitVectorLength.
     */
    private static final int INITLEN = 32;

    /**
     * The Supplier.
     */
    private final GordianXCoreAgreementSupplier theSupplier;

    /**
     * The factory.
     */
    private final GordianBaseFactory theFactory;

    /**
     * Secure Random.
     */
    private final SecureRandom theRandom;

    /**
     * The KeyPair factory.
     */
    private final GordianKeyPairGenerator theKeyPairGenerator;

    /**
     * The state.
     */
    private final GordianXCoreAgreementState theState;

    /**
     * The result calculator.
     */
    private final GordianXCoreAgreementCalculator theResultCalc;

    /**
     * Constructor.
     * @param pSupplier the supplier
     * @param pSpec the agreement spec
     * @throws GordianException on error
     */
    GordianXCoreAgreementBuilder(final GordianXCoreAgreementSupplier pSupplier,
<span class="nc" id="L93">                                 final GordianAgreementSpec pSpec) throws GordianException {</span>
        /* Store parameters and access factory and random */
<span class="nc" id="L95">        theSupplier = pSupplier;</span>
<span class="nc" id="L96">        theFactory = pSupplier.getFactory();</span>
<span class="nc" id="L97">        theRandom = theFactory.getRandomSource().getRandom();</span>

        /* Create the state */
<span class="nc" id="L100">        theState = new GordianXCoreAgreementState(pSpec);</span>
<span class="nc" id="L101">        final GordianKeyPairFactory myFactory = theFactory.getAsyncFactory().getKeyPairFactory();</span>
<span class="nc" id="L102">        theKeyPairGenerator = myFactory.getKeyPairGenerator(pSpec.getKeyPairSpec());</span>

        /* Create the result calculator */
<span class="nc" id="L105">        theResultCalc = new GordianXCoreAgreementCalculator(theFactory, theState);</span>
<span class="nc" id="L106">    }</span>

    /**
     * Obtain the supplier.
     * @return the supplier
     */
    public GordianXCoreAgreementSupplier getSupplier() {
<span class="nc" id="L113">        return theSupplier;</span>
    }

    /**
     * Obtain the state.
     * @return the state
     */
    public GordianXCoreAgreementState getState() {
<span class="nc" id="L121">        return theState;</span>
    }

    /**
     * Obtain the random.
     * @return the random
     */
    public SecureRandom getRandom() {
<span class="nc" id="L129">        return theFactory.getRandomSource().getRandom();</span>
    }

    /**
     * Set the status.
     * @param pStatus the status
     */
    void setStatus(final GordianXAgreementStatus pStatus) {
<span class="nc" id="L137">        theState.setStatus(pStatus);</span>
<span class="nc" id="L138">    }</span>

    /**
     * Set the resultType.
     * @param pResultType the resultType
     * @throws GordianException on error
     */
    void setResultType(final Object pResultType) throws GordianException {
<span class="nc" id="L146">        theState.setResultType(pResultType);</span>
<span class="nc" id="L147">    }</span>

    /**
     * Store secret.
     * @param pSecret the secret
     * @throws GordianException on error
     */
    public void storeSecret(final byte[] pSecret) throws GordianException {
        /* Protect against failure */
        try {
            /* Just process the secret */
<span class="nc" id="L158">            processSecret(pSecret);</span>

            /* Clear buffers */
        } finally {
            /* Clear the secret */
<span class="nc" id="L163">            Arrays.fill(pSecret, (byte) 0);</span>
        }
<span class="nc" id="L165">    }</span>

    /**
     * Process the secret.
     * @param pSecret the secret
     * @throws GordianException on error
     */
    private void processSecret(final byte[] pSecret) throws GordianException {
        /* If we are using confirmation and are not SM2 */
<span class="nc" id="L174">        final GordianAgreementSpec mySpec = theState.getSpec();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (Boolean.TRUE.equals(mySpec.withConfirm())</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                &amp;&amp; mySpec.getAgreementType() != GordianAgreementType.SM2) {</span>
            /* calculate the confirmation tags */
<span class="nc" id="L178">            calculateConfirmationTags(pSecret);</span>
        }

        /* Calculate result */
<span class="nc" id="L182">        theState.setResult(theResultCalc.processSecret(pSecret, theState.getResultType()));</span>
<span class="nc" id="L183">    }</span>

    /**
     * Set the result as an error.
     * @param pError the error
     */
    void setError(final String pError) {
        /* Store details of the error */
<span class="nc" id="L191">        theState.setResultType(pError);</span>
<span class="nc" id="L192">        theState.setResult(new GordianDataException(pError));</span>
<span class="nc" id="L193">    }</span>

    /**
     * Is there an errorState?.
     * @return true/false
     */
    public boolean isError() {
<span class="nc" id="L200">        return theState.getResultType() instanceof String;</span>
    }

    /**
     * Set the clientCertificate.
     * @param pCert the Certificate
     */
    void setClientCertificate(final GordianCertificate pCert) {
<span class="nc" id="L208">        theState.getClient().setCertificate(pCert);</span>
<span class="nc" id="L209">    }</span>

    /**
     * Set the serverCertificate.
     * @param pCert the Certificate
     */
    void setServerCertificate(final GordianCertificate pCert) {
<span class="nc" id="L216">        theState.getServer().setCertificate(pCert);</span>
<span class="nc" id="L217">    }</span>

    /**
     * Set the signerCertificate.
     * @param pCert the Certificate
     * @return the Builder
     */
    GordianXCoreAgreementBuilder setSignerCertificate(final GordianCertificate pCert) {
<span class="nc" id="L225">        theState.setSignerCertificate(pCert);</span>
<span class="nc" id="L226">        return this;</span>
    }

    /**
     * Set the signSpec.
     * @param pSpec the signSpec
     * @return the Builder
     */
    GordianXCoreAgreementBuilder setSignSpec(final GordianSignatureSpec pSpec) {
<span class="nc" id="L235">        theState.setSignSpec(pSpec);</span>
<span class="nc" id="L236">        return this;</span>
    }

    /**
     * Create a new clientId.
     */
    void newClientId() {
<span class="nc" id="L243">        theState.getClient().setId(theSupplier.getNextId());</span>
<span class="nc" id="L244">    }</span>

    /**
     * Create a new serverId.
     */
    void newServerId() {
<span class="nc" id="L250">        theState.getServer().setId(theSupplier.getNextId());</span>
<span class="nc" id="L251">    }</span>

    /**
     * Create a new client initVector.
     */
    void newClientIV() {
<span class="nc" id="L257">        final byte[] myClientIV = new byte[INITLEN];</span>
<span class="nc" id="L258">        theRandom.nextBytes(myClientIV);</span>
<span class="nc" id="L259">        theState.getClient().setInitVector(myClientIV);</span>
<span class="nc" id="L260">    }</span>

    /**
     * Create a new server initVector.
     */
    void newServerIV() {
<span class="nc" id="L266">        final byte[] myServerIV = new byte[INITLEN];</span>
<span class="nc" id="L267">        theRandom.nextBytes(myServerIV);</span>
<span class="nc" id="L268">        theState.getServer().setInitVector(myServerIV);</span>
<span class="nc" id="L269">    }</span>

    /**
     * Create a new client ephemeral.
     * @throws GordianException on error
     */
    public void newClientEphemeral() throws GordianException {
<span class="nc" id="L276">        final GordianKeyPair myPair = theKeyPairGenerator.generateKeyPair();</span>
<span class="nc" id="L277">        theState.getClient()</span>
<span class="nc" id="L278">                .setEphemeralKeyPair(myPair)</span>
<span class="nc" id="L279">                .setEphemeralKeySpec(theKeyPairGenerator.getX509Encoding(myPair));</span>
<span class="nc" id="L280">    }</span>

    /**
     * Set the client ephemeral.
     * @param pEphemeral the keyPair
     * @throws GordianException on error
     */
    public void setClientEphemeral(final GordianKeyPair pEphemeral) throws GordianException {
<span class="nc" id="L288">        theState.getClient()</span>
<span class="nc" id="L289">                .setEphemeralKeyPair(pEphemeral)</span>
<span class="nc" id="L290">                .setEphemeralKeySpec(theKeyPairGenerator.getX509Encoding(pEphemeral));</span>
<span class="nc" id="L291">    }</span>

    /**
     * Create a new client ephemeral.
     * @throws GordianException on error
     */
    public void newServerEphemeral() throws GordianException {
<span class="nc" id="L298">        final GordianKeyPair myPair = theKeyPairGenerator.generateKeyPair();</span>
<span class="nc" id="L299">        theState.getServer()</span>
<span class="nc" id="L300">                .setEphemeralKeyPair(myPair)</span>
<span class="nc" id="L301">                .setEphemeralKeySpec(theKeyPairGenerator.getX509Encoding(myPair));</span>
<span class="nc" id="L302">     }</span>

    /**
     * Copy ephemeral keyPairs to main keyPairs.
     */
    void copyEphemerals() {
<span class="nc" id="L308">        theState.getClient().copyEphemeral();</span>
<span class="nc" id="L309">        theState.getServer().copyEphemeral();</span>
<span class="nc" id="L310">    }</span>

    /**
     * Set the encapsulated message.
     * @param pEncapsulated the message
     */
    public void setEncapsulated(final byte[] pEncapsulated) {
<span class="nc" id="L317">        theState.setEncapsulated(pEncapsulated);</span>
<span class="nc" id="L318">    }</span>

    /**
     * Set the client confirm.
     * @param pConfirm the clientConfirm
     * @throws GordianException on error
     */
    void setClientConfirm(final byte[] pConfirm) throws GordianException {
        /* Access any expected value */
<span class="nc" id="L327">        final GordianXCoreAgreementParticipant myClient = theState.getClient();</span>
<span class="nc" id="L328">        final byte[] myExpected = myClient.getConfirm();</span>

        /* If we have an expected value, reject any difference */
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (myExpected != null</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                &amp;&amp; !Arrays.constantTimeAreEqual(myExpected, pConfirm)) {</span>
<span class="nc" id="L333">            throw new GordianDataException(&quot;Client Confirmation failed&quot;);</span>
        }
<span class="nc" id="L335">        myClient.setConfirm(pConfirm);</span>
<span class="nc" id="L336">    }</span>

    /**
     * Set the client confirm.
     * @param pConfirm the clientConfirm
     * @throws GordianException on error
     */
    void setServerConfirm(final byte[] pConfirm) throws GordianException {
        /* Access any expected value */
<span class="nc" id="L345">        final GordianXCoreAgreementParticipant myServer = theState.getServer();</span>
<span class="nc" id="L346">        final byte[] myExpected = myServer.getConfirm();</span>

        /* If we have an expected value, reject any difference */
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (myExpected != null</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                &amp;&amp; !Arrays.constantTimeAreEqual(myExpected, pConfirm)) {</span>
<span class="nc" id="L351">            throw new GordianDataException(&quot;Server Confirmation failed&quot;);</span>
        }
<span class="nc" id="L353">        myServer.setConfirm(pConfirm);</span>
<span class="nc" id="L354">    }</span>

    /**
     * Build the clientHello.
     * @return the clientHello message
     * @throws GordianException on error
     */
    GordianXCoreAgreementMessageASN1 newClientHello() throws GordianException {
        /* Access details */
<span class="nc" id="L363">        final GordianXCoreAgreementMessageASN1 myMsg = GordianXCoreAgreementMessageASN1.newClientHello();</span>
<span class="nc" id="L364">        final GordianXCoreAgreementParticipant myClient = theState.getClient();</span>
<span class="nc" id="L365">        final GordianXCoreAgreementParticipant myServer = theState.getServer();</span>

        /* Set standard details */
<span class="nc" id="L368">        myMsg.setAgreementId(theSupplier.getIdentifierForSpec(theState.getSpec()))</span>
<span class="nc" id="L369">                .setResultId(theSupplier.getIdentifierForResultType(theState.getResultType()))</span>
<span class="nc" id="L370">                .setClientId(myClient.getId())</span>
<span class="nc" id="L371">                .setInitVector(myClient.getInitVector())</span>
<span class="nc" id="L372">                .setEphemeral(myClient.getEphemeralKeySpec())</span>
<span class="nc" id="L373">                .setEncapsulated(theState.getEncapsulated());</span>

        /* Store certificates */
<span class="nc" id="L376">        final GordianCoreCertificate myClientCert = (GordianCoreCertificate) myClient.getCertificate();</span>
<span class="nc" id="L377">        final GordianCoreCertificate myServerCert = (GordianCoreCertificate) myServer.getCertificate();</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">        myMsg.setClientCertificate(myClientCert == null ? null : myClientCert.getCertificate())</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                .setServerCertificate(myServerCert == null ? null : myServerCert.getCertificate());</span>

        /* Return the message */
<span class="nc" id="L382">        return myMsg;</span>
    }

    /**
     * Build the serverHello.
     * @return the serverHello message
     * @throws GordianException on error
     */
    GordianXCoreAgreementMessageASN1 newServerHello() throws GordianException {
        /* Access details */
<span class="nc" id="L392">        final GordianXCoreAgreementMessageASN1 myMsg = GordianXCoreAgreementMessageASN1.newServerHello();</span>
<span class="nc" id="L393">        final GordianXCoreAgreementParticipant myClient = theState.getClient();</span>
<span class="nc" id="L394">        final GordianXCoreAgreementParticipant myServer = theState.getServer();</span>

        /* Set standard details */
<span class="nc" id="L397">        myMsg.setAgreementId(theSupplier.getIdentifierForSpec(theState.getSpec()))</span>
<span class="nc" id="L398">                .setClientId(myClient.getId());</span>

        /* Handle error result */
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (theState.getResultType() instanceof String myType) {</span>
<span class="nc" id="L402">            myMsg.setResultId(theSupplier.getIdentifierForResultType(myType));</span>
<span class="nc" id="L403">            return myMsg;</span>
        }

        /* Set server details */
<span class="nc" id="L407">        myMsg.setServerId(myServer.getId())</span>
<span class="nc" id="L408">                .setInitVector(myServer.getInitVector())</span>
<span class="nc" id="L409">                .setEphemeral(myServer.getEphemeralKeySpec())</span>
<span class="nc" id="L410">                .setConfirmation(myServer.getConfirm());</span>

        /* Store signing details */
<span class="nc" id="L413">        final GordianCoreCertificate mySignerCert = (GordianCoreCertificate) theState.getSignerCertificate();</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">        if (mySignerCert != null) {</span>
            /* Access details */
<span class="nc" id="L416">            final GordianCoreSignatureFactory mySigns = (GordianCoreSignatureFactory) theFactory.getAsyncFactory().getSignatureFactory();</span>
<span class="nc" id="L417">            final GordianSignatureSpec mySignSpec = theState.getSignSpec();</span>
<span class="nc" id="L418">            final GordianKeyPair mySignerPair = mySignerCert.getKeyPair();</span>
<span class="nc" id="L419">            final AlgorithmIdentifier myAlgId = mySigns.getIdentifierForSpecAndKeyPair(mySignSpec, mySignerPair);</span>

            /* Build the signature */
<span class="nc" id="L422">            final GordianSignature mySigner = mySigns.createSigner(mySignSpec);</span>
<span class="nc" id="L423">            mySigner.initForSigning(GordianSignParams.keyPair(mySignerPair));</span>
<span class="nc" id="L424">            mySigner.update(myClient.getEphemeralKeySpec().getEncoded());</span>
<span class="nc" id="L425">            mySigner.update(myClient.getInitVector());</span>
<span class="nc" id="L426">            mySigner.update(myServer.getEphemeralKeySpec().getEncoded());</span>
<span class="nc" id="L427">            mySigner.update(myServer.getInitVector());</span>
<span class="nc" id="L428">            myMsg.setSignerCertificate(mySignerCert.getCertificate())</span>
<span class="nc" id="L429">                    .setSignature(myAlgId, mySigner.sign());</span>
        }

        /* Return the message */
<span class="nc" id="L433">        return myMsg;</span>
    }

    /**
     * Build the clientConfirm.
     * @return the clientConfirm
     * @throws GordianException on error
     */
    GordianXCoreAgreementMessageASN1 newClientConfirm() throws GordianException {
        /* Access details */
<span class="nc" id="L443">        final GordianXCoreAgreementMessageASN1 myMsg = GordianXCoreAgreementMessageASN1.newClientConfirm();</span>
<span class="nc" id="L444">        final GordianXCoreAgreementParticipant myClient = theState.getClient();</span>
<span class="nc" id="L445">        final GordianXCoreAgreementParticipant myServer = theState.getServer();</span>

        /* Handle error result */
<span class="nc bnc" id="L448" title="All 2 branches missed.">        if (theState.getResultType() instanceof String myType) {</span>
<span class="nc" id="L449">            myMsg.setResultId(theSupplier.getIdentifierForResultType(myType));</span>
<span class="nc" id="L450">            return myMsg;</span>
        }

        /* Set standard details */
<span class="nc" id="L454">        myMsg.setAgreementId(theSupplier.getIdentifierForSpec(theState.getSpec()))</span>
<span class="nc" id="L455">                .setServerId(myServer.getId())</span>
<span class="nc" id="L456">                .setConfirmation(myClient.getConfirm());</span>

        /* Return the message */
<span class="nc" id="L459">        return myMsg;</span>
    }

    /**
     * Parse the clientHello.
     * @param pClientHello the message
     * @throws GordianException on error
     */
    void parseClientHello(final GordianXCoreAgreementMessageASN1 pClientHello) throws GordianException {
        /* Access details */
<span class="nc" id="L469">        final GordianXCoreAgreementParticipant myClient = theState.getClient();</span>
<span class="nc" id="L470">        final GordianXCoreAgreementParticipant myServer = theState.getServer();</span>

        /* Set standard details */
<span class="nc" id="L473">        theState.setResultType(theSupplier.getResultTypeForIdentifier(pClientHello.getResultId()))</span>
<span class="nc" id="L474">                .setEncapsulated(pClientHello.getEncapsulated());</span>

        /* Store client details */
<span class="nc" id="L477">        myClient.setId(pClientHello.getClientId())</span>
<span class="nc" id="L478">                .setInitVector(pClientHello.getInitVector());</span>
<span class="nc" id="L479">        final X509EncodedKeySpec myEphemeral = pClientHello.getEphemeral();</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (myEphemeral != null) {</span>
<span class="nc" id="L481">            myClient.setEphemeralKeySpec(myEphemeral)</span>
<span class="nc" id="L482">                    .setEphemeralKeyPair(theKeyPairGenerator.derivePublicOnlyKeyPair(myEphemeral));</span>
        }

        /* Store certificates */
<span class="nc" id="L486">        final Certificate myClientCert = pClientHello.getClientCertificate();</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">        myClient.setCertificate(myClientCert == null ? null : new GordianCoreCertificate(theFactory, myClientCert));</span>
<span class="nc" id="L488">        final Certificate myServerCert = pClientHello.getServerCertificate();</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        myServer.setCertificate(myServerCert == null ? null : new GordianCoreCertificate(theFactory, myServerCert));</span>
<span class="nc" id="L490">    }</span>

    /**
     * Parse the serverHello.
     * @param pServerHello the message
     * @throws GordianException on error
     */
    void parseServerHello(final GordianXCoreAgreementMessageASN1 pServerHello) throws GordianException {
        /* Access details */
<span class="nc" id="L499">        final GordianXCoreAgreementParticipant myClient = theState.getClient();</span>
<span class="nc" id="L500">        final GordianXCoreAgreementParticipant myServer = theState.getServer();</span>

        /* Handle error result */
<span class="nc" id="L503">        final AlgorithmIdentifier myResId = pServerHello.getResultId();</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (myResId != null) {</span>
<span class="nc" id="L505">            setError((String) theSupplier.getResultTypeForIdentifier(myResId));</span>
<span class="nc" id="L506">            return;</span>
        }

        /* Store server details */
<span class="nc" id="L510">        myServer.setId(pServerHello.getServerId())</span>
<span class="nc" id="L511">                .setInitVector(pServerHello.getInitVector())</span>
<span class="nc" id="L512">                .setConfirm(pServerHello.getConfirmation());</span>
<span class="nc" id="L513">        final X509EncodedKeySpec myEphemeral = pServerHello.getEphemeral();</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">        if (myEphemeral != null) {</span>
<span class="nc" id="L515">            myServer.setEphemeralKeySpec(myEphemeral)</span>
<span class="nc" id="L516">                    .setEphemeralKeyPair(theKeyPairGenerator.derivePublicOnlyKeyPair(myEphemeral));</span>
        }

        /* Store signing details */
<span class="nc" id="L520">        final Certificate mySignerCert = pServerHello.getSignerCertificate();</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (mySignerCert != null) {</span>
            /* Access details */
<span class="nc" id="L523">            final GordianCoreSignatureFactory mySigns = (GordianCoreSignatureFactory) theFactory.getAsyncFactory().getSignatureFactory();</span>
<span class="nc" id="L524">            final GordianSignatureSpec mySignSpec = mySigns.getSpecForIdentifier(pServerHello.getSignatureId());</span>
<span class="nc" id="L525">            final GordianCoreCertificate myCert = new GordianCoreCertificate(theFactory, mySignerCert);</span>
<span class="nc" id="L526">            final GordianKeyPair mySignerPair = myCert.getKeyPair();</span>
<span class="nc" id="L527">            theState.setSignerCertificate(myCert)</span>
<span class="nc" id="L528">                    .setSignSpec(mySignSpec);</span>
<span class="nc" id="L529">            final GordianSignature mySigner = mySigns.createSigner(mySignSpec);</span>

            /* Build the signature */
<span class="nc" id="L532">            mySigner.initForVerify(GordianSignParams.keyPair(mySignerPair));</span>
<span class="nc" id="L533">            mySigner.update(myClient.getEphemeralKeySpec().getEncoded());</span>
<span class="nc" id="L534">            mySigner.update(myClient.getInitVector());</span>
<span class="nc" id="L535">            mySigner.update(myServer.getEphemeralKeySpec().getEncoded());</span>
<span class="nc" id="L536">            mySigner.update(myServer.getInitVector());</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">            if (!mySigner.verify(pServerHello.getSignature())) {</span>
<span class="nc" id="L538">                setError(&quot;Signature Failed&quot;);</span>
            }
        }
<span class="nc" id="L541">    }</span>

    /**
     * Parse the clientConfirm.
     * @param pClientConfirm the clientConfirm
     * @throws GordianException on error
     */
    void parseClientConfirm(final GordianXCoreAgreementMessageASN1 pClientConfirm) throws GordianException {
        /* Access details */
<span class="nc" id="L550">        final GordianXCoreAgreementParticipant myClient = theState.getClient();</span>

        /* Handle error result */
<span class="nc" id="L553">        final AlgorithmIdentifier myResId = pClientConfirm.getResultId();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">        if (myResId != null) {</span>
<span class="nc" id="L555">            setError((String) theSupplier.getResultTypeForIdentifier(myResId));</span>
<span class="nc" id="L556">            return;</span>
        }

        /* Store client details */
<span class="nc" id="L560">        myClient.setConfirm(pClientConfirm.getConfirmation());</span>
<span class="nc" id="L561">    }</span>

    /**
     * Calculate the confirmation tags.
     * @param pSecret the secret
     * @throws GordianException on error
     */
    private void calculateConfirmationTags(final byte[] pSecret) throws GordianException {
        /* Access details */
<span class="nc" id="L570">        final GordianXCoreAgreementParticipant myClient = theState.getClient();</span>
<span class="nc" id="L571">        final GordianXCoreAgreementParticipant myServer = theState.getServer();</span>

        /* Derive the key */
<span class="nc" id="L574">        final byte[] myKey = theResultCalc.calculateDerivedSecret(pSecret, GordianXDerivationId.TAGS, GordianLength.LEN_512.getByteLength());</span>

        /* Create the hMac and initialize with the key */
<span class="nc" id="L577">        final GordianMacFactory myMacs = theFactory.getMacFactory();</span>
<span class="nc" id="L578">        final GordianMacSpec mySpec = GordianMacSpecBuilder.hMac(GordianXDerivationId.TAGS.getDigestType());</span>
<span class="nc" id="L579">        final GordianMac myMac = myMacs.createMac(mySpec);</span>
<span class="nc" id="L580">        myMac.initKeyBytes(myKey);</span>

        /* Access the public encodings */
<span class="nc" id="L583">        final byte[] myClientSpec = theKeyPairGenerator.getX509Encoding(myClient.getKeyPair()).getEncoded();</span>
<span class="nc" id="L584">        final byte[] myClientEphemeral = myClient.getEphemeralKeySpec().getEncoded();</span>
<span class="nc" id="L585">        final byte[] myServerSpec = theKeyPairGenerator.getX509Encoding(myServer.getKeyPair()).getEncoded();</span>
<span class="nc" id="L586">        final byte[] myServerEphemeral = myServer.getEphemeralKeySpec().getEncoded();</span>

        /* Build Server Confirmation tag */
<span class="nc" id="L589">        myMac.update(myServerSpec);</span>
<span class="nc" id="L590">        myMac.update(myClientSpec);</span>
<span class="nc" id="L591">        myMac.update(myServerEphemeral);</span>
<span class="nc" id="L592">        myMac.update(myClientEphemeral);</span>
<span class="nc" id="L593">        setServerConfirm(myMac.finish());</span>

        /* Build Client Confirmation tag */
<span class="nc" id="L596">        myMac.update(myClientSpec);</span>
<span class="nc" id="L597">        myMac.update(myServerSpec);</span>
<span class="nc" id="L598">        myMac.update(myClientEphemeral);</span>
<span class="nc" id="L599">        myMac.update(myServerEphemeral);</span>
<span class="nc" id="L600">        setClientConfirm(myMac.finish());</span>
<span class="nc" id="L601">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>