<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Encoder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">SevenZip.Compression.RangeCoder</a> &gt; <span class="el_source">Encoder.java</span></div><h1>Encoder.java</h1><pre class="source lang-java linenums">package SevenZip.Compression.RangeCoder;
import java.io.IOException;

<span class="fc" id="L4">public class Encoder</span>
{
	static final int kTopMask = ~((1 &lt;&lt; 24) - 1);
	
	static final int kNumBitModelTotalBits = 11;
	static final int kBitModelTotal = (1 &lt;&lt; kNumBitModelTotalBits);
	static final int kNumMoveBits = 5;
	
	java.io.OutputStream Stream;

	long Low;
	int Range;
	int _cacheSize;
	int _cache;
	
	long _position;
	
	public void SetStream(java.io.OutputStream stream)
	{
<span class="fc" id="L23">		Stream = stream;</span>
<span class="fc" id="L24">	}</span>
	
	public void ReleaseStream()
	{
<span class="fc" id="L28">		Stream = null;</span>
<span class="fc" id="L29">	}</span>
	
	public void Init()
	{
<span class="fc" id="L33">		_position = 0;</span>
<span class="fc" id="L34">		Low = 0;</span>
<span class="fc" id="L35">		Range = -1;</span>
<span class="fc" id="L36">		_cacheSize = 1;</span>
<span class="fc" id="L37">		_cache = 0;</span>
<span class="fc" id="L38">	}</span>
	
	public void FlushData() throws IOException
	{
<span class="fc bfc" id="L42" title="All 2 branches covered.">		for (int i = 0; i &lt; 5; i++)</span>
<span class="fc" id="L43">			ShiftLow();</span>
<span class="fc" id="L44">	}</span>
	
	public void FlushStream() throws IOException
	{
<span class="fc" id="L48">		Stream.flush();</span>
<span class="fc" id="L49">	}</span>
	
	public void ShiftLow() throws IOException
	{
<span class="fc" id="L53">		int LowHi = (int)(Low &gt;&gt;&gt; 32);</span>
<span class="fc bfc" id="L54" title="All 4 branches covered.">		if (LowHi != 0 || Low &lt; 0xFF000000L)</span>
		{
<span class="fc" id="L56">			_position += _cacheSize;</span>
<span class="fc" id="L57">			int temp = _cache;</span>
			do
			{
<span class="fc" id="L60">				Stream.write(temp + LowHi);</span>
<span class="fc" id="L61">				temp = 0xFF;</span>
			}
<span class="fc bfc" id="L63" title="All 2 branches covered.">			while(--_cacheSize != 0);</span>
<span class="fc" id="L64">			_cache = (((int)Low) &gt;&gt;&gt; 24);</span>
		}
<span class="fc" id="L66">		_cacheSize++;</span>
<span class="fc" id="L67">		Low = (Low &amp; 0xFFFFFF) &lt;&lt; 8;</span>
<span class="fc" id="L68">	}</span>
	
	public void EncodeDirectBits(int v, int numTotalBits) throws IOException
	{
<span class="fc bfc" id="L72" title="All 2 branches covered.">		for (int i = numTotalBits - 1; i &gt;= 0; i--)</span>
		{
<span class="fc" id="L74">			Range &gt;&gt;&gt;= 1;</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">			if (((v &gt;&gt;&gt; i) &amp; 1) == 1)</span>
<span class="fc" id="L76">				Low += Range;</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">			if ((Range &amp; Encoder.kTopMask) == 0)</span>
			{
<span class="fc" id="L79">				Range &lt;&lt;= 8;</span>
<span class="fc" id="L80">				ShiftLow();</span>
			}
		}
<span class="fc" id="L83">	}</span>
	
	
	public long GetProcessedSizeAdd()
	{
<span class="fc" id="L88">		return _cacheSize + _position + 4;</span>
	}
	
	
	
	static final int kNumMoveReducingBits = 2;
	public static final int kNumBitPriceShiftBits = 6;
	
	public static void InitBitModels(short []probs)
	{
<span class="fc bfc" id="L98" title="All 2 branches covered.">		for (int i = 0; i &lt; probs.length; i++)</span>
<span class="fc" id="L99">			probs[i] = (kBitModelTotal &gt;&gt;&gt; 1);</span>
<span class="fc" id="L100">	}</span>
	
	public void Encode(short []probs, int index, int symbol) throws IOException
	{
<span class="fc" id="L104">		int prob = probs[index];</span>
<span class="fc" id="L105">		int newBound = (Range &gt;&gt;&gt; kNumBitModelTotalBits) * prob;</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">		if (symbol == 0)</span>
		{
<span class="fc" id="L108">			Range = newBound;</span>
<span class="fc" id="L109">			probs[index] = (short)(prob + ((kBitModelTotal - prob) &gt;&gt;&gt; kNumMoveBits));</span>
		}
		else
		{
<span class="fc" id="L113">			Low += (newBound &amp; 0xFFFFFFFFL);</span>
<span class="fc" id="L114">			Range -= newBound;</span>
<span class="fc" id="L115">			probs[index] = (short)(prob - ((prob) &gt;&gt;&gt; kNumMoveBits));</span>
		}
<span class="fc bfc" id="L117" title="All 2 branches covered.">		if ((Range &amp; kTopMask) == 0)</span>
		{
<span class="fc" id="L119">			Range &lt;&lt;= 8;</span>
<span class="fc" id="L120">			ShiftLow();</span>
		}
<span class="fc" id="L122">	}</span>
	
<span class="fc" id="L124">	private static int[] ProbPrices = new int[kBitModelTotal &gt;&gt;&gt; kNumMoveReducingBits];</span>
	
	static
	{
<span class="fc" id="L128">		int kNumBits = (kNumBitModelTotalBits - kNumMoveReducingBits);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">		for (int i = kNumBits - 1; i &gt;= 0; i--)</span>
		{
<span class="fc" id="L131">			int start = 1 &lt;&lt; (kNumBits - i - 1);</span>
<span class="fc" id="L132">			int end = 1 &lt;&lt; (kNumBits - i);</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">			for (int j = start; j &lt; end; j++)</span>
<span class="fc" id="L134">				ProbPrices[j] = (i &lt;&lt; kNumBitPriceShiftBits) +</span>
						(((end - j) &lt;&lt; kNumBitPriceShiftBits) &gt;&gt;&gt; (kNumBits - i - 1));
		}
<span class="fc" id="L137">	}</span>
	
	static public int GetPrice(int Prob, int symbol)
	{
<span class="fc" id="L141">		return ProbPrices[(((Prob - symbol) ^ ((-symbol))) &amp; (kBitModelTotal - 1)) &gt;&gt;&gt; kNumMoveReducingBits];</span>
	}
	static public int GetPrice0(int Prob)
	{ 
<span class="fc" id="L145">		return ProbPrices[Prob &gt;&gt;&gt; kNumMoveReducingBits]; </span>
	}
	static public int GetPrice1(int Prob)
	{ 
<span class="fc" id="L149">		return ProbPrices[(kBitModelTotal - Prob) &gt;&gt;&gt; kNumMoveReducingBits]; </span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>