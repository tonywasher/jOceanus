<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianCoreAgreementFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.gordianknot.impl.core.agree</a> &gt; <span class="el_source">GordianCoreAgreementFactory.java</span></div><h1>GordianCoreAgreementFactory.java</h1><pre class="source lang-java linenums">/*
 * GordianKnot: Security Suite
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.gordianknot.impl.core.agree;

import io.github.tonywasher.joceanus.gordianknot.api.agree.GordianAgreement;
import io.github.tonywasher.joceanus.gordianknot.api.agree.GordianAgreementKDF;
import io.github.tonywasher.joceanus.gordianknot.api.agree.GordianAgreementParams;
import io.github.tonywasher.joceanus.gordianknot.api.agree.GordianAgreementSpec;
import io.github.tonywasher.joceanus.gordianknot.api.agree.GordianAgreementSpecBuilder;
import io.github.tonywasher.joceanus.gordianknot.api.agree.GordianAgreementType;
import io.github.tonywasher.joceanus.gordianknot.api.base.GordianException;
import io.github.tonywasher.joceanus.gordianknot.api.cert.GordianCertificate;
import io.github.tonywasher.joceanus.gordianknot.api.cert.GordianKeyPairUsage;
import io.github.tonywasher.joceanus.gordianknot.api.cert.GordianKeyPairUse;
import io.github.tonywasher.joceanus.gordianknot.api.keypair.GordianEdwardsElliptic;
import io.github.tonywasher.joceanus.gordianknot.api.keypair.GordianKeyPair;
import io.github.tonywasher.joceanus.gordianknot.api.keypair.GordianKeyPairSpec;
import io.github.tonywasher.joceanus.gordianknot.api.keypair.GordianKeyPairType;
import io.github.tonywasher.joceanus.gordianknot.api.sign.GordianSignatureFactory;
import io.github.tonywasher.joceanus.gordianknot.api.sign.GordianSignatureSpec;
import io.github.tonywasher.joceanus.gordianknot.impl.core.base.GordianBaseData;
import io.github.tonywasher.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import io.github.tonywasher.joceanus.gordianknot.impl.core.cert.GordianMiniCertificate;
import io.github.tonywasher.joceanus.gordianknot.impl.core.exc.GordianDataException;
import org.bouncycastle.asn1.x500.X500Name;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.function.Predicate;

/**
 * Core agreement factory.
 */
public abstract class GordianCoreAgreementFactory
        implements GordianCoreAgreementSupplier {
    /**
     * The factory.
     */
    private final GordianBaseFactory theFactory;

    /**
     * The id cache.
     */
    private final GordianCoreAgreementCache theCache;

    /**
     * The algorithm Ids.
     */
    private GordianCoreAgreementAlgId theAlgIds;

    /**
     * The signer certificate.
     */
    private GordianCertificate theSignerCertificate;

    /**
     * The signatureSpec.
     */
    private GordianSignatureSpec theSignSpec;

    /**
     * Constructor.
     *
     * @param pFactory the factory
     */
<span class="fc" id="L82">    protected GordianCoreAgreementFactory(final GordianBaseFactory pFactory) {</span>
<span class="fc" id="L83">        theFactory = pFactory;</span>
<span class="fc" id="L84">        theCache = new GordianCoreAgreementCache(theFactory.getRandomSource());</span>
<span class="fc" id="L85">    }</span>

    @Override
    public GordianBaseFactory getFactory() {
<span class="fc" id="L89">        return theFactory;</span>
    }

    @Override
    public GordianAgreementParams newAgreementParams(final GordianAgreementSpec pSpec,
                                                     final Object pResultType) throws GordianException {
<span class="fc" id="L95">        return new GordianCoreAgreementParams(this, pSpec, pResultType);</span>
    }

    @Override
    public GordianCertificate newMiniCertificate(final X500Name pSubject,
                                                 final GordianKeyPair pKeyPair,
                                                 final GordianKeyPairUsage pUsage) throws GordianException {
<span class="fc" id="L102">        return new GordianMiniCertificate(theFactory, pSubject, pKeyPair, pUsage);</span>
    }

    @Override
    public GordianAgreement createAgreement(final GordianAgreementParams pParams) throws GordianException {
        /* Check validity of Agreement */
<span class="fc" id="L108">        final GordianAgreementSpec mySpec = pParams.getAgreementSpec();</span>
<span class="fc" id="L109">        checkAgreementSpec(mySpec);</span>

        /* Create the agreement */
<span class="fc" id="L112">        final GordianCoreAgreementEngine myEngine = createEngine(mySpec);</span>
<span class="fc" id="L113">        final GordianCoreAgreement myAgreement = new GordianCoreAgreement(myEngine);</span>

        /* Set the details */
<span class="fc" id="L116">        myAgreement.setClientCertificate(pParams.getClientCertificate());</span>
<span class="fc" id="L117">        myAgreement.setServerCertificate(pParams.getServerCertificate());</span>
<span class="fc" id="L118">        myAgreement.setResultType(pParams.getResultType());</span>
<span class="fc" id="L119">        myAgreement.setAdditionalData(pParams.getAdditionalData());</span>

        /* Build the clientHello */
<span class="fc" id="L122">        myAgreement.buildClientHello();</span>

        /* Return the agreement */
<span class="fc" id="L125">        return myAgreement;</span>
    }

    @Override
    public GordianAgreement parseAgreementMessage(final byte[] pMessage) throws GordianException {
        /* Parse the message */
<span class="fc" id="L131">        final GordianCoreAgreementMessageASN1 myASN1 = GordianCoreAgreementMessageASN1.getInstance(pMessage);</span>

        /* Switch on the messageType */
<span class="pc bpc" id="L134" title="1 of 4 branches missed.">        switch (myASN1.getMessageType()) {</span>
            case CLIENTHELLO:
<span class="fc" id="L136">                return parseClientHello(myASN1);</span>
            case SERVERHELLO:
<span class="fc" id="L138">                return parseServerHello(myASN1);</span>
            case CLIENTCONFIRM:
<span class="fc" id="L140">                return parseClientConfirm(myASN1);</span>
            default:
<span class="nc" id="L142">                throw new GordianDataException(&quot;Unexpected MessageType: &quot; + myASN1.getMessageType());</span>
        }
    }

    /**
     * Parse a clientHello message.
     *
     * @param pClientHello the message
     * @return the agreement
     * @throws GordianException error
     */
    private GordianAgreement parseClientHello(final GordianCoreAgreementMessageASN1 pClientHello) throws GordianException {
        /* Create a new agreement */
<span class="fc" id="L155">        final GordianAgreementSpec mySpec = getSpecForIdentifier(pClientHello.getAgreementId());</span>
<span class="fc" id="L156">        final GordianCoreAgreementEngine myEngine = createEngine(mySpec);</span>
<span class="fc" id="L157">        final GordianCoreAgreement myAgreement = new GordianCoreAgreement(myEngine);</span>

        /* Parse the clientHello */
<span class="fc" id="L160">        myAgreement.parseClientHello(pClientHello);</span>

        /* Return the agreement */
<span class="fc" id="L163">        return myAgreement;</span>
    }

    /**
     * Parse a serverHello message.
     *
     * @param pServerHello the message
     * @return the agreement
     * @throws GordianException error
     */
    private GordianAgreement parseServerHello(final GordianCoreAgreementMessageASN1 pServerHello) throws GordianException {
        /* Look up the agreement in the cache */
<span class="fc" id="L175">        final GordianAgreementSpec mySpec = getSpecForIdentifier(pServerHello.getAgreementId());</span>
<span class="fc" id="L176">        final GordianCoreAgreement myAgreement = theCache.lookUpAgreement(pServerHello.getClientId(), mySpec);</span>

        /* Process the serverHello */
<span class="fc" id="L179">        myAgreement.processServerHello(pServerHello);</span>

        /* Return the agreement */
<span class="fc" id="L182">        return myAgreement;</span>
    }

    /**
     * Parse a clientConfirm message.
     *
     * @param pClientConfirm the message
     * @return the agreement
     * @throws GordianException error
     */
    private GordianAgreement parseClientConfirm(final GordianCoreAgreementMessageASN1 pClientConfirm) throws GordianException {
        /* Look up the agreement in the cache */
<span class="fc" id="L194">        final GordianAgreementSpec mySpec = getSpecForIdentifier(pClientConfirm.getAgreementId());</span>
<span class="fc" id="L195">        final GordianCoreAgreement myAgreement = theCache.lookUpAgreement(pClientConfirm.getServerId(), mySpec);</span>

        /* Process the clientConfirm */
<span class="fc" id="L198">        myAgreement.processClientConfirm(pClientConfirm);</span>

        /* Return the agreement */
<span class="fc" id="L201">        return myAgreement;</span>
    }

    /**
     * Create engine.
     *
     * @param pSpec the agreement Spec
     * @return the engine
     * @throws GordianException on error
     */
    protected GordianCoreAgreementEngine createEngine(final GordianAgreementSpec pSpec) throws GordianException {
        /* If this is a composite agreement */
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (pSpec.getKeyPairSpec().getKeyPairType() == GordianKeyPairType.COMPOSITE) {</span>
            /* Create an engine for each sub-agreement */
<span class="fc" id="L215">            final List&lt;GordianAgreementSpec&gt; mySpecs = GordianCoreAgreementComposite.getSubAgreements(pSpec);</span>
<span class="fc" id="L216">            final List&lt;GordianCoreAgreementEngine&gt; myEngines = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">            for (GordianAgreementSpec mySpec : mySpecs) {</span>
<span class="fc" id="L218">                myEngines.add(createEngine(mySpec));</span>
<span class="fc" id="L219">            }</span>
<span class="fc" id="L220">            return new GordianCoreAgreementComposite(this, pSpec, myEngines);</span>
        }

        /* Unsupported spec */
<span class="nc" id="L224">        throw new GordianDataException(GordianBaseData.getInvalidText(pSpec));</span>
    }

    @Override
    public Predicate&lt;GordianAgreementSpec&gt; supportedAgreements() {
<span class="fc" id="L229">        return this::validAgreementSpec;</span>
    }

    @Override
    public void checkAgreementSpec(final GordianAgreementSpec pAgreementSpec) throws GordianException {
        /* Check validity of agreement */
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">        if (!validAgreementSpec(pAgreementSpec)) {</span>
<span class="nc" id="L236">            throw new GordianDataException(GordianBaseData.getInvalidText(pAgreementSpec));</span>
        }
<span class="fc" id="L238">    }</span>

    @Override
    public Long getNextId() {
<span class="fc" id="L242">        return theCache.getNextId();</span>
    }

    @Override
    public void storeAgreement(final Long pId,
                               final GordianAgreement pAgreement) {
<span class="fc" id="L248">        theCache.storeAgreement(pId, pAgreement);</span>
<span class="fc" id="L249">    }</span>

    @Override
    public void removeAgreement(final Long pId) {
<span class="fc" id="L253">        theCache.removeAgreement(pId);</span>
<span class="fc" id="L254">    }</span>

    @Override
    public void setSigner(final GordianCertificate pSigner) throws GordianException {
<span class="nc" id="L258">        final GordianSignatureFactory mySignFactory = theFactory.getAsyncFactory().getSignatureFactory();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        final GordianSignatureSpec mySignSpec = pSigner == null ? null : mySignFactory.defaultForKeyPair(pSigner.getKeyPair().getKeyPairSpec());</span>
<span class="nc" id="L260">        setSigner(pSigner, mySignSpec);</span>
<span class="nc" id="L261">    }</span>

    @Override
    public void setSigner(final GordianCertificate pSigner,
                          final GordianSignatureSpec pSignSpec) throws GordianException {
        /* Check that certificate can sign data */
<span class="nc bnc" id="L267" title="All 4 branches missed.">        if (pSigner == null || !pSigner.getUsage().hasUse(GordianKeyPairUse.SIGNATURE)) {</span>
<span class="nc" id="L268">            throw new GordianDataException(&quot;Certificate must be capable of signing data&quot;);</span>
        }

        /* Check that certificate can sign data */
<span class="nc" id="L272">        final GordianSignatureFactory mySignFactory = theFactory.getAsyncFactory().getSignatureFactory();</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (!mySignFactory.validSignatureSpecForKeyPair(pSigner.getKeyPair(), pSignSpec)) {</span>
<span class="nc" id="L274">            throw new GordianDataException(GordianBaseData.getInvalidText(pSignSpec));</span>
        }

        /* Store parameters */
<span class="nc" id="L278">        theSignerCertificate = pSigner;</span>
<span class="nc" id="L279">        theSignSpec = pSignSpec;</span>
<span class="nc" id="L280">    }</span>

    /**
     * Check AgreementSpec.
     *
     * @param pSpec the agreementSpec
     * @return true/false
     */
    protected boolean validAgreementSpec(final GordianAgreementSpec pSpec) {
        /* Reject invalid agreementSpec */
<span class="pc bpc" id="L290" title="1 of 4 branches missed.">        if (pSpec == null || !pSpec.isValid()) {</span>
<span class="fc" id="L291">            return false;</span>
        }

        /* Check that spec is supported */
<span class="fc" id="L295">        return pSpec.isSupported();</span>
    }

    @Override
    public boolean validAgreementSpecForKeyPairSpec(final GordianKeyPairSpec pKeyPairSpec,
                                                    final GordianAgreementSpec pAgreementSpec) {
        /* Check that the agreementSpec is supported */
<span class="fc bfc" id="L302" title="All 2 branches covered.">        if (!validAgreementSpec(pAgreementSpec)) {</span>
<span class="fc" id="L303">            return false;</span>
        }

        /* Check agreement matches keySpec */
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">        if (!pAgreementSpec.getKeyPairSpec().equals(pKeyPairSpec)) {</span>
<span class="nc" id="L308">            return false;</span>
        }

        /* For Edwards XDH, disallow 512KDF for 25519 and 256KDF for 448 */
<span class="fc bfc" id="L312" title="All 2 branches covered.">        if (pKeyPairSpec.getKeyPairType() == GordianKeyPairType.XDH) {</span>
<span class="fc" id="L313">            final GordianEdwardsElliptic myEdwards = pKeyPairSpec.getEdwardsElliptic();</span>
<span class="fc bfc" id="L314" title="All 3 branches covered.">            switch (pAgreementSpec.getKDFType()) {</span>
                case SHA256KDF:
                case SHA256CKDF:
                case SHA256HKDF:
<span class="fc" id="L318">                    return myEdwards.is25519();</span>
                case SHA512KDF:
                case SHA512CKDF:
                case SHA512HKDF:
<span class="fc bfc" id="L322" title="All 2 branches covered.">                    return !myEdwards.is25519();</span>
                default:
                    break;
            }
        }

        /* For Composite AgreementSpec */
<span class="fc bfc" id="L329" title="All 2 branches covered.">        if (pKeyPairSpec.getKeyPairType() == GordianKeyPairType.COMPOSITE) {</span>
            /* Access the subSpecs  */
<span class="fc" id="L331">            final List&lt;GordianAgreementSpec&gt; mySubAgrees = GordianCoreAgreementComposite.getSubAgreements(pAgreementSpec);</span>

            /* Loop through the subAgreements */
<span class="fc bfc" id="L334" title="All 2 branches covered.">            for (GordianAgreementSpec mySpec : mySubAgrees) {</span>
<span class="fc bfc" id="L335" title="All 2 branches covered.">                if (!validAgreementSpecForKeyPairSpec(mySpec.getKeyPairSpec(), mySpec)) {</span>
<span class="fc" id="L336">                    return false;</span>
                }
<span class="fc" id="L338">            }</span>

            /* Check confirmation */
<span class="fc bfc" id="L341" title="All 2 branches covered.">            if (Boolean.TRUE.equals(pAgreementSpec.withConfirm())</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">                    &amp;&amp; !pAgreementSpec.getAgreementType().canConfirm()) {</span>
<span class="nc" id="L343">                return false;</span>
            }

            /* Disallow SM2 with confirm */
<span class="fc bfc" id="L347" title="All 2 branches covered.">            return pAgreementSpec.getAgreementType() != GordianAgreementType.SM2</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">                    || !pAgreementSpec.withConfirm();</span>
        }

        /* OK */
<span class="fc" id="L352">        return true;</span>
    }

    @Override
    public AlgorithmIdentifier getIdentifierForSpec(final GordianAgreementSpec pSpec) {
<span class="fc" id="L357">        return getAlgorithmIds().determineIdentifier(pSpec);</span>
    }

    @Override
    public GordianAgreementSpec getSpecForIdentifier(final AlgorithmIdentifier pIdentifier) {
<span class="fc" id="L362">        return getAlgorithmIds().determineAgreementSpec(pIdentifier);</span>
    }

    @Override
    public AlgorithmIdentifier getIdentifierForResultType(final Object pResult) throws GordianException {
<span class="fc" id="L367">        return getAlgorithmIds().getIdentifierForResult(pResult);</span>
    }

    @Override
    public Object getResultTypeForIdentifier(final AlgorithmIdentifier pIdentifier) throws GordianException {
<span class="fc" id="L372">        return getAlgorithmIds().processResultIdentifier(pIdentifier);</span>
    }

    /**
     * Obtain the agreement algorithm Ids.
     *
     * @return the agreement Algorithm Ids
     */
    private GordianCoreAgreementAlgId getAlgorithmIds() {
<span class="fc bfc" id="L381" title="All 2 branches covered.">        if (theAlgIds == null) {</span>
<span class="fc" id="L382">            theAlgIds = new GordianCoreAgreementAlgId(theFactory);</span>
        }
<span class="fc" id="L384">        return theAlgIds;</span>
    }

    @Override
    public List&lt;GordianAgreementSpec&gt; listAllSupportedAgreements(final GordianKeyPair pKeyPair) {
<span class="nc" id="L389">        return listAllSupportedAgreements(pKeyPair.getKeyPairSpec());</span>
    }

    @Override
    public List&lt;GordianAgreementSpec&gt; listAllSupportedAgreements(final GordianKeyPairSpec pKeyPairSpec) {
<span class="fc" id="L394">        return listPossibleAgreements(pKeyPairSpec)</span>
<span class="fc" id="L395">                .stream()</span>
<span class="fc" id="L396">                .filter(supportedAgreements())</span>
<span class="fc" id="L397">                .filter(s -&gt; validAgreementSpecForKeyPairSpec(pKeyPairSpec, s))</span>
<span class="fc" id="L398">                .toList();</span>
    }

    /**
     * Obtain a list of all possible agreements for the keyPairSpec.
     *
     * @param pKeyPairSpec the keyPairSpec
     * @return the list
     */
    private List&lt;GordianAgreementSpec&gt; listPossibleAgreements(final GordianKeyPairSpec pKeyPairSpec) {
        /* Create list */
<span class="fc" id="L409">        final List&lt;GordianAgreementSpec&gt; myAgreements = new ArrayList&lt;&gt;();</span>

        /* Switch on keyPairType */
<span class="fc bfc" id="L412" title="All 7 branches covered.">        switch (pKeyPairSpec.getKeyPairType()) {</span>
            case RSA:
<span class="fc" id="L414">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.KEM));</span>
<span class="fc" id="L415">                break;</span>
            case NEWHOPE:
            case CMCE:
            case FRODO:
            case SABER:
            case MLKEM:
            case HQC:
            case BIKE:
            case NTRU:
            case NTRUPRIME:
<span class="fc" id="L425">                myAgreements.add(GordianAgreementSpecBuilder.kem(pKeyPairSpec, GordianAgreementKDF.NONE));</span>
<span class="fc" id="L426">                break;</span>
            case EC:
            case SM2:
            case GOST2012:
<span class="fc" id="L430">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.ANON));</span>
<span class="fc" id="L431">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.KEM));</span>
<span class="fc" id="L432">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.BASIC));</span>
<span class="fc" id="L433">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SIGNED));</span>
<span class="fc" id="L434">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED));</span>
<span class="fc" id="L435">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED, Boolean.TRUE));</span>
<span class="fc" id="L436">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.MQV));</span>
<span class="fc" id="L437">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.MQV, Boolean.TRUE));</span>
<span class="fc" id="L438">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SM2));</span>
<span class="fc" id="L439">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SM2, Boolean.TRUE));</span>
<span class="fc" id="L440">                break;</span>
            case DH:
            case DSTU4145:
<span class="fc" id="L443">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.ANON));</span>
<span class="fc" id="L444">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.KEM));</span>
<span class="fc" id="L445">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.BASIC));</span>
<span class="fc" id="L446">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SIGNED));</span>
<span class="fc" id="L447">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED));</span>
<span class="fc" id="L448">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED, Boolean.TRUE));</span>
<span class="fc" id="L449">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.MQV));</span>
<span class="fc" id="L450">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.MQV, Boolean.TRUE));</span>
<span class="fc" id="L451">                break;</span>
            case XDH:
<span class="fc" id="L453">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.ANON));</span>
<span class="fc" id="L454">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.BASIC));</span>
<span class="fc" id="L455">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.SIGNED));</span>
<span class="fc" id="L456">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED));</span>
<span class="fc" id="L457">                myAgreements.addAll(listAllKDFs(pKeyPairSpec, GordianAgreementType.UNIFIED, Boolean.TRUE));</span>
<span class="fc" id="L458">                break;</span>
            case COMPOSITE:
                /* Loop through the possible keySpecs for the first key */
<span class="fc" id="L461">                final Iterator&lt;GordianKeyPairSpec&gt; myIterator = pKeyPairSpec.keySpecIterator();</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">                for (GordianAgreementSpec mySpec : listPossibleAgreements(myIterator.next())) {</span>
<span class="fc" id="L463">                    final GordianAgreementSpec myTest = new GordianAgreementSpec(pKeyPairSpec, mySpec.getAgreementType(), mySpec.getKDFType(), mySpec.withConfirm());</span>
<span class="pc bpc" id="L464" title="1 of 2 branches missed.">                    if (myTest.isValid()) {</span>
<span class="fc" id="L465">                        myAgreements.add(myTest);</span>
                    }
<span class="fc" id="L467">                }</span>
<span class="fc" id="L468">                break;</span>
            default:
                break;
        }

        /* Return the list */
<span class="fc" id="L474">        return myAgreements;</span>
    }

    /**
     * Create list of KDF variants.
     *
     * @param pKeyPairSpec   the keyPairSpec
     * @param pAgreementType the agreementType
     * @return the list
     */
    public static List&lt;GordianAgreementSpec&gt; listAllKDFs(final GordianKeyPairSpec pKeyPairSpec,
                                                         final GordianAgreementType pAgreementType) {
<span class="fc" id="L486">        return listAllKDFs(pKeyPairSpec, pAgreementType, Boolean.FALSE);</span>
    }

    @Override
    public GordianAgreementSpec defaultForKeyPair(final GordianKeyPairSpec pKeySpec) {
<span class="fc" id="L491">        final Iterator&lt;GordianAgreementSpec&gt; myIterator = listAllSupportedAgreements(pKeySpec).iterator();</span>
<span class="pc bpc" id="L492" title="1 of 2 branches missed.">        return myIterator.hasNext() ? myIterator.next() : null;</span>
    }

    /**
     * Create list of KDF variants.
     *
     * @param pKeyPairSpec   the keyPairSpec
     * @param pAgreementType the agreementType
     * @param pConfirm       with key confirmation
     * @return the list
     */
    public static List&lt;GordianAgreementSpec&gt; listAllKDFs(final GordianKeyPairSpec pKeyPairSpec,
                                                         final GordianAgreementType pAgreementType,
                                                         final Boolean pConfirm) {
        /* Create list */
<span class="fc" id="L507">        final List&lt;GordianAgreementSpec&gt; myAgreements = new ArrayList&lt;&gt;();</span>

        /* Loop through the KDFs */
<span class="fc bfc" id="L510" title="All 2 branches covered.">        for (final GordianAgreementKDF myKDF : GordianAgreementKDF.values()) {</span>
<span class="fc" id="L511">            myAgreements.add(new GordianAgreementSpec(pKeyPairSpec, pAgreementType, myKDF, pConfirm));</span>
        }

        /* Return the list */
<span class="fc" id="L515">        return myAgreements;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>