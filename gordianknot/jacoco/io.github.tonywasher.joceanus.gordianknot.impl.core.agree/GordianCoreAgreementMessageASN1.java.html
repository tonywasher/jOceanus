<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianCoreAgreementMessageASN1.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.gordianknot.impl.core.agree</a> &gt; <span class="el_source">GordianCoreAgreementMessageASN1.java</span></div><h1>GordianCoreAgreementMessageASN1.java</h1><pre class="source lang-java linenums">/*
 * GordianKnot: Security Suite
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.gordianknot.impl.core.agree;

import io.github.tonywasher.joceanus.gordianknot.api.base.GordianException;
import io.github.tonywasher.joceanus.gordianknot.api.cert.GordianCertificate;
import io.github.tonywasher.joceanus.gordianknot.api.factory.GordianFactory;
import io.github.tonywasher.joceanus.gordianknot.impl.core.base.GordianASN1Util.GordianASN1Object;
import io.github.tonywasher.joceanus.gordianknot.impl.core.cert.GordianCertificateASN1;
import io.github.tonywasher.joceanus.gordianknot.impl.core.exc.GordianDataException;
import io.github.tonywasher.joceanus.gordianknot.impl.core.exc.GordianIOException;
import org.bouncycastle.asn1.ASN1EncodableVector;
import org.bouncycastle.asn1.ASN1Integer;
import org.bouncycastle.asn1.ASN1OctetString;
import org.bouncycastle.asn1.ASN1Primitive;
import org.bouncycastle.asn1.ASN1Sequence;
import org.bouncycastle.asn1.ASN1TaggedObject;
import org.bouncycastle.asn1.BEROctetString;
import org.bouncycastle.asn1.DERSequence;
import org.bouncycastle.asn1.DERTaggedObject;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;
import org.bouncycastle.asn1.x509.SubjectPublicKeyInfo;

import java.io.IOException;
import java.security.spec.X509EncodedKeySpec;
import java.util.Arrays;
import java.util.Enumeration;
import java.util.Objects;

/**
 * ASN1 Encoding of Agreement Messages.
 * &lt;pre&gt;
 * GordianAgreementMessageASN1 ::= SEQUENCE  {
 *      Id Identification
 *      Algs Specifications
 *      clientCertificate [1] GordianCertificateASN1 OPTIONAL
 *      serverCertificate [2] GordianCertificateASN1 OPTIONAL
 *      signerCertificate [3] GordianCertificateASN1 OPTIONAL
 *      initVector [4] OCTET STRING OPTIONAL
 *      encapsulated [5] OCTET STRING OPTIONAL
 *      ephemeral [6] SubjectPublicKeyInfo OPTIONAL
 *      confirmation [7] OCTET STRING OPTIONAL
 *      signature [8] OCTET STRING OPTIONAL
 * }
 *
 * Identification ::= SEQUENCE  {
 *      messageType INTEGER
 *      clientId [1] INTEGER OPTIONAL
 *      serverId [2] INTEGER OPTIONAL
 * }
 *
 * Specification ::= SEQUENCE  {
 *      agreeId AlgorithmIdentifier
 *      resultId [1] AlgorithmIdentifier OPTIONAL
 *      signId [2] lgorithmIdentifier OPTIONAL
 *  }
 * &lt;/pre&gt;
 */
public final class GordianCoreAgreementMessageASN1
        extends GordianASN1Object {
    /**
     * The clientCertificate tag.
     */
    private static final int TAG_CLIENTCERTIFICATE = 1;

    /**
     * The serverCertificate tag.
     */
    private static final int TAG_SERVERCERTIFICATE = 2;

    /**
     * The signingCertificate tag.
     */
    private static final int TAG_SIGNERCERTIFICATE = 3;

    /**
     * The initVector tag.
     */
    private static final int TAG_INITVECTOR = 4;

    /**
     * The encapsulated tag.
     */
    private static final int TAG_ENCAPSULATED = 5;

    /**
     * The ephemeral tag.
     */
    private static final int TAG_EPHEMERAL = 6;

    /**
     * The confirmation tag.
     */
    private static final int TAG_CONFIRMATION = 7;

    /**
     * The signature tag.
     */
    private static final int TAG_SIGNATURE = 8;

    /**
     * The clientId tag.
     */
    private static final int TAG_CLIENTID = 1;

    /**
     * The serverId tag.
     */
    private static final int TAG_SERVERID = 2;


    /**
     * The resultAlgId tag.
     */
    private static final int TAG_RESULTALGID = 1;

    /**
     * The signAlgId tag.
     */
    private static final int TAG_SIGNALGID = 2;

    /**
     * The MessageType.
     */
    private final GordianAgreementMessageType theMessageType;

    /**
     * The ClientId.
     */
    private Long theClientId;

    /**
     * The ServerId.
     */
    private Long theServerId;

    /**
     * The Agreement AlgorithmId.
     */
    private AlgorithmIdentifier theAgreementId;

    /**
     * The ResultId.
     */
    private AlgorithmIdentifier theResultId;

    /**
     * The SignatureId.
     */
    private AlgorithmIdentifier theSignatureId;

    /**
     * The Client Certificate.
     */
    private GordianCertificateASN1 theClientCertificate;

    /**
     * The Server Certificate.
     */
    private GordianCertificateASN1 theServerCertificate;

    /**
     * The Signer Certificate.
     */
    private GordianCertificateASN1 theSignerCertificate;

    /**
     * The InitVector.
     */
    private byte[] theInitVector;

    /**
     * The Encapsulated.
     */
    private byte[] theEncapsulated;

    /**
     * The Ephemeral.
     */
    private X509EncodedKeySpec theEphemeral;

    /**
     * The Confirmation.
     */
    private byte[] theConfirmation;

    /**
     * The Signature.
     */
    private byte[] theSignature;

    /**
     * Constructor.
     *
     * @param pType the messageType
     */
<span class="fc" id="L211">    private GordianCoreAgreementMessageASN1(final GordianAgreementMessageType pType) {</span>
<span class="fc" id="L212">        theMessageType = pType;</span>
<span class="fc" id="L213">    }</span>

    /**
     * Constructor.
     *
     * @param pSequence the Sequence
     * @throws GordianException on error
     */
<span class="fc" id="L221">    private GordianCoreAgreementMessageASN1(final ASN1Sequence pSequence) throws GordianException {</span>
        /* Protect against exceptions */
        try {
            /* Access the sequence */
<span class="fc" id="L225">            final ASN1Sequence mySequence = ASN1Sequence.getInstance(pSequence);</span>
<span class="fc" id="L226">            final Enumeration&lt;?&gt; en = mySequence.getObjects();</span>

            /* Access id element */
<span class="fc" id="L229">            final ASN1Sequence myId = ASN1Sequence.getInstance(en.nextElement());</span>
<span class="fc" id="L230">            final Enumeration&lt;?&gt; enIds = myId.getObjects();</span>
<span class="fc" id="L231">            theMessageType = GordianAgreementMessageType.determineType(ASN1Integer.getInstance(enIds.nextElement()).intValueExact());</span>

            /* Loop through the optional id elements */
<span class="fc bfc" id="L234" title="All 2 branches covered.">            while (enIds.hasMoreElements()) {</span>
<span class="fc" id="L235">                final ASN1TaggedObject myTagged = ASN1TaggedObject.getInstance(enIds.nextElement());</span>
<span class="pc bpc" id="L236" title="1 of 3 branches missed.">                switch (myTagged.getTagNo()) {</span>
                    case TAG_CLIENTID:
<span class="fc" id="L238">                        theClientId = ASN1Integer.getInstance(myTagged, false).longValueExact();</span>
<span class="fc" id="L239">                        break;</span>
                    case TAG_SERVERID:
<span class="fc" id="L241">                        theServerId = ASN1Integer.getInstance(myTagged, false).longValueExact();</span>
<span class="fc" id="L242">                        break;</span>
                    default:
<span class="nc" id="L244">                        throw new GordianDataException(&quot;Unexpected id tag&quot;);</span>
                }
<span class="fc" id="L246">            }</span>

            /* Access algorithms element */
<span class="fc" id="L249">            final ASN1Sequence myAlgs = ASN1Sequence.getInstance(en.nextElement());</span>
<span class="fc" id="L250">            final Enumeration&lt;?&gt; enAlgs = myAlgs.getObjects();</span>
<span class="fc" id="L251">            theAgreementId = AlgorithmIdentifier.getInstance(enAlgs.nextElement());</span>

            /* Loop through the optional algorithm elements */
<span class="fc bfc" id="L254" title="All 2 branches covered.">            while (enAlgs.hasMoreElements()) {</span>
<span class="fc" id="L255">                final ASN1TaggedObject myTagged = ASN1TaggedObject.getInstance(enAlgs.nextElement());</span>
<span class="pc bpc" id="L256" title="1 of 3 branches missed.">                switch (myTagged.getTagNo()) {</span>
                    case TAG_RESULTALGID:
<span class="fc" id="L258">                        theResultId = AlgorithmIdentifier.getInstance(myTagged, false);</span>
<span class="fc" id="L259">                        break;</span>
                    case TAG_SIGNALGID:
<span class="fc" id="L261">                        theSignatureId = AlgorithmIdentifier.getInstance(myTagged, false);</span>
<span class="fc" id="L262">                        break;</span>
                    default:
<span class="nc" id="L264">                        throw new GordianDataException(&quot;Unexpected algorithm tag&quot;);</span>
                }
<span class="fc" id="L266">            }</span>

            /* Loop through the optional elements */
<span class="fc bfc" id="L269" title="All 2 branches covered.">            while (en.hasMoreElements()) {</span>
<span class="fc" id="L270">                final ASN1TaggedObject myTagged = ASN1TaggedObject.getInstance(en.nextElement());</span>
<span class="pc bpc" id="L271" title="1 of 9 branches missed.">                switch (myTagged.getTagNo()) {</span>
                    case TAG_CLIENTCERTIFICATE:
<span class="fc" id="L273">                        theClientCertificate = GordianCertificateASN1.getInstance(myTagged, false);</span>
<span class="fc" id="L274">                        break;</span>
                    case TAG_SERVERCERTIFICATE:
<span class="fc" id="L276">                        theServerCertificate = GordianCertificateASN1.getInstance(myTagged, false);</span>
<span class="fc" id="L277">                        break;</span>
                    case TAG_SIGNERCERTIFICATE:
<span class="fc" id="L279">                        theSignerCertificate = GordianCertificateASN1.getInstance(myTagged, false);</span>
<span class="fc" id="L280">                        break;</span>
                    case TAG_INITVECTOR:
<span class="fc" id="L282">                        theInitVector = ASN1OctetString.getInstance(myTagged, false).getOctets();</span>
<span class="fc" id="L283">                        break;</span>
                    case TAG_ENCAPSULATED:
<span class="fc" id="L285">                        theEncapsulated = ASN1OctetString.getInstance(myTagged, false).getOctets();</span>
<span class="fc" id="L286">                        break;</span>
                    case TAG_EPHEMERAL:
<span class="fc" id="L288">                        theEphemeral = new X509EncodedKeySpec(SubjectPublicKeyInfo.getInstance(myTagged, false).getEncoded());</span>
<span class="fc" id="L289">                        break;</span>
                    case TAG_CONFIRMATION:
<span class="fc" id="L291">                        theConfirmation = ASN1OctetString.getInstance(myTagged, false).getOctets();</span>
<span class="fc" id="L292">                        break;</span>
                    case TAG_SIGNATURE:
<span class="fc" id="L294">                        theSignature = ASN1OctetString.getInstance(myTagged, false).getOctets();</span>
<span class="fc" id="L295">                        break;</span>
                    default:
<span class="nc" id="L297">                        throw new GordianDataException(&quot;Unexpected tag&quot;);</span>
                }
<span class="fc" id="L299">            }</span>

            /* handle exceptions */
<span class="nc" id="L302">        } catch (IllegalArgumentException</span>
                 | IOException e) {
<span class="nc" id="L304">            throw new GordianIOException(&quot;Unable to parse ASN1 sequence&quot;, e);</span>
<span class="fc" id="L305">        }</span>
<span class="fc" id="L306">    }</span>

    /**
     * Create a client hello.
     *
     * @return the clientHello
     */
    public static GordianCoreAgreementMessageASN1 newClientHello() {
<span class="fc" id="L314">        return new GordianCoreAgreementMessageASN1(GordianAgreementMessageType.CLIENTHELLO);</span>
    }

    /**
     * Create a server hello.
     *
     * @return the serverHello
     */
    public static GordianCoreAgreementMessageASN1 newServerHello() {
<span class="fc" id="L323">        return new GordianCoreAgreementMessageASN1(GordianAgreementMessageType.SERVERHELLO);</span>
    }

    /**
     * Create a client confirm.
     *
     * @return the clientConfirm
     */
    public static GordianCoreAgreementMessageASN1 newClientConfirm() {
<span class="fc" id="L332">        return new GordianCoreAgreementMessageASN1(GordianAgreementMessageType.CLIENTCONFIRM);</span>
    }

    /**
     * Parse the ASN1 object.
     *
     * @param pObject the object to parse
     * @return the parsed object
     * @throws GordianException on error
     */
    public static GordianCoreAgreementMessageASN1 getInstance(final Object pObject) throws GordianException {
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">        if (pObject instanceof GordianCoreAgreementMessageASN1 myASN1) {</span>
<span class="nc" id="L344">            return myASN1;</span>
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">        } else if (pObject != null) {</span>
<span class="fc" id="L346">            return new GordianCoreAgreementMessageASN1(ASN1Sequence.getInstance(pObject));</span>
        }
<span class="nc" id="L348">        throw new GordianDataException(&quot;Null sequence&quot;);</span>
    }

    /**
     * Get the messageType.
     *
     * @return the messageType
     */
    GordianAgreementMessageType getMessageType() {
<span class="fc" id="L357">        return theMessageType;</span>
    }

    /**
     * Check the message type.
     *
     * @param pMessageType the message type
     * @throws GordianException on error
     */
    public void checkMessageType(final GordianAgreementMessageType pMessageType) throws GordianException {
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (!theMessageType.equals(pMessageType)) {</span>
<span class="nc" id="L368">            throw new GordianDataException(&quot;Unexpected Message type: &quot; + pMessageType);</span>
        }
<span class="nc" id="L370">    }</span>

    /**
     * Get the clientId.
     *
     * @return the clientId
     */
    Long getClientId() {
<span class="fc" id="L378">        return theClientId;</span>
    }

    /**
     * Set the clientId.
     *
     * @param pClientId the clientId
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setClientId(final Long pClientId) {
<span class="fc" id="L388">        theClientId = pClientId;</span>
<span class="fc" id="L389">        return this;</span>
    }

    /**
     * Get the clientId.
     *
     * @return the clientId
     */
    Long getServerId() {
<span class="fc" id="L398">        return theServerId;</span>
    }

    /**
     * Set the serverId.
     *
     * @param pServerId the serverId
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setServerId(final Long pServerId) {
<span class="fc" id="L408">        theServerId = pServerId;</span>
<span class="fc" id="L409">        return this;</span>
    }

    /**
     * Get the agreement algorithmId.
     *
     * @return the agreement algorithmId (or null)
     */
    AlgorithmIdentifier getAgreementId() {
<span class="fc" id="L418">        return theAgreementId;</span>
    }

    /**
     * Set the agreement algorithmId.
     *
     * @param pAgreeId the agreementId
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setAgreementId(final AlgorithmIdentifier pAgreeId) {
<span class="fc" id="L428">        theAgreementId = pAgreeId;</span>
<span class="fc" id="L429">        return this;</span>
    }

    /**
     * Get the result algorithmId.
     *
     * @return the result algorithmId (or null)
     */
    AlgorithmIdentifier getResultId() {
<span class="fc" id="L438">        return theResultId;</span>
    }

    /**
     * Set the result algorithmId.
     *
     * @param pResultId the resultId
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setResultId(final AlgorithmIdentifier pResultId) {
<span class="fc" id="L448">        theResultId = pResultId;</span>
<span class="fc" id="L449">        return this;</span>
    }

    /**
     * Get the client certificate.
     *
     * @param pFactory the factory
     * @return the certificate (or null)
     * @throws GordianException on error
     */
    GordianCertificate getClientCertificate(final GordianFactory pFactory) throws GordianException {
<span class="fc bfc" id="L460" title="All 2 branches covered.">        return theClientCertificate == null ? null : theClientCertificate.getCertificate(pFactory);</span>
    }

    /**
     * Set the client certificate.
     *
     * @param pCertificate the certificate
     * @return this object
     * @throws GordianException on error
     */
    GordianCoreAgreementMessageASN1 setClientCertificate(final GordianCertificate pCertificate) throws GordianException {
<span class="fc bfc" id="L471" title="All 2 branches covered.">        theClientCertificate = pCertificate == null ? null : new GordianCertificateASN1(pCertificate);</span>
<span class="fc" id="L472">        return this;</span>
    }

    /**
     * Get the server certificate.
     *
     * @param pFactory the factory
     * @return the certificate (or null)
     * @throws GordianException on error
     */
    GordianCertificate getServerCertificate(final GordianFactory pFactory) throws GordianException {
<span class="fc bfc" id="L483" title="All 2 branches covered.">        return theServerCertificate == null ? null : theServerCertificate.getCertificate(pFactory);</span>
    }

    /**
     * Set the server certificate.
     *
     * @param pCertificate the certificate
     * @return this object
     * @throws GordianException on error
     */
    GordianCoreAgreementMessageASN1 setServerCertificate(final GordianCertificate pCertificate) throws GordianException {
<span class="fc bfc" id="L494" title="All 2 branches covered.">        theServerCertificate = pCertificate == null ? null : new GordianCertificateASN1(pCertificate);</span>
<span class="fc" id="L495">        return this;</span>
    }

    /**
     * Get the signer certificate.
     *
     * @param pFactory the factory
     * @return the certificate (or null)
     * @throws GordianException on error
     */
    GordianCertificate getSignerCertificate(final GordianFactory pFactory) throws GordianException {
<span class="fc bfc" id="L506" title="All 2 branches covered.">        return theSignerCertificate == null ? null : theSignerCertificate.getCertificate(pFactory);</span>
    }

    /**
     * Set the signer certificate.
     *
     * @param pCertificate the certificate
     * @return this object
     * @throws GordianException on error
     */
    GordianCoreAgreementMessageASN1 setSignerCertificate(final GordianCertificate pCertificate) throws GordianException {
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">        theSignerCertificate = pCertificate == null ? null : new GordianCertificateASN1(pCertificate);</span>
<span class="fc" id="L518">        return this;</span>
    }

    /**
     * Get the initVector.
     *
     * @return the initVector (or null)
     */
    byte[] getInitVector() {
<span class="fc" id="L527">        return theInitVector;</span>
    }

    /**
     * Set the initVector.
     *
     * @param pInitVector the initVector Tag
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setInitVector(final byte[] pInitVector) {
<span class="fc" id="L537">        theInitVector = pInitVector;</span>
<span class="fc" id="L538">        return this;</span>
    }

    /**
     * Get the encapsulated.
     *
     * @return the encapsulated (or null)
     */
    public byte[] getEncapsulated() {
<span class="fc" id="L547">        return theEncapsulated;</span>
    }

    /**
     * Set the encapsulated.
     *
     * @param pEncapsulated the encapsulated
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setEncapsulated(final byte[] pEncapsulated) {
<span class="fc" id="L557">        theEncapsulated = pEncapsulated;</span>
<span class="fc" id="L558">        return this;</span>
    }

    /**
     * Get the ephemeral.
     *
     * @return the ephemeral (or null)
     */
    public X509EncodedKeySpec getEphemeral() {
<span class="fc" id="L567">        return theEphemeral;</span>
    }

    /**
     * Set the ephemeral.
     *
     * @param pEphemeral the ephemeral
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setEphemeral(final X509EncodedKeySpec pEphemeral) {
<span class="fc" id="L577">        theEphemeral = pEphemeral;</span>
<span class="fc" id="L578">        return this;</span>
    }

    /**
     * Get the confirmation.
     *
     * @return the confirmation Tag (or null)
     */
    byte[] getConfirmation() {
<span class="fc" id="L587">        return theConfirmation;</span>
    }

    /**
     * Set the confirmation.
     *
     * @param pConfirmation the confirmation Tag
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setConfirmation(final byte[] pConfirmation) {
<span class="fc" id="L597">        theConfirmation = pConfirmation;</span>
<span class="fc" id="L598">        return this;</span>
    }

    /**
     * Get the signature algorithmId.
     *
     * @return the signature algorithmId (or null)
     */
    AlgorithmIdentifier getSignatureId() {
<span class="fc" id="L607">        return theSignatureId;</span>
    }

    /**
     * Get the signature.
     *
     * @return the signature (or null)
     */
    byte[] getSignature() {
<span class="fc" id="L616">        return theSignature;</span>
    }

    /**
     * Set the signature and algorithmId.
     *
     * @param pSignatureId the signature algorithmId
     * @param pSignature   the signature
     * @return this object
     */
    GordianCoreAgreementMessageASN1 setSignature(final AlgorithmIdentifier pSignatureId,
                                                 final byte[] pSignature) {
<span class="fc" id="L628">        theSignatureId = pSignatureId;</span>
<span class="fc" id="L629">        theSignature = pSignature;</span>
<span class="fc" id="L630">        return this;</span>
    }

    @Override
    public ASN1Primitive toASN1Primitive() {
        /* Create the vector */
<span class="fc" id="L636">        final ASN1EncodableVector v = new ASN1EncodableVector();</span>

        /* Add id section */
<span class="fc" id="L639">        final ASN1EncodableVector vId = new ASN1EncodableVector();</span>
<span class="fc" id="L640">        vId.add(new ASN1Integer(theMessageType.getId()));</span>
<span class="fc bfc" id="L641" title="All 2 branches covered.">        if (theClientId != null) {</span>
<span class="fc" id="L642">            vId.add(new DERTaggedObject(false, TAG_CLIENTID, new ASN1Integer(theClientId)));</span>
        }
<span class="fc bfc" id="L644" title="All 2 branches covered.">        if (theServerId != null) {</span>
<span class="fc" id="L645">            vId.add(new DERTaggedObject(false, TAG_SERVERID, new ASN1Integer(theServerId)));</span>
        }
<span class="fc" id="L647">        v.add(new DERSequence(vId));</span>

        /* Add algorithm section */
<span class="fc" id="L650">        final ASN1EncodableVector vAlg = new ASN1EncodableVector();</span>
<span class="fc" id="L651">        vAlg.add(theAgreementId);</span>
<span class="fc bfc" id="L652" title="All 2 branches covered.">        if (theResultId != null) {</span>
<span class="fc" id="L653">            vAlg.add(new DERTaggedObject(false, TAG_RESULTALGID, theResultId));</span>
        }
<span class="fc bfc" id="L655" title="All 2 branches covered.">        if (theSignatureId != null) {</span>
<span class="fc" id="L656">            vAlg.add(new DERTaggedObject(false, TAG_SIGNALGID, theSignatureId));</span>
        }
<span class="fc" id="L658">        v.add(new DERSequence(vAlg));</span>

        /* Add optional components */
<span class="fc bfc" id="L661" title="All 2 branches covered.">        if (theClientCertificate != null) {</span>
<span class="fc" id="L662">            v.add(new DERTaggedObject(false, TAG_CLIENTCERTIFICATE, theClientCertificate));</span>
        }
<span class="fc bfc" id="L664" title="All 2 branches covered.">        if (theServerCertificate != null) {</span>
<span class="fc" id="L665">            v.add(new DERTaggedObject(false, TAG_SERVERCERTIFICATE, theServerCertificate));</span>
        }
<span class="fc bfc" id="L667" title="All 2 branches covered.">        if (theSignerCertificate != null) {</span>
<span class="fc" id="L668">            v.add(new DERTaggedObject(false, TAG_SIGNERCERTIFICATE, theSignerCertificate));</span>
        }
<span class="fc bfc" id="L670" title="All 2 branches covered.">        if (theInitVector != null) {</span>
<span class="fc" id="L671">            v.add(new DERTaggedObject(false, TAG_INITVECTOR, new BEROctetString(theInitVector)));</span>
        }
<span class="fc bfc" id="L673" title="All 2 branches covered.">        if (theEncapsulated != null) {</span>
<span class="fc" id="L674">            v.add(new DERTaggedObject(false, TAG_ENCAPSULATED, new BEROctetString(theEncapsulated)));</span>
        }
<span class="fc bfc" id="L676" title="All 2 branches covered.">        if (theEphemeral != null) {</span>
<span class="fc" id="L677">            v.add(new DERTaggedObject(false, TAG_EPHEMERAL, SubjectPublicKeyInfo.getInstance(theEphemeral.getEncoded())));</span>
        }
<span class="fc bfc" id="L679" title="All 2 branches covered.">        if (theConfirmation != null) {</span>
<span class="fc" id="L680">            v.add(new DERTaggedObject(false, TAG_CONFIRMATION, new BEROctetString(theConfirmation)));</span>
        }
<span class="fc bfc" id="L682" title="All 2 branches covered.">        if (theSignature != null) {</span>
<span class="fc" id="L683">            v.add(new DERTaggedObject(false, TAG_SIGNATURE, new BEROctetString(theSignature)));</span>
        }

<span class="fc" id="L686">        return new DERSequence(v);</span>
    }


    @Override
    public boolean equals(final Object pThat) {
        /* Handle trivial cases */
<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (this == pThat) {</span>
<span class="nc" id="L694">            return true;</span>
        }
<span class="nc bnc" id="L696" title="All 2 branches missed.">        if (pThat == null) {</span>
<span class="nc" id="L697">            return false;</span>
        }

        /* Check that the fields are equal */
<span class="nc" id="L701">        return pThat instanceof GordianCoreAgreementMessageASN1 myThat</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">                &amp;&amp; Objects.equals(getMessageType(), myThat.getMessageType())</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">                &amp;&amp; Objects.equals(getClientId(), myThat.getClientId())</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">                &amp;&amp; Objects.equals(getServerId(), myThat.getServerId())</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">                &amp;&amp; Objects.equals(getAgreementId(), myThat.getAgreementId())</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">                &amp;&amp; Objects.equals(getResultId(), myThat.getResultId())</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">                &amp;&amp; Objects.equals(getSignatureId(), myThat.getSignatureId())</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                &amp;&amp; Objects.equals(getEphemeral(), myThat.getEphemeral())</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                &amp;&amp; Objects.equals(theClientCertificate, myThat.theClientCertificate)</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                &amp;&amp; Objects.equals(theServerCertificate, myThat.theServerCertificate)</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">                &amp;&amp; Objects.equals(theSignerCertificate, myThat.theSignerCertificate)</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                &amp;&amp; Arrays.equals(getSignature(), myThat.getSignature())</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                &amp;&amp; Arrays.equals(getEncapsulated(), myThat.getEncapsulated())</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                &amp;&amp; Arrays.equals(getConfirmation(), myThat.getConfirmation())</span>
<span class="nc bnc" id="L715" title="All 4 branches missed.">                &amp;&amp; Arrays.equals(getInitVector(), myThat.getInitVector());</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L720">        return Objects.hash(getMessageType(), getClientId(), getServerId(),</span>
<span class="nc" id="L721">                getAgreementId(), getResultId(), getSignatureId(), getEphemeral(),</span>
                theClientCertificate, theServerCertificate, theSignerCertificate)
<span class="nc" id="L723">                ^ Arrays.hashCode(getSignature())</span>
<span class="nc" id="L724">                ^ Arrays.hashCode(getEncapsulated())</span>
<span class="nc" id="L725">                ^ Arrays.hashCode(getConfirmation())</span>
<span class="nc" id="L726">                ^ Arrays.hashCode(getInitVector());</span>
    }

    /**
     * The messageType.
     */
<span class="fc" id="L732">    public enum GordianAgreementMessageType {</span>
        /**
         * ClientHello.
         */
<span class="fc" id="L736">        CLIENTHELLO(1),</span>

        /**
         * ServerHello.
         */
<span class="fc" id="L741">        SERVERHELLO(2),</span>

        /**
         * ClientConfirm.
         */
<span class="fc" id="L746">        CLIENTCONFIRM(3);</span>

        /**
         * The messageId.
         */
        private final int theId;

        /**
         * Constructor.
         *
         * @param pId the id
         */
<span class="fc" id="L758">        GordianAgreementMessageType(final int pId) {</span>
<span class="fc" id="L759">            theId = pId;</span>
<span class="fc" id="L760">        }</span>

        /**
         * Obtain id for messageType.
         *
         * @return the id
         */
        int getId() {
<span class="fc" id="L768">            return theId;</span>
        }

        /**
         * Determine the MessageType from the id.
         *
         * @param pId the id
         * @return the messageType
         * @throws GordianException on error
         */
        private static GordianAgreementMessageType determineType(final int pId) throws GordianException {
<span class="pc bpc" id="L779" title="1 of 2 branches missed.">            for (GordianAgreementMessageType myType : values()) {</span>
<span class="fc bfc" id="L780" title="All 2 branches covered.">                if (pId == myType.getId()) {</span>
<span class="fc" id="L781">                    return myType;</span>
                }
            }
<span class="nc" id="L784">            throw new GordianDataException(&quot;Unexpected messageType: &quot; + pId);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>