<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GordianKeyStoreElement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.core.keystore</a> &gt; <span class="el_source">GordianKeyStoreElement.java</span></div><h1>GordianKeyStoreElement.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.core.keystore;

import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.base.GordianKeySpec;
import net.sourceforge.joceanus.gordianknot.api.cert.GordianCertificate;
import net.sourceforge.joceanus.gordianknot.api.factory.GordianFactory;
import net.sourceforge.joceanus.gordianknot.api.lock.GordianLockFactory;
import net.sourceforge.joceanus.gordianknot.api.key.GordianKey;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPair;
import net.sourceforge.joceanus.gordianknot.api.keyset.GordianKeySet;
import net.sourceforge.joceanus.gordianknot.api.lock.GordianKeySetLock;
import net.sourceforge.joceanus.gordianknot.api.lock.GordianPasswordLockSpec;
import net.sourceforge.joceanus.gordianknot.impl.core.cert.GordianCoreCertificate;
import net.sourceforge.joceanus.gordianknot.impl.core.keystore.GordianBaseKeyStore.GordianKeyStoreCertificateKey;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * KeyStoreElement.
 * &lt;p&gt;
 * These are the entries as held in the keyStore.
 * &lt;/p&gt;
 */
public interface GordianKeyStoreElement {
    /**
     * KeyStore Certificate.
     */
    interface GordianKeyStoreCertificateHolder {
        /**
         * Obtain the key.
         * @return the key
         */
        GordianKeyStoreCertificateKey getCertificateKey();
    }

    /**
     * KeyStore Certificate Element.
     */
    class GordianKeyStoreCertificateElement
            extends GordianCoreKeyStoreEntry
            implements GordianKeyStoreCertificateHolder {
        /**
         * The certificate Id.
         */
        private final GordianKeyStoreCertificateKey theKey;

        /**
         * Constructor.
         * @param pCertificate the certificate.
         */
<span class="fc" id="L70">        GordianKeyStoreCertificateElement(final GordianCertificate pCertificate) {</span>
<span class="fc" id="L71">            theKey = new GordianKeyStoreCertificateKey(pCertificate);</span>
<span class="fc" id="L72">        }</span>

        /**
         * Constructor.
         * @param pKey the key.
         * @param pDate the creation date
         */
        GordianKeyStoreCertificateElement(final GordianKeyStoreCertificateKey pKey,
                                          final LocalDate pDate) {
<span class="nc" id="L81">            super(pDate);</span>
<span class="nc" id="L82">            theKey = pKey;</span>
<span class="nc" id="L83">        }</span>

        @Override
        public GordianKeyStoreCertificateKey getCertificateKey() {
<span class="fc" id="L87">            return theKey;</span>
        }

        /**
         * Obtain the corresponding keyStoreEntry.
         * @param pKeyStore the keyStore
         * @return the keyStore certificate entry
         */
        GordianCoreKeyStoreCertificate buildEntry(final GordianBaseKeyStore pKeyStore) {
<span class="nc" id="L96">            final GordianCoreCertificate myCert = (GordianCoreCertificate) pKeyStore.getCertificate(getCertificateKey());</span>
<span class="nc" id="L97">            return new GordianCoreKeyStoreCertificate(myCert, getCreationDate());</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L104">                return true;</span>
            }
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L107">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (!(pThat instanceof GordianKeyStoreCertificateElement)) {</span>
<span class="nc" id="L112">                return false;</span>
            }
<span class="nc" id="L114">            final GordianKeyStoreCertificateElement myThat = (GordianKeyStoreCertificateElement) pThat;</span>

            /* Check that the keys match */
<span class="nc bnc" id="L117" title="All 2 branches missed.">            return theKey.equals(myThat.getCertificateKey())</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L123">            return theKey.hashCode()</span>
<span class="nc" id="L124">                    + super.hashCode();</span>
        }
    }

    /**
     * KeyStore KeyPair Element.
     */
    class GordianKeyStorePairElement
            extends GordianCoreKeyStoreEntry
            implements GordianKeyStoreCertificateHolder {
        /**
         * The securedPrivateKey.
         */
        private final byte[] theSecuredKey;

        /**
         * The securing lock.
         */
        private final GordianKeyStoreLockElement theSecuringLock;

        /**
         * The certificate chain.
         */
        private final List&lt;GordianKeyStoreCertificateKey&gt; theChain;

        /**
         * Constructor.
         * @param pFactory the factory
         * @param pSpec the passwordLockSpec
         * @param pKeyPair the keyPair
         * @param pPassword the securing password.
         * @param pChain the certificate chain.
         * @throws GordianException on error
         */
        GordianKeyStorePairElement(final GordianFactory pFactory,
                                   final GordianPasswordLockSpec pSpec,
                                   final GordianKeyPair pKeyPair,
                                   final char[] pPassword,
<span class="fc" id="L162">                                   final List&lt;GordianCertificate&gt; pChain) throws GordianException {</span>
            /* Create a securing lock */
<span class="fc" id="L164">            final GordianLockFactory myFactory = pFactory.getLockFactory();</span>
<span class="fc" id="L165">            final GordianKeySetLock myLock = myFactory.newKeySetLock(pSpec, pPassword);</span>
<span class="fc" id="L166">            theSecuringLock = new GordianKeyStoreLockElement(myLock);</span>
<span class="fc" id="L167">            final GordianKeySet myKeySet = myLock.getKeySet();</span>

            /* Secure the privateKey */
<span class="fc" id="L170">            theSecuredKey = securePrivateKey(myKeySet, pKeyPair);</span>

            /* Create the chain */
<span class="fc" id="L173">            theChain = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">            for (GordianCertificate myCert : pChain) {</span>
<span class="fc" id="L175">                theChain.add(new GordianKeyStoreCertificateKey(myCert));</span>
<span class="fc" id="L176">            }</span>
<span class="fc" id="L177">        }</span>

        /**
         * Constructor.
         * @param pSecuredKey the secured privateKey
         * @param pSecuringLock the securing keySetLock.
         * @param pChain the certificate chain.
         * @param pDate the creation date
         */
        GordianKeyStorePairElement(final byte[] pSecuredKey,
                                   final byte[] pSecuringLock,
                                   final List&lt;GordianKeyStoreCertificateKey&gt; pChain,
                                   final LocalDate pDate) {
            /* Store details */
<span class="fc" id="L191">            super(pDate);</span>
<span class="fc" id="L192">            theSecuredKey = pSecuredKey;</span>
<span class="fc" id="L193">            theSecuringLock = new GordianKeyStoreLockElement(pSecuringLock, pDate);</span>
<span class="fc" id="L194">            theChain = new ArrayList&lt;&gt;(pChain);</span>
<span class="fc" id="L195">        }</span>

        /**
         * Obtain the securedKey.
         * @return the securedKey
         */
        byte[] getSecuredKey() {
<span class="fc" id="L202">            return theSecuredKey;</span>
        }

        /**
         * Obtain the securingLock.
         * @return the securingLock
         */
        GordianKeyStoreLockElement getSecuringLock() {
<span class="fc" id="L210">            return theSecuringLock;</span>
        }

        /**
         * Obtain the securingLockBytes.
         * @return the securingLockBytes
         */
        byte[] getSecuringLockBytes() {
<span class="fc" id="L218">            return theSecuringLock.getLock();</span>
        }

        @Override
        public GordianKeyStoreCertificateKey getCertificateKey() {
<span class="fc" id="L223">            return theChain.get(0);</span>
        }

        /**
         * Obtain the certificateChain.
         * @return the certificateChain
         */
        List&lt;GordianKeyStoreCertificateKey&gt; getCertificateChain() {
<span class="fc" id="L231">            return theChain;</span>
        }

        /**
         * Update the chain.
         * @param pChain the new chain.
         */
        void updateChain(final List&lt;GordianCertificate&gt; pChain) {
<span class="fc" id="L239">            theChain.clear();</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">            for (GordianCertificate myCert : pChain) {</span>
<span class="fc" id="L241">                theChain.add(new GordianKeyStoreCertificateKey(myCert));</span>
<span class="fc" id="L242">            }</span>
<span class="fc" id="L243">        }</span>

        /**
         * Obtain the secured privateKey.
         * @param pKeySet the keySet
         * @param pKeyPair the keyPair
         * @return the securedPrivateKey
         * @throws GordianException on error
         */
        byte[] securePrivateKey(final GordianKeySet pKeySet,
                                final GordianKeyPair pKeyPair) throws GordianException {
<span class="fc" id="L254">            return pKeySet.securePrivateKey(pKeyPair);</span>
        }

        /**
         * Build the corresponding certificate chain.
         * @param pKeyStore the keyStore
         * @return the certificate chain
         */
        List&lt;GordianCertificate&gt; buildChain(final GordianBaseKeyStore pKeyStore) {
            /* Create the chain */
<span class="fc" id="L264">            final List&lt;GordianKeyStoreCertificateKey&gt; myKeys = getCertificateChain();</span>
<span class="fc" id="L265">            final List&lt;GordianCertificate&gt; myChain = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">            for (GordianKeyStoreCertificateKey myKey : myKeys) {</span>
<span class="fc" id="L267">                myChain.add(pKeyStore.getCertificate(myKey));</span>
<span class="fc" id="L268">            }</span>
<span class="fc" id="L269">            return myChain;</span>
        }

        /**
         * Build the corresponding keyStoreEntry.
         * @param pKeyStore the keyStore
         * @param pPassword the password
         * @return the keyStorePair entry
         * @throws GordianException on error
         */
        GordianCoreKeyStorePair buildEntry(final GordianBaseKeyStore pKeyStore,
                                           final char[] pPassword) throws GordianException {
            /* Create the chain */
<span class="fc" id="L282">            final List&lt;GordianCertificate&gt; myChain = buildChain(pKeyStore);</span>

            /* Resolve securing lock */
<span class="fc" id="L285">            final GordianKeySetLock myHash = getSecuringLock().buildEntry(pKeyStore, pPassword);</span>

            /* derive the keyPair */
<span class="fc" id="L288">            final GordianKeySet myKeySet = myHash.getKeySet();</span>
<span class="fc" id="L289">            final GordianCoreCertificate myCert = (GordianCoreCertificate) myChain.get(0);</span>
<span class="fc" id="L290">            final GordianKeyPair myPair = myKeySet.deriveKeyPair(myCert.getX509KeySpec(), getSecuredKey());</span>

            /* Create the entry */
<span class="fc" id="L293">            return new GordianCoreKeyStorePair(myPair, myChain, getCreationDate());</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L300">                return true;</span>
            }
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L303">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">            if (!(pThat instanceof GordianKeyStorePairElement)) {</span>
<span class="nc" id="L308">                return false;</span>
            }
<span class="fc" id="L310">            final GordianKeyStorePairElement myThat = (GordianKeyStorePairElement) pThat;</span>

            /* Check that the hashes match */
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">            return Arrays.equals(theSecuredKey, myThat.getSecuredKey())</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(getSecuringLockBytes(), myThat.getSecuringLockBytes())</span>
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">                    &amp;&amp; theChain.equals(myThat.getCertificateChain())</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L321">            return Arrays.hashCode(theSecuredKey)</span>
<span class="nc" id="L322">                    + Arrays.hashCode(getSecuringLockBytes())</span>
<span class="nc" id="L323">                    + theChain.hashCode()</span>
<span class="nc" id="L324">                    + super.hashCode();</span>
        }
    }

    /**
     * KeyStore lock Element.
     */
    class GordianKeyStoreLockElement
            extends GordianCoreKeyStoreEntry {
        /**
         * The hash.
         */
        private final byte[] theLock;

        /**
         * Constructor.
         * @param pLock the lock.
         */
<span class="fc" id="L342">        GordianKeyStoreLockElement(final GordianKeySetLock pLock) {</span>
            /* Store details */
<span class="fc" id="L344">            theLock = pLock.getLockBytes();</span>
<span class="fc" id="L345">        }</span>

        /**
         * Constructor.
         * @param pLock the lock.
         * @param pDate the creation date
         */
        GordianKeyStoreLockElement(final byte[] pLock,
                                   final LocalDate pDate) {
            /* Store details */
<span class="fc" id="L355">            super(pDate);</span>
<span class="fc" id="L356">            theLock = pLock;</span>
<span class="fc" id="L357">        }</span>

        /**
         * Obtain the hash.
         * @return the hash
         */
        byte[] getLock()  {
<span class="fc" id="L364">            return theLock;</span>
        }

        /**
         * Obtain the corresponding keyStoreEntry.
         * @param pKeyStore the keyStore
         * @param pPassword the password
         * @return the keyStore certificate entry
         * @throws GordianException on error
         */
        GordianKeySetLock buildEntry(final GordianBaseKeyStore pKeyStore,
                                     final char[] pPassword) throws GordianException {
            /* Resolve the hash */
<span class="fc" id="L377">            final GordianLockFactory myFactory = pKeyStore.getFactory().getLockFactory();</span>
<span class="fc" id="L378">            return myFactory.resolveKeySetLock(theLock, pPassword);</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="nc bnc" id="L384" title="All 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L385">                return true;</span>
            }
<span class="nc bnc" id="L387" title="All 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L388">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="nc bnc" id="L392" title="All 2 branches missed.">            if (!(pThat instanceof GordianKeyStoreLockElement)) {</span>
<span class="nc" id="L393">                return false;</span>
            }
<span class="nc" id="L395">            final GordianKeyStoreLockElement myThat = (GordianKeyStoreLockElement) pThat;</span>

            /* Check that the hashes match */
<span class="nc bnc" id="L398" title="All 2 branches missed.">            return Arrays.equals(theLock, myThat.getLock())</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L404">            return Arrays.hashCode(theLock)</span>
<span class="nc" id="L405">                    + super.hashCode();</span>
        }
    }

    /**
     * KeyStore key Element.
     * @param &lt;T&gt; the key type
     */
    class GordianKeyStoreKeyElement&lt;T extends GordianKeySpec&gt;
            extends GordianCoreKeyStoreEntry {
        /**
         * The keyType.
         */
        private final T theKeyType;

        /**
         * The securedKey.
         */
        private final byte[] theSecuredKey;

        /**
         * The securing lock.
         */
        private final GordianKeyStoreLockElement theSecuringLock;

        /**
         * Constructor.
         * @param pFactory the factory
         * @param pSpec the passwordLockSpec
         * @param pKey the key
         * @param pPassword the securing password.
         * @throws GordianException on error
         */
        GordianKeyStoreKeyElement(final GordianFactory pFactory,
                                  final GordianPasswordLockSpec pSpec,
                                  final GordianKey&lt;T&gt; pKey,
<span class="fc" id="L441">                                  final char[] pPassword) throws GordianException {</span>
            /* Create a securing lock */
<span class="fc" id="L443">            final GordianLockFactory myFactory = pFactory.getLockFactory();</span>
<span class="fc" id="L444">            final GordianKeySetLock myLock = myFactory.newKeySetLock(pSpec, pPassword);</span>
<span class="fc" id="L445">            final GordianKeySet myKeySet = myLock.getKeySet();</span>

            /* Store details */
<span class="fc" id="L448">            theKeyType = pKey.getKeyType();</span>
<span class="fc" id="L449">            theSecuredKey = myKeySet.secureKey(pKey);</span>
<span class="fc" id="L450">            theSecuringLock = new GordianKeyStoreLockElement(myLock);</span>
<span class="fc" id="L451">        }</span>

        /**
         * Constructor.
         * @param pKeyType the keyType
         * @param pSecuredKey the key
         * @param pSecuringLock the securing lock.
         * @param pDate the creation date
         */
        GordianKeyStoreKeyElement(final T pKeyType,
                                  final byte[] pSecuredKey,
                                  final byte[] pSecuringLock,
                                  final LocalDate pDate) {
            /* Store details */
<span class="fc" id="L465">            super(pDate);</span>
<span class="fc" id="L466">            theKeyType = pKeyType;</span>
<span class="fc" id="L467">            theSecuredKey = pSecuredKey;</span>
<span class="fc" id="L468">            theSecuringLock = new GordianKeyStoreLockElement(pSecuringLock, pDate);</span>
<span class="fc" id="L469">        }</span>

        /**
         * Obtain the keyType.
         * @return the keyType
         */
        T getKeyType() {
<span class="fc" id="L476">            return theKeyType;</span>
        }

        /**
         * Obtain the securedKey.
         * @return the securedKey
         */
        byte[] getSecuredKey() {
<span class="fc" id="L484">            return theSecuredKey;</span>
        }

        /**
         * Obtain the securingLock.
         * @return the securingLock
         */
        GordianKeyStoreLockElement getSecuringLock() {
<span class="nc" id="L492">            return theSecuringLock;</span>
        }

        /**
         * Obtain the securingLockBytes.
         * @return the securingLockBytes
         */
        byte[] getSecuringLockBytes() {
<span class="fc" id="L500">            return theSecuringLock.getLock();</span>
        }

        /**
         * Obtain the corresponding keyStoreEntry.
         * @param pKeyStore the keyStore
         * @param pPassword the password
         * @return the keyStore certificate entry
         * @throws GordianException on error
         */
        GordianCoreKeyStoreKey&lt;T&gt; buildEntry(final GordianBaseKeyStore pKeyStore,
                                             final char[] pPassword) throws GordianException {
            /* Resolve securing lock */
<span class="fc" id="L513">            final GordianKeySetLock myLock = theSecuringLock.buildEntry(pKeyStore, pPassword);</span>

            /* derive the key */
<span class="fc" id="L516">            final GordianKeySet myKeySet = myLock.getKeySet();</span>
<span class="fc" id="L517">            final GordianKey&lt;T&gt; myKey = myKeySet.deriveKey(theSecuredKey, theKeyType);</span>
<span class="fc" id="L518">            return new GordianCoreKeyStoreKey&lt;&gt;(myKey, getCreationDate());</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L525">                return true;</span>
            }
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L528">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">            if (!(pThat instanceof GordianKeyStoreKeyElement)) {</span>
<span class="nc" id="L533">                return false;</span>
            }
<span class="fc" id="L535">            final GordianKeyStoreKeyElement&lt;?&gt; myThat = (GordianKeyStoreKeyElement&lt;?&gt;) pThat;</span>

            /* Check that the hashes match */
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">            return theKeyType.equals(myThat.getKeyType())</span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(theSecuredKey, myThat.getSecuredKey())</span>
<span class="pc bpc" id="L540" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(getSecuringLockBytes(), myThat.getSecuringLockBytes())</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L546">            return theKeyType.hashCode()</span>
<span class="nc" id="L547">                    + Arrays.hashCode(theSecuredKey)</span>
<span class="nc" id="L548">                    + Arrays.hashCode(getSecuringLockBytes())</span>
<span class="nc" id="L549">                    + super.hashCode();</span>
        }
    }

    /**
     * KeyStore keySet Element.
     */
    class GordianKeyStoreSetElement
            extends GordianCoreKeyStoreEntry {
        /**
         * The keyMap.
         */
        private final byte[] theSecuredKeySet;

        /**
         * The securing lock.
         */
        private final GordianKeyStoreLockElement theSecuringLock;

        /**
         * Constructor.
         * @param pFactory the factory
         * @param pSpec the keySetHashSpec
         * @param pKeySet the keySet
         * @param pPassword the securing password.
         * @throws GordianException on error
         */
        GordianKeyStoreSetElement(final GordianFactory pFactory,
                                  final GordianPasswordLockSpec pSpec,
                                  final GordianKeySet pKeySet,
<span class="fc" id="L579">                                  final char[] pPassword) throws GordianException {</span>
            /* Create a securing hash */
<span class="fc" id="L581">            final GordianLockFactory myFactory = pFactory.getLockFactory();</span>
<span class="fc" id="L582">            final GordianKeySetLock myLock = myFactory.newKeySetLock(pSpec, pPassword);</span>
<span class="fc" id="L583">            final GordianKeySet myKeySet = myLock.getKeySet();</span>
<span class="fc" id="L584">            theSecuringLock = new GordianKeyStoreLockElement(myLock);</span>

            /* Secure the keySet */
<span class="fc" id="L587">            theSecuredKeySet = myKeySet.secureKeySet(pKeySet);</span>
<span class="fc" id="L588">       }</span>

        /**
         * Constructor.
         * @param pSecuredKeySet the securedKeySet
         * @param pSecuringLock the securing lock.
         * @param pDate the creation date
         */
        GordianKeyStoreSetElement(final byte[] pSecuredKeySet,
                                  final byte[] pSecuringLock,
                                  final LocalDate pDate) {
            /* Store details */
<span class="fc" id="L600">            super(pDate);</span>
<span class="fc" id="L601">            theSecuredKeySet = pSecuredKeySet;</span>
<span class="fc" id="L602">            theSecuringLock = new GordianKeyStoreLockElement(pSecuringLock, pDate);</span>
<span class="fc" id="L603">        }</span>

        /**
         * Obtain the keyType.
         * @return the keyType
         */
        byte[] getSecuredKeySet() {
<span class="fc" id="L610">            return theSecuredKeySet;</span>
        }

        /**
         * Obtain the securingLock.
         * @return the securingLock
         */
        GordianKeyStoreLockElement getSecuringLock() {
<span class="nc" id="L618">            return theSecuringLock;</span>
        }

        /**
         * Obtain the securingLockBytes.
         * @return the securingLockBytes
         */
        byte[] getSecuringLockBytes() {
<span class="fc" id="L626">            return theSecuringLock.getLock();</span>
        }

        /**
         * Obtain the corresponding keyStoreEntry.
         * @param pKeyStore the keyStore
         * @param pPassword the password
         * @return the keyStore certificate entry
         * @throws GordianException on error
         */
        GordianCoreKeyStoreSet buildEntry(final GordianBaseKeyStore pKeyStore,
                                          final char[] pPassword) throws GordianException {
            /* Resolve the lock */
<span class="fc" id="L639">            final GordianKeySetLock myLock = theSecuringLock.buildEntry(pKeyStore, pPassword);</span>
<span class="fc" id="L640">            final GordianKeySet mySecuringKeySet = myLock.getKeySet();</span>

            /* Derive the keySet */
<span class="fc" id="L643">            final GordianKeySet myKeySet = mySecuringKeySet.deriveKeySet(theSecuredKeySet);</span>

            /* build the new entry */
<span class="fc" id="L646">            return new GordianCoreKeyStoreSet(myKeySet, getCreationDate());</span>
        }

        @Override
        public boolean equals(final Object pThat) {
            /* Handle the trivial case */
<span class="pc bpc" id="L652" title="1 of 2 branches missed.">            if (pThat == this) {</span>
<span class="nc" id="L653">                return true;</span>
            }
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">            if (pThat == null) {</span>
<span class="nc" id="L656">                return false;</span>
            }

            /* Ensure object is correct class */
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">            if (!(pThat instanceof GordianKeyStoreSetElement)) {</span>
<span class="nc" id="L661">                return false;</span>
            }
<span class="fc" id="L663">            final GordianKeyStoreSetElement myThat = (GordianKeyStoreSetElement) pThat;</span>

            /* Check that the hashes match */
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">            return Arrays.equals(theSecuredKeySet, myThat.getSecuredKeySet())</span>
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(getSecuringLockBytes(), myThat.getSecuringLockBytes())</span>
<span class="pc bpc" id="L668" title="1 of 2 branches missed.">                    &amp;&amp; super.equals(pThat);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L673">            return Arrays.hashCode(theSecuredKeySet)</span>
<span class="nc" id="L674">                    + Arrays.hashCode(getSecuringLockBytes())</span>
<span class="nc" id="L675">                    + super.hashCode();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>