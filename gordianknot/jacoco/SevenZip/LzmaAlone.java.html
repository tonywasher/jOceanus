<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LzmaAlone.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">SevenZip</a> &gt; <span class="el_source">LzmaAlone.java</span></div><h1>LzmaAlone.java</h1><pre class="source lang-java linenums">package SevenZip;

<span class="nc" id="L3">public class LzmaAlone</span>
{
<span class="nc" id="L5">	static public class CommandLine</span>
	{
		public static final int kEncode = 0;
		public static final int kDecode = 1;
		public static final int kBenchmak = 2;
		
<span class="nc" id="L11">		public int Command = -1;</span>
<span class="nc" id="L12">		public int NumBenchmarkPasses = 10;</span>
		
<span class="nc" id="L14">		public int DictionarySize = 1 &lt;&lt; 23;</span>
<span class="nc" id="L15">		public boolean DictionarySizeIsDefined = false;</span>
		
<span class="nc" id="L17">		public int Lc = 3;</span>
<span class="nc" id="L18">		public int Lp = 0;</span>
<span class="nc" id="L19">		public int Pb = 2;</span>
		
<span class="nc" id="L21">		public int Fb = 128;</span>
<span class="nc" id="L22">		public boolean FbIsDefined = false;</span>
		
<span class="nc" id="L24">		public boolean Eos = false;</span>
		
<span class="nc" id="L26">		public int Algorithm = 2;</span>
<span class="nc" id="L27">		public int MatchFinder = 1;</span>
		
		public String InFile;
		public String OutFile;
		
		boolean ParseSwitch(String s)
		{
<span class="nc bnc" id="L34" title="All 2 branches missed.">			if (s.startsWith(&quot;d&quot;))</span>
			{
<span class="nc" id="L36">				DictionarySize = 1 &lt;&lt; Integer.parseInt(s.substring(1));</span>
<span class="nc" id="L37">				DictionarySizeIsDefined = true;</span>
			}
<span class="nc bnc" id="L39" title="All 2 branches missed.">			else if (s.startsWith(&quot;fb&quot;))</span>
			{
<span class="nc" id="L41">				Fb = Integer.parseInt(s.substring(2));</span>
<span class="nc" id="L42">				FbIsDefined = true;</span>
			}
<span class="nc bnc" id="L44" title="All 2 branches missed.">			else if (s.startsWith(&quot;a&quot;))</span>
<span class="nc" id="L45">				Algorithm = Integer.parseInt(s.substring(1));</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">			else if (s.startsWith(&quot;lc&quot;))</span>
<span class="nc" id="L47">				Lc = Integer.parseInt(s.substring(2));</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">			else if (s.startsWith(&quot;lp&quot;))</span>
<span class="nc" id="L49">				Lp = Integer.parseInt(s.substring(2));</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">			else if (s.startsWith(&quot;pb&quot;))</span>
<span class="nc" id="L51">				Pb = Integer.parseInt(s.substring(2));</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">			else if (s.startsWith(&quot;eos&quot;))</span>
<span class="nc" id="L53">				Eos = true;</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">			else if (s.startsWith(&quot;mf&quot;))</span>
			{
<span class="nc" id="L56">				String mfs = s.substring(2);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">				if (mfs.equals(&quot;bt2&quot;))</span>
<span class="nc" id="L58">					MatchFinder = 0;</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">				else if (mfs.equals(&quot;bt4&quot;))</span>
<span class="nc" id="L60">					MatchFinder = 1;</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">				else if (mfs.equals(&quot;bt4b&quot;))</span>
<span class="nc" id="L62">					MatchFinder = 2;</span>
				else
<span class="nc" id="L64">					return false;</span>
<span class="nc" id="L65">			}</span>
			else
<span class="nc" id="L67">				return false;</span>
<span class="nc" id="L68">			return true;</span>
		}
		
		public boolean Parse(String[] args) throws Exception
		{
<span class="nc" id="L73">			int pos = 0;</span>
<span class="nc" id="L74">			boolean switchMode = true;</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">			for (int i = 0; i &lt; args.length; i++)</span>
			{
<span class="nc" id="L77">				String s = args[i];</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">				if (s.length() == 0)</span>
<span class="nc" id="L79">					return false;</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">				if (switchMode)</span>
				{
<span class="nc bnc" id="L82" title="All 2 branches missed.">					if (s.compareTo(&quot;--&quot;) == 0)</span>
					{
<span class="nc" id="L84">						switchMode = false;</span>
<span class="nc" id="L85">						continue;</span>
					}
<span class="nc bnc" id="L87" title="All 2 branches missed.">					if (s.charAt(0) == '-')</span>
					{
<span class="nc" id="L89">						String sw = s.substring(1).toLowerCase();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">						if (sw.length() == 0)</span>
<span class="nc" id="L91">							return false;</span>
						try
						{
<span class="nc bnc" id="L94" title="All 2 branches missed.">							if (!ParseSwitch(sw))</span>
<span class="nc" id="L95">								return false;</span>
						}
<span class="nc" id="L97">						catch (NumberFormatException e)</span>
						{
<span class="nc" id="L99">							return false;</span>
<span class="nc" id="L100">						}</span>
						continue;
					}
				}
<span class="nc bnc" id="L104" title="All 2 branches missed.">				if (pos == 0)</span>
				{
<span class="nc bnc" id="L106" title="All 2 branches missed.">					if (s.equalsIgnoreCase(&quot;e&quot;))</span>
<span class="nc" id="L107">						Command = kEncode;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">					else if (s.equalsIgnoreCase(&quot;d&quot;))</span>
<span class="nc" id="L109">						Command = kDecode;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">					else if (s.equalsIgnoreCase(&quot;b&quot;))</span>
<span class="nc" id="L111">						Command = kBenchmak;</span>
					else
<span class="nc" id="L113">						return false;</span>
				}
<span class="nc bnc" id="L115" title="All 2 branches missed.">				else if(pos == 1)</span>
				{
<span class="nc bnc" id="L117" title="All 2 branches missed.">					if (Command == kBenchmak)</span>
					{
						try
						{
<span class="nc" id="L121">							NumBenchmarkPasses = Integer.parseInt(s);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">							if (NumBenchmarkPasses &lt; 1)</span>
<span class="nc" id="L123">								return false;</span>
						}
<span class="nc" id="L125">						catch (NumberFormatException e)</span>
						{
<span class="nc" id="L127">							return false;</span>
<span class="nc" id="L128">						}</span>
					}
					else
<span class="nc" id="L131">						InFile = s;</span>
				}
<span class="nc bnc" id="L133" title="All 2 branches missed.">				else if(pos == 2)</span>
<span class="nc" id="L134">					OutFile = s;</span>
				else
<span class="nc" id="L136">					return false;</span>
<span class="nc" id="L137">				pos++;</span>
<span class="nc" id="L138">				continue;</span>
			}
<span class="nc" id="L140">			return true;</span>
		}
	}
	
	
	static void PrintHelp()
	{
<span class="nc" id="L147">		System.out.println(</span>
				&quot;\nUsage:  LZMA &lt;e|d&gt; [&lt;switches&gt;...] inputFile outputFile\n&quot; +
				&quot;  e: encode file\n&quot; +
				&quot;  d: decode file\n&quot; +
				&quot;  b: Benchmark\n&quot; +
				&quot;&lt;Switches&gt;\n&quot; +
				// &quot;  -a{N}:  set compression mode - [0, 1], default: 1 (max)\n&quot; +
				&quot;  -d{N}:  set dictionary - [0,28], default: 23 (8MB)\n&quot; +
				&quot;  -fb{N}: set number of fast bytes - [5, 273], default: 128\n&quot; +
				&quot;  -lc{N}: set number of literal context bits - [0, 8], default: 3\n&quot; +
				&quot;  -lp{N}: set number of literal pos bits - [0, 4], default: 0\n&quot; +
				&quot;  -pb{N}: set number of pos bits - [0, 4], default: 2\n&quot; +
				&quot;  -mf{MF_ID}: set Match Finder: [bt2, bt4], default: bt4\n&quot; +
				&quot;  -eos:   write End Of Stream marker\n&quot;
				);
<span class="nc" id="L162">	}</span>
	
	public static void main(String[] args) throws Exception
	{
<span class="nc" id="L166">		System.out.println(&quot;\nLZMA (Java) 4.61  2008-11-23\n&quot;);</span>
		
<span class="nc bnc" id="L168" title="All 2 branches missed.">		if (args.length &lt; 1)</span>
		{
<span class="nc" id="L170">			PrintHelp();</span>
<span class="nc" id="L171">			return;</span>
		}
		
<span class="nc" id="L174">		CommandLine params = new CommandLine();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">		if (!params.Parse(args))</span>
		{
<span class="nc" id="L177">			System.out.println(&quot;\nIncorrect command&quot;);</span>
<span class="nc" id="L178">			return;</span>
		}
		
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if (params.Command == CommandLine.kBenchmak)</span>
		{
<span class="nc" id="L183">			int dictionary = (1 &lt;&lt; 21);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">			if (params.DictionarySizeIsDefined)</span>
<span class="nc" id="L185">				dictionary = params.DictionarySize;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">			if (params.MatchFinder &gt; 1)</span>
<span class="nc" id="L187">				throw new Exception(&quot;Unsupported match finder&quot;);</span>
<span class="nc" id="L188">			SevenZip.LzmaBench.LzmaBenchmark(params.NumBenchmarkPasses, dictionary);</span>
<span class="nc" id="L189">		}</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">		else if (params.Command == CommandLine.kEncode || params.Command == CommandLine.kDecode)</span>
		{
<span class="nc" id="L192">			java.io.File inFile = new java.io.File(params.InFile);</span>
<span class="nc" id="L193">			java.io.File outFile = new java.io.File(params.OutFile);</span>
			
<span class="nc" id="L195">			java.io.BufferedInputStream inStream  = new java.io.BufferedInputStream(new java.io.FileInputStream(inFile));</span>
<span class="nc" id="L196">			java.io.BufferedOutputStream outStream = new java.io.BufferedOutputStream(new java.io.FileOutputStream(outFile));</span>
			
<span class="nc" id="L198">			boolean eos = false;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">			if (params.Eos)</span>
<span class="nc" id="L200">				eos = true;</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if (params.Command == CommandLine.kEncode)</span>
			{
<span class="nc" id="L203">				SevenZip.Compression.LZMA.Encoder encoder = new SevenZip.Compression.LZMA.Encoder();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">				if (!encoder.SetAlgorithm(params.Algorithm))</span>
<span class="nc" id="L205">					throw new Exception(&quot;Incorrect compression mode&quot;);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">				if (!encoder.SetDictionarySize(params.DictionarySize))</span>
<span class="nc" id="L207">					throw new Exception(&quot;Incorrect dictionary size&quot;);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">				if (!encoder.SetNumFastBytes(params.Fb))</span>
<span class="nc" id="L209">					throw new Exception(&quot;Incorrect -fb value&quot;);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">				if (!encoder.SetMatchFinder(params.MatchFinder))</span>
<span class="nc" id="L211">					throw new Exception(&quot;Incorrect -mf value&quot;);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">				if (!encoder.SetLcLpPb(params.Lc, params.Lp, params.Pb))</span>
<span class="nc" id="L213">					throw new Exception(&quot;Incorrect -lc or -lp or -pb value&quot;);</span>
<span class="nc" id="L214">				encoder.SetEndMarkerMode(eos);</span>
<span class="nc" id="L215">				encoder.WriteCoderProperties(outStream);</span>
				long fileSize;
<span class="nc bnc" id="L217" title="All 2 branches missed.">				if (eos)</span>
<span class="nc" id="L218">					fileSize = -1;</span>
				else
<span class="nc" id="L220">					fileSize = inFile.length();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">				for (int i = 0; i &lt; 8; i++)</span>
<span class="nc" id="L222">					outStream.write((int)(fileSize &gt;&gt;&gt; (8 * i)) &amp; 0xFF);</span>
<span class="nc" id="L223">				encoder.Code(inStream, outStream, -1, -1, null);</span>
<span class="nc" id="L224">			}</span>
			else
			{
<span class="nc" id="L227">				int propertiesSize = 5;</span>
<span class="nc" id="L228">				byte[] properties = new byte[propertiesSize];</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">				if (inStream.read(properties, 0, propertiesSize) != propertiesSize)</span>
<span class="nc" id="L230">					throw new Exception(&quot;input .lzma file is too short&quot;);</span>
<span class="nc" id="L231">				SevenZip.Compression.LZMA.Decoder decoder = new SevenZip.Compression.LZMA.Decoder();</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">				if (!decoder.SetDecoderProperties(properties))</span>
<span class="nc" id="L233">					throw new Exception(&quot;Incorrect stream properties&quot;);</span>
<span class="nc" id="L234">				long outSize = 0;</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">				for (int i = 0; i &lt; 8; i++)</span>
				{
<span class="nc" id="L237">					int v = inStream.read();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">					if (v &lt; 0)</span>
<span class="nc" id="L239">						throw new Exception(&quot;Can't read stream size&quot;);</span>
<span class="nc" id="L240">					outSize |= ((long)v) &lt;&lt; (8 * i);</span>
				}
<span class="nc bnc" id="L242" title="All 2 branches missed.">				if (!decoder.Code(inStream, outStream, outSize))</span>
<span class="nc" id="L243">					throw new Exception(&quot;Error in data stream&quot;);</span>
			}
<span class="nc" id="L245">			outStream.flush();</span>
<span class="nc" id="L246">			outStream.close();</span>
<span class="nc" id="L247">			inStream.close();</span>
<span class="nc" id="L248">		}</span>
		else
<span class="nc" id="L250">			throw new Exception(&quot;Incorrect command&quot;);</span>
<span class="nc" id="L251">		return;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>