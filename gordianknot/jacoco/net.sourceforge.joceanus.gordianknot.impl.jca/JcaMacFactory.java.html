<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JcaMacFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.jca</a> &gt; <span class="el_source">JcaMacFactory.java</span></div><h1>JcaMacFactory.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.jca;

import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.base.GordianKeySpec;
import net.sourceforge.joceanus.gordianknot.api.base.GordianLength;
import net.sourceforge.joceanus.gordianknot.api.cipher.GordianSymKeySpec;
import net.sourceforge.joceanus.gordianknot.api.cipher.GordianSymKeyType;
import net.sourceforge.joceanus.gordianknot.api.digest.GordianDigestSpec;
import net.sourceforge.joceanus.gordianknot.api.key.GordianKeyGenerator;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacSpec;
import net.sourceforge.joceanus.gordianknot.api.mac.GordianMacType;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseData;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianCryptoException;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianDataException;
import net.sourceforge.joceanus.gordianknot.impl.core.mac.GordianCoreMacFactory;

import javax.crypto.KeyGenerator;
import javax.crypto.Mac;
import java.security.NoSuchAlgorithmException;
import java.util.HashMap;
import java.util.Map;

/**
 * Jca Cipher Factory.
 */
public class JcaMacFactory
    extends GordianCoreMacFactory {
    /**
     * CMAC algorithm name.
     */
    private static final String CMAC_ALGORITHM = &quot;CMAC&quot;;

    /**
     * GOST algorithm name.
     */
    private static final String GOST_ALGORITHM = &quot;GOST28147&quot;;

    /**
     * ZUC-128 algorithm name.
     */
    private static final String ZUC256_ALGORITHM = &quot;ZUC-256&quot;;

    /**
     * KeyGenerator Cache.
     */
    private final Map&lt;GordianKeySpec, JcaKeyGenerator&lt;? extends GordianKeySpec&gt;&gt; theCache;

    /**
     * Constructor.
     *
     * @param pFactory the factory
     */
    JcaMacFactory(final GordianBaseFactory pFactory) {
        /* Initialise underlying class */
<span class="fc" id="L72">        super(pFactory);</span>

        /* Create the cache */
<span class="fc" id="L75">        theCache = new HashMap&lt;&gt;();</span>
<span class="fc" id="L76">    }</span>

    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T extends GordianKeySpec&gt; GordianKeyGenerator&lt;T&gt; getKeyGenerator(final T pMacSpec) throws GordianException {
        /* Look up in the cache */
<span class="fc" id="L82">        JcaKeyGenerator&lt;T&gt; myGenerator = (JcaKeyGenerator&lt;T&gt;) theCache.get(pMacSpec);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (myGenerator == null) {</span>
            /* Check validity of MacSpec */
<span class="fc" id="L85">            checkMacSpec(pMacSpec);</span>

            /* Create the new generator */
<span class="fc" id="L88">            final String myAlgorithm = getMacSpecAlgorithm((GordianMacSpec) pMacSpec);</span>
<span class="fc" id="L89">            final KeyGenerator myJavaGenerator = getJavaKeyGenerator(myAlgorithm);</span>
<span class="fc" id="L90">            myGenerator = new JcaKeyGenerator&lt;&gt;(getFactory(), pMacSpec, myJavaGenerator);</span>

            /* Add to cache */
<span class="fc" id="L93">            theCache.put(pMacSpec, myGenerator);</span>
        }
<span class="fc" id="L95">        return myGenerator;</span>
    }

    @Override
    public JcaMac createMac(final GordianMacSpec pMacSpec) throws GordianException {
        /* Check validity of MacSpec */
<span class="fc" id="L101">        checkMacSpec(pMacSpec);</span>

        /* Create Mac */
<span class="fc" id="L104">        final Mac myJavaMac = getJavaMac(pMacSpec);</span>
<span class="fc" id="L105">        return new JcaMac(getFactory(), pMacSpec, myJavaMac);</span>
    }

    @Override
    protected boolean validMacType(final GordianMacType pMacType) {
<span class="fc bfc" id="L110" title="All 2 branches covered.">        switch (pMacType) {</span>
            case BLAKE2:
            case BLAKE3:
            case KALYNA:
            case CBCMAC:
            case CFBMAC:
<span class="fc" id="L116">                return false;</span>
            default:
<span class="fc" id="L118">                return super.validMacType(pMacType);</span>
        }
    }

    /**
     * Create the BouncyCastle MAC via JCA.
     * @param pMacSpec the MacSpec
     * @return the MAC
     * @throws GordianException on error
     */
    private Mac getJavaMac(final GordianMacSpec pMacSpec) throws GordianException {
<span class="pc bpc" id="L129" title="1 of 3 branches missed.">        switch (pMacSpec.getMacType()) {</span>
            case HMAC:
            case GMAC:
            case CMAC:
            case POLY1305:
            case SKEIN:
            case KUPYNA:
            case SIPHASH:
            case GOST:
            case ZUC:
            case KMAC:
<span class="fc" id="L140">                return getJavaMac(getMacSpecAlgorithm(pMacSpec));</span>
            case VMPC:
<span class="fc" id="L142">                return getJavaMac(&quot;VMPC-MAC&quot;);</span>
            default:
<span class="nc" id="L144">                throw new GordianDataException(GordianBaseData.getInvalidText(pMacSpec));</span>
        }
    }

    /**
     * Create the BouncyCastle MAC via JCA.
     * @param pAlgorithm the Algorithm
     * @return the MAC
     * @throws GordianException on error
     */
    private static Mac getJavaMac(final String pAlgorithm) throws GordianException {
        /* Protect against exceptions */
        try {
            /* Return a MAC for the algorithm */
<span class="fc" id="L158">            return Mac.getInstance(pAlgorithm, JcaProvider.BCPROV);</span>

            /* Catch exceptions */
<span class="nc" id="L161">        } catch (NoSuchAlgorithmException e) {</span>
            /* Throw the exception */
<span class="nc" id="L163">            throw new GordianCryptoException(&quot;Failed to create Mac&quot;, e);</span>
        }
    }

    /**
     * Create the BouncyCastle KeyGenerator via JCA.
     * @param pAlgorithm the Algorithm
     * @return the KeyGenerator
     * @throws GordianException on error
     */
    private static KeyGenerator getJavaKeyGenerator(final String pAlgorithm) throws GordianException {
        /* Protect against exceptions */
        try {
            /* Massage the keyGenerator name */
<span class="fc" id="L177">            String myAlgorithm = pAlgorithm;</span>

            /* CMAC generators use the symKeyGenerator */
<span class="fc bfc" id="L180" title="All 2 branches covered.">            if (myAlgorithm.endsWith(CMAC_ALGORITHM)) {</span>
<span class="fc" id="L181">                myAlgorithm = myAlgorithm.substring(0, myAlgorithm.length() - CMAC_ALGORITHM.length());</span>
            }

            /* GOST generators use the GOST28147 key generator */
<span class="fc bfc" id="L185" title="All 2 branches covered.">            if (myAlgorithm.startsWith(GOST_ALGORITHM)) {</span>
<span class="fc" id="L186">                myAlgorithm = GOST_ALGORITHM;</span>
            }

            /* ZUC-256 generators use the ZUC-256 key generator */
<span class="fc bfc" id="L190" title="All 2 branches covered.">            if (myAlgorithm.startsWith(ZUC256_ALGORITHM)) {</span>
<span class="fc" id="L191">                myAlgorithm = ZUC256_ALGORITHM;</span>
            }

            /* Return a KeyGenerator for the algorithm */
<span class="fc" id="L195">            return KeyGenerator.getInstance(myAlgorithm, JcaProvider.BCPROV);</span>

            /* Catch exceptions */
<span class="nc" id="L198">        } catch (NoSuchAlgorithmException e) {</span>
            /* Throw the exception */
<span class="nc" id="L200">            throw new GordianCryptoException(&quot;Failed to create KeyGenerator&quot;, e);</span>
        }
    }

    /**
     * Obtain the MacSpec Key algorithm.
     * @param pMacSpec the MacSpec
     * @return the Algorithm
     * @throws GordianException on error
     */
    private static String getMacSpecAlgorithm(final GordianMacSpec pMacSpec) throws GordianException {
<span class="pc bpc" id="L211" title="1 of 12 branches missed.">        switch (pMacSpec.getMacType()) {</span>
            case HMAC:
<span class="fc" id="L213">                return getHMacAlgorithm(pMacSpec.getDigestSpec());</span>
            case GMAC:
<span class="fc" id="L215">                return getGMacAlgorithm(pMacSpec.getSymKeySpec());</span>
            case CMAC:
<span class="fc" id="L217">                return getCMacAlgorithm(pMacSpec.getSymKeySpec());</span>
            case POLY1305:
<span class="fc" id="L219">                return getPoly1305Algorithm(pMacSpec.getSymKeySpec());</span>
            case SKEIN:
<span class="fc" id="L221">                return getSkeinMacAlgorithm(pMacSpec.getDigestSpec());</span>
            case KUPYNA:
<span class="fc" id="L223">                return getKupynaMacAlgorithm(pMacSpec.getDigestSpec());</span>
            case ZUC:
<span class="fc" id="L225">                return getZucMacAlgorithm(pMacSpec);</span>
            case SIPHASH:
<span class="fc" id="L227">                return pMacSpec.toString();</span>
            case KMAC:
<span class="fc" id="L229">                return pMacSpec.getMacType().toString() + pMacSpec.getDigestSpec().getDigestState();</span>
            case GOST:
<span class="fc" id="L231">                return &quot;GOST28147MAC&quot;;</span>
            case VMPC:
<span class="fc" id="L233">                return &quot;VMPC-KSA3&quot;;</span>
            default:
<span class="nc" id="L235">                throw new GordianDataException(GordianBaseData.getInvalidText(pMacSpec));</span>
        }
    }

    /**
     * Return the associated HMac algorithm.
     * @param pDigestSpec the digestSpec
     * @return the algorithm
     * @throws GordianException on error
     */
    private static String getHMacAlgorithm(final GordianDigestSpec pDigestSpec) throws GordianException {
<span class="fc" id="L246">        return &quot;HMac&quot; + JcaDigest.getHMacAlgorithm(pDigestSpec);</span>
    }

    /**
     * Obtain the GMAC algorithm.
     * @param pKeySpec the symmetric keySpec
     * @return the algorithm
     * @throws GordianException on error
     */
    private static String getGMacAlgorithm(final GordianSymKeySpec pKeySpec) throws GordianException {
        /* Return algorithm name */
<span class="fc" id="L257">        return JcaCipherFactory.getSymKeyAlgorithm(pKeySpec) + &quot;GMAC&quot;;</span>
    }

    /**
     * Obtain the GMAC algorithm.
     * @param pKeySpec the symmetric keySpec
     * @return the algorithm
     * @throws GordianException on error
     */
    private static String getCMacAlgorithm(final GordianSymKeySpec pKeySpec) throws GordianException {
        /* Return algorithm name */
<span class="fc" id="L268">        return JcaCipherFactory.getSymKeyAlgorithm(pKeySpec) + CMAC_ALGORITHM;</span>
    }

    /**
     * Obtain the Poly1305 algorithm.
     * @param pKeySpec the symmetric keySpec
     * @return the algorithm
     * @throws GordianException on error
     */
    private static String getPoly1305Algorithm(final GordianSymKeySpec pKeySpec) throws GordianException {
        /* Return algorithm name */
<span class="fc bfc" id="L279" title="All 2 branches covered.">        return pKeySpec == null</span>
<span class="fc" id="L280">               ? &quot;POLY1305&quot;</span>
<span class="fc" id="L281">               : &quot;POLY1305-&quot; + JcaCipherFactory.getSymKeyAlgorithm(pKeySpec);</span>
    }

    /**
     * Obtain the Skein MAC algorithm.
     * @param pSpec the digestSpec
     * @return the algorithm
     */
    private static String getSkeinMacAlgorithm(final GordianDigestSpec pSpec) {
<span class="fc" id="L290">        return &quot;Skein-MAC-&quot;</span>
<span class="fc" id="L291">                + pSpec.getDigestState()</span>
                + '-'
<span class="fc" id="L293">                + pSpec.getDigestLength();</span>
    }

    /**
     * Obtain the Skein MAC algorithm.
     * @param pSpec the digestSpec
     * @return the algorithm
     */
    private static String getZucMacAlgorithm(final GordianMacSpec pSpec) {
<span class="fc" id="L302">        final String myKeyLen = Integer.toString(pSpec.getKeyLength().getLength());</span>
<span class="fc" id="L303">        final String myMacLen = Integer.toString(pSpec.getMacLength().getLength());</span>
<span class="fc" id="L304">        final StringBuilder myBuilder = new StringBuilder();</span>
<span class="fc" id="L305">        myBuilder.append(&quot;ZUC-&quot;)</span>
<span class="fc" id="L306">                .append(myKeyLen);</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">        if (GordianLength.LEN_256 == pSpec.getKeyLength()) {</span>
<span class="fc" id="L308">                myBuilder.append('-')</span>
<span class="fc" id="L309">                        .append(myMacLen);</span>
        }
<span class="fc" id="L311">        return myBuilder.toString();</span>
    }

    /**
     * Obtain the Kupyna MAC algorithm.
     * @param pSpec the digestSpec
     * @return the algorithm
     * @throws GordianException on error
     */
    private static String getKupynaMacAlgorithm(final GordianDigestSpec pSpec) throws GordianException {
        /* For some reason this is accessed as HMAC !!! */
<span class="fc" id="L322">        return getHMacAlgorithm(pSpec);</span>
    }

    @Override
    protected boolean validCMacSymKeySpec(final GordianSymKeySpec pKeySpec) {
<span class="fc bfc" id="L327" title="All 2 branches covered.">        switch (pKeySpec.getSymKeyType()) {</span>
            case AES:
            case DESEDE:
            case BLOWFISH:
            case SHACAL2:
            case THREEFISH:
            case SEED:
            case SM4:
<span class="fc" id="L335">                return super.validCMacSymKeySpec(pKeySpec);</span>
            default:
<span class="fc" id="L337">                return false;</span>
        }
    }

    @Override
    protected boolean validGMacSymKeySpec(final GordianSymKeySpec pKeySpec) {
<span class="fc bfc" id="L343" title="All 2 branches covered.">        switch (pKeySpec.getSymKeyType()) {</span>
            case KUZNYECHIK:
            case KALYNA:
<span class="fc" id="L346">                return false;</span>
            default:
<span class="fc" id="L348">                return super.validGMacSymKeySpec(pKeySpec);</span>
        }
    }

    @Override
    protected boolean validPoly1305SymKeySpec(final GordianSymKeySpec pKeySpec) {
<span class="fc bfc" id="L354" title="All 2 branches covered.">        if (GordianSymKeyType.KALYNA.equals(pKeySpec.getSymKeyType())) {</span>
<span class="fc" id="L355">            return false;</span>
        }
<span class="fc" id="L357">        return super.validPoly1305SymKeySpec(pKeySpec);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>