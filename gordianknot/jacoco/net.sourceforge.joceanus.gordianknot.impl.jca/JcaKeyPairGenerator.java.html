<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JcaKeyPairGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GordianKnot Security Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.gordianknot.impl.jca</a> &gt; <span class="el_source">JcaKeyPairGenerator.java</span></div><h1>JcaKeyPairGenerator.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * GordianKnot: Security Suite
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.gordianknot.impl.jca;

import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianDHGroup;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianDSAKeyType;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPair;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianKeyPairSpec;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianLMSKeySpec;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianLMSKeySpec.GordianHSSKeySpec;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianRSAModulus;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianXMSSKeySpec;
import net.sourceforge.joceanus.gordianknot.api.keypair.GordianXMSSKeySpec.GordianXMSSDigestType;
import net.sourceforge.joceanus.gordianknot.impl.core.base.GordianBaseFactory;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianCryptoException;
import net.sourceforge.joceanus.gordianknot.impl.core.exc.GordianLogicException;
import net.sourceforge.joceanus.gordianknot.impl.core.keypair.GordianCoreKeyPairGenerator;
import net.sourceforge.joceanus.gordianknot.impl.core.keypair.GordianKeyPairValidity;
import net.sourceforge.joceanus.gordianknot.impl.jca.JcaKeyPair.JcaDHPrivateKey;
import net.sourceforge.joceanus.gordianknot.impl.jca.JcaKeyPair.JcaDHPublicKey;
import net.sourceforge.joceanus.gordianknot.impl.jca.JcaKeyPair.JcaPrivateKey;
import net.sourceforge.joceanus.gordianknot.impl.jca.JcaKeyPair.JcaPublicKey;
import net.sourceforge.joceanus.gordianknot.impl.jca.JcaKeyPair.JcaStateAwareKeyPair;
import net.sourceforge.joceanus.gordianknot.impl.jca.JcaKeyPair.JcaStateAwarePrivateKey;
import org.bouncycastle.crypto.params.DHParameters;
import org.bouncycastle.jcajce.provider.asymmetric.dh.BCDHPrivateKey;
import org.bouncycastle.jcajce.provider.asymmetric.dh.BCDHPublicKey;
import org.bouncycastle.jcajce.spec.DHDomainParameterSpec;
import org.bouncycastle.jcajce.spec.EdDSAParameterSpec;
import org.bouncycastle.jcajce.spec.MLDSAParameterSpec;
import org.bouncycastle.jcajce.spec.MLKEMParameterSpec;
import org.bouncycastle.jcajce.spec.SLHDSAParameterSpec;
import org.bouncycastle.jcajce.spec.XDHParameterSpec;
import org.bouncycastle.jce.spec.ElGamalParameterSpec;
import org.bouncycastle.pqc.crypto.lms.LMSParameters;
import org.bouncycastle.pqc.jcajce.spec.BIKEParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.CMCEParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.FalconParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.FrodoParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.HQCParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.LMSHSSKeyGenParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.LMSKeyGenParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.MayoParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.NTRULPRimeParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.NTRUParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.PicnicParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.SABERParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.SNTRUPrimeParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.SnovaParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.XMSSMTParameterSpec;
import org.bouncycastle.pqc.jcajce.spec.XMSSParameterSpec;

import java.security.InvalidAlgorithmParameterException;
import java.security.KeyFactory;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.NoSuchAlgorithmException;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.spec.AlgorithmParameterSpec;
import java.security.spec.ECGenParameterSpec;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.PKCS8EncodedKeySpec;
import java.security.spec.X509EncodedKeySpec;
import java.util.Arrays;

/**
 * Jca KeyPair generator.
 */
public abstract class JcaKeyPairGenerator
        extends GordianCoreKeyPairGenerator {
    /**
     * Parse error.
     */
    private static final String PARSE_ERROR = &quot;Failed to parse encoding&quot;;

    /**
     * Factory.
     */
    private KeyFactory theFactory;

    /**
     * Constructor.
     * @param pFactory the Security Factory
     * @param pKeySpec the keySpec
     */
    JcaKeyPairGenerator(final GordianBaseFactory pFactory,
                        final GordianKeyPairSpec pKeySpec) {
<span class="fc" id="L104">        super(pFactory, pKeySpec);</span>
<span class="fc" id="L105">    }</span>

    /**
     * Obtain Set the key factory.
     * @return the keyFactory
     */
    KeyFactory getKeyFactory() {
<span class="fc" id="L112">        return theFactory;</span>
    }

    /**
     * Set the key factory.
     * @param pFactory the keyFactory
     */
    void setKeyFactory(final KeyFactory pFactory) {
<span class="fc" id="L120">        theFactory = pFactory;</span>
<span class="fc" id="L121">    }</span>

    @Override
    public PKCS8EncodedKeySpec getPKCS8Encoding(final GordianKeyPair pKeyPair) throws GordianException {
        /* Check the keyPair */
<span class="fc" id="L126">        JcaKeyPair.checkKeyPair(pKeyPair);</span>

        /* derive the encoding */
<span class="fc" id="L129">        final JcaPrivateKey myPrivateKey = (JcaPrivateKey) getPrivateKey(pKeyPair);</span>
<span class="fc" id="L130">        return new PKCS8EncodedKeySpec(myPrivateKey.getPrivateKey().getEncoded());</span>
    }

    @Override
    public X509EncodedKeySpec getX509Encoding(final GordianKeyPair pKeyPair) throws GordianException {
        /* Check the keyPair */
<span class="fc" id="L136">        JcaKeyPair.checkKeyPair(pKeyPair);</span>

        /* derive the encoding */
<span class="fc" id="L139">        final JcaPublicKey myPublicKey = (JcaPublicKey) getPublicKey(pKeyPair);</span>
<span class="fc" id="L140">        return new X509EncodedKeySpec(myPublicKey.getPublicKey().getEncoded());</span>
    }

    @Override
    public JcaKeyPair deriveKeyPair(final X509EncodedKeySpec pPublicKey,
                                    final PKCS8EncodedKeySpec pPrivateKey) throws GordianException {
        /* Protect against exceptions */
        try {
            /* Check the keySpec */
<span class="fc" id="L149">            checkKeySpec(pPrivateKey);</span>

            /* derive the keyPair */
<span class="fc" id="L152">            final JcaPublicKey myPublic = derivePublicKey(pPublicKey);</span>
<span class="fc" id="L153">            final JcaPrivateKey myPrivate = createPrivate(theFactory.generatePrivate(pPrivateKey));</span>
<span class="fc" id="L154">            final JcaKeyPair myPair = new JcaKeyPair(myPublic, myPrivate);</span>

            /* Check that we have a matching pair */
<span class="fc" id="L157">            GordianKeyPairValidity.checkValidity(getFactory(), myPair);</span>

            /* Return the keyPair */
<span class="fc" id="L160">            return myPair;</span>

<span class="nc" id="L162">        } catch (InvalidKeySpecException e) {</span>
<span class="nc" id="L163">            throw new GordianCryptoException(PARSE_ERROR, e);</span>
        }
    }

    /**
     * Create private key.
     * @param pPrivateKey the private key
     * @return the private key
     */
    protected JcaPrivateKey createPrivate(final PrivateKey pPrivateKey) {
<span class="fc" id="L173">        return new JcaPrivateKey(getKeySpec(), pPrivateKey);</span>
    }

    /**
     * Create public key.
     * @param pPublicKey the public key
     * @return the public key
     */
    protected JcaPublicKey createPublic(final PublicKey pPublicKey) {
<span class="fc" id="L182">        return new JcaPublicKey(getKeySpec(), pPublicKey);</span>
    }

    @Override
    public JcaKeyPair derivePublicOnlyKeyPair(final X509EncodedKeySpec pPublicKey) throws GordianException {
<span class="fc" id="L187">        final JcaPublicKey myPublic = derivePublicKey(pPublicKey);</span>
<span class="fc" id="L188">        return new JcaKeyPair(myPublic);</span>
    }

    /**
     * Derive the public key.
     * @param pEncodedKey the encoded public key
     * @return the public key
     * @throws GordianException on error
     */
    protected JcaPublicKey derivePublicKey(final X509EncodedKeySpec pEncodedKey) throws GordianException {
        /* Protect against exceptions */
        try {
            /* Check the keySpec */
<span class="fc" id="L201">            checkKeySpec(pEncodedKey);</span>

            /* derive the key */
<span class="fc" id="L204">            return createPublic(theFactory.generatePublic(pEncodedKey));</span>

<span class="nc" id="L206">        } catch (InvalidKeySpecException e) {</span>
<span class="nc" id="L207">            throw new GordianCryptoException(PARSE_ERROR, e);</span>
        }
    }

    /**
     * Jca RSA KeyPair generator.
     */
    public static class JcaRSAKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * RSA algorithm.
         */
        private static final String RSA_ALGO = &quot;RSA&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaRSAKeyPairGenerator(final GordianBaseFactory pFactory,
                               final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L235">            super(pFactory, pKeySpec);</span>

            /* Create and initialize the generator */
<span class="fc" id="L238">            theGenerator = getJavaKeyPairGenerator(RSA_ALGO, false);</span>
<span class="fc" id="L239">            theGenerator.initialize(pKeySpec.getRSAModulus().getLength(), getRandom());</span>

            /* Create the factory */
<span class="fc" id="L242">            setKeyFactory(getJavaKeyFactory(RSA_ALGO, false));</span>
<span class="fc" id="L243">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L248">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L249">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L250">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L251">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca ElGamal KeyPair generator.
     */
    public static class JcaElGamalKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * RSA algorithm.
         */
        private static final String ELGAMAL_ALGO = &quot;ELGAMAL&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaElGamalKeyPairGenerator(final GordianBaseFactory pFactory,
                                   final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L279">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create the parameter generator */
<span class="fc" id="L284">                final GordianDHGroup myGroup = pKeySpec.getDHGroup();</span>
<span class="fc" id="L285">                final DHParameters myParms = myGroup.getParameters();</span>
<span class="fc" id="L286">                final ElGamalParameterSpec mySpec = new ElGamalParameterSpec(myParms.getP(), myParms.getQ());</span>

                /* Create and initialize the generator */
<span class="fc" id="L289">                theGenerator = getJavaKeyPairGenerator(ELGAMAL_ALGO, false);</span>
<span class="fc" id="L290">                theGenerator.initialize(mySpec, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L293">                setKeyFactory(getJavaKeyFactory(ELGAMAL_ALGO, false));</span>

<span class="nc" id="L295">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L296">                throw new GordianCryptoException(&quot;Failed to create ElGamalGenerator&quot;, e);</span>
<span class="fc" id="L297">            }</span>
<span class="fc" id="L298">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L303">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L304">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L305">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L306">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca Elliptic KeyPair generator.
     */
    public static class JcaECKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaECKeyPairGenerator(final GordianBaseFactory pFactory,
                              final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L329">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L334">                final String myAlgo = getAlgorithm();</span>
<span class="fc" id="L335">                theGenerator = getJavaKeyPairGenerator(myAlgo, false);</span>
<span class="fc" id="L336">                final ECGenParameterSpec myParms = new ECGenParameterSpec(pKeySpec.getElliptic().getCurveName());</span>
<span class="fc" id="L337">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L340">                setKeyFactory(getJavaKeyFactory(myAlgo, false));</span>

<span class="nc" id="L342">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L343">                throw new GordianCryptoException(&quot;Failed to create ECgenerator for:  &quot; + pKeySpec, e);</span>
<span class="fc" id="L344">            }</span>
<span class="fc" id="L345">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L350">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L351">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L352">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L353">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }

        /**
         * Obtain algorithm for keySpec.
         * @return the algorithm
         */
        private String getAlgorithm() {
<span class="fc bfc" id="L361" title="All 3 branches covered.">            switch (this.getKeySpec().getKeyPairType()) {</span>
                case DSTU4145:
<span class="fc" id="L363">                    return &quot;DSTU4145&quot;;</span>
                case GOST2012:
<span class="fc" id="L365">                    return &quot;ECGOST3410-2012&quot;;</span>
                default:
<span class="fc" id="L367">                    return &quot;EC&quot;;</span>
            }
        }
    }

    /**
     * Jca DSA KeyPair generator.
     */
    public static class JcaDSAKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * DSA algorithm.
         */
        private static final String DSA_ALGO = &quot;DSA&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaDSAKeyPairGenerator(final GordianBaseFactory pFactory,
                               final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L396">            super(pFactory, pKeySpec);</span>

            /* Create and initialize the generator */
<span class="fc" id="L399">            final GordianDSAKeyType myKeyType = pKeySpec.getDSAKeyType();</span>
<span class="fc" id="L400">            theGenerator = getJavaKeyPairGenerator(DSA_ALGO, false);</span>
<span class="fc" id="L401">            theGenerator.initialize(myKeyType.getKeySize(), getRandom());</span>

            /* Create the factory */
<span class="fc" id="L404">            setKeyFactory(getJavaKeyFactory(DSA_ALGO, false));</span>
<span class="fc" id="L405">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L410">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L411">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L412">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L413">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca DiffieHellman KeyPair generator.
     */
    public static class JcaDHKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * DH algorithm.
         */
        private static final String DH_ALGO = &quot;DH&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaDHKeyPairGenerator(final GordianBaseFactory pFactory,
                              final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L441">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create the parameter generator */
<span class="fc" id="L446">                final GordianDHGroup myGroup = pKeySpec.getDHGroup();</span>
<span class="fc" id="L447">                final DHParameters myParms = myGroup.getParameters();</span>
<span class="fc" id="L448">                final DHDomainParameterSpec mySpec = new DHDomainParameterSpec(myParms);</span>

                /* Create and initialize the generator */
<span class="fc" id="L451">                theGenerator = getJavaKeyPairGenerator(DH_ALGO, false);</span>
<span class="fc" id="L452">                theGenerator.initialize(mySpec, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L455">                setKeyFactory(getJavaKeyFactory(DH_ALGO, false));</span>

<span class="nc" id="L457">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L458">                throw new GordianCryptoException(&quot;Failed to create DHgenerator&quot;, e);</span>
<span class="fc" id="L459">            }</span>
<span class="fc" id="L460">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L465">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L466">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L467">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L468">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }

        @Override
        protected JcaPrivateKey createPrivate(final PrivateKey pPrivateKey) {
<span class="fc" id="L473">            return new JcaDHPrivateKey(getKeySpec(), (BCDHPrivateKey) pPrivateKey);</span>
        }

        @Override
        protected JcaPublicKey createPublic(final PublicKey pPublicKey) {
<span class="fc" id="L478">            return new JcaDHPublicKey(getKeySpec(), (BCDHPublicKey) pPublicKey);</span>
        }
    }

    /**
     * Jca SLHDSA KeyPair generator.
     */
    public static class JcaSLHDSAKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * SLHDSA algorithm.
         */
        private static final String SLHDSA_ALGO = &quot;SLH-DSA&quot;;

        /**
         * HASH indication.
         */
        private static final String SLHDSA_HASH = &quot;HASH-&quot; + SLHDSA_ALGO;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaSLHDSAKeyPairGenerator(final GordianBaseFactory pFactory,
                                  final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L511">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Determine algorithm */
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">                final String myAlgo = pKeySpec.getSLHDSAKeySpec().isHash() ? SLHDSA_HASH : SLHDSA_ALGO;</span>

                /* Create and initialize the generator */
<span class="fc" id="L519">                theGenerator = getJavaKeyPairGenerator(myAlgo, false);</span>
<span class="fc" id="L520">                final SLHDSAParameterSpec myParms = pKeySpec.getSLHDSAKeySpec().getParameterSpec();</span>
<span class="fc" id="L521">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L524">                setKeyFactory(getJavaKeyFactory(myAlgo, false));</span>

<span class="nc" id="L526">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L527">                throw new GordianCryptoException(&quot;Failed to create SLHDSAgenerator&quot;, e);</span>
<span class="fc" id="L528">            }</span>
<span class="fc" id="L529">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L534">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L535">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L536">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L537">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca CMCE KeyPair generator.
     */
    public static class JcaCMCEKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * FRODO algorithm.
         */
        private static final String CMCE_ALGO = &quot;CMCE&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaCMCEKeyPairGenerator(final GordianBaseFactory pFactory,
                                final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L565">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L570">                theGenerator = getJavaKeyPairGenerator(CMCE_ALGO, true);</span>
<span class="fc" id="L571">                final CMCEParameterSpec myParms = pKeySpec.getCMCEKeySpec().getParameterSpec();</span>
<span class="fc" id="L572">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L575">                setKeyFactory(getJavaKeyFactory(CMCE_ALGO, true));</span>

<span class="nc" id="L577">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L578">                throw new GordianCryptoException(&quot;Failed to create CMCEgenerator&quot;, e);</span>
<span class="fc" id="L579">            }</span>
<span class="fc" id="L580">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L585">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L586">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L587">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L588">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca Frodo KeyPair generator.
     */
    public static class JcaFrodoKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * FRODO algorithm.
         */
        private static final String FRODO_ALGO = &quot;FRODO&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaFrodoKeyPairGenerator(final GordianBaseFactory pFactory,
                                 final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L616">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L621">                theGenerator = getJavaKeyPairGenerator(FRODO_ALGO, true);</span>
<span class="fc" id="L622">                final FrodoParameterSpec myParms = pKeySpec.getFRODOKeySpec().getParameterSpec();</span>
<span class="fc" id="L623">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L626">                setKeyFactory(getJavaKeyFactory(FRODO_ALGO, true));</span>

<span class="nc" id="L628">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L629">                throw new GordianCryptoException(&quot;Failed to create FRODOgenerator&quot;, e);</span>
<span class="fc" id="L630">            }</span>
<span class="fc" id="L631">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L636">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L637">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L638">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L639">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca SABER KeyPair generator.
     */
    public static class JcaSABERKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * SABER algorithm.
         */
        private static final String SABER_ALGO = &quot;SABER&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaSABERKeyPairGenerator(final GordianBaseFactory pFactory,
                                 final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L667">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L672">                theGenerator = getJavaKeyPairGenerator(SABER_ALGO, true);</span>
<span class="fc" id="L673">                final SABERParameterSpec myParms = pKeySpec.getSABERKeySpec().getParameterSpec();</span>
<span class="fc" id="L674">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L677">                setKeyFactory(getJavaKeyFactory(SABER_ALGO, true));</span>

<span class="nc" id="L679">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L680">                throw new GordianCryptoException(&quot;Failed to create SABERgenerator&quot;, e);</span>
<span class="fc" id="L681">            }</span>
<span class="fc" id="L682">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L687">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L688">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L689">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L690">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca MLKEM KeyPair generator.
     */
    public static class JcaMLKEMKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * MLKEM algorithm.
         */
        private static final String MLKEM_ALGO = &quot;MLKEM&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaMLKEMKeyPairGenerator(final GordianBaseFactory pFactory,
                                 final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L718">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L723">                theGenerator = getJavaKeyPairGenerator(MLKEM_ALGO, false);</span>
<span class="fc" id="L724">                final MLKEMParameterSpec myParms = pKeySpec.getMLKEMKeySpec().getParameterSpec();</span>
<span class="fc" id="L725">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L728">                setKeyFactory(getJavaKeyFactory(MLKEM_ALGO, false));</span>

<span class="nc" id="L730">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L731">                throw new GordianCryptoException(&quot;Failed to create MLKEMgenerator&quot;, e);</span>
<span class="fc" id="L732">            }</span>
<span class="fc" id="L733">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L738">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L739">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L740">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L741">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca MLDSA KeyPair generator.
     */
    public static class JcaMLDSAKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * MLDSA algorithm.
         */
        private static final String MLDSA_ALGO = &quot;ML-DSA&quot;;

        /**
         * HASH indication.
         */
        private static final String MLDSA_HASH = &quot;HASH-&quot; + MLDSA_ALGO;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaMLDSAKeyPairGenerator(final GordianBaseFactory pFactory,
                                 final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L774">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Determine algorithm */
<span class="pc bpc" id="L779" title="1 of 2 branches missed.">                final String myAlgo = pKeySpec.getMLDSAKeySpec().isHash() ? MLDSA_HASH : MLDSA_ALGO;</span>

                /* Create and initialize the generator */
<span class="fc" id="L782">                theGenerator = getJavaKeyPairGenerator(myAlgo, false);</span>
<span class="fc" id="L783">                final MLDSAParameterSpec myParms = pKeySpec.getMLDSAKeySpec().getParameterSpec();</span>
<span class="fc" id="L784">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L787">                setKeyFactory(getJavaKeyFactory(myAlgo, false));</span>

<span class="nc" id="L789">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L790">                throw new GordianCryptoException(&quot;Failed to create MLDSAGenerator&quot;, e);</span>
<span class="fc" id="L791">            }</span>
<span class="fc" id="L792">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L797">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L798">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L799">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L800">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca HQC KeyPair generator.
     */
    public static class JcaHQCKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * BIKE algorithm.
         */
        private static final String HQC_ALGO = &quot;HQC&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaHQCKeyPairGenerator(final GordianBaseFactory pFactory,
                               final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L828">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L833">                theGenerator = getJavaKeyPairGenerator(HQC_ALGO, true);</span>
<span class="fc" id="L834">                final HQCParameterSpec myParms = pKeySpec.getHQCKeySpec().getParameterSpec();</span>
<span class="fc" id="L835">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L838">                setKeyFactory(getJavaKeyFactory(HQC_ALGO, true));</span>

<span class="nc" id="L840">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L841">                throw new GordianCryptoException(&quot;Failed to create HQCgenerator&quot;, e);</span>
<span class="fc" id="L842">            }</span>
<span class="fc" id="L843">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L848">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L849">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L850">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L851">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }


    /**
     * Jca BIKE KeyPair generator.
     */
    public static class JcaBIKEKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * BIKE algorithm.
         */
        private static final String BIKE_ALGO = &quot;BIKE&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaBIKEKeyPairGenerator(final GordianBaseFactory pFactory,
                                final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L880">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L885">                theGenerator = getJavaKeyPairGenerator(BIKE_ALGO, true);</span>
<span class="fc" id="L886">                final BIKEParameterSpec myParms = pKeySpec.getBIKEKeySpec().getParameterSpec();</span>
<span class="fc" id="L887">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L890">                setKeyFactory(getJavaKeyFactory(BIKE_ALGO, true));</span>

<span class="nc" id="L892">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L893">                throw new GordianCryptoException(&quot;Failed to create BIKEgenerator&quot;, e);</span>
<span class="fc" id="L894">            }</span>
<span class="fc" id="L895">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L900">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L901">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L902">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L903">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca NTRU KeyPair generator.
     */
    public static class JcaNTRUKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * NTRU algorithm.
         */
        private static final String NTRU_ALGO = &quot;NTRU&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaNTRUKeyPairGenerator(final GordianBaseFactory pFactory,
                                final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L931">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L936">                theGenerator = getJavaKeyPairGenerator(NTRU_ALGO, true);</span>
<span class="fc" id="L937">                final NTRUParameterSpec myParms = pKeySpec.getNTRUKeySpec().getParameterSpec();</span>
<span class="fc" id="L938">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L941">                setKeyFactory(getJavaKeyFactory(NTRU_ALGO, true));</span>

<span class="nc" id="L943">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L944">                throw new GordianCryptoException(&quot;Failed to create NTRUgenerator&quot;, e);</span>
<span class="fc" id="L945">            }</span>
<span class="fc" id="L946">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L951">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L952">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L953">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L954">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca Falcon KeyPair generator.
     */
    public static class JcaFalconKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * FALCON algorithm.
         */
        private static final String FALCON_ALGO = &quot;FALCON&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaFalconKeyPairGenerator(final GordianBaseFactory pFactory,
                                  final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L982">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L987">                theGenerator = getJavaKeyPairGenerator(FALCON_ALGO, true);</span>
<span class="fc" id="L988">                final FalconParameterSpec myParms = pKeySpec.getFalconKeySpec().getParameterSpec();</span>
<span class="fc" id="L989">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L992">                setKeyFactory(getJavaKeyFactory(FALCON_ALGO, true));</span>

<span class="nc" id="L994">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L995">                throw new GordianCryptoException(&quot;Failed to create FALCONgenerator&quot;, e);</span>
<span class="fc" id="L996">            }</span>
<span class="fc" id="L997">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1002">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1003">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1004">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1005">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca Mayo KeyPair generator.
     */
    public static class JcaMayoKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * Mayo algorithm.
         */
        private static final String MAYO_ALGO = &quot;MAYO&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaMayoKeyPairGenerator(final GordianBaseFactory pFactory,
                                final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L1033">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L1038">                theGenerator = getJavaKeyPairGenerator(MAYO_ALGO, true);</span>
<span class="fc" id="L1039">                final MayoParameterSpec myParms = pKeySpec.getMayoKeySpec().getParameterSpec();</span>
<span class="fc" id="L1040">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L1043">                setKeyFactory(getJavaKeyFactory(MAYO_ALGO, true));</span>

<span class="nc" id="L1045">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L1046">                throw new GordianCryptoException(&quot;Failed to create MayoGenerator&quot;, e);</span>
<span class="fc" id="L1047">            }</span>
<span class="fc" id="L1048">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1053">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1054">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1055">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1056">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca Snova KeyPair generator.
     */
    public static class JcaSnovaKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * Snova algorithm.
         */
        private static final String SNOVA_ALGO = &quot;SNOVA&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaSnovaKeyPairGenerator(final GordianBaseFactory pFactory,
                                 final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L1084">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L1089">                theGenerator = getJavaKeyPairGenerator(SNOVA_ALGO, true);</span>
<span class="fc" id="L1090">                final SnovaParameterSpec myParms = pKeySpec.getSnovaKeySpec().getParameterSpec();</span>
<span class="fc" id="L1091">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L1094">                setKeyFactory(getJavaKeyFactory(SNOVA_ALGO, true));</span>

<span class="nc" id="L1096">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L1097">                throw new GordianCryptoException(&quot;Failed to create SnovaGenerator&quot;, e);</span>
<span class="fc" id="L1098">            }</span>
<span class="fc" id="L1099">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1104">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1105">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1106">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1107">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca NTRULPrime KeyPair generator.
     */
    public static class JcaNTRULPrimeKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * NTRULPrime algorithm.
         */
        private static final String NTRU_ALGO = &quot;NTRULPRIME&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaNTRULPrimeKeyPairGenerator(final GordianBaseFactory pFactory,
                                      final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L1135">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L1140">                theGenerator = getJavaKeyPairGenerator(NTRU_ALGO, true);</span>
<span class="fc" id="L1141">                final NTRULPRimeParameterSpec myParms = pKeySpec.getNTRUPrimeKeySpec().getParams().getNTRULParameterSpec();</span>
<span class="fc" id="L1142">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L1145">                setKeyFactory(getJavaKeyFactory(NTRU_ALGO, true));</span>

<span class="nc" id="L1147">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L1148">                throw new GordianCryptoException(&quot;Failed to create NTRULPrimeGenerator&quot;, e);</span>
<span class="fc" id="L1149">            }</span>
<span class="fc" id="L1150">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1155">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1156">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1157">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1158">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca SNTRUPrime KeyPair generator.
     */
    public static class JcaSNTRUPrimeKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * NTRULPrime algorithm.
         */
        private static final String NTRU_ALGO = &quot;SNTRUPRIME&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaSNTRUPrimeKeyPairGenerator(final GordianBaseFactory pFactory,
                                      final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="nc" id="L1186">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="nc" id="L1191">                theGenerator = getJavaKeyPairGenerator(NTRU_ALGO, true);</span>
<span class="nc" id="L1192">                final SNTRUPrimeParameterSpec myParms = pKeySpec.getNTRUPrimeKeySpec().getParams().getSNTRUParameterSpec();</span>
<span class="nc" id="L1193">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="nc" id="L1196">                setKeyFactory(getJavaKeyFactory(NTRU_ALGO, true));</span>

<span class="nc" id="L1198">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L1199">                throw new GordianCryptoException(&quot;Failed to create SNTRUPrimeGenerator&quot;, e);</span>
<span class="nc" id="L1200">            }</span>
<span class="nc" id="L1201">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="nc" id="L1206">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="nc" id="L1207">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="nc" id="L1208">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="nc" id="L1209">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca Picnic KeyPair generator.
     */
    public static class JcaPicnicKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * Picnic algorithm.
         */
        private static final String PICNIC_ALGO = &quot;PICNIC&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaPicnicKeyPairGenerator(final GordianBaseFactory pFactory,
                                  final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L1237">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create and initialize the generator */
<span class="fc" id="L1242">                theGenerator = getJavaKeyPairGenerator(PICNIC_ALGO, true);</span>
<span class="fc" id="L1243">                final PicnicParameterSpec myParms = pKeySpec.getPicnicKeySpec().getParameterSpec();</span>
<span class="fc" id="L1244">                theGenerator.initialize(myParms, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L1247">                setKeyFactory(getJavaKeyFactory(PICNIC_ALGO, true));</span>

<span class="nc" id="L1249">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L1250">                throw new GordianCryptoException(&quot;Failed to create PICNICgenerator&quot;, e);</span>
<span class="fc" id="L1251">            }</span>
<span class="fc" id="L1252">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1257">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1258">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1259">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1260">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca XMSS KeyPair generator.
     */
    public static class JcaXMSSKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaXMSSKeyPairGenerator(final GordianBaseFactory pFactory,
                                final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L1283">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Access the algorithm */
<span class="fc" id="L1288">                final GordianXMSSKeySpec myXMSSKeySpec = pKeySpec.getXMSSKeySpec();</span>
<span class="fc" id="L1289">                final boolean isXMSSMT = myXMSSKeySpec.isMT();</span>
<span class="fc" id="L1290">                final GordianXMSSDigestType myType = myXMSSKeySpec.getDigestType();</span>

                /* Create the parameters */
<span class="pc bpc" id="L1293" title="1 of 2 branches missed.">                final AlgorithmParameterSpec myAlgo = isXMSSMT</span>
<span class="nc" id="L1294">                                                      ? new XMSSMTParameterSpec(myXMSSKeySpec.getHeight().getHeight(),</span>
<span class="nc" id="L1295">                                                                                myXMSSKeySpec.getLayers().getLayers(), myType.name())</span>
<span class="fc" id="L1296">                                                      : new XMSSParameterSpec(myXMSSKeySpec.getHeight().getHeight(), myType.name());</span>

                /* Create and initialize the generator */
<span class="fc" id="L1299">                final String myJavaType = myXMSSKeySpec.getKeyType().name();</span>
<span class="fc" id="L1300">                theGenerator = getJavaKeyPairGenerator(myJavaType, true);</span>
<span class="fc" id="L1301">                theGenerator.initialize(myAlgo, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L1304">                setKeyFactory(getJavaKeyFactory(myJavaType, true));</span>

<span class="nc" id="L1306">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L1307">                throw new GordianCryptoException(&quot;Failed to create XMSSgenerator&quot;, e);</span>
<span class="fc" id="L1308">            }</span>
<span class="fc" id="L1309">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1314">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1315">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1316">            final JcaStateAwarePrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1317">            return new JcaStateAwareKeyPair(myPublic, myPrivate);</span>
        }

        @Override
        protected JcaStateAwarePrivateKey createPrivate(final PrivateKey pPrivateKey) {
<span class="fc" id="L1322">            return new JcaStateAwarePrivateKey(getKeySpec(), pPrivateKey);</span>
        }

        @Override
        public JcaKeyPair deriveKeyPair(final X509EncodedKeySpec pPublicKey,
                                        final PKCS8EncodedKeySpec pPrivateKey) throws GordianException {
            /* Protect against exceptions */
            try {
                /* Check the keySpecs */
<span class="fc" id="L1331">                checkKeySpec(pPrivateKey);</span>

                /* derive keyPair */
<span class="fc" id="L1334">                final JcaPublicKey myPublic = derivePublicKey(pPublicKey);</span>
<span class="fc" id="L1335">                JcaStateAwarePrivateKey myPrivate = createPrivate(getKeyFactory().generatePrivate(pPrivateKey));</span>
<span class="fc" id="L1336">                final JcaKeyPair myPair = new JcaStateAwareKeyPair(myPublic, myPrivate);</span>

                /* Check that we have a matching pair */
<span class="fc" id="L1339">                GordianKeyPairValidity.checkValidity(getFactory(), myPair);</span>

                /* Rebuild and return the keyPair to avoid incrementing usage count */
<span class="fc" id="L1342">                myPrivate = createPrivate(getKeyFactory().generatePrivate(pPrivateKey));</span>
<span class="fc" id="L1343">                return new JcaStateAwareKeyPair(myPublic, myPrivate);</span>

<span class="nc" id="L1345">            } catch (InvalidKeySpecException e) {</span>
<span class="nc" id="L1346">                throw new GordianCryptoException(PARSE_ERROR, e);</span>
            }
        }
    }

    /**
     * Jca Edwards KeyPair generator.
     */
    public static class JcaEdKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        protected JcaEdKeyPairGenerator(final GordianBaseFactory pFactory,
                                        final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L1370">            super(pFactory, pKeySpec);</span>

            /* Protect against exceptions */
            try {
                /* Create the parameters */
                final AlgorithmParameterSpec myAlgo;
<span class="fc" id="L1376">                final boolean is25519 = pKeySpec.getEdwardsElliptic().is25519();</span>
<span class="pc bpc" id="L1377" title="1 of 3 branches missed.">                switch (pKeySpec.getKeyPairType()) {</span>
                    case XDH:
<span class="fc bfc" id="L1379" title="All 2 branches covered.">                        myAlgo = is25519</span>
<span class="fc" id="L1380">                                 ? new XDHParameterSpec(XDHParameterSpec.X25519)</span>
<span class="fc" id="L1381">                                 : new XDHParameterSpec(XDHParameterSpec.X448);</span>
<span class="fc" id="L1382">                        break;</span>
                    case EDDSA:
<span class="fc bfc" id="L1384" title="All 2 branches covered.">                        myAlgo = is25519</span>
<span class="fc" id="L1385">                                 ? new EdDSAParameterSpec(EdDSAParameterSpec.Ed25519)</span>
<span class="fc" id="L1386">                                 : new EdDSAParameterSpec(EdDSAParameterSpec.Ed448);</span>
<span class="fc" id="L1387">                        break;</span>
                    default:
<span class="nc" id="L1389">                        throw new GordianLogicException(&quot;Invalid KeySpec&quot; + pKeySpec);</span>
                }

                /* Create and initialize the generator */
<span class="fc" id="L1393">                final String myJavaType = pKeySpec.toString();</span>
<span class="fc" id="L1394">                theGenerator = getJavaKeyPairGenerator(myJavaType, false);</span>
<span class="fc" id="L1395">                theGenerator.initialize(myAlgo, getRandom());</span>

                /* Create the factory */
<span class="fc" id="L1398">                setKeyFactory(getJavaKeyFactory(myJavaType, false));</span>

<span class="nc" id="L1400">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L1401">                throw new GordianCryptoException(&quot;Failed to create EdwardsGenerator&quot;, e);</span>
<span class="fc" id="L1402">            }</span>
<span class="fc" id="L1403">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1408">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1409">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1410">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1411">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca NewHope KeyPair generator.
     */
    public static class JcaNewHopeKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * NewHope algorithm.
         */
        private static final String NEWHOPE_ALGO = &quot;NH&quot;;

        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaNewHopeKeyPairGenerator(final GordianBaseFactory pFactory,
                                   final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L1439">            super(pFactory, pKeySpec);</span>

            /* Create and initialize the generator */
<span class="fc" id="L1442">            theGenerator = getJavaKeyPairGenerator(NEWHOPE_ALGO, true);</span>
<span class="fc" id="L1443">            theGenerator.initialize(GordianRSAModulus.MOD1024.getLength(), getRandom());</span>

            /* Create the factory */
<span class="fc" id="L1446">            setKeyFactory(getJavaKeyFactory(NEWHOPE_ALGO, true));</span>
<span class="fc" id="L1447">        }</span>

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1452">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1453">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1454">            final JcaPrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1455">            return new JcaKeyPair(myPublic, myPrivate);</span>
        }
    }

    /**
     * Jca LMS KeyPair generator.
     */
    public static class JcaLMSKeyPairGenerator
            extends JcaKeyPairGenerator {
        /**
         * Generator.
         */
        private final KeyPairGenerator theGenerator;

        /**
         * Constructor.
         * @param pFactory the Security Factory
         * @param pKeySpec the keySpec
         * @throws GordianException on error
         */
        JcaLMSKeyPairGenerator(final GordianBaseFactory pFactory,
                               final GordianKeyPairSpec pKeySpec) throws GordianException {
            /* initialize underlying class */
<span class="fc" id="L1478">            super(pFactory, pKeySpec);</span>

            /* Create and initialize the generator */
<span class="fc" id="L1481">            final String myJavaType = pKeySpec.getKeyPairType().toString();</span>
<span class="fc" id="L1482">            theGenerator = getJavaKeyPairGenerator(myJavaType, true);</span>

            /* Protect against exceptions */
            try {
<span class="pc bpc" id="L1486" title="1 of 2 branches missed.">                final AlgorithmParameterSpec myParms = pKeySpec.getSubKeyType() instanceof GordianHSSKeySpec</span>
<span class="fc" id="L1487">                        ? deriveParameters(pKeySpec.getHSSKeySpec())</span>
<span class="pc" id="L1488">                        : deriveParameters(pKeySpec.getLMSKeySpec());</span>
<span class="fc" id="L1489">                theGenerator.initialize(myParms, getRandom());</span>

<span class="nc" id="L1491">            } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L1492">                throw new GordianCryptoException(&quot;Failed to initialize generator&quot;, e);</span>
<span class="fc" id="L1493">            }</span>

            /* Create the factory */
<span class="fc" id="L1496">            setKeyFactory(getJavaKeyFactory(myJavaType, true));</span>
<span class="fc" id="L1497">        }</span>

        /**
         * Derive the parameters.
         * @param pKeySpec the keySPec
         * @return the parameters.
         */
        private static LMSHSSKeyGenParameterSpec deriveParameters(final GordianHSSKeySpec pKeySpec) {
            /* Generate and return the keyPair */
<span class="fc" id="L1506">            final GordianLMSKeySpec myKeySpec = pKeySpec.getKeySpec();</span>
<span class="fc" id="L1507">            final LMSKeyGenParameterSpec[] myParams = new LMSKeyGenParameterSpec[pKeySpec.getTreeDepth()];</span>
<span class="fc" id="L1508">            Arrays.fill(myParams, deriveParameters(myKeySpec));</span>
<span class="fc" id="L1509">            return new LMSHSSKeyGenParameterSpec(myParams);</span>
        }

        /**
         * Derive the parameters.
         * @param pKeySpec the keySpec
         * @return the parameters.
         */
        private static LMSKeyGenParameterSpec deriveParameters(final GordianLMSKeySpec pKeySpec) {
<span class="fc" id="L1518">            final LMSParameters myParms = pKeySpec.getParameters();</span>
<span class="fc" id="L1519">            return new LMSKeyGenParameterSpec(myParms.getLMSigParam(), myParms.getLMOTSParam());</span>
        }

        @Override
        public JcaKeyPair generateKeyPair() {
            /* Generate and return the keyPair */
<span class="fc" id="L1525">            final KeyPair myPair = theGenerator.generateKeyPair();</span>
<span class="fc" id="L1526">            final JcaPublicKey myPublic = createPublic(myPair.getPublic());</span>
<span class="fc" id="L1527">            final JcaStateAwarePrivateKey myPrivate = createPrivate(myPair.getPrivate());</span>
<span class="fc" id="L1528">            return new JcaStateAwareKeyPair(myPublic, myPrivate);</span>
        }

        @Override
        protected JcaStateAwarePrivateKey createPrivate(final PrivateKey pPrivateKey) {
<span class="fc" id="L1533">            return new JcaStateAwarePrivateKey(getKeySpec(), pPrivateKey);</span>
        }

        @Override
        public JcaKeyPair deriveKeyPair(final X509EncodedKeySpec pPublicKey,
                                        final PKCS8EncodedKeySpec pPrivateKey) throws GordianException {
            /* Protect against exceptions */
            try {
                /* Check the keySpecs */
<span class="fc" id="L1542">                checkKeySpec(pPrivateKey);</span>

                /* derive keyPair */
<span class="fc" id="L1545">                final JcaPublicKey myPublic = derivePublicKey(pPublicKey);</span>
<span class="fc" id="L1546">                JcaStateAwarePrivateKey myPrivate = createPrivate(getKeyFactory().generatePrivate(pPrivateKey));</span>
<span class="fc" id="L1547">                final JcaKeyPair myPair = new JcaStateAwareKeyPair(myPublic, myPrivate);</span>

                /* Check that we have a matching pair */
<span class="fc" id="L1550">                GordianKeyPairValidity.checkValidity(getFactory(), myPair);</span>

                /* Rebuild and return the keyPair to avoid incrementing usage count */
<span class="fc" id="L1553">                myPrivate = createPrivate(getKeyFactory().generatePrivate(pPrivateKey));</span>
<span class="fc" id="L1554">                return new JcaStateAwareKeyPair(myPublic, myPrivate);</span>

<span class="nc" id="L1556">            } catch (InvalidKeySpecException e) {</span>
<span class="nc" id="L1557">                throw new GordianCryptoException(PARSE_ERROR, e);</span>
            }
        }
    }

    /**
     * Create the BouncyCastle KeyFactory via JCA.
     * @param pAlgorithm the Algorithm
     * @param postQuantum is this a postQuantum algorithm?
     * @return the KeyFactory
     * @throws GordianException on error
     */
    static KeyFactory getJavaKeyFactory(final String pAlgorithm,
                                        final boolean postQuantum) throws GordianException {
        /* Protect against exceptions */
        try {
            /* Return a KeyFactory for the algorithm */
<span class="fc bfc" id="L1574" title="All 2 branches covered.">            return KeyFactory.getInstance(pAlgorithm, postQuantum</span>
<span class="fc" id="L1575">                    ? JcaProvider.BCPQPROV</span>
<span class="fc" id="L1576">                    : JcaProvider.BCPROV);</span>

            /* Catch exceptions */
<span class="nc" id="L1579">        } catch (NoSuchAlgorithmException e) {</span>
            /* Throw the exception */
<span class="nc" id="L1581">            throw new GordianCryptoException(&quot;Failed to create KeyFactory&quot;, e);</span>
        }
    }

    /**
     * Create the BouncyCastle KeyPairGenerator via JCA.
     * @param pAlgorithm the Algorithm
     * @param postQuantum is this a postQuantum algorithm?
     * @return the KeyPairGenerator
     * @throws GordianException on error
     */
    static KeyPairGenerator getJavaKeyPairGenerator(final String pAlgorithm,
                                                    final boolean postQuantum) throws GordianException {
        /* Protect against exceptions */
        try {
            /* Return a KeyPairGenerator for the algorithm */
<span class="fc bfc" id="L1597" title="All 2 branches covered.">            return KeyPairGenerator.getInstance(pAlgorithm, postQuantum</span>
<span class="fc" id="L1598">                    ? JcaProvider.BCPQPROV</span>
<span class="fc" id="L1599">                    : JcaProvider.BCPROV);</span>

            /* Catch exceptions */
<span class="nc" id="L1602">        } catch (NoSuchAlgorithmException e) {</span>
            /* Throw the exception */
<span class="nc" id="L1604">            throw new GordianCryptoException(&quot;Failed to create KeyPairGenerator&quot;, e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>