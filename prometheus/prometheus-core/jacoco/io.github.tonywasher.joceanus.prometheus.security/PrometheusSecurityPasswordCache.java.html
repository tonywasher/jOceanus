<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusSecurityPasswordCache.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.prometheus.security</a> &gt; <span class="el_source">PrometheusSecurityPasswordCache.java</span></div><h1>PrometheusSecurityPasswordCache.java</h1><pre class="source lang-java linenums">/*
 * Prometheus: Application Framework
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.prometheus.security;

import io.github.tonywasher.joceanus.gordianknot.api.base.GordianException;
import io.github.tonywasher.joceanus.gordianknot.api.factory.GordianFactory;
import io.github.tonywasher.joceanus.gordianknot.api.factory.GordianFactory.GordianFactoryLock;
import io.github.tonywasher.joceanus.gordianknot.api.keypair.GordianKeyPair;
import io.github.tonywasher.joceanus.gordianknot.api.keyset.GordianBadCredentialsException;
import io.github.tonywasher.joceanus.gordianknot.api.keyset.GordianKeySet;
import io.github.tonywasher.joceanus.gordianknot.api.keyset.GordianKeySetFactory;
import io.github.tonywasher.joceanus.gordianknot.api.lock.GordianKeyPairLock;
import io.github.tonywasher.joceanus.gordianknot.api.lock.GordianKeySetLock;
import io.github.tonywasher.joceanus.gordianknot.api.lock.GordianLock;
import io.github.tonywasher.joceanus.gordianknot.api.lock.GordianLockFactory;
import io.github.tonywasher.joceanus.gordianknot.api.lock.GordianPasswordLockSpec;
import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.convert.OceanusDataConverter;
import io.github.tonywasher.joceanus.oceanus.logger.OceanusLogManager;
import io.github.tonywasher.joceanus.oceanus.logger.OceanusLogger;
import io.github.tonywasher.joceanus.prometheus.exc.PrometheusDataException;
import io.github.tonywasher.joceanus.prometheus.exc.PrometheusSecurityException;

import java.nio.ByteBuffer;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;

/**
 * Password Cache.
 */
public class PrometheusSecurityPasswordCache {
    /**
     * Logger.
     */
<span class="fc" id="L51">    private static final OceanusLogger LOGGER = OceanusLogManager.getLogger(PrometheusSecurityPasswordCache.class);</span>

    /**
     * Password failed message.
     */
    private static final String PASSWORD_FAIL = &quot;Password attempt failed&quot;;

    /**
     * List of resolved Locks.
     */
    private final List&lt;PrometheusLockCache&lt;?&gt;&gt; theLocks;

    /**
     * List of successful passwords.
     */
    private final List&lt;ByteBuffer&gt; thePasswords;

    /**
     * The Factory.
     */
    private final GordianFactory theFactory;

    /**
     * The KeySet Factory.
     */
    private final GordianKeySetFactory theKeySetFactory;

    /**
     * The lockFactory.
     */
    private final GordianLockFactory theLockFactory;

    /**
     * PasswordLockSpec.
     */
    private final GordianPasswordLockSpec theLockSpec;

    /**
     * Local keySet.
     */
    private final GordianKeySet theKeySet;

    /**
     * Constructor.
     *
     * @param pManager  the password manager
     * @param pLockSpec the passwordLockSpec
     * @throws OceanusException on error
     */
    PrometheusSecurityPasswordCache(final PrometheusSecurityPasswordManager pManager,
<span class="fc" id="L101">                                    final GordianPasswordLockSpec pLockSpec) throws OceanusException {</span>
        /* Protect against exceptions */
        try {
            /* Store factory and lockSpec*/
<span class="fc" id="L105">            theFactory = pManager.getSecurityFactory();</span>
<span class="fc" id="L106">            theKeySetFactory = theFactory.getKeySetFactory();</span>
<span class="fc" id="L107">            theLockFactory = theFactory.getLockFactory();</span>
<span class="fc" id="L108">            theLockSpec = pLockSpec;</span>

            /* Create a keySet */
<span class="fc" id="L111">            theKeySet = theKeySetFactory.generateKeySet(pLockSpec.getKeySetSpec());</span>

            /* Create the lists */
<span class="fc" id="L114">            theLocks = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L115">            thePasswords = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L117">        } catch (GordianException e) {</span>
<span class="nc" id="L118">            throw new PrometheusSecurityException(e);</span>
<span class="fc" id="L119">        }</span>
<span class="fc" id="L120">    }</span>

    /**
     * Add resolved factoryLock to cache.
     *
     * @param pFactory  the resolved FactoryLock
     * @param pPassword the password
     * @throws OceanusException on error
     */
    void addResolvedFactory(final GordianFactoryLock pFactory,
                            final char[] pPassword) throws OceanusException {
<span class="fc" id="L131">        byte[] myPasswordBytes = null;</span>
        try {
            /* Encrypt the password */
<span class="fc" id="L134">            myPasswordBytes = OceanusDataConverter.charsToByteArray(pPassword);</span>
<span class="fc" id="L135">            final byte[] myEncrypted = theKeySet.encryptBytes(myPasswordBytes);</span>

            /* Add the entry to the lists */
<span class="fc" id="L138">            final ByteBuffer myBuffer = ByteBuffer.wrap(myEncrypted);</span>
<span class="fc" id="L139">            theLocks.add(new PrometheusLockCache&lt;&gt;(pFactory, myBuffer));</span>
<span class="fc" id="L140">            thePasswords.add(myBuffer);</span>


<span class="nc" id="L143">        } catch (GordianException e) {</span>
<span class="nc" id="L144">            throw new PrometheusSecurityException(e);</span>

        } finally {
            /* Clear out password */
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="fc" id="L149">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
        }
<span class="fc" id="L152">    }</span>

    /**
     * Add resolved keySetLock to cache.
     *
     * @param pKeySet   the resolved keySetLock
     * @param pPassword the password
     * @throws OceanusException on error
     */
    void addResolvedKeySet(final GordianKeySetLock pKeySet,
                           final char[] pPassword) throws OceanusException {
<span class="fc" id="L163">        byte[] myPasswordBytes = null;</span>
        try {
            /* Encrypt the password */
<span class="fc" id="L166">            myPasswordBytes = OceanusDataConverter.charsToByteArray(pPassword);</span>
<span class="fc" id="L167">            final byte[] myEncrypted = theKeySet.encryptBytes(myPasswordBytes);</span>

            /* Add the entry to the lists */
<span class="fc" id="L170">            final ByteBuffer myBuffer = ByteBuffer.wrap(myEncrypted);</span>
<span class="fc" id="L171">            theLocks.add(new PrometheusLockCache&lt;&gt;(pKeySet, myBuffer));</span>
<span class="fc" id="L172">            thePasswords.add(myBuffer);</span>

<span class="nc" id="L174">        } catch (GordianException e) {</span>
<span class="nc" id="L175">            throw new PrometheusSecurityException(e);</span>

        } finally {
            /* Clear out password */
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="fc" id="L180">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
        }
<span class="fc" id="L183">    }</span>

    /**
     * Add resolved keyPairLock to cache.
     *
     * @param pKeyPair  the resolved keyPairLock
     * @param pPassword the password
     * @throws OceanusException on error
     */
    void addResolvedKeyPair(final GordianKeyPairLock pKeyPair,
                            final char[] pPassword) throws OceanusException {
<span class="nc" id="L194">        byte[] myPasswordBytes = null;</span>
        try {
            /* Encrypt the password */
<span class="nc" id="L197">            myPasswordBytes = OceanusDataConverter.charsToByteArray(pPassword);</span>
<span class="nc" id="L198">            final byte[] myEncrypted = theKeySet.encryptBytes(myPasswordBytes);</span>

            /* Add the entry to the lists */
<span class="nc" id="L201">            final ByteBuffer myBuffer = ByteBuffer.wrap(myEncrypted);</span>
<span class="nc" id="L202">            theLocks.add(new PrometheusLockCache&lt;&gt;(pKeyPair, myBuffer));</span>
<span class="nc" id="L203">            thePasswords.add(myBuffer);</span>

<span class="nc" id="L205">        } catch (GordianException e) {</span>
<span class="nc" id="L206">            throw new PrometheusSecurityException(e);</span>

        } finally {
            /* Clear out password */
<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="nc" id="L211">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
        }
<span class="nc" id="L214">    }</span>

    /**
     * LookUp previously resolved Factory.
     *
     * @param pLockBytes the LockBytes to search for
     * @return the previous factoryLock if found, otherwise null
     */
    GordianFactoryLock lookUpResolvedFactoryLock(final byte[] pLockBytes) {
        /* Look for the factory in the list */
<span class="fc bfc" id="L224" title="All 2 branches covered.">        for (PrometheusLockCache&lt;?&gt; myCurr : theLocks) {</span>
            /* If this is the factoryLock we are looking for, return it */
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">            if (myCurr.getLock() instanceof GordianFactoryLock</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(pLockBytes, myCurr.getLock().getLockBytes())) {</span>
<span class="nc" id="L228">                return (GordianFactoryLock) myCurr.getLock();</span>
            }
<span class="fc" id="L230">        }</span>

        /* Return not found */
<span class="fc" id="L233">        return null;</span>
    }

    /**
     * LookUp previously resolved keySet.
     *
     * @param pLockBytes the LockBytes to search for
     * @return the previous keySetLock if found, otherwise null
     */
    GordianKeySetLock lookUpResolvedKeySetLock(final byte[] pLockBytes) {
        /* Look for the keySet in the list */
<span class="fc bfc" id="L244" title="All 2 branches covered.">        for (PrometheusLockCache&lt;?&gt; myCurr : theLocks) {</span>
            /* If this is the keySetLock we are looking for, return it */
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">            if (myCurr.getLock() instanceof GordianKeySetLock</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">                    &amp;&amp; Arrays.equals(pLockBytes, myCurr.getLock().getLockBytes())) {</span>
<span class="nc" id="L248">                return (GordianKeySetLock) myCurr.getLock();</span>
            }
<span class="fc" id="L250">        }</span>

        /* Return not found */
<span class="fc" id="L253">        return null;</span>
    }

    /**
     * LookUp previously resolved keyPair.
     *
     * @param pLockBytes the LockBytes to search for
     * @param pKeyPair   the keyPair
     * @return the previous keySetLock if found, otherwise null
     */
    GordianKeyPairLock lookUpResolvedKeyPairLock(final byte[] pLockBytes,
                                                 final GordianKeyPair pKeyPair) {
        /* Look for the keyPair in the list */
<span class="nc bnc" id="L266" title="All 2 branches missed.">        for (PrometheusLockCache&lt;?&gt; myCurr : theLocks) {</span>
            /* If this is the keyPairLock we are looking for, return it */
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (myCurr.getLock() instanceof GordianKeyPairLock</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                    &amp;&amp; Arrays.equals(pLockBytes, myCurr.getLock().getLockBytes())</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                    &amp;&amp; pKeyPair.equals(((GordianKeyPairLock) myCurr.getLock()).getKeyPair())) {</span>
<span class="nc" id="L271">                return (GordianKeyPairLock) myCurr.getLock();</span>
            }
<span class="nc" id="L273">        }</span>

        /* Return not found */
<span class="nc" id="L276">        return null;</span>
    }

    /**
     * LookUp previously resolved Password.
     *
     * @param pReference the Reference to search for
     * @return the encrypted password
     * @throws OceanusException on error
     */
    ByteBuffer lookUpResolvedPassword(final Object pReference) throws OceanusException {
        /* If the reference is a lock */
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">        if (pReference instanceof GordianLock) {</span>
            /* Look for the lock in the list */
<span class="fc" id="L290">            final GordianLock&lt;?&gt; myReference = (GordianLock&lt;?&gt;) pReference;</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">            for (PrometheusLockCache&lt;?&gt; myCurr : theLocks) {</span>
                /* If this is the lock are looking for, return it */
<span class="fc bfc" id="L293" title="All 2 branches covered.">                if (Objects.equals(myReference, myCurr.getLock())) {</span>
<span class="fc" id="L294">                    return myCurr.getPassword();</span>
                }
<span class="fc" id="L296">            }</span>
        }

        /* Throw error */
<span class="nc" id="L300">        throw new PrometheusDataException(&quot;Referenced Object not known&quot;);</span>
    }

    /**
     * Attempt known passwords for factory lock.
     *
     * @param pLockBytes the lockBytes to attempt passwords for
     * @return the new FactoryLock if successful, otherwise null
     */
    GordianFactoryLock attemptKnownPasswordsForFactoryLock(final byte[] pLockBytes) {
        /* Loop through the passwords */
<span class="fc bfc" id="L311" title="All 2 branches covered.">        for (ByteBuffer myCurr : thePasswords) {</span>
            /* Attempt the password */
<span class="fc" id="L313">            final GordianFactoryLock myFactory = attemptPasswordForFactoryLock(pLockBytes, myCurr.array());</span>

            /* If we succeeded */
<span class="fc bfc" id="L316" title="All 2 branches covered.">            if (myFactory != null) {</span>
                /* Add the factory to the list and return it */
<span class="fc" id="L318">                theLocks.add(new PrometheusLockCache&lt;&gt;(myFactory, myCurr));</span>
<span class="fc" id="L319">                return myFactory;</span>
            }
<span class="fc" id="L321">        }</span>

        /* Return null */
<span class="fc" id="L324">        return null;</span>
    }

    /**
     * Attempt the cached password against the passed lock.
     *
     * @param pLockBytes the Lock to test against
     * @param pPassword  the encrypted password
     * @return the new FactoryLock if successful, otherwise null
     */
    private GordianFactoryLock attemptPasswordForFactoryLock(final byte[] pLockBytes,
                                                             final byte[] pPassword) {
        /* Protect against exceptions */
<span class="fc" id="L337">        byte[] myPasswordBytes = null;</span>
<span class="fc" id="L338">        char[] myPasswordChars = null;</span>
        try {
            /* Access the original password */
<span class="fc" id="L341">            myPasswordBytes = theKeySet.decryptBytes(pPassword);</span>
<span class="fc" id="L342">            myPasswordChars = OceanusDataConverter.bytesToCharArray(myPasswordBytes);</span>

            /* Try to resolve the lock and return it */
<span class="fc" id="L345">            return theFactory.resolveFactoryLock(pLockBytes, myPasswordChars);</span>

            /* Catch Exceptions */
<span class="nc" id="L348">        } catch (GordianException</span>
                 | OceanusException e) {
<span class="nc" id="L350">            LOGGER.error(PASSWORD_FAIL, e);</span>
<span class="nc" id="L351">            return null;</span>

<span class="fc" id="L353">        } catch (GordianBadCredentialsException e) {</span>
<span class="fc" id="L354">            return null;</span>

        } finally {
            /* Clear out password */
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="fc" id="L359">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">            if (myPasswordChars != null) {</span>
<span class="fc" id="L362">                Arrays.fill(myPasswordChars, (char) 0);</span>
            }
        }
    }

    /**
     * Attempt known passwords for keySet lock.
     *
     * @param pLockBytes the lockBytes to attempt passwords for
     * @return the new keySetLock if successful, otherwise null
     */
    GordianKeySetLock attemptKnownPasswordsForKeySetLock(final byte[] pLockBytes) {
        /* Loop through the passwords */
<span class="fc bfc" id="L375" title="All 2 branches covered.">        for (ByteBuffer myCurr : thePasswords) {</span>
            /* Attempt the password */
<span class="fc" id="L377">            final GordianKeySetLock myKeySet = attemptPasswordForKeySetLock(pLockBytes, myCurr.array());</span>

            /* If we succeeded */
<span class="fc bfc" id="L380" title="All 2 branches covered.">            if (myKeySet != null) {</span>
                /* Add the factory to the list and return it */
<span class="fc" id="L382">                theLocks.add(new PrometheusLockCache&lt;&gt;(myKeySet, myCurr));</span>
<span class="fc" id="L383">                return myKeySet;</span>
            }
<span class="fc" id="L385">        }</span>

        /* Return null */
<span class="fc" id="L388">        return null;</span>
    }

    /**
     * Attempt the cached password against the passed lock.
     *
     * @param pLockBytes the Lock to test against
     * @param pPassword  the encrypted password
     * @return the new keySetLock if successful, otherwise null
     */
    private GordianKeySetLock attemptPasswordForKeySetLock(final byte[] pLockBytes,
                                                           final byte[] pPassword) {
        /* Protect against exceptions */
<span class="fc" id="L401">        byte[] myPasswordBytes = null;</span>
<span class="fc" id="L402">        char[] myPasswordChars = null;</span>
        try {
            /* Access the original password */
<span class="fc" id="L405">            myPasswordBytes = theKeySet.decryptBytes(pPassword);</span>
<span class="fc" id="L406">            myPasswordChars = OceanusDataConverter.bytesToCharArray(myPasswordBytes);</span>

            /* Try to resolve the lock and return it */
<span class="fc" id="L409">            return theLockFactory.resolveKeySetLock(pLockBytes, myPasswordChars);</span>

            /* Catch Exceptions */
<span class="nc" id="L412">        } catch (GordianException</span>
                 | OceanusException e) {
<span class="nc" id="L414">            LOGGER.error(PASSWORD_FAIL, e);</span>
<span class="nc" id="L415">            return null;</span>

<span class="fc" id="L417">        } catch (GordianBadCredentialsException e) {</span>
<span class="fc" id="L418">            return null;</span>

        } finally {
            /* Clear out password */
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="fc" id="L423">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">            if (myPasswordChars != null) {</span>
<span class="fc" id="L426">                Arrays.fill(myPasswordChars, (char) 0);</span>
            }
        }
    }

    /**
     * Attempt known passwords for keyPair lock.
     *
     * @param pLockBytes the lockBytes to attempt passwords for
     * @param pKeyPair   the keyPair
     * @return the new keyPairLock if successful, otherwise null
     */
    GordianKeyPairLock attemptKnownPasswordsForKeyPairLock(final byte[] pLockBytes,
                                                           final GordianKeyPair pKeyPair) {
        /* Loop through the passwords */
<span class="nc bnc" id="L441" title="All 2 branches missed.">        for (ByteBuffer myCurr : thePasswords) {</span>
            /* Attempt the password */
<span class="nc" id="L443">            final GordianKeyPairLock myKeyPair = attemptPasswordForKeyPairLock(pLockBytes, pKeyPair, myCurr.array());</span>

            /* If we succeeded */
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (myKeyPair != null) {</span>
                /* Add the factory to the list and return it */
<span class="nc" id="L448">                theLocks.add(new PrometheusLockCache&lt;&gt;(myKeyPair, myCurr));</span>
<span class="nc" id="L449">                return myKeyPair;</span>
            }
<span class="nc" id="L451">        }</span>

        /* Return null */
<span class="nc" id="L454">        return null;</span>
    }

    /**
     * Attempt the cached password against the passed lock.
     *
     * @param pLockBytes the Lock to test against
     * @param pKeyPair   the keyPair
     * @param pPassword  the encrypted password
     * @return the new keyPairLock if successful, otherwise null
     */
    private GordianKeyPairLock attemptPasswordForKeyPairLock(final byte[] pLockBytes,
                                                             final GordianKeyPair pKeyPair,
                                                             final byte[] pPassword) {
        /* Protect against exceptions */
<span class="nc" id="L469">        byte[] myPasswordBytes = null;</span>
<span class="nc" id="L470">        char[] myPasswordChars = null;</span>
        try {
            /* Access the original password */
<span class="nc" id="L473">            myPasswordBytes = theKeySet.decryptBytes(pPassword);</span>
<span class="nc" id="L474">            myPasswordChars = OceanusDataConverter.bytesToCharArray(myPasswordBytes);</span>

            /* Try to resolve the lock and return it */
<span class="nc" id="L477">            return theLockFactory.resolveKeyPairLock(pLockBytes, pKeyPair, myPasswordChars);</span>

            /* Catch Exceptions */
<span class="nc" id="L480">        } catch (GordianException</span>
                 | OceanusException e) {
<span class="nc" id="L482">            LOGGER.error(PASSWORD_FAIL, e);</span>
<span class="nc" id="L483">            return null;</span>

<span class="nc" id="L485">        } catch (GordianBadCredentialsException e) {</span>
<span class="nc" id="L486">            return null;</span>

        } finally {
            /* Clear out password */
<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="nc" id="L491">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
<span class="nc bnc" id="L493" title="All 2 branches missed.">            if (myPasswordChars != null) {</span>
<span class="nc" id="L494">                Arrays.fill(myPasswordChars, (char) 0);</span>
            }
        }
    }

    /**
     * Create a factoryLock with a previously used password.
     *
     * @param pFactory  the new factory
     * @param pPassword the encrypted password
     * @return the new factoryLock
     * @throws OceanusException on error
     */
    GordianFactoryLock createSimilarFactoryLock(final GordianFactory pFactory,
                                                final ByteBuffer pPassword) throws OceanusException {
        /* Protect against exceptions */
<span class="fc" id="L510">        byte[] myPasswordBytes = null;</span>
<span class="fc" id="L511">        char[] myPasswordChars = null;</span>
        try {
            /* Access the original password */
<span class="fc" id="L514">            myPasswordBytes = theKeySet.decryptBytes(pPassword.array());</span>
<span class="fc" id="L515">            myPasswordChars = OceanusDataConverter.bytesToCharArray(myPasswordBytes);</span>

            /* Create the new lock */
<span class="fc" id="L518">            final GordianFactoryLock myLock = theFactory.newFactoryLock(pFactory, theLockSpec, myPasswordChars);</span>

            /* Add the entry to the list and return the hash */
<span class="fc" id="L521">            theLocks.add(new PrometheusLockCache&lt;&gt;(myLock, pPassword));</span>
<span class="fc" id="L522">            return myLock;</span>

<span class="nc" id="L524">        } catch (GordianException e) {</span>
<span class="nc" id="L525">            throw new PrometheusSecurityException(e);</span>

        } finally {
            /* Clear out password */
<span class="pc bpc" id="L529" title="1 of 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="fc" id="L530">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">            if (myPasswordChars != null) {</span>
<span class="fc" id="L533">                Arrays.fill(myPasswordChars, (char) 0);</span>
            }
        }
    }

    /**
     * Create a keySetLock with a previously used password.
     *
     * @param pKeySet   the new keySet
     * @param pPassword the encrypted password
     * @return the new factoryLock
     * @throws OceanusException on error
     */
    GordianKeySetLock createSimilarKeySetLock(final GordianKeySet pKeySet,
                                              final ByteBuffer pPassword) throws OceanusException {
        /* Protect against exceptions */
<span class="fc" id="L549">        byte[] myPasswordBytes = null;</span>
<span class="fc" id="L550">        char[] myPasswordChars = null;</span>
        try {
            /* Access the original password */
<span class="fc" id="L553">            myPasswordBytes = theKeySet.decryptBytes(pPassword.array());</span>
<span class="fc" id="L554">            myPasswordChars = OceanusDataConverter.bytesToCharArray(myPasswordBytes);</span>

            /* Create the new lock */
<span class="fc" id="L557">            final GordianKeySetLock myLock = theLockFactory.newKeySetLock(pKeySet, theLockSpec, myPasswordChars);</span>

            /* Add the entry to the list and return the hash */
<span class="fc" id="L560">            theLocks.add(new PrometheusLockCache&lt;&gt;(myLock, pPassword));</span>
<span class="fc" id="L561">            return myLock;</span>

<span class="nc" id="L563">        } catch (GordianException e) {</span>
<span class="nc" id="L564">            throw new PrometheusSecurityException(e);</span>

        } finally {
            /* Clear out password */
<span class="pc bpc" id="L568" title="1 of 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="fc" id="L569">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">            if (myPasswordChars != null) {</span>
<span class="fc" id="L572">                Arrays.fill(myPasswordChars, (char) 0);</span>
            }
        }
    }

    /**
     * Create a zipLock with a previously used password.
     *
     * @param pKeyPair  the keyPair
     * @param pPassword the encrypted password
     * @return the new PasswordHash
     * @throws OceanusException on error
     */
    GordianKeyPairLock createSimilarKeyPairLock(final GordianKeyPair pKeyPair,
                                                final ByteBuffer pPassword) throws OceanusException {
        /* Protect against exceptions */
<span class="nc" id="L588">        byte[] myPasswordBytes = null;</span>
<span class="nc" id="L589">        char[] myPasswordChars = null;</span>
        try {
            /* Access the original password */
<span class="nc" id="L592">            myPasswordBytes = theKeySet.decryptBytes(pPassword.array());</span>
<span class="nc" id="L593">            myPasswordChars = OceanusDataConverter.bytesToCharArray(myPasswordBytes);</span>

            /* Create the similar passwordLock and return it */
<span class="nc" id="L596">            return theLockFactory.newKeyPairLock(theLockSpec, pKeyPair, myPasswordChars);</span>

<span class="nc" id="L598">        } catch (GordianException e) {</span>
<span class="nc" id="L599">            throw new PrometheusSecurityException(e);</span>

        } finally {
            /* Clear out password */
<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (myPasswordBytes != null) {</span>
<span class="nc" id="L604">                Arrays.fill(myPasswordBytes, (byte) 0);</span>
            }
<span class="nc bnc" id="L606" title="All 2 branches missed.">            if (myPasswordChars != null) {</span>
<span class="nc" id="L607">                Arrays.fill(myPasswordChars, (char) 0);</span>
            }
        }
    }

    /**
     * The lockCache.
     *
     * @param &lt;T&gt; the locked object
     *
     */
    static class PrometheusLockCache&lt;T&gt; {
        /**
         * The FactoryLock.
         */
        private final GordianLock&lt;T&gt; theLock;

        /**
         * The Encrypted password.
         */
        private final ByteBuffer thePassword;

        /**
         * Constructor.
         *
         * @param pLock     the Lock
         * @param pPassword the encrypted password
         */
        PrometheusLockCache(final GordianLock&lt;T&gt; pLock,
<span class="fc" id="L636">                            final ByteBuffer pPassword) {</span>
<span class="fc" id="L637">            theLock = pLock;</span>
<span class="fc" id="L638">            thePassword = pPassword;</span>
<span class="fc" id="L639">        }</span>

        /**
         * Obtain the lock.
         *
         * @return the Lock
         */
        GordianLock&lt;T&gt; getLock() {
<span class="fc" id="L647">            return theLock;</span>
        }

        /**
         * Obtain the encrypted password.
         *
         * @return the password
         */
        ByteBuffer getPassword() {
<span class="fc" id="L656">            return thePassword;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>