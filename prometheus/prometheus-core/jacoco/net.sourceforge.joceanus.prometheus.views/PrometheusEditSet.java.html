<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusEditSet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.prometheus.views</a> &gt; <span class="el_source">PrometheusEditSet.java</span></div><h1>PrometheusEditSet.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Prometheus: Application Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.prometheus.views;

import net.sourceforge.joceanus.metis.data.MetisDataEditState;
import net.sourceforge.joceanus.metis.field.MetisFieldItem;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.metis.list.MetisListKey;
import net.sourceforge.joceanus.metis.ui.MetisErrorPanel;
import net.sourceforge.joceanus.metis.viewer.MetisViewerErrorList;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.event.OceanusEventManager;
import net.sourceforge.joceanus.oceanus.event.OceanusEventRegistrar;
import net.sourceforge.joceanus.oceanus.event.OceanusEventRegistrar.OceanusEventProvider;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.oceanus.logger.OceanusLogManager;
import net.sourceforge.joceanus.oceanus.logger.OceanusLogger;
import net.sourceforge.joceanus.oceanus.profile.OceanusProfile;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataList;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataList.PrometheusDataListSet;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataResource;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataSet;

import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;

/**
 * Provides control of a set of update-able DataLists.
 */
public class PrometheusEditSet
        implements MetisFieldItem, OceanusEventProvider&lt;PrometheusDataEvent&gt;, PrometheusDataListSet {
    /**
     * Report fields.
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc" id="L52">    private static final MetisFieldSet&lt;PrometheusEditSet&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(PrometheusEditSet.class);</span>

    /*
     * Declare Fields.
     */
    static {
<span class="nc" id="L58">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATASET_VERSION, PrometheusEditSet::getVersion);</span>
    }

    /**
     * Logger.
     */
<span class="nc" id="L64">    private static final OceanusLogger LOGGER = OceanusLogManager.getLogger(PrometheusEditSet.class);</span>

    /**
     * The Event Manager.
     */
    private final OceanusEventManager&lt;PrometheusDataEvent&gt; theEventManager;

    /**
     * Report fields.
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
    private final MetisFieldSet&lt;PrometheusEditSet&gt; theLocalFields;

    /**
     * The entry map.
     */
    private final Map&lt;MetisListKey, PrometheusEditEntry&lt;?&gt;&gt; theMap;

    /**
     * The DataControl.
     */
    private final PrometheusDataControl theControl;

    /**
     * The DataSet.
     */
    private PrometheusDataSet theDataSet;

    /**
     * The version.
     */
    private int theVersion;

    /**
     * Are we editing?
     */
<span class="nc" id="L100">    private Boolean itemEditing = Boolean.FALSE;</span>

    /**
     * Constructor for an update list.
     * @param pControl the Data Control
     */
    public PrometheusEditSet(final PrometheusDataControl pControl) {
<span class="nc" id="L107">        this(pControl, pControl.getData());</span>
<span class="nc" id="L108">    }</span>

    /**
     * Constructor for an update list.
     * @param pControl the Data Control
     * @param pDataSet the DataSet
     */
    public PrometheusEditSet(final PrometheusDataControl pControl,
<span class="nc" id="L116">                             final PrometheusDataSet pDataSet) {</span>
        /* Store the Control */
<span class="nc" id="L118">        theControl = pControl;</span>
<span class="nc" id="L119">        theDataSet = pDataSet;</span>

        /* Create event manager */
<span class="nc" id="L122">        theEventManager = new OceanusEventManager&lt;&gt;();</span>

        /* Create local fields */
<span class="nc" id="L125">        theLocalFields = MetisFieldSet.newFieldSet(this);</span>

        /* Create the map */
<span class="nc" id="L128">        theMap = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L129">    }</span>

    @SuppressWarnings(&quot;rawtypes&quot;)
    @Override
    public MetisFieldSet&lt;PrometheusEditSet&gt; getDataFieldSet() {
<span class="nc" id="L134">        return theLocalFields;</span>
    }

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L139">        return getDataFieldSet().getName();</span>
    }

    @Override
    public OceanusEventRegistrar&lt;PrometheusDataEvent&gt; getEventRegistrar() {
<span class="nc" id="L144">        return theEventManager.getEventRegistrar();</span>
    }

    /**
     * Set editing flag.
     * @param pFlag the editing flag
     */
    public void setEditing(final Boolean pFlag) {
<span class="nc" id="L152">        itemEditing = pFlag;</span>
<span class="nc" id="L153">    }</span>

    /**
     * Is the item editing?
     * @return true/false
     */
    public Boolean isEditing() {
<span class="nc" id="L160">        return itemEditing;</span>
    }

    /**
     * Obtain the version.
     * @return the version
     */
    public int getVersion() {
<span class="nc" id="L168">        return theVersion;</span>
    }

    /**
     * Obtain the dataSet.
     * @return the dataSet
     */
    public PrometheusDataSet getDataSet() {
<span class="nc" id="L176">        return theDataSet;</span>
    }

    /**
     * Set the dataSet.
     * @param pDataSet the dataSet
     */
    public void setDataSet(final PrometheusDataSet pDataSet) {
<span class="nc" id="L184">        theDataSet = pDataSet;</span>
<span class="nc" id="L185">    }</span>

    /**
     * Register an entry for a class.
     * @param &lt;T&gt; the object type
     * @param pDataType the data type
     * @return the list class entry
     */
    public &lt;T extends PrometheusDataItem&gt; PrometheusEditEntry&lt;T&gt; registerType(final MetisListKey pDataType) {
        /* Locate any existing entry */
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L196">        final PrometheusEditEntry&lt;T&gt; myEntry = (PrometheusEditEntry&lt;T&gt;) theMap.computeIfAbsent(pDataType, t -&gt; {</span>
            /* Not found , so add it */
<span class="nc" id="L198">            final PrometheusEditEntry&lt;T&gt; myNewEntry = new PrometheusEditEntry&lt;&gt;(t);</span>
<span class="nc" id="L199">            theLocalFields.declareLocalField(myNewEntry.getName(), n -&gt; myNewEntry);</span>
<span class="nc" id="L200">            return myNewEntry;</span>
        });

        /* Update list to null and return */
<span class="nc" id="L204">        myEntry.setDataList(null);</span>
<span class="nc" id="L205">        return myEntry;</span>
    }

    /**
     * Obtain the list for a class.
     * &lt;p&gt;
     * Will look first for the list in the updateSet and then in the underlying data.
     * @param &lt;L&gt; the list type
     * @param pDataType the data type
     * @param pClass the list class
     * @return the list
     */
    @Override
    public &lt;L extends PrometheusDataList&lt;?&gt;&gt; L getDataList(final MetisListKey pDataType,
                                                           final Class&lt;L&gt; pClass) {
        /* Locate an existing entry */
<span class="nc" id="L221">        final PrometheusEditEntry&lt;?&gt; myEntry = theMap.get(pDataType);</span>

        /* Cast correctly */
<span class="nc bnc" id="L224" title="All 2 branches missed.">        return myEntry != null</span>
<span class="nc" id="L225">                ? pClass.cast(myEntry.getDataList())</span>
<span class="nc" id="L226">                : theDataSet.getDataList(pDataType, pClass);</span>
    }

    @Override
    public boolean hasDataType(final MetisListKey pDataType) {
<span class="nc" id="L231">        return theMap.containsKey(pDataType);</span>
    }

    /**
     * Set the editEntry for a type.
     * @param &lt;T&gt; the dataType
     * @param pDataType the data type
     * @param pList the list
     */
    public &lt;T extends PrometheusDataItem&gt; void setEditEntryList(final MetisListKey pDataType,
                                                                final PrometheusDataList&lt;T&gt; pList) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L243">        final PrometheusEditEntry&lt;T&gt; myEntry = (PrometheusEditEntry&lt;T&gt;) theMap.get(pDataType);</span>
<span class="nc" id="L244">        myEntry.setDataList(pList);</span>
<span class="nc" id="L245">    }</span>

    /**
     * Obtain an iterator over the listKeys.
     * @return the iterator
     */
    public Iterator&lt;MetisListKey&gt; keyIterator() {
<span class="nc" id="L252">        return theMap.keySet().iterator();</span>
    }

    /**
     * Obtain an iterator over the listKeys.
     * @return the iterator
     */
    public Iterator&lt;PrometheusEditEntry&lt;?&gt;&gt; listIterator() {
<span class="nc" id="L260">        return theMap.values().iterator();</span>
    }

    /**
     * Increment Version.
     */
    public void incrementVersion() {
        /* Obtain the active profile */
<span class="nc" id="L268">        final OceanusProfile myTask = theControl.getActiveTask();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        final OceanusProfile mySubTask = myTask == null</span>
<span class="nc" id="L270">                ? theControl.getNewProfile(&quot;incrementVersion&quot;)</span>
<span class="nc" id="L271">                : myTask.startTask(&quot;incrementVersion&quot;);</span>

        /* Increment the version */
<span class="nc" id="L274">        theVersion++;</span>

        /* Loop through the items in the list */
<span class="nc bnc" id="L277" title="All 2 branches missed.">        for (PrometheusEditEntry&lt;?&gt; myEntry : theMap.values()) {</span>
            /* Access list */
<span class="nc" id="L279">            final PrometheusDataList&lt;?&gt; myDataList = myEntry.getDataList();</span>

            /* Increment the version if the list exists */
<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (myDataList != null) {</span>
                /* Note the new step */
<span class="nc" id="L284">                mySubTask.startTask(myDataList.listName());</span>

                /* Set the new version */
<span class="nc" id="L287">                myDataList.setVersion(theVersion);</span>

                /* postProcess */
<span class="nc bnc" id="L290" title="All 2 branches missed.">                if (Boolean.FALSE.equals(itemEditing)) {</span>
<span class="nc" id="L291">                    myDataList.postProcessOnUpdate();</span>
                }
            }
<span class="nc" id="L294">        }</span>

        /* Complete the task */
<span class="nc" id="L297">        mySubTask.end();</span>
<span class="nc" id="L298">    }</span>

    /**
     * Rewind items to the required version.
     * @param pVersion the version to rewind to
     */
    private void rewindToVersion(final int pVersion) {
        /* Obtain the active profile */
<span class="nc" id="L306">        final OceanusProfile myTask = theControl.getActiveTask();</span>
<span class="nc" id="L307">        OceanusProfile mySubTask = myTask.startTask(&quot;reWindToVersion&quot;);</span>

        /* Record the version */
<span class="nc" id="L310">        theVersion = pVersion;</span>

        /* Loop through the items in the list */
<span class="nc" id="L313">        Iterator&lt;PrometheusEditEntry&lt;?&gt;&gt; myIterator = theMap.values().iterator();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
            /* Access list */
<span class="nc" id="L316">            final PrometheusEditEntry&lt;?&gt; myEntry = myIterator.next();</span>
<span class="nc" id="L317">            final PrometheusDataList&lt;?&gt; myDataList = myEntry.getDataList();</span>

            /* If the list exists */
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (myDataList != null) {</span>
                /* Note the new step */
<span class="nc" id="L322">                mySubTask.startTask(myDataList.listName());</span>

                /* Rewind the version */
<span class="nc" id="L325">                myDataList.rewindToVersion(theVersion);</span>
            }
<span class="nc" id="L327">        }</span>

        /* Need to validate after full reWind to avoid false errors */
<span class="nc" id="L330">        mySubTask = myTask.startTask(&quot;postProcess&quot;);</span>
<span class="nc" id="L331">        myIterator = theMap.values().iterator();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
            /* Access list */
<span class="nc" id="L334">            final PrometheusEditEntry&lt;?&gt; myEntry = myIterator.next();</span>
<span class="nc" id="L335">            final PrometheusDataList&lt;?&gt; myDataList = myEntry.getDataList();</span>

            /* If the list exists */
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (myDataList != null) {</span>
                /* Note the new step */
<span class="nc" id="L340">                mySubTask.startTask(myDataList.listName());</span>

                /* postProcess */
<span class="nc bnc" id="L343" title="All 2 branches missed.">                if (Boolean.FALSE.equals(itemEditing)) {</span>
<span class="nc" id="L344">                    myDataList.postProcessOnUpdate();</span>
                }
            }
<span class="nc" id="L347">        }</span>

        /* Note the new step */
<span class="nc" id="L350">        mySubTask = myTask.startTask(&quot;Notify&quot;);</span>

        /* Fire that we have rewound the updateSet */
<span class="nc" id="L353">        theEventManager.fireEvent(PrometheusDataEvent.DATACHANGED);</span>

        /* Complete the task */
<span class="nc" id="L356">        mySubTask.end();</span>
<span class="nc" id="L357">    }</span>

    /**
     * Undo changes in a viewSet.
     */
    private void undoLastChange() {
        /* Ignore if we have no changes */
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (theVersion == 0) {</span>
<span class="nc" id="L365">            return;</span>
        }

        /* Decrement version */
<span class="nc" id="L369">        theVersion--;</span>

        /* Rewind to the version */
<span class="nc" id="L372">        rewindToVersion(theVersion);</span>
<span class="nc" id="L373">    }</span>

    /**
     * Reset changes in a viewSet.
     */
    private void resetChanges() {
        /* Ignore if we have no changes */
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (theVersion == 0) {</span>
<span class="nc" id="L381">            return;</span>
        }

        /* Decrement version */
<span class="nc" id="L385">        theVersion = 0;</span>

        /* Rewind to the version */
<span class="nc" id="L388">        rewindToVersion(theVersion);</span>
<span class="nc" id="L389">    }</span>

    /**
     * Apply changes in a ViewSet into the core data.
     */
    private void applyChanges() {
        /* Obtain the active profile */
<span class="nc" id="L396">        final OceanusProfile myTask = theControl.getActiveTask();</span>
<span class="nc" id="L397">        final OceanusProfile mySubTask = myTask.startTask(&quot;applyChanges&quot;);</span>

        /* Validate the changes */
<span class="nc" id="L400">        validate();</span>

        /* Reject request if there are errors */
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (hasErrors()) {</span>
            /* We have finished */
<span class="nc" id="L405">            mySubTask.startTask(&quot;Notify&quot;);</span>

            /* Fire that we have rewound the updateSet */
<span class="nc" id="L408">            theEventManager.fireEvent(PrometheusDataEvent.DATACHANGED);</span>

            /* Complete the task */
<span class="nc" id="L411">            mySubTask.end();</span>
<span class="nc" id="L412">            return;</span>
        }

        /* Apply the changes */
<span class="nc" id="L416">        boolean bSuccess = prepareChanges();</span>

        /* analyse the data */
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (bSuccess) {</span>
            /* Analyse the applied changes */
<span class="nc" id="L421">            bSuccess = theControl.analyseData(false);</span>
        }

        /* If we were successful */
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (bSuccess) {</span>
            /* Commit the changes */
<span class="nc" id="L427">            commitChanges();</span>

            /* Refresh views */
<span class="nc" id="L430">            theControl.refreshViews();</span>

            /* else we failed */
        } else {
            /* RollBack the changes */
<span class="nc" id="L435">            rollBackChanges();</span>

            /* Re-analyse the data */
<span class="nc" id="L438">            theControl.analyseData(true);</span>
        }

        /* Complete the task */
<span class="nc" id="L442">        mySubTask.end();</span>
<span class="nc" id="L443">    }</span>

    /**
     * Prepare changes in a ViewSet back into the core data.
     * @return success true/false
     */
    private boolean prepareChanges() {
        /* Obtain the active profile */
<span class="nc" id="L451">        final OceanusProfile myTask = theControl.getActiveTask();</span>
<span class="nc" id="L452">        final OceanusProfile mySubTask = myTask.startTask(&quot;prepareChanges&quot;);</span>
<span class="nc" id="L453">        boolean bSuccess = true;</span>

        /* Protect against exceptions */
        try {
            /* Loop through the items in the list */
<span class="nc bnc" id="L458" title="All 2 branches missed.">            for (PrometheusEditEntry&lt;?&gt; myEntry : theMap.values()) {</span>
                /* Note the new step */
<span class="nc" id="L460">                mySubTask.startTask(myEntry.getName());</span>

                /* Prepare changes for the entry */
<span class="nc" id="L463">                myEntry.prepareChanges();</span>
<span class="nc" id="L464">            }</span>

<span class="nc" id="L466">        } catch (OceanusException e) {</span>
<span class="nc" id="L467">            LOGGER.error(&quot;Failed to prepare changes&quot;, e);</span>
<span class="nc" id="L468">            bSuccess = false;</span>
<span class="nc" id="L469">        }</span>

        /* Complete the task */
<span class="nc" id="L472">        mySubTask.end();</span>
<span class="nc" id="L473">        return bSuccess;</span>
    }

    /**
     * Commit changes in a ViewSet back into the core data.
     */
    private void commitChanges() {
        /* Obtain the active profile */
<span class="nc" id="L481">        final OceanusProfile myTask = theControl.getActiveTask();</span>
<span class="nc" id="L482">        final OceanusProfile mySubTask = myTask.startTask(&quot;commitChanges&quot;);</span>

        /* Loop through the items in the list */
<span class="nc bnc" id="L485" title="All 2 branches missed.">        for (PrometheusEditEntry&lt;?&gt; myEntry : theMap.values()) {</span>
            /* Note the new step */
<span class="nc" id="L487">            mySubTask.startTask(myEntry.getName());</span>

            /* Commit changes for the entry */
<span class="nc" id="L490">            myEntry.commitChanges();</span>
<span class="nc" id="L491">        }</span>

        /* Increment the version and notify listeners */
<span class="nc" id="L494">        theControl.incrementVersion();</span>
<span class="nc" id="L495">        theVersion = 0;</span>

        /* Complete the task */
<span class="nc" id="L498">        mySubTask.end();</span>
<span class="nc" id="L499">    }</span>

    /**
     * RollBack changes in a ViewSet back into the core data.
     */
    private void rollBackChanges() {
        /* Obtain the active profile */
<span class="nc" id="L506">        final OceanusProfile myTask = theControl.getActiveTask();</span>
<span class="nc" id="L507">        final OceanusProfile mySubTask = myTask.startTask(&quot;rollBackChanges&quot;);</span>

        /* Loop through the items in the list */
<span class="nc bnc" id="L510" title="All 2 branches missed.">        for (PrometheusEditEntry&lt;?&gt; myEntry : theMap.values()) {</span>
            /* Note the new step */
<span class="nc" id="L512">            mySubTask.startTask(myEntry.getName());</span>

            /* RollBack changes for the entry */
<span class="nc" id="L515">            myEntry.rollBackChanges();</span>
<span class="nc" id="L516">        }</span>

        /* Complete the task */
<span class="nc" id="L519">        mySubTask.end();</span>
<span class="nc" id="L520">    }</span>

    /**
     * Has this UpdateSet got updates?
     * @return true/false
     */
    public boolean hasUpdates() {
        /* We have changes if version is non-zero */
<span class="nc bnc" id="L528" title="All 2 branches missed.">        return theVersion != 0;</span>
    }

    /**
     * Has this UpdateSet got errors?
     * @return true/false
     */
    public boolean hasErrors() {
        /* Loop through the items in the list */
<span class="nc bnc" id="L537" title="All 2 branches missed.">        for (PrometheusEditEntry&lt;?&gt; myEntry : theMap.values()) {</span>
            /* Access entry */
<span class="nc" id="L539">            final PrometheusDataList&lt;?&gt; myDataList = myEntry.getDataList();</span>

            /* Determine whether there are errors */
<span class="nc bnc" id="L542" title="All 4 branches missed.">            if (myDataList != null &amp;&amp; myDataList.hasErrors()) {</span>
<span class="nc" id="L543">                return true;</span>
            }
<span class="nc" id="L545">        }</span>

        /* Return to caller */
<span class="nc" id="L548">        return false;</span>
    }

    /**
     * Validate the updateSet.
     */
    public void validate() {
        /* Obtain the active profile */
<span class="nc" id="L556">        final OceanusProfile myTask = theControl.getActiveTask();</span>
<span class="nc" id="L557">        final OceanusProfile mySubTask = myTask.startTask(&quot;validate&quot;);</span>

        /* Loop through the items in the list */
<span class="nc bnc" id="L560" title="All 2 branches missed.">        for (PrometheusEditEntry&lt;?&gt; myEntry : theMap.values()) {</span>
            /* Access list */
<span class="nc" id="L562">            final PrometheusDataList&lt;?&gt; myDataList = myEntry.getDataList();</span>

            /* if list exists */
<span class="nc bnc" id="L565" title="All 2 branches missed.">            if (myDataList != null) {</span>
                /* Note the new step */
<span class="nc" id="L567">                mySubTask.startTask(myDataList.listName());</span>

                /* Validate */
<span class="nc" id="L570">                myDataList.validate();</span>
            }
<span class="nc" id="L572">        }</span>

        /* Complete the task */
<span class="nc" id="L575">        mySubTask.end();</span>
<span class="nc" id="L576">    }</span>

    /**
     * Get the edit state of this set of tables.
     * @return the edit state
     */
    public MetisDataEditState getEditState() {
        /* Loop through the items in the list */
<span class="nc" id="L584">        final Iterator&lt;PrometheusEditEntry&lt;?&gt;&gt; myIterator = theMap.values().iterator();</span>
<span class="nc" id="L585">        MetisDataEditState myState = MetisDataEditState.CLEAN;</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
            /* Access list */
<span class="nc" id="L588">            final PrometheusEditEntry&lt;?&gt; myEntry = myIterator.next();</span>
<span class="nc" id="L589">            final PrometheusDataList&lt;?&gt; myDataList = myEntry.getDataList();</span>

            /* Combine states if list exists */
<span class="nc bnc" id="L592" title="All 2 branches missed.">            if (myDataList != null) {</span>
<span class="nc" id="L593">                myState = myState.combineState(myDataList.getEditState());</span>
            }
<span class="nc" id="L595">        }</span>

        /* Return the state */
<span class="nc" id="L598">        return myState;</span>
    }

    /**
     * Process Save command.
     * @param pCmd the command.
     * @param pError the error panel
     */
    public void processCommand(final PrometheusUIEvent pCmd,
                               final MetisErrorPanel pError) {
        /* Create a new profile */
<span class="nc" id="L609">        final OceanusProfile myTask = theControl.getNewProfile(&quot;EditCommand&quot;);</span>

        /* Switch on command */
<span class="nc bnc" id="L612" title="All 4 branches missed.">        switch (pCmd) {</span>
            case OK:
<span class="nc" id="L614">                applyChanges();</span>
<span class="nc" id="L615">                break;</span>
            case UNDO:
<span class="nc" id="L617">                undoLastChange();</span>
<span class="nc" id="L618">                break;</span>
            case RESET:
<span class="nc" id="L620">                resetChanges();</span>
<span class="nc" id="L621">                break;</span>
            default:
                break;
        }

        /* Access any error */
<span class="nc" id="L627">        final MetisViewerErrorList myErrors = theControl.getErrors();</span>

        /* Show the error */
<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (!myErrors.isEmpty()) {</span>
<span class="nc" id="L631">            pError.setErrors(myErrors);</span>
        }

        /* Complete the task */
<span class="nc" id="L635">        myTask.end();</span>
<span class="nc" id="L636">    }</span>

    /**
     * Process Edit command.
     * @param pCmd the command.
     * @param pVersion the version
     * @param pError the error panel
     */
    public void processEditCommand(final PrometheusUIEvent pCmd,
                                   final int pVersion,
                                   final MetisErrorPanel pError) {
        /* Create a new profile */
<span class="nc" id="L648">        final OceanusProfile myTask = theControl.getNewProfile(&quot;ItemCommand&quot;);</span>

        /* Switch on command */
<span class="nc bnc" id="L651" title="All 4 branches missed.">        switch (pCmd) {</span>
            case OK:
<span class="nc" id="L653">                condenseHistory(pVersion);</span>
<span class="nc" id="L654">                break;</span>
            case UNDO:
<span class="nc" id="L656">                undoLastChange();</span>
<span class="nc" id="L657">                break;</span>
            case REWIND:
<span class="nc" id="L659">                rewindToVersion(pVersion);</span>
<span class="nc" id="L660">                break;</span>
            default:
                break;
        }

        /* Access any error */
<span class="nc" id="L666">        final MetisViewerErrorList myErrors = theControl.getErrors();</span>

        /* Show the error */
<span class="nc bnc" id="L669" title="All 2 branches missed.">        if (!myErrors.isEmpty()) {</span>
<span class="nc" id="L670">            pError.setErrors(myErrors);</span>
        }

        /* Complete the task */
<span class="nc" id="L674">        myTask.end();</span>
<span class="nc" id="L675">    }</span>

    /**
     * Condense history.
     * @param pNewVersion the new maximum version
     */
    private void condenseHistory(final int pNewVersion) {
        /* Obtain the active profile */
<span class="nc" id="L683">        final OceanusProfile myTask = theControl.getActiveTask();</span>
<span class="nc" id="L684">        final OceanusProfile mySubTask = myTask.startTask(&quot;condenseHistory&quot;);</span>

        /* Loop through the items in the list */
<span class="nc bnc" id="L687" title="All 2 branches missed.">        for (PrometheusEditEntry&lt;?&gt; myEntry : theMap.values()) {</span>
            /* Access list */
<span class="nc" id="L689">            final PrometheusDataList&lt;?&gt; myDataList = myEntry.getDataList();</span>

            /* Condense history in the list */
<span class="nc bnc" id="L692" title="All 2 branches missed.">            if (myDataList != null) {</span>
                /* Note the new step */
<span class="nc" id="L694">                final OceanusProfile myListTask = mySubTask.startTask(myDataList.listName());</span>
<span class="nc" id="L695">                myListTask.startTask(&quot;Condense&quot;);</span>

                /* Condense history */
<span class="nc" id="L698">                myDataList.condenseHistory(pNewVersion);</span>

                /* postProcess */
<span class="nc bnc" id="L701" title="All 2 branches missed.">                if (Boolean.FALSE.equals(itemEditing)) {</span>
<span class="nc" id="L702">                    myListTask.startTask(&quot;postProcess&quot;);</span>
<span class="nc" id="L703">                    myDataList.postProcessOnUpdate();</span>
                }
            }
<span class="nc" id="L706">        }</span>

        /* Store version */
<span class="nc" id="L709">        theVersion = pNewVersion;</span>

        /* Fire that we have added to updateSet */
<span class="nc" id="L712">        theEventManager.fireEvent(PrometheusDataEvent.DATACHANGED);</span>

        /* Complete the task */
<span class="nc" id="L715">        mySubTask.end();</span>
<span class="nc" id="L716">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>