<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusTableDefinition.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.prometheus.database</a> &gt; <span class="el_source">PrometheusTableDefinition.java</span></div><h1>PrometheusTableDefinition.java</h1><pre class="source lang-java linenums">/*
 * Prometheus: Application Framework
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.prometheus.database;

import io.github.tonywasher.joceanus.gordianknot.util.GordianUtilities;
import io.github.tonywasher.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.date.OceanusDate;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusMoney;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusPrice;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusRate;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusRatio;
import io.github.tonywasher.joceanus.oceanus.decimal.OceanusUnits;
import io.github.tonywasher.joceanus.oceanus.format.OceanusDataFormatter;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusBinaryColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusBooleanColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusDateColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusIdColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusIntegerColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusLongColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusMoneyColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusPriceColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusRateColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusRatioColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusReferenceColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusStringColumn;
import io.github.tonywasher.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusUnitsColumn;
import io.github.tonywasher.joceanus.prometheus.exc.PrometheusLogicException;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * Database field definition class. Maps each dataType to a database field.
 */
public class PrometheusTableDefinition {
    /**
     * The index prefix.
     */
    private static final String PREFIX_INDEX = &quot;idx_&quot;;

    /**
     * The quote string.
     */
    protected static final String QUOTE_STRING = &quot;\&quot;&quot;;

    /**
     * The Descending string.
     */
    protected static final String STR_DESC = &quot; DESC&quot;;

    /**
     * The Buffer length.
     */
    private static final int BUFFER_LEN = 1000;

    /**
     * The Table name.
     */
    private final String theTableName;

    /**
     * The Database driver.
     */
    private final PrometheusJDBCDriver theDriver;

    /**
     * The Column Definitions.
     */
    private final List&lt;PrometheusColumnDefinition&gt; theList;

    /**
     * The Sort List.
     */
    private final List&lt;PrometheusColumnDefinition&gt; theSortList;

    /**
     * Are we sorting on a reference column.
     */
    private boolean sortOnReference;

    /**
     * The array list for the columns.
     */
    private final Map&lt;MetisDataFieldId, PrometheusColumnDefinition&gt; theMap;

    /**
     * The prepared statement for the insert/update.
     */
    private PreparedStatement theStatement;

    /**
     * Constructor.
     *
     * @param pDriver the driver
     * @param pName   the table name
     */
    protected PrometheusTableDefinition(final PrometheusJDBCDriver pDriver,
<span class="nc" id="L119">                                        final String pName) {</span>
        /* Record the name and driver */
<span class="nc" id="L121">        theTableName = pName;</span>
<span class="nc" id="L122">        theDriver = pDriver;</span>

        /* Create the column list */
<span class="nc" id="L125">        theList = new ArrayList&lt;&gt;();</span>

        /* Create the sort list */
<span class="nc" id="L128">        theSortList = new ArrayList&lt;&gt;();</span>

        /* Create the initial column map */
<span class="nc" id="L131">        theMap = new HashMap&lt;&gt;();</span>

        /* Add an Id column */
<span class="nc" id="L134">        theList.add(new PrometheusIdColumn(this));</span>
<span class="nc" id="L135">    }</span>

    /**
     * Obtain the table name.
     *
     * @return the table name
     */
    protected String getTableName() {
<span class="nc" id="L143">        return theTableName;</span>
    }

    /**
     * Obtain the column map.
     *
     * @return the map
     */
    protected Map&lt;MetisDataFieldId, PrometheusColumnDefinition&gt; getMap() {
<span class="nc" id="L152">        return theMap;</span>
    }

    /**
     * Is the table indexed.
     *
     * @return true/false
     */
    protected boolean isIndexed() {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        return !theSortList.isEmpty();</span>
    }

    /**
     * Column Definitions array.
     *
     * @return the columns
     */
    protected List&lt;PrometheusColumnDefinition&gt; getColumns() {
<span class="nc" id="L170">        return theList;</span>
    }

    /**
     * Sort List.
     *
     * @return the sort list
     */
    protected List&lt;PrometheusColumnDefinition&gt; getSortList() {
<span class="nc" id="L179">        return theSortList;</span>
    }

    /**
     * Obtain the driver.
     *
     * @return the driver
     */
    protected PrometheusJDBCDriver getDriver() {
<span class="nc" id="L188">        return theDriver;</span>
    }

    /**
     * Note that we have a sort on reference.
     */
    protected void setSortOnReference() {
<span class="nc" id="L195">        sortOnReference = true;</span>
<span class="nc" id="L196">    }</span>

    /**
     * Add a reference column.
     *
     * @param pId  the column id
     * @param pRef the reference table
     * @return the reference column
     */
    public PrometheusReferenceColumn addReferenceColumn(final MetisDataFieldId pId,
                                                        final String pRef) {
        /* Create the new reference column */
<span class="nc" id="L208">        final PrometheusReferenceColumn myColumn = new PrometheusReferenceColumn(this, pId, pRef);</span>

        /* Add it to the list and return it */
<span class="nc" id="L211">        theList.add(myColumn);</span>
<span class="nc" id="L212">        return myColumn;</span>
    }

    /**
     * Add a reference column, which can be null.
     *
     * @param pId  the column id
     * @param pRef the reference table
     * @return the reference column
     */
    public PrometheusReferenceColumn addNullReferenceColumn(final MetisDataFieldId pId,
                                                            final String pRef) {
<span class="nc" id="L224">        final PrometheusReferenceColumn myColumn = addReferenceColumn(pId, pRef);</span>
<span class="nc" id="L225">        myColumn.setNullable();</span>
<span class="nc" id="L226">        return myColumn;</span>
    }

    /**
     * Add an integer column.
     *
     * @param pId the column id
     * @return the integer column
     */
    public PrometheusIntegerColumn addIntegerColumn(final MetisDataFieldId pId) {
        /* Create the new integer column */
<span class="nc" id="L237">        final PrometheusIntegerColumn myColumn = new PrometheusIntegerColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L240">        theList.add(myColumn);</span>
<span class="nc" id="L241">        return myColumn;</span>
    }

    /**
     * Add an integer column, which can be null.
     *
     * @param pId the column id
     * @return the integer column
     */
    public PrometheusIntegerColumn addNullIntegerColumn(final MetisDataFieldId pId) {
<span class="nc" id="L251">        final PrometheusIntegerColumn myColumn = addIntegerColumn(pId);</span>
<span class="nc" id="L252">        myColumn.setNullable();</span>
<span class="nc" id="L253">        return myColumn;</span>
    }

    /**
     * Add a long column.
     *
     * @param pId the column id
     * @return the long column
     */
    public PrometheusLongColumn addLongColumn(final MetisDataFieldId pId) {
        /* Create the new long column */
<span class="nc" id="L264">        final PrometheusLongColumn myColumn = new PrometheusLongColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L267">        theList.add(myColumn);</span>
<span class="nc" id="L268">        return myColumn;</span>
    }

    /**
     * Add a long column, which can be null.
     *
     * @param pId the column id
     * @return the long column
     */
    public PrometheusLongColumn addNullLongColumn(final MetisDataFieldId pId) {
<span class="nc" id="L278">        final PrometheusLongColumn myColumn = addLongColumn(pId);</span>
<span class="nc" id="L279">        myColumn.setNullable();</span>
<span class="nc" id="L280">        return myColumn;</span>
    }

    /**
     * Add a boolean column.
     *
     * @param pId the column id
     * @return the boolean column
     */
    public PrometheusBooleanColumn addBooleanColumn(final MetisDataFieldId pId) {
        /* Create the new boolean column */
<span class="nc" id="L291">        final PrometheusBooleanColumn myColumn = new PrometheusBooleanColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L294">        theList.add(myColumn);</span>
<span class="nc" id="L295">        return myColumn;</span>
    }

    /**
     * Add a boolean column, which can be null.
     *
     * @param pId the column id
     * @return the boolean column
     */
    public PrometheusBooleanColumn addNullBooleanColumn(final MetisDataFieldId pId) {
<span class="nc" id="L305">        final PrometheusBooleanColumn myColumn = addBooleanColumn(pId);</span>
<span class="nc" id="L306">        myColumn.setNullable();</span>
<span class="nc" id="L307">        return myColumn;</span>
    }

    /**
     * Add a date column.
     *
     * @param pId the column id
     * @return the date column
     */
    public PrometheusDateColumn addDateColumn(final MetisDataFieldId pId) {
        /* Create the new date column */
<span class="nc" id="L318">        final PrometheusDateColumn myColumn = new PrometheusDateColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L321">        theList.add(myColumn);</span>
<span class="nc" id="L322">        return myColumn;</span>
    }

    /**
     * Add a date column, which can be null.
     *
     * @param pId the column id
     * @return the date column
     */
    public PrometheusDateColumn addNullDateColumn(final MetisDataFieldId pId) {
<span class="nc" id="L332">        final PrometheusDateColumn myColumn = addDateColumn(pId);</span>
<span class="nc" id="L333">        myColumn.setNullable();</span>
<span class="nc" id="L334">        return myColumn;</span>
    }

    /**
     * Add a money column.
     *
     * @param pId the column id
     * @return the money column
     */
    public PrometheusMoneyColumn addMoneyColumn(final MetisDataFieldId pId) {
        /* Create the new money column */
<span class="nc" id="L345">        final PrometheusMoneyColumn myColumn = new PrometheusMoneyColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L348">        theList.add(myColumn);</span>
<span class="nc" id="L349">        return myColumn;</span>
    }

    /**
     * Add a money column, which can be null.
     *
     * @param pId the column id
     * @return the money column
     */
    public PrometheusMoneyColumn addNullMoneyColumn(final MetisDataFieldId pId) {
<span class="nc" id="L359">        final PrometheusMoneyColumn myColumn = addMoneyColumn(pId);</span>
<span class="nc" id="L360">        myColumn.setNullable();</span>
<span class="nc" id="L361">        return myColumn;</span>
    }

    /**
     * Add a rate column.
     *
     * @param pId the column id
     * @return the rate column
     */
    public PrometheusRateColumn addRateColumn(final MetisDataFieldId pId) {
        /* Create the new rate column */
<span class="nc" id="L372">        final PrometheusRateColumn myColumn = new PrometheusRateColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L375">        theList.add(myColumn);</span>
<span class="nc" id="L376">        return myColumn;</span>
    }

    /**
     * Add a rate column, which can be null.
     *
     * @param pId the column id
     * @return the rate column
     */
    public PrometheusRateColumn addNullRateColumn(final MetisDataFieldId pId) {
<span class="nc" id="L386">        final PrometheusRateColumn myColumn = addRateColumn(pId);</span>
<span class="nc" id="L387">        myColumn.setNullable();</span>
<span class="nc" id="L388">        return myColumn;</span>
    }

    /**
     * Add a rate column.
     *
     * @param pId the column id
     * @return the rate column
     */
    public PrometheusRatioColumn addRatioColumn(final MetisDataFieldId pId) {
        /* Create the new rate column */
<span class="nc" id="L399">        final PrometheusRatioColumn myColumn = new PrometheusRatioColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L402">        theList.add(myColumn);</span>
<span class="nc" id="L403">        return myColumn;</span>
    }

    /**
     * Add a rate column, which can be null.
     *
     * @param pId the column id
     * @return the rate column
     */
    public PrometheusRatioColumn addNullRatioColumn(final MetisDataFieldId pId) {
<span class="nc" id="L413">        final PrometheusRatioColumn myColumn = addRatioColumn(pId);</span>
<span class="nc" id="L414">        myColumn.setNullable();</span>
<span class="nc" id="L415">        return myColumn;</span>
    }

    /**
     * Add a binary column.
     *
     * @param pId     the column id
     * @param pLength the underlying (character) length
     * @return the binary column
     */
    public PrometheusBinaryColumn addBinaryColumn(final MetisDataFieldId pId,
                                                  final int pLength) {
        /* Create the new binary column */
<span class="nc" id="L428">        final PrometheusBinaryColumn myColumn = new PrometheusBinaryColumn(this, pId, pLength);</span>

        /* Add it to the list and return it */
<span class="nc" id="L431">        theList.add(myColumn);</span>
<span class="nc" id="L432">        return myColumn;</span>
    }

    /**
     * Add a binary column, which can be null.
     *
     * @param pId     the column id
     * @param pLength the underlying (character) length
     * @return the binary column
     */
    public PrometheusBinaryColumn addNullBinaryColumn(final MetisDataFieldId pId,
                                                      final int pLength) {
<span class="nc" id="L444">        final PrometheusBinaryColumn myColumn = addBinaryColumn(pId, pLength);</span>
<span class="nc" id="L445">        myColumn.setNullable();</span>
<span class="nc" id="L446">        return myColumn;</span>
    }

    /**
     * Add an encrypted column.
     *
     * @param pId     the column id
     * @param pLength the underlying (character) length
     * @return the binary column
     */
    public PrometheusBinaryColumn addEncryptedColumn(final MetisDataFieldId pId,
                                                     final int pLength) {
        /* Create the new binary column */
<span class="nc" id="L459">        final PrometheusBinaryColumn myColumn = new PrometheusBinaryColumn(this, pId, GordianUtilities.getKeySetEncryptionLength(pLength));</span>

        /* Add it to the list and return it */
<span class="nc" id="L462">        theList.add(myColumn);</span>
<span class="nc" id="L463">        return myColumn;</span>
    }

    /**
     * Add an encrypted column, which can be null.
     *
     * @param pId     the column id
     * @param pLength the underlying (character) length
     * @return the binary column
     */
    public PrometheusBinaryColumn addNullEncryptedColumn(final MetisDataFieldId pId,
                                                         final int pLength) {
<span class="nc" id="L475">        final PrometheusBinaryColumn myColumn = addEncryptedColumn(pId, pLength);</span>
<span class="nc" id="L476">        myColumn.setNullable();</span>
<span class="nc" id="L477">        return myColumn;</span>
    }

    /**
     * Add a string column.
     *
     * @param pId     the column id
     * @param pLength the character length
     * @return the binary column
     */
    public PrometheusStringColumn addStringColumn(final MetisDataFieldId pId,
                                                  final int pLength) {
        /* Create the new string column */
<span class="nc" id="L490">        final PrometheusStringColumn myColumn = new PrometheusStringColumn(this, pId, pLength);</span>

        /* Add it to the list and return it */
<span class="nc" id="L493">        theList.add(myColumn);</span>
<span class="nc" id="L494">        return myColumn;</span>
    }

    /**
     * Add a string column, which can be null.
     *
     * @param pId     the column id
     * @param pLength the character length
     * @return the binary column
     */
    public PrometheusStringColumn addNullStringColumn(final MetisDataFieldId pId,
                                                      final int pLength) {
<span class="nc" id="L506">        final PrometheusStringColumn myColumn = addStringColumn(pId, pLength);</span>
<span class="nc" id="L507">        myColumn.setNullable();</span>
<span class="nc" id="L508">        return myColumn;</span>
    }

    /**
     * Locate reference.
     *
     * @param pTables the list of defined tables
     */
    protected void resolveReferences(final List&lt;PrometheusTableDataItem&lt;?&gt;&gt; pTables) {
        /* Create the iterator */
<span class="nc" id="L518">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>

        /* Loop through the columns */
<span class="nc bnc" id="L521" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L522">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc" id="L523">            myDef.locateReference(pTables);</span>
<span class="nc" id="L524">        }</span>
<span class="nc" id="L525">    }</span>

    /**
     * Load results.
     *
     * @param pResults the result set
     * @throws SQLException on error
     */
    protected void loadResults(final ResultSet pResults) throws SQLException {
        /* clear values */
<span class="nc" id="L535">        clearValues();</span>

        /* Create the iterator */
<span class="nc" id="L538">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L539">        int myIndex = 1;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L542" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L543">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc" id="L544">            myDef.loadValue(pResults, myIndex++);</span>
<span class="nc" id="L545">        }</span>
<span class="nc" id="L546">    }</span>

    /**
     * Build column error string.
     *
     * @param pCol the column definition.
     * @return the error string
     */
    private String getColumnError(final PrometheusColumnDefinition pCol) {
<span class="nc" id="L555">        return &quot;Column &quot; + pCol.getColumnName() + &quot; in table &quot; + theTableName;</span>
    }

    /**
     * Insert values.
     *
     * @param pStmt the statement
     * @throws SQLException     on error
     * @throws OceanusException on error
     */
    protected void insertValues(final PreparedStatement pStmt) throws SQLException, OceanusException {
        /* Store the Statement */
<span class="nc" id="L567">        theStatement = pStmt;</span>

        /* Create the iterator */
<span class="nc" id="L570">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L571">        int myIndex = 1;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L574" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L575">            final PrometheusColumnDefinition myDef = myIterator.next();</span>

            /* Reject if the value is not set */
<span class="nc bnc" id="L578" title="All 2 branches missed.">            if (!myDef.isValueSet()) {</span>
<span class="nc" id="L579">                throw new PrometheusLogicException(getColumnError(myDef) + &quot; has no value for insert&quot;);</span>
            }

<span class="nc" id="L582">            myDef.storeValue(theStatement, myIndex++);</span>
<span class="nc" id="L583">        }</span>
<span class="nc" id="L584">    }</span>

    /**
     * Update values.
     *
     * @param pStmt the statement
     * @throws SQLException on error
     */
    protected void updateValues(final PreparedStatement pStmt) throws SQLException {
<span class="nc" id="L593">        PrometheusColumnDefinition myId = null;</span>

        /* Store the Statement */
<span class="nc" id="L596">        theStatement = pStmt;</span>

        /* Create the iterator */
<span class="nc" id="L599">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L600">        int myIndex = 1;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L603" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L604">            final PrometheusColumnDefinition myDef = myIterator.next();</span>

            /* If this is the Id record */
<span class="nc bnc" id="L607" title="All 2 branches missed.">            if (myDef instanceof PrometheusIdColumn) {</span>
                /* Remember the column */
<span class="nc" id="L609">                myId = myDef;</span>

                /* Store value if it has been set */
<span class="nc bnc" id="L612" title="All 2 branches missed.">            } else if (myDef.isValueSet()) {</span>
<span class="nc" id="L613">                myDef.storeValue(theStatement, myIndex++);</span>
            }
<span class="nc" id="L615">        }</span>

        /* Store the Id */
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (myId != null) {</span>
<span class="nc" id="L619">            myId.storeValue(theStatement, myIndex);</span>
        }
<span class="nc" id="L621">    }</span>

    /**
     * Clear values for table.
     */
    protected void clearValues() {
        /* Loop over the Column Definitions */
<span class="nc bnc" id="L628" title="All 2 branches missed.">        for (PrometheusColumnDefinition myDef : theList) {</span>
            /* Clear value */
<span class="nc" id="L630">            myDef.clearValue();</span>
<span class="nc" id="L631">        }</span>
<span class="nc" id="L632">    }</span>

    /**
     * Get Integer value for column.
     *
     * @param pId the column id
     * @return the integer value
     * @throws OceanusException on error
     */
    public Integer getIntegerValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L643">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not an integer column */
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusIntegerColumn)) {</span>
<span class="nc" id="L647">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Integer type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L651">        final PrometheusIntegerColumn myIntCol = (PrometheusIntegerColumn) myCol;</span>
<span class="nc" id="L652">        return myIntCol.getValue();</span>
    }

    /**
     * Get Long value for column.
     *
     * @param pId the column id
     * @return the long value
     * @throws OceanusException on error
     */
    public Long getLongValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L664">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a long column */
<span class="nc bnc" id="L667" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusLongColumn)) {</span>
<span class="nc" id="L668">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Long type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L672">        final PrometheusLongColumn myLongCol = (PrometheusLongColumn) myCol;</span>
<span class="nc" id="L673">        return myLongCol.getValue();</span>
    }

    /**
     * Get Date value for column.
     *
     * @param pId the column id
     * @return the Date value
     * @throws OceanusException on error
     */
    public OceanusDate getDateValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L685">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a date column */
<span class="nc bnc" id="L688" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusDateColumn)) {</span>
<span class="nc" id="L689">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Date type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L693">        final PrometheusDateColumn myDateCol = (PrometheusDateColumn) myCol;</span>
<span class="nc" id="L694">        return myDateCol.getValue();</span>
    }

    /**
     * Get Boolean value for column.
     *
     * @param pId the column id
     * @return the boolean value
     * @throws OceanusException on error
     */
    public Boolean getBooleanValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L706">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a boolean column */
<span class="nc bnc" id="L709" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusBooleanColumn)) {</span>
<span class="nc" id="L710">            throw new PrometheusLogicException(&quot;Column &quot; + getColumnError(myCol) + &quot; is not Boolean type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L714">        final PrometheusBooleanColumn myBoolCol = (PrometheusBooleanColumn) myCol;</span>
<span class="nc" id="L715">        return myBoolCol.getValue();</span>
    }

    /**
     * Get String value for column.
     *
     * @param pId the column id
     * @return the String value
     * @throws OceanusException on error
     */
    public String getStringValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L727">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a string column */
<span class="nc bnc" id="L730" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusStringColumn)) {</span>
<span class="nc" id="L731">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not String type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L735">        final PrometheusStringColumn myStringCol = (PrometheusStringColumn) myCol;</span>
<span class="nc" id="L736">        return myStringCol.getValue();</span>
    }

    /**
     * Get Money value for column.
     *
     * @param pId        the column id
     * @param pFormatter the data formatter
     * @return the Money value
     * @throws OceanusException on error
     */
    public OceanusMoney getMoneyValue(final MetisDataFieldId pId,
                                      final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L750">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a money column */
<span class="nc bnc" id="L753" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusMoneyColumn)) {</span>
<span class="nc" id="L754">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not money type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L758">        final PrometheusMoneyColumn myMoneyCol = (PrometheusMoneyColumn) myCol;</span>
<span class="nc" id="L759">        return myMoneyCol.getValue(pFormatter);</span>
    }

    /**
     * Get Price value for column.
     *
     * @param pId        the column id
     * @param pFormatter the data formatter
     * @return the price value
     * @throws OceanusException on error
     */
    public OceanusPrice getPriceValue(final MetisDataFieldId pId,
                                      final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L773">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a price column */
<span class="nc bnc" id="L776" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusPriceColumn)) {</span>
<span class="nc" id="L777">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Price type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L781">        final PrometheusPriceColumn myPriceCol = (PrometheusPriceColumn) myCol;</span>
<span class="nc" id="L782">        return myPriceCol.getValue(pFormatter);</span>
    }

    /**
     * Get Rate value for column.
     *
     * @param pId        the column id
     * @param pFormatter the data formatter
     * @return the rate value
     * @throws OceanusException on error
     */
    public OceanusRate getRateValue(final MetisDataFieldId pId,
                                    final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L796">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a rate column */
<span class="nc bnc" id="L799" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusRateColumn)) {</span>
<span class="nc" id="L800">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Rate type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L804">        final PrometheusRateColumn myRateCol = (PrometheusRateColumn) myCol;</span>
<span class="nc" id="L805">        return myRateCol.getValue(pFormatter);</span>
    }

    /**
     * Get Units value for column.
     *
     * @param pId        the column id
     * @param pFormatter the data formatter
     * @return the Units value
     * @throws OceanusException on error
     */
    public OceanusUnits getUnitsValue(final MetisDataFieldId pId,
                                      final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L819">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a units column */
<span class="nc bnc" id="L822" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusUnitsColumn)) {</span>
<span class="nc" id="L823">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Units type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L827">        final PrometheusUnitsColumn myUnitsCol = (PrometheusUnitsColumn) myCol;</span>
<span class="nc" id="L828">        return myUnitsCol.getValue(pFormatter);</span>
    }

    /**
     * Get Ratio value for column.
     *
     * @param pId        the column id
     * @param pFormatter the data formatter
     * @return the Ratio value
     * @throws OceanusException on error
     */
    public OceanusRatio getRatioValue(final MetisDataFieldId pId,
                                      final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L842">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a ratio column */
<span class="nc bnc" id="L845" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusRatioColumn)) {</span>
<span class="nc" id="L846">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Ratio type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L850">        final PrometheusRatioColumn myRatioCol = (PrometheusRatioColumn) myCol;</span>
<span class="nc" id="L851">        return myRatioCol.getValue(pFormatter);</span>
    }

    /**
     * Get Binary value for column.
     *
     * @param pId the column id
     * @return the binary value
     * @throws OceanusException on error
     */
    public byte[] getBinaryValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L863">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a string column */
<span class="nc bnc" id="L866" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusBinaryColumn)) {</span>
<span class="nc" id="L867">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Binary type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L871">        final PrometheusBinaryColumn myBinaryCol = (PrometheusBinaryColumn) myCol;</span>
<span class="nc" id="L872">        return myBinaryCol.getValue();</span>
    }

    /**
     * Set Integer value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setIntegerValue(final MetisDataFieldId pId,
                                final Integer pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L885">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not an integer column */
<span class="nc bnc" id="L888" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusIntegerColumn)) {</span>
<span class="nc" id="L889">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Integer type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L893">        final PrometheusIntegerColumn myIntCol = (PrometheusIntegerColumn) myCol;</span>
<span class="nc" id="L894">        myIntCol.setValue(pValue);</span>
<span class="nc" id="L895">    }</span>

    /**
     * Set Long value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setLongValue(final MetisDataFieldId pId,
                             final Long pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L907">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a long column */
<span class="nc bnc" id="L910" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusLongColumn)) {</span>
<span class="nc" id="L911">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Long type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L915">        final PrometheusLongColumn myLongCol = (PrometheusLongColumn) myCol;</span>
<span class="nc" id="L916">        myLongCol.setValue(pValue);</span>
<span class="nc" id="L917">    }</span>

    /**
     * Set Boolean value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setBooleanValue(final MetisDataFieldId pId,
                                final Boolean pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L929">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a boolean column */
<span class="nc bnc" id="L932" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusBooleanColumn)) {</span>
<span class="nc" id="L933">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Boolean type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L937">        final PrometheusBooleanColumn myBoolCol = (PrometheusBooleanColumn) myCol;</span>
<span class="nc" id="L938">        myBoolCol.setValue(pValue);</span>
<span class="nc" id="L939">    }</span>

    /**
     * Set Date value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setDateValue(final MetisDataFieldId pId,
                             final OceanusDate pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L951">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a Date column */
<span class="nc bnc" id="L954" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusDateColumn)) {</span>
<span class="nc" id="L955">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Date type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L959">        final PrometheusDateColumn myDateCol = (PrometheusDateColumn) myCol;</span>
<span class="nc" id="L960">        myDateCol.setValue(pValue);</span>
<span class="nc" id="L961">    }</span>

    /**
     * Set String value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setStringValue(final MetisDataFieldId pId,
                               final String pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L973">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a string column */
<span class="nc bnc" id="L976" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusStringColumn)) {</span>
<span class="nc" id="L977">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not String type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L981">        final PrometheusStringColumn myStringCol = (PrometheusStringColumn) myCol;</span>
<span class="nc" id="L982">        myStringCol.setValue(pValue);</span>
<span class="nc" id="L983">    }</span>

    /**
     * Set Binary value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setBinaryValue(final MetisDataFieldId pId,
                               final byte[] pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L995">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a binary column */
<span class="nc bnc" id="L998" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusBinaryColumn)) {</span>
<span class="nc" id="L999">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Binary type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L1003">        final PrometheusBinaryColumn myBinaryCol = (PrometheusBinaryColumn) myCol;</span>
<span class="nc" id="L1004">        myBinaryCol.setValue(pValue);</span>
<span class="nc" id="L1005">    }</span>

    /**
     * Set Money value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setMoneyValue(final MetisDataFieldId pId,
                              final OceanusMoney pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L1017">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a money column */
<span class="nc bnc" id="L1020" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusMoneyColumn)) {</span>
<span class="nc" id="L1021">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Money type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L1025">        final PrometheusMoneyColumn myMoneyCol = (PrometheusMoneyColumn) myCol;</span>
<span class="nc" id="L1026">        myMoneyCol.setValue(pValue);</span>
<span class="nc" id="L1027">    }</span>

    /**
     * Set Rate value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setRateValue(final MetisDataFieldId pId,
                             final OceanusRate pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L1039">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a rate column */
<span class="nc bnc" id="L1042" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusRateColumn)) {</span>
<span class="nc" id="L1043">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Rate type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L1047">        final PrometheusRateColumn myRateCol = (PrometheusRateColumn) myCol;</span>
<span class="nc" id="L1048">        myRateCol.setValue(pValue);</span>
<span class="nc" id="L1049">    }</span>

    /**
     * Set Ratio value for column.
     *
     * @param pId    the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setRatioValue(final MetisDataFieldId pId,
                              final OceanusRatio pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L1061">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a ratio column */
<span class="nc bnc" id="L1064" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusRatioColumn)) {</span>
<span class="nc" id="L1065">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Ratio type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L1069">        final PrometheusRatioColumn myRatioCol = (PrometheusRatioColumn) myCol;</span>
<span class="nc" id="L1070">        myRatioCol.setValue(pValue);</span>
<span class="nc" id="L1071">    }</span>

    /**
     * Locate column for id.
     *
     * @param pId the id of the column
     * @return the column
     * @throws OceanusException on error
     */
    private PrometheusColumnDefinition getColumnForId(final MetisDataFieldId pId) throws OceanusException {
        /* Access the definition */
<span class="nc" id="L1082">        final PrometheusColumnDefinition myDef = theMap.get(pId);</span>

        /* Check that the id is in range and present */
<span class="nc bnc" id="L1085" title="All 2 branches missed.">        if (myDef == null) {</span>
<span class="nc" id="L1086">            throw new PrometheusLogicException(&quot;Invalid Column Id: &quot; + pId + &quot; for &quot; + theTableName);</span>
        }

        /* Return the column definition */
<span class="nc" id="L1090">        return myDef;</span>
    }

    /**
     * Build the create table string for the table.
     *
     * @return the SQL string
     */
    protected String getCreateTableString() {
<span class="nc" id="L1099">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial create */
<span class="nc" id="L1102">        myBuilder.append(&quot;create table &quot;);</span>
<span class="nc" id="L1103">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1104">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1105">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1106">        myBuilder.append(&quot; (&quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1109">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L1110">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1113" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1114">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc bnc" id="L1115" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1116">                myBuilder.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L1118">            myDef.buildCreateString(myBuilder);</span>
<span class="nc" id="L1119">            myFirst = false;</span>
<span class="nc" id="L1120">        }</span>

        /* Close the statement and return it */
<span class="nc" id="L1123">        myBuilder.append(')');</span>
<span class="nc" id="L1124">        return myBuilder.toString();</span>
    }

    /**
     * Build the create index string for the table.
     *
     * @return the SQL string
     */
    protected String getCreateIndexString() {
<span class="nc" id="L1133">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Return null if we are not indexed */
<span class="nc bnc" id="L1136" title="All 2 branches missed.">        if (!isIndexed()) {</span>
<span class="nc" id="L1137">            return null;</span>
        }

        /* Build the initial create */
<span class="nc" id="L1141">        myBuilder.append(&quot;create index &quot;);</span>
<span class="nc" id="L1142">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1143">        myBuilder.append(PREFIX_INDEX);</span>
<span class="nc" id="L1144">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1145">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1146">        myBuilder.append(&quot; on &quot;);</span>
<span class="nc" id="L1147">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1148">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1149">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1150">        myBuilder.append(&quot; (&quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1153">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theSortList.iterator();</span>
<span class="nc" id="L1154">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1157" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1158">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1160">                myBuilder.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L1162">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1163">            myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1164">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">            if (myDef.getSortOrder() == PrometheusSortOrder.DESCENDING) {</span>
<span class="nc" id="L1166">                myBuilder.append(STR_DESC);</span>
            }
<span class="nc" id="L1168">            myFirst = false;</span>
<span class="nc" id="L1169">        }</span>

        /* Close the statement and return it */
<span class="nc" id="L1172">        myBuilder.append(')');</span>
<span class="nc" id="L1173">        return myBuilder.toString();</span>
    }

    /**
     * Build the drop table string for the table.
     *
     * @return the SQL string
     */
    protected String getDropTableString() {
<span class="nc" id="L1182">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>
<span class="nc" id="L1183">        myBuilder.append(&quot;drop table if exists &quot;);</span>
<span class="nc" id="L1184">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1185">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1186">        addQuoteIfAllowed(myBuilder);</span>

        /* Return the command */
<span class="nc" id="L1189">        return myBuilder.toString();</span>
    }

    /**
     * Build the drop index string for the table.
     *
     * @return the SQL string
     */
    protected String getDropIndexString() {
        /* Return null if we are not indexed */
<span class="nc bnc" id="L1199" title="All 4 branches missed.">        if (!isIndexed() || !theDriver.explicitDropIndex()) {</span>
<span class="nc" id="L1200">            return null;</span>
        }

        /* Build the drop command */
<span class="nc" id="L1204">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>
<span class="nc" id="L1205">        myBuilder.append(&quot;drop index if exists &quot;);</span>
<span class="nc" id="L1206">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1207">        myBuilder.append(PREFIX_INDEX);</span>
<span class="nc" id="L1208">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1209">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">        if (!PrometheusJDBCDriver.POSTGRESQL.equals(theDriver)) {</span>
<span class="nc" id="L1211">            myBuilder.append(&quot; on &quot;);</span>
<span class="nc" id="L1212">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1213">            myBuilder.append(theTableName);</span>
<span class="nc" id="L1214">            addQuoteIfAllowed(myBuilder);</span>
        }

        /* Return the command */
<span class="nc" id="L1218">        return myBuilder.toString();</span>
    }

    /**
     * Build the load string for a list of columns.
     *
     * @return the SQL string
     */
    protected String getLoadString() {
<span class="nc" id="L1227">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial select */
<span class="nc" id="L1230">        myBuilder.append(&quot;select &quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1233">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L1234">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1237" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1238">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1240">                myBuilder.append(&quot;, &quot;);</span>
            }
<span class="nc bnc" id="L1242" title="All 2 branches missed.">            if (sortOnReference) {</span>
<span class="nc" id="L1243">                myBuilder.append(&quot;a.&quot;);</span>
            }
<span class="nc" id="L1245">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1246">            myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1247">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1248">            myFirst = false;</span>
<span class="nc" id="L1249">        }</span>

        /* Close the statement */
<span class="nc" id="L1252">        myBuilder.append(&quot; from &quot;);</span>
<span class="nc" id="L1253">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1254">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1255">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">        if (sortOnReference) {</span>
<span class="nc" id="L1257">            myBuilder.append(&quot; a&quot;);</span>
        }

        /* If we are indexed */
<span class="nc bnc" id="L1261" title="All 2 branches missed.">        if (isIndexed()) {</span>
            /* Add Joins */
<span class="nc bnc" id="L1263" title="All 2 branches missed.">            if (sortOnReference) {</span>
<span class="nc" id="L1264">                myBuilder.append(getJoinString('a', 1));</span>
            }

            /* Add the order clause */
<span class="nc" id="L1268">            myBuilder.append(&quot; order by &quot;);</span>

            /* Build the order string */
<span class="nc" id="L1271">            myBuilder.append(getOrderString('a', 0));</span>
        }

<span class="nc" id="L1274">        return myBuilder.toString();</span>
    }

    /**
     * Build the Join string for the list of columns.
     *
     * @param pChar   the character for this table
     * @param pOffset the join offset
     * @return the SQL string
     */
    protected String getJoinString(final char pChar,
                                   final Integer pOffset) {
        /* Loop through the columns */
<span class="nc" id="L1287">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>
<span class="nc bnc" id="L1288" title="All 2 branches missed.">        for (PrometheusColumnDefinition myDef : theSortList) {</span>
            /* Access next column and skip if not reference column */
<span class="nc bnc" id="L1290" title="All 2 branches missed.">            if (!(myDef instanceof PrometheusReferenceColumn)) {</span>
<span class="nc" id="L1291">                continue;</span>
            }

            /* Add the join */
<span class="nc" id="L1295">            final PrometheusReferenceColumn myCol = (PrometheusReferenceColumn) myDef;</span>
<span class="nc" id="L1296">            myCol.buildJoinString(myBuilder, pChar, pOffset);</span>
<span class="nc" id="L1297">        }</span>

<span class="nc" id="L1299">        return myBuilder.toString();</span>
    }

    /**
     * Build the Order string for the list of columns.
     *
     * @param pChar   the character for this table
     * @param pOffset the join offset
     * @return the SQL string
     */
    protected String getOrderString(final char pChar,
                                    final Integer pOffset) {
<span class="nc" id="L1311">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Create the iterator */
<span class="nc" id="L1314">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theSortList.iterator();</span>
<span class="nc" id="L1315">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1318" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1319">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
            /* Handle secondary columns */
<span class="nc bnc" id="L1321" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1322">                myBuilder.append(&quot;, &quot;);</span>
            }

            /* If we are using prefixes */
<span class="nc bnc" id="L1326" title="All 4 branches missed.">            if (sortOnReference || pChar &gt; 'a') {</span>
                /* If this is a reference column */
<span class="nc bnc" id="L1328" title="All 2 branches missed.">                if (myDef instanceof PrometheusReferenceColumn myCol) {</span>
                    /* Handle Reference column */
<span class="nc" id="L1330">                    myCol.buildOrderString(myBuilder, pOffset + 1);</span>
                } else {
                    /* Handle standard column with prefix */
<span class="nc" id="L1333">                    myBuilder.append(pChar);</span>
<span class="nc" id="L1334">                    myBuilder.append(&quot;.&quot;);</span>
<span class="nc" id="L1335">                    addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1336">                    myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1337">                    addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">                    if (myDef.getSortOrder() == PrometheusSortOrder.DESCENDING) {</span>
<span class="nc" id="L1339">                        myBuilder.append(STR_DESC);</span>
                    }
                }
            } else {
                /* Handle standard column */
<span class="nc" id="L1344">                addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1345">                myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1346">                addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">                if (myDef.getSortOrder() == PrometheusSortOrder.DESCENDING) {</span>
<span class="nc" id="L1348">                    myBuilder.append(STR_DESC);</span>
                }
            }

            /* Note secondary columns */
<span class="nc" id="L1353">            myFirst = false;</span>
<span class="nc" id="L1354">        }</span>

<span class="nc" id="L1356">        return myBuilder.toString();</span>
    }

    /**
     * Build the insert string for a list of columns.
     *
     * @return the SQL string
     */
    protected String getInsertString() {
<span class="nc" id="L1365">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>
<span class="nc" id="L1366">        final StringBuilder myValues = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial insert */
<span class="nc" id="L1369">        myBuilder.append(&quot;insert into &quot;);</span>
<span class="nc" id="L1370">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1371">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1372">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1373">        myBuilder.append(&quot; (&quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1376">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L1377">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1380" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1381">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc bnc" id="L1382" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1383">                myBuilder.append(&quot;, &quot;);</span>
<span class="nc" id="L1384">                myValues.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L1386">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1387">            myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1388">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1389">            myValues.append('?');</span>
<span class="nc" id="L1390">            myFirst = false;</span>
<span class="nc" id="L1391">        }</span>

        /* Close the statement and return it */
<span class="nc" id="L1394">        myBuilder.append(&quot;) values(&quot;);</span>
<span class="nc" id="L1395">        myBuilder.append(myValues);</span>
<span class="nc" id="L1396">        myBuilder.append(')');</span>
<span class="nc" id="L1397">        return myBuilder.toString();</span>
    }

    /**
     * Build the update string for a list of columns.
     *
     * @return the SQL string
     * @throws OceanusException on error
     */
    protected String getUpdateString() throws OceanusException {
<span class="nc" id="L1407">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial update */
<span class="nc" id="L1410">        myBuilder.append(&quot;update &quot;);</span>
<span class="nc" id="L1411">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1412">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1413">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1414">        myBuilder.append(&quot; set &quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1417">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L1418">        PrometheusColumnDefinition myId = null;</span>
<span class="nc" id="L1419">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1422" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1423">            final PrometheusColumnDefinition myDef = myIterator.next();</span>

            /* If this is the Id record */
<span class="nc bnc" id="L1426" title="All 2 branches missed.">            if (myDef instanceof PrometheusIdColumn) {</span>
                /* Reject if the value is not set */
<span class="nc bnc" id="L1428" title="All 2 branches missed.">                if (!myDef.isValueSet()) {</span>
<span class="nc" id="L1429">                    throw new PrometheusLogicException(getColumnError(myDef) + &quot; has no value for update&quot;);</span>
                }

                /* Remember the column */
<span class="nc" id="L1433">                myId = myDef;</span>

                /* If this column is to be updated */
<span class="nc bnc" id="L1436" title="All 2 branches missed.">            } else if (myDef.isValueSet()) {</span>
                /* Add the update of this column */
<span class="nc bnc" id="L1438" title="All 2 branches missed.">                if (!myFirst) {</span>
<span class="nc" id="L1439">                    myBuilder.append(&quot;, &quot;);</span>
                }
<span class="nc" id="L1441">                addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1442">                myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1443">                addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1444">                myBuilder.append(&quot;=?&quot;);</span>
<span class="nc" id="L1445">                myFirst = false;</span>
            }
<span class="nc" id="L1447">        }</span>

        /* If we have no values then just return null */
<span class="nc bnc" id="L1450" title="All 4 branches missed.">        if (myFirst || myId == null) {</span>
<span class="nc" id="L1451">            return null;</span>
        }

        /* Close the statement and return it */
<span class="nc" id="L1455">        myBuilder.append(&quot; where &quot;);</span>
<span class="nc" id="L1456">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1457">        myBuilder.append(myId.getColumnName());</span>
<span class="nc" id="L1458">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1459">        myBuilder.append(&quot;=?&quot;);</span>
<span class="nc" id="L1460">        return myBuilder.toString();</span>
    }

    /**
     * Build the delete string for a table.
     *
     * @return the SQL string
     */
    protected String getDeleteString() {
<span class="nc" id="L1469">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial delete */
<span class="nc" id="L1472">        myBuilder.append(&quot;delete from &quot;);</span>
<span class="nc" id="L1473">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1474">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1475">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1476">        myBuilder.append(&quot; where &quot;);</span>

        /* Access the id definition */
<span class="nc" id="L1479">        final PrometheusColumnDefinition myId = theList.get(0);</span>

        /* Build the rest of the command */
<span class="nc" id="L1482">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1483">        myBuilder.append(myId.getColumnName());</span>
<span class="nc" id="L1484">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1485">        myBuilder.append(&quot;=?&quot;);</span>
<span class="nc" id="L1486">        return myBuilder.toString();</span>
    }

    /**
     * Build the purge string for a table.
     *
     * @return the SQL string
     */
    protected String getPurgeString() {
<span class="nc" id="L1495">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial delete */
<span class="nc" id="L1498">        myBuilder.append(&quot;delete from &quot;);</span>
<span class="nc" id="L1499">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1500">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1501">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1502">        return myBuilder.toString();</span>
    }

    /**
     * Build the count string for a table.
     *
     * @return the SQL string
     */
    protected String getCountString() {
<span class="nc" id="L1511">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial delete */
<span class="nc" id="L1514">        myBuilder.append(&quot;select count(*) from &quot;);</span>
<span class="nc" id="L1515">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1516">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1517">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1518">        return myBuilder.toString();</span>
    }

    /**
     * Add quote if necessary.
     *
     * @param pBuilder the builder
     */
    void addQuoteIfAllowed(final StringBuilder pBuilder) {
<span class="nc bnc" id="L1527" title="All 2 branches missed.">        if (theDriver.useQuotes()) {</span>
<span class="nc" id="L1528">            pBuilder.append(QUOTE_STRING);</span>
        }
<span class="nc" id="L1530">    }</span>

    /**
     * SortOrder.
     */
<span class="nc" id="L1535">    public enum PrometheusSortOrder {</span>
        /**
         * Ascending.
         */
<span class="nc" id="L1539">        ASCENDING,</span>

        /**
         * Descending.
         */
<span class="nc" id="L1544">        DESCENDING;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>