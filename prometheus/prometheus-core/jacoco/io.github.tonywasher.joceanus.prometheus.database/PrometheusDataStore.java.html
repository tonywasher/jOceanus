<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusDataStore.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.prometheus.database</a> &gt; <span class="el_source">PrometheusDataStore.java</span></div><h1>PrometheusDataStore.java</h1><pre class="source lang-java linenums">/*
 * Prometheus: Application Framework
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.prometheus.database;

import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.logger.OceanusLogManager;
import io.github.tonywasher.joceanus.oceanus.logger.OceanusLogger;
import io.github.tonywasher.joceanus.oceanus.profile.OceanusProfile;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataSet;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataSet.PrometheusCryptographyDataType;
import io.github.tonywasher.joceanus.prometheus.exc.PrometheusIOException;
import io.github.tonywasher.joceanus.tethys.api.thread.TethysUIThreadStatusReport;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.ListIterator;
import java.util.Properties;

/**
 * Class that encapsulates a database connection.
 */
public abstract class PrometheusDataStore {
    /**
     * Number of update steps per table (INSERT/UPDATE/DELETE).
     */
    private static final int NUM_STEPS_PER_TABLE = 3;

    /**
     * User property name.
     */
    private static final String PROPERTY_USER = &quot;user&quot;;

    /**
     * Password property name.
     */
    private static final String PROPERTY_PASS = &quot;password&quot;;

    /**
     * Instance property name.
     */
    private static final String PROPERTY_INSTANCE = &quot;instance&quot;;

    /**
     * Encrypt property name.
     */
    private static final String PROPERTY_ENCRYPT = &quot;encrypt&quot;;

    /**
     * Logger.
     */
<span class="nc" id="L70">    private static final OceanusLogger LOGGER = OceanusLogManager.getLogger(PrometheusDataStore.class);</span>

    /**
     * Database connection.
     */
    private Connection theConn;

    /**
     * Database name.
     */
    private String theDatabase;

    /**
     * Batch Size.
     */
    private final Integer theBatchSize;

    /**
     * Database Driver.
     */
    private final PrometheusJDBCDriver theDriver;

    /**
     * List of Database tables.
     */
    private final List&lt;PrometheusTableDataItem&lt;?&gt;&gt; theTables;

    /**
     * Construct a new Database class.
     *
     * @param pDatabase the database
     * @param pConfig   the config
     * @throws OceanusException on error
     */
    protected PrometheusDataStore(final String pDatabase,
<span class="nc" id="L105">                                  final PrometheusDBConfig pConfig) throws OceanusException {</span>
        /* Create the connection */
        try {
            /* Access the batch size */
<span class="nc" id="L109">            theBatchSize = pConfig.getBatchSize();</span>

            /* Access the JDBC Driver */
<span class="nc" id="L112">            theDriver = pConfig.getDriver();</span>

            /* Store the name */
<span class="nc" id="L115">            theDatabase = pDatabase;</span>

            /* Obtain the connection */
<span class="nc" id="L118">            final String myConnString = theDriver.getConnectionString(pDatabase, pConfig.getServer(), pConfig.getPort());</span>

            /* Create the properties and record user */
<span class="nc" id="L121">            final Properties myProperties = new Properties();</span>
<span class="nc" id="L122">            final String myUser = pConfig.getUser();</span>
<span class="nc" id="L123">            final char[] myPass = pConfig.getPassword();</span>
<span class="nc" id="L124">            myProperties.setProperty(PROPERTY_USER, myUser);</span>
<span class="nc" id="L125">            myProperties.setProperty(PROPERTY_PASS, new String(myPass));</span>

            /* If we are using instance */
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (theDriver.useInstance()) {</span>
<span class="nc" id="L129">                final String myInstance = pConfig.getInstance();</span>
<span class="nc" id="L130">                myProperties.setProperty(PROPERTY_INSTANCE, myInstance);</span>
<span class="nc" id="L131">                myProperties.setProperty(PROPERTY_ENCRYPT, &quot;false&quot;);</span>
            }

            /* Connect using properties */
<span class="nc" id="L135">            theConn = DriverManager.getConnection(myConnString, myProperties);</span>

            /* Connect to the correct database */
<span class="nc" id="L138">            theConn.setCatalog(pDatabase);</span>

            /* Switch off autoCommit */
<span class="nc" id="L141">            theConn.setAutoCommit(false);</span>

            /* handle exceptions */
<span class="nc" id="L144">        } catch (SQLException e) {</span>
<span class="nc" id="L145">            throw new PrometheusIOException(&quot;Failed to load driver&quot;, e);</span>
<span class="nc" id="L146">        }</span>

        /* Create table list and add the tables to the list */
<span class="nc" id="L149">        theTables = new ArrayList&lt;&gt;();</span>

        /* Loop through the tables */
<span class="nc bnc" id="L152" title="All 2 branches missed.">        for (PrometheusCryptographyDataType myType : PrometheusCryptographyDataType.values()) {</span>
            /* Create the sheet */
<span class="nc" id="L154">            theTables.add(newTable(myType));</span>
        }
<span class="nc" id="L156">    }</span>

    /**
     * Construct a new Database class.
     *
     * @param pConfig the config
     * @throws OceanusException on error
     */
<span class="nc" id="L164">    protected PrometheusDataStore(final PrometheusDBConfig pConfig) throws OceanusException {</span>
        /* Create the connection */
        try {
            /* Access the batch size */
<span class="nc" id="L168">            theBatchSize = pConfig.getBatchSize();</span>

            /* Access the JDBC Driver */
<span class="nc" id="L171">            theDriver = pConfig.getDriver();</span>

            /* Obtain the connection */
<span class="nc" id="L174">            final String myConnString = theDriver.getConnectionString(pConfig.getServer(), pConfig.getPort());</span>

            /* Create the properties and record user */
<span class="nc" id="L177">            final Properties myProperties = new Properties();</span>
<span class="nc" id="L178">            final String myUser = pConfig.getUser();</span>
<span class="nc" id="L179">            final char[] myPass = pConfig.getPassword();</span>
<span class="nc" id="L180">            myProperties.setProperty(PROPERTY_USER, myUser);</span>
<span class="nc" id="L181">            myProperties.setProperty(PROPERTY_PASS, new String(myPass));</span>

            /* If we are using instance */
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (theDriver.useInstance()) {</span>
<span class="nc" id="L185">                final String myInstance = pConfig.getInstance();</span>
<span class="nc" id="L186">                myProperties.setProperty(PROPERTY_INSTANCE, myInstance);</span>
<span class="nc" id="L187">                myProperties.setProperty(PROPERTY_ENCRYPT, &quot;false&quot;);</span>
            }

            /* Connect using properties */
<span class="nc" id="L191">            theConn = DriverManager.getConnection(myConnString, myProperties);</span>

            /* Switch off autoCommit */
<span class="nc" id="L194">            theConn.setAutoCommit(false);</span>

            /* handle exceptions */
<span class="nc" id="L197">        } catch (SQLException e) {</span>
<span class="nc" id="L198">            throw new PrometheusIOException(&quot;Failed to load driver&quot;, e);</span>
<span class="nc" id="L199">        }</span>

        /* Create table list and add the tables to the list */
<span class="nc" id="L202">        theTables = new ArrayList&lt;&gt;();</span>

        /* Loop through the tables */
<span class="nc bnc" id="L205" title="All 2 branches missed.">        for (PrometheusCryptographyDataType myType : PrometheusCryptographyDataType.values()) {</span>
            /* Create the sheet */
<span class="nc" id="L207">            theTables.add(newTable(myType));</span>
        }
<span class="nc" id="L209">    }</span>

    /**
     * Obtain the database name.
     *
     * @return the name
     */
    public String getName() {
<span class="nc" id="L217">        return theDatabase;</span>
    }

    /**
     * Execute the statement outside a transaction.
     *
     * @param pStatement the statement
     * @throws OceanusException on error
     */
    void executeStatement(final String pStatement) throws OceanusException {
        /* Protect the statement and execute without commit */
<span class="nc" id="L228">        try (PreparedStatement myStmt = theConn.prepareStatement(pStatement)) {</span>
<span class="nc" id="L229">            theConn.setAutoCommit(true);</span>
<span class="nc" id="L230">            myStmt.execute();</span>
<span class="nc" id="L231">            theConn.setAutoCommit(false);</span>

<span class="nc" id="L233">        } catch (SQLException e) {</span>
<span class="nc" id="L234">            throw new PrometheusIOException(&quot;Failed to execute statement&quot;, e);</span>
<span class="nc" id="L235">        }</span>
<span class="nc" id="L236">    }</span>

    /**
     * Create new sheet of required type.
     *
     * @param pListType the list type
     * @return the new sheet
     */
    private PrometheusTableDataItem&lt;?&gt; newTable(final PrometheusCryptographyDataType pListType) {
        /* Switch on list Type */
<span class="nc bnc" id="L246" title="All 5 branches missed.">        switch (pListType) {</span>
            case CONTROLDATA:
<span class="nc" id="L248">                return new PrometheusTableControlData(this);</span>
            case CONTROLKEY:
<span class="nc" id="L250">                return new PrometheusTableControlKeys(this);</span>
            case CONTROLKEYSET:
<span class="nc" id="L252">                return new PrometheusTableControlKeySet(this);</span>
            case DATAKEYSET:
<span class="nc" id="L254">                return new PrometheusTableDataKeySet(this);</span>
            default:
<span class="nc" id="L256">                throw new IllegalArgumentException(pListType.toString());</span>
        }
    }

    /**
     * Obtain the Driver.
     *
     * @return the driver
     */
    protected PrometheusJDBCDriver getDriver() {
<span class="nc" id="L266">        return theDriver;</span>
    }

    /**
     * Access the connection.
     *
     * @return the connection
     */
    protected Connection getConn() {
<span class="nc" id="L275">        return theConn;</span>
    }

    /**
     * Add a table.
     *
     * @param pTable the Table to add
     */
    protected void addTable(final PrometheusTableDataItem&lt;?&gt; pTable) {
<span class="nc" id="L284">        pTable.getDefinition().resolveReferences(theTables);</span>
<span class="nc" id="L285">        theTables.add(pTable);</span>
<span class="nc" id="L286">    }</span>

    /**
     * Close the connection to the database rolling back any outstanding transaction.
     */
    public void close() {
        /* Ignore if no connection */
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (theConn == null) {</span>
<span class="nc" id="L294">            return;</span>
        }

        /* Protect against exceptions */
        try {
            /* Roll-back any outstanding transaction */
<span class="nc bnc" id="L300" title="All 2 branches missed.">            if (!theConn.getAutoCommit()) {</span>
<span class="nc" id="L301">                theConn.rollback();</span>
            }

            /* Loop through the tables */
<span class="nc bnc" id="L305" title="All 2 branches missed.">            for (PrometheusTableDataItem&lt;?&gt; myTable : theTables) {</span>
                /* Close the Statement */
<span class="nc" id="L307">                myTable.closeStmt();</span>
<span class="nc" id="L308">            }</span>

            /* Close the connection */
<span class="nc" id="L311">            theConn.close();</span>
<span class="nc" id="L312">            theConn = null;</span>

            /* Discard Exceptions */
<span class="nc" id="L315">        } catch (SQLException e) {</span>
<span class="nc" id="L316">            LOGGER.error(&quot;Failed to close database connection&quot;, e);</span>
<span class="nc" id="L317">            theConn = null;</span>
<span class="nc" id="L318">        }</span>
<span class="nc" id="L319">    }</span>

    /**
     * Load data from the database.
     *
     * @param pReport the report
     * @param pData   the new DataSet
     * @throws OceanusException on error
     */
    public void loadDatabase(final TethysUIThreadStatusReport pReport,
                             final PrometheusDataSet pData) throws OceanusException {
        /* Initialise task */
<span class="nc" id="L331">        pReport.initTask(&quot;loadDatabase&quot;);</span>
<span class="nc" id="L332">        pReport.setNumStages(theTables.size());</span>

        /* Obtain the active profile */
<span class="nc" id="L335">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L336">        myTask = myTask.startTask(&quot;loadDatabase&quot;);</span>

        /* Loop through the tables */
<span class="nc bnc" id="L339" title="All 2 branches missed.">        for (PrometheusTableDataItem&lt;?&gt; myTable : theTables) {</span>
            /* Note the new step */
<span class="nc" id="L341">            myTask.startTask(myTable.getTableName());</span>

            /* Load the items */
<span class="nc" id="L344">            myTable.loadItems(pReport, pData);</span>
<span class="nc" id="L345">        }</span>

        /* Complete the task */
<span class="nc" id="L348">        myTask.end();</span>
<span class="nc" id="L349">    }</span>

    /**
     * Update data into database.
     *
     * @param pReport the report
     * @param pData   the data
     * @throws OceanusException on error
     */
    public void updateDatabase(final TethysUIThreadStatusReport pReport,
                               final PrometheusDataSet pData) throws OceanusException {
        /* Set the number of stages */
<span class="nc" id="L361">        final PrometheusBatchControl myBatch = new PrometheusBatchControl(theBatchSize);</span>
<span class="nc" id="L362">        pReport.setNumStages(NUM_STEPS_PER_TABLE * theTables.size());</span>

        /* Obtain the active profile */
<span class="nc" id="L365">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L366">        myTask = myTask.startTask(&quot;updateDatabase&quot;);</span>

        /* Loop through the tables */
<span class="nc" id="L369">        OceanusProfile myStage = myTask.startTask(&quot;insertData&quot;);</span>
<span class="nc" id="L370">        final Iterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myIterator = theTables.iterator();</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L372">            final PrometheusTableDataItem&lt;?&gt; myTable = myIterator.next();</span>

            /* Note the new step */
<span class="nc" id="L375">            myStage.startTask(myTable.getTableName());</span>

            /* insert the items */
<span class="nc" id="L378">            myTable.insertItems(pReport, pData, myBatch);</span>
<span class="nc" id="L379">        }</span>

        /* Loop through the tables */
<span class="nc" id="L382">        myStage = myTask.startTask(&quot;updateData&quot;);</span>
<span class="nc" id="L383">        final ListIterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myListIterator = theTables.listIterator();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">        while (myListIterator.hasNext()) {</span>
<span class="nc" id="L385">            final PrometheusTableDataItem&lt;?&gt; myTable = myListIterator.next();</span>

            /* Note the new step */
<span class="nc" id="L388">            myStage.startTask(myTable.getTableName());</span>

            /* Load the items */
<span class="nc" id="L391">            myTable.updateItems(pReport, myBatch);</span>
<span class="nc" id="L392">        }</span>

        /* Loop through the tables in reverse order */
<span class="nc" id="L395">        myStage = myTask.startTask(&quot;deleteData&quot;);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">        while (myListIterator.hasPrevious()) {</span>
<span class="nc" id="L397">            final PrometheusTableDataItem&lt;?&gt; myTable = myListIterator.previous();</span>

            /* Note the new step */
<span class="nc" id="L400">            myStage.startTask(myTable.getTableName());</span>

            /* Delete items from the table */
<span class="nc" id="L403">            myTable.deleteItems(pReport, myBatch);</span>
<span class="nc" id="L404">        }</span>

        /* If we have active work in the batch */
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (myBatch.isActive()) {</span>
            /* Commit the database */
            try {
<span class="nc" id="L410">                theConn.commit();</span>
<span class="nc" id="L411">            } catch (SQLException e) {</span>
<span class="nc" id="L412">                close();</span>
<span class="nc" id="L413">                throw new PrometheusIOException(&quot;Failed to commit transaction&quot;, e);</span>
<span class="nc" id="L414">            }</span>

            /* Commit the batch */
<span class="nc" id="L417">            myBatch.commitItems();</span>
        }

        /* Complete the task */
<span class="nc" id="L421">        myTask.end();</span>
<span class="nc" id="L422">    }</span>

    /**
     * Create database.
     *
     * @param pReport   the report
     * @param pDatabase the database to create
     * @throws OceanusException on error
     */
    public void createDatabase(final TethysUIThreadStatusReport pReport,
                               final String pDatabase) throws OceanusException {
        /* Set the number of stages */
<span class="nc" id="L434">        pReport.setNumStages(2);</span>

        /* Obtain the active profile */
<span class="nc" id="L437">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L438">        myTask = myTask.startTask(&quot;dropDatabase&quot;);</span>
<span class="nc" id="L439">        executeStatement(&quot;DROP DATABASE IF EXISTS &quot; + pDatabase);</span>

        /* Create database */
<span class="nc" id="L442">        myTask = myTask.startTask(&quot;createDatabase&quot;);</span>
<span class="nc" id="L443">        executeStatement(&quot;CREATE DATABASE &quot; + pDatabase);</span>

        /* Complete the task */
<span class="nc" id="L446">        myTask.end();</span>
<span class="nc" id="L447">    }</span>

    /**
     * Create tables.
     *
     * @param pReport the report
     * @throws OceanusException on error
     */
    public void createTables(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Set the number of stages */
<span class="nc" id="L457">        pReport.setNumStages(2);</span>

        /* Drop any existing tables */
<span class="nc" id="L460">        dropTables(pReport);</span>

        /* Obtain the active profile */
<span class="nc" id="L463">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L464">        myTask = myTask.startTask(&quot;createTables&quot;);</span>

        /* Loop through the tables */
<span class="nc" id="L467">        final Iterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myIterator = theTables.iterator();</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L469">            final PrometheusTableDataItem&lt;?&gt; myTable = myIterator.next();</span>

            /* Check for cancellation */
<span class="nc" id="L472">            pReport.checkForCancellation();</span>

            /* Note the new step */
<span class="nc" id="L475">            myTask.startTask(myTable.getTableName());</span>

            /* Create the table */
<span class="nc" id="L478">            myTable.createTable();</span>
<span class="nc" id="L479">        }</span>

        /* Complete the task */
<span class="nc" id="L482">        myTask.end();</span>
<span class="nc" id="L483">    }</span>

    /**
     * Drop tables.
     *
     * @param pReport the report
     * @throws OceanusException on error
     */
    private void dropTables(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Obtain the active profile */
<span class="nc" id="L493">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L494">        myTask = myTask.startTask(&quot;dropTables&quot;);</span>

        /* Loop through the tables in reverse order */
<span class="nc" id="L497">        final ListIterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myIterator = theTables.listIterator(theTables.size());</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">        while (myIterator.hasPrevious()) {</span>
<span class="nc" id="L499">            final PrometheusTableDataItem&lt;?&gt; myTable = myIterator.previous();</span>

            /* Check for cancellation */
<span class="nc" id="L502">            pReport.checkForCancellation();</span>

            /* Note the new step */
<span class="nc" id="L505">            myTask.startTask(myTable.getTableName());</span>

            /* Drop the table */
<span class="nc" id="L508">            myTable.dropTable();</span>
<span class="nc" id="L509">        }</span>

        /* Complete the task */
<span class="nc" id="L512">        myTask.end();</span>
<span class="nc" id="L513">    }</span>

    /**
     * Purge tables.
     *
     * @param pReport the report
     * @throws OceanusException on error
     */
    public void purgeTables(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Set the number of stages */
<span class="nc" id="L523">        pReport.setNumStages(1);</span>

        /* Obtain the active profile */
<span class="nc" id="L526">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L527">        myTask = myTask.startTask(&quot;purgeTables&quot;);</span>

        /* Loop through the tables in reverse order */
<span class="nc" id="L530">        final ListIterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myIterator = theTables.listIterator(theTables.size());</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">        while (myIterator.hasPrevious()) {</span>
<span class="nc" id="L532">            final PrometheusTableDataItem&lt;?&gt; myTable = myIterator.previous();</span>

            /* Check for cancellation */
<span class="nc" id="L535">            pReport.checkForCancellation();</span>

            /* Note the new step */
<span class="nc" id="L538">            myTask.startTask(myTable.getTableName());</span>

            /* Purge the table */
<span class="nc" id="L541">            myTable.purgeTable();</span>
<span class="nc" id="L542">        }</span>

        /* Complete the task */
<span class="nc" id="L545">        myTask.end();</span>
<span class="nc" id="L546">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>