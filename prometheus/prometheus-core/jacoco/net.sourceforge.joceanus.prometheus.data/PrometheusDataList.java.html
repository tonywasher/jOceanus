<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusDataList.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.prometheus.data</a> &gt; <span class="el_source">PrometheusDataList.java</span></div><h1>PrometheusDataList.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Prometheus: Application Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.prometheus.data;

import net.sourceforge.joceanus.metis.data.MetisDataEditState;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataList;
import net.sourceforge.joceanus.metis.data.MetisDataResource;
import net.sourceforge.joceanus.metis.data.MetisDataState;
import net.sourceforge.joceanus.metis.field.MetisFieldItem;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.metis.list.MetisListIndexed;
import net.sourceforge.joceanus.metis.list.MetisListKey;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataInfoItem.PrometheusDataInfoList;
import net.sourceforge.joceanus.prometheus.data.PrometheusTableItem.PrometheusTableList;
import net.sourceforge.joceanus.prometheus.exc.PrometheusDataException;

import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * Generic implementation of a DataList for DataItems.
 * @author Tony Washer
 * @param &lt;T&gt; the item type
 */
public abstract class PrometheusDataList&lt;T extends PrometheusDataItem&gt;
        implements MetisFieldItem, MetisDataList&lt;T&gt;, PrometheusTableList&lt;T&gt; {
    /**
     * DataList interface.
     */
    public interface PrometheusDataListSet {
        /**
         * Obtain the list for a class.
         * @param &lt;L&gt; the list type
         * @param pDataType the data type
         * @param pClass the list class
         * @return the list
         */
        &lt;L extends PrometheusDataList&lt;?&gt;&gt; L getDataList(MetisListKey pDataType,
                                                        Class&lt;L&gt; pClass);

        /**
         * Does this list have the dataType?
         * @param pDataType the dataType
         * @return true/false
         */
        boolean hasDataType(MetisListKey pDataType);
    }

    /**
     * Report fields.
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc" id="L70">    private static final MetisFieldSet&lt;PrometheusDataList&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(PrometheusDataList.class);</span>

    /*
     * Declare Fields.
     */
    static {
<span class="nc" id="L76">        FIELD_DEFS.declareLocalField(MetisDataResource.LIST_SIZE, PrometheusDataList::size);</span>
<span class="nc" id="L77">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATALIST_STYLE, PrometheusDataList::getStyle);</span>
<span class="nc" id="L78">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATASET_NAME, PrometheusDataList::getDataSet);</span>
<span class="nc" id="L79">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATALIST_MAPS, PrometheusDataList::getDataMap);</span>
<span class="nc" id="L80">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATASET_VERSION, PrometheusDataList::getVersion);</span>
<span class="nc" id="L81">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATAITEM_EDITSTATE, PrometheusDataList::getEditState);</span>
<span class="nc" id="L82">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATAITEM_TYPE, PrometheusDataList::getItemType);</span>
<span class="nc" id="L83">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATAITEM_BASE, PrometheusDataList::getBaseList);</span>
<span class="nc" id="L84">    }</span>

    /**
     * The list.
     */
    private final MetisListIndexed&lt;T&gt; theList;

    /**
     * The class.
     */
    private final Class&lt;T&gt; theBaseClazz;

    /**
     * The style of the list.
     */
<span class="nc" id="L99">    private PrometheusListStyle theStyle = PrometheusListStyle.CORE;</span>

    /**
     * The edit state of the list.
     */
<span class="nc" id="L104">    private MetisDataEditState theEdit = MetisDataEditState.CLEAN;</span>

    /**
     * The DataSet.
     */
    private PrometheusDataSet theDataSet;

    /**
     * The item type.
     */
    private final MetisListKey theItemType;

    /**
     * The base list (for extracts).
     */
    private PrometheusDataList&lt;? extends PrometheusDataItem&gt; theBase;

    /**
     * DataMap.
     */
    private PrometheusDataMapItem theDataMap;

    /**
     * The version.
     */
    private int theVersion;

    /**
     * The validator.
     */
    private PrometheusDataValidator theValidator;

    /**
     * Construct a new object.
     * @param pBaseClass the class of the underlying object
     * @param pDataSet the owning dataSet
     * @param pItemType the item type
     * @param pStyle the new {@link PrometheusListStyle}
     */
    protected PrometheusDataList(final Class&lt;T&gt; pBaseClass,
                                 final PrometheusDataSet pDataSet,
                                 final MetisListKey pItemType,
<span class="nc" id="L146">                                 final PrometheusListStyle pStyle) {</span>
<span class="nc" id="L147">        theBaseClazz = pBaseClass;</span>
<span class="nc" id="L148">        theStyle = pStyle;</span>
<span class="nc" id="L149">        theItemType = pItemType;</span>
<span class="nc" id="L150">        theDataSet = pDataSet;</span>

        /* Create the list */
<span class="nc" id="L153">        theList = new MetisListIndexed&lt;&gt;();</span>
<span class="nc" id="L154">        theList.setComparator(PrometheusDataItem::compareTo);</span>
<span class="nc" id="L155">    }</span>

    /**
     * Construct a clone object.
     * @param pSource the list to clone
     */
    protected PrometheusDataList(final PrometheusDataList&lt;T&gt; pSource) {
<span class="nc" id="L162">        this(pSource.getBaseClass(), pSource.getDataSet(), pSource.getItemType(), PrometheusListStyle.COPY);</span>
<span class="nc" id="L163">        theBase = pSource;</span>
<span class="nc" id="L164">    }</span>

    @Override
    public List&lt;T&gt; getUnderlyingList() {
<span class="nc" id="L168">        return theList.getUnderlyingList();</span>
    }

    /**
     * Obtain item fields.
     * @return the item fields
     */
    public abstract MetisFieldSetDef getItemFields();

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L179">        return getDataFieldSet().getName();</span>
    }

    @Override
    public boolean add(final T pItem) {
<span class="nc" id="L184">        return theList.add(pItem);</span>
    }

    @Override
    public void add(final int pIndex,
                    final T pItem) {
<span class="nc" id="L190">        theList.add(pIndex, pItem);</span>
<span class="nc" id="L191">    }</span>

    @Override
    public boolean remove(final Object pItem) {
<span class="nc" id="L195">        return theList.remove(pItem);</span>
    }

    @Override
    public void clear() {
<span class="nc" id="L200">        theList.clear();</span>
<span class="nc" id="L201">    }</span>

    /**
     * reSort the list.
     */
    public void reSort() {
<span class="nc" id="L207">        theList.sortList();</span>
<span class="nc" id="L208">    }</span>

    @Override
    public Class&lt;T&gt; getBaseClass() {
<span class="nc" id="L212">        return theBaseClazz;</span>
    }

    /**
     * Obtain item by id.
     * @param pId the id to lookup
     * @return the item (or null if not present)
     */
    public T findItemById(final Integer pId) {
<span class="nc" id="L221">        return theList.getItemById(pId);</span>
    }

    /**
     * Should this list be included in DataXml?
     * @return true/false
     */
    public boolean includeDataXML() {
<span class="nc" id="L229">        return true;</span>
    }

    /**
     * Obtain List Name.
     * @return the ListName
     */
    public abstract String listName();

    /**
     * Get the style of the list.
     * @return the list style
     */
    public PrometheusListStyle getStyle() {
<span class="nc" id="L243">        return theStyle;</span>
    }

    /**
     * Get the type of the list.
     * @return the item type
     */
    public MetisListKey getItemType() {
<span class="nc" id="L251">        return theItemType;</span>
    }

    /**
     * Get the dataSet.
     * @return the dataSet
     */
    public PrometheusDataSet getDataSet() {
<span class="nc" id="L259">        return theDataSet;</span>
    }

    /**
     * Set the version.
     * @param pVersion the version
     */
    public void setVersion(final int pVersion) {
<span class="nc" id="L267">        theVersion = pVersion;</span>
<span class="nc" id="L268">    }</span>

    /**
     * Set the style of the list.
     * @param pStyle the list style
     */
    protected void setStyle(final PrometheusListStyle pStyle) {
<span class="nc" id="L275">        theStyle = pStyle;</span>
<span class="nc" id="L276">    }</span>

    /**
     * Get the EditState of the list.
     * @return the Edit State
     */
    public MetisDataEditState getEditState() {
<span class="nc" id="L283">        return theEdit;</span>
    }

    /**
     * Get the Version of the list.
     * @return the Version
     */
    public int getVersion() {
<span class="nc" id="L291">        return theVersion;</span>
    }

    /**
     * Get the Base of the list.
     * @return the Base list
     */
    public PrometheusDataList&lt;?&gt; getBaseList() {
<span class="nc" id="L299">        return theBase;</span>
    }

    /**
     * Obtain the DataMap.
     * @return the enumClass
     */
    protected PrometheusDataMapItem getDataMap() {
<span class="nc" id="L307">        return theDataMap;</span>
    }

    /**
     * Determine whether the list got any errors.
     * @return &lt;code&gt;true/false&lt;/code&gt;
     */
    public boolean hasErrors() {
<span class="nc bnc" id="L315" title="All 2 branches missed.">        return theEdit == MetisDataEditState.ERROR;</span>
    }

    /**
     * Determine whether the list got any updates.
     * @return &lt;code&gt;true/false&lt;/code&gt;
     */
    public boolean hasUpdates() {
        /* We have changes if version is non-zero */
<span class="nc bnc" id="L324" title="All 2 branches missed.">        return theVersion != 0;</span>
    }

    /**
     * Determine whether the list is valid (or are there errors/non-validated changes).
     * @return &lt;code&gt;true/false&lt;/code&gt;
     */
    public boolean isValid() {
<span class="nc bnc" id="L332" title="All 4 branches missed.">        return theEdit == MetisDataEditState.CLEAN</span>
                || theEdit == MetisDataEditState.VALID;
    }

    @Override
    public boolean isLocked() {
<span class="nc" id="L338">        return false;</span>
    }

    /**
     * Set the base DataList.
     * @param pBase the list that this list is based upon
     */
    protected void setBase(final PrometheusDataList&lt;? extends PrometheusDataItem&gt; pBase) {
<span class="nc" id="L346">        theBase = pBase;</span>
<span class="nc" id="L347">    }</span>

    /**
     * Obtain a copy of the Id Map.
     * @return the Id map.
     */
    public Map&lt;Integer, T&gt; copyIdMap() {
<span class="nc" id="L354">        return theList.copyIdMap();</span>
    }

    /**
     * Obtain the validator.
     * @return the validator
     */
    public PrometheusDataValidator getValidator() {
<span class="nc bnc" id="L362" title="All 2 branches missed.">        if (theValidator == null) {</span>
<span class="nc" id="L363">            theValidator = getDataSet().getValidator(theItemType);</span>
        }
<span class="nc" id="L365">        return theValidator;</span>
    }

    /**
     * Obtain an empty list based on this list.
     * @param pStyle the style of the empty list
     * @return the list
     */
    protected abstract PrometheusDataList&lt;T&gt; getEmptyList(PrometheusListStyle pStyle);

    /**
     * Derive an cloned extract of the source list.
     * @param pData the dataSet
     * @param pSource the source list
     * @throws OceanusException on error
     */
    protected void cloneList(final PrometheusDataSet pData,
                             final PrometheusDataList&lt;?&gt; pSource) throws OceanusException {
        /* Correct the dataSet reference */
<span class="nc" id="L384">        theDataSet = pData;</span>

        /* Populate the list */
<span class="nc" id="L387">        pSource.populateList(this);</span>

        /* Remove base reference and reset to CORE list */
<span class="nc" id="L390">        theBase = null;</span>
<span class="nc" id="L391">        theStyle = PrometheusListStyle.CORE;</span>
<span class="nc" id="L392">    }</span>

    /**
     * Derive an extract of this list.
     * @param pStyle the Style of the extract
     * @return the derived list
     * @throws OceanusException on error
     */
    public PrometheusDataList&lt;T&gt; deriveList(final PrometheusListStyle pStyle) throws OceanusException {
        /* Obtain an empty list of the correct style */
<span class="nc" id="L402">        final PrometheusDataList&lt;T&gt; myList = getEmptyList(pStyle);</span>

        /* Populate the list */
<span class="nc" id="L405">        populateList(myList);</span>

        /* Return the derived list */
<span class="nc" id="L408">        return myList;</span>
    }

    /**
     * Populate a list extract.
     * @param pList the list to populate
     * @throws OceanusException on error
     */
    protected void populateList(final PrometheusDataList&lt;?&gt; pList) throws OceanusException {
        /* Determine special styles */
<span class="nc" id="L418">        final PrometheusListStyle myStyle = pList.getStyle();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        final boolean isUpdate = myStyle == PrometheusListStyle.UPDATE;</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">        final boolean isClone = myStyle == PrometheusListStyle.CLONE;</span>

        /* Create an iterator for all items in the list */
<span class="nc" id="L423">        final Iterator&lt;? extends PrometheusDataItem&gt; myIterator = iterator();</span>

        /* Loop through the list */
<span class="nc bnc" id="L426" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
            /* Access the item and its state */
<span class="nc" id="L428">            final PrometheusDataItem myCurr = myIterator.next();</span>
<span class="nc" id="L429">            final MetisDataState myState = myCurr.getState();</span>

            /* If this is an UPDATE list, ignore clean elements */
<span class="nc bnc" id="L432" title="All 4 branches missed.">            if (isUpdate &amp;&amp; myState == MetisDataState.CLEAN) {</span>
<span class="nc" id="L433">                continue;</span>
            }

            /* Copy the item */
<span class="nc" id="L437">            pList.addCopyItem(myCurr);</span>
<span class="nc" id="L438">        }</span>

        /* If this is a Clone list */
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (isClone) {</span>
            /* Adjust the links */
<span class="nc" id="L443">            pList.resolveDataSetLinks();</span>
        }
<span class="nc" id="L445">    }</span>

    /**
     * Adjust links.
     * @throws OceanusException on error
     */
    public void resolveDataSetLinks() throws OceanusException {
        /* Loop through the list */
<span class="nc" id="L453">        final Iterator&lt;? extends PrometheusDataItem&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
            /* Access the item */
<span class="nc" id="L456">            final PrometheusDataItem myCurr = myIterator.next();</span>

            /* Adjust the links */
<span class="nc" id="L459">            myCurr.resolveDataSetLinks();</span>
<span class="nc" id="L460">        }</span>
<span class="nc" id="L461">    }</span>

    /**
     * Construct a difference extract between two DataLists. The difference extract will only have
     * items that differ between the two lists. Items that are in the new list, but not in the old
     * list will be viewed as inserted. Items that are in the old list but not in the new list will
     * be viewed as deleted. Items that are in both list but differ will be viewed as changed
     * @param pDataSet the difference DataSet
     * @param pOld The old list to compare to
     * @return the difference list
     */
    public PrometheusDataList&lt;T&gt; deriveDifferences(final PrometheusDataSet pDataSet,
                                                   final PrometheusDataList&lt;?&gt; pOld) {
        /* Obtain an empty list of the correct style */
<span class="nc" id="L475">        final PrometheusDataList&lt;T&gt; myList = getEmptyList(PrometheusListStyle.DIFFER);</span>
<span class="nc" id="L476">        myList.theDataSet = pDataSet;</span>

        /* Access an Id Map of the old list */
<span class="nc" id="L479">        final Map&lt;Integer, ?&gt; myOld = pOld.copyIdMap();</span>

        /* Loop through the new list */
<span class="nc" id="L482">        final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
            /* Locate the item in the old list */
<span class="nc" id="L485">            final PrometheusDataItem myCurr = myIterator.next();</span>
<span class="nc" id="L486">            PrometheusDataItem myItem = (PrometheusDataItem) myOld.get(myCurr.getIndexedId());</span>

            /* If the item does not exist in the old list */
<span class="nc bnc" id="L489" title="All 2 branches missed.">            if (myItem == null) {</span>
                /* Insert a new item */
<span class="nc" id="L491">                myItem = myList.addCopyItem(myCurr);</span>
<span class="nc" id="L492">                myItem.setNewVersion();</span>

                /* else the item exists in the old list */
            } else {
                /* If the item has changed */
<span class="nc bnc" id="L497" title="All 2 branches missed.">                if (!myCurr.equals(myItem)) {</span>
                    /* Copy the item */
<span class="nc" id="L499">                    final PrometheusDataItem myNew = myList.addCopyItem(myCurr);</span>
<span class="nc" id="L500">                    myNew.setBase(myItem);</span>

                    /* Ensure that we record the correct history */
<span class="nc" id="L503">                    myNew.setHistory(myItem);</span>
                }

                /* Remove the item from the map */
<span class="nc" id="L507">                myOld.remove(myItem.getIndexedId());</span>
            }
<span class="nc" id="L509">        }</span>

        /* Loop through the remaining items in the old list */
<span class="nc" id="L512">        final Iterator&lt;?&gt; myOldIterator = myOld.values().iterator();</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">        while (myOldIterator.hasNext()) {</span>
            /* Insert a new item */
<span class="nc" id="L515">            final PrometheusDataItem myCurr = (PrometheusDataItem) myOldIterator.next();</span>
<span class="nc" id="L516">            final PrometheusDataItem myItem = myList.addCopyItem(myCurr);</span>
<span class="nc" id="L517">            myItem.setBase(null);</span>
<span class="nc" id="L518">            myItem.setDeleted(true);</span>
<span class="nc" id="L519">        }</span>

        /* Return the difference list */
<span class="nc" id="L522">        return myList;</span>
    }

    /**
     * Re-base the list against a database image. This method is used to re-synchronise between two
     * sources. Items that are in this list, but not in the base list will be viewed as inserted.
     * Items that are in the base list but not in this list list will be viewed as deleted. Items
     * that are in both list but differ will be viewed as changed
     * @param pBase The base list to re-base on
     * @return are there any changes
     */
    public boolean reBase(final PrometheusDataList&lt;?&gt; pBase) {
        /* Access an Id Map of the old list */
<span class="nc" id="L535">        final Map&lt;Integer, ?&gt; myBase = pBase.copyIdMap();</span>
<span class="nc" id="L536">        boolean bChanges = false;</span>

        /* Loop through this list */
<span class="nc" id="L539">        final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
            /* Locate the item in the base list */
<span class="nc" id="L542">            final T myCurr = myIterator.next();</span>
<span class="nc" id="L543">            final PrometheusDataItem myItem = (PrometheusDataItem) myBase.get(myCurr.getIndexedId());</span>

            /* If the underlying item does not exist */
<span class="nc bnc" id="L546" title="All 2 branches missed.">            if (myItem == null) {</span>
                /* Mark this as a new item */
<span class="nc" id="L548">                myCurr.getValues().setVersion(getVersion() + 1);</span>
<span class="nc" id="L549">                myCurr.setBase(null);</span>
<span class="nc" id="L550">                bChanges = true;</span>

                /* else the item exists in the old list */
            } else {
                /* if it has changed */
<span class="nc bnc" id="L555" title="All 2 branches missed.">                if (!myCurr.equals(myItem)) {</span>
                    /* Set correct history */
<span class="nc" id="L557">                    myCurr.setHistory(myItem);</span>
<span class="nc" id="L558">                    myCurr.setBase(null);</span>
<span class="nc" id="L559">                    bChanges = true;</span>

                    /* else it is identical */
                } else {
                    /* Mark this as a clean item */
<span class="nc" id="L564">                    myCurr.clearHistory();</span>
<span class="nc" id="L565">                    myCurr.setBase(null);</span>
                }

                /* Remove the old item */
<span class="nc" id="L569">                myBase.remove(myItem.getIndexedId());</span>
            }
<span class="nc" id="L571">        }</span>

        /* Loop through the remaining items in the base list */
<span class="nc" id="L574">        final Iterator&lt;?&gt; myBaseIterator = myBase.values().iterator();</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">        while (myBaseIterator.hasNext()) {</span>
            /* Insert a new item */
<span class="nc" id="L577">            final PrometheusDataItem myCurr = (PrometheusDataItem) myBaseIterator.next();</span>
<span class="nc" id="L578">            final T myItem = addCopyItem(myCurr);</span>
<span class="nc" id="L579">            myItem.setBase(null);</span>
<span class="nc" id="L580">            myItem.setHistory(myCurr);</span>
<span class="nc" id="L581">            myItem.getValues().setDeletion(true);</span>
<span class="nc" id="L582">            bChanges = true;</span>
<span class="nc" id="L583">        }</span>

        /* Return flag */
<span class="nc" id="L586">        return bChanges;</span>
    }

    /**
     * Is the Id unique in this list.
     * @param uId the Id to check
     * @return Whether the id is unique &lt;code&gt;true/false&lt;/code&gt;
     */
    public boolean isIdUnique(final Integer uId) {
        /* Its unique if its unassigned or greater than the max id */
<span class="nc bnc" id="L596" title="All 2 branches missed.">        if (uId == null</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                || uId == 0</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                || uId &gt; theList.getNextId()) {</span>
<span class="nc" id="L599">            return true;</span>
        }

        /* Check in list */
<span class="nc bnc" id="L603" title="All 2 branches missed.">        return !theList.containsId(uId);</span>
    }

    /**
     * Generate/Record new id for the item.
     * @param pItem the new item
     */
    protected void setNewId(final PrometheusDataItem pItem) {
        /* Access the Id */
<span class="nc" id="L612">        final Integer myId = pItem.getIndexedId();</span>

        /* If we need to generate a new id */
<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (myId == null</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                || myId == 0) {</span>
            /* Obtain the next Id */
<span class="nc" id="L618">            pItem.setIndexedId(theList.allocateNextId());</span>
        }
<span class="nc" id="L620">    }</span>

    /**
     * Touch underlying items that are referenced by items in this list.
     */
    public void touchUnderlyingItems() {
        /* Loop through items in the list */
<span class="nc" id="L627">        final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L629">            final T myItem = myIterator.next();</span>

            /* If the item is not deleted */
<span class="nc bnc" id="L632" title="All 2 branches missed.">            if (!myItem.isDeleted()) {</span>
                /* Touch underlying items */
<span class="nc" id="L634">                myItem.touchUnderlyingItems();</span>
            }
<span class="nc" id="L636">        }</span>
<span class="nc" id="L637">    }</span>

    /**
     * Set the EditState for the list (forcible on error/change).
     * @param pState the new {@link MetisDataEditState} (only ERROR/DIRTY)
     */
    public void setEditState(final MetisDataEditState pState) {
<span class="nc bnc" id="L644" title="All 3 branches missed.">        switch (pState) {</span>
            case CLEAN:
            case VALID:
            case ERROR:
<span class="nc" id="L648">                theEdit = pState;</span>
<span class="nc" id="L649">                break;</span>
            case DIRTY:
<span class="nc bnc" id="L651" title="All 2 branches missed.">                if (theEdit != MetisDataEditState.ERROR) {</span>
<span class="nc" id="L652">                    theEdit = pState;</span>
                }
                break;
            default:
                break;
        }
<span class="nc" id="L658">    }</span>

    /**
     * Validate the data items.
     * @return the error list (or null if no errors)
     */
    public PrometheusDataErrorList validate() {
        /* Allocate error list */
<span class="nc" id="L666">        PrometheusDataErrorList myErrors = null;</span>
<span class="nc" id="L667">        MetisDataEditState myState = MetisDataEditState.CLEAN;</span>

        /* Loop through the items */
<span class="nc" id="L670">        final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L672">            final T myCurr = myIterator.next();</span>

            /* Clear errors for the item */
<span class="nc" id="L675">            myCurr.clearErrors();</span>

            /* Skip deleted items */
<span class="nc bnc" id="L678" title="All 2 branches missed.">            if (myCurr.isDeleted()) {</span>
<span class="nc" id="L679">                myCurr.setValidEdit();</span>
<span class="nc" id="L680">                myState = myState.combineState(MetisDataEditState.VALID);</span>
<span class="nc" id="L681">                continue;</span>
            }

            /* Validate the item and build up the state */
<span class="nc" id="L685">            myCurr.validate();</span>
<span class="nc" id="L686">            myState = myState.combineState(myCurr.getEditState());</span>

            /* If the item is in error */
<span class="nc bnc" id="L689" title="All 2 branches missed.">            if (myCurr.hasErrors()) {</span>
                /* If this is the first error */
<span class="nc bnc" id="L691" title="All 2 branches missed.">                if (myErrors == null) {</span>
                    /* Allocate error list */
<span class="nc" id="L693">                    myErrors = new PrometheusDataErrorList();</span>
                }

                /* Add to the error list */
<span class="nc" id="L697">                myErrors.add(myCurr);</span>
            }
<span class="nc" id="L699">        }</span>

        /* Store the edit state */
<span class="nc" id="L702">        theEdit = myState;</span>

        /* Return the errors */
<span class="nc" id="L705">        return myErrors;</span>
    }

    /**
     * Perform a validation on data load.
     * @throws OceanusException on error
     */
    public void validateOnLoad() throws OceanusException {
        /* Validate the list */
<span class="nc" id="L714">        final PrometheusDataErrorList myErrors = validate();</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (myErrors != null) {</span>
<span class="nc" id="L716">            throw new PrometheusDataException(myErrors, PrometheusDataItem.ERROR_VALIDATION);</span>
        }
<span class="nc" id="L718">    }</span>

    /**
     * Allocate the dataMap.
     * @return the dataMap
     */
    protected abstract PrometheusDataMapItem allocateDataMap();

    /**
     * Set map.
     * @param pMap the map
     */
    protected void setDataMap(final PrometheusDataMapItem pMap) {
<span class="nc" id="L731">        theDataMap = pMap;</span>
<span class="nc" id="L732">    }</span>

    /**
     * Ensure map.
     */
    public void ensureMap() {
        /* Allocate/Reset the map */
<span class="nc bnc" id="L739" title="All 2 branches missed.">        if (theDataMap == null) {</span>
<span class="nc" id="L740">            theDataMap = allocateDataMap();</span>
        } else {
<span class="nc" id="L742">            theDataMap.resetMap();</span>
        }
<span class="nc" id="L744">    }</span>

    /**
     * Build map of the data.
     */
    public void mapData() {
        /* Ensure the map */
<span class="nc" id="L751">        ensureMap();</span>

        /* Loop through the items */
<span class="nc" id="L754">        final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L756">            final T myItem = myIterator.next();</span>

            /* If the item is not deleted */
<span class="nc bnc" id="L759" title="All 2 branches missed.">            if (!myItem.isDeleted()) {</span>
                /* Map the item */
<span class="nc" id="L761">                myItem.touchUnderlyingItems();</span>
<span class="nc" id="L762">                theDataMap.adjustForItem(myItem);</span>
            }
<span class="nc" id="L764">        }</span>
<span class="nc" id="L765">    }</span>

    /**
     * PostProcess a loaded list.
     * @throws OceanusException on error
     */
    public void postProcessOnLoad() throws OceanusException {
        /* Default action is to resolve links and then sort */
<span class="nc" id="L773">        resolveDataSetLinks();</span>
<span class="nc" id="L774">        theList.sortList();</span>

        /* Map the data */
<span class="nc" id="L777">        mapData();</span>

        /* Now validate the list */
<span class="nc" id="L780">        validateOnLoad();</span>
<span class="nc" id="L781">    }</span>

    /**
     * Update Maps.
     */
    public void updateMaps() {
        /* Ensure the map */
<span class="nc" id="L788">        ensureMap();</span>

        /* Loop through items clearing active flag */
<span class="nc" id="L791">        final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L793">            final T myItem = myIterator.next();</span>

            /* If the item is not deleted */
<span class="nc bnc" id="L796" title="All 2 branches missed.">            if (!myItem.isDeleted()) {</span>
                /* Update Maps */
<span class="nc" id="L798">                myItem.updateMaps();</span>
            }
<span class="nc" id="L800">        }</span>
<span class="nc" id="L801">    }</span>

    /**
     * postProcessOnUpdate.
     */
    public void postProcessOnUpdate() {
        /* Note whether this is a DataInfoList */
<span class="nc" id="L808">        final boolean isDataInfo = this instanceof PrometheusDataInfoList;</span>

        /* Reset the map */
<span class="nc bnc" id="L811" title="All 2 branches missed.">        if (theDataMap != null) {</span>
<span class="nc" id="L812">            theDataMap.resetMap();</span>
        }

        /* Loop through items clearing active flag */
<span class="nc" id="L816">        final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc" id="L817">        MetisDataEditState myState = MetisDataEditState.CLEAN;</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L819">            final T myCurr = myIterator.next();</span>

            /* Clear errors for the item */
<span class="nc" id="L822">            myCurr.clearErrors();</span>

            /* Skip deleted items */
<span class="nc bnc" id="L825" title="All 2 branches missed.">            if (myCurr.isDeleted()) {</span>
<span class="nc" id="L826">                myCurr.setValidEdit();</span>
<span class="nc" id="L827">                myState = myState.combineState(MetisDataEditState.VALID);</span>
<span class="nc" id="L828">                continue;</span>
            }

            /* If this is not a DataInfo */
<span class="nc bnc" id="L832" title="All 2 branches missed.">            if (!isDataInfo) {</span>
                /* Adjust touches and update map */
<span class="nc" id="L834">                myCurr.touchOnUpdate();</span>
<span class="nc" id="L835">                myCurr.adjustMapForItem();</span>
            }

            /* Validate the item and build up the state */
<span class="nc" id="L839">            myCurr.validate();</span>
<span class="nc" id="L840">            myState = myState.combineState(myCurr.getEditState());</span>
<span class="nc" id="L841">        }</span>

        /* Store the edit state */
<span class="nc" id="L844">        theEdit = myState;</span>
<span class="nc" id="L845">    }</span>

    /**
     * Create a new element in the list copied from another element (to be over-written).
     * @param pElement - element to base new item on
     * @return the newly allocated item
     */
    public abstract T addCopyItem(PrometheusDataItem pElement);

    /**
     * Create a new empty element in the edit list (to be over-written).
     * @return the newly allocated item
     */
    public abstract T addNewItem();

    /**
     * Create a new element according to the DataValues.
     * @param pValues the data values
     * @return the newly allocated item
     * @throws OceanusException on error
     */
    public abstract T addValuesItem(PrometheusDataValues pValues) throws OceanusException;

    /**
     * Locate an item by name (if possible).
     * @param pName the name of the item
     * @return the matching item
     */
    public T findItemByName(final String pName) {
<span class="nc" id="L874">        return null;</span>
    }

    /**
     * Rewind items to the required version.
     * @param pVersion the version to rewind to
     */
    public void rewindToVersion(final int pVersion) {
        /* Loop through the elements */
<span class="nc" id="L883">        final Iterator&lt;T&gt; myIterator = theList.iterator();</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L885">            final T myCurr = myIterator.next();</span>

            /* If the version is before required version */
<span class="nc bnc" id="L888" title="All 2 branches missed.">            if (myCurr.getValues().getVersion() &lt;= pVersion) {</span>
                /* Ignore */
<span class="nc" id="L890">                continue;</span>
            }

            /* If the item was created after the required version */
<span class="nc bnc" id="L894" title="All 2 branches missed.">            if (myCurr.getOriginalValues().getVersion() &gt; pVersion) {</span>
                /* Remove from list */
<span class="nc" id="L896">                myIterator.remove();</span>
<span class="nc" id="L897">                myCurr.deRegister();</span>

                /* Re-Loop */
<span class="nc" id="L900">                continue;</span>
            }

            /* Adjust values */
<span class="nc" id="L904">            myCurr.rewindToVersion(pVersion);</span>
<span class="nc" id="L905">        }</span>

        /* Adjust list value */
<span class="nc" id="L908">        setVersion(pVersion);</span>

        /* ReSort the list unless we are an edit list */
<span class="nc bnc" id="L911" title="All 2 branches missed.">        if (theStyle != PrometheusListStyle.EDIT) {</span>
<span class="nc" id="L912">            theList.sortList();</span>
        }
<span class="nc" id="L914">    }</span>

    /**
     * Condense history.
     * @param pNewVersion the new maximum version
     */
    public void condenseHistory(final int pNewVersion) {
        /* Loop through the elements */
<span class="nc" id="L922">        final Iterator&lt;T&gt; myIterator = theList.iterator();</span>
<span class="nc bnc" id="L923" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L924">            final T myCurr = myIterator.next();</span>

            /* If the version is before required version */
<span class="nc bnc" id="L927" title="All 2 branches missed.">            if (myCurr.getValues().getVersion() &lt; pNewVersion) {</span>
                /* Ignore */
<span class="nc" id="L929">                continue;</span>
            }

            /* If the item is in DELNEW state */
<span class="nc bnc" id="L933" title="All 2 branches missed.">            if (myCurr.isDeleted()</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">                    &amp;&amp; (myCurr.getOriginalValues().getVersion() &gt;= pNewVersion)) {</span>
                /* Remove from list */
<span class="nc" id="L936">                myIterator.remove();</span>
<span class="nc" id="L937">                myCurr.deRegister();</span>

                /* Re-Loop */
<span class="nc" id="L940">                continue;</span>
            }

            /* Condense the history */
<span class="nc" id="L944">            myCurr.condenseHistory(pNewVersion);</span>
<span class="nc" id="L945">        }</span>

        /* Adjust list value */
<span class="nc" id="L948">        setVersion(pNewVersion);</span>
<span class="nc" id="L949">    }</span>

    /**
     * ListStyles.
     */
<span class="nc" id="L954">    public enum PrometheusListStyle {</span>
        /**
         * Core list holding the true version of the data.
         */
<span class="nc" id="L958">        CORE,</span>

        /**
         * Deep Copy clone for security updates.
         */
<span class="nc" id="L963">        CLONE,</span>

        /**
         * Shallow Copy list for comparison purposes. Only references to other items can be added to
         * the list
         */
<span class="nc" id="L969">        COPY,</span>

        /**
         * Partial extract of the data for the purposes of editing.
         */
<span class="nc" id="L974">        EDIT,</span>

        /**
         * List of changes to be applied to database.
         */
<span class="nc" id="L979">        UPDATE,</span>

        /**
         * List of differences.
         */
<span class="nc" id="L984">        DIFFER;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>