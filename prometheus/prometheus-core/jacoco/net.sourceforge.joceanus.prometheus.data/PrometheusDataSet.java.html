<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusDataSet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.prometheus.data</a> &gt; <span class="el_source">PrometheusDataSet.java</span></div><h1>PrometheusDataSet.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Prometheus: Application Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.prometheus.data;

import net.sourceforge.joceanus.gordianknot.api.factory.GordianFactory.GordianFactoryLock;
import net.sourceforge.joceanus.gordianknot.api.keyset.GordianKeySetSpec;
import net.sourceforge.joceanus.metis.data.MetisDataFieldValue;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.metis.field.MetisFieldItem;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.metis.field.MetisFieldVersionedItem;
import net.sourceforge.joceanus.metis.list.MetisListKey;
import net.sourceforge.joceanus.metis.toolkit.MetisToolkit;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.oceanus.profile.OceanusProfile;
import net.sourceforge.joceanus.prometheus.data.PrometheusControlData.PrometheusControlDataList;
import net.sourceforge.joceanus.prometheus.data.PrometheusControlKey.PrometheusControlKeyList;
import net.sourceforge.joceanus.prometheus.data.PrometheusControlKeySet.PrometheusControlKeySetList;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataKeySet.PrometheusDataKeySetList;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataList.PrometheusDataListSet;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataList.PrometheusListStyle;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataValidator.PrometheusDataValidatorFactory;
import net.sourceforge.joceanus.prometheus.data.PrometheusEncryptedDataItem.PrometheusEncryptedList;
import net.sourceforge.joceanus.prometheus.preference.PrometheusPreferenceManager;
import net.sourceforge.joceanus.prometheus.preference.PrometheusPreferenceSecurity.PrometheusSecurityPreferenceKey;
import net.sourceforge.joceanus.prometheus.preference.PrometheusPreferenceSecurity.PrometheusSecurityPreferences;
import net.sourceforge.joceanus.prometheus.security.PrometheusSecurityPasswordManager;
import net.sourceforge.joceanus.prometheus.toolkit.PrometheusToolkit;
import net.sourceforge.joceanus.tethys.api.thread.TethysUIThreadStatusReport;

import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Map.Entry;

/**
 * DataSet definition and list. A DataSet is a set of DataLists backed by the three security lists.
 */
public abstract class PrometheusDataSet
        implements MetisFieldItem, PrometheusDataListSet {
    /**
     * The Hash prime.
     */
    protected static final int HASH_PRIME = 19;

    /**
     * Report fields.
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc" id="L65">    private static final MetisFieldSet&lt;PrometheusDataSet&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(PrometheusDataSet.class);</span>

    /*
     * Declare Fields.
     */
    static {
<span class="nc" id="L71">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATASET_VERSION, PrometheusDataSet::getVersion);</span>
<span class="nc" id="L72">        FIELD_DEFS.declareLocalFieldsForEnum(PrometheusCryptographyDataType.class, PrometheusDataSet::getFieldListValue);</span>
    }

    /**
     * SecurityInit Task.
     */
<span class="nc" id="L78">    private static final String TASK_SECINIT = PrometheusDataResource.TASK_SECURITY_INIT.getValue();</span>

    /**
     * SecurityCheck Task.
     */
<span class="nc" id="L83">    private static final String TASK_SECCHECK = PrometheusDataResource.TASK_SECURITY_CHECK.getValue();</span>

    /**
     * SecurityUpdate Task.
     */
<span class="nc" id="L88">    private static final String TASK_SECUPDATE = PrometheusDataResource.TASK_SECURITY_UPDATE.getValue();</span>

    /**
     * SecurityReNew Task.
     */
<span class="nc" id="L93">    private static final String TASK_SECRENEW = PrometheusDataResource.TASK_SECURITY_RENEW.getValue();</span>

    /**
     * DataReBase Task.
     */
<span class="nc" id="L98">    private static final String TASK_DATAREBASE = PrometheusDataResource.TASK_DATA_REBASE.getValue();</span>

    /**
     * DataDiff Task.
     */
<span class="nc" id="L103">    private static final String TASK_DATADIFF = PrometheusDataResource.TASK_DATA_DIFF.getValue();</span>

    /**
     * Password Manager.
     */
    private final PrometheusSecurityPasswordManager thePasswordMgr;

    /**
     * KeySetSpec.
     */
    private final GordianKeySetSpec theKeySetSpec;

    /**
     * Number of activeKeySets.
     */
    private final int theNumActiveKeySets;

    /**
     * Number of encrypted lists.
     */
    private int theNumEncrypted;

    /**
     * Version of dataSet.
     */
    private int theVersion;

    /**
     * The DataList Map.
     */
    private final Map&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; theListMap;

    /**
     * General formatter.
     */
    private final OceanusDataFormatter theFormatter;

    /**
     * Validator factory.
     */
    private PrometheusDataValidatorFactory theValidatorFactory;

    /**
     * Constructor for new empty DataSet.
     * @param pToolkit the toolkit set
     */
<span class="nc" id="L149">    protected PrometheusDataSet(final PrometheusToolkit pToolkit) {</span>
        /* Store the password manager and Enum class */
<span class="nc" id="L151">        thePasswordMgr = pToolkit.getPasswordManager();</span>
<span class="nc" id="L152">        theKeySetSpec = thePasswordMgr.getLockSpec().getKeySetSpec();</span>

        /* Access the SecurityPreferences */
<span class="nc" id="L155">        final PrometheusPreferenceManager myPrefMgr = pToolkit.getPreferenceManager();</span>
<span class="nc" id="L156">        final PrometheusSecurityPreferences mySecPreferences = myPrefMgr.getPreferenceSet(PrometheusSecurityPreferences.class);</span>
<span class="nc" id="L157">        theNumActiveKeySets = mySecPreferences.getIntegerValue(PrometheusSecurityPreferenceKey.ACTIVEKEYSETS);</span>

        /* Create the map of additional DataLists */
<span class="nc" id="L160">        theListMap = new LinkedHashMap&lt;&gt;();</span>

        /* Loop through the list types */
<span class="nc bnc" id="L163" title="All 2 branches missed.">        for (PrometheusCryptographyDataType myType : PrometheusCryptographyDataType.values()) {</span>
            /* Create the empty list */
<span class="nc" id="L165">            addList(myType, newList(myType));</span>
        }

        /* record formatter */
<span class="nc" id="L169">        final MetisToolkit myToolkit = pToolkit.getToolkit();</span>
<span class="nc" id="L170">        theFormatter = myToolkit.getFormatter();</span>
<span class="nc" id="L171">    }</span>

    /**
     * Constructor for a cloned DataSet.
     * @param pSource the source DataSet
     */
<span class="nc" id="L177">    protected PrometheusDataSet(final PrometheusDataSet pSource) {</span>

        /* Access the #activeKeySets */
<span class="nc" id="L180">        theNumActiveKeySets = pSource.getNumActiveKeySets();</span>

        /* Store the password manager */
<span class="nc" id="L183">        thePasswordMgr = pSource.getPasswordMgr();</span>

        /* Store the keySetSpec */
<span class="nc" id="L186">        theKeySetSpec = pSource.getKeySetSpec();</span>

        /* Create the map of additional DataLists */
<span class="nc" id="L189">        theListMap = new LinkedHashMap&lt;&gt;();</span>

        /* Copy formatter */
<span class="nc" id="L192">        theFormatter = pSource.getDataFormatter();</span>

        /* Copy validator factory */
<span class="nc" id="L195">        theValidatorFactory = pSource.theValidatorFactory;</span>
<span class="nc" id="L196">    }</span>

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L200">        return PrometheusDataSet.class.getSimpleName();</span>
    }

    /**
     * Obtain the data formatter.
     * @return the formatter
     */
    public OceanusDataFormatter getDataFormatter() {
<span class="nc" id="L208">        return theFormatter;</span>
    }

    /**
     * Set the validator factory.
     * @param pFactory the validator factory
     */
    public void setValidatorFactory(final PrometheusDataValidatorFactory pFactory) {
<span class="nc" id="L216">        theValidatorFactory = pFactory;</span>
<span class="nc" id="L217">    }</span>

    /**
     * Obtain a validator fot=r the itemType.
     * @param pItemType the itemType
     * @return the validator.
     */
    PrometheusDataValidator getValidator(final MetisListKey pItemType) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (theValidatorFactory == null) {</span>
<span class="nc" id="L226">            throw new IllegalStateException(&quot;Validator factory not set&quot;);</span>
        }
<span class="nc" id="L228">        return theValidatorFactory.newValidator(pItemType);</span>
    }

    /**
     * Get Password Manager.
     * @return the password manager
     */
    public PrometheusSecurityPasswordManager getPasswordMgr() {
<span class="nc" id="L236">        return thePasswordMgr;</span>
    }

    /**
     * Get ControlKeys.
     * @return the controlKeys
     */
    public PrometheusControlKeyList getControlKeys() {
<span class="nc" id="L244">        return getDataList(PrometheusCryptographyDataType.CONTROLKEY, PrometheusControlKeyList.class);</span>
    }

    /**
     * Get ControlKeySets.
     * @return the controlKeySets
     */
    public PrometheusControlKeySetList getControlKeySets() {
<span class="nc" id="L252">        return getDataList(PrometheusCryptographyDataType.CONTROLKEYSET, PrometheusControlKeySetList.class);</span>
    }

    /**
     * Get DataKeySets.
     * @return the dataKeySets
     */
    public PrometheusDataKeySetList getDataKeySets() {
<span class="nc" id="L260">        return getDataList(PrometheusCryptographyDataType.DATAKEYSET, PrometheusDataKeySetList.class);</span>
    }

    /**
     * Get ControlData.
     * @return the controlData
     */
    public PrometheusControlDataList getControlData() {
<span class="nc" id="L268">        return getDataList(PrometheusCryptographyDataType.CONTROLDATA, PrometheusControlDataList.class);</span>
    }

    /**
     * Get Version.
     * @return the version
     */
    public int getVersion() {
<span class="nc" id="L276">        return theVersion;</span>
    }

    /**
     * Get Number of activeKeySets.
     * @return the # active KeySets
     */
    public int getNumActiveKeySets() {
<span class="nc" id="L284">        return theNumActiveKeySets;</span>
    }

    /**
     * Get KeySetSpec.
     * @return the keySetSpec
     */
    public GordianKeySetSpec getKeySetSpec() {
<span class="nc" id="L292">        return theKeySetSpec;</span>
    }

    /**
     * Get List Map.
     * @return the list map
     */
    protected Map&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; getListMap() {
<span class="nc" id="L300">        return theListMap;</span>
    }

    @Override
    public boolean hasDataType(final MetisListKey pDataType) {
<span class="nc" id="L305">        return theListMap.containsKey(pDataType);</span>
    }

    /**
     * Construct a Clone for a DataSet.
     * @return the extract
     * @throws OceanusException on error
     */
    public abstract PrometheusDataSet deriveCloneSet() throws OceanusException;

    /**
     * Create new list of required type.
     * @param pListType the list type
     * @return the new list
     */
    private PrometheusDataList&lt;?&gt; newList(final PrometheusCryptographyDataType pListType) {
        /* Switch on list Type */
<span class="nc bnc" id="L322" title="All 5 branches missed.">        switch (pListType) {</span>
            case CONTROLDATA:
<span class="nc" id="L324">                return new PrometheusControlDataList(this);</span>
            case CONTROLKEY:
<span class="nc" id="L326">                return new PrometheusControlKeyList(this);</span>
            case CONTROLKEYSET:
<span class="nc" id="L328">                return new PrometheusControlKeySetList(this);</span>
            case DATAKEYSET:
<span class="nc" id="L330">                return new PrometheusDataKeySetList(this);</span>
            default:
<span class="nc" id="L332">                throw new IllegalArgumentException(pListType.toString());</span>
        }
    }

    /**
     * Build an empty clone dataSet.
     * @param pSource the source DataSet
     * @throws OceanusException on error
     */
    protected void buildEmptyCloneSet(final PrometheusDataSet pSource) throws OceanusException {
        /* Loop through the source lists */
<span class="nc" id="L343">        final Iterator&lt;Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt;&gt; myIterator = pSource.entryIterator();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L345">            final Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myEntry = myIterator.next();</span>

            /* Access components */
<span class="nc" id="L348">            final MetisListKey myType = myEntry.getKey();</span>
<span class="nc" id="L349">            final PrometheusDataList&lt;?&gt; myList = myEntry.getValue();</span>

            /* Create the empty cloned list */
<span class="nc" id="L352">            addList(myType, myList.getEmptyList(PrometheusListStyle.CLONE));</span>
<span class="nc" id="L353">        }</span>
<span class="nc" id="L354">    }</span>

    /**
     * Construct a Clone for a DataSet.
     * @param pSource the source DataSet
     * @throws OceanusException on error
     */
    protected void deriveCloneSet(final PrometheusDataSet pSource) throws OceanusException {
        /* Obtain listMaps */
<span class="nc" id="L363">        final Map&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myOldMap = pSource.getListMap();</span>

        /* Loop through the new lists */
<span class="nc" id="L366">        final Iterator&lt;Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt;&gt; myIterator = entryIterator();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L368">            final Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myEntry = myIterator.next();</span>

            /* Access components */
<span class="nc" id="L371">            final MetisListKey myType = myEntry.getKey();</span>
<span class="nc" id="L372">            final PrometheusDataList&lt;?&gt; myNew = myEntry.getValue();</span>
<span class="nc" id="L373">            final PrometheusDataList&lt;?&gt; myOld = myOldMap.get(myType);</span>

            /* Clone the list */
<span class="nc" id="L376">            myNew.cloneList(this, myOld);</span>
<span class="nc" id="L377">        }</span>
<span class="nc" id="L378">    }</span>

    /**
     * Construct an update extract for a FinanceData Set.
     * @return the extract
     * @throws OceanusException on error
     */
    public abstract PrometheusDataSet deriveUpdateSet() throws OceanusException;

    /**
     * Construct an update extract for a DataSet.
     * @param pSource the source of the extract
     * @throws OceanusException on error
     */
    protected void deriveUpdateSet(final PrometheusDataSet pSource) throws OceanusException {
        /* Loop through the source lists */
<span class="nc" id="L394">        final Iterator&lt;Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt;&gt; myIterator = pSource.entryIterator();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L396">            final Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myEntry = myIterator.next();</span>

            /* Access components */
<span class="nc" id="L399">            final MetisListKey myType = myEntry.getKey();</span>
<span class="nc" id="L400">            final PrometheusDataList&lt;?&gt; myList = myEntry.getValue();</span>

            /* Create the update list */
<span class="nc" id="L403">            addList(myType, myList.deriveList(PrometheusListStyle.UPDATE));</span>
<span class="nc" id="L404">        }</span>

        /* If we have updates */
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (!isEmpty()) {</span>
            /* Update the version */
<span class="nc" id="L409">            setVersion(1);</span>
        }
<span class="nc" id="L411">    }</span>

    /**
     * Construct a difference extract between two DataSets. The difference extract will only contain
     * items that differ between the two DataSets. Items that are in the new list, but not in the
     * old list will be viewed as inserted. Items that are in the old list but not in the new list
     * will be viewed as deleted. Items that are in both list but differ will be viewed as changed
     * @param pReport the report
     * @param pOld The old list to extract from
     * @return the difference set
     * @throws OceanusException on error
     */
    public abstract PrometheusDataSet getDifferenceSet(TethysUIThreadStatusReport pReport,
                                                       PrometheusDataSet pOld) throws OceanusException;

    /**
     * Construct a difference extract between two DataSets. The difference extract will only contain
     * items that differ between the two DataSets. Items that are in the new list, but not in the
     * old list will be viewed as inserted. Items that are in the old list but not in the new list
     * will be viewed as deleted. Items that are in both list but differ will be viewed as changed
     * @param pReport the report
     * @param pNew The new list to compare
     * @param pOld The old list to compare
     * @throws OceanusException on error
     */
    protected void deriveDifferences(final TethysUIThreadStatusReport pReport,
                                     final PrometheusDataSet pNew,
                                     final PrometheusDataSet pOld) throws OceanusException {
        /* Access current profile */
<span class="nc" id="L440">        final OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L441">        final OceanusProfile myStage = myTask.startTask(TASK_DATADIFF);</span>

        /* Obtain listMaps */
<span class="nc" id="L444">        final Map&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myOldMap = pOld.getListMap();</span>

        /* Loop through the new lists */
<span class="nc" id="L447">        final Iterator&lt;Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt;&gt; myIterator = pNew.entryIterator();</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L449">            final Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myEntry = myIterator.next();</span>

            /* Access components */
<span class="nc" id="L452">            final MetisListKey myType = myEntry.getKey();</span>
<span class="nc" id="L453">            final PrometheusDataList&lt;?&gt; myNew = myEntry.getValue();</span>
<span class="nc" id="L454">            final PrometheusDataList&lt;?&gt; myOld = myOldMap.get(myType);</span>

            /* Derive Differences */
<span class="nc" id="L457">            myStage.startTask(myNew.listName());</span>
<span class="nc" id="L458">            addList(myType, myNew.deriveDifferences(this, myOld));</span>
<span class="nc" id="L459">        }</span>

        /* Complete task */
<span class="nc" id="L462">        myStage.end();</span>
<span class="nc" id="L463">    }</span>

    /**
     * ReBase this data set against an earlier version.
     * @param pReport the report
     * @param pOld The old data to reBase against
     * @throws OceanusException on error
     */
    public void reBase(final TethysUIThreadStatusReport pReport,
                       final PrometheusDataSet pOld) throws OceanusException {
        /* Access current profile */
<span class="nc" id="L474">        final OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L475">        final OceanusProfile myStage = myTask.startTask(TASK_DATAREBASE);</span>

        /* Obtain old listMap */
<span class="nc" id="L478">        final Map&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myMap = pOld.getListMap();</span>

        /* Loop through the lists */
<span class="nc" id="L481">        boolean bUpdates = false;</span>
<span class="nc" id="L482">        final Iterator&lt;Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt;&gt; myIterator = entryIterator();</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L484">            final Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myEntry = myIterator.next();</span>

            /* Access components */
<span class="nc" id="L487">            final MetisListKey myType = myEntry.getKey();</span>
<span class="nc" id="L488">            final PrometheusDataList&lt;?&gt; myList = myEntry.getValue();</span>

            /* ReBase on Old dataList */
<span class="nc" id="L491">            myStage.startTask(myList.listName());</span>
<span class="nc" id="L492">            bUpdates |= myList.reBase(myMap.get(myType));</span>
<span class="nc" id="L493">        }</span>

        /* If we have updates */
<span class="nc bnc" id="L496" title="All 2 branches missed.">        if (bUpdates) {</span>
            /* Update the version */
<span class="nc" id="L498">            setVersion(getVersion() + 1);</span>
        }

        /* Complete task */
<span class="nc" id="L502">        myStage.end();</span>
<span class="nc" id="L503">    }</span>

    /**
     * Add DataList to list of lists.
     * @param pListType the list type
     * @param pList the list to add
     */
    protected void addList(final MetisListKey pListType,
                           final PrometheusDataList&lt;?&gt; pList) {
        /* Add the DataList to the map */
<span class="nc" id="L513">        theListMap.put(pListType, pList);</span>

        /* Note if the list is an encrypted list */
<span class="nc bnc" id="L516" title="All 2 branches missed.">        if (pList instanceof PrometheusEncryptedList) {</span>
<span class="nc" id="L517">            theNumEncrypted++;</span>
        }
<span class="nc" id="L519">    }</span>

    @Override
    public &lt;L extends PrometheusDataList&lt;?&gt;&gt; L getDataList(final MetisListKey pListType,
                                                           final Class&lt;L&gt; pListClass) {
        /* Access the list */
<span class="nc" id="L525">        final PrometheusDataList&lt;?&gt; myList = theListMap.get(pListType);</span>

        /* Cast correctly */
<span class="nc bnc" id="L528" title="All 2 branches missed.">        return myList == null</span>
<span class="nc" id="L529">                ? null</span>
<span class="nc" id="L530">                : pListClass.cast(myList);</span>
    }

    /**
     * Obtain debug value for list.
     * @param pListType the list type
     * @return true/false
     */
    protected Object getFieldListValue(final MetisListKey pListType) {
        /* Access the class */
<span class="nc" id="L540">        final PrometheusDataList&lt;?&gt; myList = theListMap.get(pListType);</span>

        /* Cast correctly */
<span class="nc" id="L543">        return myList == null</span>
<span class="nc bnc" id="L544" title="All 4 branches missed.">                || myList.isEmpty()</span>
<span class="nc" id="L545">                ? MetisDataFieldValue.SKIP</span>
<span class="nc" id="L546">                : myList;</span>
    }

    /**
     * Obtain DataList for an list class.
     * @param &lt;L&gt; the List type
     * @param pListClass the class of the list
     * @return the list of items
     */
    public &lt;L extends PrometheusDataList&lt;?&gt;&gt; L getDataList(final Class&lt;L&gt; pListClass) {
        /* Loop through the lists */
<span class="nc" id="L557">        final Iterator&lt;Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt;&gt; myIterator = entryIterator();</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L559">            final Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myEntry = myIterator.next();</span>

            /* Access components */
<span class="nc" id="L562">            final PrometheusDataList&lt;?&gt; myList = myEntry.getValue();</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">            if (pListClass.equals(myList.getClass())) {</span>
<span class="nc" id="L564">                return pListClass.cast(myList);</span>
            }
<span class="nc" id="L566">        }</span>

        /* Not found */
<span class="nc" id="L569">        return null;</span>
    }

    /**
     * Set Version.
     * @param pVersion the version
     */
    public void setVersion(final int pVersion) {
        /* Record the version */
<span class="nc" id="L578">        theVersion = pVersion;</span>

        /* Loop through the List values */
<span class="nc" id="L581">        final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L583">            final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

            /* Set the Version */
<span class="nc" id="L586">            myList.setVersion(pVersion);</span>
<span class="nc" id="L587">        }</span>
<span class="nc" id="L588">    }</span>

    /**
     * Rewind items to the required version.
     * @param pVersion the version to rewind to
     */
    public void rewindToVersion(final int pVersion) {
        /* Record the version */
<span class="nc" id="L596">        theVersion = pVersion;</span>

        /* Loop through the List values */
<span class="nc" id="L599">        final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L601">            final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

            /* Rewind the list */
<span class="nc" id="L604">            myList.rewindToVersion(pVersion);</span>
<span class="nc" id="L605">        }</span>
<span class="nc" id="L606">    }</span>

    @Override
    public boolean equals(final Object pThat) {
        /* Handle the trivial cases */
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (this == pThat) {</span>
<span class="nc" id="L612">            return true;</span>
        }
<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (pThat == null) {</span>
<span class="nc" id="L615">            return false;</span>
        }

        /* Make sure that the object is a DataSet */
<span class="nc bnc" id="L619" title="All 2 branches missed.">        if (pThat.getClass() != this.getClass()) {</span>
<span class="nc" id="L620">            return false;</span>
        }

        /* Access the object as a DataSet */
<span class="nc" id="L624">        final PrometheusDataSet myThat = (PrometheusDataSet) pThat;</span>

        /* Check version and generation */
<span class="nc bnc" id="L627" title="All 2 branches missed.">        if (myThat.getVersion() != theVersion) {</span>
<span class="nc" id="L628">            return false;</span>
        }

        /* Compare the maps */
<span class="nc" id="L632">        return theListMap.equals(myThat.getListMap());</span>
    }

    @Override
    public int hashCode() {
        /* Build initial hashCode */
<span class="nc" id="L638">        int myHashCode = 0;</span>

        /* Loop through the List values */
<span class="nc" id="L641">        final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L643">            final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

            /* Access equivalent list */
<span class="nc" id="L646">            myHashCode *= HASH_PRIME;</span>
<span class="nc" id="L647">            myHashCode += myList.hashCode();</span>
<span class="nc" id="L648">        }</span>

        /* Return the hashCode */
<span class="nc" id="L651">        return myHashCode;</span>
    }

    /**
     * Determine whether a DataSet has entries.
     * @return &lt;code&gt;true&lt;/code&gt; if the DataSet has entries
     */
    public boolean isEmpty() {
        /* Loop through the List values */
<span class="nc" id="L660">        final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L662">            final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

            /* Determine whether the list is empty */
<span class="nc bnc" id="L665" title="All 2 branches missed.">            if (!myList.isEmpty()) {</span>
<span class="nc" id="L666">                return false;</span>
            }
<span class="nc" id="L668">        }</span>

        /* Return the indication */
<span class="nc" id="L671">        return true;</span>
    }

    /**
     * Determine whether the Data-set has updates.
     * @return &lt;code&gt;true&lt;/code&gt; if the Data-set has updates, &lt;code&gt;false&lt;/code&gt; if not
     */
    public boolean hasUpdates() {
        /* Loop through the List values */
<span class="nc" id="L680">        final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L682">            final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

            /* Determine whether the list has updates */
<span class="nc bnc" id="L685" title="All 2 branches missed.">            if (myList.hasUpdates()) {</span>
<span class="nc" id="L686">                return true;</span>
            }
<span class="nc" id="L688">        }</span>

        /* We have no updates */
<span class="nc" id="L691">        return false;</span>
    }

    /**
     * Get the control record.
     * @return the control record
     */
    public PrometheusControlData getControl() {
        /* Set the control */
<span class="nc" id="L700">        return getControlData().getControl();</span>
    }

    /**
     * Get the active control key.
     * @return the control key
     */
    public PrometheusControlKey getControlKey() {
        /* Access the control element from the database */
<span class="nc" id="L709">        final PrometheusControlData myControl = getControl();</span>

        /* Return the key */
<span class="nc bnc" id="L712" title="All 2 branches missed.">        return myControl == null ? null : myControl.getControlKey();</span>
    }

    /**
     * Initialise Security from database (if present).
     * @param pReport the report
     * @param pBase the database data
     * @throws OceanusException on error
     */
    public void initialiseSecurity(final TethysUIThreadStatusReport pReport,
                                   final PrometheusDataSet pBase) throws OceanusException {
        /* Access current profile */
<span class="nc" id="L724">        final OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L725">        final OceanusProfile myStage = myTask.startTask(TASK_SECINIT);</span>

        /* Set the number of stages */
<span class="nc" id="L728">        pReport.initTask(TASK_SECINIT);</span>
<span class="nc" id="L729">        pReport.setNumStages(theNumEncrypted);</span>

        /* Initialise Security */
<span class="nc" id="L732">        getControlKeys().initialiseSecurity(pBase);</span>

        /* Obtain base listMap */
<span class="nc" id="L735">        final Map&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myMap = pBase.getListMap();</span>

        /* Loop through the List values */
<span class="nc" id="L738">        final Iterator&lt;Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt;&gt; myIterator = entryIterator();</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L740">            final Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt; myEntry = myIterator.next();</span>

            /* Access the two lists */
<span class="nc" id="L743">            final PrometheusDataList&lt;?&gt; myList = myEntry.getValue();</span>
<span class="nc" id="L744">            final PrometheusDataList&lt;?&gt; myBase = myMap.get(myEntry.getKey());</span>

            /* If the list is an encrypted list */
<span class="nc bnc" id="L747" title="All 2 branches missed.">            if (myList instanceof PrometheusEncryptedList) {</span>
                /* Adopt the security */
<span class="nc" id="L749">                myStage.startTask(myList.listName());</span>
<span class="nc" id="L750">                final PrometheusEncryptedList&lt;?&gt; myEncrypted = (PrometheusEncryptedList&lt;?&gt;) myList;</span>
<span class="nc" id="L751">                myEncrypted.adoptSecurity(pReport, (PrometheusEncryptedList&lt;?&gt;) myBase);</span>
            }
<span class="nc" id="L753">        }</span>

        /* Complete the task */
<span class="nc" id="L756">        myStage.end();</span>
<span class="nc" id="L757">    }</span>

    /**
     * Renew Security.
     * @param pReport the report
     * @throws OceanusException on error
     */
    public void renewSecurity(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Access current profile */
<span class="nc" id="L766">        final OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L767">        final OceanusProfile myStage = myTask.startTask(TASK_SECRENEW);</span>

        /* Access ControlData */
<span class="nc" id="L770">        final PrometheusControlData myControl = getControl();</span>

        /* Clone the control key */
<span class="nc" id="L773">        final PrometheusControlKey myKey = getControlKeys().cloneItem(myControl.getControlKey());</span>

        /* Declare the New Control Key */
<span class="nc" id="L776">        myControl.setControlKey(myKey);</span>

        /* Update Security */
<span class="nc" id="L779">        updateSecurity(pReport);</span>

        /* Complete task */
<span class="nc" id="L782">        myStage.end();</span>
<span class="nc" id="L783">    }</span>

    /**
     * Check Security for incomplete security operations.
     * @param pReport the report
     * @throws OceanusException on error
     */
    public void checkSecurity(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Access current profile */
<span class="nc" id="L792">        final OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L793">        final OceanusProfile myStage = myTask.startTask(TASK_SECCHECK);</span>

        /* If there is more than one controlKey */
<span class="nc bnc" id="L796" title="All 2 branches missed.">        if (getControlKeys().size() &gt; 1) {</span>
            /* Update to the selected controlKey */
<span class="nc" id="L798">            updateSecurity(pReport);</span>
        }

        /* Complete task */
<span class="nc" id="L802">        myStage.end();</span>
<span class="nc" id="L803">    }</span>

    /**
     * Update Security.
     * @param pReport the report
     * @throws OceanusException on error
     */
    public void updateSecurity(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Access the control key */
<span class="nc" id="L812">        final PrometheusControlKey myControl = getControlKey();</span>

        /* Set the number of stages */
<span class="nc" id="L815">        pReport.initTask(TASK_SECUPDATE);</span>
<span class="nc" id="L816">        pReport.setNumStages(theNumEncrypted);</span>

        /* Loop through the List values */
<span class="nc" id="L819">        final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L821">            final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

            /* If the list is an encrypted list */
<span class="nc bnc" id="L824" title="All 2 branches missed.">            if (myList instanceof PrometheusEncryptedList) {</span>
                /* Update the security */
<span class="nc" id="L826">                final PrometheusEncryptedList&lt;?&gt; myEncrypted = (PrometheusEncryptedList&lt;?&gt;) myList;</span>
<span class="nc" id="L827">                myEncrypted.updateSecurity(pReport, myControl);</span>
            }
<span class="nc" id="L829">        }</span>

        /* Delete old ControlSets */
<span class="nc" id="L832">        getControlKeys().purgeOldControlKeys();</span>
<span class="nc" id="L833">        setVersion(1);</span>
<span class="nc" id="L834">    }</span>

    /**
     * Get the Password Hash.
     * @return the password hash
     * @throws OceanusException on error
     */
    public GordianFactoryLock getFactoryLock() throws OceanusException {
        /* Access the active control key */
<span class="nc" id="L843">        final PrometheusControlKey myKey = getControlKey();</span>

        /* Set the control */
<span class="nc bnc" id="L846" title="All 2 branches missed.">        return myKey == null</span>
<span class="nc" id="L847">                ? null</span>
<span class="nc" id="L848">                : myKey.getFactoryLock();</span>
    }

    /**
     * Update data with a new password.
     * @param pReport the report
     * @param pSource the source of the data
     * @throws OceanusException on error
     */
    public void updateFactoryLock(final TethysUIThreadStatusReport pReport,
                                  final String pSource) throws OceanusException {
        /* Update the control details */
<span class="nc" id="L860">        getControlKey().updateFactoryLock(pSource);</span>
<span class="nc" id="L861">    }</span>

    /**
     * Undo changes in a dataSet.
     */
    public void undoLastChange() {
        /* Ignore if we have no changes */
<span class="nc bnc" id="L868" title="All 2 branches missed.">        if (theVersion == 0) {</span>
<span class="nc" id="L869">            return;</span>
        }

        /* Decrement version */
<span class="nc" id="L873">        theVersion--;</span>

        /* Rewind to the version */
<span class="nc" id="L876">        rewindToVersion(theVersion);</span>
<span class="nc" id="L877">    }</span>

    /**
     * Reset changes in a dataSet.
     */
    public void resetChanges() {
        /* Ignore if we have no changes */
<span class="nc bnc" id="L884" title="All 2 branches missed.">        if (theVersion == 0) {</span>
<span class="nc" id="L885">            return;</span>
        }

        /* Decrement version */
<span class="nc" id="L889">        theVersion = 0;</span>

        /* Rewind to the version */
<span class="nc" id="L892">        rewindToVersion(theVersion);</span>
<span class="nc" id="L893">    }</span>

    /**
     * Obtain list iterator.
     * @return the iterator
     */
    public Iterator&lt;PrometheusDataList&lt;?&gt;&gt; iterator() {
<span class="nc" id="L900">        return theListMap.values().iterator();</span>
    }

    /**
     * Obtain list iterator.
     * @return the iterator
     */
    public Iterator&lt;Entry&lt;MetisListKey, PrometheusDataList&lt;?&gt;&gt;&gt; entryIterator() {
<span class="nc" id="L908">        return theListMap.entrySet().iterator();</span>
    }

    /**
     * Obtain listKey iterator.
     * @return the iterator
     */
    public Iterator&lt;MetisListKey&gt; keyIterator() {
<span class="nc" id="L916">        return theListMap.keySet().iterator();</span>
    }

    /**
     * Cryptography Data Enum Types.
     */
<span class="nc" id="L922">    public enum PrometheusCryptographyDataType</span>
            implements MetisListKey, MetisDataFieldId {
        /**
         * ControlKey.
         */
<span class="nc" id="L927">        CONTROLKEY(1),</span>

        /**
         * ControlKeySet.
         */
<span class="nc" id="L932">        CONTROLKEYSET(2),</span>

        /**
         * DataKeySet.
         */
<span class="nc" id="L937">        DATAKEYSET(3),</span>

        /**
         * ControlData.
         */
<span class="nc" id="L942">        CONTROLDATA(4);</span>

        /**
         * Maximum keyId.
         */
<span class="nc" id="L947">        public static final Integer MAXKEYID = CONTROLDATA.getItemKey();</span>

        /**
         * The list key.
         */
        private final Integer theKey;

        /**
         * The String name.
         */
        private String theName;

        /**
         * The list name.
         */
        private String theListName;

        /**
         * Constructor.
         * @param pKey the key
         */
<span class="nc" id="L968">        PrometheusCryptographyDataType(final Integer pKey) {</span>
<span class="nc" id="L969">            theKey = pKey;</span>
<span class="nc" id="L970">        }</span>

        @Override
        public String toString() {
            /* If we have not yet loaded the name */
<span class="nc bnc" id="L975" title="All 2 branches missed.">            if (theName == null) {</span>
                /* Load the name */
<span class="nc" id="L977">                theName = PrometheusDataResource.getKeyForCryptoItem(this).getValue();</span>
            }

            /* return the name */
<span class="nc" id="L981">            return theName;</span>
        }

        @Override
        public String getItemName() {
<span class="nc" id="L986">            return toString();</span>
        }

        @Override
        public Class&lt;? extends MetisFieldVersionedItem&gt; getClazz() {
<span class="nc bnc" id="L991" title="All 5 branches missed.">            switch (this) {</span>
                case CONTROLDATA:
<span class="nc" id="L993">                    return PrometheusControlData.class;</span>
                case CONTROLKEY:
<span class="nc" id="L995">                    return PrometheusControlKey.class;</span>
                case CONTROLKEYSET:
<span class="nc" id="L997">                    return PrometheusControlKeySet.class;</span>
                case DATAKEYSET:
<span class="nc" id="L999">                    return PrometheusDataKeySet.class;</span>
                default:
<span class="nc" id="L1001">                    return null;</span>
            }
        }

        @Override
        public String getListName() {
            /* If we have not yet loaded the name */
<span class="nc bnc" id="L1008" title="All 2 branches missed.">            if (theListName == null) {</span>
                /* Load the name */
<span class="nc" id="L1010">                theListName = PrometheusDataResource.getKeyForCryptoList(this).getValue();</span>
            }

            /* return the list name */
<span class="nc" id="L1014">            return theListName;</span>
        }

        @Override
        public Integer getItemKey() {
<span class="nc" id="L1019">            return theKey;</span>
        }

        @Override
        public String getId() {
<span class="nc" id="L1024">            return toString();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>