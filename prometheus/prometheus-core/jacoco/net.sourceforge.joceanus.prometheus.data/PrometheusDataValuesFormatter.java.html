<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusDataValuesFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.prometheus.data</a> &gt; <span class="el_source">PrometheusDataValuesFormatter.java</span></div><h1>PrometheusDataValuesFormatter.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Prometheus: Application Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.prometheus.data;

import net.sourceforge.joceanus.gordianknot.api.base.GordianException;
import net.sourceforge.joceanus.gordianknot.api.factory.GordianFactory.GordianFactoryLock;
import net.sourceforge.joceanus.gordianknot.api.zip.GordianZipFactory;
import net.sourceforge.joceanus.gordianknot.api.zip.GordianZipFileContents;
import net.sourceforge.joceanus.gordianknot.api.zip.GordianZipFileEntry;
import net.sourceforge.joceanus.gordianknot.api.zip.GordianZipLock;
import net.sourceforge.joceanus.gordianknot.api.zip.GordianZipReadFile;
import net.sourceforge.joceanus.gordianknot.api.zip.GordianZipWriteFile;
import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.metis.field.MetisFieldItem.MetisFieldSetDef;
import net.sourceforge.joceanus.metis.list.MetisListKey;
import net.sourceforge.joceanus.metis.toolkit.MetisToolkit;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.oceanus.profile.OceanusProfile;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataValues.PrometheusGroupedItem;
import net.sourceforge.joceanus.prometheus.exc.PrometheusDataException;
import net.sourceforge.joceanus.prometheus.exc.PrometheusIOException;
import net.sourceforge.joceanus.prometheus.exc.PrometheusSecurityException;
import net.sourceforge.joceanus.prometheus.security.PrometheusSecurityPasswordManager;
import net.sourceforge.joceanus.tethys.api.thread.TethysUIThreadStatusReport;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.xml.sax.SAXException;

import javax.xml.XMLConstants;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.Iterator;

/**
 * Formatter/Parser class for DataValues.
 */
public class PrometheusDataValuesFormatter {
    /**
     * Entry suffix.
     */
    private static final String SUFFIX_ENTRY = &quot;.xml&quot;;

    /**
     * Error text.
     */
    private static final String ERROR_BACKUP = &quot;Failed to create backup XML&quot;;

    /**
     * The report.
     */
    private final TethysUIThreadStatusReport theReport;

    /**
     * The password manager.
     */
    private final PrometheusSecurityPasswordManager thePasswordMgr;

    /**
     * The document builder.
     */
    private final DocumentBuilder theBuilder;

    /**
     * The transformer.
     */
    private final Transformer theXformer;

    /**
     * The Data version.
     */
    private Integer theVersion;

    /**
     * Constructor.
     * @param pReport the report
     * @param pPasswordMgr the password manager
     * @throws PrometheusIOException on error
     */
    public PrometheusDataValuesFormatter(final TethysUIThreadStatusReport pReport,
<span class="nc" id="L109">                                         final PrometheusSecurityPasswordManager pPasswordMgr) throws PrometheusIOException {</span>
        /* Store values */
<span class="nc" id="L111">        theReport = pReport;</span>
<span class="nc" id="L112">        thePasswordMgr = pPasswordMgr;</span>

        /* protect against exceptions */
        try {
            /* Create a Document builder */
<span class="nc" id="L117">            final DocumentBuilderFactory myFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L118">            myFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>
<span class="nc" id="L119">            myFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, &quot;&quot;);</span>
<span class="nc" id="L120">            myFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, &quot;&quot;);</span>
<span class="nc" id="L121">            theBuilder = myFactory.newDocumentBuilder();</span>

            /* Create the transformer */
<span class="nc" id="L124">            final TransformerFactory myXformFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L125">            myXformFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>
<span class="nc" id="L126">            myXformFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, &quot;&quot;);</span>
<span class="nc" id="L127">            myXformFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, &quot;&quot;);</span>
<span class="nc" id="L128">            theXformer = myXformFactory.newTransformer();</span>

<span class="nc" id="L130">        } catch (ParserConfigurationException | TransformerConfigurationException e) {</span>
<span class="nc" id="L131">            throw new PrometheusIOException(&quot;Failed to initialise parser&quot;, e);</span>
<span class="nc" id="L132">        }</span>
<span class="nc" id="L133">    }</span>

    /**
     * Create a Backup ZipFile.
     * @param pData Data to write out
     * @param pFile the backup file to write to
     * @throws OceanusException on error
     */
    public void createBackup(final PrometheusDataSet pData,
                             final File pFile) throws OceanusException {
<span class="nc" id="L143">        boolean writeFailed = false;</span>
        try {
<span class="nc" id="L145">            createBackup(pData, new FileOutputStream(pFile));</span>
<span class="nc" id="L146">        } catch (IOException</span>
                 | OceanusException e) {
<span class="nc" id="L148">            writeFailed = true;</span>
<span class="nc" id="L149">            throw new PrometheusIOException(ERROR_BACKUP, e);</span>
        } finally {
            /* Try to delete the file if required */
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (writeFailed) {</span>
<span class="nc" id="L153">                MetisToolkit.cleanUpFile(pFile);</span>
            }
        }
<span class="nc" id="L156">    }</span>

    /**
     * Create a Backup ZipFile.
     * @param pData Data to write out
     * @param pZipStream the output stream
     * @throws OceanusException on error
     */
    public void createBackup(final PrometheusDataSet pData,
                             final OutputStream pZipStream) throws OceanusException {
        /* Obtain the active profile */
<span class="nc" id="L167">        final OceanusProfile myTask = theReport.getActiveTask();</span>
<span class="nc" id="L168">        final OceanusProfile myStage = myTask.startTask(&quot;Writing&quot;);</span>

        /* Protect agains exceptions */
        try {
            /* Create a similar security control */
<span class="nc" id="L173">            final PrometheusSecurityPasswordManager myPasswordMgr = pData.getPasswordMgr();</span>
<span class="nc" id="L174">            final GordianFactoryLock myBase = pData.getFactoryLock();</span>
<span class="nc" id="L175">            final GordianFactoryLock myLock = myPasswordMgr.similarFactoryLock(myBase);</span>
<span class="nc" id="L176">            final GordianZipFactory myZips = myPasswordMgr.getSecurityFactory().getZipFactory();</span>
<span class="nc" id="L177">            final GordianZipLock myZipLock = myZips.zipLock(myLock);</span>

            /* Access the data version */
<span class="nc" id="L180">            theVersion = pData.getControl().getDataVersion();</span>

            /* Declare the number of stages */
<span class="nc" id="L183">            theReport.setNumStages(pData.getListMap().size());</span>

            /* Protect the workbook access */
<span class="nc" id="L186">            try (GordianZipWriteFile myZipFile = myZips.createZipFile(myZipLock, pZipStream)) {</span>
                /* Loop through the data lists */
<span class="nc" id="L188">                final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = pData.iterator();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                while (myIterator.hasNext()) {</span>
<span class="nc" id="L190">                    final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

                    /* Declare the new stage */
<span class="nc" id="L193">                    theReport.setNewStage(myList.listName());</span>

                    /* If this list should be written */
<span class="nc bnc" id="L196" title="All 2 branches missed.">                    if (myList.includeDataXML()) {</span>
                        /* Write the list details */
<span class="nc" id="L198">                        myStage.startTask(myList.listName());</span>
<span class="nc" id="L199">                        writeXMLListToFile(myList, myZipFile, true);</span>
                    }
<span class="nc" id="L201">                }</span>

                /* Complete the task */
<span class="nc" id="L204">                myStage.end();</span>

<span class="nc" id="L206">            } catch (IOException</span>
                     | OceanusException e) {
<span class="nc" id="L208">                throw new PrometheusIOException(ERROR_BACKUP, e);</span>
<span class="nc" id="L209">            }</span>
<span class="nc" id="L210">        } catch (GordianException e) {</span>
<span class="nc" id="L211">            throw new PrometheusSecurityException(e);</span>
<span class="nc" id="L212">        }</span>
<span class="nc" id="L213">    }</span>

    /**
     * Create a Backup ZipFile.
     * @param pData Data to write out
     * @param pFile the backup file to write to
     * @throws OceanusException on error
     */
    public void createExtract(final PrometheusDataSet pData,
                              final File pFile) throws OceanusException {
<span class="nc" id="L223">        boolean writeFailed = false;</span>
        try {
<span class="nc" id="L225">            createExtract(pData, new FileOutputStream(pFile));</span>
<span class="nc" id="L226">        } catch (IOException</span>
                 | OceanusException e) {
<span class="nc" id="L228">            writeFailed = true;</span>
<span class="nc" id="L229">            throw new PrometheusIOException(ERROR_BACKUP, e);</span>
        } finally {
            /* Try to delete the file if required */
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (writeFailed) {</span>
<span class="nc" id="L233">                MetisToolkit.cleanUpFile(pFile);</span>
            }
        }
<span class="nc" id="L236">    }</span>

    /**
     * Create an Extract ZipFile.
     * @param pData Data to write out
     * @param pZipStream the output stream
     * @throws OceanusException on error
     */
    public void createExtract(final PrometheusDataSet pData,
                              final OutputStream pZipStream) throws OceanusException {
        /* Obtain the active profile */
<span class="nc" id="L247">        final OceanusProfile myTask = theReport.getActiveTask();</span>
<span class="nc" id="L248">        final OceanusProfile myStage = myTask.startTask(&quot;Writing&quot;);</span>

        /* Access the data version */
<span class="nc" id="L251">        theVersion = pData.getControl().getDataVersion();</span>

        /* Declare the number of stages */
<span class="nc" id="L254">        theReport.setNumStages(pData.getListMap().size());</span>
<span class="nc" id="L255">        final GordianZipFactory myZips = thePasswordMgr.getSecurityFactory().getZipFactory();</span>

        /* Protect the workbook access */
<span class="nc" id="L258">        try (GordianZipWriteFile myZipFile = myZips.createZipFile(pZipStream)) {</span>
            /* Loop through the data lists */
<span class="nc" id="L260">            final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = pData.iterator();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L262">                final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

                /* Declare the new stage */
<span class="nc" id="L265">                theReport.setNewStage(myList.listName());</span>

                /* If this list should be written */
<span class="nc bnc" id="L268" title="All 2 branches missed.">                if (myList.includeDataXML()) {</span>
                    /* Write the list details */
<span class="nc" id="L270">                    myStage.startTask(myList.listName());</span>
<span class="nc" id="L271">                    writeXMLListToFile(myList, myZipFile, false);</span>
                }
<span class="nc" id="L273">            }</span>

            /* Complete the task */
<span class="nc" id="L276">            myStage.end();</span>

<span class="nc" id="L278">        } catch (IOException</span>
                 | OceanusException e) {
<span class="nc" id="L280">            throw new PrometheusIOException(&quot;Failed to create extract XML&quot;, e);</span>
<span class="nc" id="L281">        }</span>
<span class="nc" id="L282">    }</span>

    /**
     * Write XML list to file.
     * @param pList the data list
     * @param pZipFile the output zipFile
     * @param pStoreIds do we include IDs in XML
     * @throws OceanusException on error
     */
    private void writeXMLListToFile(final PrometheusDataList&lt;?&gt; pList,
                                    final GordianZipWriteFile pZipFile,
                                    final boolean pStoreIds) throws OceanusException {
        /* Access the list name */
<span class="nc" id="L295">        final String myName = pList.listName() + SUFFIX_ENTRY;</span>

        /* Protect the workbook access */
<span class="nc" id="L298">        try (OutputStream myStream = pZipFile.createOutputStream(new File(myName), true)) {</span>
            /* Create a new document */
<span class="nc" id="L300">            final Document myDocument = theBuilder.newDocument();</span>

            /* Populate the document from the list */
<span class="nc" id="L303">            populateXML(myDocument, pList, pStoreIds);</span>

            /* Format the XML and write to stream */
<span class="nc" id="L306">            theXformer.transform(new DOMSource(myDocument), new StreamResult(myStream));</span>

<span class="nc" id="L308">        } catch (GordianException</span>
                 | TransformerException
                 | IOException e) {
<span class="nc" id="L311">            throw new PrometheusIOException(&quot;Failed to transform XML&quot;, e);</span>
<span class="nc" id="L312">        }</span>
<span class="nc" id="L313">    }</span>

    /**
     * Create XML for a list.
     * @param pDocument the document to hold the list.
     * @param pList the data list
     * @param pStoreIds do we include IDs in XML
     * @throws OceanusException on error
     */
    private void populateXML(final Document pDocument,
                             final PrometheusDataList&lt;?&gt; pList,
                             final boolean pStoreIds) throws OceanusException {
        /* Create an element for the item */
<span class="nc" id="L326">        final Element myElement = pDocument.createElement(pList.listName());</span>
<span class="nc" id="L327">        pDocument.appendChild(myElement);</span>

        /* Access the Data formatter */
<span class="nc" id="L330">        final OceanusDataFormatter myFormatter = pList.getDataSet().getDataFormatter();</span>

        /* Declare the number of steps */
<span class="nc" id="L333">        final int myTotal = pList.size();</span>
<span class="nc" id="L334">        theReport.setNumSteps(myTotal);</span>

        /* Set the list type and size */
<span class="nc" id="L337">        myElement.setAttribute(PrometheusDataValues.ATTR_TYPE, pList.getItemType().getItemName());</span>
<span class="nc" id="L338">        myElement.setAttribute(PrometheusDataValues.ATTR_SIZE, Integer.toString(myTotal));</span>
<span class="nc" id="L339">        myElement.setAttribute(PrometheusDataValues.ATTR_VERS, Integer.toString(theVersion));</span>

        /* Iterate through the list */
<span class="nc" id="L342">        final Iterator&lt;?&gt; myIterator = pList.iterator();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L344">            final Object myObject = myIterator.next();</span>

            /* Ignore if not a DataItem */
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (!(myObject instanceof PrometheusDataItem myItem)) {</span>
                continue;
            }

            /* Skip over child items */
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (myItem instanceof PrometheusGroupedItem myGrouped</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                    &amp;&amp; myGrouped.isChild()) {</span>
<span class="nc" id="L354">                continue;</span>
            }

            /* Create DataValues for item */
<span class="nc" id="L358">            final PrometheusDataValues myValues = new PrometheusDataValues(myItem);</span>

            /* Add the child to the list */
<span class="nc" id="L361">            final Element myChild = myValues.createXML(pDocument, myFormatter, pStoreIds);</span>
<span class="nc" id="L362">            myElement.appendChild(myChild);</span>

            /* Report the progress */
<span class="nc" id="L365">            theReport.setNextStep();</span>
<span class="nc" id="L366">        }</span>
<span class="nc" id="L367">    }</span>

    /**
     * Load a ZipFile.
     * @param pData DataSet to load into
     * @param pFile the file to load
     * @throws OceanusException on error
     */
    public void loadZipFile(final PrometheusDataSet pData,
                            final File pFile) throws OceanusException {
        try {
<span class="nc" id="L378">            loadZipFile(pData, new FileInputStream(pFile), pFile.getName());</span>
<span class="nc" id="L379">        } catch (IOException e) {</span>
<span class="nc" id="L380">            throw new PrometheusIOException(&quot;Failed to access ZipFile&quot;, e);</span>
<span class="nc" id="L381">        }</span>
<span class="nc" id="L382">    }</span>

    /**
     * Load a ZipFile.
     * @param pData DataSet to load into
     * @param pInStream the input stream
     * @param pName the file to load
     * @throws OceanusException on error
     */
    public void loadZipFile(final PrometheusDataSet pData,
                            final InputStream pInStream,
                            final String pName) throws OceanusException {
        /* Protect against exceptions */
        try {
            /* Obtain the active profile */
<span class="nc" id="L397">            final OceanusProfile myTask = theReport.getActiveTask();</span>
<span class="nc" id="L398">            final OceanusProfile myStage = myTask.startTask(&quot;Loading&quot;);</span>
<span class="nc" id="L399">            myStage.startTask(&quot;Parsing&quot;);</span>

            /* Access the zip file */
<span class="nc" id="L402">            final GordianZipFactory myZips = thePasswordMgr.getSecurityFactory().getZipFactory();</span>
<span class="nc" id="L403">            final GordianZipReadFile myZipFile = myZips.openZipFile(pInStream);</span>

            /* Obtain the hash bytes from the file */
<span class="nc" id="L406">            final GordianZipLock myLock = myZipFile.getLock();</span>

            /* If this is a secure ZipFile */
<span class="nc bnc" id="L409" title="All 2 branches missed.">            if (myLock != null) {</span>
                /* Resolve the lock */
<span class="nc" id="L411">                thePasswordMgr.resolveZipLock(myLock, pName);</span>
            }

            /* Parse the Zip File */
<span class="nc" id="L415">            parseZipFile(myStage, pData, myZipFile);</span>

            /* Complete the task */
<span class="nc" id="L418">            myStage.end();</span>

<span class="nc" id="L420">        } catch (GordianException e) {</span>
<span class="nc" id="L421">            throw new PrometheusSecurityException(e);</span>
<span class="nc" id="L422">        }</span>
<span class="nc" id="L423">    }</span>

    /**
     * Parse a ZipFile.
     * @param pProfile the active profile
     * @param pData DataSet to load into
     * @param pZipFile the file to parse
     * @throws OceanusException on error
     */
    private void parseZipFile(final OceanusProfile pProfile,
                              final PrometheusDataSet pData,
                              final GordianZipReadFile pZipFile) throws OceanusException {
        /* Start new stage */
<span class="nc" id="L436">        final OceanusProfile myStage = pProfile.startTask(&quot;Loading&quot;);</span>

        /* Declare the number of stages */
<span class="nc" id="L439">        theReport.setNumStages(pData.getListMap().size());</span>

        /* Loop through the data lists */
<span class="nc" id="L442">        final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = pData.iterator();</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L444">            final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

            /* Declare the new stage */
<span class="nc" id="L447">            theReport.setNewStage(myList.listName());</span>

            /* If this list should be read */
<span class="nc bnc" id="L450" title="All 2 branches missed.">            if (myList.includeDataXML()) {</span>
                /* Write the list details */
<span class="nc" id="L452">                myStage.startTask(myList.listName());</span>
<span class="nc" id="L453">                readXMLListFromFile(myList, pZipFile);</span>
            }

            /* postProcessList after load */
<span class="nc" id="L457">            myList.postProcessOnLoad();</span>
<span class="nc" id="L458">        }</span>

        /* Create the control data */
<span class="nc" id="L461">        pData.getControlData().addNewControl(theVersion);</span>

        /* Complete the task */
<span class="nc" id="L464">        myStage.end();</span>
<span class="nc" id="L465">    }</span>

    /**
     * Read XML list from file.
     * @param pList the data list
     * @param pZipFile the input zipFile
     * @throws OceanusException on error
     */
    private void readXMLListFromFile(final PrometheusDataList&lt;?&gt; pList,
                                     final GordianZipReadFile pZipFile) throws OceanusException {
        /* Protect against exceptions */
        try {
            /* Access the list name */
<span class="nc" id="L478">            final String myName = pList.listName() + SUFFIX_ENTRY;</span>

            /* Locate the correct entry */
<span class="nc" id="L481">            final GordianZipFileContents myContents = pZipFile.getContents();</span>
<span class="nc" id="L482">            final GordianZipFileEntry myEntry = myContents.findFileEntry(myName);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (myEntry == null) {</span>
<span class="nc" id="L484">                throw new PrometheusDataException(&quot;List not found &quot; + myName);</span>
            }

            /* Protect the workbook access */
<span class="nc" id="L488">            try (InputStream myStream = pZipFile.createInputStream(myEntry)) {</span>
                /* Read the document from the stream and parse it */
<span class="nc" id="L490">                final Document myDocument = theBuilder.parse(myStream);</span>

                /* Populate the list from the document */
<span class="nc" id="L493">                parseXMLDocument(myDocument, pList);</span>

<span class="nc" id="L495">            } catch (IOException</span>
                     | SAXException e) {
<span class="nc" id="L497">                throw new PrometheusIOException(&quot;Failed to parse XML&quot;, e);</span>
<span class="nc" id="L498">            }</span>
<span class="nc" id="L499">        } catch (GordianException e) {</span>
<span class="nc" id="L500">            throw new PrometheusSecurityException(e);</span>
<span class="nc" id="L501">        }</span>
<span class="nc" id="L502">    }</span>

    /**
     * parse an XML document into DataValues.
     * @param pDocument the document that holds the list.
     * @param pList the data list
     * @throws OceanusException on error
     */
    private void parseXMLDocument(final Document pDocument,
                                  final PrometheusDataList&lt;?&gt; pList) throws OceanusException {
        /* Access the parent element */
<span class="nc" id="L513">        final Element myElement = pDocument.getDocumentElement();</span>
<span class="nc" id="L514">        final MetisListKey myItemType = pList.getItemType();</span>

        /* Check that the document name and dataType are correct */
<span class="nc bnc" id="L517" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(myElement.getNodeName(), pList.listName())</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                || !MetisDataDifference.isEqual(myElement.getAttribute(PrometheusDataValues.ATTR_TYPE), myItemType.getItemName())) {</span>
<span class="nc" id="L519">            throw new PrometheusDataException(&quot;Invalid list type&quot;);</span>
        }

        /* If this is the first Data version */
<span class="nc" id="L523">        final Integer myVersion = Integer.valueOf(myElement.getAttribute(PrometheusDataValues.ATTR_VERS));</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (theVersion == null) {</span>
<span class="nc" id="L525">            theVersion = myVersion;</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        } else if (!theVersion.equals(myVersion)) {</span>
<span class="nc" id="L527">            throw new PrometheusDataException(&quot;Inconsistent data version&quot;);</span>
        }

        /* Access field types for list */
<span class="nc" id="L531">        final MetisFieldSetDef myFields = pList.getItemFields();</span>

        /* Access the Data formatter */
<span class="nc" id="L534">        final OceanusDataFormatter myFormatter = pList.getDataSet().getDataFormatter();</span>

        /* Declare the number of steps */
<span class="nc" id="L537">        final int myTotal = getListCount(myFormatter, myElement);</span>
<span class="nc" id="L538">        theReport.setNumSteps(myTotal);</span>

        /* Loop through the children */
<span class="nc bnc" id="L541" title="All 2 branches missed.">        for (Node myChild = myElement.getFirstChild(); myChild != null; myChild = myChild.getNextSibling()) {</span>
            /* Ignore non-elements */
<span class="nc bnc" id="L543" title="All 2 branches missed.">            if (!(myChild instanceof Element)) {</span>
<span class="nc" id="L544">                continue;</span>
            }

            /* Access as Element */
<span class="nc" id="L548">            final Element myItem = (Element) myChild;</span>

            /* Create DataArguments for item */
<span class="nc" id="L551">            final PrometheusDataValues myValues = new PrometheusDataValues(myItem, myFields);</span>

            /* Add the child to the list */
<span class="nc" id="L554">            pList.addValuesItem(myValues);</span>

            /* Report the progress */
<span class="nc" id="L557">            theReport.setNextStep();</span>
        }
<span class="nc" id="L559">    }</span>

    /**
     * Obtain count attribute.
     * @param pFormatter the formatter.
     * @param pElement the element that holds the count.
     * @return the list count
     * @throws OceanusException on error
     */
    private static Integer getListCount(final OceanusDataFormatter pFormatter,
                                        final Element pElement) throws OceanusException {
        try {
            /* Access the list count */
<span class="nc" id="L572">            final String mySize = pElement.getAttribute(PrometheusDataValues.ATTR_SIZE);</span>
<span class="nc" id="L573">            return pFormatter.parseValue(mySize, Integer.class);</span>
<span class="nc" id="L574">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L575">            throw new PrometheusDataException(&quot;Invalid list count&quot;, e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>