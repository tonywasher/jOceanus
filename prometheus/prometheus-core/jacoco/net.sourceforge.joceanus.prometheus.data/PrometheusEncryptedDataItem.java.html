<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusEncryptedDataItem.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.prometheus.data</a> &gt; <span class="el_source">PrometheusEncryptedDataItem.java</span></div><h1>PrometheusEncryptedDataItem.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Prometheus: Application Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.prometheus.data;

import net.sourceforge.joceanus.metis.data.MetisDataDifference;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.metis.field.MetisFieldSet;
import net.sourceforge.joceanus.metis.field.MetisFieldVersionedSet;
import net.sourceforge.joceanus.metis.list.MetisListKey;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataKeySet.PrometheusDataKeySetList;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataSet.PrometheusCryptographyDataType;
import net.sourceforge.joceanus.tethys.api.thread.TethysUIThreadStatusReport;

import java.util.Iterator;

/**
 * Encrypted Data Item and List.
 * @author Tony Washer
 */
public abstract class PrometheusEncryptedDataItem
        extends PrometheusDataItem {
    /**
     * Null Encryptor.
     */
<span class="nc" id="L41">    private static final PrometheusEncryptor NULL_ENCRYPTOR = new PrometheusEncryptor(new OceanusDataFormatter(), null);</span>

    /**
     * Report fields.
     */
<span class="nc" id="L46">    private static final MetisFieldVersionedSet&lt;PrometheusEncryptedDataItem&gt; FIELD_DEFS = MetisFieldVersionedSet.newVersionedFieldSet(PrometheusEncryptedDataItem.class);</span>

    /*
     * FieldIds.
     */
    static {
<span class="nc" id="L52">        FIELD_DEFS.declareLinkField(PrometheusCryptographyDataType.DATAKEYSET);</span>
<span class="nc" id="L53">    }</span>

    /**
     * Standard Constructor. This creates a null encryption generator. This will be overridden when
     * a DataKeySet is assigned to the item.
     * @param pList the list that this item is associated with
     * @param pId the Id of the new item (or 0 if not yet known)
     */
    protected PrometheusEncryptedDataItem(final PrometheusEncryptedList&lt;?&gt; pList,
                                          final Integer pId) {
<span class="nc" id="L63">        super(pList, pId);</span>
<span class="nc" id="L64">    }</span>

    /**
     * Copy Constructor. This picks up the generator from the source item.
     * @param pList the list that this item is associated with
     * @param pSource the source item
     */
    protected PrometheusEncryptedDataItem(final PrometheusEncryptedList&lt;?&gt; pList,
                                          final PrometheusEncryptedDataItem pSource) {
<span class="nc" id="L73">        super(pList, pSource);</span>
<span class="nc" id="L74">    }</span>

    /**
     * Values Constructor. This creates a null encryption generator. This will be overridden when a
     * ControlKey is assigned to the item.
     * @param pList the list that this item is associated with
     * @param pValues the data values
     * @throws OceanusException on error
     */
    protected PrometheusEncryptedDataItem(final PrometheusEncryptedList&lt;?&gt; pList,
                                          final PrometheusDataValues pValues) throws OceanusException {
<span class="nc" id="L85">        super(pList, pValues);</span>

        /* Access dataKeySet id */
<span class="nc" id="L88">        final Integer myId = pValues.getValue(PrometheusCryptographyDataType.DATAKEYSET, Integer.class);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (myId != null) {</span>
<span class="nc" id="L90">            setDataKeySet(myId);</span>
        }
<span class="nc" id="L92">    }</span>

    @Override
    protected PrometheusEncryptedValues newVersionValues() {
<span class="nc" id="L96">        return new PrometheusEncryptedValues(this);</span>
    }

    @Override
    public PrometheusEncryptedValues getValues() {
<span class="nc" id="L101">        return (PrometheusEncryptedValues) super.getValues();</span>
    }

    @Override
    public PrometheusEncryptedValues getOriginalValues() {
<span class="nc" id="L106">        return (PrometheusEncryptedValues) super.getOriginalValues();</span>
    }

    /**
     * Get the DataKeySet for this item.
     * @return the DataKeySet
     */
    public final PrometheusDataKeySet getDataKeySet() {
<span class="nc" id="L114">        return getValues().getValue(PrometheusCryptographyDataType.DATAKEYSET, PrometheusDataKeySet.class);</span>
    }

    /**
     * Get the DataKeySetId for this item.
     * @return the DataKeySetId
     */
    public final Integer getDataKeySetId() {
<span class="nc" id="L122">        final PrometheusDataKeySet mySet = getDataKeySet();</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        return (mySet == null)</span>
<span class="nc" id="L124">                ? null</span>
<span class="nc" id="L125">                : mySet.getIndexedId();</span>
    }

    /**
     * Set the DataKeySet for this item.
     * @param pSet the dataKeySet
     */
    private void setValueDataKeySet(final PrometheusDataKeySet pSet) {
<span class="nc" id="L133">        getValues().setUncheckedValue(PrometheusCryptographyDataType.DATAKEYSET, pSet);</span>
<span class="nc" id="L134">    }</span>

    /**
     * Set the KeySet id for this item.
     * @param pId the keySet id
     */
    private void setValueDataKeySet(final Integer pId) {
<span class="nc" id="L141">        getValues().setUncheckedValue(PrometheusCryptographyDataType.DATAKEYSET, pId);</span>
<span class="nc" id="L142">    }</span>

    /**
     * Get the Encryptor.
     * @return the encryptor
     */
    public PrometheusEncryptor getEncryptor() {
<span class="nc" id="L149">        final PrometheusDataKeySet myKeySet = getDataKeySet();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        return myKeySet == null ? NULL_ENCRYPTOR : myKeySet.getEncryptor();</span>
    }

    @Override
    public PrometheusEncryptedList&lt;?&gt; getList() {
<span class="nc" id="L155">        return (PrometheusEncryptedList&lt;?&gt;) super.getList();</span>
    }

    /**
     * Set DataKeySet.
     * @param pKeySet the DataKeySet
     */
    protected final void setDataKeySet(final PrometheusDataKeySet pKeySet) {
<span class="nc" id="L163">        setValueDataKeySet(pKeySet);</span>
<span class="nc" id="L164">    }</span>

    /**
     * Set Next DataKeySet.
     */
    protected final void setNextDataKeySet() {
<span class="nc" id="L170">        setDataKeySet(getList().getNextDataKeySet());</span>
<span class="nc" id="L171">    }</span>

    /**
     * Set DataKeySet id.
     * @param pKeySetId the KeySet Id
     * @throws OceanusException on error
     */
    protected final void setDataKeySet(final Integer pKeySetId) throws OceanusException {
        /* Store the id */
<span class="nc" id="L180">        setValueDataKeySet(pKeySetId);</span>

        /* Resolve the ControlKey */
<span class="nc" id="L183">        final PrometheusDataSet myData = getDataSet();</span>
<span class="nc" id="L184">        resolveDataLink(PrometheusCryptographyDataType.DATAKEYSET, myData.getDataKeySets());</span>
<span class="nc" id="L185">    }</span>

    /**
     * Set encrypted value.
     * @param pFieldId the fieldId to set
     * @param pValue the value to set
     * @throws OceanusException on error
     */
    protected final void setEncryptedValue(final MetisDataFieldId pFieldId,
                                           final Object pValue) throws OceanusException {
        /* Obtain the existing value */
<span class="nc" id="L196">        final MetisFieldDef myFieldDef = getDataFieldSet().getField(pFieldId);</span>
<span class="nc" id="L197">        final PrometheusEncryptedValues myValueSet = getValues();</span>
<span class="nc" id="L198">        Object myCurrent = myValueSet.getValue(myFieldDef);</span>

        /* Handle switched usage */
<span class="nc bnc" id="L201" title="All 4 branches missed.">        if (myCurrent != null &amp;&amp; !(myCurrent instanceof PrometheusEncryptedPair)) {</span>
<span class="nc" id="L202">            myCurrent = null;</span>
        }

        /* Create the new encrypted value */
<span class="nc" id="L206">        final PrometheusEncryptedPair myCurr = (PrometheusEncryptedPair) myCurrent;</span>
<span class="nc" id="L207">        final PrometheusEncryptedPair myField = getEncryptor().encryptValue(myCurr, pValue);</span>

        /* Store the new value */
<span class="nc" id="L210">        myValueSet.setUncheckedValue(myFieldDef, myField);</span>
<span class="nc" id="L211">    }</span>

    /**
     * Set encrypted value.
     * @param pFieldId the fieldId to set
     * @param pEncrypted the encrypted value to set
      * @throws OceanusException on error
     */
    protected final void setEncryptedValue(final MetisDataFieldId pFieldId,
                                           final byte[] pEncrypted) throws OceanusException {
        /* Create the new encrypted value */
<span class="nc" id="L222">        final MetisFieldDef myFieldDef = getDataFieldSet().getField(pFieldId);</span>
<span class="nc" id="L223">        final PrometheusEncryptedPair myField = getEncryptor().decryptValue(pEncrypted, myFieldDef);</span>

        /* Store the new value */
<span class="nc" id="L226">        getValues().setValue(myFieldDef, myField);</span>
<span class="nc" id="L227">    }</span>

    /**
     * Set encrypted value.
     * @param pFieldId the fieldId to set
     * @param pEncrypted the encrypted value to set
     * @param pClazz the class to decrypt to
     * @throws OceanusException on error
     */
    protected final void setEncryptedValue(final MetisDataFieldId pFieldId,
                                           final byte[] pEncrypted,
                                           final Class&lt;?&gt; pClazz) throws OceanusException {
        /* Create the new encrypted value */
<span class="nc" id="L240">        final MetisFieldDef myFieldDef = getDataFieldSet().getField(pFieldId);</span>
<span class="nc" id="L241">        final PrometheusEncryptedPair myField = getEncryptor().decryptValue(pEncrypted, pClazz);</span>

        /* Store the new value */
<span class="nc" id="L244">        getValues().setUncheckedValue(myFieldDef, myField);</span>
<span class="nc" id="L245">    }</span>

    /**
     * Determine whether two ValuePair objects differ.
     * @param pCurr The current Pair
     * @param pNew The new Pair
     * @return &lt;code&gt;true&lt;/code&gt; if the objects differ, &lt;code&gt;false&lt;/code&gt; otherwise
     */
    public static MetisDataDifference getDifference(final PrometheusEncryptedPair pCurr,
                                                    final PrometheusEncryptedPair pNew) {
        /* Handle case where current value is null */
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (pCurr == null) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">            return (pNew != null)</span>
<span class="nc" id="L258">                    ? MetisDataDifference.DIFFERENT</span>
<span class="nc" id="L259">                    : MetisDataDifference.IDENTICAL;</span>
        }

        /* Handle case where new value is null */
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (pNew == null) {</span>
<span class="nc" id="L264">            return MetisDataDifference.DIFFERENT;</span>
        }

        /* Handle Standard cases */
<span class="nc" id="L268">        return pCurr.differs(pNew);</span>
    }

    @Override
    public void resolveDataSetLinks() throws OceanusException {
        /* Resolve the ControlKey */
<span class="nc" id="L274">        final PrometheusDataSet myData = getDataSet();</span>
<span class="nc" id="L275">        resolveDataLink(PrometheusCryptographyDataType.DATAKEYSET, myData.getDataKeySets());</span>
<span class="nc" id="L276">    }</span>

    /**
     * Adopt security for all encrypted values.
     * @param pKeySet the new KeySet
     * @param pBase the base item
     * @throws OceanusException on error
     */
    protected void adoptSecurity(final PrometheusDataKeySet pKeySet,
                                 final PrometheusEncryptedDataItem pBase) throws OceanusException {
        /* Set the DataKeySet */
<span class="nc" id="L287">        setValueDataKeySet(pKeySet);</span>

        /* Access underlying values if they exist */
<span class="nc" id="L290">        final PrometheusEncryptedValues myBaseValues = pBase.getValues();</span>

        /* Try to adopt the underlying */
<span class="nc" id="L293">        getValues().adoptSecurity(myBaseValues);</span>
<span class="nc" id="L294">    }</span>

    /**
     * Initialise security for all encrypted values.
     * @param pKeySet the new KeySet
     * @throws OceanusException on error
     */
    protected void initialiseSecurity(final PrometheusDataKeySet pKeySet) throws OceanusException {
        /* Set the DataKeySet */
<span class="nc" id="L303">        setValueDataKeySet(pKeySet);</span>

        /* Initialise security */
<span class="nc" id="L306">        getValues().adoptSecurity(null);</span>
<span class="nc" id="L307">    }</span>

    /**
     * Update security for all encrypted values.
     * @param pKeySet the new KeySet
     * @throws OceanusException on error
     */
    protected void updateSecurity(final PrometheusDataKeySet pKeySet) throws OceanusException {
        /* Ignore call if we have the same keySet */
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (pKeySet.equals(getDataKeySet())) {</span>
<span class="nc" id="L317">            return;</span>
        }

        /* Store the current detail into history */
<span class="nc" id="L321">        pushHistory();</span>

        /* Set the DataKeySet */
<span class="nc" id="L324">        setDataKeySet(pKeySet);</span>

        /* Update all elements */
<span class="nc" id="L327">        getValues().updateSecurity();</span>
<span class="nc" id="L328">    }</span>

    /**
     * Encrypted DataList.
     * @param &lt;T&gt; the item type
     */
    public abstract static class PrometheusEncryptedList&lt;T extends PrometheusEncryptedDataItem&gt;
            extends PrometheusDataList&lt;T&gt; {
        /*
         * Report fields.
         */
        static {
<span class="nc" id="L340">            MetisFieldSet.newFieldSet(PrometheusEncryptedList.class);</span>
<span class="nc" id="L341">        }</span>

        /**
         * Construct an empty CORE encrypted list.
         * @param pBaseClass the class of the underlying object
         * @param pData the DataSet for the list
         * @param pItemType the item type
         */
        protected PrometheusEncryptedList(final Class&lt;T&gt; pBaseClass,
                                          final PrometheusDataSet pData,
                                          final MetisListKey pItemType) {
<span class="nc" id="L352">            this(pBaseClass, pData, pItemType, PrometheusListStyle.CORE);</span>
<span class="nc" id="L353">        }</span>

        /**
         * Construct a generic encrypted list.
         * @param pBaseClass the class of the underlying object
         * @param pData the DataSet for the list
         * @param pItemType the list type
         * @param pStyle the style of the list
         */
        protected PrometheusEncryptedList(final Class&lt;T&gt; pBaseClass,
                                          final PrometheusDataSet pData,
                                          final MetisListKey pItemType,
                                          final PrometheusListStyle pStyle) {
<span class="nc" id="L366">            super(pBaseClass, pData, pItemType, pStyle);</span>
<span class="nc" id="L367">        }</span>

        /**
         * Constructor for a cloned List.
         * @param pSource the source List
         */
        protected PrometheusEncryptedList(final PrometheusEncryptedList&lt;T&gt; pSource) {
<span class="nc" id="L374">            super(pSource);</span>
<span class="nc" id="L375">        }</span>

        /**
         * Get the active controlKey.
         * @return the active controlKey
         */
        private PrometheusControlKey getControlKey() {
<span class="nc" id="L382">            final PrometheusControlData myControl = getDataSet().getControl();</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            return (myControl == null)</span>
<span class="nc" id="L384">                    ? null</span>
<span class="nc" id="L385">                    : myControl.getControlKey();</span>
        }

        /**
         * Obtain the DataKeySet to use.
         * @return the DataKeySet
         */
        private PrometheusDataKeySet getNextDataKeySet() {
<span class="nc" id="L393">            final PrometheusControlKey myKey = getControlKey();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">            return (myKey == null)</span>
<span class="nc" id="L395">                    ? null</span>
<span class="nc" id="L396">                    : myKey.getNextDataKeySet();</span>
        }

        /**
         * Update Security for items in the list.
         * @param pReport the report
         * @param pControl the control key to apply
         * @throws OceanusException on error
         */
        public void updateSecurity(final TethysUIThreadStatusReport pReport,
                                   final PrometheusControlKey pControl) throws OceanusException {
            /* Declare the new stage */
<span class="nc" id="L408">            pReport.setNewStage(listName());</span>

            /* Count the Number of items */
<span class="nc" id="L411">            pReport.setNumSteps(size());</span>

            /* Loop through the items */
<span class="nc" id="L414">            final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L416">                final T myCurr = myIterator.next();</span>

                /* Only update if we are using the wrong controlKey */
<span class="nc bnc" id="L419" title="All 2 branches missed.">                if (!pControl.equals(myCurr.getDataKeySet().getControlKey())) {</span>
                    /* Update the security */
<span class="nc" id="L421">                    myCurr.updateSecurity(pControl.getNextDataKeySet());</span>
                }

                /* Report the progress */
<span class="nc" id="L425">                pReport.setNextStep();</span>
<span class="nc" id="L426">            }</span>
<span class="nc" id="L427">        }</span>

        /**
         * Adopt security from underlying list. If a match for the item is found in the underlying
         * list, its security is adopted. If no match is found then the security is initialised.
         * @param pReport the report
         * @param pBase The base list to adopt from
         * @throws OceanusException on error
         */
        protected void adoptSecurity(final TethysUIThreadStatusReport pReport,
                                     final PrometheusEncryptedList&lt;?&gt; pBase) throws OceanusException {
            /* Declare the new stage */
<span class="nc" id="L439">            pReport.setNewStage(listName());</span>

            /* Count the Number of items */
<span class="nc" id="L442">            pReport.setNumSteps(size());</span>

            /* Obtain DataKeySet list */
<span class="nc" id="L445">            final PrometheusDataSet myData = getDataSet();</span>
<span class="nc" id="L446">            final PrometheusDataKeySetList mySets = myData.getDataKeySets();</span>

            /* Create an iterator for our new list */
<span class="nc" id="L449">            final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc" id="L450">            final Class&lt;T&gt; myClass = getBaseClass();</span>

            /* Loop through this list */
<span class="nc bnc" id="L453" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
                /* Locate the item in the base list */
<span class="nc" id="L455">                final PrometheusEncryptedDataItem myCurr = myIterator.next();</span>
<span class="nc" id="L456">                final PrometheusEncryptedDataItem myBase = pBase.findItemById(myCurr.getIndexedId());</span>

                /* Access target correctly */
<span class="nc" id="L459">                final T myTarget = myClass.cast(myCurr);</span>

                /* If we have a base */
<span class="nc bnc" id="L462" title="All 2 branches missed.">                if (myBase != null) {</span>
                    /* Access base correctly */
<span class="nc" id="L464">                    final T mySource = myClass.cast(myBase);</span>

                    /* Obtain required KeySet */
<span class="nc" id="L467">                    PrometheusDataKeySet mySet = myBase.getDataKeySet();</span>
<span class="nc" id="L468">                    mySet = mySets.findItemById(mySet.getIndexedId());</span>

                    /* Adopt the security */
<span class="nc" id="L471">                    myTarget.adoptSecurity(mySet, mySource);</span>
<span class="nc" id="L472">                } else {</span>
                    /* Initialise the security */
<span class="nc" id="L474">                    myTarget.initialiseSecurity(getNextDataKeySet());</span>
                }

                /* Report the progress */
<span class="nc" id="L478">                pReport.setNextStep();</span>
<span class="nc" id="L479">            }</span>
<span class="nc" id="L480">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>