<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusDataStore.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.prometheus.database</a> &gt; <span class="el_source">PrometheusDataStore.java</span></div><h1>PrometheusDataStore.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Prometheus: Application Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.prometheus.database;

import net.sourceforge.joceanus.prometheus.exc.PrometheusIOException;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataSet;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataSet.PrometheusCryptographyDataType;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.logger.OceanusLogManager;
import net.sourceforge.joceanus.oceanus.logger.OceanusLogger;
import net.sourceforge.joceanus.oceanus.profile.OceanusProfile;
import net.sourceforge.joceanus.tethys.api.thread.TethysUIThreadStatusReport;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.ListIterator;
import java.util.Properties;

/**
 * Class that encapsulates a database connection.
 */
public abstract class PrometheusDataStore {
    /**
     * Number of update steps per table (INSERT/UPDATE/DELETE).
     */
    private static final int NUM_STEPS_PER_TABLE = 3;

    /**
     * User property name.
     */
    private static final String PROPERTY_USER = &quot;user&quot;;

    /**
     * Password property name.
     */
    private static final String PROPERTY_PASS = &quot;password&quot;;

    /**
     * Instance property name.
     */
    private static final String PROPERTY_INSTANCE = &quot;instance&quot;;

    /**
     * Encrypt property name.
     */
    private static final String PROPERTY_ENCRYPT = &quot;encrypt&quot;;

    /**
     * Logger.
     */
<span class="nc" id="L70">    private static final OceanusLogger LOGGER = OceanusLogManager.getLogger(PrometheusDataStore.class);</span>

    /**
     * Database connection.
     */
    private Connection theConn;

    /**
     * Database name.
     */
    private String theDatabase;

    /**
     * Batch Size.
     */
    private final Integer theBatchSize;

    /**
     * Database Driver.
     */
    private final PrometheusJDBCDriver theDriver;

    /**
     * List of Database tables.
     */
    private final List&lt;PrometheusTableDataItem&lt;?&gt;&gt; theTables;

    /**
     * Construct a new Database class.
     * @param pDatabase the database
     * @param pConfig the config
     * @throws OceanusException on error
     */
    protected PrometheusDataStore(final String pDatabase,
<span class="nc" id="L104">                                  final PrometheusDBConfig pConfig) throws OceanusException {</span>
        /* Create the connection */
        try {
            /* Access the batch size */
<span class="nc" id="L108">            theBatchSize = pConfig.getBatchSize();</span>

            /* Access the JDBC Driver */
<span class="nc" id="L111">            theDriver = pConfig.getDriver();</span>

            /* Store the name */
<span class="nc" id="L114">            theDatabase = pDatabase;</span>

            /* Obtain the connection */
<span class="nc" id="L117">            final String myConnString = theDriver.getConnectionString(pDatabase, pConfig.getServer(), pConfig.getPort());</span>

            /* Create the properties and record user */
<span class="nc" id="L120">            final Properties myProperties = new Properties();</span>
<span class="nc" id="L121">            final String myUser = pConfig.getUser();</span>
<span class="nc" id="L122">            final char[] myPass = pConfig.getPassword();</span>
<span class="nc" id="L123">            myProperties.setProperty(PROPERTY_USER, myUser);</span>
<span class="nc" id="L124">            myProperties.setProperty(PROPERTY_PASS, new String(myPass));</span>

            /* If we are using instance */
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (theDriver.useInstance()) {</span>
<span class="nc" id="L128">                final String myInstance = pConfig.getInstance();</span>
<span class="nc" id="L129">                myProperties.setProperty(PROPERTY_INSTANCE, myInstance);</span>
<span class="nc" id="L130">                myProperties.setProperty(PROPERTY_ENCRYPT, &quot;false&quot;);</span>
            }

            /* Connect using properties */
<span class="nc" id="L134">            theConn = DriverManager.getConnection(myConnString, myProperties);</span>

            /* Connect to the correct database */
<span class="nc" id="L137">            theConn.setCatalog(pDatabase);</span>

            /* Switch off autoCommit */
<span class="nc" id="L140">            theConn.setAutoCommit(false);</span>

            /* handle exceptions */
<span class="nc" id="L143">        } catch (SQLException e) {</span>
<span class="nc" id="L144">            throw new PrometheusIOException(&quot;Failed to load driver&quot;, e);</span>
<span class="nc" id="L145">        }</span>

        /* Create table list and add the tables to the list */
<span class="nc" id="L148">        theTables = new ArrayList&lt;&gt;();</span>

        /* Loop through the tables */
<span class="nc bnc" id="L151" title="All 2 branches missed.">        for (PrometheusCryptographyDataType myType : PrometheusCryptographyDataType.values()) {</span>
            /* Create the sheet */
<span class="nc" id="L153">            theTables.add(newTable(myType));</span>
        }
<span class="nc" id="L155">    }</span>

    /**
     * Construct a new Database class.
     * @param pConfig the config
     * @throws OceanusException on error
     */
<span class="nc" id="L162">    protected PrometheusDataStore(final PrometheusDBConfig pConfig) throws OceanusException {</span>
        /* Create the connection */
        try {
            /* Access the batch size */
<span class="nc" id="L166">            theBatchSize = pConfig.getBatchSize();</span>

            /* Access the JDBC Driver */
<span class="nc" id="L169">            theDriver = pConfig.getDriver();</span>

            /* Obtain the connection */
<span class="nc" id="L172">            final String myConnString = theDriver.getConnectionString(pConfig.getServer(), pConfig.getPort());</span>

            /* Create the properties and record user */
<span class="nc" id="L175">            final Properties myProperties = new Properties();</span>
<span class="nc" id="L176">            final String myUser = pConfig.getUser();</span>
<span class="nc" id="L177">            final char[] myPass = pConfig.getPassword();</span>
<span class="nc" id="L178">            myProperties.setProperty(PROPERTY_USER, myUser);</span>
<span class="nc" id="L179">            myProperties.setProperty(PROPERTY_PASS, new String(myPass));</span>

            /* If we are using instance */
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (theDriver.useInstance()) {</span>
<span class="nc" id="L183">                final String myInstance = pConfig.getInstance();</span>
<span class="nc" id="L184">                myProperties.setProperty(PROPERTY_INSTANCE, myInstance);</span>
<span class="nc" id="L185">                myProperties.setProperty(PROPERTY_ENCRYPT, &quot;false&quot;);</span>
            }

            /* Connect using properties */
<span class="nc" id="L189">            theConn = DriverManager.getConnection(myConnString, myProperties);</span>

            /* Switch off autoCommit */
<span class="nc" id="L192">            theConn.setAutoCommit(false);</span>

            /* handle exceptions */
<span class="nc" id="L195">        } catch (SQLException e) {</span>
<span class="nc" id="L196">            throw new PrometheusIOException(&quot;Failed to load driver&quot;, e);</span>
<span class="nc" id="L197">        }</span>

        /* Create table list and add the tables to the list */
<span class="nc" id="L200">        theTables = new ArrayList&lt;&gt;();</span>

        /* Loop through the tables */
<span class="nc bnc" id="L203" title="All 2 branches missed.">        for (PrometheusCryptographyDataType myType : PrometheusCryptographyDataType.values()) {</span>
            /* Create the sheet */
<span class="nc" id="L205">            theTables.add(newTable(myType));</span>
        }
<span class="nc" id="L207">    }</span>

    /**
     * Obtain the database name.
     * @return the name
     */
    public String getName() {
<span class="nc" id="L214">        return theDatabase;</span>
    }

    /**
     * Execute the statement outside a transaction.
     * @param pStatement the statement
     * @throws OceanusException on error
     */
    void executeStatement(final String pStatement) throws OceanusException {
        /* Protect the statement and execute without commit */
<span class="nc" id="L224">        try (PreparedStatement myStmt = theConn.prepareStatement(pStatement)) {</span>
<span class="nc" id="L225">            theConn.setAutoCommit(true);</span>
<span class="nc" id="L226">            myStmt.execute();</span>
<span class="nc" id="L227">            theConn.setAutoCommit(false);</span>

<span class="nc" id="L229">        } catch (SQLException e) {</span>
<span class="nc" id="L230">            throw new PrometheusIOException(&quot;Failed to execute statement&quot;, e);</span>
<span class="nc" id="L231">        }</span>
<span class="nc" id="L232">    }</span>

    /**
     * Create new sheet of required type.
     * @param pListType the list type
     * @return the new sheet
     */
    private PrometheusTableDataItem&lt;?&gt; newTable(final PrometheusCryptographyDataType pListType) {
        /* Switch on list Type */
<span class="nc bnc" id="L241" title="All 5 branches missed.">        switch (pListType) {</span>
            case CONTROLDATA:
<span class="nc" id="L243">                return new PrometheusTableControlData(this);</span>
            case CONTROLKEY:
<span class="nc" id="L245">                return new PrometheusTableControlKeys(this);</span>
            case CONTROLKEYSET:
<span class="nc" id="L247">                return new PrometheusTableControlKeySet(this);</span>
            case DATAKEYSET:
<span class="nc" id="L249">                return new PrometheusTableDataKeySet(this);</span>
            default:
<span class="nc" id="L251">                throw new IllegalArgumentException(pListType.toString());</span>
        }
    }

    /**
     * Obtain the Driver.
     * @return the driver
     */
    protected PrometheusJDBCDriver getDriver() {
<span class="nc" id="L260">        return theDriver;</span>
    }

    /**
     * Access the connection.
     * @return the connection
     */
    protected Connection getConn() {
<span class="nc" id="L268">        return theConn;</span>
    }

    /**
     * Add a table.
     * @param pTable the Table to add
     */
    protected void addTable(final PrometheusTableDataItem&lt;?&gt; pTable) {
<span class="nc" id="L276">        pTable.getDefinition().resolveReferences(theTables);</span>
<span class="nc" id="L277">        theTables.add(pTable);</span>
<span class="nc" id="L278">    }</span>

    /**
     * Close the connection to the database rolling back any outstanding transaction.
     */
    public void close() {
        /* Ignore if no connection */
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (theConn == null) {</span>
<span class="nc" id="L286">            return;</span>
        }

        /* Protect against exceptions */
        try {
            /* Roll-back any outstanding transaction */
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (!theConn.getAutoCommit()) {</span>
<span class="nc" id="L293">                theConn.rollback();</span>
            }

            /* Loop through the tables */
<span class="nc bnc" id="L297" title="All 2 branches missed.">            for (PrometheusTableDataItem&lt;?&gt; myTable : theTables) {</span>
                /* Close the Statement */
<span class="nc" id="L299">                myTable.closeStmt();</span>
<span class="nc" id="L300">            }</span>

            /* Close the connection */
<span class="nc" id="L303">            theConn.close();</span>
<span class="nc" id="L304">            theConn = null;</span>

            /* Discard Exceptions */
<span class="nc" id="L307">        } catch (SQLException e) {</span>
<span class="nc" id="L308">            LOGGER.error(&quot;Failed to close database connection&quot;, e);</span>
<span class="nc" id="L309">            theConn = null;</span>
<span class="nc" id="L310">        }</span>
<span class="nc" id="L311">    }</span>

    /**
     * Load data from the database.
     * @param pReport the report
     * @param pData the new DataSet
     * @throws OceanusException on error
     */
    public void loadDatabase(final TethysUIThreadStatusReport pReport,
                             final PrometheusDataSet pData) throws OceanusException {
        /* Initialise task */
<span class="nc" id="L322">        pReport.initTask(&quot;loadDatabase&quot;);</span>
<span class="nc" id="L323">        pReport.setNumStages(theTables.size());</span>

        /* Obtain the active profile */
<span class="nc" id="L326">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L327">        myTask = myTask.startTask(&quot;loadDatabase&quot;);</span>

        /* Loop through the tables */
<span class="nc bnc" id="L330" title="All 2 branches missed.">        for (PrometheusTableDataItem&lt;?&gt; myTable : theTables) {</span>
            /* Note the new step */
<span class="nc" id="L332">            myTask.startTask(myTable.getTableName());</span>

            /* Load the items */
<span class="nc" id="L335">            myTable.loadItems(pReport, pData);</span>
<span class="nc" id="L336">        }</span>

        /* Complete the task */
<span class="nc" id="L339">        myTask.end();</span>
<span class="nc" id="L340">    }</span>

    /**
     * Update data into database.
     * @param pReport the report
     * @param pData the data
     * @throws OceanusException on error
     */
    public void updateDatabase(final TethysUIThreadStatusReport pReport,
                               final PrometheusDataSet pData) throws OceanusException {
        /* Set the number of stages */
<span class="nc" id="L351">        final PrometheusBatchControl myBatch = new PrometheusBatchControl(theBatchSize);</span>
<span class="nc" id="L352">        pReport.setNumStages(NUM_STEPS_PER_TABLE * theTables.size());</span>

        /* Obtain the active profile */
<span class="nc" id="L355">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L356">        myTask = myTask.startTask(&quot;updateDatabase&quot;);</span>

        /* Loop through the tables */
<span class="nc" id="L359">        OceanusProfile myStage = myTask.startTask(&quot;insertData&quot;);</span>
<span class="nc" id="L360">        final Iterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myIterator = theTables.iterator();</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L362">            final PrometheusTableDataItem&lt;?&gt; myTable = myIterator.next();</span>

            /* Note the new step */
<span class="nc" id="L365">            myStage.startTask(myTable.getTableName());</span>

            /* insert the items */
<span class="nc" id="L368">            myTable.insertItems(pReport, pData, myBatch);</span>
<span class="nc" id="L369">        }</span>

        /* Loop through the tables */
<span class="nc" id="L372">        myStage = myTask.startTask(&quot;updateData&quot;);</span>
<span class="nc" id="L373">        final ListIterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myListIterator = theTables.listIterator();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        while (myListIterator.hasNext()) {</span>
<span class="nc" id="L375">            final PrometheusTableDataItem&lt;?&gt; myTable = myListIterator.next();</span>

            /* Note the new step */
<span class="nc" id="L378">            myStage.startTask(myTable.getTableName());</span>

            /* Load the items */
<span class="nc" id="L381">            myTable.updateItems(pReport, myBatch);</span>
<span class="nc" id="L382">        }</span>

        /* Loop through the tables in reverse order */
<span class="nc" id="L385">        myStage = myTask.startTask(&quot;deleteData&quot;);</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">        while (myListIterator.hasPrevious()) {</span>
<span class="nc" id="L387">            final PrometheusTableDataItem&lt;?&gt; myTable = myListIterator.previous();</span>

            /* Note the new step */
<span class="nc" id="L390">            myStage.startTask(myTable.getTableName());</span>

            /* Delete items from the table */
<span class="nc" id="L393">            myTable.deleteItems(pReport, myBatch);</span>
<span class="nc" id="L394">        }</span>

        /* If we have active work in the batch */
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (myBatch.isActive()) {</span>
            /* Commit the database */
            try {
<span class="nc" id="L400">                theConn.commit();</span>
<span class="nc" id="L401">            } catch (SQLException e) {</span>
<span class="nc" id="L402">                close();</span>
<span class="nc" id="L403">                throw new PrometheusIOException(&quot;Failed to commit transaction&quot;, e);</span>
<span class="nc" id="L404">            }</span>

            /* Commit the batch */
<span class="nc" id="L407">            myBatch.commitItems();</span>
        }

        /* Complete the task */
<span class="nc" id="L411">        myTask.end();</span>
<span class="nc" id="L412">    }</span>

    /**
     * Create database.
     * @param pReport the report
     * @param pDatabase the database to create
     * @throws OceanusException on error
     */
    public void createDatabase(final TethysUIThreadStatusReport pReport,
                               final String pDatabase) throws OceanusException {
        /* Set the number of stages */
<span class="nc" id="L423">        pReport.setNumStages(2);</span>

        /* Obtain the active profile */
<span class="nc" id="L426">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L427">        myTask = myTask.startTask(&quot;dropDatabase&quot;);</span>
<span class="nc" id="L428">        executeStatement(&quot;DROP DATABASE IF EXISTS &quot; + pDatabase);</span>

        /* Create database */
<span class="nc" id="L431">        myTask = myTask.startTask(&quot;createDatabase&quot;);</span>
<span class="nc" id="L432">        executeStatement(&quot;CREATE DATABASE &quot; + pDatabase);</span>

        /* Complete the task */
<span class="nc" id="L435">        myTask.end();</span>
<span class="nc" id="L436">    }</span>

    /**
     * Create tables.
     * @param pReport the report
     * @throws OceanusException on error
     */
    public void createTables(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Set the number of stages */
<span class="nc" id="L445">        pReport.setNumStages(2);</span>

        /* Drop any existing tables */
<span class="nc" id="L448">        dropTables(pReport);</span>

        /* Obtain the active profile */
<span class="nc" id="L451">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L452">        myTask = myTask.startTask(&quot;createTables&quot;);</span>

        /* Loop through the tables */
<span class="nc" id="L455">        final Iterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myIterator = theTables.iterator();</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L457">            final PrometheusTableDataItem&lt;?&gt; myTable = myIterator.next();</span>

            /* Check for cancellation */
<span class="nc" id="L460">            pReport.checkForCancellation();</span>

            /* Note the new step */
<span class="nc" id="L463">            myTask.startTask(myTable.getTableName());</span>

            /* Create the table */
<span class="nc" id="L466">            myTable.createTable();</span>
<span class="nc" id="L467">        }</span>

        /* Complete the task */
<span class="nc" id="L470">        myTask.end();</span>
<span class="nc" id="L471">    }</span>

    /**
     * Drop tables.
     * @param pReport the report
     * @throws OceanusException on error
     */
    private void dropTables(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Obtain the active profile */
<span class="nc" id="L480">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L481">        myTask = myTask.startTask(&quot;dropTables&quot;);</span>

        /* Loop through the tables in reverse order */
<span class="nc" id="L484">        final ListIterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myIterator = theTables.listIterator(theTables.size());</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">        while (myIterator.hasPrevious()) {</span>
<span class="nc" id="L486">            final PrometheusTableDataItem&lt;?&gt; myTable = myIterator.previous();</span>

            /* Check for cancellation */
<span class="nc" id="L489">            pReport.checkForCancellation();</span>

            /* Note the new step */
<span class="nc" id="L492">            myTask.startTask(myTable.getTableName());</span>

            /* Drop the table */
<span class="nc" id="L495">            myTable.dropTable();</span>
<span class="nc" id="L496">        }</span>

        /* Complete the task */
<span class="nc" id="L499">        myTask.end();</span>
<span class="nc" id="L500">    }</span>

    /**
     * Purge tables.
     * @param pReport the report
     * @throws OceanusException on error
     */
    public void purgeTables(final TethysUIThreadStatusReport pReport) throws OceanusException {
        /* Set the number of stages */
<span class="nc" id="L509">        pReport.setNumStages(1);</span>

        /* Obtain the active profile */
<span class="nc" id="L512">        OceanusProfile myTask = pReport.getActiveTask();</span>
<span class="nc" id="L513">        myTask = myTask.startTask(&quot;purgeTables&quot;);</span>

        /* Loop through the tables in reverse order */
<span class="nc" id="L516">        final ListIterator&lt;PrometheusTableDataItem&lt;?&gt;&gt; myIterator = theTables.listIterator(theTables.size());</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">        while (myIterator.hasPrevious()) {</span>
<span class="nc" id="L518">            final PrometheusTableDataItem&lt;?&gt; myTable = myIterator.previous();</span>

            /* Check for cancellation */
<span class="nc" id="L521">            pReport.checkForCancellation();</span>

            /* Note the new step */
<span class="nc" id="L524">            myTask.startTask(myTable.getTableName());</span>

            /* Purge the table */
<span class="nc" id="L527">            myTable.purgeTable();</span>
<span class="nc" id="L528">        }</span>

        /* Complete the task */
<span class="nc" id="L531">        myTask.end();</span>
<span class="nc" id="L532">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>