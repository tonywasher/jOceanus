<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusTableDataItem.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.prometheus.database</a> &gt; <span class="el_source">PrometheusTableDataItem.java</span></div><h1>PrometheusTableDataItem.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Prometheus: Application Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.prometheus.database;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Iterator;
import java.util.ListIterator;

import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.metis.data.MetisDataResource;
import net.sourceforge.joceanus.metis.data.MetisDataState;
import net.sourceforge.joceanus.metis.field.MetisFieldVersionValues;
import net.sourceforge.joceanus.prometheus.exc.PrometheusDataException;
import net.sourceforge.joceanus.prometheus.exc.PrometheusIOException;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataItem;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataList;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataSet;
import net.sourceforge.joceanus.prometheus.data.PrometheusDataValues;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.tethys.api.thread.TethysUIThreadStatusReport;

/**
 * Database Table class. This controls should be extended for each DataType/Table.
 * @param &lt;T&gt; the DataType
 */
public abstract class PrometheusTableDataItem&lt;T extends PrometheusDataItem&gt; {
    /**
     * The Database control.
     */
    private final PrometheusDataStore theDatabase;

    /**
     * The Database connection.
     */
    private final Connection theConn;

    /**
     * The list of items for this table.
     */
    private PrometheusDataList&lt;T&gt; theList;

    /**
     * The prepared statement.
     */
    private PreparedStatement theStmt;

    /**
     * Do we have batched updated in the prepared statement?
     */
    private boolean hasBatchedUpdates;

    /**
     * The result set.
     */
    private ResultSet theResults;

    /**
     * The table definition.
     */
    private final PrometheusTableDefinition theTable;

    /**
     * Constructor.
     * @param pDatabase the database control
     * @param pTable the table name
     */
    protected PrometheusTableDataItem(final PrometheusDataStore pDatabase,
<span class="nc" id="L85">                                      final String pTable) {</span>
        /* Set the table */
<span class="nc" id="L87">        theDatabase = pDatabase;</span>
<span class="nc" id="L88">        theConn = theDatabase.getConn();</span>
<span class="nc" id="L89">        theTable = new PrometheusTableDefinition(theDatabase.getDriver(), pTable);</span>
<span class="nc" id="L90">    }</span>

    /**
     * Obtain database.
     * @return the database
     */
    protected PrometheusDataStore getDatabase() {
<span class="nc" id="L97">        return theDatabase;</span>
    }

    /**
     * Obtain table definition.
     * @return the table definition
     */
    protected PrometheusTableDefinition getTableDef() {
<span class="nc" id="L105">        return theTable;</span>
    }

    /**
     * Access the table name.
     * @return the table name
     */
    protected String getTableName() {
<span class="nc" id="L113">        return theTable.getTableName();</span>
    }

    /**
     * Access the table definition.
     * @return the table definition
     */
    protected PrometheusTableDefinition getDefinition() {
<span class="nc" id="L121">        return theTable;</span>
    }

    /**
     * Close the result set and statement.
     * @throws SQLException on error
     */
    protected void closeStmt() throws SQLException {
<span class="nc" id="L129">        executeBatch();</span>
<span class="nc" id="L130">        theTable.clearValues();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (theResults != null) {</span>
<span class="nc" id="L132">            theResults.close();</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (theStmt != null) {</span>
<span class="nc" id="L135">            theStmt.close();</span>
        }
<span class="nc" id="L137">    }</span>

    /**
     * Shift to next line in result set.
     * @return is there a next line
     * @throws SQLException on error
     */
    private boolean nextLine() throws SQLException {
<span class="nc" id="L145">        return theResults.next();</span>
    }

    /**
     * Prepare the statement.
     * @param pStatement the statement to prepare
     * @throws SQLException on error
     */
    private void prepareStatement(final String pStatement) throws SQLException {
<span class="nc" id="L154">        theStmt = theConn.prepareStatement(pStatement);</span>
<span class="nc" id="L155">    }</span>

    /**
     * Execute the prepared statement.
     * @throws SQLException on error
     */
    private void execute() throws SQLException {
<span class="nc" id="L162">        theStmt.executeUpdate();</span>
<span class="nc" id="L163">        theTable.clearValues();</span>
<span class="nc" id="L164">    }</span>

    /**
     * Add to the batched statement.
     * @throws SQLException on error
     */
    private void addToBatch() throws SQLException {
<span class="nc" id="L171">        theStmt.addBatch();</span>
<span class="nc" id="L172">        theTable.clearValues();</span>
<span class="nc" id="L173">        hasBatchedUpdates = true;</span>
<span class="nc" id="L174">    }</span>

    /**
     * Execute the batched statement.
     * @throws SQLException on error
     */
    private void executeBatch() throws SQLException {
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (hasBatchedUpdates) {</span>
<span class="nc" id="L182">            theStmt.executeBatch();</span>
<span class="nc" id="L183">            hasBatchedUpdates = false;</span>
        }
<span class="nc" id="L185">    }</span>

    /**
     * Query the prepared statement.
     * @throws SQLException on error
     */
    private void executeQuery() throws SQLException {
<span class="nc" id="L192">        theTable.clearValues();</span>
<span class="nc" id="L193">        theResults = theStmt.executeQuery();</span>
<span class="nc" id="L194">    }</span>

    /**
     * Commit the update.
     * @throws SQLException on error
     */
    private void commit() throws SQLException {
<span class="nc" id="L201">        theConn.commit();</span>
<span class="nc" id="L202">    }</span>

    /**
     * Execute a statement.
     * @param pStatement the statement
     * @throws SQLException on error
     */
    private void executeStatement(final String pStatement) throws SQLException {
        /* Prepare the statement */
<span class="nc" id="L211">        prepareStatement(pStatement);</span>

        /* Execute the delete */
<span class="nc" id="L214">        execute();</span>
<span class="nc" id="L215">        commit();</span>

        /* Close the Statement */
<span class="nc" id="L218">        closeStmt();</span>
<span class="nc" id="L219">    }</span>

    /**
     * Count the number of items to be loaded.
     * @return the count of items
     * @throws SQLException on error
     */
    protected int countLoadItems() throws SQLException {
<span class="nc" id="L227">        int myCount = 0;</span>
<span class="nc" id="L228">        final String myString = theTable.getCountString();</span>
<span class="nc" id="L229">        prepareStatement(myString);</span>
<span class="nc" id="L230">        executeQuery();</span>

        /* Loop through the results */
<span class="nc bnc" id="L233" title="All 2 branches missed.">        while (theResults.next()) {</span>
            /* Get the count */
<span class="nc" id="L235">            myCount = theResults.getInt(1);</span>
        }

        /* Close the Statement */
<span class="nc" id="L239">        closeStmt();</span>

        /* Return the count */
<span class="nc" id="L242">        return myCount;</span>
    }

    /**
     * Declare DataSet.
     * @param pData the Data set
     */
    protected abstract void declareData(PrometheusDataSet pData);

    /**
     * Set the list of items.
     * @param pList the list of items
     */
    protected void setList(final PrometheusDataList&lt;T&gt; pList) {
<span class="nc" id="L256">        theList = pList;</span>
<span class="nc" id="L257">    }</span>

    /**
     * Obtain the list of items.
     * @return the list of items
     */
    protected PrometheusDataList&lt;T&gt; getList() {
<span class="nc" id="L264">        return theList;</span>
    }

    /**
     * Load an individual item from the result set.
     * @return the values for the row
     * @throws OceanusException on error
     */
    protected abstract PrometheusDataValues loadValues() throws OceanusException;

    /**
     * Set a field value for an item.
     * @param pItem the item to insert
     * @param pField the field id
     * @throws OceanusException on error
     */
    protected void setFieldValue(final T pItem,
                                 final MetisDataFieldId pField) throws OceanusException {
        /* Switch on field id */
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (pField.equals(MetisDataResource.DATA_ID)) {</span>
<span class="nc" id="L284">            theTable.setIntegerValue(MetisDataResource.DATA_ID, pItem.getIndexedId());</span>
        }
<span class="nc" id="L286">    }</span>

    /**
     * Post-Process on a load operation.
     * @throws OceanusException on error
     */
    protected void postProcessOnLoad() throws OceanusException {
        /* PostProcess the list */
<span class="nc" id="L294">        theList.postProcessOnLoad();</span>
<span class="nc" id="L295">    }</span>

    /**
     * Load items from the list into the table.
     * @param pReport the report
     * @param pData the data
     * @throws OceanusException on error
     */
    protected void loadItems(final TethysUIThreadStatusReport pReport,
                             final PrometheusDataSet pData) throws OceanusException {
        /* Declare the new stage */
<span class="nc" id="L306">        pReport.setNewStage(getTableName());</span>

        /* Declare the Data */
<span class="nc" id="L309">        declareData(pData);</span>

        /* Protect the load */
        try {
            /* Count the Items to be loaded */
<span class="nc" id="L314">            pReport.setNumSteps(countLoadItems());</span>

            /* Load the items from the table */
<span class="nc" id="L317">            final String myQuery = theTable.getLoadString();</span>
<span class="nc" id="L318">            prepareStatement(myQuery);</span>
<span class="nc" id="L319">            executeQuery();</span>

            /* Loop through the results */
<span class="nc bnc" id="L322" title="All 2 branches missed.">            while (nextLine()) {</span>
                /* Read in the results */
<span class="nc" id="L324">                theTable.loadResults(theResults);</span>

                /* Load the next item */
<span class="nc" id="L327">                theList.addValuesItem(loadValues());</span>

                /* Report the progress */
<span class="nc" id="L330">                pReport.setNextStep();</span>
            }

            /* Close the Statement */
<span class="nc" id="L334">            closeStmt();</span>

            /* Perform post process */
<span class="nc" id="L337">            postProcessOnLoad();</span>

<span class="nc" id="L339">        } catch (SQLException e) {</span>
<span class="nc" id="L340">            throw new PrometheusIOException(&quot;Failed to load &quot; + getTableName(), e);</span>
<span class="nc" id="L341">        }</span>
<span class="nc" id="L342">    }</span>

    /**
     * Determine the count of items that are in a particular state.
     * @param pState the particular state
     * @return the count of items
     */
    private int countStateItems(final MetisDataState pState) {
        /* Initialise the count */
<span class="nc" id="L351">        int iCount = 0;</span>

        /* Loop through the list */
<span class="nc" id="L354">        final Iterator&lt;T&gt; myIterator = theList.iterator();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L356">            final T myCurr = myIterator.next();</span>

            /* Ignore items that are not this type */
<span class="nc bnc" id="L359" title="All 2 branches missed.">            if (myCurr.getState() != pState) {</span>
<span class="nc" id="L360">                continue;</span>
            }

            /* Increment count */
<span class="nc" id="L364">            ++iCount;</span>
<span class="nc" id="L365">        }</span>

        /* Return count */
<span class="nc" id="L368">        return iCount;</span>
    }

    /**
     * Insert new items from the list.
     * @param pReport the report
     * @param pData the data
     * @param pBatch the batch control
     * @throws OceanusException on error
     */
    protected void insertItems(final TethysUIThreadStatusReport pReport,
                               final PrometheusDataSet pData,
                               final PrometheusBatchControl pBatch) throws OceanusException {
        /* Declare the new stage */
<span class="nc" id="L382">        pReport.setNewStage(&quot;Inserting &quot; + getTableName());</span>

        /* Declare the Data */
<span class="nc" id="L385">        declareData(pData);</span>

        /* Protect the insert */
<span class="nc" id="L388">        T myCurr = null;</span>
        try {
            /* Declare the number of steps */
<span class="nc" id="L391">            final int mySteps = countStateItems(MetisDataState.NEW);</span>
<span class="nc" id="L392">            pReport.setNumSteps(mySteps);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">            if (mySteps == 0) {</span>
<span class="nc" id="L394">                return;</span>
            }

            /* Declare the table and mode */
<span class="nc" id="L398">            pBatch.setCurrentTable(this, MetisDataState.NEW);</span>

            /* Prepare the insert statement */
<span class="nc" id="L401">            final String myInsert = theTable.getInsertString();</span>
<span class="nc" id="L402">            prepareStatement(myInsert);</span>

            /* Loop through the list */
<span class="nc" id="L405">            final Iterator&lt;T&gt; myIterator = theList.iterator();</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
                /* Ignore non-new items */
<span class="nc" id="L408">                myCurr = myIterator.next();</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                if (myCurr.getState() != MetisDataState.NEW) {</span>
<span class="nc" id="L410">                    continue;</span>
                }

                /* Loop through the columns */
<span class="nc bnc" id="L414" title="All 2 branches missed.">                for (PrometheusColumnDefinition myCol : theTable.getColumns()) {</span>
                    /* Access the column id */
<span class="nc" id="L416">                    final MetisDataFieldId iField = myCol.getColumnId();</span>

                    /* Set the field value */
<span class="nc" id="L419">                    setFieldValue(myCurr, iField);</span>
<span class="nc" id="L420">                }</span>

                /* Apply the values */
<span class="nc" id="L423">                theTable.insertValues(theStmt);</span>
<span class="nc" id="L424">                pBatch.addBatchItem();</span>

                /* Add to the statement batch */
<span class="nc" id="L427">                addToBatch();</span>
<span class="nc" id="L428">                myCurr = null;</span>

                /* If we have no further space in the batch */
<span class="nc bnc" id="L431" title="All 2 branches missed.">                if (pBatch.isFull()) {</span>
                    /* ExecuteBatch and commit the database */
<span class="nc" id="L433">                    executeBatch();</span>
<span class="nc" id="L434">                    commit();</span>

                    /* Commit the batch */
<span class="nc" id="L437">                    pBatch.commitItems();</span>
                }

                /* Report the progress */
<span class="nc" id="L441">                pReport.setNextStep();</span>
            }

            /* Close the Statement */
<span class="nc" id="L445">            closeStmt();</span>

<span class="nc" id="L447">        } catch (SQLException e) {</span>
<span class="nc" id="L448">            throw new PrometheusDataException(myCurr, &quot;Failed to insert &quot; + getTableName(), e);</span>
<span class="nc" id="L449">        }</span>
<span class="nc" id="L450">    }</span>

    /**
     * Update items from the list.
     * @param pReport the report
     * @param pBatch the batch control
     * @throws OceanusException on error
     */
    protected void updateItems(final TethysUIThreadStatusReport pReport,
                               final PrometheusBatchControl pBatch) throws OceanusException {
        /* Declare the new stage */
<span class="nc" id="L461">        pReport.setNewStage(&quot;Updating &quot; + getTableName());</span>

        /* Protect the update */
<span class="nc" id="L464">        T myCurr = null;</span>
        try {
            /* Declare the number of steps */
<span class="nc" id="L467">            final int mySteps = countStateItems(MetisDataState.CHANGED);</span>
<span class="nc" id="L468">            pReport.setNumSteps(mySteps);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">            if (mySteps == 0) {</span>
<span class="nc" id="L470">                return;</span>
            }

            /* Declare the table and mode */
<span class="nc" id="L474">            pBatch.setCurrentTable(this, MetisDataState.CHANGED);</span>

            /* Loop through the list */
<span class="nc" id="L477">            final Iterator&lt;T&gt; myIterator = theList.iterator();</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
                /* Ignore non-changed items */
<span class="nc" id="L480">                myCurr = myIterator.next();</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">                if ((myCurr.getState() != MetisDataState.CHANGED)</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">                        || !updateItem(myCurr)) {</span>
<span class="nc" id="L483">                    continue;</span>
                }

                /* Record the id and access the update string */
<span class="nc" id="L487">                theTable.setIntegerValue(MetisDataResource.DATA_ID, myCurr.getIndexedId());</span>
<span class="nc" id="L488">                final String myUpdate = theTable.getUpdateString();</span>

                /* Prepare the statement and declare values */
<span class="nc" id="L491">                prepareStatement(myUpdate);</span>
<span class="nc" id="L492">                theTable.updateValues(theStmt);</span>
<span class="nc" id="L493">                pBatch.addBatchItem();</span>

                /* Execute the update */
<span class="nc" id="L496">                execute();</span>
<span class="nc" id="L497">                myCurr = null;</span>

                /* Close the Statement */
<span class="nc" id="L500">                closeStmt();</span>

                /* If we have no further space in the batch */
<span class="nc bnc" id="L503" title="All 2 branches missed.">                if (pBatch.isFull()) {</span>
                    /* Commit the database */
<span class="nc" id="L505">                    commit();</span>

                    /* Commit the batch */
<span class="nc" id="L508">                    pBatch.commitItems();</span>
                }

                /* Report the progress */
<span class="nc" id="L512">                pReport.setNextStep();</span>
<span class="nc" id="L513">            }</span>
<span class="nc" id="L514">        } catch (SQLException e) {</span>
<span class="nc" id="L515">            throw new PrometheusDataException(myCurr, &quot;Failed to update &quot; + getTableName(), e);</span>
<span class="nc" id="L516">        }</span>
<span class="nc" id="L517">    }</span>

    /**
     * Update the item.
     * @param pItem the item
     * @return Continue &lt;code&gt;true/false&lt;/code&gt;
     * @throws OceanusException on error
     */
    private boolean updateItem(final T pItem) throws OceanusException {
        /* Access the object and base */
<span class="nc" id="L527">        final MetisFieldVersionValues myCurr = pItem.getValues();</span>
<span class="nc" id="L528">        final MetisFieldVersionValues myBase = pItem.getOriginalValues();</span>
<span class="nc" id="L529">        boolean isUpdated = false;</span>

        /* Loop through the fields */
<span class="nc bnc" id="L532" title="All 2 branches missed.">        for (PrometheusColumnDefinition myCol : theTable.getColumns()) {</span>
            /* Skip null and Id columns */
<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (myCol == null) {</span>
<span class="nc" id="L535">                continue;</span>
            }

            /* Access the column id */
<span class="nc" id="L539">            final MetisDataFieldId iField = myCol.getColumnId();</span>

            /* If the non-Id field has changed */
<span class="nc bnc" id="L542" title="All 2 branches missed.">            if (!MetisDataResource.DATA_ID.equals(myCol.getColumnId())</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">                    &amp;&amp; myCurr.fieldChanged(iField, myBase).isDifferent()) {</span>
                /* Record the change */
<span class="nc" id="L545">                isUpdated = true;</span>
<span class="nc" id="L546">                setFieldValue(pItem, iField);</span>
            }
<span class="nc" id="L548">        }</span>

        /* Return to caller */
<span class="nc" id="L551">        return isUpdated;</span>
    }

    /**
     * Delete items from the list.
     * @param pReport the report
     * @param pBatch the batch control
     * @throws OceanusException on error
     */
    protected void deleteItems(final TethysUIThreadStatusReport pReport,
                               final PrometheusBatchControl pBatch) throws OceanusException {
        /* Declare the new stage */
<span class="nc" id="L563">        pReport.setNewStage(&quot;Deleting &quot; + getTableName());</span>

        /* Protect the delete */
<span class="nc" id="L566">        T myCurr = null;</span>
        try {
            /* Declare the number of steps */
<span class="nc" id="L569">            int mySteps = countStateItems(MetisDataState.DELETED);</span>
<span class="nc" id="L570">            mySteps += countStateItems(MetisDataState.DELNEW);</span>
<span class="nc" id="L571">            pReport.setNumSteps(mySteps);</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">            if (mySteps == 0) {</span>
<span class="nc" id="L573">                return;</span>
            }

            /* Declare the table and mode */
<span class="nc" id="L577">            pBatch.setCurrentTable(this, MetisDataState.DELETED);</span>

            /* Prepare the delete statement */
<span class="nc" id="L580">            final String myDelete = theTable.getDeleteString();</span>
<span class="nc" id="L581">            prepareStatement(myDelete);</span>

            /* Access the iterator */
<span class="nc" id="L584">            final ListIterator&lt;T&gt; myIterator = theList.listIterator(theList.size());</span>

            /* Loop through the list in reverse order */
<span class="nc bnc" id="L587" title="All 2 branches missed.">            while (myIterator.hasPrevious()) {</span>
                /* Ignore non-deleted items */
<span class="nc" id="L589">                myCurr = myIterator.previous();</span>
<span class="nc" id="L590">                final MetisDataState myState = myCurr.getState();</span>
<span class="nc bnc" id="L591" title="All 4 branches missed.">                if ((myState != MetisDataState.DELETED)</span>
                        &amp;&amp; (myState != MetisDataState.DELNEW)) {
<span class="nc" id="L593">                    continue;</span>
                }

                /* Declare the item in the batch */
<span class="nc" id="L597">                pBatch.addBatchItem();</span>

                /* Ignore DelNew items as far as the database is concerned */
<span class="nc bnc" id="L600" title="All 2 branches missed.">                if (myState != MetisDataState.DELNEW) {</span>
                    /* Apply the id */
<span class="nc" id="L602">                    theTable.setIntegerValue(MetisDataResource.DATA_ID, myCurr.getIndexedId());</span>
<span class="nc" id="L603">                    theTable.updateValues(theStmt);</span>

                    /* Add to the statement batch */
<span class="nc" id="L606">                    addToBatch();</span>
                }

                /* If we have no further space in the batch */
<span class="nc bnc" id="L610" title="All 2 branches missed.">                if (pBatch.isFull()) {</span>
                    /* ExecuteBatch and commit the database */
<span class="nc" id="L612">                    executeBatch();</span>
<span class="nc" id="L613">                    commit();</span>

                    /* Commit the batch */
<span class="nc" id="L616">                    pBatch.commitItems();</span>
                }

                /* Report the progress */
<span class="nc" id="L620">                pReport.setNextStep();</span>
<span class="nc" id="L621">            }</span>

            /* Close the Statement */
<span class="nc" id="L624">            closeStmt();</span>

<span class="nc" id="L626">        } catch (SQLException e) {</span>
<span class="nc" id="L627">            throw new PrometheusDataException(myCurr, &quot;Failed to delete &quot; + getTableName(), e);</span>
<span class="nc" id="L628">        }</span>
<span class="nc" id="L629">    }</span>

    /**
     * Create the table.
     * @throws OceanusException on error
     */
    protected void createTable() throws OceanusException {
        /* Protect the create */
        try {
            /* Execute the create index statement */
<span class="nc" id="L639">            String myCreate = theTable.getCreateTableString();</span>
<span class="nc" id="L640">            executeStatement(myCreate);</span>

            /* If the table has an index */
<span class="nc bnc" id="L643" title="All 2 branches missed.">            if (theTable.isIndexed()) {</span>
                /* Prepare the create index statement */
<span class="nc" id="L645">                myCreate = theTable.getCreateIndexString();</span>
<span class="nc" id="L646">                executeStatement(myCreate);</span>
            }

<span class="nc" id="L649">        } catch (SQLException e) {</span>
<span class="nc" id="L650">            throw new PrometheusIOException(&quot;Failed to create &quot; + getTableName(), e);</span>
<span class="nc" id="L651">        }</span>
<span class="nc" id="L652">    }</span>

    /**
     * Create the database.
     * @param pDatabase the database name
     * @throws OceanusException on error
     */
    void createDatabase(final String pDatabase) throws OceanusException {
        /* Protect the statements */
        try {
            /* Execute the drop and create database statements */
<span class="nc" id="L663">            theConn.setAutoCommit(true);</span>
<span class="nc" id="L664">            final String myDrop = &quot;DROP DATABASE IF EXISTS &quot; + pDatabase;</span>
<span class="nc" id="L665">            prepareStatement(myDrop);</span>
<span class="nc" id="L666">            theStmt.execute();</span>
<span class="nc" id="L667">            theStmt.close();</span>
<span class="nc" id="L668">            final String myCreate = &quot;CREATE DATABASE &quot; + pDatabase;</span>
<span class="nc" id="L669">            prepareStatement(myCreate);</span>
<span class="nc" id="L670">            theStmt.execute();</span>
<span class="nc" id="L671">            theStmt.close();</span>
<span class="nc" id="L672">            theConn.setAutoCommit(false);</span>

<span class="nc" id="L674">        } catch (SQLException e) {</span>
<span class="nc" id="L675">            throw new PrometheusIOException(&quot;Failed to create database&quot;, e);</span>
<span class="nc" id="L676">        }</span>
<span class="nc" id="L677">    }</span>

    /**
     * Drop the table.
     * @throws OceanusException on error
     */
    protected void dropTable() throws OceanusException {
        /* Protect the drop */
        try {
            /* If we should drop the index */
<span class="nc" id="L687">            String myDrop = theTable.getDropIndexString();</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">            if (myDrop != null) {</span>
                /* Execute the drop index statement */
<span class="nc" id="L690">                executeStatement(myDrop);</span>
            }

            /* Execute the drop table statement */
<span class="nc" id="L694">            myDrop = theTable.getDropTableString();</span>
<span class="nc" id="L695">            executeStatement(myDrop);</span>

<span class="nc" id="L697">        } catch (SQLException e) {</span>
<span class="nc" id="L698">            throw new PrometheusIOException(&quot;Failed to drop &quot; + getTableName(), e);</span>
<span class="nc" id="L699">        }</span>
<span class="nc" id="L700">    }</span>

    /**
     * Truncate the table.
     * @throws OceanusException on error
     */
    protected void purgeTable() throws OceanusException {
        /* Protect the truncate */
        try {
            /* Execute the purge statement */
<span class="nc" id="L710">            final String myTrunc = theTable.getPurgeString();</span>
<span class="nc" id="L711">            executeStatement(myTrunc);</span>

<span class="nc" id="L713">        } catch (SQLException e) {</span>
<span class="nc" id="L714">            throw new PrometheusIOException(&quot;Failed to purge &quot; + getTableName(), e);</span>
<span class="nc" id="L715">        }</span>
<span class="nc" id="L716">    }</span>

    /**
     * Obtain row values.
     * @param pName the name of the item
     * @return the row values.
     * @throws OceanusException on error
     */
    protected PrometheusDataValues getRowValues(final String pName) throws OceanusException {
        /* Allocate the values */
<span class="nc" id="L726">        final PrometheusDataValues myValues = new PrometheusDataValues(pName);</span>

        /* Add the id and return the new values */
<span class="nc" id="L729">        myValues.addValue(MetisDataResource.DATA_ID, theTable.getIntegerValue(MetisDataResource.DATA_ID));</span>
<span class="nc" id="L730">        return myValues;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>