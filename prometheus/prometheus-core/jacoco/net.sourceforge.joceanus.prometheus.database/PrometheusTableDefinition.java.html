<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusTableDefinition.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.joceanus.prometheus.database</a> &gt; <span class="el_source">PrometheusTableDefinition.java</span></div><h1>PrometheusTableDefinition.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Prometheus: Application Framework
 * Copyright 2012,2025 Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package net.sourceforge.joceanus.prometheus.database;

import net.sourceforge.joceanus.gordianknot.util.GordianUtilities;
import net.sourceforge.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import net.sourceforge.joceanus.oceanus.base.OceanusException;
import net.sourceforge.joceanus.oceanus.date.OceanusDate;
import net.sourceforge.joceanus.oceanus.decimal.OceanusMoney;
import net.sourceforge.joceanus.oceanus.decimal.OceanusPrice;
import net.sourceforge.joceanus.oceanus.decimal.OceanusRate;
import net.sourceforge.joceanus.oceanus.decimal.OceanusRatio;
import net.sourceforge.joceanus.oceanus.decimal.OceanusUnits;
import net.sourceforge.joceanus.oceanus.format.OceanusDataFormatter;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusBinaryColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusBooleanColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusDateColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusIdColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusIntegerColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusLongColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusMoneyColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusPriceColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusRateColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusRatioColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusReferenceColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusStringColumn;
import net.sourceforge.joceanus.prometheus.database.PrometheusColumnDefinition.PrometheusUnitsColumn;
import net.sourceforge.joceanus.prometheus.exc.PrometheusLogicException;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * Database field definition class. Maps each dataType to a database field.
 */
public class PrometheusTableDefinition {
    /**
     * The index prefix.
     */
    private static final String PREFIX_INDEX = &quot;idx_&quot;;

    /**
     * The quote string.
     */
    protected static final String QUOTE_STRING = &quot;\&quot;&quot;;

    /**
     * The Descending string.
     */
    protected static final String STR_DESC = &quot; DESC&quot;;

    /**
     * The Buffer length.
     */
    private static final int BUFFER_LEN = 1000;

    /**
     * The Table name.
     */
    private final String theTableName;

    /**
     * The Database driver.
     */
    private final PrometheusJDBCDriver theDriver;

    /**
     * The Column Definitions.
     */
    private final List&lt;PrometheusColumnDefinition&gt; theList;

    /**
     * The Sort List.
     */
    private final List&lt;PrometheusColumnDefinition&gt; theSortList;

    /**
     * Are we sorting on a reference column.
     */
    private boolean sortOnReference;

    /**
     * The array list for the columns.
     */
    private final Map&lt;MetisDataFieldId, PrometheusColumnDefinition&gt; theMap;

    /**
     * The prepared statement for the insert/update.
     */
    private PreparedStatement theStatement;

    /**
     * Constructor.
     * @param pDriver the driver
     * @param pName the table name
     */
    protected PrometheusTableDefinition(final PrometheusJDBCDriver pDriver,
<span class="nc" id="L118">                                        final String pName) {</span>
        /* Record the name and driver */
<span class="nc" id="L120">        theTableName = pName;</span>
<span class="nc" id="L121">        theDriver = pDriver;</span>

        /* Create the column list */
<span class="nc" id="L124">        theList = new ArrayList&lt;&gt;();</span>

        /* Create the sort list */
<span class="nc" id="L127">        theSortList = new ArrayList&lt;&gt;();</span>

        /* Create the initial column map */
<span class="nc" id="L130">        theMap = new HashMap&lt;&gt;();</span>

        /* Add an Id column */
<span class="nc" id="L133">        theList.add(new PrometheusIdColumn(this));</span>
<span class="nc" id="L134">    }</span>

    /**
     * Obtain the table name.
     * @return the table name
     */
    protected String getTableName() {
<span class="nc" id="L141">        return theTableName;</span>
    }

    /**
     * Obtain the column map.
     * @return the map
     */
    protected Map&lt;MetisDataFieldId, PrometheusColumnDefinition&gt; getMap() {
<span class="nc" id="L149">        return theMap;</span>
    }

    /**
     * Is the table indexed.
     * @return true/false
     */
    protected boolean isIndexed() {
<span class="nc bnc" id="L157" title="All 2 branches missed.">        return !theSortList.isEmpty();</span>
    }

    /**
     * Column Definitions array.
     * @return the columns
     */
    protected List&lt;PrometheusColumnDefinition&gt; getColumns() {
<span class="nc" id="L165">        return theList;</span>
    }

    /**
     * Sort List.
     * @return the sort list
     */
    protected List&lt;PrometheusColumnDefinition&gt; getSortList() {
<span class="nc" id="L173">        return theSortList;</span>
    }

    /**
     * Obtain the driver.
     * @return the driver
     */
    protected PrometheusJDBCDriver getDriver() {
<span class="nc" id="L181">        return theDriver;</span>
    }

    /**
     * Note that we have a sort on reference.
     */
    protected void setSortOnReference() {
<span class="nc" id="L188">        sortOnReference = true;</span>
<span class="nc" id="L189">    }</span>

    /**
     * Add a reference column.
     * @param pId the column id
     * @param pRef the reference table
     * @return the reference column
     */
    public PrometheusReferenceColumn addReferenceColumn(final MetisDataFieldId pId,
                                                        final String pRef) {
        /* Create the new reference column */
<span class="nc" id="L200">        final PrometheusReferenceColumn myColumn = new PrometheusReferenceColumn(this, pId, pRef);</span>

        /* Add it to the list and return it */
<span class="nc" id="L203">        theList.add(myColumn);</span>
<span class="nc" id="L204">        return myColumn;</span>
    }

    /**
     * Add a reference column, which can be null.
     * @param pId the column id
     * @param pRef the reference table
     * @return the reference column
     */
    public PrometheusReferenceColumn addNullReferenceColumn(final MetisDataFieldId pId,
                                                            final String pRef) {
<span class="nc" id="L215">        final PrometheusReferenceColumn myColumn = addReferenceColumn(pId, pRef);</span>
<span class="nc" id="L216">        myColumn.setNullable();</span>
<span class="nc" id="L217">        return myColumn;</span>
    }

    /**
     * Add an integer column.
     * @param pId the column id
     * @return the integer column
     */
    public PrometheusIntegerColumn addIntegerColumn(final MetisDataFieldId pId) {
        /* Create the new integer column */
<span class="nc" id="L227">        final PrometheusIntegerColumn myColumn = new PrometheusIntegerColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L230">        theList.add(myColumn);</span>
<span class="nc" id="L231">        return myColumn;</span>
    }

    /**
     * Add an integer column, which can be null.
     * @param pId the column id
     * @return the integer column
     */
    public PrometheusIntegerColumn addNullIntegerColumn(final MetisDataFieldId pId) {
<span class="nc" id="L240">        final PrometheusIntegerColumn myColumn = addIntegerColumn(pId);</span>
<span class="nc" id="L241">        myColumn.setNullable();</span>
<span class="nc" id="L242">        return myColumn;</span>
    }

    /**
     * Add a long column.
     * @param pId the column id
     * @return the long column
     */
    public PrometheusLongColumn addLongColumn(final MetisDataFieldId pId) {
        /* Create the new long column */
<span class="nc" id="L252">        final PrometheusLongColumn myColumn = new PrometheusLongColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L255">        theList.add(myColumn);</span>
<span class="nc" id="L256">        return myColumn;</span>
    }

    /**
     * Add a long column, which can be null.
     * @param pId the column id
     * @return the long column
     */
    public PrometheusLongColumn addNullLongColumn(final MetisDataFieldId pId) {
<span class="nc" id="L265">        final PrometheusLongColumn myColumn = addLongColumn(pId);</span>
<span class="nc" id="L266">        myColumn.setNullable();</span>
<span class="nc" id="L267">        return myColumn;</span>
    }

    /**
     * Add a boolean column.
     * @param pId the column id
     * @return the boolean column
     */
    public PrometheusBooleanColumn addBooleanColumn(final MetisDataFieldId pId) {
        /* Create the new boolean column */
<span class="nc" id="L277">        final PrometheusBooleanColumn myColumn = new PrometheusBooleanColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L280">        theList.add(myColumn);</span>
<span class="nc" id="L281">        return myColumn;</span>
    }

    /**
     * Add a boolean column, which can be null.
     * @param pId the column id
     * @return the boolean column
     */
    public PrometheusBooleanColumn addNullBooleanColumn(final MetisDataFieldId pId) {
<span class="nc" id="L290">        final PrometheusBooleanColumn myColumn = addBooleanColumn(pId);</span>
<span class="nc" id="L291">        myColumn.setNullable();</span>
<span class="nc" id="L292">        return myColumn;</span>
    }

    /**
     * Add a date column.
     * @param pId the column id
     * @return the date column
     */
    public PrometheusDateColumn addDateColumn(final MetisDataFieldId pId) {
        /* Create the new date column */
<span class="nc" id="L302">        final PrometheusDateColumn myColumn = new PrometheusDateColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L305">        theList.add(myColumn);</span>
<span class="nc" id="L306">        return myColumn;</span>
    }

    /**
     * Add a date column, which can be null.
     * @param pId the column id
     * @return the date column
     */
    public PrometheusDateColumn addNullDateColumn(final MetisDataFieldId pId) {
<span class="nc" id="L315">        final PrometheusDateColumn myColumn = addDateColumn(pId);</span>
<span class="nc" id="L316">        myColumn.setNullable();</span>
<span class="nc" id="L317">        return myColumn;</span>
    }

    /**
     * Add a money column.
     * @param pId the column id
     * @return the money column
     */
    public PrometheusMoneyColumn addMoneyColumn(final MetisDataFieldId pId) {
        /* Create the new money column */
<span class="nc" id="L327">        final PrometheusMoneyColumn myColumn = new PrometheusMoneyColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L330">        theList.add(myColumn);</span>
<span class="nc" id="L331">        return myColumn;</span>
    }

    /**
     * Add a money column, which can be null.
     * @param pId the column id
     * @return the money column
     */
    public PrometheusMoneyColumn addNullMoneyColumn(final MetisDataFieldId pId) {
<span class="nc" id="L340">        final PrometheusMoneyColumn myColumn = addMoneyColumn(pId);</span>
<span class="nc" id="L341">        myColumn.setNullable();</span>
<span class="nc" id="L342">        return myColumn;</span>
    }

    /**
     * Add a rate column.
     * @param pId the column id
     * @return the rate column
     */
    public PrometheusRateColumn addRateColumn(final MetisDataFieldId pId) {
        /* Create the new rate column */
<span class="nc" id="L352">        final PrometheusRateColumn myColumn = new PrometheusRateColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L355">        theList.add(myColumn);</span>
<span class="nc" id="L356">        return myColumn;</span>
    }

    /**
     * Add a rate column, which can be null.
     * @param pId the column id
     * @return the rate column
     */
    public PrometheusRateColumn addNullRateColumn(final MetisDataFieldId pId) {
<span class="nc" id="L365">        final PrometheusRateColumn myColumn = addRateColumn(pId);</span>
<span class="nc" id="L366">        myColumn.setNullable();</span>
<span class="nc" id="L367">        return myColumn;</span>
    }

    /**
     * Add a rate column.
     * @param pId the column id
     * @return the rate column
     */
    public PrometheusRatioColumn addRatioColumn(final MetisDataFieldId pId) {
        /* Create the new rate column */
<span class="nc" id="L377">        final PrometheusRatioColumn myColumn = new PrometheusRatioColumn(this, pId);</span>

        /* Add it to the list and return it */
<span class="nc" id="L380">        theList.add(myColumn);</span>
<span class="nc" id="L381">        return myColumn;</span>
    }

    /**
     * Add a rate column, which can be null.
     * @param pId the column id
     * @return the rate column
     */
    public PrometheusRatioColumn addNullRatioColumn(final MetisDataFieldId pId) {
<span class="nc" id="L390">        final PrometheusRatioColumn myColumn = addRatioColumn(pId);</span>
<span class="nc" id="L391">        myColumn.setNullable();</span>
<span class="nc" id="L392">        return myColumn;</span>
    }

    /**
     * Add a binary column.
     * @param pId the column id
     * @param pLength the underlying (character) length
     * @return the binary column
     */
    public PrometheusBinaryColumn addBinaryColumn(final MetisDataFieldId pId,
                                                  final int pLength) {
        /* Create the new binary column */
<span class="nc" id="L404">        final PrometheusBinaryColumn myColumn = new PrometheusBinaryColumn(this, pId, pLength);</span>

        /* Add it to the list and return it */
<span class="nc" id="L407">        theList.add(myColumn);</span>
<span class="nc" id="L408">        return myColumn;</span>
    }

    /**
     * Add a binary column, which can be null.
     * @param pId the column id
     * @param pLength the underlying (character) length
     * @return the binary column
     */
    public PrometheusBinaryColumn addNullBinaryColumn(final MetisDataFieldId pId,
                                                      final int pLength) {
<span class="nc" id="L419">        final PrometheusBinaryColumn myColumn = addBinaryColumn(pId, pLength);</span>
<span class="nc" id="L420">        myColumn.setNullable();</span>
<span class="nc" id="L421">        return myColumn;</span>
    }

    /**
     * Add an encrypted column.
     * @param pId the column id
     * @param pLength the underlying (character) length
     * @return the binary column
     */
    public PrometheusBinaryColumn addEncryptedColumn(final MetisDataFieldId pId,
                                                     final int pLength) {
        /* Create the new binary column */
<span class="nc" id="L433">        final PrometheusBinaryColumn myColumn = new PrometheusBinaryColumn(this, pId, GordianUtilities.getKeySetEncryptionLength(pLength));</span>

        /* Add it to the list and return it */
<span class="nc" id="L436">        theList.add(myColumn);</span>
<span class="nc" id="L437">        return myColumn;</span>
    }

    /**
     * Add an encrypted column, which can be null.
     * @param pId the column id
     * @param pLength the underlying (character) length
     * @return the binary column
     */
    public PrometheusBinaryColumn addNullEncryptedColumn(final MetisDataFieldId pId,
                                                         final int pLength) {
<span class="nc" id="L448">        final PrometheusBinaryColumn myColumn = addEncryptedColumn(pId, pLength);</span>
<span class="nc" id="L449">        myColumn.setNullable();</span>
<span class="nc" id="L450">        return myColumn;</span>
    }

    /**
     * Add a string column.
     * @param pId the column id
     * @param pLength the character length
     * @return the binary column
     */
    public PrometheusStringColumn addStringColumn(final MetisDataFieldId pId,
                                                  final int pLength) {
        /* Create the new string column */
<span class="nc" id="L462">        final PrometheusStringColumn myColumn = new PrometheusStringColumn(this, pId, pLength);</span>

        /* Add it to the list and return it */
<span class="nc" id="L465">        theList.add(myColumn);</span>
<span class="nc" id="L466">        return myColumn;</span>
    }

    /**
     * Add a string column, which can be null.
     * @param pId the column id
     * @param pLength the character length
     * @return the binary column
     */
    public PrometheusStringColumn addNullStringColumn(final MetisDataFieldId pId,
                                                      final int pLength) {
<span class="nc" id="L477">        final PrometheusStringColumn myColumn = addStringColumn(pId, pLength);</span>
<span class="nc" id="L478">        myColumn.setNullable();</span>
<span class="nc" id="L479">        return myColumn;</span>
    }

    /**
     * Locate reference.
     * @param pTables the list of defined tables
     */
    protected void resolveReferences(final List&lt;PrometheusTableDataItem&lt;?&gt;&gt; pTables) {
        /* Create the iterator */
<span class="nc" id="L488">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>

        /* Loop through the columns */
<span class="nc bnc" id="L491" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L492">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc" id="L493">            myDef.locateReference(pTables);</span>
<span class="nc" id="L494">        }</span>
<span class="nc" id="L495">    }</span>

    /**
     * Load results.
     * @param pResults the result set
     * @throws SQLException on error
     */
    protected void loadResults(final ResultSet pResults) throws SQLException {
        /* clear values */
<span class="nc" id="L504">        clearValues();</span>

        /* Create the iterator */
<span class="nc" id="L507">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L508">        int myIndex = 1;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L511" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L512">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc" id="L513">            myDef.loadValue(pResults, myIndex++);</span>
<span class="nc" id="L514">        }</span>
<span class="nc" id="L515">    }</span>

    /**
     * Build column error string.
     * @param pCol the column definition.
     * @return the error string
     */
    private String getColumnError(final PrometheusColumnDefinition pCol) {
<span class="nc" id="L523">        return &quot;Column &quot; + pCol.getColumnName() + &quot; in table &quot; + theTableName;</span>
    }

    /**
     * Insert values.
     * @param pStmt the statement
     * @throws SQLException on error
     * @throws OceanusException on error
     */
    protected void insertValues(final PreparedStatement pStmt) throws SQLException, OceanusException {
        /* Store the Statement */
<span class="nc" id="L534">        theStatement = pStmt;</span>

        /* Create the iterator */
<span class="nc" id="L537">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L538">        int myIndex = 1;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L541" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L542">            final PrometheusColumnDefinition myDef = myIterator.next();</span>

            /* Reject if the value is not set */
<span class="nc bnc" id="L545" title="All 2 branches missed.">            if (!myDef.isValueSet()) {</span>
<span class="nc" id="L546">                throw new PrometheusLogicException(getColumnError(myDef) + &quot; has no value for insert&quot;);</span>
            }

<span class="nc" id="L549">            myDef.storeValue(theStatement, myIndex++);</span>
<span class="nc" id="L550">        }</span>
<span class="nc" id="L551">    }</span>

    /**
     * Update values.
     * @param pStmt the statement
     * @throws SQLException on error
     */
    protected void updateValues(final PreparedStatement pStmt) throws SQLException {
<span class="nc" id="L559">        PrometheusColumnDefinition myId = null;</span>

        /* Store the Statement */
<span class="nc" id="L562">        theStatement = pStmt;</span>

        /* Create the iterator */
<span class="nc" id="L565">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L566">        int myIndex = 1;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L569" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L570">            final PrometheusColumnDefinition myDef = myIterator.next();</span>

            /* If this is the Id record */
<span class="nc bnc" id="L573" title="All 2 branches missed.">            if (myDef instanceof PrometheusIdColumn) {</span>
                /* Remember the column */
<span class="nc" id="L575">                myId = myDef;</span>

                /* Store value if it has been set */
<span class="nc bnc" id="L578" title="All 2 branches missed.">            } else if (myDef.isValueSet()) {</span>
<span class="nc" id="L579">                myDef.storeValue(theStatement, myIndex++);</span>
            }
<span class="nc" id="L581">        }</span>

        /* Store the Id */
<span class="nc bnc" id="L584" title="All 2 branches missed.">        if (myId != null) {</span>
<span class="nc" id="L585">            myId.storeValue(theStatement, myIndex);</span>
        }
<span class="nc" id="L587">    }</span>

    /**
     * Clear values for table.
     */
    protected void clearValues() {
        /* Loop over the Column Definitions */
<span class="nc bnc" id="L594" title="All 2 branches missed.">        for (PrometheusColumnDefinition myDef : theList) {</span>
            /* Clear value */
<span class="nc" id="L596">            myDef.clearValue();</span>
<span class="nc" id="L597">        }</span>
<span class="nc" id="L598">    }</span>

    /**
     * Get Integer value for column.
     * @param pId the column id
     * @return the integer value
     * @throws OceanusException on error
     */
    public Integer getIntegerValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L608">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not an integer column */
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusIntegerColumn)) {</span>
<span class="nc" id="L612">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Integer type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L616">        final PrometheusIntegerColumn myIntCol = (PrometheusIntegerColumn) myCol;</span>
<span class="nc" id="L617">        return myIntCol.getValue();</span>
    }

    /**
     * Get Long value for column.
     * @param pId the column id
     * @return the long value
     * @throws OceanusException on error
     */
    public Long getLongValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L628">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a long column */
<span class="nc bnc" id="L631" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusLongColumn)) {</span>
<span class="nc" id="L632">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Long type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L636">        final PrometheusLongColumn myLongCol = (PrometheusLongColumn) myCol;</span>
<span class="nc" id="L637">        return myLongCol.getValue();</span>
    }

    /**
     * Get Date value for column.
     * @param pId the column id
     * @return the Date value
     * @throws OceanusException on error
     */
    public OceanusDate getDateValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L648">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a date column */
<span class="nc bnc" id="L651" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusDateColumn)) {</span>
<span class="nc" id="L652">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Date type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L656">        final PrometheusDateColumn myDateCol = (PrometheusDateColumn) myCol;</span>
<span class="nc" id="L657">        return myDateCol.getValue();</span>
    }

    /**
     * Get Boolean value for column.
     * @param pId the column id
     * @return the boolean value
     * @throws OceanusException on error
     */
    public Boolean getBooleanValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L668">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a boolean column */
<span class="nc bnc" id="L671" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusBooleanColumn)) {</span>
<span class="nc" id="L672">            throw new PrometheusLogicException(&quot;Column &quot; + getColumnError(myCol) + &quot; is not Boolean type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L676">        final PrometheusBooleanColumn myBoolCol = (PrometheusBooleanColumn) myCol;</span>
<span class="nc" id="L677">        return myBoolCol.getValue();</span>
    }

    /**
     * Get String value for column.
     * @param pId the column id
     * @return the String value
     * @throws OceanusException on error
     */
    public String getStringValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L688">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a string column */
<span class="nc bnc" id="L691" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusStringColumn)) {</span>
<span class="nc" id="L692">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not String type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L696">        final PrometheusStringColumn myStringCol = (PrometheusStringColumn) myCol;</span>
<span class="nc" id="L697">        return myStringCol.getValue();</span>
    }

    /**
     * Get Money value for column.
     * @param pId the column id
     * @param pFormatter the data formatter
     * @return the Money value
     * @throws OceanusException on error
     */
    public OceanusMoney getMoneyValue(final MetisDataFieldId pId,
                                      final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L710">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a money column */
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusMoneyColumn)) {</span>
<span class="nc" id="L714">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not money type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L718">        final PrometheusMoneyColumn myMoneyCol = (PrometheusMoneyColumn) myCol;</span>
<span class="nc" id="L719">        return myMoneyCol.getValue(pFormatter);</span>
    }

    /**
     * Get Price value for column.
     * @param pId the column id
     * @param pFormatter the data formatter
     * @return the price value
     * @throws OceanusException on error
     */
    public OceanusPrice getPriceValue(final MetisDataFieldId pId,
                                      final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L732">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a price column */
<span class="nc bnc" id="L735" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusPriceColumn)) {</span>
<span class="nc" id="L736">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Price type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L740">        final PrometheusPriceColumn myPriceCol = (PrometheusPriceColumn) myCol;</span>
<span class="nc" id="L741">        return myPriceCol.getValue(pFormatter);</span>
    }

    /**
     * Get Rate value for column.
     * @param pId the column id
     * @param pFormatter the data formatter
     * @return the rate value
     * @throws OceanusException on error
     */
    public OceanusRate getRateValue(final MetisDataFieldId pId,
                                    final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L754">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a rate column */
<span class="nc bnc" id="L757" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusRateColumn)) {</span>
<span class="nc" id="L758">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Rate type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L762">        final PrometheusRateColumn myRateCol = (PrometheusRateColumn) myCol;</span>
<span class="nc" id="L763">        return myRateCol.getValue(pFormatter);</span>
    }

    /**
     * Get Units value for column.
     * @param pId the column id
     * @param pFormatter the data formatter
     * @return the Units value
     * @throws OceanusException on error
     */
    public OceanusUnits getUnitsValue(final MetisDataFieldId pId,
                                      final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L776">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a units column */
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusUnitsColumn)) {</span>
<span class="nc" id="L780">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Units type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L784">        final PrometheusUnitsColumn myUnitsCol = (PrometheusUnitsColumn) myCol;</span>
<span class="nc" id="L785">        return myUnitsCol.getValue(pFormatter);</span>
    }

    /**
     * Get Ratio value for column.
     * @param pId the column id
     * @param pFormatter the data formatter
     * @return the Ratio value
     * @throws OceanusException on error
     */
    public OceanusRatio getRatioValue(final MetisDataFieldId pId,
                                      final OceanusDataFormatter pFormatter) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L798">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a ratio column */
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusRatioColumn)) {</span>
<span class="nc" id="L802">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Ratio type&quot;);</span>
        }

        /* Access the value */
<span class="nc" id="L806">        final PrometheusRatioColumn myRatioCol = (PrometheusRatioColumn) myCol;</span>
<span class="nc" id="L807">        return myRatioCol.getValue(pFormatter);</span>
    }

    /**
     * Get Binary value for column.
     * @param pId the column id
     * @return the binary value
     * @throws OceanusException on error
     */
    public byte[] getBinaryValue(final MetisDataFieldId pId) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L818">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a string column */
<span class="nc bnc" id="L821" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusBinaryColumn)) {</span>
<span class="nc" id="L822">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Binary type&quot;);</span>
        }

        /* Return the value */
<span class="nc" id="L826">        final PrometheusBinaryColumn myBinaryCol = (PrometheusBinaryColumn) myCol;</span>
<span class="nc" id="L827">        return myBinaryCol.getValue();</span>
    }

    /**
     * Set Integer value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setIntegerValue(final MetisDataFieldId pId,
                                final Integer pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L839">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not an integer column */
<span class="nc bnc" id="L842" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusIntegerColumn)) {</span>
<span class="nc" id="L843">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Integer type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L847">        final PrometheusIntegerColumn myIntCol = (PrometheusIntegerColumn) myCol;</span>
<span class="nc" id="L848">        myIntCol.setValue(pValue);</span>
<span class="nc" id="L849">    }</span>

    /**
     * Set Long value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setLongValue(final MetisDataFieldId pId,
                             final Long pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L860">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a long column */
<span class="nc bnc" id="L863" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusLongColumn)) {</span>
<span class="nc" id="L864">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Long type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L868">        final PrometheusLongColumn myLongCol = (PrometheusLongColumn) myCol;</span>
<span class="nc" id="L869">        myLongCol.setValue(pValue);</span>
<span class="nc" id="L870">    }</span>

    /**
     * Set Boolean value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setBooleanValue(final MetisDataFieldId pId,
                                final Boolean pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L881">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a boolean column */
<span class="nc bnc" id="L884" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusBooleanColumn)) {</span>
<span class="nc" id="L885">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Boolean type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L889">        final PrometheusBooleanColumn myBoolCol = (PrometheusBooleanColumn) myCol;</span>
<span class="nc" id="L890">        myBoolCol.setValue(pValue);</span>
<span class="nc" id="L891">    }</span>

    /**
     * Set Date value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setDateValue(final MetisDataFieldId pId,
                             final OceanusDate pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L902">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a Date column */
<span class="nc bnc" id="L905" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusDateColumn)) {</span>
<span class="nc" id="L906">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Date type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L910">        final PrometheusDateColumn myDateCol = (PrometheusDateColumn) myCol;</span>
<span class="nc" id="L911">        myDateCol.setValue(pValue);</span>
<span class="nc" id="L912">    }</span>

    /**
     * Set String value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setStringValue(final MetisDataFieldId pId,
                               final String pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L923">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a string column */
<span class="nc bnc" id="L926" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusStringColumn)) {</span>
<span class="nc" id="L927">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not String type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L931">        final PrometheusStringColumn myStringCol = (PrometheusStringColumn) myCol;</span>
<span class="nc" id="L932">        myStringCol.setValue(pValue);</span>
<span class="nc" id="L933">    }</span>

    /**
     * Set Binary value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setBinaryValue(final MetisDataFieldId pId,
                               final byte[] pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L944">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a binary column */
<span class="nc bnc" id="L947" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusBinaryColumn)) {</span>
<span class="nc" id="L948">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Binary type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L952">        final PrometheusBinaryColumn myBinaryCol = (PrometheusBinaryColumn) myCol;</span>
<span class="nc" id="L953">        myBinaryCol.setValue(pValue);</span>
<span class="nc" id="L954">    }</span>

    /**
     * Set Money value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setMoneyValue(final MetisDataFieldId pId,
                              final OceanusMoney pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L965">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a money column */
<span class="nc bnc" id="L968" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusMoneyColumn)) {</span>
<span class="nc" id="L969">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Money type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L973">        final PrometheusMoneyColumn myMoneyCol = (PrometheusMoneyColumn) myCol;</span>
<span class="nc" id="L974">        myMoneyCol.setValue(pValue);</span>
<span class="nc" id="L975">    }</span>

    /**
     * Set Rate value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setRateValue(final MetisDataFieldId pId,
                             final OceanusRate pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L986">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a rate column */
<span class="nc bnc" id="L989" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusRateColumn)) {</span>
<span class="nc" id="L990">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Rate type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L994">        final PrometheusRateColumn myRateCol = (PrometheusRateColumn) myCol;</span>
<span class="nc" id="L995">        myRateCol.setValue(pValue);</span>
<span class="nc" id="L996">    }</span>

    /**
     * Set Ratio value for column.
     * @param pId the column id
     * @param pValue the value
     * @throws OceanusException on error
     */
    public void setRatioValue(final MetisDataFieldId pId,
                              final OceanusRatio pValue) throws OceanusException {
        /* Obtain the correct id */
<span class="nc" id="L1007">        final PrometheusColumnDefinition myCol = getColumnForId(pId);</span>

        /* Reject if this is not a ratio column */
<span class="nc bnc" id="L1010" title="All 2 branches missed.">        if (!(myCol instanceof PrometheusRatioColumn)) {</span>
<span class="nc" id="L1011">            throw new PrometheusLogicException(getColumnError(myCol) + &quot; is not Ratio type&quot;);</span>
        }

        /* Set the value */
<span class="nc" id="L1015">        final PrometheusRatioColumn myRatioCol = (PrometheusRatioColumn) myCol;</span>
<span class="nc" id="L1016">        myRatioCol.setValue(pValue);</span>
<span class="nc" id="L1017">    }</span>

    /**
     * Locate column for id.
     * @param pId the id of the column
     * @return the column
     * @throws OceanusException on error
     */
    private PrometheusColumnDefinition getColumnForId(final MetisDataFieldId pId) throws OceanusException {
        /* Access the definition */
<span class="nc" id="L1027">        final PrometheusColumnDefinition myDef = theMap.get(pId);</span>

        /* Check that the id is in range and present */
<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (myDef == null) {</span>
<span class="nc" id="L1031">            throw new PrometheusLogicException(&quot;Invalid Column Id: &quot; + pId + &quot; for &quot; + theTableName);</span>
        }

        /* Return the column definition */
<span class="nc" id="L1035">        return myDef;</span>
    }

    /**
     * Build the create table string for the table.
     * @return the SQL string
     */
    protected String getCreateTableString() {
<span class="nc" id="L1043">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial create */
<span class="nc" id="L1046">        myBuilder.append(&quot;create table &quot;);</span>
<span class="nc" id="L1047">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1048">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1049">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1050">        myBuilder.append(&quot; (&quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1053">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L1054">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1057" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1058">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1060">                myBuilder.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L1062">            myDef.buildCreateString(myBuilder);</span>
<span class="nc" id="L1063">            myFirst = false;</span>
<span class="nc" id="L1064">        }</span>

        /* Close the statement and return it */
<span class="nc" id="L1067">        myBuilder.append(')');</span>
<span class="nc" id="L1068">        return myBuilder.toString();</span>
    }

    /**
     * Build the create index string for the table.
     * @return the SQL string
     */
    protected String getCreateIndexString() {
<span class="nc" id="L1076">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Return null if we are not indexed */
<span class="nc bnc" id="L1079" title="All 2 branches missed.">        if (!isIndexed()) {</span>
<span class="nc" id="L1080">            return null;</span>
        }

        /* Build the initial create */
<span class="nc" id="L1084">        myBuilder.append(&quot;create index &quot;);</span>
<span class="nc" id="L1085">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1086">        myBuilder.append(PREFIX_INDEX);</span>
<span class="nc" id="L1087">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1088">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1089">        myBuilder.append(&quot; on &quot;);</span>
<span class="nc" id="L1090">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1091">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1092">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1093">        myBuilder.append(&quot; (&quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1096">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theSortList.iterator();</span>
<span class="nc" id="L1097">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1100" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1101">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1103">                myBuilder.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L1105">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1106">            myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1107">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1108" title="All 2 branches missed.">            if (myDef.getSortOrder() == PrometheusSortOrder.DESCENDING) {</span>
<span class="nc" id="L1109">                myBuilder.append(STR_DESC);</span>
            }
<span class="nc" id="L1111">            myFirst = false;</span>
<span class="nc" id="L1112">        }</span>

        /* Close the statement and return it */
<span class="nc" id="L1115">        myBuilder.append(')');</span>
<span class="nc" id="L1116">        return myBuilder.toString();</span>
    }

    /**
     * Build the drop table string for the table.
     * @return the SQL string
     */
    protected String getDropTableString() {
<span class="nc" id="L1124">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>
<span class="nc" id="L1125">        myBuilder.append(&quot;drop table if exists &quot;);</span>
<span class="nc" id="L1126">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1127">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1128">        addQuoteIfAllowed(myBuilder);</span>

        /* Return the command */
<span class="nc" id="L1131">        return myBuilder.toString();</span>
    }

    /**
     * Build the drop index string for the table.
     * @return the SQL string
     */
    protected String getDropIndexString() {
        /* Return null if we are not indexed */
<span class="nc bnc" id="L1140" title="All 4 branches missed.">        if (!isIndexed() || !theDriver.explicitDropIndex()) {</span>
<span class="nc" id="L1141">            return null;</span>
        }

        /* Build the drop command */
<span class="nc" id="L1145">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>
<span class="nc" id="L1146">        myBuilder.append(&quot;drop index if exists &quot;);</span>
<span class="nc" id="L1147">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1148">        myBuilder.append(PREFIX_INDEX);</span>
<span class="nc" id="L1149">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1150">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">        if (!PrometheusJDBCDriver.POSTGRESQL.equals(theDriver)) {</span>
<span class="nc" id="L1152">            myBuilder.append(&quot; on &quot;);</span>
<span class="nc" id="L1153">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1154">            myBuilder.append(theTableName);</span>
<span class="nc" id="L1155">            addQuoteIfAllowed(myBuilder);</span>
        }

        /* Return the command */
<span class="nc" id="L1159">        return myBuilder.toString();</span>
    }

    /**
     * Build the load string for a list of columns.
     * @return the SQL string
     */
    protected String getLoadString() {
<span class="nc" id="L1167">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial select */
<span class="nc" id="L1170">        myBuilder.append(&quot;select &quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1173">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L1174">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1177" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1178">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1180">                myBuilder.append(&quot;, &quot;);</span>
            }
<span class="nc bnc" id="L1182" title="All 2 branches missed.">            if (sortOnReference) {</span>
<span class="nc" id="L1183">                myBuilder.append(&quot;a.&quot;);</span>
            }
<span class="nc" id="L1185">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1186">            myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1187">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1188">            myFirst = false;</span>
<span class="nc" id="L1189">        }</span>

        /* Close the statement */
<span class="nc" id="L1192">        myBuilder.append(&quot; from &quot;);</span>
<span class="nc" id="L1193">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1194">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1195">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">        if (sortOnReference) {</span>
<span class="nc" id="L1197">            myBuilder.append(&quot; a&quot;);</span>
        }

        /* If we are indexed */
<span class="nc bnc" id="L1201" title="All 2 branches missed.">        if (isIndexed()) {</span>
            /* Add Joins */
<span class="nc bnc" id="L1203" title="All 2 branches missed.">            if (sortOnReference) {</span>
<span class="nc" id="L1204">                myBuilder.append(getJoinString('a', 1));</span>
            }

            /* Add the order clause */
<span class="nc" id="L1208">            myBuilder.append(&quot; order by &quot;);</span>

            /* Build the order string */
<span class="nc" id="L1211">            myBuilder.append(getOrderString('a', 0));</span>
        }

<span class="nc" id="L1214">        return myBuilder.toString();</span>
    }

    /**
     * Build the Join string for the list of columns.
     * @param pChar the character for this table
     * @param pOffset the join offset
     * @return the SQL string
     */
    protected String getJoinString(final char pChar,
                                   final Integer pOffset) {
        /* Loop through the columns */
<span class="nc" id="L1226">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">        for (PrometheusColumnDefinition myDef : theSortList) {</span>
            /* Access next column and skip if not reference column */
<span class="nc bnc" id="L1229" title="All 2 branches missed.">            if (!(myDef instanceof PrometheusReferenceColumn)) {</span>
<span class="nc" id="L1230">                continue;</span>
            }

            /* Add the join */
<span class="nc" id="L1234">            final PrometheusReferenceColumn myCol = (PrometheusReferenceColumn) myDef;</span>
<span class="nc" id="L1235">            myCol.buildJoinString(myBuilder, pChar, pOffset);</span>
<span class="nc" id="L1236">        }</span>

<span class="nc" id="L1238">        return myBuilder.toString();</span>
    }

    /**
     * Build the Order string for the list of columns.
     * @param pChar the character for this table
     * @param pOffset the join offset
     * @return the SQL string
     */
    protected String getOrderString(final char pChar,
                                    final Integer pOffset) {
<span class="nc" id="L1249">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Create the iterator */
<span class="nc" id="L1252">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theSortList.iterator();</span>
<span class="nc" id="L1253">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1256" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1257">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
            /* Handle secondary columns */
<span class="nc bnc" id="L1259" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1260">                myBuilder.append(&quot;, &quot;);</span>
            }

            /* If we are using prefixes */
<span class="nc bnc" id="L1264" title="All 4 branches missed.">            if (sortOnReference || pChar &gt; 'a') {</span>
                /* If this is a reference column */
<span class="nc bnc" id="L1266" title="All 2 branches missed.">                if (myDef instanceof PrometheusReferenceColumn myCol) {</span>
                    /* Handle Reference column */
<span class="nc" id="L1268">                    myCol.buildOrderString(myBuilder, pOffset + 1);</span>
                } else {
                    /* Handle standard column with prefix */
<span class="nc" id="L1271">                    myBuilder.append(pChar);</span>
<span class="nc" id="L1272">                    myBuilder.append(&quot;.&quot;);</span>
<span class="nc" id="L1273">                    addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1274">                    myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1275">                    addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">                    if (myDef.getSortOrder() == PrometheusSortOrder.DESCENDING) {</span>
<span class="nc" id="L1277">                        myBuilder.append(STR_DESC);</span>
                    }
                }
            } else {
                /* Handle standard column */
<span class="nc" id="L1282">                addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1283">                myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1284">                addQuoteIfAllowed(myBuilder);</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">                if (myDef.getSortOrder() == PrometheusSortOrder.DESCENDING) {</span>
<span class="nc" id="L1286">                    myBuilder.append(STR_DESC);</span>
                }
            }

            /* Note secondary columns */
<span class="nc" id="L1291">            myFirst = false;</span>
<span class="nc" id="L1292">        }</span>

<span class="nc" id="L1294">        return myBuilder.toString();</span>
    }

    /**
     * Build the insert string for a list of columns.
     * @return the SQL string
     */
    protected String getInsertString() {
<span class="nc" id="L1302">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>
<span class="nc" id="L1303">        final StringBuilder myValues = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial insert */
<span class="nc" id="L1306">        myBuilder.append(&quot;insert into &quot;);</span>
<span class="nc" id="L1307">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1308">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1309">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1310">        myBuilder.append(&quot; (&quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1313">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L1314">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1317" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1318">            final PrometheusColumnDefinition myDef = myIterator.next();</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">            if (!myFirst) {</span>
<span class="nc" id="L1320">                myBuilder.append(&quot;, &quot;);</span>
<span class="nc" id="L1321">                myValues.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L1323">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1324">            myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1325">            addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1326">            myValues.append('?');</span>
<span class="nc" id="L1327">            myFirst = false;</span>
<span class="nc" id="L1328">        }</span>

        /* Close the statement and return it */
<span class="nc" id="L1331">        myBuilder.append(&quot;) values(&quot;);</span>
<span class="nc" id="L1332">        myBuilder.append(myValues);</span>
<span class="nc" id="L1333">        myBuilder.append(')');</span>
<span class="nc" id="L1334">        return myBuilder.toString();</span>
    }

    /**
     * Build the update string for a list of columns.
     * @return the SQL string
     * @throws OceanusException on error
     */
    protected String getUpdateString() throws OceanusException {
<span class="nc" id="L1343">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial update */
<span class="nc" id="L1346">        myBuilder.append(&quot;update &quot;);</span>
<span class="nc" id="L1347">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1348">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1349">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1350">        myBuilder.append(&quot; set &quot;);</span>

        /* Create the iterator */
<span class="nc" id="L1353">        final Iterator&lt;PrometheusColumnDefinition&gt; myIterator = theList.iterator();</span>
<span class="nc" id="L1354">        PrometheusColumnDefinition myId = null;</span>
<span class="nc" id="L1355">        boolean myFirst = true;</span>

        /* Loop through the columns */
<span class="nc bnc" id="L1358" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L1359">            final PrometheusColumnDefinition myDef = myIterator.next();</span>

            /* If this is the Id record */
<span class="nc bnc" id="L1362" title="All 2 branches missed.">            if (myDef instanceof PrometheusIdColumn) {</span>
                /* Reject if the value is not set */
<span class="nc bnc" id="L1364" title="All 2 branches missed.">                if (!myDef.isValueSet()) {</span>
<span class="nc" id="L1365">                    throw new PrometheusLogicException(getColumnError(myDef) + &quot; has no value for update&quot;);</span>
                }

                /* Remember the column */
<span class="nc" id="L1369">                myId = myDef;</span>

                /* If this column is to be updated */
<span class="nc bnc" id="L1372" title="All 2 branches missed.">            } else if (myDef.isValueSet()) {</span>
                /* Add the update of this column */
<span class="nc bnc" id="L1374" title="All 2 branches missed.">                if (!myFirst) {</span>
<span class="nc" id="L1375">                    myBuilder.append(&quot;, &quot;);</span>
                }
<span class="nc" id="L1377">                addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1378">                myBuilder.append(myDef.getColumnName());</span>
<span class="nc" id="L1379">                addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1380">                myBuilder.append(&quot;=?&quot;);</span>
<span class="nc" id="L1381">                myFirst = false;</span>
            }
<span class="nc" id="L1383">        }</span>

        /* If we have no values then just return null */
<span class="nc bnc" id="L1386" title="All 4 branches missed.">        if (myFirst || myId == null) {</span>
<span class="nc" id="L1387">            return null;</span>
        }

        /* Close the statement and return it */
<span class="nc" id="L1391">        myBuilder.append(&quot; where &quot;);</span>
<span class="nc" id="L1392">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1393">        myBuilder.append(myId.getColumnName());</span>
<span class="nc" id="L1394">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1395">        myBuilder.append(&quot;=?&quot;);</span>
<span class="nc" id="L1396">        return myBuilder.toString();</span>
    }

    /**
     * Build the delete string for a table.
     * @return the SQL string
     */
    protected String getDeleteString() {
<span class="nc" id="L1404">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial delete */
<span class="nc" id="L1407">        myBuilder.append(&quot;delete from &quot;);</span>
<span class="nc" id="L1408">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1409">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1410">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1411">        myBuilder.append(&quot; where &quot;);</span>

        /* Access the id definition */
<span class="nc" id="L1414">        final PrometheusColumnDefinition myId = theList.get(0);</span>

        /* Build the rest of the command */
<span class="nc" id="L1417">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1418">       myBuilder.append(myId.getColumnName());</span>
<span class="nc" id="L1419">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1420">        myBuilder.append(&quot;=?&quot;);</span>
<span class="nc" id="L1421">        return myBuilder.toString();</span>
    }

    /**
     * Build the purge string for a table.
     * @return the SQL string
     */
    protected String getPurgeString() {
<span class="nc" id="L1429">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial delete */
<span class="nc" id="L1432">        myBuilder.append(&quot;delete from &quot;);</span>
<span class="nc" id="L1433">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1434">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1435">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1436">        return myBuilder.toString();</span>
    }

    /**
     * Build the count string for a table.
     * @return the SQL string
     */
    protected String getCountString() {
<span class="nc" id="L1444">        final StringBuilder myBuilder = new StringBuilder(BUFFER_LEN);</span>

        /* Build the initial delete */
<span class="nc" id="L1447">        myBuilder.append(&quot;select count(*) from &quot;);</span>
<span class="nc" id="L1448">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1449">        myBuilder.append(theTableName);</span>
<span class="nc" id="L1450">        addQuoteIfAllowed(myBuilder);</span>
<span class="nc" id="L1451">        return myBuilder.toString();</span>
    }

    /**
     * Add quote if necessary.
     * @param pBuilder the builder
     */
    void addQuoteIfAllowed(final StringBuilder pBuilder) {
<span class="nc bnc" id="L1459" title="All 2 branches missed.">        if (theDriver.useQuotes()) {</span>
<span class="nc" id="L1460">            pBuilder.append(QUOTE_STRING);</span>
        }
<span class="nc" id="L1462">    }</span>

    /**
     * SortOrder.
     */
<span class="nc" id="L1467">    public enum PrometheusSortOrder {</span>
        /**
         * Ascending.
         */
<span class="nc" id="L1471">        ASCENDING,</span>

        /**
         * Descending.
         */
<span class="nc" id="L1476">        DESCENDING;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>