<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusDataValuesFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.prometheus.data</a> &gt; <span class="el_source">PrometheusDataValuesFormatter.java</span></div><h1>PrometheusDataValuesFormatter.java</h1><pre class="source lang-java linenums">/*
 * Prometheus: Application Framework
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.prometheus.data;

import io.github.tonywasher.joceanus.gordianknot.api.base.GordianException;
import io.github.tonywasher.joceanus.gordianknot.api.factory.GordianFactory.GordianFactoryLock;
import io.github.tonywasher.joceanus.gordianknot.api.zip.GordianZipFactory;
import io.github.tonywasher.joceanus.gordianknot.api.zip.GordianZipFileContents;
import io.github.tonywasher.joceanus.gordianknot.api.zip.GordianZipFileEntry;
import io.github.tonywasher.joceanus.gordianknot.api.zip.GordianZipLock;
import io.github.tonywasher.joceanus.gordianknot.api.zip.GordianZipReadFile;
import io.github.tonywasher.joceanus.gordianknot.api.zip.GordianZipWriteFile;
import io.github.tonywasher.joceanus.metis.data.MetisDataDifference;
import io.github.tonywasher.joceanus.metis.field.MetisFieldItem.MetisFieldSetDef;
import io.github.tonywasher.joceanus.metis.list.MetisListKey;
import io.github.tonywasher.joceanus.metis.toolkit.MetisToolkit;
import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.format.OceanusDataFormatter;
import io.github.tonywasher.joceanus.oceanus.profile.OceanusProfile;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataValues.PrometheusGroupedItem;
import io.github.tonywasher.joceanus.prometheus.exc.PrometheusDataException;
import io.github.tonywasher.joceanus.prometheus.exc.PrometheusIOException;
import io.github.tonywasher.joceanus.prometheus.exc.PrometheusSecurityException;
import io.github.tonywasher.joceanus.prometheus.security.PrometheusSecurityPasswordManager;
import io.github.tonywasher.joceanus.tethys.api.thread.TethysUIThreadStatusReport;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.xml.sax.SAXException;

import javax.xml.XMLConstants;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.Iterator;

/**
 * Formatter/Parser class for DataValues.
 */
public class PrometheusDataValuesFormatter {
    /**
     * Entry suffix.
     */
    private static final String SUFFIX_ENTRY = &quot;.xml&quot;;

    /**
     * Error text.
     */
    private static final String ERROR_BACKUP = &quot;Failed to create backup XML&quot;;

    /**
     * The report.
     */
    private final TethysUIThreadStatusReport theReport;

    /**
     * The password manager.
     */
    private final PrometheusSecurityPasswordManager thePasswordMgr;

    /**
     * The document builder.
     */
    private final DocumentBuilder theBuilder;

    /**
     * The transformer.
     */
    private final Transformer theXformer;

    /**
     * The Data version.
     */
    private Integer theVersion;

    /**
     * Constructor.
     *
     * @param pReport      the report
     * @param pPasswordMgr the password manager
     * @throws PrometheusIOException on error
     */
    public PrometheusDataValuesFormatter(final TethysUIThreadStatusReport pReport,
<span class="nc" id="L110">                                         final PrometheusSecurityPasswordManager pPasswordMgr) throws PrometheusIOException {</span>
        /* Store values */
<span class="nc" id="L112">        theReport = pReport;</span>
<span class="nc" id="L113">        thePasswordMgr = pPasswordMgr;</span>

        /* protect against exceptions */
        try {
            /* Create a Document builder */
<span class="nc" id="L118">            final DocumentBuilderFactory myFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L119">            myFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>
<span class="nc" id="L120">            myFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, &quot;&quot;);</span>
<span class="nc" id="L121">            myFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, &quot;&quot;);</span>
<span class="nc" id="L122">            theBuilder = myFactory.newDocumentBuilder();</span>

            /* Create the transformer */
<span class="nc" id="L125">            final TransformerFactory myXformFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L126">            myXformFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>
<span class="nc" id="L127">            myXformFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, &quot;&quot;);</span>
<span class="nc" id="L128">            myXformFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, &quot;&quot;);</span>
<span class="nc" id="L129">            theXformer = myXformFactory.newTransformer();</span>

<span class="nc" id="L131">        } catch (ParserConfigurationException | TransformerConfigurationException e) {</span>
<span class="nc" id="L132">            throw new PrometheusIOException(&quot;Failed to initialise parser&quot;, e);</span>
<span class="nc" id="L133">        }</span>
<span class="nc" id="L134">    }</span>

    /**
     * Create a Backup ZipFile.
     *
     * @param pData Data to write out
     * @param pFile the backup file to write to
     * @throws OceanusException on error
     */
    public void createBackup(final PrometheusDataSet pData,
                             final File pFile) throws OceanusException {
<span class="nc" id="L145">        boolean writeFailed = false;</span>
        try {
<span class="nc" id="L147">            createBackup(pData, new FileOutputStream(pFile));</span>
<span class="nc" id="L148">        } catch (IOException</span>
                 | OceanusException e) {
<span class="nc" id="L150">            writeFailed = true;</span>
<span class="nc" id="L151">            throw new PrometheusIOException(ERROR_BACKUP, e);</span>
        } finally {
            /* Try to delete the file if required */
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (writeFailed) {</span>
<span class="nc" id="L155">                MetisToolkit.cleanUpFile(pFile);</span>
            }
        }
<span class="nc" id="L158">    }</span>

    /**
     * Create a Backup ZipFile.
     *
     * @param pData      Data to write out
     * @param pZipStream the output stream
     * @throws OceanusException on error
     */
    public void createBackup(final PrometheusDataSet pData,
                             final OutputStream pZipStream) throws OceanusException {
        /* Obtain the active profile */
<span class="nc" id="L170">        final OceanusProfile myTask = theReport.getActiveTask();</span>
<span class="nc" id="L171">        final OceanusProfile myStage = myTask.startTask(&quot;Writing&quot;);</span>

        /* Protect agains exceptions */
        try {
            /* Create a similar security control */
<span class="nc" id="L176">            final PrometheusSecurityPasswordManager myPasswordMgr = pData.getPasswordMgr();</span>
<span class="nc" id="L177">            final GordianFactoryLock myBase = pData.getFactoryLock();</span>
<span class="nc" id="L178">            final GordianFactoryLock myLock = myPasswordMgr.similarFactoryLock(myBase);</span>
<span class="nc" id="L179">            final GordianZipFactory myZips = myPasswordMgr.getSecurityFactory().getZipFactory();</span>
<span class="nc" id="L180">            final GordianZipLock myZipLock = myZips.zipLock(myLock);</span>

            /* Access the data version */
<span class="nc" id="L183">            theVersion = pData.getControl().getDataVersion();</span>

            /* Declare the number of stages */
<span class="nc" id="L186">            theReport.setNumStages(pData.getListMap().size());</span>

            /* Protect the workbook access */
<span class="nc" id="L189">            try (GordianZipWriteFile myZipFile = myZips.createZipFile(myZipLock, pZipStream)) {</span>
                /* Loop through the data lists */
<span class="nc" id="L191">                final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = pData.iterator();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                while (myIterator.hasNext()) {</span>
<span class="nc" id="L193">                    final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

                    /* Declare the new stage */
<span class="nc" id="L196">                    theReport.setNewStage(myList.listName());</span>

                    /* If this list should be written */
<span class="nc bnc" id="L199" title="All 2 branches missed.">                    if (myList.includeDataXML()) {</span>
                        /* Write the list details */
<span class="nc" id="L201">                        myStage.startTask(myList.listName());</span>
<span class="nc" id="L202">                        writeXMLListToFile(myList, myZipFile, true);</span>
                    }
<span class="nc" id="L204">                }</span>

                /* Complete the task */
<span class="nc" id="L207">                myStage.end();</span>

<span class="nc" id="L209">            } catch (IOException</span>
                     | OceanusException e) {
<span class="nc" id="L211">                throw new PrometheusIOException(ERROR_BACKUP, e);</span>
<span class="nc" id="L212">            }</span>
<span class="nc" id="L213">        } catch (GordianException e) {</span>
<span class="nc" id="L214">            throw new PrometheusSecurityException(e);</span>
<span class="nc" id="L215">        }</span>
<span class="nc" id="L216">    }</span>

    /**
     * Create a Backup ZipFile.
     *
     * @param pData Data to write out
     * @param pFile the backup file to write to
     * @throws OceanusException on error
     */
    public void createExtract(final PrometheusDataSet pData,
                              final File pFile) throws OceanusException {
<span class="nc" id="L227">        boolean writeFailed = false;</span>
        try {
<span class="nc" id="L229">            createExtract(pData, new FileOutputStream(pFile));</span>
<span class="nc" id="L230">        } catch (IOException</span>
                 | OceanusException e) {
<span class="nc" id="L232">            writeFailed = true;</span>
<span class="nc" id="L233">            throw new PrometheusIOException(ERROR_BACKUP, e);</span>
        } finally {
            /* Try to delete the file if required */
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (writeFailed) {</span>
<span class="nc" id="L237">                MetisToolkit.cleanUpFile(pFile);</span>
            }
        }
<span class="nc" id="L240">    }</span>

    /**
     * Create an Extract ZipFile.
     *
     * @param pData      Data to write out
     * @param pZipStream the output stream
     * @throws OceanusException on error
     */
    public void createExtract(final PrometheusDataSet pData,
                              final OutputStream pZipStream) throws OceanusException {
        /* Obtain the active profile */
<span class="nc" id="L252">        final OceanusProfile myTask = theReport.getActiveTask();</span>
<span class="nc" id="L253">        final OceanusProfile myStage = myTask.startTask(&quot;Writing&quot;);</span>

        /* Access the data version */
<span class="nc" id="L256">        theVersion = pData.getControl().getDataVersion();</span>

        /* Declare the number of stages */
<span class="nc" id="L259">        theReport.setNumStages(pData.getListMap().size());</span>
<span class="nc" id="L260">        final GordianZipFactory myZips = thePasswordMgr.getSecurityFactory().getZipFactory();</span>

        /* Protect the workbook access */
<span class="nc" id="L263">        try (GordianZipWriteFile myZipFile = myZips.createZipFile(pZipStream)) {</span>
            /* Loop through the data lists */
<span class="nc" id="L265">            final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = pData.iterator();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">            while (myIterator.hasNext()) {</span>
<span class="nc" id="L267">                final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

                /* Declare the new stage */
<span class="nc" id="L270">                theReport.setNewStage(myList.listName());</span>

                /* If this list should be written */
<span class="nc bnc" id="L273" title="All 2 branches missed.">                if (myList.includeDataXML()) {</span>
                    /* Write the list details */
<span class="nc" id="L275">                    myStage.startTask(myList.listName());</span>
<span class="nc" id="L276">                    writeXMLListToFile(myList, myZipFile, false);</span>
                }
<span class="nc" id="L278">            }</span>

            /* Complete the task */
<span class="nc" id="L281">            myStage.end();</span>

<span class="nc" id="L283">        } catch (IOException</span>
                 | OceanusException e) {
<span class="nc" id="L285">            throw new PrometheusIOException(&quot;Failed to create extract XML&quot;, e);</span>
<span class="nc" id="L286">        }</span>
<span class="nc" id="L287">    }</span>

    /**
     * Write XML list to file.
     *
     * @param pList     the data list
     * @param pZipFile  the output zipFile
     * @param pStoreIds do we include IDs in XML
     * @throws OceanusException on error
     */
    private void writeXMLListToFile(final PrometheusDataList&lt;?&gt; pList,
                                    final GordianZipWriteFile pZipFile,
                                    final boolean pStoreIds) throws OceanusException {
        /* Access the list name */
<span class="nc" id="L301">        final String myName = pList.listName() + SUFFIX_ENTRY;</span>

        /* Protect the workbook access */
<span class="nc" id="L304">        try (OutputStream myStream = pZipFile.createOutputStream(new File(myName), true)) {</span>
            /* Create a new document */
<span class="nc" id="L306">            final Document myDocument = theBuilder.newDocument();</span>

            /* Populate the document from the list */
<span class="nc" id="L309">            populateXML(myDocument, pList, pStoreIds);</span>

            /* Format the XML and write to stream */
<span class="nc" id="L312">            theXformer.transform(new DOMSource(myDocument), new StreamResult(myStream));</span>

<span class="nc" id="L314">        } catch (GordianException</span>
                 | TransformerException
                 | IOException e) {
<span class="nc" id="L317">            throw new PrometheusIOException(&quot;Failed to transform XML&quot;, e);</span>
<span class="nc" id="L318">        }</span>
<span class="nc" id="L319">    }</span>

    /**
     * Create XML for a list.
     *
     * @param pDocument the document to hold the list.
     * @param pList     the data list
     * @param pStoreIds do we include IDs in XML
     * @throws OceanusException on error
     */
    private void populateXML(final Document pDocument,
                             final PrometheusDataList&lt;?&gt; pList,
                             final boolean pStoreIds) throws OceanusException {
        /* Create an element for the item */
<span class="nc" id="L333">        final Element myElement = pDocument.createElement(pList.listName());</span>
<span class="nc" id="L334">        pDocument.appendChild(myElement);</span>

        /* Access the Data formatter */
<span class="nc" id="L337">        final OceanusDataFormatter myFormatter = pList.getDataSet().getDataFormatter();</span>

        /* Declare the number of steps */
<span class="nc" id="L340">        final int myTotal = pList.size();</span>
<span class="nc" id="L341">        theReport.setNumSteps(myTotal);</span>

        /* Set the list type and size */
<span class="nc" id="L344">        myElement.setAttribute(PrometheusDataValues.ATTR_TYPE, pList.getItemType().getItemName());</span>
<span class="nc" id="L345">        myElement.setAttribute(PrometheusDataValues.ATTR_SIZE, Integer.toString(myTotal));</span>
<span class="nc" id="L346">        myElement.setAttribute(PrometheusDataValues.ATTR_VERS, Integer.toString(theVersion));</span>

        /* Iterate through the list */
<span class="nc" id="L349">        final Iterator&lt;?&gt; myIterator = pList.iterator();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L351">            final Object myObject = myIterator.next();</span>

            /* Ignore if not a DataItem */
<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (!(myObject instanceof PrometheusDataItem myItem)) {</span>
                continue;
            }

            /* Skip over child items */
<span class="nc bnc" id="L359" title="All 2 branches missed.">            if (myItem instanceof PrometheusGroupedItem myGrouped</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                    &amp;&amp; myGrouped.isChild()) {</span>
<span class="nc" id="L361">                continue;</span>
            }

            /* Create DataValues for item */
<span class="nc" id="L365">            final PrometheusDataValues myValues = new PrometheusDataValues(myItem);</span>

            /* Add the child to the list */
<span class="nc" id="L368">            final Element myChild = myValues.createXML(pDocument, myFormatter, pStoreIds);</span>
<span class="nc" id="L369">            myElement.appendChild(myChild);</span>

            /* Report the progress */
<span class="nc" id="L372">            theReport.setNextStep();</span>
<span class="nc" id="L373">        }</span>
<span class="nc" id="L374">    }</span>

    /**
     * Load a ZipFile.
     *
     * @param pData DataSet to load into
     * @param pFile the file to load
     * @throws OceanusException on error
     */
    public void loadZipFile(final PrometheusDataSet pData,
                            final File pFile) throws OceanusException {
        try {
<span class="nc" id="L386">            loadZipFile(pData, new FileInputStream(pFile), pFile.getName());</span>
<span class="nc" id="L387">        } catch (IOException e) {</span>
<span class="nc" id="L388">            throw new PrometheusIOException(&quot;Failed to access ZipFile&quot;, e);</span>
<span class="nc" id="L389">        }</span>
<span class="nc" id="L390">    }</span>

    /**
     * Load a ZipFile.
     *
     * @param pData     DataSet to load into
     * @param pInStream the input stream
     * @param pName     the file to load
     * @throws OceanusException on error
     */
    public void loadZipFile(final PrometheusDataSet pData,
                            final InputStream pInStream,
                            final String pName) throws OceanusException {
        /* Protect against exceptions */
        try {
            /* Obtain the active profile */
<span class="nc" id="L406">            final OceanusProfile myTask = theReport.getActiveTask();</span>
<span class="nc" id="L407">            final OceanusProfile myStage = myTask.startTask(&quot;Loading&quot;);</span>
<span class="nc" id="L408">            myStage.startTask(&quot;Parsing&quot;);</span>

            /* Access the zip file */
<span class="nc" id="L411">            final GordianZipFactory myZips = thePasswordMgr.getSecurityFactory().getZipFactory();</span>
<span class="nc" id="L412">            final GordianZipReadFile myZipFile = myZips.openZipFile(pInStream);</span>

            /* Obtain the hash bytes from the file */
<span class="nc" id="L415">            final GordianZipLock myLock = myZipFile.getLock();</span>

            /* If this is a secure ZipFile */
<span class="nc bnc" id="L418" title="All 2 branches missed.">            if (myLock != null) {</span>
                /* Resolve the lock */
<span class="nc" id="L420">                thePasswordMgr.resolveZipLock(myLock, pName);</span>
            }

            /* Parse the Zip File */
<span class="nc" id="L424">            parseZipFile(myStage, pData, myZipFile);</span>

            /* Complete the task */
<span class="nc" id="L427">            myStage.end();</span>

<span class="nc" id="L429">        } catch (GordianException e) {</span>
<span class="nc" id="L430">            throw new PrometheusSecurityException(e);</span>
<span class="nc" id="L431">        }</span>
<span class="nc" id="L432">    }</span>

    /**
     * Parse a ZipFile.
     *
     * @param pProfile the active profile
     * @param pData    DataSet to load into
     * @param pZipFile the file to parse
     * @throws OceanusException on error
     */
    private void parseZipFile(final OceanusProfile pProfile,
                              final PrometheusDataSet pData,
                              final GordianZipReadFile pZipFile) throws OceanusException {
        /* Start new stage */
<span class="nc" id="L446">        final OceanusProfile myStage = pProfile.startTask(&quot;Loading&quot;);</span>

        /* Declare the number of stages */
<span class="nc" id="L449">        theReport.setNumStages(pData.getListMap().size());</span>

        /* Loop through the data lists */
<span class="nc" id="L452">        final Iterator&lt;PrometheusDataList&lt;?&gt;&gt; myIterator = pData.iterator();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L454">            final PrometheusDataList&lt;?&gt; myList = myIterator.next();</span>

            /* Declare the new stage */
<span class="nc" id="L457">            theReport.setNewStage(myList.listName());</span>

            /* If this list should be read */
<span class="nc bnc" id="L460" title="All 2 branches missed.">            if (myList.includeDataXML()) {</span>
                /* Write the list details */
<span class="nc" id="L462">                myStage.startTask(myList.listName());</span>
<span class="nc" id="L463">                readXMLListFromFile(myList, pZipFile);</span>
            }

            /* postProcessList after load */
<span class="nc" id="L467">            myList.postProcessOnLoad();</span>
<span class="nc" id="L468">        }</span>

        /* Create the control data */
<span class="nc" id="L471">        pData.getControlData().addNewControl(theVersion);</span>

        /* Complete the task */
<span class="nc" id="L474">        myStage.end();</span>
<span class="nc" id="L475">    }</span>

    /**
     * Read XML list from file.
     *
     * @param pList    the data list
     * @param pZipFile the input zipFile
     * @throws OceanusException on error
     */
    private void readXMLListFromFile(final PrometheusDataList&lt;?&gt; pList,
                                     final GordianZipReadFile pZipFile) throws OceanusException {
        /* Protect against exceptions */
        try {
            /* Access the list name */
<span class="nc" id="L489">            final String myName = pList.listName() + SUFFIX_ENTRY;</span>

            /* Locate the correct entry */
<span class="nc" id="L492">            final GordianZipFileContents myContents = pZipFile.getContents();</span>
<span class="nc" id="L493">            final GordianZipFileEntry myEntry = myContents.findFileEntry(myName);</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">            if (myEntry == null) {</span>
<span class="nc" id="L495">                throw new PrometheusDataException(&quot;List not found &quot; + myName);</span>
            }

            /* Protect the workbook access */
<span class="nc" id="L499">            try (InputStream myStream = pZipFile.createInputStream(myEntry)) {</span>
                /* Read the document from the stream and parse it */
<span class="nc" id="L501">                final Document myDocument = theBuilder.parse(myStream);</span>

                /* Populate the list from the document */
<span class="nc" id="L504">                parseXMLDocument(myDocument, pList);</span>

<span class="nc" id="L506">            } catch (IOException</span>
                     | SAXException e) {
<span class="nc" id="L508">                throw new PrometheusIOException(&quot;Failed to parse XML&quot;, e);</span>
<span class="nc" id="L509">            }</span>
<span class="nc" id="L510">        } catch (GordianException e) {</span>
<span class="nc" id="L511">            throw new PrometheusSecurityException(e);</span>
<span class="nc" id="L512">        }</span>
<span class="nc" id="L513">    }</span>

    /**
     * parse an XML document into DataValues.
     *
     * @param pDocument the document that holds the list.
     * @param pList     the data list
     * @throws OceanusException on error
     */
    private void parseXMLDocument(final Document pDocument,
                                  final PrometheusDataList&lt;?&gt; pList) throws OceanusException {
        /* Access the parent element */
<span class="nc" id="L525">        final Element myElement = pDocument.getDocumentElement();</span>
<span class="nc" id="L526">        final MetisListKey myItemType = pList.getItemType();</span>

        /* Check that the document name and dataType are correct */
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (!MetisDataDifference.isEqual(myElement.getNodeName(), pList.listName())</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">                || !MetisDataDifference.isEqual(myElement.getAttribute(PrometheusDataValues.ATTR_TYPE), myItemType.getItemName())) {</span>
<span class="nc" id="L531">            throw new PrometheusDataException(&quot;Invalid list type&quot;);</span>
        }

        /* If this is the first Data version */
<span class="nc" id="L535">        final Integer myVersion = Integer.valueOf(myElement.getAttribute(PrometheusDataValues.ATTR_VERS));</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (theVersion == null) {</span>
<span class="nc" id="L537">            theVersion = myVersion;</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">        } else if (!theVersion.equals(myVersion)) {</span>
<span class="nc" id="L539">            throw new PrometheusDataException(&quot;Inconsistent data version&quot;);</span>
        }

        /* Access field types for list */
<span class="nc" id="L543">        final MetisFieldSetDef myFields = pList.getItemFields();</span>

        /* Access the Data formatter */
<span class="nc" id="L546">        final OceanusDataFormatter myFormatter = pList.getDataSet().getDataFormatter();</span>

        /* Declare the number of steps */
<span class="nc" id="L549">        final int myTotal = getListCount(myFormatter, myElement);</span>
<span class="nc" id="L550">        theReport.setNumSteps(myTotal);</span>

        /* Loop through the children */
<span class="nc bnc" id="L553" title="All 2 branches missed.">        for (Node myChild = myElement.getFirstChild(); myChild != null; myChild = myChild.getNextSibling()) {</span>
            /* Ignore non-elements */
<span class="nc bnc" id="L555" title="All 2 branches missed.">            if (!(myChild instanceof Element)) {</span>
<span class="nc" id="L556">                continue;</span>
            }

            /* Access as Element */
<span class="nc" id="L560">            final Element myItem = (Element) myChild;</span>

            /* Create DataArguments for item */
<span class="nc" id="L563">            final PrometheusDataValues myValues = new PrometheusDataValues(myItem, myFields);</span>

            /* Add the child to the list */
<span class="nc" id="L566">            pList.addValuesItem(myValues);</span>

            /* Report the progress */
<span class="nc" id="L569">            theReport.setNextStep();</span>
        }
<span class="nc" id="L571">    }</span>

    /**
     * Obtain count attribute.
     *
     * @param pFormatter the formatter.
     * @param pElement   the element that holds the count.
     * @return the list count
     * @throws OceanusException on error
     */
    private static Integer getListCount(final OceanusDataFormatter pFormatter,
                                        final Element pElement) throws OceanusException {
        try {
            /* Access the list count */
<span class="nc" id="L585">            final String mySize = pElement.getAttribute(PrometheusDataValues.ATTR_SIZE);</span>
<span class="nc" id="L586">            return pFormatter.parseValue(mySize, Integer.class);</span>
<span class="nc" id="L587">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L588">            throw new PrometheusDataException(&quot;Invalid list count&quot;, e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>