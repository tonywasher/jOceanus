<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusDataInfoSet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prometheus Core Application Framework</a> &gt; <a href="index.source.html" class="el_package">io.github.tonywasher.joceanus.prometheus.data</a> &gt; <span class="el_source">PrometheusDataInfoSet.java</span></div><h1>PrometheusDataInfoSet.java</h1><pre class="source lang-java linenums">/*
 * Prometheus: Application Framework
 * Copyright 2012-2026. Tony Washer
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package io.github.tonywasher.joceanus.prometheus.data;

import io.github.tonywasher.joceanus.oceanus.base.OceanusException;
import io.github.tonywasher.joceanus.oceanus.format.OceanusDataFormatter;
import io.github.tonywasher.joceanus.metis.data.MetisDataDifference;
import io.github.tonywasher.joceanus.metis.data.MetisDataEditState;
import io.github.tonywasher.joceanus.metis.data.MetisDataItem.MetisDataFieldId;
import io.github.tonywasher.joceanus.metis.data.MetisDataState;
import io.github.tonywasher.joceanus.metis.field.MetisFieldItem;
import io.github.tonywasher.joceanus.metis.field.MetisFieldSet;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusDataInfoItem.PrometheusDataInfoList;
import io.github.tonywasher.joceanus.prometheus.data.PrometheusStaticDataItem.PrometheusStaticList;

import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Spliterator;
import java.util.function.Consumer;

/**
 * Representation of an information set extension of a DataItem.
 *
 * @param &lt;T&gt; the data type
 * @author Tony Washer
 */
public abstract class PrometheusDataInfoSet&lt;T extends PrometheusDataInfoItem&gt;
        implements MetisFieldItem, Iterable&lt;T&gt; {
    /**
     * Report fields.
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc" id="L50">    private static final MetisFieldSet&lt;PrometheusDataInfoSet&gt; FIELD_DEFS = MetisFieldSet.newFieldSet(PrometheusDataInfoSet.class);</span>

    /*
     * FieldIds.
     */
    static {
<span class="nc" id="L56">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATAINFO_OWNER, PrometheusDataInfoSet::getOwner);</span>
<span class="nc" id="L57">        FIELD_DEFS.declareLocalField(PrometheusDataResource.DATAINFOSET_VALUES, PrometheusDataInfoSet::getValues);</span>
<span class="nc" id="L58">    }</span>

    /**
     * The Owner to which this set belongs.
     */
    private final PrometheusDataItem theOwner;

    /**
     * The InfoTypes for the InfoSet.
     */
    private final PrometheusStaticList&lt;?&gt; theTypeList;

    /**
     * The DataInfoList for the InfoSet.
     */
    private final PrometheusDataInfoList&lt;T&gt; theInfoList;

    /**
     * The Map of the DataInfo.
     */
    private final Map&lt;PrometheusDataInfoClass, PrometheusDataInfoItem&gt; theMap;

    /**
     * The class of the entries.
     */
    private final Class&lt;T&gt; theClass;

    /**
     * Constructor.
     *
     * @param pOwner    the Owner to which this Set belongs
     * @param pTypeList the infoTypeList for the set
     * @param pInfoList the infoList for the set
     */
    protected PrometheusDataInfoSet(final PrometheusDataItem pOwner,
                                    final PrometheusStaticList&lt;?&gt; pTypeList,
<span class="nc" id="L94">                                    final PrometheusDataInfoList&lt;T&gt; pInfoList) {</span>
        /* Store the Owner and InfoType List */
<span class="nc" id="L96">        theOwner = pOwner;</span>
<span class="nc" id="L97">        theTypeList = pTypeList;</span>
<span class="nc" id="L98">        theInfoList = pInfoList;</span>
<span class="nc" id="L99">        theClass = theInfoList.getBaseClass();</span>

        /* Create the Map */
<span class="nc" id="L102">        theMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L103">    }</span>

    @Override
    public String formatObject(final OceanusDataFormatter pFormatter) {
<span class="nc" id="L107">        return this.getDataFieldSet().getName();</span>
    }

    /**
     * Obtain owner.
     *
     * @return the owner
     */
    public PrometheusDataItem getOwner() {
<span class="nc" id="L116">        return theOwner;</span>
    }

    /**
     * Obtain values.
     *
     * @return the values
     */
    private Map&lt;PrometheusDataInfoClass, PrometheusDataInfoItem&gt; getValues() {
<span class="nc" id="L125">        return theMap;</span>
    }

    /**
     * Obtain class iterator for the underlying infoClasses.
     *
     * @return the Iterator
     */
    public abstract Iterator&lt;PrometheusDataInfoClass&gt; classIterator();

    /**
     * Clone the dataInfoSet.
     *
     * @param pSource the InfoSet to clone
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected void cloneTheDataInfoSet(final PrometheusDataInfoSet&lt;T&gt; pSource) {
        /* Clone the InfoSet for each Event in the underlying Map */
<span class="nc bnc" id="L143" title="All 2 branches missed.">        for (Entry&lt;PrometheusDataInfoClass, PrometheusDataInfoItem&gt; myEntry : pSource.theMap.entrySet()) {</span>
            /* Create the new value */
<span class="nc" id="L145">            final PrometheusDataInfoItem myValue = myEntry.getValue();</span>

            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L148" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Clone the infoLinkSet */
<span class="nc" id="L150">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myValue;</span>
<span class="nc" id="L151">                final PrometheusDataInfoItem myNew = new PrometheusDataInfoLinkSet&lt;&gt;(theInfoList, mySet);</span>
<span class="nc" id="L152">                theMap.put(myEntry.getKey(), myNew);</span>

                /* else its a standard entry */
<span class="nc" id="L155">            } else {</span>
                /* Add to the map */
<span class="nc" id="L157">                final PrometheusDataInfoItem myNew = theInfoList.addCopyItem(myValue);</span>
<span class="nc" id="L158">                theMap.put(myEntry.getKey(), myNew);</span>
            }
<span class="nc" id="L160">        }</span>
<span class="nc" id="L161">    }</span>

    /**
     * Obtain the value for the infoClass.
     *
     * @param &lt;X&gt;        the infoClass
     * @param pInfoClass the Info Class
     * @param pClass     the Value Class
     * @return the value
     */
    public &lt;X&gt; X getValue(final PrometheusDataInfoClass pInfoClass,
                          final Class&lt;X&gt; pClass) {
        /* Reject if called for LinkSet */
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (pInfoClass.isLinkSet()) {</span>
<span class="nc" id="L175">            throw new UnsupportedOperationException();</span>
        }

        /* Access existing entry */
<span class="nc" id="L179">        final PrometheusDataInfoItem myValue = theMap.get(pInfoClass);</span>

        /* If we have no entry, return null */
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (myValue == null) {</span>
<span class="nc" id="L183">            return null;</span>
        }

        /* Return the value */
<span class="nc" id="L187">        return myValue.getValue(pClass);</span>
    }

    /**
     * Obtain the list iterator for the infoClass.
     *
     * @param pInfoClass the Info Class
     * @return the iterator
     */
    public List&lt;?&gt; getListValue(final PrometheusDataInfoClass pInfoClass) {
        /* Reject if not called for LinkSet */
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!pInfoClass.isLinkSet()) {</span>
<span class="nc" id="L199">            throw new UnsupportedOperationException();</span>
        }

        /* Access existing entry */
<span class="nc" id="L203">        final PrometheusDataInfoLinkSet&lt;T&gt; mySet = getInfoLinkSet(pInfoClass);</span>

        /* Return list if it is available */
<span class="nc bnc" id="L206" title="All 2 branches missed.">        return mySet == null</span>
<span class="nc" id="L207">                ? null</span>
<span class="nc" id="L208">                : mySet.getActive();</span>
    }

    /**
     * Is there active values for the infoClass?
     *
     * @param pInfoClass the info class
     * @return true/false
     */
    public boolean isExisting(final PrometheusDataInfoClass pInfoClass) {
        /* Access the value */
<span class="nc" id="L219">        final PrometheusDataInfoItem myInfo = theMap.get(pInfoClass);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (myInfo instanceof PrometheusDataInfoLinkSet) {</span>
            /* Access the info */
<span class="nc" id="L222">            final PrometheusDataInfoLinkSet&lt;T&gt; mySet = getInfoLinkSet(pInfoClass);</span>
<span class="nc" id="L223">            return mySet.isExisting();</span>
        }

        /* Handle standard info */
<span class="nc bnc" id="L227" title="All 4 branches missed.">        return (myInfo != null) &amp;&amp; !myInfo.isDeleted();</span>
    }

    /**
     * Obtain the field value for the infoClass.
     *
     * @param pInfoClass the Info Class
     * @return the value
     */
    public PrometheusEncryptedPair getField(final PrometheusDataInfoClass pInfoClass) {
        /* Reject if called for LinkSet */
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (pInfoClass.isLinkSet()) {</span>
<span class="nc" id="L239">            throw new UnsupportedOperationException();</span>
        }

        /* Access existing entry */
<span class="nc" id="L243">        final PrometheusDataInfoItem myValue = theMap.get(pInfoClass);</span>

        /* If we have no entry, return null */
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (myValue == null) {</span>
<span class="nc" id="L247">            return null;</span>
        }

        /* Return the field */
<span class="nc" id="L251">        return myValue.getField();</span>
    }

    /**
     * Obtain the field value for the infoClass.
     *
     * @param pInfoClass the Info Class
     * @return the value
     */
    public T getInfo(final PrometheusDataInfoClass pInfoClass) {
        /* Reject if called for LinkSet */
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (pInfoClass.isLinkSet()) {</span>
<span class="nc" id="L263">            throw new UnsupportedOperationException();</span>
        }

        /* Return the info */
<span class="nc" id="L267">        final PrometheusDataInfoItem myInfo = theMap.get(pInfoClass);</span>
<span class="nc" id="L268">        return theClass.cast(myInfo);</span>
    }

    /**
     * link the value for the infoClass.
     *
     * @param pInfoClass the Info Class
     * @param pLink      the link value
     * @throws OceanusException on error
     */
    public void linkValue(final PrometheusDataInfoClass pInfoClass,
                          final PrometheusDataItem pLink) throws OceanusException {
        /* Reject if not called for LinkSet */
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (!pInfoClass.isLinkSet()) {</span>
<span class="nc" id="L282">            throw new UnsupportedOperationException();</span>
        }

        /* Access existing set */
<span class="nc" id="L286">        PrometheusDataInfoLinkSet&lt;T&gt; mySet = getInfoLinkSet(pInfoClass);</span>

        /* If we have no set, create one */
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (mySet == null) {</span>
            /* Obtain infoType */
<span class="nc" id="L291">            final PrometheusStaticDataItem myInfoType = theTypeList.findItemByClass(pInfoClass);</span>

            /* Allocate the new set */
<span class="nc" id="L294">            mySet = new PrometheusDataInfoLinkSet&lt;&gt;(theInfoList, theOwner, myInfoType);</span>

            /* Add to the map */
<span class="nc" id="L297">            theMap.put(pInfoClass, mySet);</span>
        }

        /* Locate any existing link */
<span class="nc" id="L301">        T myItem = mySet.getItemForValue(pLink);</span>

        /* If this is a new link */
<span class="nc bnc" id="L304" title="All 2 branches missed.">        if (myItem == null) {</span>
            /* Obtain infoType */
<span class="nc" id="L306">            final PrometheusStaticDataItem myInfoType = theTypeList.findItemByClass(pInfoClass);</span>

            /* Create the entry and add to list */
<span class="nc" id="L309">            myItem = theInfoList.addNewItem(theOwner, myInfoType);</span>
<span class="nc" id="L310">            myItem.setValue(pLink);</span>
<span class="nc" id="L311">            myItem.setNewVersion();</span>

            /* link the item */
<span class="nc" id="L314">            mySet.linkItem(myItem);</span>
<span class="nc" id="L315">            mySet.sortLinks();</span>

            /* else if this is a deleted link */
<span class="nc bnc" id="L318" title="All 2 branches missed.">        } else if (myItem.isDeleted()) {</span>
            /* Restore the value */
<span class="nc" id="L320">            myItem.setDeleted(false);</span>
        }
<span class="nc" id="L322">    }</span>

    /**
     * set the list value for the infoClass.
     *
     * @param pInfoClass the Info Class
     * @param pLinks     the links value
     * @throws OceanusException on error
     */
    public void setListValue(final PrometheusDataInfoClass pInfoClass,
                             final List&lt;? extends PrometheusDataItem&gt; pLinks) throws OceanusException {
        /* Reject if not called for LinkSet */
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (!pInfoClass.isLinkSet()) {</span>
<span class="nc" id="L335">            throw new UnsupportedOperationException();</span>
        }

        /* Access existing set */
<span class="nc" id="L339">        PrometheusDataInfoLinkSet&lt;T&gt; mySet = getInfoLinkSet(pInfoClass);</span>

        /* If we now have no selected values */
<span class="nc bnc" id="L342" title="All 4 branches missed.">        if (pLinks == null || pLinks.isEmpty()) {</span>
            /* If we have a set */
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (mySet != null) {</span>
                /* Clear all values in linkSet */
<span class="nc" id="L346">                mySet.clearAllLinks();</span>
<span class="nc" id="L347">                theMap.remove(pInfoClass);</span>
            }

            /* Else we have selected values */
        } else {
            /* If we do not currently have a set */
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (mySet == null) {</span>
                /* Obtain infoType */
<span class="nc" id="L355">                final PrometheusStaticDataItem myInfoType = theTypeList.findItemByClass(pInfoClass);</span>

                /* Allocate the new set */
<span class="nc" id="L358">                mySet = new PrometheusDataInfoLinkSet&lt;&gt;(theInfoList, theOwner, myInfoType);</span>

                /* Add to the map */
<span class="nc" id="L361">                theMap.put(pInfoClass, mySet);</span>
            }

            /* Clear out unnecessary links */
<span class="nc" id="L365">            mySet.clearUnnecessaryLinks(pLinks);</span>

            /* Add new links */
<span class="nc" id="L368">            mySet.addNewLinks(pLinks);</span>
<span class="nc" id="L369">            mySet.sortLinks();</span>
        }
<span class="nc" id="L371">    }</span>

    /**
     * Obtain the infoLinkSet for the infoClass.
     *
     * @param pInfoClass the Info Class
     * @return the value
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected PrometheusDataInfoLinkSet&lt;T&gt; getInfoLinkSet(final PrometheusDataInfoClass pInfoClass) {
        /* Reject if not called for LinkSet */
<span class="nc bnc" id="L382" title="All 2 branches missed.">        if (!pInfoClass.isLinkSet()) {</span>
<span class="nc" id="L383">            throw new UnsupportedOperationException();</span>
        }

        /* Return the info */
<span class="nc" id="L387">        final PrometheusDataInfoItem myInfo = theMap.get(pInfoClass);</span>
<span class="nc" id="L388">        return (PrometheusDataInfoLinkSet&lt;T&gt;) myInfo;</span>
    }

    /**
     * Determine whether a particular field has changed in this edit view.
     *
     * @param pInfoClass the class to test
     * @return &lt;code&gt;true/false&lt;/code&gt;
     */
    public MetisDataDifference fieldChanged(final PrometheusDataInfoClass pInfoClass) {
        /* If this is called for LinkSet */
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (pInfoClass.isLinkSet()) {</span>
            /* Access the info */
<span class="nc" id="L401">            final PrometheusDataInfoLinkSet&lt;T&gt; mySet = getInfoLinkSet(pInfoClass);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">            return mySet == null</span>
<span class="nc" id="L403">                    ? MetisDataDifference.IDENTICAL</span>
<span class="nc" id="L404">                    : mySet.fieldChanged();</span>
        }

        /* Access the info */
<span class="nc" id="L408">        final T myInfo = getInfo(pInfoClass);</span>

        /* Return change details */
<span class="nc bnc" id="L411" title="All 2 branches missed.">        if (myInfo == null) {</span>
<span class="nc" id="L412">            return MetisDataDifference.DIFFERENT;</span>
        }
<span class="nc bnc" id="L414" title="All 2 branches missed.">        return myInfo.hasHistory()</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                || MetisDataState.NEW.equals(myInfo.getState())</span>
<span class="nc" id="L416">                ? MetisDataDifference.DIFFERENT</span>
<span class="nc" id="L417">                : MetisDataDifference.IDENTICAL;</span>
    }

    /**
     * Set the value for the infoClass.
     *
     * @param pInfoClass the Info Class
     * @param pValue     the Value
     * @throws OceanusException on error
     */
    public void setValue(final PrometheusDataInfoClass pInfoClass,
                         final Object pValue) throws OceanusException {
        /* Reject if called for LinkSet */
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (pInfoClass.isLinkSet()) {</span>
<span class="nc" id="L431">            throw new UnsupportedOperationException();</span>
        }

        /* Determine whether this is a deletion */
<span class="nc bnc" id="L435" title="All 2 branches missed.">        final boolean bDelete = pValue == null;</span>

        /* Obtain the Map value */
<span class="nc" id="L438">        PrometheusDataInfoItem myValue = theMap.get(pInfoClass);</span>

        /* If we are deleting */
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (bDelete) {</span>
            /* Mark existing value as deleted */
<span class="nc bnc" id="L443" title="All 2 branches missed.">            if (myValue != null) {</span>
<span class="nc" id="L444">                myValue.markDeleted();</span>
            }

            /* Return to caller */
<span class="nc" id="L448">            return;</span>
        }

        /* If we have no entry */
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (myValue == null) {</span>
            /* Obtain infoType */
<span class="nc" id="L454">            final PrometheusStaticDataItem myInfoType = theTypeList.findItemByClass(pInfoClass);</span>

            /* Create the entry and add to list */
<span class="nc" id="L457">            myValue = theInfoList.addNewItem(theOwner, myInfoType);</span>
<span class="nc" id="L458">            myValue.setNewVersion();</span>

            /* Insert the value into the map */
<span class="nc" id="L461">            theMap.put(pInfoClass, myValue);</span>
        }

        /* Update the value */
<span class="nc" id="L465">        myValue.setValue(pValue);</span>
<span class="nc" id="L466">    }</span>

    /**
     * Sort linkSets.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void sortLinkSets() {
        /* Loop through each existing value */
<span class="nc bnc" id="L474" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L476" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Pass call to linkSet */
<span class="nc" id="L478">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myValue;</span>
<span class="nc" id="L479">                mySet.sortLinks();</span>
            }
<span class="nc" id="L481">        }</span>
<span class="nc" id="L482">    }</span>

    /**
     * Register Info.
     *
     * @param pInfo the info to register
     * @throws OceanusException on error
     */
    public void registerInfo(final T pInfo) throws OceanusException {
        /* Obtain the existing Map value */
<span class="nc" id="L492">        final PrometheusDataInfoClass myClass = pInfo.getInfoClass();</span>

        /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L495" title="All 2 branches missed.">        if (myClass.isLinkSet()) {</span>
            /* Access existing entry */
<span class="nc" id="L497">            PrometheusDataInfoLinkSet&lt;T&gt; mySet = getInfoLinkSet(myClass);</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">            if (mySet == null) {</span>
                /* Allocate the new set */
<span class="nc" id="L500">                mySet = new PrometheusDataInfoLinkSet&lt;&gt;(theInfoList, theOwner, pInfo.getInfoType());</span>

                /* Add to the map */
<span class="nc" id="L503">                theMap.put(myClass, mySet);</span>
            }

            /* link the item */
<span class="nc" id="L507">            mySet.linkItem(pInfo);</span>

            /* else it is a standard item */
<span class="nc" id="L510">        } else {</span>
            /* Access existing entry */
<span class="nc" id="L512">            final PrometheusDataInfoItem myValue = theMap.get(myClass);</span>

            /* Reject if duplicate and not re-registration */
<span class="nc bnc" id="L515" title="All 4 branches missed.">            if ((myValue != null) &amp;&amp; !myValue.getIndexedId().equals(pInfo.getIndexedId())) {</span>
<span class="nc" id="L516">                throw new IllegalArgumentException(&quot;Duplicate information type &quot; + pInfo.getInfoClass());</span>
            }

            /* Add to the map */
<span class="nc" id="L520">            theMap.put(myClass, pInfo);</span>
        }
<span class="nc" id="L522">    }</span>

    /**
     * deRegister Info.
     *
     * @param pInfo the info to deRegister
     */
    public void deRegisterInfo(final T pInfo) {
        /* Obtain the existing Map value */
<span class="nc" id="L531">        final PrometheusDataInfoClass myClass = pInfo.getInfoClass();</span>

        /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (myClass.isLinkSet()) {</span>
            /* Access existing entry */
<span class="nc" id="L536">            final PrometheusDataInfoLinkSet&lt;T&gt; mySet = getInfoLinkSet(myClass);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">            if (mySet != null) {</span>
                /* Unlink the item */
<span class="nc" id="L539">                mySet.unlinkItem(pInfo);</span>

                /* If the set is now empty */
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (mySet.isEmpty()) {</span>
                    /* Remove the set from the map */
<span class="nc" id="L544">                    theMap.remove(myClass);</span>
                }
            }

            /* else it is a standard info */
<span class="nc" id="L549">        } else {</span>
            /* Remove from the map */
<span class="nc" id="L551">            theMap.remove(myClass);</span>
        }
<span class="nc" id="L553">    }</span>

    /**
     * deRegister Info.
     *
     * @param pInfo the info to deRegister
     */
    public void rewindInfoLinkSet(final T pInfo) {
        /* Obtain the existing Map value */
<span class="nc" id="L562">        final PrometheusDataInfoClass myClass = pInfo.getInfoClass();</span>

        /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (myClass.isLinkSet()) {</span>
            /* Access existing entry */
<span class="nc" id="L567">            final PrometheusDataInfoLinkSet&lt;T&gt; mySet = getInfoLinkSet(myClass);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">            if (mySet != null) {</span>
                /* reSort the links */
<span class="nc" id="L570">                mySet.sortLinks();</span>
            } else {
                /* Remove the set from the map */
<span class="nc" id="L573">                theMap.remove(myClass);</span>
            }

            /* illegal operation */
<span class="nc" id="L577">        } else {</span>
<span class="nc" id="L578">            throw new UnsupportedOperationException();</span>
        }
<span class="nc" id="L580">    }</span>

    /**
     * wipe information regarding the infoClass.
     *
     * @param pInfoClass the Info Class
     */
    public void wipeInfo(final PrometheusDataInfoClass pInfoClass) {
        /* If we have an item for the class */
<span class="nc" id="L589">        final PrometheusDataInfoItem myInfo = theMap.get(pInfoClass);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">        if (myInfo != null) {</span>
            /* Remove and unlink it */
<span class="nc" id="L592">            theMap.remove(pInfoClass);</span>
<span class="nc" id="L593">            theInfoList.remove(myInfo);</span>
        }
<span class="nc" id="L595">    }</span>

    /**
     * touch underlying items.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void touchUnderlyingItems() {
        /* Loop through each existing value */
<span class="nc bnc" id="L603" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L605" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Pass call to linkSet */
<span class="nc" id="L607">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myValue;</span>
<span class="nc" id="L608">                mySet.touchUnderlyingItems();</span>

                /* else this is a standard DataInfo */
<span class="nc" id="L611">            } else {</span>
                /* Touch the underlying items */
<span class="nc" id="L613">                myValue.touchUnderlyingItems();</span>
            }
<span class="nc" id="L615">        }</span>
<span class="nc" id="L616">    }</span>

    /**
     * touch underlying items after update.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void touchOnUpdate() {
        /* Loop through each existing value */
<span class="nc bnc" id="L624" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L626" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Pass call to linkSet */
<span class="nc" id="L628">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myValue;</span>
<span class="nc" id="L629">                mySet.touchOnUpdate();</span>

                /* else this is a standard DataInfo */
<span class="nc" id="L632">            } else {</span>
                /* Touch the underlying items */
<span class="nc" id="L634">                myValue.touchOnUpdate();</span>
            }
<span class="nc" id="L636">        }</span>
<span class="nc" id="L637">    }</span>

    /**
     * Determine whether the set has changes.
     *
     * @return &lt;code&gt;true/false&lt;/code&gt;
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public boolean hasHistory() {
<span class="nc" id="L646">        boolean bChanges = false;</span>

        /* Loop through each existing value */
<span class="nc bnc" id="L649" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L651" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Pass call to linkSet */
<span class="nc" id="L653">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myValue;</span>
<span class="nc" id="L654">                bChanges |= mySet.hasHistory();</span>

<span class="nc" id="L656">            } else {</span>
                /* Check for history */
<span class="nc" id="L658">                bChanges |= myValue.hasHistory();</span>
            }
<span class="nc" id="L660">        }</span>

        /* return result */
<span class="nc" id="L663">        return bChanges;</span>
    }

    /**
     * Push history.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void pushHistory() {
        /* Loop through each existing value */
<span class="nc bnc" id="L672" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L674" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Pass call to linkSet */
<span class="nc" id="L676">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myValue;</span>
<span class="nc" id="L677">                mySet.pushHistory();</span>

<span class="nc" id="L679">            } else {</span>
                /* Push history for the value */
<span class="nc" id="L681">                myValue.pushHistory();</span>
            }
<span class="nc" id="L683">        }</span>
<span class="nc" id="L684">    }</span>

    /**
     * Pop history.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void popHistory() {
        /* Iterate through table values */
<span class="nc" id="L692">        final Iterator&lt;PrometheusDataInfoItem&gt; myIterator = theMap.values().iterator();</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L694">            final PrometheusDataInfoItem myValue = myIterator.next();</span>

            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L697" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Pass call to linkSet */
<span class="nc" id="L699">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myValue;</span>
<span class="nc" id="L700">                mySet.popHistory();</span>

                /* If the set is now empty */
<span class="nc bnc" id="L703" title="All 2 branches missed.">                if (mySet.isEmpty()) {</span>
                    /* Remove the value */
<span class="nc" id="L705">                    myIterator.remove();</span>
                }

                /* else this is a standard element */
<span class="nc" id="L709">            } else {</span>
                /* If the entry should be removed */
<span class="nc bnc" id="L711" title="All 2 branches missed.">                if (myValue.getOriginalValues().getVersion() &gt; theInfoList.getVersion()) {</span>
                    /* Remove the value */
<span class="nc" id="L713">                    myIterator.remove();</span>
<span class="nc" id="L714">                    myValue.unLink();</span>
<span class="nc" id="L715">                    continue;</span>
                }

                /* Pop the value */
<span class="nc" id="L719">                myValue.popHistory();</span>
            }
<span class="nc" id="L721">        }</span>
<span class="nc" id="L722">    }</span>

    /**
     * Check for history.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if changes were made, &lt;code&gt;false&lt;/code&gt; otherwise
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public boolean checkForHistory() {
        /* Loop through each existing value */
<span class="nc" id="L732">        boolean bChanges = false;</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L735" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Pass call to linkSet */
<span class="nc" id="L737">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myValue;</span>
<span class="nc" id="L738">                bChanges |= mySet.checkForHistory();</span>

<span class="nc" id="L740">            } else {</span>
                /* If this is a newly created item */
<span class="nc bnc" id="L742" title="All 2 branches missed.">                if (!myValue.hasHistory()) {</span>
<span class="nc" id="L743">                    bChanges = true;</span>

                    /* else existing entry */
                } else {
                    /* Check for history */
<span class="nc" id="L748">                    bChanges |= myValue.checkForHistory();</span>
                }
            }
<span class="nc" id="L751">        }</span>

        /* return result */
<span class="nc" id="L754">        return bChanges;</span>
    }

    /**
     * Set values as deleted/restored.
     *
     * @param bDeleted &lt;code&gt;true/false&lt;/code&gt;
     */
    public void setDeleted(final boolean bDeleted) {
        /* If we are restoring */
<span class="nc bnc" id="L764" title="All 2 branches missed.">        if (!bDeleted) {</span>
            /* Handle separately */
<span class="nc" id="L766">            setRestored();</span>
<span class="nc" id="L767">            return;</span>
        }

        /* For each existing value */
<span class="nc bnc" id="L771" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If the value is active */
<span class="nc bnc" id="L773" title="All 2 branches missed.">            if (!myValue.isDeleted()) {</span>
                /* Set the value as deleted */
<span class="nc" id="L775">                myValue.setDeleted(true);</span>
            }
<span class="nc" id="L777">        }</span>
<span class="nc" id="L778">    }</span>

    /**
     * Restore values that we deleted at the same time as the owner.
     */
    private void setRestored() {
        /* Access the version of the owner */
<span class="nc" id="L785">        int myVersion = theOwner.getValueSetVersion();</span>

        /* We are restoring an edit version if delete was in this session */
<span class="nc bnc" id="L788" title="All 2 branches missed.">        final boolean bEditRestore = myVersion &gt; 0;</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">        if (!bEditRestore) {</span>
            /* Access underlying version if not editRestore */
<span class="nc" id="L791">            myVersion = theOwner.getBase().getValueSetVersion();</span>
        }

        /* For each existing value */
<span class="nc bnc" id="L795" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If this is an instance of a LinkSet */
<span class="nc bnc" id="L797" title="All 2 branches missed.">            if (myValue instanceof PrometheusDataInfoLinkSet) {</span>
                /* Pass call to linkSet */
<span class="nc" id="L799">                myValue.setDeleted(false);</span>

            } else {
                /* Access version of value */
<span class="nc bnc" id="L803" title="All 2 branches missed.">                final int myValueVersion = bEditRestore</span>
<span class="nc" id="L804">                        ? myValue.getValueSetVersion()</span>
<span class="nc" id="L805">                        : myValue.getBase().getValueSetVersion();</span>

                /* If the value was deleted at same time as owner */
<span class="nc bnc" id="L808" title="All 2 branches missed.">                if (myValueVersion == myVersion) {</span>
                    /* Set the value as restored */
<span class="nc" id="L810">                    myValue.setDeleted(false);</span>
                }
            }
<span class="nc" id="L813">        }</span>
<span class="nc" id="L814">    }</span>

    /**
     * Get the EditState for this item.
     *
     * @return the EditState
     */
    public MetisDataEditState getEditState() {
        /* Loop through each existing value */
<span class="nc bnc" id="L823" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If we have changes */
<span class="nc bnc" id="L825" title="All 2 branches missed.">            if (myValue.hasHistory()) {</span>
                /* Note that new state is changed */
<span class="nc" id="L827">                return MetisDataEditState.VALID;</span>
            }
<span class="nc" id="L829">        }</span>

        /* Default to clean */
<span class="nc" id="L832">        return MetisDataEditState.CLEAN;</span>
    }

    /**
     * Get the State for this infoSet.
     *
     * @return the State
     */
    public MetisDataState getState() {
        /* Default to clean */
<span class="nc" id="L842">        final MetisDataState myState = MetisDataState.CLEAN;</span>

        /* Loop through each existing value */
<span class="nc bnc" id="L845" title="All 2 branches missed.">        for (PrometheusDataInfoItem myValue : theMap.values()) {</span>
            /* If we have changes */
<span class="nc bnc" id="L847" title="All 2 branches missed.">            if (myValue.getState() != MetisDataState.CLEAN) {</span>
                /* Note that new state is changed */
<span class="nc" id="L849">                return MetisDataState.CHANGED;</span>
            }
<span class="nc" id="L851">        }</span>

        /* return result */
<span class="nc" id="L854">        return myState;</span>
    }

    @Override
    public Iterator&lt;T&gt; iterator() {
<span class="nc" id="L859">        return new InfoIterator();</span>
    }

    @Override
    public void forEach(final Consumer&lt;? super T&gt; pAction) {
<span class="nc" id="L864">        final Iterator&lt;T&gt; myIterator = iterator();</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L866">            pAction.accept(myIterator.next());</span>
        }
<span class="nc" id="L868">    }</span>

    @Override
    public Spliterator&lt;T&gt; spliterator() {
<span class="nc" id="L872">        throw new UnsupportedOperationException();</span>
    }

    /**
     * Is the infoSet empty?
     *
     * @return true/false.
     */
    public boolean isEmpty() {
<span class="nc" id="L881">        return theMap.isEmpty();</span>
    }

    /**
     * Remove items.
     */
    public void removeItems() {
<span class="nc" id="L888">        final InfoIterator myIterator = new InfoIterator();</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">        while (myIterator.hasNext()) {</span>
<span class="nc" id="L890">            final T myItem = myIterator.next();</span>
<span class="nc" id="L891">            myItem.removeItem();</span>
<span class="nc" id="L892">        }</span>
<span class="nc" id="L893">    }</span>

    /**
     * Iterator class.
     */
    private final class InfoIterator
            implements Iterator&lt;T&gt; {
        /**
         * Overall iterator.
         */
        private final Iterator&lt;PrometheusDataInfoItem&gt; theIterator;

        /**
         * Local iterator.
         */
        private Iterator&lt;T&gt; theSetIterator;

        /**
         * Constructor.
         */
<span class="nc" id="L913">        private InfoIterator() {</span>
            /* Allocate iterator */
<span class="nc" id="L915">            theIterator = theMap.values().iterator();</span>
<span class="nc" id="L916">        }</span>

        @Override
        public boolean hasNext() {
            /* If we have a set iterator with more to go */
<span class="nc bnc" id="L921" title="All 2 branches missed.">            if (theSetIterator != null</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">                    &amp;&amp; theSetIterator.hasNext()) {</span>
                /* We have a next item */
<span class="nc" id="L924">                return true;</span>
            }

            /* No longer have a valid setIterator */
<span class="nc" id="L928">            theSetIterator = null;</span>

            /* Check for next entry */
<span class="nc" id="L931">            return theIterator.hasNext();</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public T next() {
            /* If we have a set iterator with more to go */
<span class="nc bnc" id="L938" title="All 2 branches missed.">            if (theSetIterator != null</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">                    &amp;&amp; theSetIterator.hasNext()) {</span>
                /* Return the item */
<span class="nc" id="L941">                return theSetIterator.next();</span>
            }

            /* No longer have a valid setIterator */
<span class="nc" id="L945">            theSetIterator = null;</span>

            /* Obtain the next item */
<span class="nc" id="L948">            final PrometheusDataInfoItem myItem = theIterator.next();</span>

            /* If this is an infoLinkSet */
<span class="nc bnc" id="L951" title="All 2 branches missed.">            if (myItem instanceof PrometheusDataInfoLinkSet) {</span>
                /* Access set iterator and return first element */
<span class="nc" id="L953">                final PrometheusDataInfoLinkSet&lt;T&gt; mySet = (PrometheusDataInfoLinkSet&lt;T&gt;) myItem;</span>
<span class="nc" id="L954">                theSetIterator = mySet.iterator();</span>
<span class="nc" id="L955">                return theSetIterator.next();</span>
            }

            /* Return the item */
<span class="nc" id="L959">            return theClass.cast(myItem);</span>
        }

        @Override
        public void remove() {
<span class="nc" id="L964">            throw new UnsupportedOperationException();</span>
        }

        @Override
        public void forEachRemaining(final Consumer&lt;? super T&gt; pAction) {
<span class="nc bnc" id="L969" title="All 2 branches missed.">            while (hasNext()) {</span>
<span class="nc" id="L970">                pAction.accept(next());</span>
            }
<span class="nc" id="L972">        }</span>
    }

    /**
     * Obtain the field for the infoSet class.
     *
     * @param pClass the class
     * @return the field
     */
    public abstract MetisDataFieldId getFieldForClass(PrometheusDataInfoClass pClass);
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>